[{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"èƒŒæ™¯ æºäºä¸€æ¬¡çº¿ä¸Š P0 æ•…éšœï¼Œä¸€ä¸ªç”Ÿäº§é›†ç¾¤è¢«è¯¯æ“ä½œåˆ é™¤ï¼ˆä¸åªæ˜¯ä¸šåŠ¡è¢«åˆ ï¼Œæ˜¯é›†ç¾¤ä¹Ÿè¢«åˆ äº†ï¼‰ï¼Œé›†ç¾¤è§„æ¨¡è¾ƒå¤§ï¼Œåœ¨é›†ç¾¤æ¢å¤å Pod è¿›è¡Œäº†é‡æ–°ã€è°ƒåº¦çš„è¿‡ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼ˆä»å¼€å§‹æ¢å¤é›†ç¾¤åˆ°ä¸šåŠ¡æœåŠ¡å°±ç»ªï¼‰è€—æ—¶ç•¥é•¿ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è°ƒåº¦ç¯èŠ‚è€—æ—¶çš„è®¡ç®—ï¼Œç”±äºå½“æ—¶ç›‘æ§æœåŠ¡ä¹Ÿéƒ¨ç½²åœ¨é›†ç¾¤ä¸­ï¼Œå¯¼è‡´æ•…éšœæ—¶çš„è°ƒåº¦å™¨ç›‘æ§æ•°æ®ä¸¢å¤±ï¼Œæœ€åçš„æœ€åï¼Œåˆå›åˆ°äº†åŸç‚¹ï¼šæ•…éšœé©±åŠ¨ï¼Œè‡ªè¯æ¸…ç™½ã€‚äºæ˜¯å°±æœ‰äº† scheduler-stress-test é¡¹ç›®ï¼Œå°±æœ‰äº†æœ¬ç¯‡å…³äºæ­¤é¡¹ç›®çš„ä»‹ç»ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°æœ‰ç±»ä¼¼éœ€æ±‚ï¼ˆè°ƒåº¦å™¨å‹æµ‹ï¼‰çš„åŒå¿—ä»¬ã€‚ å®ç° ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:0:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"Metrics èƒ½æƒ³åˆ°çš„æœ€ç®€å•ç›´è§‚çš„åŠæ³•ï¼Œå°±æ˜¯é€šè¿‡è°ƒåº¦å™¨æš´éœ²å‡ºæ¥çš„ metrics æ¥è®¡ç®—è°ƒåº¦æ€§èƒ½ï¼Œè°ƒåº¦å™¨æŒ‡æ ‡å®šä¹‰æ–‡ä»¶ï¼š k8s.io/kubernetes/pkg/scheduler/metrics/metrics.go æœ‰å¦‚ä¸‹å‡ ä¸ªå…³é”®æŒ‡æ ‡ï¼š æŒ‡æ ‡ type query example scheduler_e2e_scheduling_duration_seconds_count count sum(rate(scheduler_e2e_scheduling_duration_seconds_count{job=â€œadvanced-schedulerâ€,profile=â€œdefault-schedulerâ€,result=â€œscheduledâ€}[5m])) by (instance) scheduler_pending_pods gauge scheduler_pending_pods{queue=â€˜activeâ€™, job=â€œdefault-schedulerâ€} scheduler_e2e_scheduling_duration_seconds_bucket histogram histogram_quantile(0.99, sum(rate(scheduler_e2e_scheduling_duration_seconds_bucket{job=â€œdefault-schedulerâ€}[5m])) by (le)) scheduler_scheduling_algorithm_duration_seconds_bucket histogram histogram_quantile(0.99, sum by(le) (rate(scheduler_scheduling_algorithm_duration_seconds_bucket{job=â€œdefault-schedulerâ€}[5m]))) scheduler_binding_duration_seconds_bucket histogram histogram_quantile(0.99, sum by(le) (rate(scheduler_binding_duration_seconds_bucket{job=â€œdefault-schedulerâ€}[5m]))) ä»åå­—å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹å‡ºæ¥æŒ‡æ ‡ç‚¹çš„å«ä¹‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:1:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"Condition ç¬¬äºŒç§æ–¹å¼æ˜¯é€šè¿‡è·å– Pod PodScheduled Condition ä¿¡æ¯ï¼Œé€šè¿‡è®¡ç®—å…¶ LastTransitionTime ä¸ CreationTimestamp æ—¶é—´å·®ä½œä¸ºè°ƒåº¦è€—æ—¶ã€‚ ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:2:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"åˆ†æ ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å¾—åˆ°è°ƒåº¦è€—æ—¶ç›¸å…³æ€§èƒ½æ•°æ®ï¼Œä½†æœ‰ä¸€äº›å·®å¼‚ï¼Œå…·ä½“è¡¨ç°ä¸ºï¼š å‰è€…çš„è€—æ—¶æ¯”è¾ƒç²¾ç¡®ï¼Œæ˜¯è°ƒåº¦å™¨å†…å­˜ä¸­ä¿å­˜çš„è€—æ—¶ï¼Œä½†ç¼ºå°‘æ¯ä¸ª Pod çš„è€—æ—¶ï¼Œæš´éœ²çš„æ˜¯æ‰€æœ‰ Pod è€—æ—¶åˆ†å¸ƒï¼Œè€Œ histogram æœ¬èº«å°±ä¼šå­˜åœ¨ä¸€å®šçš„è¯¯å·®ã€‚ åè€…çš„è€—æ—¶åˆ™åŒ…å«æ›´å¤šé˜¶æ®µçš„è€—æ—¶ï¼š LastTransitionTime æ˜¯è°ƒåº¦å™¨å‘èµ·å¼‚æ­¥ Bind è¯·æ±‚ä¸” kube-apiserver æ”¶åˆ°è¯·æ±‚ååœ¨å®é™…ä¿å­˜æ•°æ®åˆ° Etcd å‰è®¾ç½®çš„ï¼› CreationTimestamp æ˜¯ kube-apiserver æ”¶åˆ°åˆ›å»ºè¯·æ±‚ååœ¨ä¿å­˜åˆ° Etcd ä¹‹å‰è®¾ç½®çš„ï¼› æ‰€ä»¥ LastTransitionTime - CreationTimestamp çš„ç»“æœä¼šåŒ…å« Create è¯·æ±‚å†™ Etcd çš„è€—æ—¶ï¼ˆç½‘ç»œä¼ è¾“ã€å†™ç£ç›˜ï¼‰ã€è°ƒåº¦å™¨ watch åˆ° Pod çš„è€—æ—¶ï¼ˆç½‘ç»œä¼ è¾“ï¼‰ã€è°ƒåº¦å™¨è¯·æ±‚ apiserver åˆ° apiserver æ”¶åˆ°è¯·æ±‚è¿›è¡Œç»‘å®šçš„è€—æ—¶ï¼ˆç½‘ç»œä¼ è¾“ï¼‰ç­‰ã€‚ç”±äº metav1.Time ç»“æ„åœ¨ä¼ è¾“æ—¶é‡‡ç”¨ RFC3339 è¿›è¡Œç¼–ç ï¼Œåªèƒ½ç²¾ç¡®åˆ°ç§’ï¼Œå› æ­¤ä¼šæŸå¤±éƒ¨åˆ†ç²¾åº¦ã€‚ ç»¼ä¸Šï¼Œæ— è®ºé‡‡ç”¨é‚£ç§æ–¹å¼è¿›è¡Œç»Ÿè®¡ï¼Œç»“æœéƒ½ä¼šæœ‰ä¸€äº›è¯¯å·®ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£è¯¯å·®æ¥æºï¼Œä»¥åŠæ¯ç§ç»Ÿè®¡æ–¹å¼çš„ç»“æœä»£è¡¨çš„å«ä¹‰ã€‚åœ¨å®é™…æµ‹è¯•æ—¶ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼ã€‚ é¡¹ç›®ä»‹ç» scheduler-stress-test å³é€šè¿‡ Condition æ–¹å¼è¿›è¡Œç»Ÿè®¡ï¼Œä½¿ç”¨æ–¹å¼å‚è€ƒ README.mdã€‚ ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:3:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"ç¯å¢ƒå‡†å¤‡ ä¸ºäº†æ¨¡æ‹Ÿå¤§è§„æ¨¡è°ƒåº¦åœºæ™¯ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ kwok åˆ›å»ºæ‰€éœ€æ•°é‡çš„èŠ‚ç‚¹ã€‚åˆ›å»ºçš„èŠ‚ç‚¹å¯èƒ½å¤„äº NotReady çŠ¶æ€ã€‚ä¸ºäº†èƒ½å¤Ÿå°†è¿™äº›èŠ‚ç‚¹ç”¨äºè°ƒåº¦ Podï¼Œå¿…é¡»ä¸ºå¾…è°ƒåº¦çš„ Pod æ·»åŠ ä¸€ä¸ª tolerationï¼Œä»¥å®¹å¿æ‰€æœ‰ NoSchedule çš„æ±¡ç‚¹ã€‚ ä¸ºæ­¤ï¼Œæ‚¨åº”è¯¥æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š åœ¨æ‚¨çš„ k8s é›†ç¾¤ä¸Šå®‰è£… kwokï¼Œè¯·å‚è€ƒ https://kwok.sigs.k8s.io/docs/user/kwok-in-cluster/ï¼› åœ¨æ‚¨çš„ k8s é›†ç¾¤ä¸Šåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¯ä»¥å‚è€ƒå¦‚ä¸‹å‘½ä»¤ cat \u003c\u003c EOF \u003e node.yaml apiVersion: v1 kind: Node metadata: annotations: node.alpha.kubernetes.io/ttl: \"0\" kwok.x-k8s.io/node: fake labels: beta.kubernetes.io/arch: amd64 beta.kubernetes.io/os: linux kubernetes.io/arch: amd64 kubernetes.io/hostname: {NODE_NAME} kubernetes.io/os: linux kubernetes.io/role: agent node-role.kubernetes.io/agent: \"\" type: kwok name: {NODE_NAME} spec: taints: # Avoid scheduling actual running pods to fake Node - effect: NoSchedule key: kwok.x-k8s.io/node value: fake status: allocatable: cpu: \"64\" ephemeral-storage: 1Ti hugepages-1Gi: \"0\" hugepages-2Mi: \"0\" memory: 250Gi pods: \"110\" capacity: cpu: \"64\" ephemeral-storage: 1Ti hugepages-1Gi: \"0\" hugepages-2Mi: \"0\" memory: 250Gi pods: \"128\" nodeInfo: architecture: amd64 bootID: \"\" containerRuntimeVersion: \"\" kernelVersion: \"\" kubeProxyVersion: fake kubeletVersion: fake machineID: \"\" operatingSystem: linux osImage: \"\" systemUUID: \"\" phase: Running EOF # create nodes as you needed for i in {0..99}; do sed \"s/{NODE_NAME}/kwok-node-$i/g\" node.yaml | kubectl apply -f -; done ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:4:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"å‹æµ‹ ä¸‹è½½ä»£ç å¹¶æ„å»ºï¼š git clone https://github.com/k-cloud-labs/scheduler-stress-test.git make build è¯¥å·¥å…·æ”¯æŒä¸¤ä¸ªå‘½ä»¤ï¼šcreate å’Œ waitã€‚ create å‘½ä»¤ä½¿ç”¨æŒ‡å®šçš„æ¨¡æ¿æ–‡ä»¶ï¼Œåœ¨ k8s é›†ç¾¤ä¸­ä»¥æŒ‡å®šçš„å¹¶å‘çº§åˆ«åˆ›å»ºæŒ‡å®šæ•°é‡çš„ podã€‚ wait å‘½ä»¤ç­‰å¾…æ‰€æœ‰ä¸Šè¿°åˆ›å»ºçš„ pod è¢«è°ƒåº¦å¹¶è¿ç»­æ‰“å°ç»“æœã€‚ ç¤ºä¾‹ï¼š # åˆ›å»º 1000 ä¸ª podï¼Œä½¿ç”¨ 1000 çš„å¹¶å‘çº§åˆ«ï¼ˆnamespace: scheduler-stress-testï¼‰ sst create --kubeconfig=/root/.kube/config --count 1000 --concurrency 1000 --pod-template=pod.yaml # ç­‰å¾…ç»“æœ sst wait --kubeconfig=/root/.kube/config --namespace=seduler-stress-test ä¸Šè¿°ç¤ºä¾‹ä½¿ç”¨é¡¹ç›®ä¸­çš„ pod.yaml ä½œä¸ºæ¨¡æ¿ï¼Œåœ¨ k8s é›†ç¾¤çš„ scheduler-stress-test å‘½åç©ºé—´ä¸­åˆ›å»ºäº† 1000 ä¸ª podã€‚ç„¶åç­‰å¾…å¹¶è¿ç»­æ‰“å°ç»“æœï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ pod.yaml æ–‡ä»¶ã€‚ Enjoy it!!! ","date":"2023-02-12","objectID":"https://www.likakuli.com/posts/scheduler-stress-test/:5:0","tags":["kubernetes"],"title":"è°ƒåº¦å™¨å‹æµ‹å·¥å…·ä»‹ç»","uri":"https://www.likakuli.com/posts/scheduler-stress-test/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"1.èƒŒæ™¯ Definition å‡†å…¥ Webhook æ˜¯ä¸€ç§ç”¨äºæ¥æ”¶å‡†å…¥è¯·æ±‚å¹¶å¯¹å…¶è¿›è¡Œå¤„ç†çš„ HTTP å›è°ƒæœºåˆ¶ã€‚ å¯ä»¥å®šä¹‰ä¸¤ç§ç±»å‹çš„å‡†å…¥ webhookï¼Œå³ éªŒè¯æ€§è´¨çš„å‡†å…¥ Webhook å’Œ ä¿®æ”¹æ€§è´¨çš„å‡†å…¥ Webhookã€‚ ä¿®æ”¹æ€§è´¨çš„å‡†å…¥ Webhook ä¼šå…ˆè¢«è°ƒç”¨ã€‚å®ƒä»¬å¯ä»¥æ›´æ”¹å‘é€åˆ° API æœåŠ¡å™¨çš„å¯¹è±¡ä»¥æ‰§è¡Œè‡ªå®šä¹‰çš„è®¾ç½®é»˜è®¤å€¼æ“ä½œã€‚ åœ¨å®Œæˆäº†æ‰€æœ‰å¯¹è±¡ä¿®æ”¹å¹¶ä¸” API æœåŠ¡å™¨ä¹ŸéªŒè¯äº†æ‰€ä¼ å…¥çš„å¯¹è±¡ä¹‹åï¼Œ éªŒè¯æ€§è´¨çš„ Webhook ä¼šè¢«è°ƒç”¨ï¼Œå¹¶é€šè¿‡æ‹’ç»è¯·æ±‚çš„æ–¹å¼æ¥å¼ºåˆ¶å®æ–½è‡ªå®šä¹‰çš„ç­–ç•¥ã€‚ ä»¥ä¸Šæ˜¯ kubernetes ç»™å‡ºçš„å®šä¹‰ï¼Œç®€å•æ¥è¯´ï¼Œk8s çš„ webhook åˆ†ä¸ºä¸¤ç±» validating å’Œ mutating åˆ†åˆ«ç”¨äºæ ¡éªŒå’Œä¿®æ”¹ k8s èµ„æºçš„ä¿®æ”¹æ“ä½œã€‚å½“ç”¨æˆ·åˆ›å»º or ä¿®æ”¹èµ„æºæ—¶ï¼Œapiserver ä¼šè°ƒç”¨(http)å·²æ³¨å†Œçš„ validating å’Œ mutating webhookï¼Œåœ¨è¿™äº› webhook å“åº”åæ‰çœŸæ­£å¤„ç†è¿™æ¬¡ä¿®æ”¹æ“ä½œã€‚ æ‰§è¡Œæµç¨‹\" æ‰§è¡Œæµç¨‹ å¯¹äºç†Ÿæ‚‰äº‘åŸç”Ÿå¼€å‘æˆ–ç†Ÿæ‚‰ k8s çš„å¼€å‘æ¥è¯´ï¼Œwebhook åº”è¯¥æ˜¯éå¸¸ç†Ÿæ‚‰çš„ä¸€å—ï¼Œä¹Ÿåº”è¯¥å†™è¿‡å¤šå¤šå°‘å°‘çš„ç›¸å…³ä»£ç ã€‚ä½œä¸º k8s åŸç”Ÿæä¾›çš„èƒ½åŠ›ï¼Œç›®å‰çš„ webhook å¼€å‘/ä½¿ç”¨æ–¹å¼å¯ä»¥è¯´æ˜¯éå¸¸ä¸å‹å¥½ä¸”å¾ˆåŸå§‹ï¼Œk8s å¾ˆå¤šèƒ½åŠ›éƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹å·²æœ‰çš„å¯¹è±¡æˆ– CRD çš„ä¿¡æ¯è¾¾åˆ°ç›®çš„ï¼ˆå¦‚æ›´æ–°é•œåƒï¼Œæ»šåŠ¨å‡çº§ç­‰ï¼‰ï¼Œå”¯æœ‰ webhook éœ€è¦å†™ä»£ç å¼€å‘ä¸”æ³¨å†Œåˆ° apiserver å¹¶è¿è¡Œç¨‹åºæ¥è¾¾åˆ°ç›®çš„ã€‚ ç„¶è€Œåœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¤§å¤šæ•°å¯¹äº webhook çš„éœ€æ±‚ä»…é™äºå¾ˆç®€å•çš„ä¸€äº›èƒ½åŠ›ï¼Œæ¯”å¦‚æ ¡éªŒæŸäº›å¯¹è±¡çš„å­—æ®µå’Œåˆæ³•æ€§ã€ä¿®æ”¹ç‰¹å®šçš„å¯¹è±¡çš„ä¿¡æ¯ï¼ˆæ‰“ labelã€annotation or ä¿®æ”¹èµ„æºè§„æ ¼ç­‰ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†æ¯æ¬¡æ–°å¢éœ€æ±‚æˆ–è€…ä¿®æ”¹éœ€æ±‚æ—¶éƒ½éœ€è¦å¼€å‘æ”¹ä»£ç æ‰“åŒ…å‘ç‰ˆã€‚è¿™ä½¿å¾—æ•´ä¸ªè¿‡ç¨‹æ•ˆç‡å¾ˆä½ï¼ŒåŒæ—¶ä¼šå­˜åœ¨ä¸€ä¸ªé›†ç¾¤å†…æ³¨å†Œäº†è¿‡å¤šçš„ webhook ä½¿ apiserver çš„å“åº”æ—¶é—´è¢«æ‹‰é•¿ï¼Œå¯é æ€§é™ä½ã€‚ ä¸ºäº†è§£å†³ä»¥ä¸Šçš„æåˆ°çš„è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€å¥—å…¨æ–°çš„åŸºäºè§„åˆ™çš„å¯ç¼–ç¨‹çš„ webhook â€“ kinitirasï¼Œå¸Œæœ›èƒ½é€šè¿‡è¯¥ç»„ä»¶æ¥ä»£æ›¿é›†ç¾¤å†…æ‰€æœ‰çš„ webhook å¹¶ä¸”æ‰€æœ‰çš„éœ€æ±‚å¯ä»¥é€šè¿‡è¯¥ç»„ä»¶æ¥è§£å†³æ— éœ€è‡ªå·±å¼€å‘æ–°çš„ webhookï¼Œæå‡æ•ˆç‡çš„åŒæ—¶å‡å°‘å› å¤šä¸ª webhook å¸¦æ¥çš„å®‰å…¨éšæ‚£ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:1:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"2.èƒ½åŠ› ç‰¹æ€§\" ç‰¹æ€§ åœ¨è®²è¿°å…¶è®¾è®¡ä¸å®ç°ä¹‹å‰ï¼Œè¿™é‡Œå…ˆè®²è¿°ä¸€ä¸‹ kinitiras èƒ½å¹²ä»€ä¹ˆï¼Œå…·å¤‡å“ªäº›èƒ½åŠ›ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:2:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"2.1 æ ¡éªŒèµ„æº ç­–ç•¥ä¾‹å­ æˆ‘ä»¬å¯ä»¥å¯¹ä¸åŒçš„èµ„æºé…ç½®ä¸åŒçš„ç­–ç•¥ï¼Œä»è€Œå‡å°‘å‡ºç°ä¸€äº›ä¸å¯æ§æƒ…å†µæˆ–è€…é™åˆ¶ä¸€äº›ç‰¹æ®Šæ“ä½œï¼Œæ¯”å¦‚ï¼š å¯¹äºåˆ›å»ºæ›´æ–°æ“ä½œï¼Œå¯ä»¥å¯¹èµ„æºçš„ä¸€äº›å­—æ®µè¿›è¡Œé™åˆ¶ï¼ˆä¸å¯ç©º æˆ–è€… å…¶å€¼ç­‰äºä¸ç­‰äºæŒ‡å®šçš„å€¼ç­‰ç­‰ï¼‰ é™åˆ¶æ›´æ–°æˆ–åˆ é™¤æ“ä½œã€‚å¯ä»¥å¯¹ä¸€äº›ç‰¹å®šçš„èµ„æºï¼ˆns or deploymentï¼‰è¿›è¡Œç¦æ­¢åˆ é™¤æˆ–è€…äºŒæ¬¡ç¡®è®¤æœºåˆ¶ï¼ˆåªæœ‰å­˜åœ¨æŒ‡å®šçš„ annotation æ‰å…è®¸åˆ é™¤ï¼‰ å­—æ®µæ ¡éªŒ è¿™äº›æ ¡éªŒçš„å­—æ®µå’Œå€¼å¯ä»¥ä¸ºå½“å‰çš„ object çš„å€¼ ä¹Ÿå¯ä»¥è·Ÿå…¶ä»– object çš„å€¼ï¼ˆæ¯”å¦‚ä¸ cm æˆ–è€… secret ç­‰å…¶ä»– object å¯¹æ¯”ï¼‰ä¹Ÿä¸ºç¬¬ä¸‰æ–¹ http æœåŠ¡è·å–çš„æ•°æ®è¿›è¡Œå¯¹æ¯”æ ¡éªŒã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:2:1","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"2.2 ä¿®æ”¹èµ„æº ç­–ç•¥ä¾‹å­ å¯¹äºä¿®æ”¹èµ„æºï¼Œæˆ‘ä»¬çš„ç­–ç•¥å¯ä»¥é…ç½®å¾ˆå¤šä¸åŒåœºæ™¯ï¼Œæ»¡è¶³ä¸åŒçš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼š ç»™èµ„æºç»Ÿä¸€æ‰“æ ‡ç­¾æ‰“ annotation ä¿®æ”¹èµ„æºè§„æ ¼ ä¿®æ”¹èµ„æºçš„ affinity toleration ç­‰ è€Œè¿™ä¸ªä¿®æ”¹çš„å€¼ï¼Œå‡å¯ä»¥ä¸ºåŠ¨æ€çš„ï¼Œå¯ä»¥ä»åˆ«çš„ object è·å–ï¼ˆæ¯”å¦‚æŠŠ owner çš„å±æ€§å†™åˆ° pod ä¸Šï¼‰ä¹Ÿå¯ä»¥ä»ç¬¬ä¸‰æ–¹ http æœåŠ¡è·å–ï¼ˆæˆ‘è‡ªå·±æœ‰ç±»ä¼¼çš„éœ€æ±‚ï¼‰ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:2:2","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"3.è®¾è®¡ Kinitiras æ˜¯æ¥è‡ªå¸Œè…Šè¯­ ÎºÎ¹Î½Î·Ï„Î®ÏÎ±Ï‚ (kiniÌ±tÃ­Ì±ras)ï¼Œæ„æ€ä¸ºå‘åŠ¨æœºï¼ˆengine/motorï¼‰ï¼Œè¯¥é¡¹ç›®çš„æ ¸å¿ƒèƒ½åŠ›ä¹Ÿæ˜¯ä¸€ä¸ªåŸºäºç­–ç•¥/è§„åˆ™çš„å¼•æ“ï¼Œæä¾›é«˜æ•ˆå¼ºå¤§çš„èƒ½åŠ›ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:3:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"3.1 åŸºç¡€æ¦‚å¿µ æ¦‚å¿µ æ„ä¹‰ è¯´æ˜ validating æ ¡éªŒ éªŒè¯èµ„æºå¯¹è±¡çš„åˆæ³•æ€§ mutating ä¿®æ”¹ ä¿®æ”¹èµ„æºå¯¹è±¡çš„å­—æ®µ policy ç­–ç•¥/è§„åˆ™ ä¸€æ¡å¯æ‰§è¡Œçš„ç­–ç•¥/è§„åˆ™ override policy ä¿®æ”¹ç­–ç•¥ è¡¨ç¤ºç”¨äºä¿®æ”¹èµ„æºçš„ç­–ç•¥ validate policy æ ¡éªŒç­–ç•¥ è¡¨ç¤ºç”¨äºæ ¡éªŒèµ„æºçš„ç­–ç•¥ cue cue è¯­è¨€ æ˜¯ä¸€ä¸ªå¼€æºçš„å¯ç¼–ç¨‹çš„ json è¶…é›†ï¼Œhttps://cuelang.org ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:3:1","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"3.2 æ ¸å¿ƒé€»è¾‘ kinitiras æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š åˆ†åˆ«å®šä¹‰ validating å’Œ mutating å¯¹åº”çš„ crd è¡¨ç¤ºä¸€æ¡ç­–ç•¥ï¼ˆpolicyï¼‰ï¼Œè®°å½•ç­–ç•¥ç”Ÿæ•ˆçš„èŒƒå›´ï¼ˆæŒ‡å®šèµ„æºåç§°æˆ– labelï¼‰å’Œæ‰§è¡Œè§„åˆ™ï¼ˆæ ¡éªŒæˆ–ä¿®æ”¹å†…å®¹ï¼‰ æ³¨å†Œç»Ÿä¸€çš„ webhook configurationï¼Œé»˜è®¤è®¢é˜…æ‰€æœ‰å¸¦æœ‰ç‰¹å®š label çš„èµ„æºçš„ä¿®æ”¹åˆ é™¤äº‹ä»¶ï¼ˆå®‰è£…æ—¶å¯è‡ªå®šä¹‰è¯¥é…ç½®ï¼‰ åœ¨æ”¶åˆ° apiserver çš„å›è°ƒæ—¶ï¼Œå½“å‰è¢«ä¿®æ”¹çš„èµ„æºå’Œå·²æœ‰çš„ç­–ç•¥åŒ¹é…ç­›é€‰å‘½ä¸­çš„ç­–ç•¥åˆ—è¡¨ æŒ‰å¾ªåºæ‰§è¡Œç­–ç•¥ ç­–ç•¥å¼•æ“æ ¸å¿ƒé€»è¾‘(æµç¨‹ä¸­æ­¥éª¤ 3 å’Œæ­¥éª¤ 4 æ ‡åäº†)\" ç­–ç•¥å¼•æ“æ ¸å¿ƒé€»è¾‘(æµç¨‹ä¸­æ­¥éª¤ 3 å’Œæ­¥éª¤ 4 æ ‡åäº†) ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:3:2","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"3.3 Api definition æœ¬é¡¹ç›®å®šä¹‰äº†ä¸‰ä¸ª CRDï¼š OverridePolicy: ç”¨æ¥ä¿®æ”¹èµ„æºä¿¡æ¯ï¼ˆnamespace çº§åˆ«ï¼‰ ClusterOverridePolicy: ç”¨æ¥ä¿®æ”¹èµ„æºä¿¡æ¯ï¼ˆcluster çº§åˆ«ï¼‰ ClusterValidatePolicy: ç”¨æ¥æ ¡éªŒèµ„æºä¿¡æ¯ï¼ˆcluster çº§åˆ«ï¼‰ ä¸‹é¢å°†å®šä¹‰çš„ crd çš„æ ¸å¿ƒéƒ¨åˆ†ç®€å•è®²è§£ä¸€ä¸‹ã€‚ 3.3.1 Resource selector ResourceSelector the resources will be selected. Field type required Description apiVersion string Y APIVersion represents the API version of the target resources. kind string Y Kind represents the Kind of the target resources. namespace string N Namespace of the target resource. Default is empty, which means inherit from the parent object scope. name string N Name of the target resource. Default is empty, which means selecting all resources. labelSelector Kubernetes meta/v1.LabelSelector N A label query over a set of resources. If name is not empty, labelSelector will be ignored. fieldSelector FieldSelector N A field query over a set of resources. If name is not empty, fieldSelector wil be ignored. è¯¥ç»“æ„æ˜¯ç”¨äºé€‰æ‹©ç­–ç•¥åŒ¹é…èµ„æºï¼Œå¯ä»¥æŒ‡å®šç‰¹å®šçš„æŸä¸ªèµ„æºï¼Œä¹Ÿå¯ä»¥é€‰æ‹©æŒ‡å®š label æˆ– field çš„æ–¹å¼å¯¹ä¸€ç»„èµ„æºéƒ½ç”Ÿæ•ˆã€‚ for example: # match with all the pod which contains label webhook:enabledresourceSelectors:- apiVersion:v1kind:PodlabelSelector:matchLabels:webhook:enabled 3.3.2 Validate rule Defines validate rules on operations. Field type required Description targetOperations []Kubernetes admission/v1.Operation Y Operations is the operations the admission hook cares about - CREATE, UPDATE, DELETE, CONNECT or * for all of those operations and any future admission operations that are added. If * is present, the length of the slice must be one. cue string N Cue represents validate rules defined with cue code. template ValidateRuleTemplate N Template of condition which defines validate cond, and it will be rendered to CUE and store in RenderedCue field, so if there are any data added manually will be erased. renderedCue string N RenderedCue represents validate rule defined by Template. Donâ€™t modify the value of this field, modify Rules instead of. è¿™é‡Œæ˜¯å®šä¹‰ validate ç­–ç•¥çš„æ‰§è¡Œé€»è¾‘ç›¸å…³ä¿¡æ¯ã€‚ targetOperationsï¼šè¡¨ç¤ºç”Ÿæ•ˆçš„æ“ä½œç±»å‹ï¼Œå³å¯ä»¥å®šä¹‰åªå¯¹åˆ›å»º or delete äº‹ä»¶ç”Ÿæ•ˆ cueï¼šè¯¥å­—æ®µå¯å¡«å†™ä¸€æ®µ cue ä»£ç ï¼Œä¼šåœ¨å‘½ä¸­ç­–ç•¥åæ‰§è¡Œè¯¥ä»£ç ï¼Œè¯·çœ‹ä¸‹é¢ Example templateï¼šå®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼Œå°†ä¸€äº›å¸¸è§çš„æ ¡éªŒå¸¸è§æ¨¡æ¿åŒ–ï¼ˆæ— éœ€å†™ cue äº†ï¼‰ renderedCueï¼šæ¨¡æ¿æœ€ç»ˆä¼šè‡ªåŠ¨æ¸²æŸ“æˆ cue ä»£ç å¹¶å­˜å‚¨åˆ°è¯¥å­—æ®µä¸Šã€‚ cue exampleï¼š validateRules:# è¿™æ®µä»£ç è¡¨ç¤ºï¼Œæ£€æŸ¥å½“å‰èµ„æºçš„ label å¦‚æœæœ‰ä¸å¯åˆ é™¤çš„æ ‡è¯†ï¼Œåˆ™æ‹’ç»è¿™æ¬¡åˆ é™¤æ“ä½œ- cue:|-object: _ @tag(object) reject: object.metadata.labels != null \u0026\u0026 object.metadata.labels[\"xxx.io/no-delete\"] == \"true\" validate: { if reject{ reason: \"operation rejected\" } if !reject{ reason: \"\" } valid: !reject }targetOperations:- DELETE template example: # è¡¨ç¤º å­˜åœ¨ no-delete annotation æ—¶ æ‹’ç»æœ¬æ¬¡åˆ é™¤æ“ä½œvalidateRules:- targetOperations:- DELETEtemplate:type:condition# å½“å‰åªæœ‰ condition ä¸€ä¸ªç±»å‹ï¼Œåç»­æ‰©å±•condition:affectMode:reject# è¡¨ç¤ºå‘½ä¸­è¯¥è§„åˆ™æ˜¯æ‹’ç»ï¼Œå¯ä»¥è®¾ç½®ä¸º allow è¡¨ç¤ºåªæœ‰å‘½ä¸­æ—¶æ‰å‡†å…¥ï¼Œé»˜è®¤æ˜¯ rejectcond:Exist# æ”¯æŒå­˜åœ¨ ä¸å­˜åœ¨ å¤§äº å°äº ç­‰æ“ä½œmessage:\"cannot delete this ns\"# å‘½ä¸­æ—¶è¿”å›çš„ä¿¡æ¯dataRef:# æ ¡éªŒçš„æ•°æ®æ¥æºfrom:current# current è¡¨ç¤ºå½“å‰ object ä¸­è·å–ï¼Œæ”¯æŒä»å½“å‰é›†ç¾¤çš„å…¶ä»–èµ„æºæˆ–è€…é€šè¿‡ http è¯·æ±‚è·å–æ•°æ®path:\"/metadata/annotations/no-delete\"# æ•°æ® path è¿™ç§æ¨¡æ¿åŒ–çš„æ–¹å¼ï¼Œå¯ä»¥å‡å°‘å­¦ä¹  cue çš„æˆæœ¬ï¼Œèƒ½æ»¡è¶³å¤§éƒ¨åˆ†åˆ¤æ–­å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œä¸å…¶ä»–å­—æ®µåšå¤§å°å¯¹æ¯”ç­‰åœºæ™¯ã€‚ 3.3.3 Override rule Overriders offers various alternatives to represent the override rules. If more than one alternative exist, they will be applied with following order: RenderCue Cue Plaintext Field type required Description plaintext []PlaintextOverrider N Plaintext represents override rules defined with plaintext overriders. cue string N Cue represents override rules defined with cue code. template OverrideRuleTemplate N Template of rule which defines override rule, and it will be rendered to CUE and store in RenderedCue field, so if there are any data added manually will be erased. renderedCue string N RenderedCue represents override rule defined by Template. Donâ€™t modify the value of this field, modify Rules instead of. è¿™é‡Œå®šä¹‰ Override policy çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå³ä¿®æ”¹èµ„æºä¿¡æ¯ç­–ç•¥ï¼Œå…¶å«ä¹‰å¦‚ä¸‹ï¼š plaintextï¼šä¸ºç®€å•çš„ä¿®æ”¹æ–¹å¼ï¼Œå¡«å†™æ“ä½œçš„å­—æ®µå’Œå€¼å³å¯ cueï¼šè¯¥å­—æ®µå¯å¡«å†™ä¸€æ®µ cue ä»£ç ï¼Œä¼šåœ¨å‘½ä¸­ç­–ç•¥åæ‰§è¡Œè¯¥ä»£ç ï¼Œè¯·çœ‹ä¸‹é¢ Example templateï¼šå®šä¹‰äº†ä¸€ä¸ªç®€å•çš„æ¨¡æ¿ï¼Œå°†ä¸€äº›å¸¸è§çš„ä¿®æ”¹æ¨¡æ¿åŒ–ï¼ˆæ— éœ€å†™ cue äº†ï¼‰ renderedCueï¼šæ¨¡æ¿æœ€ç»ˆä¼šè‡ªåŠ¨æ¸²æŸ“æˆ cue ä»£ç å¹¶å­˜å‚¨åˆ°è¯¥å­—æ®µä¸Šã€‚ plaintext exampleï¼š overrideRules:- targetOperations:- CREATEoverriders:plaintext:# ä¸ºæ•°ç»„ï¼Œå¯åŒæ—¶ä¿®æ”¹å¤šä¸ªå­—æ®µå€¼ï¼Œä¼šç›´æ¥ apply åˆ°å¯¹è±¡ä¸Š- path:/metadata/annot","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:3:3","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"4.å®ç° ä¸Šé¢æŠŠ kinitiras çš„å·¥ä½œåŸç†å’Œæ ¸å¿ƒæ¦‚å¿µè¿›è¡Œäº†è®²è¿°ï¼Œä»è¿™é‡Œå¼€å§‹å°†å…¶æ ¸å¿ƒèƒ½åŠ›çš„å®ç°é•œåƒç®€å•çš„æè¿°ï¼Œæ–¹ä¾¿ä½¿ç”¨æ—¶debug æˆ–äº†è§£åº•å±‚å®ç°ã€‚ é¡¹ç›®ç»“æ„ é¡¹ç›®æ•´ä½“æ¥è¯´åˆ†ä¸‰ä¸ª repoï¼Œåˆ†åˆ«æ˜¯ kinitiras, pkg, pidalioã€‚æ¯ä¸ª repo çš„å®šä½ä¸åŒï¼Œå…¶ä¸­ kinitiras ä¸ºæ¯”è¾ƒå¸¸è§„çš„ webhook é¡¹ç›®ï¼Œè´Ÿè´£å°†è‡ªå·±æ³¨å†Œåˆ° apiserverï¼Œå¤„ç†å›è°ƒï¼Œpkgåˆ™ä¸ºæ ¸å¿ƒæ¨¡å—çš„å®ç°ï¼Œæ¯”å¦‚ api å®šä¹‰ï¼Œæ‰§è¡Œç­–ç•¥ç­‰ã€‚è€Œ pidalio ä¸º client-go çš„ transport ä¸­é—´ä»¶ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯æ‹¦æˆªè¯·æ±‚æ‰§è¡Œç­–ç•¥çš„åº”ç”¨ã€‚æœ¬ç¯‡é‡ç‚¹è®²è¿°å‰ä¸¤ä¸ª repo çš„æ ¸å¿ƒå®ç°ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:4:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"4.1 kinitiras é¡¹ç›®åœ°å€ï¼šhttps://github.com/k-cloud-labs/kinitiras æœ¬é¡¹ç›®ä½œä¸ºä¸€ä¸ª webhookï¼Œæ ¸å¿ƒé€»è¾‘å°±æ˜¯ï¼Œåˆå§‹åŒ–å„ä¸ªå‚æ•°å’Œå°†è‡ªå·±æ³¨å†Œåˆ° apiserverï¼Œç„¶ååœ¨å›è°ƒå‡½æ•°é‡Œè°ƒç”¨ pkg æä¾›çš„ç»Ÿä¸€å¤„ç†æ–¹æ³•å³å¯ã€‚ 4.1.2 åˆå§‹åŒ– // Run runs the webhook server with options. This should never exit. func Run(ctx context.Context, opts *options.Options) error { klog.InfoS(\"kinitiras webhook starting.\", \"version\", version.Get()) config, err := controllerruntime.GetConfig() if err != nil { panic(err) } config.QPS, config.Burst = opts.KubeAPIQPS, opts.KubeAPIBurst hookManager, err := controllerruntime.NewManager(config, controllerruntime.Options{ // ... set options }) if err != nil { klog.ErrorS(err, \"failed to build webhook server.\") return err } // init clients, informer, lister sm := \u0026setupManager{} if err := sm.init(hookManager, ctx.Done()); err != nil { klog.ErrorS(err, \"init setup manager failed\") return err } if err := sm.waitForCacheSync(ctx); err != nil { klog.ErrorS(err, \"wait for cache sync failed\") return err } if err := sm.setupInterrupter(); err != nil { klog.ErrorS(err, \"setup interrupter failed\") return err } setupCh, err := cert.SetupCertRotator(hookManager, cert.Options{ // ... set options }) if err != nil { klog.ErrorS(err, \"failed to setup cert rotator controller.\") return err } go func() { \u003c-setupCh // register handler here hookServer := hookManager.GetWebhookServer() hookServer.Register(\"/mutate\", \u0026webhook.Admission{Handler: pkgwebhook.NewMutatingAdmissionHandler(sm.overrideManager, sm.policyInterrupterManager)}) hookServer.Register(\"/validate\", \u0026webhook.Admission{Handler: pkgwebhook.NewValidatingAdmissionHandler(sm.validateManager, sm.policyInterrupterManager)}) hookServer.WebhookMux.Handle(\"/readyz\", http.StripPrefix(\"/readyz\", \u0026healthz.Handler{})) }() // blocks until the context is done. if err := hookManager.Start(ctx); err != nil { klog.ErrorS(err, \"webhook server exits unexpectedly.\") return err } // never reach here return nil } ä¸Šè¿°ä»£ç æ¯”è¾ƒå¸¸è§„ï¼Œåªæœ‰ sm.setupInterrupter() è¿™å—å•ç‹¬è¯´ä¸€ä¸‹ã€‚æœ¬ webhook è‡ªå®šä¹‰äº†å‡ ä¸ª CRD ä½œä¸ºç­–ç•¥çš„è½½ä½“ï¼Œè€Œç­–ç•¥æœ¬èº«ä¹Ÿéœ€è¦è¿›è¡Œæ ¡éªŒå’Œä¿®æ”¹ï¼Œå°¤å…¶æ˜¯æä¾›äº†æ¨¡æ¿åŒ–(template)åï¼Œæ¨¡æ¿éœ€è¦æ¸²æŸ“æˆ cue è„šæœ¬ï¼Œä¸ºäº†èƒ½å¤Ÿåœ¨ç­–ç•¥åˆ›å»ºæ—¶è¿›è¡Œæ ¡éªŒå’Œæ¸²æŸ“ï¼Œå¼•è¿›äº† interrupterçš„æ¦‚å¿µã€‚Interrupter é¡¾åæ€ä¹‰ â€“ æ‹¦æˆªå™¨ï¼Œç”¨æ¥æ‹¦æˆªç­–ç•¥å¹¶å¯¹ç­–ç•¥çš„ç‰¹å®šå­—æ®µè¿›è¡Œæ ¡éªŒå’Œå¯¹æ¨¡ç‰ˆè¿›è¡Œæ¸²æŸ“ï¼Œè¿™äº›é€»è¾‘ä¸å¸¸è§„çš„å¯¹è±¡çš„æ ¡éªŒå’Œä¿®æ”¹ä¸å¤ªä¸€æ ·ï¼Œå› æ­¤ä¸èµ°æ™®é€šçš„é€»è¾‘ï¼Œåªç»è¿‡ interrupterçš„é€»è¾‘éƒ¨åˆ†ã€‚è€Œä¸Šè¿°çš„çš„ sm.setupInterrupter() æ˜¯ç”¨æ¥åˆå§‹åŒ–è¿™äº› interrupter çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š func (s *setupManager) setupInterrupter() error { // åˆå§‹åŒ–æ¨¡æ¿ -- æ¨¡æ¿æ¸²æŸ“æ˜¯åŸºäº go.tmpl å®ç°çš„ï¼Œå› æ­¤è¿™é‡Œåˆå§‹åŒ– tmpl otm, err := templatemanager.NewOverrideTemplateManager(\u0026templatemanager.TemplateSource{ Content: templates.OverrideTemplate, TemplateName: \"BaseTemplate\", }) if err != nil { klog.ErrorS(err, \"failed to setup mutating template manager.\") return err } // åˆå§‹åŒ–æ¨¡æ¿ -- æ¨¡æ¿æ¸²æŸ“æ˜¯åŸºäº go.tmpl å®ç°çš„ï¼Œå› æ­¤è¿™é‡Œåˆå§‹åŒ– tmpl vtm, err := templatemanager.NewValidateTemplateManager(\u0026templatemanager.TemplateSource{ Content: templates.ValidateTemplate, TemplateName: \"BaseTemplate\", }) if err != nil { klog.ErrorS(err, \"failed to setup validate template manager.\") return err } // base baseInterrupter := interrupter.NewBaseInterrupter(otm, vtm, templatemanager.NewCueManager()) // op overridePolicyInterrupter := interrupter.NewOverridePolicyInterrupter(baseInterrupter, s.tokenManager, s.client, s.opLister) // register interrupter to manager s.policyInterrupterManager.AddInterrupter(schema.GroupVersionKind{ Group: policyv1alpha1.SchemeGroupVersion.Group, Version: policyv1alpha1.SchemeGroupVersion.Version, Kind: \"OverridePolicy\", }, overridePolicyInterrupter) // cop s.policyInterrupterManager.AddInterrupter(schema.GroupVersionKind{ Group: policyv1alpha1.SchemeGroupVersion.Group, Version: policyv1alpha1.SchemeGroupVersion.Version, Kind: \"ClusterOverridePolicy\", }, interrupter.NewClusterOverridePolicyInterrupter(overridePolicyInterrupter, s.copLister)) // cvp s.policyInterrupterManager.AddInterrupter(schema.GroupVersionKind{ Group: policyv1alpha1.SchemeGroupVersion.Group, Version: policyv1alpha1.SchemeGroupVersion.Version, Kind: \"ClusterValidatePolicy\", }, interrupter.NewClusterValidatePolicyInterrupter(baseInterrupter, s.tokenManager, s.client, s.cvpLister)) return s.policyInterrupterManager.OnStar","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:4:1","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"4.2 pkg é¡¹ç›®åœ°å€ï¼š https://github.com/k-cloud-labs/pkg pkg åŒ…å«äº†å¤§éƒ¨åˆ†é€»è¾‘çš„å®ç°ï¼ŒåŒæ—¶ä¹ŸåŒ…å«äº† crd çš„å®šä¹‰å’Œç”Ÿæˆçš„ client ä»£ç ã€‚æ¥ä¸Šé¢çš„æåˆ°çš„å†…å®¹ï¼Œè¿™é‡Œä¸»è¦è®²è¿°interrupterçš„å®ç°éƒ¨åˆ†å’Œç­–ç•¥çš„å‘½ä¸­å’Œæ‰§è¡Œéƒ¨åˆ†ã€‚ 4.2.1 interrupter å…ˆçœ‹å®šä¹‰: // PolicyInterrupterManager manage multi PolicyInterrupter and decide which one to use by gvk. type PolicyInterrupterManager interface { PolicyInterrupter // AddInterrupter add a PolicyInterrupter to manager, // it will replace interrupter if already add with same gvk.s AddInterrupter(gvk schema.GroupVersionKind, pi PolicyInterrupter) } // PolicyInterrupter defines interrupt process for policy change // It validate and mutate policy. type PolicyInterrupter interface { // OnMutating called on \"/mutating\" api to complete policy // return nil means obj is not defined policy OnMutating(obj, oldObj *unstructured.Unstructured, operation admissionv1.Operation) ([]jsonpatchv2.JsonPatchOperation, error) // OnValidating called on \"/validating\" api to validate policy // return nil means obj is not defined policy or no invalid field OnValidating(obj, oldObj *unstructured.Unstructured, operation admissionv1.Operation) error // OnStartUp called when webhook process initialize // return error if initial phase get any error OnStartUp() error } PolicyInterrupterManager ç»§æ‰¿äº† PolicyInterrupter å¹¶æ–°å¢ä¸€ä¸ªæ·»åŠ  interrupter çš„æ–¹æ³•ï¼Œç”¨æ¥ç®¡ç†å¤šä¸ª interrupterã€‚è€Œæ¯ä¸€ä¸ª interrupter éƒ½ä¼šå®ç°ä¸‹é¢çš„ä¸‰ä¸ªæ–¹æ³•ï¼š OnMutating: åœ¨ apiserver å›è°ƒ /mutating æ¥å£æ—¶è°ƒç”¨ï¼Œä¸»è¦ç”¨æ¥æ¸²æŸ“å’Œè¡¥å……ç­–ç•¥ä¿¡æ¯ OnValidating: åœ¨ apiserver å›è°ƒ /validating æ¥å£æ—¶è°ƒç”¨ï¼Œä¸»è¦ç”¨æ¥æ ¡éªŒç­–ç•¥ä¿¡æ¯ OnStartUp: åœ¨ webhook å¯åŠ¨é˜¶æ®µè°ƒç”¨ï¼Œå¯åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼ˆæ‹‰å–ç¼“å­˜ç­‰ï¼‰ è€Œ manager çš„å®ç°ä¸å®é™… interrupter ä¸åŒï¼Œå®ƒé¦–å…ˆè¯†åˆ«å½“å‰çš„èµ„æºæ˜¯ä¸æ˜¯æˆ‘ä»¬å®šä¹‰çš„ç­–ç•¥ crdï¼Œç„¶åä»å†…å­˜æ‰¾æœ‰æ²¡æœ‰å¯¹åº”çš„æ³¨å†Œçš„ interrupter å†å»è°ƒç”¨è¯¥ interrupter çš„å¯¹åº”æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š type policyInterrupterManagerImpl struct { interrupters sync.Map } func (p *policyInterrupterManagerImpl) OnValidating(obj, oldObj *unstructured.Unstructured, operation admissionv1.Operation) error { if interrupter := p.getInterrupter(obj); interrupter != nil { return interrupter.OnValidating(obj, oldObj, operation) } return nil } func (p *policyInterrupterManagerImpl) getInterrupter(obj *unstructured.Unstructured) PolicyInterrupter { if !p.isKnownPolicy(obj) { klog.V(5).InfoS(\"unknown policy\", \"gvk\", obj.GroupVersionKind()) return nil } i, ok := p.interrupters.Load(obj.GroupVersionKind()) if ok { klog.V(4).InfoS(\"sub interrupter found\", \"gvk\", obj.GroupVersionKind()) return i.(PolicyInterrupter) } return nil } func (p *policyInterrupterManagerImpl) isKnownPolicy(obj *unstructured.Unstructured) bool { group := strings.Split(obj.GetAPIVersion(), \"/\")[0] return group == policyv1alpha1.SchemeGroupVersion.Group } 4.2.2 æ¸²æŸ“ æ¸²æŸ“è¿™ä¸ªäº‹å„¿å‰é¢å·²ç»æäº†æ— æ•°éï¼Œè¿™é‡Œå°†ä¸€æ¬¡æ€§å°†æ¸²æŸ“ç›¸å…³çš„è®¾è®¡å’Œå®ç°éƒ½è®²æ¸…æ¥šã€‚ å…ˆè¯´èƒŒæ™¯ã€‚ æœ¬é¡¹ç›®åœ¨æ—©æœŸå°±æ”¯æŒäº†ç”¨æˆ·æ‰‹å†™ cue çš„æ–¹å¼åœ¨ç­–ç•¥ä¸­æ‰§è¡Œå¤æ‚é€»è¾‘ï¼Œä»è€Œæ»¡è¶³ä¸åŒçš„éœ€æ±‚ã€‚ä½†æ˜¯å†™ cue éœ€è¦å¯¹è¿™ä¸ªè¯­è¨€çš„è¯­æ³•å’Œç‰¹æ€§æœ‰ä¸€å®šäº†è§£åŠ ä¸Šæ²¡æœ‰æ¯”è¾ƒå¥½çš„éªŒè¯ cue è„šæœ¬åˆæ³•æ€§çš„æœºåˆ¶ï¼Œå¯¼è‡´ä¸Šæ‰‹éš¾åº¦æ¯”è¾ƒé«˜ï¼Œå› æ­¤æƒ³åˆ°äº†æŠŠä¸€äº›å¸¸è§çš„æƒ…å†µæŠ½è±¡å‡ºæ¥ä¸€ä¸ªç»“æ„åŒ–çš„æ¨¡æ¿ï¼Œä½¿ç”¨è€…åªéœ€è¦åœ¨æ¨¡æ¿å¡«å†™å¿…è¦çš„å‚æ•°ï¼Œç”± webhook æœ¬èº«æŠŠè¿™ä¸ªæ¨¡æ¿ç¿»è¯‘æˆ cue è„šæœ¬ã€‚ ä¸ºäº†èƒ½å¤Ÿå°†ç»“æ„åŒ–æ•°æ®ç¿»è¯‘æˆ cue è„šæœ¬ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ go/tmpl (template link)ï¼Œç„¶åç»§ç»­ç¿»è¯‘ã€‚æµç¨‹å¦‚ä¸‹ï¼š interrupter æ£€æŸ¥æ˜¯å¦å¡«å†™æ¨¡æ¿ä¿¡æ¯ æ ¹æ®æ¨¡æ¿ç±»å‹è¿›è¡Œæ¸²æŸ“(tmpl.Execute) ç”Ÿæˆ cue è„šæœ¬ å¯¹ç»“æœè¿›è¡Œ format å’Œ lint æ£€æŸ¥ è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¹‹ä¸ºæ¸²æŸ“ã€‚ å†è¯´å®ç°ã€‚ ç”±äºç›¸å…³æ¨¡æ¿å’Œä»£ç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸è¿›è¡Œå±•ç¤ºï¼ŒåªæŠŠæ ¸å¿ƒå®ç°è¿›è¡Œè¯´æ˜ï¼š ä¸ºä¸åŒçš„ policy å†™äº†ä¸åŒçš„ tmplã€‚ç”±äº validate å’Œ override ç­–ç•¥çš„ cue æ‰§è¡Œç»“æœçš„ç»“æ„è¦æ±‚ä¸åŒï¼Œå› æ­¤å†™äº†ä¸¤ä»½ tmpl æ ¹æ® policy å»æ‰§è¡Œä¸åŒçš„æ¸²æŸ“ã€‚code link ä½¿ç”¨ cue å®˜æ–¹æä¾›çš„ go package è¿›è¡Œ format å’Œ lintã€‚cue åº•å±‚æ˜¯ go è¯­è¨€å®ç°çš„ï¼Œå› æ­¤å¯¹ go çš„æ”¯æŒæ¯”è¾ƒå‹å¥½ï¼Œæä¾›äº†ç›¸å…³ packageï¼Œå¯ä»¥åœ¨ä»£ç ä¸­ç›´æ¥ format å’Œ lint cue è„šæœ¬ï¼Œç¡®ä¿æ¸²æŸ“ååçš„ cue è„šæœ¬æ—¶åˆæ³•å¯è¿è¡Œçš„ã€‚code link 4.2.3 ç­–ç•¥å‘½ä¸­ å½“å‰ object å’Œç­–ç•¥çš„åŒ¹é…è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ—å‡ºå½“å‰æ‰€æœ‰çš„ç­–ç•¥ã€‚è¿™å—ä» informer å†…å­˜è¯»å–ï¼Œä¸”æ ¹æ®å½“å‰æ˜¯ validating è¿˜æ˜¯ mutating çš„æƒ…å†µè¯»å–ç›¸å¯¹åº”çš„ policy åˆ—è¡¨ã€‚ å¯¹äºæ²¡æœ‰è®¾ç½® resource selector çš„ç­–ç•¥ï¼Œé»˜è®¤è®¤ä¸ºå‘½ä¸­ã€‚ å¯¹äºè®¾ç½® resource selector çš„ç­–ç•¥ï¼Œè¿›è¡Œç­–ç•¥åŒ¹é…ï¼ˆä»£ç ä¸‹é¢ä¼šå±•ç¤ºã€‚ï¼‰ å†å¯¹å‘½ä¸­çš„ç­–ç•¥ä¸­è®¾ç½®æ“ä½œç±»å‹ä¸å½“å‰ object çš„æ“ä½œç±»å‹è¿›è¡ŒåŒ¹é…ã€‚ åŒ¹é…å®Œæˆã€‚ resource selector åŒ¹é…è§„åˆ™ï¼š any means no matter if itâ€™s empty or not name label selector field selector result not empty any any match name only empty empty empty match all empty not empty empty match labels only empty empty not empty match fields only empty not empty not empty match both labels and fields ç›¸å…³ä»£ç ï¼š // ResourceMatchSelectors tells if the specific resource matches the selectors. func ResourceMatchSelectors(resource *unstructured.Unstructured, selectors ...policyv1alpha1.ResourceSelector) bool { for _, rs := range selectors { // ä¸€ä¸ªç­–ç•¥å¯ä»¥é…ç½®å¤šä¸ª","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:4:2","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"5.æ€»ç»“ æœ¬ç¯‡ä»‹ç»äº† k-cloud-labs æ¨å‡ºçš„ webhook äº§å“ï¼Œå…¶åŠŸèƒ½å’Œå®ç”¨æ€§æ–¹é¢éƒ½éå¸¸ä¼˜ç§€ï¼Œæˆ‘ç°åœ¨ä½œä¸ºè¯¥é¡¹ç›®çš„å…¶ä¸­ä¸€ä¸ªç»´æŠ¤è€… å¯¹é¡¹ç›®è¿›è¡Œäº†ä¸€å®šçš„ç‰¹æ€§å¢åŠ å’Œä¼˜åŒ–ï¼ŒåæœŸå°†æŒç»­æ›´æ–°æ–°çš„èƒ½åŠ›ï¼Œè§£å†³æ›´å¤šçš„é—®é¢˜ã€‚ ä¸»è¦å†…å®¹ï¼š ä»‹ç»äº†å¼€å‘è¯¥ webhook çš„èƒŒæ™¯å’Œå…¶è§£å†³çš„é—®é¢˜ ä»‹ç»äº†æ ¸å¿ƒè®¾è®¡æ€è·¯å’Œ api å®šä¹‰ ä»‹ç»äº†å…¶æ ¸å¿ƒé€»è¾‘çš„å®ç° å…³äºæ›´è¯¦ç»†çš„è®¾è®¡ç»†èŠ‚å’Œä½¿ç”¨æ¡ˆä¾‹ä»¥åŠå®‰è£…æ–¹æ³•ï¼Œè¯·ç‚¹å‡»è¿™é‡Œè·³è½¬å®˜ç½‘å»äº†è§£ã€‚ ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:5:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"6.é“¾æ¥ğŸ”— å®˜æ–¹ï¼šhttps://k-cloud-labs.github.io/kinitiras-doc/ Githubï¼šhttps://github.com/k-cloud-labs ","date":"2023-02-03","objectID":"https://www.likakuli.com/posts/kinitiras-all/:6:0","tags":["kubernetes"],"title":"Kinitiras - å¯ç¼–ç¨‹ webhook è§„åˆ™å¼•æ“è¯¦è§£","uri":"https://www.likakuli.com/posts/kinitiras-all/"},{"categories":["éšç¬”"],"content":"ç¬¬ä¸€å· - å…³å¿ƒç¾¤ä¼—ç”Ÿæ´»ï¼Œæ³¨æ„å·¥ä½œæ–¹æ³• è¿™æ˜¯æ¯›æ³½ä¸œåœ¨ä¸€ä¹ä¸‰å››å¹´ä¸€æœˆäºŒåäºŒæ—¥è‡³äºŒæœˆä¸€æ—¥åœ¨æ±Ÿè¥¿ç‘é‡‘å¬å¼€çš„ç¬¬äºŒæ¬¡å…¨å›½å·¥å†œå…µä»£è¡¨å¤§ä¼šä¸Šæ‰€ä½œçš„ç»“è®ºçš„ä¸€éƒ¨åˆ†ã€‚ æœ‰ä¸¤ä¸ªé—®é¢˜ï¼ŒåŒå¿—ä»¬åœ¨è®¨è®ºä¸­æ²¡æœ‰ç€é‡æ³¨æ„ï¼Œæˆ‘è§‰å¾—åº”è¯¥æå‡ºæ¥è¯´ä¸€è¯´ã€‚ ","date":"2022-11-26","objectID":"https://www.likakuli.com/posts/thoughtfulessay2/:0:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”2 - ä¸€èµ·è¯»æ¯›é€‰","uri":"https://www.likakuli.com/posts/thoughtfulessay2/"},{"categories":["éšç¬”"],"content":"ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å…³äºç¾¤ä¼—ç”Ÿæ´»çš„é—®é¢˜ã€‚ æˆ‘ä»¬ç°åœ¨çš„ä¸­å¿ƒä»»åŠ¡æ˜¯åŠ¨å‘˜å¹¿å¤§ç¾¤ä¼—å‚åŠ é©å‘½æˆ˜äº‰ï¼Œä»¥é©å‘½æˆ˜äº‰æ‰“å€’å¸å›½ä¸»ä¹‰å’Œå›½æ°‘å…šï¼ŒæŠŠé©å‘½å‘å±•åˆ°å…¨å›½å»ï¼ŒæŠŠå¸å›½ä¸»ä¹‰èµ¶å‡ºä¸­å›½å»ã€‚è°è¦æ˜¯çœ‹è½»äº†è¿™ä¸ªä¸­å¿ƒä»»åŠ¡ï¼Œè°å°±ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é©å‘½å·¥ä½œäººå‘˜ã€‚æˆ‘ä»¬çš„åŒå¿—å¦‚æœæŠŠè¿™ä¸ªä¸­å¿ƒä»»åŠ¡çœŸæ­£çœ‹æ¸…æ¥šäº†ï¼Œæ‡‚å¾—æ— è®ºå¦‚ä½•è¦æŠŠé©å‘½å‘å±•åˆ°å…¨å›½å»ï¼Œé‚£æœ«ï¼Œæˆ‘ä»¬å¯¹äºå¹¿å¤§ç¾¤ä¼—çš„åˆ‡èº«åˆ©ç›Šé—®é¢˜ï¼Œç¾¤ä¼—çš„ç”Ÿæ´»é—®é¢˜ï¼Œå°±ä¸€ç‚¹ä¹Ÿä¸èƒ½ç–å¿½ï¼Œä¸€ç‚¹ä¹Ÿä¸èƒ½çœ‹è½»ã€‚å› ä¸ºé©å‘½æˆ˜äº‰æ˜¯ç¾¤ä¼—çš„æˆ˜äº‰ï¼Œåªæœ‰åŠ¨å‘˜ç¾¤ä¼—æ‰èƒ½è¿›è¡Œæˆ˜äº‰ï¼Œåªæœ‰ä¾é ç¾¤ä¼—æ‰èƒ½è¿›è¡Œæˆ˜äº‰ã€‚ å¦‚æœæˆ‘ä»¬å•å•åŠ¨å‘˜äººæ°‘è¿›è¡Œæˆ˜äº‰ï¼Œä¸€ç‚¹åˆ«çš„å·¥ä½œä¹Ÿä¸åšï¼Œèƒ½ä¸èƒ½è¾¾åˆ°æˆ˜èƒœæ•Œäººçš„ç›®çš„å‘¢ï¼Ÿå½“ç„¶ä¸èƒ½ã€‚æˆ‘ä»¬è¦èƒœåˆ©ï¼Œä¸€å®šè¿˜è¦åšå¾ˆå¤šçš„å·¥ä½œã€‚é¢†å¯¼å†œæ°‘çš„åœŸåœ°æ–—äº‰ï¼Œåˆ†åœŸåœ°ç»™å†œæ°‘ï¼›æé«˜å†œæ°‘çš„åŠ³åŠ¨çƒ­æƒ…ï¼Œå¢åŠ å†œä¸šç”Ÿäº§ï¼›ä¿éšœå·¥äººçš„åˆ©ç›Šï¼›å»ºç«‹åˆä½œç¤¾ï¼›å‘å±•å¯¹å¤–è´¸æ˜“ï¼›è§£å†³ç¾¤ä¼—çš„ç©¿è¡£é—®é¢˜ï¼Œåƒé¥­é—®é¢˜ï¼Œä½æˆ¿é—®é¢˜ï¼ŒæŸ´ç±³æ²¹ç›é—®é¢˜ï¼Œç–¾ç—…å«ç”Ÿé—®é¢˜ï¼Œå©šå§»é—®é¢˜ã€‚æ€»ä¹‹ï¼Œä¸€åˆ‡ç¾¤ä¼—çš„å®é™…ç”Ÿæ´»é—®é¢˜ï¼Œéƒ½æ˜¯æˆ‘ä»¬åº”å½“æ³¨æ„çš„é—®é¢˜ã€‚å‡å¦‚æˆ‘ä»¬å¯¹è¿™äº›é—®é¢˜æ³¨æ„äº†ï¼Œè§£å†³äº†ï¼Œæ»¡è¶³äº†ç¾¤ä¼—çš„éœ€è¦ï¼Œæˆ‘ä»¬å°±çœŸæ­£æˆäº†ç¾¤ä¼—ç”Ÿæ´»çš„ç»„ç»‡è€…ï¼Œç¾¤ä¼—å°±ä¼šçœŸæ­£å›´ç»•åœ¨æˆ‘ä»¬çš„å‘¨å›´ï¼Œçƒ­çƒˆåœ°æ‹¥æŠ¤æˆ‘ä»¬ã€‚åŒå¿—ä»¬ï¼Œé‚£æ—¶å€™ï¼Œæˆ‘ä»¬å·å¬ç¾¤ä¼—å‚åŠ é©å‘½æˆ˜äº‰ï¼Œèƒ½å¤Ÿä¸èƒ½å¤Ÿå‘¢ï¼Ÿèƒ½å¤Ÿçš„ï¼Œå®Œå…¨èƒ½å¤Ÿçš„ã€‚ ","date":"2022-11-26","objectID":"https://www.likakuli.com/posts/thoughtfulessay2/:1:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”2 - ä¸€èµ·è¯»æ¯›é€‰","uri":"https://www.likakuli.com/posts/thoughtfulessay2/"},{"categories":["éšç¬”"],"content":"ç¬¬äºŒä¸ªé—®é¢˜æ˜¯å…³äºå·¥ä½œæ–¹æ³•çš„é—®é¢˜ã€‚ æˆ‘ä»¬æ˜¯é©å‘½æˆ˜äº‰çš„é¢†å¯¼è€…ã€ç»„ç»‡è€…ï¼Œæˆ‘ä»¬åˆæ˜¯ç¾¤ä¼—ç”Ÿæ´»çš„é¢†å¯¼è€…ã€ç»„ç»‡è€…ã€‚ç»„ç»‡é©å‘½æˆ˜äº‰ï¼Œæ”¹è‰¯ç¾¤ä¼—ç”Ÿæ´»ï¼Œè¿™æ˜¯æˆ‘ä»¬çš„ä¸¤å¤§ä»»åŠ¡ã€‚åœ¨è¿™é‡Œï¼Œå·¥ä½œæ–¹æ³•çš„é—®é¢˜ï¼Œå°±ä¸¥é‡åœ°æ‘†åœ¨æˆ‘ä»¬çš„é¢å‰ã€‚æˆ‘ä»¬ä¸ä½†è¦æå‡ºä»»åŠ¡ï¼Œè€Œä¸”è¦è§£å†³å®Œæˆä»»åŠ¡çš„æ–¹æ³•é—®é¢˜ã€‚æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯è¿‡æ²³ï¼Œä½†æ˜¯æ²¡æœ‰æ¡¥æˆ–æ²¡æœ‰èˆ¹å°±ä¸èƒ½è¿‡ã€‚ä¸è§£å†³æ¡¥æˆ–èˆ¹çš„é—®é¢˜ï¼Œè¿‡æ²³å°±æ˜¯ä¸€å¥ç©ºè¯ã€‚ä¸è§£å†³æ–¹æ³•é—®é¢˜ï¼Œä»»åŠ¡ä¹Ÿåªæ˜¯çè¯´ä¸€é¡¿ã€‚ä¸æ³¨æ„æ‰©å¤§çº¢å†›çš„é¢†å¯¼ï¼Œä¸è®²ç©¶æ‰©å¤§çº¢å†›çš„æ–¹æ³•ï¼Œå°½ç®¡æŠŠæ‰©å¤§çº¢å†›å¿µä¸€åƒéï¼Œç»“æœè¿˜æ˜¯ä¸èƒ½æˆåŠŸã€‚å…¶ä»–å¦‚æŸ¥ç”°å·¥ä½œâ‘¹ã€ç»æµå»ºè®¾å·¥ä½œã€æ–‡åŒ–æ•™è‚²å·¥ä½œã€æ–°åŒºè¾¹åŒºçš„å·¥ä½œï¼Œä¸€åˆ‡å·¥ä½œï¼Œå¦‚æœä»…ä»…æå‡ºä»»åŠ¡è€Œä¸æ³¨æ„å®è¡Œæ—¶å€™çš„å·¥ä½œæ–¹æ³•ï¼Œä¸åå¯¹å®˜åƒšä¸»ä¹‰çš„å·¥ä½œæ–¹æ³•è€Œé‡‡å–å®é™…çš„å…·ä½“çš„å·¥ä½œæ–¹æ³•ï¼Œä¸æŠ›å¼ƒå‘½ä»¤ä¸»ä¹‰çš„å·¥ä½œæ–¹æ³•è€Œé‡‡å–è€å¿ƒè¯´æœçš„å·¥ä½œæ–¹æ³•ï¼Œé‚£æœ«ï¼Œä»€ä¹ˆä»»åŠ¡ä¹Ÿæ˜¯ä¸èƒ½å®ç°çš„ã€‚ ç¬¬ä¸€å· - çŸ›ç›¾è®º äº‹ç‰©å‘å±•è¿‡ç¨‹çš„æ ¹æœ¬çŸ›ç›¾åŠä¸ºæ­¤æ ¹æœ¬çŸ›ç›¾æ‰€è§„å®šçš„è¿‡ç¨‹çš„æœ¬è´¨ï¼Œéåˆ°è¿‡ç¨‹å®Œç»“ä¹‹æ—¥ï¼Œæ˜¯ä¸ä¼šæ¶ˆç­çš„ï¼›ä½†æ˜¯äº‹ç‰©å‘å±•çš„é•¿è¿‡ç¨‹ä¸­çš„å„ä¸ªå‘å±•çš„é˜¶æ®µï¼Œæƒ…å½¢åˆå¾€å¾€äº’ç›¸åŒºåˆ«ã€‚è¿™æ˜¯å› ä¸ºäº‹ç‰©å‘å±•è¿‡ç¨‹çš„æ ¹æœ¬çŸ›ç›¾çš„æ€§è´¨å’Œè¿‡ç¨‹çš„æœ¬è´¨è™½ç„¶æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯æ ¹æœ¬çŸ›ç›¾åœ¨é•¿è¿‡ç¨‹ä¸­çš„å„ä¸ªå‘å±•é˜¶æ®µä¸Šé‡‡å–äº†é€æ¸æ¿€åŒ–çš„å½¢å¼ã€‚å¹¶ä¸”ï¼Œè¢«æ ¹æœ¬çŸ›ç›¾æ‰€è§„å®šæˆ–å½±å“çš„è®¸å¤šå¤§å°çŸ›ç›¾ä¸­ï¼Œæœ‰äº›æ˜¯æ¿€åŒ–äº†ï¼Œæœ‰äº›æ˜¯æš‚æ—¶åœ°æˆ–å±€éƒ¨åœ°è§£å†³äº†ï¼Œæˆ–è€…ç¼“å’Œäº†ï¼Œåˆæœ‰äº›æ˜¯å‘ç”Ÿäº†ï¼Œå› æ­¤ï¼Œè¿‡ç¨‹å°±æ˜¾å‡ºé˜¶æ®µæ€§æ¥ã€‚å¦‚æœäººä»¬ä¸å»æ³¨æ„äº‹ç‰©å‘å±•è¿‡ç¨‹ä¸­çš„é˜¶æ®µæ€§ï¼Œäººä»¬å°±ä¸èƒ½é€‚å½“åœ°å¤„ç†äº‹ç‰©çš„çŸ›ç›¾ã€‚ ç¬¬ä¸‰å· - å…³äºé¢†å¯¼æ–¹æ³•çš„è‹¥å¹²é—®é¢˜ ï¼ˆä¸€ä¹å››ä¸‰å¹´å…­æœˆä¸€æ—¥ï¼‰ è¿™æ˜¯æ¯›æ³½ä¸œä¸ºä¸­å…±ä¸­å¤®æ‰€å†™çš„å†³å®šã€‚ ï¼ˆä¸€ï¼‰æˆ‘ä»¬å…±äº§å…šäººæ— è®ºè¿›è¡Œä½•é¡¹å·¥ä½œï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•æ˜¯å¿…é¡»é‡‡ç”¨çš„ï¼Œä¸€æ˜¯ä¸€èˆ¬å’Œä¸ªåˆ«ç›¸ç»“åˆï¼ŒäºŒæ˜¯é¢†å¯¼å’Œç¾¤ä¼—ç›¸ç»“åˆã€‚ ï¼ˆå››ï¼‰åœ¨æˆ‘å…šçš„ä¸€åˆ‡å®é™…å·¥ä½œä¸­ï¼Œå‡¡å±æ­£ç¡®çš„é¢†å¯¼ï¼Œå¿…é¡»æ˜¯ä»ç¾¤ä¼—ä¸­æ¥ï¼Œåˆ°ç¾¤ä¼—ä¸­å»ã€‚è¿™å°±æ˜¯è¯´ï¼Œå°†ç¾¤ä¼—çš„æ„è§ï¼ˆåˆ†æ•£çš„æ— ç³»ç»Ÿçš„æ„è§ï¼‰é›†ä¸­èµ·æ¥ï¼ˆç»è¿‡ç ”ç©¶ï¼ŒåŒ–ä¸ºé›†ä¸­çš„ç³»ç»Ÿçš„æ„è§ï¼‰ï¼Œåˆåˆ°ç¾¤ä¼—ä¸­å»ä½œå®£ä¼ è§£é‡Šï¼ŒåŒ–ä¸ºç¾¤ä¼—çš„æ„è§ï¼Œä½¿ç¾¤ä¼—åšæŒä¸‹å»ï¼Œè§ä¹‹äºè¡ŒåŠ¨ï¼Œå¹¶åœ¨ç¾¤ä¼—è¡ŒåŠ¨ä¸­è€ƒéªŒè¿™äº›æ„è§æ˜¯å¦æ­£ç¡®ã€‚ç„¶åå†ä»ç¾¤ä¼—ä¸­é›†ä¸­èµ·æ¥ï¼Œå†åˆ°ç¾¤ä¼—ä¸­åšæŒä¸‹å»ã€‚å¦‚æ­¤æ— é™å¾ªç¯ï¼Œä¸€æ¬¡æ¯”ä¸€æ¬¡åœ°æ›´æ­£ç¡®ã€æ›´ç”ŸåŠ¨ã€æ›´ä¸°å¯Œã€‚è¿™å°±æ˜¯é©¬å…‹æ€ä¸»ä¹‰çš„è®¤è¯†è®ºã€‚ ï¼ˆäº”ï¼‰é¢†å¯¼éª¨å¹²å’Œå¹¿å¤§ç¾¤ä¼—åœ¨ç»„ç»‡ä¸­åœ¨æ–—äº‰è¡ŒåŠ¨ä¸­å‘ç”Ÿæ­£ç¡®å…³ç³»çš„æ€æƒ³ï¼Œæ­£ç¡®çš„é¢†å¯¼æ„è§åªèƒ½ä»ç¾¤ä¼—ä¸­é›†ä¸­èµ·æ¥åˆåˆ°ç¾¤ä¼—ä¸­åšæŒä¸‹å»çš„æ€æƒ³ï¼Œåœ¨é¢†å¯¼æ„è§è§ä¹‹å®è¡Œæ—¶è¦å°†ä¸€èˆ¬å·å¬å’Œä¸ªåˆ«æŒ‡å¯¼äº’ç›¸ç»“åˆçš„æ€æƒ³ï¼Œéƒ½å¿…é¡»åœ¨è¿™æ¬¡æ•´é£ä¸­æ™®éåœ°åŠ ä»¥å®£ä¼ ï¼Œå€Ÿä»¥çº æ­£å¹²éƒ¨ä¸­åœ¨è¿™ä¸ªé—®é¢˜ä¸Šçš„é”™è¯¯è§‚ç‚¹ã€‚è®¸å¤šåŒå¿—ï¼Œä¸æ³¨é‡å’Œä¸å–„äºå›¢ç»“ç§¯æåˆ†å­ç»„æˆé¢†å¯¼æ ¸å¿ƒï¼Œä¸æ³¨é‡å’Œä¸å–„äºä½¿è¿™ç§é¢†å¯¼æ ¸å¿ƒåŒå¹¿å¤§ç¾¤ä¼—å¯†åˆ‡åœ°ç»“åˆèµ·æ¥ï¼Œå› è€Œä½¿è‡ªå·±çš„é¢†å¯¼å˜æˆè„±ç¦»ç¾¤ä¼—çš„å®˜åƒšä¸»ä¹‰çš„é¢†å¯¼ã€‚è®¸å¤šåŒå¿—ï¼Œä¸æ³¨é‡å’Œä¸å–„äºæ€»ç»“ç¾¤ä¼—æ–—äº‰çš„ç»éªŒï¼Œè€Œæ¬¢å–œä¸»è§‚ä¸»ä¹‰åœ°è‡ªä½œèªæ˜åœ°å‘è¡¨è®¸å¤šæ„è§ï¼Œå› è€Œä½¿è‡ªå·±çš„æ„è§å˜æˆä¸åˆ‡å®é™…çš„ç©ºè®ºã€‚è®¸å¤šåŒå¿—ï¼Œæ»¡è¶³äºå·¥ä½œä»»åŠ¡çš„ä¸€èˆ¬å·å¬ï¼Œä¸æ³¨é‡å’Œä¸å–„äºåœ¨ä½œäº†ä¸€èˆ¬å·å¬ä¹‹åï¼Œç´§ç´§åœ°æ¥ç€ä»äº‹äºä¸ªåˆ«çš„å…·ä½“çš„æŒ‡å¯¼ï¼Œå› è€Œä½¿è‡ªå·±çš„å·å¬åœæ­¢åœ¨å˜´ä¸Šã€çº¸ä¸Šæˆ–ä¼šè®®ä¸Šï¼Œè€Œå˜ä¸ºå®˜åƒšä¸»ä¹‰çš„é¢†å¯¼ã€‚è¿™æ¬¡æ•´é£ï¼Œå¿…é¡»çº æ­£è¿™äº›ç¼ºç‚¹ï¼Œåœ¨æ•´é£å­¦ä¹ ã€æ£€æŸ¥å·¥ä½œã€å®¡æŸ¥å¹²éƒ¨ä¸­å­¦ä¼šé¢†å¯¼å’Œç¾¤ä¼—ç›¸ç»“åˆã€ä¸€èˆ¬å’Œä¸ªåˆ«ç›¸ç»“åˆçš„æ–¹æ³•ï¼Œå¹¶åœ¨ä»¥ååº”ç”¨æ­¤ç§æ–¹æ³•äºä¸€åˆ‡å·¥ä½œã€‚ ï¼ˆå…­ï¼‰ä»ç¾¤ä¼—ä¸­é›†ä¸­èµ·æ¥åˆåˆ°ç¾¤ä¼—ä¸­åšæŒä¸‹å»ï¼Œä»¥å½¢æˆæ­£ç¡®çš„é¢†å¯¼æ„è§ï¼Œè¿™æ˜¯åŸºæœ¬çš„é¢†å¯¼æ–¹æ³•ã€‚åœ¨é›†ä¸­å’ŒåšæŒè¿‡ç¨‹ä¸­ï¼Œå¿…é¡»é‡‡å–ä¸€èˆ¬å·å¬å’Œä¸ªåˆ«æŒ‡å¯¼ç›¸ç»“åˆçš„æ–¹æ³•ï¼Œè¿™æ˜¯å‰ä¸€ä¸ªæ–¹æ³•çš„ç»„æˆéƒ¨åˆ†ã€‚ä»è®¸å¤šä¸ªåˆ«æŒ‡å¯¼ä¸­å½¢æˆä¸€èˆ¬æ„è§ï¼ˆä¸€èˆ¬å·å¬ï¼‰ï¼Œåˆæ‹¿è¿™ä¸€èˆ¬æ„è§åˆ°è®¸å¤šä¸ªåˆ«å•ä½ä¸­å»è€ƒéªŒï¼ˆä¸ä½†è‡ªå·±è¿™æ ·åšï¼Œè€Œä¸”å‘Šè¯‰åˆ«äººä¹Ÿè¿™æ ·åšï¼‰ï¼Œç„¶åé›†ä¸­æ–°çš„ç»éªŒï¼ˆæ€»ç»“ç»éªŒï¼‰ï¼Œåšæˆæ–°çš„æŒ‡ç¤ºå»æ™®éåœ°æŒ‡å¯¼ç¾¤ä¼—ã€‚åŒå¿—ä»¬åœ¨è¿™æ¬¡æ•´é£ä¸­åº”è¯¥è¿™æ ·å»åšï¼Œåœ¨ä»»ä½•å·¥ä½œä¸­ä¹Ÿåº”è¯¥è¿™æ ·å»åšã€‚æ¯”è¾ƒå¥½çš„é¢†å¯¼ï¼Œå°±æ˜¯ä»æ¯”è¾ƒå–„äºè¿™æ ·å»åšè€Œå¾—åˆ°çš„ã€‚ ","date":"2022-11-26","objectID":"https://www.likakuli.com/posts/thoughtfulessay2/:2:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”2 - ä¸€èµ·è¯»æ¯›é€‰","uri":"https://www.likakuli.com/posts/thoughtfulessay2/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"æœ¬ç¯‡ç”±æ¥ åœ¨ä½¿ç”¨ Admission Webhook çš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½ä¼šæ¶‰åŠåˆ°å‘é€ http è¯·æ±‚ä»¥è·å–æŸäº›æ•°æ®ã€‚åœ¨ v0.1.1 ç‰ˆæœ¬ä¸­å¯¹æ­¤è¿›è¡Œäº†æ”¯æŒï¼Œæœ¬æ–‡ä¸»è¦æ¥ä»‹ç»å¦‚ä½•åœ¨ kinitiras ä¸­å‘é€ http è¯·æ±‚ï¼Œå¦‚æœå¯¹ kinitiras è¿˜ä¸ç†Ÿæ‚‰ï¼Œè¯·å‚è€ƒå‰ç¯‡ã€‚ ","date":"2022-07-18","objectID":"https://www.likakuli.com/posts/kinitiras-cue-http/:1:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras å‘é€ http(s) è¯·æ±‚","uri":"https://www.likakuli.com/posts/kinitiras-cue-http/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"åŠŸèƒ½ä»‹ç» å½“å‰ä»…æ”¯æŒåœ¨ä½¿ç”¨ CUE æ—¶å¯ä»¥å‘é€ http(s) è¯·æ±‚ï¼Œç›¸å…³ç»“æ„å®šä¹‰åœ¨ processing ä¸‹ï¼Œå…¶ä¸­ output ç”¨æ¥å®šä¹‰è¾“å‡ºç»“æœï¼Œéœ€è¦ä¸ http response çš„ç»“æ„ä¸€è‡´ï¼ŒæŒ‰éœ€å®šä¹‰å³å¯ã€‚http éƒ¨åˆ†å’Œ CUE http ç»“æ„ä¸€è‡´ã€‚ ç¤ºä¾‹ï¼š object: _ @tag(object) processing: { http: { method: *\"GET\" | string url: \"http://127.0.0.1:8090/api/v1/token?val=test-token\" request: { body ?: bytes header: { \"Accept-Language\": \"en,nl\" } trailer: { \"Accept-Language\": \"en,nl\" User: \"foo\" } } } output: { token?: string } } validate:{ reason: \"hello cue\" valid: object.metadata.name == \"ut-cue-success-with-parameter\" \u0026\u0026 processing.output.token == \"test-token\" } ä¸Šé¢è¿™æ®µ CUE é…ç½®çš„å«ä¹‰æ˜¯ä¼ å…¥ä¸€ä¸ª k8s èµ„æºå¯¹è±¡ï¼Œè®¿é—® http://127.0.0.1:8090/api/v1/token?val=test-token è·å– token ä¿¡æ¯ï¼Œæœ€ç»ˆè¿”å› validate ç»“æœï¼Œå¦‚æœä¼ å…¥çš„ k8s å¯¹è±¡çš„åå­—æ˜¯ ut-cue-success-with-parameter å¹¶ä¸” http è¿”å›ç»“æœä¸­çš„ token æ˜¯ test-token çš„è¯ï¼Œæ ¡éªŒæˆåŠŸã€‚ CUE http ç›¸å…³å¤„ç†å‚è€ƒ kubevela ç›¸å…³èƒ½åŠ›çš„å®ç°ï¼Œæ¶‰åŠåˆ°çš„éƒ¨åˆ†åŒ…åœ¨å½“å‰ CUE ä¸­å±äº internalï¼Œæ— æ³•åœ¨å¤–éƒ¨ç›´æ¥å¼•ç”¨ï¼Œæ•…éƒ¨åˆ†å†…å®¹ç›´æ¥åœ¨ builtin ç›®å½•ä¸‹é‡æ–°å†™äº†ä¸€éã€‚ ","date":"2022-07-18","objectID":"https://www.likakuli.com/posts/kinitiras-cue-http/:2:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras å‘é€ http(s) è¯·æ±‚","uri":"https://www.likakuli.com/posts/kinitiras-cue-http/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"é¡¹ç›®ç”±æ¥ ä½¿ç”¨ kubernetes çš„åŒå­¦å¯èƒ½æˆ–å¤šæˆ–å°‘ä¼šæœ‰ä»¥ä¸‹çš„å®é™…ä¸šåŠ¡æˆ–è€…éœ€æ±‚åœºæ™¯ï¼š ä¸ºç¡®ä¿å®‰å…¨æ€§ï¼Œéœ€è¦å¯¹æŸäº›èµ„æºè¿›è¡Œåˆ é™¤ä¿æŠ¤ï¼Œä¾‹å¦‚ä¸å…è®¸åˆ é™¤ namespaceã€crd å®šä¹‰ç­‰ï¼› æ ¹æ®æœåŠ¡ç”»åƒä¸ºä¸åŒçš„æœåŠ¡è®¾ç½®ä¸åŒçš„å±æ€§ï¼Œè¿™äº›å±æ€§åŸºæœ¬æ˜¯ä¸šåŠ¡æ— æ„Ÿçš„ï¼Œä¾‹å¦‚è®¾ç½®ä¸åŒçš„è¶…å”®æ¯”ã€è®¾ç½®ä¸åŒçš„ Label ä»¥åŠè°ƒåº¦ç‰¹æ€§ä»è€Œå®ç° io æ•æ„Ÿå‹ä¸ io å¯†é›†å‹æœåŠ¡çš„åäº²å’Œè°ƒåº¦ç­‰ï¼› é’ˆå¯¹åŒä¸€ä¸ª workload ç”Ÿæˆ per pod per config çš„é…ç½®ï¼Œä¾‹å¦‚ä¸ºç‰¹å®šçš„ä¸šåŠ¡å®¹å™¨è®¾ç½® debug å¼€å…³ã€ç‰¹æƒæ¨¡å¼ã€æ—¥å¿—è·¯å¾„ç­‰ï¼› é›†ç¾¤é‡Œé¢æ¯å¼•å…¥ä¸€ä¸ªç»„ä»¶ï¼Œå¯èƒ½å°±ä¼šåŒæ—¶å¼•å…¥ä¸€ä¸ªç”šè‡³å¤šä¸ª admission webhookï¼Œä¹…è€Œä¹…ä¹‹ï¼Œé›†ç¾¤é‡Œé¢ä¼šå­˜åœ¨ä¼—å¤šçš„ admission webhookï¼Œå®ç°æ–¹å¼ã€å…³æ³¨çš„èµ„æºéƒ½ä¸åŒï¼Œç®¡ç†èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼› è™½ç„¶ä½¿ç”¨ä¸€äº›å·¥å…·ä¾‹å¦‚ kube-builderã€controller-runtime ç­‰å¯ä»¥å¿«é€Ÿçš„åˆ›å»º admission webhook çš„æ¡†æ¶ï¼Œä½†å¼€å‘æ•´ä¸ªåŠŸèƒ½ä¹Ÿéœ€è¦ä¸€å®šçš„å¼€å‘å·¥ä½œé‡ï¼Œå¾€å¾€éœ€è¦å¼€å‘çš„ä¸šåŠ¡é€»è¾‘æ¯”è¾ƒç®€å•ï¼ŒåŸºæœ¬æ˜¯æ ¹æ®ä¸€äº›è§„åˆ™è¿›è¡Œä¸€äº›å†³ç­–ï¼› admission webhook é‡Œçš„ä¸šåŠ¡é€»è¾‘çš„æ”¹åŠ¨éœ€è¦å‡çº§ wehook æ¥å®ç°ï¼Œå˜æ›´å°±æœ‰å¯èƒ½å¼•å…¥çº¿ä¸Šç¨³å®šæ€§é£é™©ï¼› å¯ä»¥å¤§è‡´å½’ä¸ºä¸‰ç±»ï¼šé›†ç¾¤èµ„æºç®¡ç†ã€admission webhok è‡ªèº«ç®¡ç†ã€ä¸šåŠ¡èµ„æºå®šåˆ¶ã€‚åŸºäºä»¥ä¸Šçš„éœ€æ±‚åœºæ™¯ï¼Œä¸€ä¸ªé€šç”¨çš„å¯ç¼–ç¨‹çš„ webhook è§„åˆ™å¼•æ“çš„æƒ³æ³•è¯ç”Ÿäº†ã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:1:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"é¡¹ç›®ä»‹ç» Kinitiras ä¸ºå¸Œè…Šè¯­ï¼Œæ„æ€ä¸ºå‘åŠ¨æœºã€å¼•æ“ï¼Œè´´åˆ rule engine çš„æ¦‚å¿µã€‚é¡¹ç›®é€šè¿‡æŠ½è±¡å‡ºæ¥ä¸‰ç§ç­–ç•¥æ¥å®ç°é›†ç¾¤èµ„æºçš„ mutate å’Œ validate çš„é€»è¾‘ï¼Œæ”¯æŒé€šè¿‡ CUE é…ç½®ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œæ”¯æŒäº†åŠ¨æ€ç¼–ç¨‹èƒ½åŠ›ï¼Œå¯ä»¥åœ¨ä¸å˜æ›´ç¨‹åºçš„å‰æä¸‹é€šè¿‡å¯¹ç­–ç•¥çš„æ“ä½œå®ç°æ‰€éœ€çš„èƒ½åŠ›ã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:2:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"èƒ½åŠ›ä»‹ç» ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:3:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"Mutate å†…ç½®äº† OverridePolicy å’Œ ClusterOverridePolicy æ¥æ”¯æŒ Mutate èƒ½åŠ›ï¼Œå‰è€…æ˜¯ Namespace çº§åˆ«ç”Ÿæ•ˆï¼Œå³åªèƒ½ä¿®æ”¹åŒ Namespace ä¸‹çš„èµ„æºå¯¹è±¡ï¼Œåè€…æ˜¯ Cluster çº§åˆ«ç”Ÿæ•ˆï¼Œå¯ä¿®æ”¹èµ„æºå¯¹è±¡ä¸å— Namespace é™åˆ¶ã€‚ç­–ç•¥å†…ç½®ä¸€äº›ç­›é€‰æ¡ä»¶æ¥å¯¹ç›®æ ‡èµ„æºå¯¹è±¡è¿›è¡Œç­›é€‰ï¼Œå¯¹äºåŒä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå¯ä»¥æœ‰å¤šæ¡ç­–ç•¥ä¸ä¹‹åŒ¹é…ï¼Œå…¶ç”Ÿæ•ˆé¡ºåºé’ˆå¯¹ä¸åŒç±»å‹ç­–ç•¥ä¼˜å…ˆä½¿ç”¨ ClusterOverridePolicyï¼ŒåŒä¸€ç§ç±»å‹çš„ç­–ç•¥åˆ™æŒ‰ç…§å­—æ¯é¡ºåºä¾æ¬¡ç”Ÿæ•ˆã€‚ ä¾‹ï¼š kind:ClusterOverridePolicyapiVersion:policy.kcloudlabs.io/v1alpha1metadata:name:add-anno-cop-cuespec:resourceSelectors:- apiVersion:v1kind:PodlabelSelector:matchLabels:kinitiras.kcloudlabs.io/webhook:enabledoverrideRules:- targetOperations:- CREATEoverriders:cue:|-object: _ @tag(object) patches: [ if object.metadata.annotations == _|_ { { op: \"add\" path: \"/metadata/annotations\" value: {} } }, { op: \"add\" path: \"/metadata/annotations/added-by\" value: \"cue\" } ]---kind:OverridePolicyapiVersion:policy.kcloudlabs.io/v1alpha1metadata:name:add-anno-op-plaintextnamespace:defaultspec:resourceSelectors:- apiVersion:v1kind:PodlabelSelector:matchLabels:kinitiras.kcloudlabs.io/webhook:enabledoverrideRules:- targetOperations:- CREATEoverriders:plaintext:- path:/metadata/annotations/added-byop:addvalue:op ä¸Šè¿°ä¾‹å­ä¸­å®šä¹‰äº†ä¸¤ç§ç±»å‹çš„ç­–ç•¥ï¼Œé€šè¿‡ resourceSelector è¿›è¡Œç›®æ ‡èµ„æºå¯¹è±¡çš„ç­›é€‰ï¼Œå¯¹äºç­›é€‰å‡ºæ¥çš„èµ„æºå¯¹è±¡ï¼Œå°†ä¼šç»§ç»­ä½¿ç”¨ overrideRules é‡Œé¢å®šä¹‰çš„è§„åˆ™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè§„åˆ™çš„ targetOperations ä¸­åŒ…å«æœ¬æ¬¡æ“ä½œç±»å‹ï¼Œåˆ™å°†ä½¿ç”¨è§„åˆ™å†…çš„ ``overridersç”Ÿæˆæœ€ç»ˆå¯¹è±¡ï¼Œå¯¹æ¯”åŸå§‹å¯¹è±¡å’Œæœ€ç»ˆå¯¹è±¡ç”Ÿæˆ json-patch æ‰€éœ€çš„ patches æ•°ç»„è¿”å›ç»™kube-apiserver. æ”¯æŒä¸¤ç§ç±»çš„ overriders`ï¼šplaintextã€cueï¼Œå‰è€…é€‚ç”¨äºä¸€äº›ç®€å•åœºæ™¯ï¼Œåè€…é€‚ç”¨äºéœ€è¦æ ¹æ®ä¼ å…¥æ•°æ®è¿›è¡Œé¢å¤–é€»è¾‘å¤„ç†æ‰èƒ½å¾—åˆ°é¢„æœŸç»“æœçš„åœºæ™¯ï¼Œèƒ½åŠ›ç›¸å¯¹å‰è€…ä¼šæ›´å¼ºã€‚ cue è„šæœ¬çº¦å®šäº†è¾“å…¥è¾“å‡ºå‚æ•°ï¼Œå¿…é¡»åŒ…å«è¿™äº›å‚æ•°è„šæœ¬æ‰èƒ½æˆåŠŸæ‰§è¡Œã€‚è¾“å…¥å‚æ•°åªæœ‰ä¸€ä¸ªï¼šobjectï¼Œå³è¦æ“ä½œçš„èµ„æºå¯¹è±¡ï¼Œè¾“å‡ºå‚æ•°ä¸º patches æ•°ç»„ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š object: _ @tag(object) patch: { op: string path: string value: string } // for mutating result patches: [...patch] å…·ä½“æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š // ResourceSelector the resources will be selected. type ResourceSelector struct { // APIVersion represents the API version of the target resources. // +required APIVersion string `json:\"apiVersion\"` // Kind represents the Kind of the target resources. // +required Kind string `json:\"kind\"` // Namespace of the target resource. // Default is empty, which means inherit from the parent object scope. // +optional Namespace string `json:\"namespace,omitempty\"` // Name of the target resource. // Default is empty, which means selecting all resources. // +optional Name string `json:\"name,omitempty\"` // A label query over a set of resources. // If name is not empty, labelSelector will be ignored. // +optional LabelSelector *metav1.LabelSelector `json:\"labelSelector,omitempty\"` } // Overriders offers various alternatives to represent the override rules. // // If more than one alternatives exist, they will be applied with following order: // - Cue // - Plaintext type Overriders struct { // Plaintext represents override rules defined with plaintext overriders. // +optional Plaintext []PlaintextOverrider `json:\"plaintext,omitempty\"` // Cue represents override rules defined with cue code. // +optional Cue string `json:\"cue,omitempty\"` } ä¸Šè¿°ä¾‹å­çš„æ•ˆæœæ˜¯å¯¹äºä»»æ„ Namespace çš„ Podï¼Œåªè¦å…¶æºå¸¦ kinitiras.kcloudlabs.io/webhook: enabled Labelï¼Œåˆ™ä¼šä¿®æ”¹å…¶ annotation ä¸º added-by: cueï¼Œé’ˆå¯¹ default ä¸‹çš„ Podï¼Œåªè¦å…¶æºå¸¦ kinitiras.kcloudlabs.io/webhook: enabled Labelï¼Œåˆ™ä¼šä¿®æ”¹å…¶ annotation ä¸º added-by: opã€‚å¦‚æœä¸¤ä¸ªç­–ç•¥åŒæ—¶ apply åˆ°é›†ç¾¤ä¸­ï¼ŒåŒæ—¶åœ¨ default ä¸‹åˆ›å»ºä¸€ä¸ª Pod å¹¶æºå¸¦ä¸Šè¿° Labelï¼Œåˆ™æœ€ç»ˆåˆ›å»ºçš„ Pod annotation å°†ä¼šæ˜¯ added-by: opï¼Œå› ä¸º OverridePolicy åæ‰§è¡Œï¼Œè¦†ç›–äº† ClusterOverridePolicy çš„ä¿®æ”¹ã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:3:1","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"Validate å†…ç½®äº† ClusterValidatePolicyï¼Œ é›†ç¾¤çº§åˆ«ç”Ÿæ•ˆã€‚é’ˆå¯¹åŒä¸€ä¸ªèµ„æºå¯¹è±¡ï¼ŒåŒæ ·å¯èƒ½å­˜åœ¨å¤šæ¡åŒ¹é…çš„ç­–ç•¥ï¼Œé¡ºåºåœ¨è¿™é‡Œä¸é‡è¦ï¼Œéœ€è¦å…¨éƒ¨ç­–ç•¥éƒ½é€šè¿‡ä¹‹åæ‰ç®—æ•´ä½“æ ¡éªŒé€šè¿‡ï¼Œä»»æ„ä¸€ä¸ªç­–ç•¥æ ¡éªŒå¤±è´¥åå°†ä¼šæ‹’ç»è¯·æ±‚ã€‚ ä¾‹ï¼š apiVersion:policy.kcloudlabs.io/v1alpha1kind:ClusterValidatePolicymetadata:name:test-delete-nsspec:validateRules:- cue:|-object: _ @tag(object) reject: object.metadata.labels != null \u0026\u0026 object.metadata.labels[\"kinitiras.kcloudlabs.io/webhook\"] == \"enabled\" validate: { if reject{ reason: \"operation rejected\" } if !reject{ reason: \"\" } valid: !reject }targetOperations:- DELETEresourceSelectors:- apiVersion:v1kind:Namespace é€šè¿‡ resourceSelector è¿›è¡Œç›®æ ‡èµ„æºå¯¹è±¡çš„ç­›é€‰ï¼Œå¯¹äºç­›é€‰å‡ºæ¥çš„èµ„æºå¯¹è±¡ï¼Œå°†ä¼šç»§ç»­ä½¿ç”¨ validateRules é‡Œé¢å®šä¹‰çš„è§„åˆ™è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè§„åˆ™çš„ targetOperations ä¸­åŒ…å«æœ¬æ¬¡æ“ä½œç±»å‹ï¼Œåˆ™å°†ä½¿ç”¨ cue è„šæœ¬è¿›è¡Œæ ¡éªŒï¼Œæ£€éªŒç»“æœè¿”å›ç»™ kube-apiserverã€‚ä¸ Mutate ä¸åŒçš„æ˜¯ï¼ŒValidate åªæ”¯æŒ cue è„šæœ¬æ ¡éªŒã€‚cue è„šæœ¬çº¦å®šäº†è¾“å…¥è¾“å‡ºå‚æ•°ï¼Œå¿…é¡»åŒ…å«è¿™äº›å‚æ•°è„šæœ¬æ‰èƒ½æˆåŠŸæ‰§è¡Œã€‚è¾“å…¥å‚æ•°æœ‰ä¸¤ä¸ªï¼šobjectã€oldObjectï¼Œå…¶ä¸­åè€…åªæœ‰åœ¨æ ¡éªŒ UPDATE æ“ä½œæ—¶æ‰éœ€è¦ï¼Œè¾“å‡ºå‚æ•°ä¸º validate ç»“æœï¼Œå®šä¹‰å¦‚ä¸‹ï¼š object: _ @tag(object) oldObject: _ @tag(oldObject) // for validating result validate: { reason?: string valid: bool } ä¸Šè¿°ä¾‹å­çš„æ•ˆæœä¸ºé˜»æ­¢åˆ é™¤å¸¦æœ‰ kinitiras.kcloudlabs.io/webhook: enabled æ ‡ç­¾çš„ namespaceã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:3:2","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"éƒ¨ç½² ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:4:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"éƒ¨ç½² CRD èµ„æº kubectl apply -f https://raw.githubusercontent.com/k-cloud-labs/pkg/main/charts/_crds/bases/policy.kcloudlabs.io_overridepolicies.yaml kubectl apply -f https://raw.githubusercontent.com/k-cloud-labs/pkg/main/charts/_crds/bases/policy.kcloudlabs.io_clusteroverridepolicies.yaml kubectl apply -f https://raw.githubusercontent.com/k-cloud-labs/pkg/main/charts/_crds/bases/policy.kcloudlabs.io_clustervalidatepolicies.yaml ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:4:1","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"éƒ¨ç½²åº”ç”¨ç¨‹åº åœ¨éƒ¨ç½²ä¹‹å‰ï¼Œéœ€è¦å…ˆæ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹ webhook-configuration.yaml æ–‡ä»¶ï¼Œå°½é‡ç¼©å°ç›®æ ‡èµ„æºå¯¹è±¡çš„èŒƒå›´ï¼Œå‡å°‘ä¸å¿…è¦çš„è¯·æ±‚ã€‚è°ƒæ•´å®Œæ‰€æœ‰ yaml æ–‡ä»¶ä¹‹åï¼Œåªéœ€è¦æ‰§è¡Œ apply å³å¯ï¼Œå¦‚ä¸‹ kubectl apply -f deploy/ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:4:2","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"ä¾‹å­ åœ¨ examples æ–‡ä»¶å¤¹ä¸‹å†…ç½®äº†ä¸Šè¿°å‡ºç°è¿‡çš„ä¸‰ä¸ªç­–ç•¥ï¼Œå¯ä»¥ apply åˆ°é›†ç¾¤è¿›è¡Œå°è¯•ã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:4:3","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"å°ç»“ ä¸Šé¢å¯¹é¡¹ç›®ç”±æ¥ï¼Œèƒ½åŠ›åŠä½¿ç”¨æ–¹å¼è¿›è¡Œäº†ç®€å•ä»‹ç»ï¼Œæ ¸å¿ƒè¿˜æ˜¯åˆ©ç”¨äº† admission webhook æ¥å®ç°ã€‚å¯èƒ½æœ‰çš„å°ä¼™ä¼´å¯¹ admission webhook çš„ç¨³å®šæ€§ã€æ€§èƒ½æ¯”è¾ƒè°¨æ…ï¼Œé‰´äºæ­¤ï¼Œè¿™é‡Œæä¾›äº†å¦å¤–ä¸€ä¸ªé¡¹ç›® pidalioï¼Œé€šè¿‡æ‰©å±• client-go Transport æ¥å®ç°ï¼Œåœ¨å®¢æˆ·ç«¯ç”Ÿæ•ˆï¼Œä½¿ç”¨ç®€å•ï¼Œä»£ç å±‚é¢åªéœ€è¦å¼•ç”¨å¯¹ç”¨çš„åŒ…ï¼Œå¹¶ä¸º rest.Config è®¾ç½®è‡ªå®šä¹‰çš„ Transport å³å¯ã€‚å¦‚ä¸‹ import( \"github.com/k-cloud-labs/pidalio\" ) config.Wrap(pidalio.NewPolicyTransport(config, stopCh).Wrap) ä½† pidalio å­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼Œå³åªæ”¯æŒ Mutate æ“ä½œï¼Œä¸”å¿…é¡»ä½¿ç”¨ client-go è®¿é—® kube-apiserverã€‚ ","date":"2022-05-12","objectID":"https://www.likakuli.com/posts/kinitiras/:5:0","tags":["kubernetes"],"title":"admission webhook èŠ±å¼ç©æ³• - kinitiras","uri":"https://www.likakuli.com/posts/kinitiras/"},{"categories":["æœ‰ç”¨çš„çŸ¥è¯†"],"content":"æœ¬ç¯‡ç”±æ¥ åˆ†äº«åœ¨ä½¿ç”¨ Docker for Mac è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°é‡åˆ°é—®é¢˜çš„äººã€‚ ","date":"2021-11-03","objectID":"https://www.likakuli.com/posts/docker-for-mac-1/:1:0","tags":["docker"],"title":"docker for mac - 1","uri":"https://www.likakuli.com/posts/docker-for-mac-1/"},{"categories":["æœ‰ç”¨çš„çŸ¥è¯†"],"content":"ç½‘ç»œä¸é€š Docker for Mac æ²¡æœ‰æä¾›ä»å®¿ä¸»çš„macOSé€šè¿‡å®¹å™¨IPè®¿é—®å®¹å™¨çš„æ–¹å¼ã€‚å‚è€ƒ Known limitations, use cases, and workaroundsã€‚é‡åˆ°æ­¤é—®é¢˜å¯ä»¥å‚ç…§æ­¤æ–‡æ¡£æ“ä½œï¼šmac docker connectorã€‚ ","date":"2021-11-03","objectID":"https://www.likakuli.com/posts/docker-for-mac-1/:2:0","tags":["docker"],"title":"docker for mac - 1","uri":"https://www.likakuli.com/posts/docker-for-mac-1/"},{"categories":["æœ‰ç”¨çš„çŸ¥è¯†"],"content":"æŸ¥çœ‹å®¹å™¨æ–‡ä»¶ Docker for Mac å®¹å™¨æ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸­çš„ï¼Œåœ¨ MacOS ä¸Šè¿è¡Œäº†ä¸€ä¸ªè™šæœºã€‚æ‰€ä»¥é€šè¿‡ docker inspect çœ‹åˆ°çš„å‘½ä»¤ï¼Œå°¤å…¶å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯ï¼Œç›´æ¥åœ¨å®¿ä¸»æœºä¸Šæ˜¯æ— æ³•æ‰¾åˆ°çš„ï¼Œéœ€è¦æ‰¾åˆ°ç›®å½•å¯¹åº”çš„åœ¨ MacOS ä¸Šçš„ç›®å½•ï¼Œç½‘ä¸Šæœç´¢å¯ä»¥å¾—åˆ°ä¸¤ç§æ–¹æ¡ˆï¼Œéƒ½æ˜¯é€šè¿‡ screen å‘½ä»¤ï¼Œåæ¥å…·ä½“æ–‡ä»¶ï¼Œç‰ˆæœ¬ä¸åŒï¼Œæ–‡ä»¶ä¸åŒï¼Œä½†æœ€æ–°ç‰ˆéƒ½å·²ç»ä¸å¯ç”¨ã€‚ å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸‡èƒ½çš„æŒ‡ä»¤æ¥å®ç°ï¼ŒåŸç†è¿˜æ˜¯åˆ©ç”¨ linux çš„å„ç§ namespace æœºåˆ¶ï¼Œå‘½ä»¤å¦‚ä¸‹ docker run -it --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh æ­¤å‘½ä»¤æ˜¯ä»¥ç‰¹æƒæ¨¡å¼å¯åŠ¨ä¸€ä¸ªæ–°å®¹å™¨ï¼Œå…±äº«è™šæœºçš„ pid namespaceï¼Œå¯åŠ¨ä¹‹åé€šè¿‡ nsenter å‘½ä»¤è¿›å»åˆ°è¿›ç¨‹1 çš„ mountã€utsã€net namespaec ä¸­ã€‚å› ä¸ºå¯åŠ¨çš„æ–°å®¹å™¨åˆ©ç”¨äº†è™šæœºçš„ pid namespaceï¼Œæ‰€ä»¥çœ‹åˆ°çš„1å·è¿›ç¨‹å°±æ˜¯è™šæœºçš„1å·è¿›ç¨‹ã€‚ å¤šä¹ˆå·§å¦™çš„å®ç°~ ","date":"2021-11-03","objectID":"https://www.likakuli.com/posts/docker-for-mac-1/:3:0","tags":["docker"],"title":"docker for mac - 1","uri":"https://www.likakuli.com/posts/docker-for-mac-1/"},{"categories":["æœ‰ç”¨çš„çŸ¥è¯†"],"content":"Exec Permission denied docker runæŠ¥é”™ï¼ŒæŠ¥å¦‚ä¸Šçš„é”™ã€‚å‡ºç°è¿™ç§æƒ…å†µå¤§æ¦‚ç‡æ˜¯åœ¨ linux ä¸Šæ‰“äº†é•œåƒï¼Œåœ¨ mac ä¸Šè¿è¡Œæ—¶å‡ºçš„é”™ã€‚åˆ©ç”¨ä¸Šä¸€æ­¥ä¸­æåˆ°çš„æ–¹æ³•è¿›å…¥å®¹å™¨æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œ å¯ä»¥å‚è€ƒè¿™é‡Œã€‚ chmod 755 filename ","date":"2021-11-03","objectID":"https://www.likakuli.com/posts/docker-for-mac-1/:4:0","tags":["docker"],"title":"docker for mac - 1","uri":"https://www.likakuli.com/posts/docker-for-mac-1/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ ä¸ŠåŠå¹´é‡åˆ°äº†ä¸€äº›ç»‘æ ¸ç›¸å…³çš„ bugï¼Œåˆ†æäº†å…¶åŸå› ï¼Œä½†æ²¡æœ‰æ€»ç»“æ•´ç†ä¸‹æ¥ï¼Œç°åœ¨åˆç¢°åˆ°äº†ï¼Œè¡¥ä¸€ä¸‹ä½œä¸šï¼ŒåŒæ—¶ä¹Ÿå¸Œæœ›å¯ä»¥å¸®åŠ©å¤§å®¶å¿«é€Ÿä»å‘é‡Œçˆ¬å‡ºæ¥ã€‚æœ¬ç¯‡ä¼šæ€»ç»“ç»‘æ ¸ç›¸å…³çš„ bugï¼Œéƒ¨åˆ†å®˜ç½‘å·²ä¿®å¤ï¼Œéƒ¨åˆ†å°šæœªä¿®å¤ï¼Œä¸ k8s ç‰ˆæœ¬æœ‰å…³ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å¯¹ k8s è¿›è¡Œä¸€äº›è€ƒå¤ï¼Œç¿»ä¸€ç¿»ä» 1.8 åˆ°ç°åœ¨ CPU Manager çš„å‘å±•è¿‡ç¨‹ï¼Œå½“ç„¶ä¸‹é¢ä¹Ÿä¼šåšç®€å•ä»‹ç»ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:1:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"å‘å±•å†ç¨‹ CPU Manager ä½œä¸º alpha ç‰¹æ€§å¼•å…¥ Kubernetes 1.8 ç‰ˆæœ¬ï¼Œ1.12 å¼€å§‹è½¬æ¢ä¸º beta çŠ¶æ€ã€‚å¦‚ä½•ä½¿ç”¨ï¼Œå‚æ•°é…ç½®ä¸æ˜¯è¿™é‡Œçš„é‡ç‚¹ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ã€‚åœ¨æ­¤åŸºç¡€ä¸Šè¿˜æœ‰ NUMA Topology Aware çš„èƒ½åŠ›ï¼Œå¯ä»¥å‚è€ƒå‰ç¯‡ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:2:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜è¡¨ç° ç»‘æ ¸çš„åŠŸèƒ½å®ç°æ˜¯åœ¨ kubelet å½“ä¸­çš„ï¼Œåœ¨å®¹å™¨å¯åŠ¨ä¹‹å‰ä¼šç»è¿‡ admit æœºåˆ¶è¿›è¡Œæ ¡éªŒå®¿ä¸»ä¸Šæ˜¯å¦æœ‰è¶³å¤Ÿèµ„æºä¾›ç»‘æ ¸ä½¿ç”¨ã€‚å¦‚æœèµ„æºä¸è¶³ï¼Œåˆ™å®¹å™¨å‡†å…¥å¤±è´¥ï¼Œä¼šæŠ¥é”™æç¤º cpu èµ„æºä¸è¶³ï¼Œnot enough cpus available to satisfy requestã€‚ æ­¤é—®é¢˜å­˜åœ¨äº1.8ä¹‹åçš„æ‰€æœ‰ç‰ˆæœ¬ä¸­ï¼Œæ‰€ä»¥å¦‚æœåœ¨çº¿ä¸Šé‡åˆ°çš„è¯ä¸è¦æƒŠè®¶ï¼Œä¸€ç›´åœ¨ä¿®å¤ï¼Œä»æœªè¢«å½»åº•ä¿®å¤ï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç›´åˆ°ç°åœ¨ä»ç„¶å¤„äº beta çŠ¶æ€çš„åŸå› ã€‚é’ˆå¯¹æ­¤ç°è±¡çš„æ‰€æœ‰çš„ PR éƒ½åªæ˜¯å¯¹å·²çŸ¥åŸå› çš„ä¿®å¤ï¼Œä¸”å½“å‰ä»å­˜åœ¨åŸå› å·²çŸ¥ä½†å°šæœªä¿®å¤çš„é—®é¢˜ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:3:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ æ ¹æ®æˆ‘çš„ç»éªŒï¼Œé‡åˆ°æ­¤ç±»é—®é¢˜æœ€ç›´æ¥æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆåˆ†ä¸‰æ­¥ï¼Œå°±å¦‚åŒæŠŠå¤§è±¡è£…å†°ç®±ä¸€æ ·ç®€å•ï¼š åœæ­¢ Kubelet è¿›ç¨‹ åˆ é™¤æœ¬åœ° cpu_manager_state æ–‡ä»¶ é‡å¯ Kubelet è¿›ç¨‹ å¯ä»¥è§£å†³99%çš„æ­¤ç±»é—®é¢˜ï¼Œå¦‚æœè¿˜æ˜¯æ— æ³•è§£å†³ä¸” k8s ç‰ˆæœ¬ \u003c 1.18ï¼Œé‚£å°±éœ€è¦ç¥­å‡ºæ›´å‰å®³çš„æ­¦åŠŸç§˜ç±äº†ï¼š docker ps æŸ¥æ‰¾åŒ Pod åŒ Conatiner Nameï¼ˆ.spec.containers ä¸­åŒä¸€ä¸ª name çš„ containerï¼‰çš„è®°å½•ï¼Œå¤§æ¦‚ç‡ä¼šå­˜åœ¨å¤šæ¡è®°å½•ï¼Œä¾‹å¦‚å­˜åœ¨ Created çŠ¶æ€çš„ containerï¼Œè¿™æ—¶éœ€è¦åˆ é™¤è¿™äº›ä¸ªå¤šä½™çš„ container æŒ‰ç…§ä¸Šé¢çš„1ï¼Œ2ï¼Œ3å†æ¥ä¸€æ¬¡å³å¯ å¦‚æœè¿˜æ˜¯æ²¡æœ‰è§£å†³ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ å¯èƒ½é‡åˆ°æœªçŸ¥åŸå› çš„é—®é¢˜äº†ï¼Œå¸Œæœ›ä½ å¯ä»¥æ·±å…¥æ’æŸ¥å¹¶åé¦ˆç»™ç¤¾åŒºï¼Œå¸®åŠ©æ›´å¤šå—å®³è€…ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:4:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"åŸç†ä»‹ç» ä¸Šå›¾æ˜¯æœ€æ–°ç‰ˆæœ¬ k8s ä¸­çš„å®ç°ï¼Œåœ¨ä¸åŒ k8s ç‰ˆæœ¬ä¸­å®ç°æ–¹å¼ä¸åŒï¼Œä¸Šå›¾ä¸­çš„è™šçº¿æ¡†ä¸­çš„éƒ¨åˆ†åœ¨ä½ç‰ˆæœ¬ä¸­æ˜¯ä¸å­˜åœ¨çš„ã€‚åœ¨ä½ç‰ˆæœ¬ä¸­ï¼Œè®¡ç®—ç»‘æ ¸ä¿¡æ¯ä»¥åŠè®¾ç½®ç»‘æ ¸ä¿¡æ¯åˆ°å®¹å™¨æ˜¯åœ¨ Reconsile å’Œ PreStartContaier ä¸­å®ç°çš„ï¼Œè€Œç°ç‰ˆæœ¬æ˜¯åœ¨ Reconsile å’Œ Admitã€PreCreateContainer å®ç°çš„ï¼Œå³åœ¨ Admit æ—¶ä¼šè®¡ç®—å‡ºå®¹å™¨æ‰€éœ€èµ„æºå¹¶ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œåœ¨çœŸæ­£è°ƒç”¨ Docker ä¹‹å‰ï¼Œä»å†…å­˜ä¸­è·å–åˆ°å®¹å™¨ç»‘æ ¸ä¿¡æ¯å¹¶è®¾ç½®åˆ°å…¶ Config ä¸­ï¼Œç„¶åä¼ é€’ç»™ Dockerï¼Œè€Œè€ç‰ˆæœ¬ä¸­æ˜¯å…ˆåˆ›å»ºå‡ºæ¥å®¹å™¨ï¼Œç„¶åå†è°ƒç”¨ Docker API å»æ›´æ–°å…¶ç»‘æ ¸ä¿¡æ¯ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:5:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"ç›¸å…³ISSUE \u0026 PR ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:6:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"ISSUE æ„Ÿå…´è¶£çš„å¯ä»¥ç¿»ç¿»å†å² ISSUEï¼Œæ­¤é—®é¢˜ä» 1.8 å¼€å§‹æœ‰å¤§é‡ç›¸å…³çš„ ISSUEï¼Œä¸‹é¢åˆ—å‡ ä¸ªæ¯”è¾ƒå…¸å‹çš„ Internal PreStartContainer hook failed: not enough cpus available to satisfy request #63018 [cpumanager] AddContainer error: not enough cpus available to satisfy request #79159 TopologyManager: Guarantee Aligned resources for Multiple Containers #83476 Container cpuset lost, apparently due to race between PostStopContainer() and new container creation #90303 The CPU manager does not work correctly for the guaranteed pod with multiple containers #103952 ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:6:1","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"PR Make CPU manager release CPUs when Pod enters completed phase #52363 cpumanager: rollback state if updateContainerCPUSet failed #67430 clean containers in reconcileState of cpuManager #68619 Update CPUManager stored state semantics #84462 Fix exclusive CPU allocations being deleted at container restart #90377 Do not clear state of pods pending admission for CPU/Memory/Device manager #103979 Slack ä¸Šæœ‰ä¸€æ®µä¸“é—¨é’ˆå¯¹ CPU Manager é—®é¢˜çš„è®¨è®ºï¼Œå¯ä»¥åŠ æ·±å¯¹é—®é¢˜çš„ç†è§£ï¼Œè§è¿™é‡Œã€‚ å…¶ä¸­é’ˆå¯¹1.22åŠä»¥ä¸Šç‰ˆæœ¬ç»‘æ ¸ç›¸å…³çš„ bug å’Œ kubelet é‡æ„æœ‰å…³ï¼Œå‚è€ƒè¿™é‡Œã€‚åœ¨ 1.22 å¼€å§‹ kubelet è¿›è¡Œäº†å¾ˆå¤§çš„é‡æ„ï¼Œå‚è€ƒ Commitï¼Œåœ¨æ­¤ PR åˆå…¥ä¹‹åå‡ºç°äº†ä¸€äº›ç›¸å…³çš„ Bug ä»¥åŠ Failing Test çš„é”™è¯¯ï¼Œé’ˆå¯¹å…¶æƒ³è¦å®ç°çš„åŠŸèƒ½ä¹Ÿå­˜åœ¨ä¸€ä¸ªæ–‡æ¡£ã€‚è¿™é‡Œä¸å†å¤šè¯´ï¼Œé’ˆå¯¹ä¸Šè¿° Commit å’Œ è®¾è®¡æ–‡æ¡£ä¼šå†å¦å¼€ä¸€ç¯‡æ¥ä»‹ç»ï¼Œå› ä¸ºå…¶æœ¬è´¨å’Œ CPU Manager æ— å…³ï¼Œä½†æ˜¯æ˜¯éå¸¸é‡å¤§çš„ä¸€ä¸ªæ”¹å˜ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:6:2","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"å·²çŸ¥é—®é¢˜ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:7:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"1.18 ä¹‹å‰çš„ç‰ˆæœ¬ éœ€è¦æ ¹æ®å…·ä½“ä½¿ç”¨çš„ k8s ç‰ˆæœ¬ç¡®å®šæœ‰å“ªäº›ä¿®å¤çš„ PR è¿˜æ²¡æœ‰åˆå…¥ã€‚ å³ä½¿æ‰€æœ‰ PR éƒ½å·²ç»åˆå…¥äº†ï¼Œä¹Ÿè¿˜æ˜¯å¯èƒ½é‡åˆ°é—®é¢˜çš„ã€‚åŸå› å¦‚ä¸‹ï¼šå½“é‡åˆ°æœºå™¨å¼‚å¸¸ï¼Œå¦‚ docker å¼‚å¸¸ã€load é«˜ã€io ä½¿ç”¨ç‡é«˜æ—¶é—®é¢˜å‡ºç°æ¦‚ç‡ä¼šå¢åŠ ï¼Œæ ¹æœ¬åŸå› å°±åœ¨äº 1.18 ä¹‹å‰çš„ç‰ˆæœ¬ cpu_manager_state æ–‡ä»¶å¯¹åº”çš„æ•°æ®ç»“æ„ä¸º map[ContainerID]resourceï¼Œä¹Ÿå°±æ˜¯è¯´ä»–æ˜¯ä»¥ container ID ä½œä¸º Key çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰ä¸Šé¢è§£å†³æ–¹æ¡ˆä¸­æåˆ°æ›´å‰å®³çš„çš„ç§˜ç±ï¼Œå› ä¸ºåŒ Podï¼ŒåŒ Container Name å­˜åœ¨å¤šä¸ª Containerï¼Œæ¯ä¸ªéƒ½æœ‰è‡ªå·±çš„ IDï¼Œä½†é€»è¾‘ä¸Šåº”è¯¥åªè®°å½•ä¸€ä¸ªåˆ° cpu_manager_state ä¸­ï¼Œä½†å®é™…ä¸Šè®°å½•äº†å¤šä¸ªã€‚ åœ¨ 1.18 ä¹‹åï¼Œcpu_manager_state æ–‡ä»¶æ•°æ®ç»“æ„å‘ç”Ÿæ”¹å˜ï¼Œå˜ä¸ºmap[PODUID]map[ContainerName]resourceï¼Œå°±å¯ä»¥é¿å…å‡ºç°åŒ Pod åŒ Container Name çš„å®¹å™¨å ç”¨å¤šä»½èµ„æºçš„é—®é¢˜ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:7:1","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"æ‰€æœ‰ç‰ˆæœ¬ å¯¹äºå¼ºåˆ¶åˆ é™¤çš„Podï¼Œå¦‚æœåœ¨å…¶åˆ é™¤è¿‡ç¨‹ä¸­é‡åˆ°æŸäº›åŸå› å¯¼è‡´ Container æ— æ³•åˆ é™¤å¯¼è‡´å…¶å†…å­˜å’Œ cpu_manager_state ä¸­è®°å½•çš„ä¿¡æ¯ä¸å®é™…ä½¿ç”¨ä¸ç¬¦æ—¶ï¼Œä¹Ÿå¯èƒ½ä¼šé‡åˆ°æ­¤é—®é¢˜ã€‚è¿™ç§é—®é¢˜ç†è®ºä¸Šé€šè¿‡ç®€å•çš„3æ­¥è§£å†³æ–¹æ¡ˆå³å¯è§£å†³ã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:7:2","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["æºç åˆ†æ","é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ å¦‚æœä¸€å®šè¦ä½¿ç”¨ç»‘æ ¸åŠŸèƒ½ï¼Œè¯·å°½é‡ä½¿ç”¨ 1.18 åŠä»¥ä¸Šç‰ˆæœ¬ï¼ŒåŒæ—¶å½“å‰æœ€æ–°ç‰ˆ 1.23 å°šæœªæ­£å¼ releaseï¼Œä¸” 1.22 å¼€å§‹å¯¹ Kubulet è¿›è¡Œäº†éƒ¨åˆ†é‡æ„ï¼Œå­˜åœ¨å¤§é‡å·²çŸ¥é—®é¢˜ï¼Œå»ºè®®é‡‡ç”¨ 1.18 ~ 1.21 ä¸­çš„ç‰ˆæœ¬ã€‚å¦‚æœè¿˜æ˜¯é‡åˆ°æ­¤é—®é¢˜ï¼Œå‚è€ƒä¸Šè¿°è§£å†³æ–¹æ¡ˆã€‚ ","date":"2021-10-16","objectID":"https://www.likakuli.com/posts/kubernetes-cpu-manager/:8:0","tags":["kubernetes"],"title":"é‚£äº›å¹´ï¼Œæˆ‘ä»¬ä¸€èµ·è¿½çš„Bug","uri":"https://www.likakuli.com/posts/kubernetes-cpu-manager/"},{"categories":["éšç¬”"],"content":"æœºç¼˜å·§åˆ å»å¹´ä¸€ä¸ªå¶ç„¶çš„æœºä¼šåœ¨æŠ–éŸ³ä¸Šåˆ·åˆ°äº†\"å§œèƒ¡è¯´\"ï¼Œé‡Œé¢ä¸ä¹ä¸€äº›æœ‰è¶£ä¸”å‘äººæ·±æ€çš„å†…å®¹ï¼Œåœ¨å…¶ä¸­ä¸€æœŸä¸­èƒ¡å­æåˆ°äº†å‡ æœ¬ä¹¦ï¼Œå…¶ä¸­åŒ…å«ã€Šæ€è€ƒ å¿«ä¸æ…¢ã€‹ï¼Œåˆåã€Šæ…¢æ€å¿«è¡Œã€‹ï¼Œä½œè€…ä¸¹å°¼å°” Â· å¡å°¼æ›¼ï¼Œè¯ºè´å°”ç»æµå­¦å¥–è·å¾—è€…ï¼Œè¡Œä¸ºç»æµå­¦çš„åˆ›å§‹äººä¹‹ä¸€ã€‚æœ¬ä¹¦å¸å¼•æˆ‘çš„åœ°æ–¹åœ¨äºå…¶ä¸­æ¶‰åŠåˆ°äº†å¤§é‡çš„å¿ƒç†å­¦ç†è®ºã€å¿ƒç†å­¦å®éªŒç­‰å†…å®¹ï¼Œåˆ†æäº†äººæ€è€ƒçš„è¿‡ç¨‹ï¼Œè¿™æ˜¯æœ€å¸å¼•æˆ‘çš„åœ°æ–¹ã€‚ä¹‹å‰ä¹Ÿå°è¯•é˜…è¯»è¿‡ä¸€äº›å…³äºæ²Ÿé€šæŠ€å·§çš„ä¹¦ï¼Œä¾‹å¦‚ã€Šéæš´åŠ›æ²Ÿé€šã€‹ï¼Œå›½å†…å¤–æœ‰å¤§é‡ç›¸å…³çš„ä¹¦ï¼Œä½†åŸºæœ¬éƒ½å±äºåœ¨ä»‹ç»æ²Ÿé€šæŠ€å·§ï¼Œæ¯”è¾ƒå¥½çš„é‡Œé¢ä¼šè®¾ç½®ä¸€äº›å®é™…æ¡ˆä¾‹æˆ–è€…ä»‹ç»ä¸€ä¸‹ç›¸å…³çš„å¿ƒç†å­¦æ•ˆåº”ï¼Œä½†æ˜¯è¯»å®Œå§‹ç»ˆéƒ½æ„Ÿè§‰ç¼ºå°‘ç‚¹ä»€ä¹ˆã€‚è¿™ç§æ„Ÿè§‰æœ‰ç‚¹ç±»ä¼¼è™½ç„¶æˆ‘è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯æˆ‘å¹¶ä¸çŸ¥é“é—®é¢˜å‘ç”Ÿçš„æ ¹å› æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•é¿å…é—®é¢˜çš„å‘ç”Ÿï¼Œå¦‚ä½•åšåˆ°ä¸¾ä¸€åä¸‰ï¼Œä»¥ä¸å˜åº”ä¸‡å˜ç­‰ã€‚ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:1:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["éšç¬”"],"content":"è¿·ä¹‹è‡ªä¿¡ ä¹¦ä¸­æŠŠäººç±»çš„æ€è€ƒæ¨¡å¼æ‹†åˆ†æˆå¿«æ€è€ƒå’Œæ…¢æ€è€ƒï¼ˆç³»ç»Ÿ1å’Œç³»ç»Ÿ2ï¼‰ä¸¤ä¸ªç³»ç»Ÿï¼Œç³»ç»Ÿ1å’Œç³»ç»Ÿ2å¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„å®ä½“ï¼Œä¹Ÿä¸æ˜¯å¤§è„‘ä¸­æŸä¸ªå›ºå®šçš„éƒ¨ä½ï¼Œå®ƒä»¬æ˜¯ä¸¤ç§ä¸åŒçš„æ€è€ƒæ¨¡å¼ã€‚ä¹‹æ‰€ä»¥å«ç³»ç»Ÿ1å’Œç³»ç»Ÿ2ï¼Œåªæ˜¯ä¸ºäº†ç†è§£èµ·æ¥æ›´æ–¹ä¾¿ã€‚ ç³»ç»Ÿ1æ˜¯ä¾èµ–ç›´è§‰çš„ã€æ— æ„è¯†çš„æ€è€ƒç³»ç»Ÿï¼Œç³»ç»Ÿ2æ˜¯éœ€è¦ä¸»åŠ¨æ§åˆ¶çš„ã€æœ‰æ„è¯†è¿›è¡Œçš„æ€è€ƒç³»ç»Ÿã€‚ç³»ç»Ÿ1æ˜¯ç›´è§‰ç³»ç»Ÿï¼Œè¿è¡Œèµ·æ¥é€Ÿåº¦å¿«ï¼Œä¸æ€ä¹ˆæ¶ˆè€—è„‘åŠ›ï¼Œä¸ç”¨æ„è¯†æ§åˆ¶ï¼Œå¯ä»¥ç§°ä¸ºå¿«æ€è€ƒã€‚ç³»ç»Ÿ2æ˜¯éç›´è§‰ç³»ç»Ÿï¼Œæœ‰æ„è¯†è¿›è¡Œï¼Œéœ€è¦ä¿æŒè¶³å¤Ÿçš„ä¸“æ³¨ï¼Œä¸»åŠ¨æ§åˆ¶ï¼Œå¯ä»¥ç§°ä¸ºæ…¢æ€è€ƒã€‚ åœ¨ä¸»è§‚ä¸Šï¼Œæˆ‘ä»¬å¾€å¾€è§‰å¾—è‡ªå·±æ˜¯ç†æ€§çš„ã€‚ä½†å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æ˜¯åœ¨ç³»ç»Ÿ1çš„æŒ‡å¼•ä¸‹ï¼Œåœ¨æ— æ„è¯†ä¹‹é—´å®Œæˆçš„ã€‚å› ä¸ºç³»ç»Ÿ2éœ€è¦é›†ä¸­æ³¨æ„åŠ›ï¼Œä½†äººç±»å¤§è„‘åˆæ˜¯å¤©ç”Ÿæœ‰æƒ°æ€§çš„ï¼Œä¸æ„¿æ„å¤šä»˜å‡ºè¿™äº›æ³¨æ„åŠ›ï¼ˆæœ€çœåŠ›åŸåˆ™ï¼‰ã€‚åœ¨è¿™ç§æƒ°æ€§ä¹‹ä¸‹ï¼Œç³»ç»Ÿ2å¾€å¾€ä¼šå¯¹ç³»ç»Ÿ1çš„ç›´è§‚åˆ¤æ–­æ— æ¡ä»¶æ¥å—ã€‚å°¤å…¶æ˜¯åœ¨äººç²¾åŠ›ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿ2ä¼šæ›´åŠ å¼±åŠ¿ã€‚ç³»ç»Ÿ1çš„ç›´è§‰å¼å¿«æ€è€ƒï¼Œä¹Ÿå°±æˆä¸ºäº†äººä»¬å†³ç­–å’Œè¡Œä¸ºçš„çœŸæ­£ä¸»å®°ã€‚è€Œç³»ç»Ÿ1è‡ªèº«å­˜åœ¨çš„ç¼ºé™·ï¼Œå®¹æ˜“å¯¼è‡´äººåœ¨æ€è€ƒè¿‡ç¨‹ä¸­å‡ºç°åè§å’Œé”™è¯¯ã€‚è€Œä¸”æˆ‘ä»¬ä¸ä»…ä¼šå‡ºç°åè§ä¸é”™è¯¯ï¼Œè¿˜å®¹æ˜“ç›´æ¥å¿½è§†è‡ªå·±ä¼šå‡ºç°åè§ä¸é”™è¯¯è¿™ä»¶äº‹æœ¬èº«ï¼Œäº§ç”Ÿè¿·ä¹‹è‡ªä¿¡ã€‚ ä¹¦ä¸­æåˆ°äº†å¾ˆå¤šé€ æˆç³»ç»Ÿ1å‡ºç°åè§å’Œé”™è¯¯çš„ç°è±¡ï¼Œå¦‚å…¸å‹æ€§åå¥½ã€å¯å¾—æ€§åå¥½ã€å› æœæ€§åå¥½ã€å…‰ç¯æ•ˆåº”ã€é”šå®šæ•ˆåº”ã€æ¡†æ¶æ•ˆåº”ã€ç¦€èµ‹æ•ˆåº”ç­‰ï¼Œå¾—å‡ºè¿™äº›ç»“è®ºæ‰€æ¶‰åŠåˆ°çš„ä¸€äº›å®éªŒä¹Ÿæ˜¯ç‰¹åˆ«çš„æœ‰æ„æ€ã€‚ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:2:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["éšç¬”"],"content":"æœ¬ç¯‡ç”±æ¥ æœ¬ç¯‡å¹¶ä¸æ˜¯è¯»åæ„Ÿï¼Œåœ¨è¿™é‡Œæ˜¯æƒ³è®°å½•åˆ†äº«ä¸€äº›è‡ªå·±è¿™æ®µæ—¶é—´é‡åˆ°çš„ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„äº‹æƒ…ï¼Œå°è¯ä¹¦ä¸­çš„éƒ¨åˆ†è§‚ç‚¹ï¼šäººç±»æ€è€ƒå¤©ç„¶å­˜åœ¨ç¼ºé™·ï¼Œä¸å¯é¿å…çš„ä¼šå‡ºç°åè§ä¸é”™è¯¯ã€‚æ„è¯†åˆ°è¿™äº›é—®é¢˜å¯¹äºæˆ‘ä»¬åœ¨åšå†³ç­–ã€æ²Ÿé€šã€åšäº‹ç­‰æ–¹é¢ä¼šæœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚æ¥ä¸‹æ¥èŠå‡ ä¸ªæœ‰æ„æ€çš„äº‹ã€‚ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:3:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["éšç¬”"],"content":"è¿ªåŠ æ³°ç½— æœ‰ä¸€é¦–æ¯”è¾ƒç«çš„æ­Œæ›²ï¼Œåå­—å«ã€Šè¸å±±æ²³ã€‹ï¼Œå¯èƒ½å¤§å®¶å¯¹åå­—æ¯”è¾ƒé™Œç”Ÿï¼Œä½†æ˜¯åº”è¯¥å¾ˆå¤šäººéƒ½å¬è¿‡ï¼Œå…¶é«˜æ½®éƒ¨åˆ†é‡Œé¢æœ‰å‡ å¥æ­Œè¯ï¼š è€Œæˆ‘æªå‡ºå¦‚é¾™ ä¹¾å¤æ’¼åŠ¨ ä¸€å•¸ç ´è‹ç©¹ é•¿æªåˆºç ´äº‘éœ æ”¾ä¸‹ä¸€ç”Ÿç‰µæŒ‚ æœ›ç€å¯’æœˆå¦‚ç‰™ å­¤èº«çºµé©¬ ç”Ÿæ­»æ— è¯ æˆ‘å„¿å­ä¹Ÿç‰¹åˆ«å–œæ¬¢è¿™ä¸€æ®µï¼Œä½†æ˜¯ä»ä»–å˜´é‡Œå”±å‡ºæ¥çš„è°ƒæ˜¯è¿™ä¸ªè°ƒï¼Œä½†è¯å°±å®Œå…¨å¬ä¸å‡ºæ¥æ˜¯å•¥äº†ï¼Œæˆ‘é—®ä»–å•¥æ­Œè¯ï¼Œä»–è¯´å•¥å¥¥ç‰¹å¤§è‹±é›„ï¼Œè¿ªåŠ æ³°ç½—ï¼Œå½é‡Œå‘±å•¦å•¥å•¥å•¥çš„ï¼Œå¾ˆå¤šå¬ä¸æ‡‚çš„è¯ã€‚è¿˜ç»™æˆ‘è§£é‡Šè¿ªè¿¦æ˜¯å•¥ï¼Œæ³°ç½—æ˜¯å•¥ï¼Œæˆ‘è™½ç„¶æ´»äº†30å²äº†ï¼Œä½†è¿˜çœŸæ²¡çœ‹è¿‡å¥¥ç‰¹æ›¼ã€‚æˆ‘å¯¹ä»–å”±çš„æ­Œè¯ä¸€ç›´çš„å°è±¡å°±æ˜¯è¿˜æŒºèƒ½ç¼–çš„ï¼ŒæŒºé¡ºå£çš„è¿˜ï¼Œç›´åˆ°æˆ‘å¬åˆ°å¥¥ç‰¹æ›¼ç‰ˆæœ¬çš„è¸å±±æ²³æ‰çŸ¥é“ï¼Œè¿˜çœŸæœ‰è¿™ä¸ªæ­Œè¯ï¼Œè€Œä¸”å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ã€‚è¿™ä¸ªæ—¶å€™æ‰æ„è¯†åˆ°ä»–æ˜¯\"å¯¹\"çš„ï¼Œæˆ‘ä¹‹å‰å¯¹ä»–çš„å°è±¡ - è§‰å¾—ä»–è‡ªå·±çç¼–çš„æ˜¯\"é”™\"çš„ã€‚ä»–å£ä¸­é‚£äº›ä¸ªå½é‡Œå‘±å•¦çš„å¯èƒ½å¯¹åº”çš„å°±æ˜¯å…¶ä¸­çš„æ—¥è¯­çš„ä¸€éƒ¨åˆ†ï¼Œæå¾—æˆ‘è¿™ä¸ªå¥½æ­¹æ—¥è¯­ä¹Ÿè¿‡äº†N2çš„éƒ½å¬ä¸æ‡‚ï¼Œæ±—é¢œå•Šã€‚ å›è¿‡å¤´æ¥æƒ³ä¸€æƒ³ï¼Œä¸ºå•¥æˆ‘çš„ååº”ä¼šæ˜¯æ­Œè¯æ˜¯ä»–çç¼–çš„å‘¢ï¼Ÿ å› ä¸ºå„¿å­ç»å¸¸ç”¨å¹³æ¿çœ‹å¥¥å°”æ›¼ç‰‡æ®µï¼Œåœ¨ä»–çš„æ­Œè¯ä¸­æ¶‰åŠåˆ°äº†å¥¥ç‰¹æ›¼ï¼ŒåŠ ä¹‹åœ¨ä»–è¿™ä¸ªå¹´çºªï¼ˆ4å²å¤šï¼‰ï¼Œåœ¨æˆ‘å¾—å‡ºä»–æ˜¯åœ¨çç¼–çš„ç»“è®ºæ—¶ï¼Œå‡ ä¹ä¸éœ€è¦æ€è€ƒï¼Œå¯ä»¥è¯´æ˜¯å°±åƒæ¡ä»¶åå°„ä¸€æ ·ã€‚è¿™å¯ä»¥ç”¨å¯å¾—æ€§åå¥½ã€å› æœæ€§åå¥½è§£é‡Šã€‚ å¯å¾—æ€§åå¥½ï¼šå¦‚æœä¸€ä»¶äº‹æƒ…æ›´å®¹æ˜“å‡ºç°åœ¨å¤§è„‘é‡Œï¼Œäººä»¬å°±è®¤ä¸ºè¿™ä»¶äº‹æƒ…æ›´å®¹æ˜“å‘ç”Ÿã€‚ å› æœæ€§åå¥½ï¼šå–œæ¬¢å¯¹äº‹ç‰©è¿›è¡Œå› æœå…³ç³»è§£é‡Šï¼Œè€Œä¸ç®¡æ˜¯ä¸æ˜¯è§£é‡Šæ˜¯ä¸æ˜¯åˆç†ã€‚ å› ä¸ºä»–å››å²ï¼Œæˆ‘å°±è§‰å¾—ä»–æ˜¯ç¼–çš„ï¼Œå› ä¸ºä»–ç»å¸¸çœ‹å¥¥ç‰¹æ›¼ï¼Œæˆ‘å°±è§‰å¾—ä»–æ˜¯ç¼–çš„ã€‚åœ¨æˆ‘å¯¹ä»–åšå‡ºåˆ¤æ–­æ—¶ï¼Œæˆ‘çš„è®¤çŸ¥é‡Œæ ¹æœ¬ä¸å­˜åœ¨å¥¥ç‰¹æ›¼ç‰ˆè¸å±±æ²³ï¼Œæ›´ä¸ä¼šæœ‰äººå«ä»–è¿™ä¸ªæ­Œè¯ï¼Œâ€œè¿™æ˜¯ä»–ç¼–æ­Œè¯\"çš„è¿™ä¸ªäº‹æƒ…ç›´æ¥å‡ºç°åœ¨æˆ‘çš„å¤§è„‘é‡Œï¼Œå› æ­¤æˆ‘æ¯«ä¸è´¹åŠ›çš„å¯¹ä»–çš„è¿™ç§è¡Œä¸ºåšå‡ºäº†ä¸€ä¸ªæ— æ„è¯†çš„é”™è¯¯çš„åˆ¤æ–­ã€‚ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:3:1","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["éšç¬”"],"content":"ä»–å±±ä¹‹çŸ³ å‰ä¸€æ®µæ—¶é—´æ¢äº†ä»½å·¥ä½œï¼Œåœ¨æ–°å…¬å¸çš„ä¸€äº›ç»å†â€ä¿ƒä½¿â€œæˆ‘å¯¹åœ¨ä¸Šä¸€å®¶çš„å…¬å¸çš„ä¸€äº›å·¥ä½œé‡æ–°åšäº†æ€»ç»“ï¼Œå¯¹æŸäº›äº‹æœ‰äº†é‡æ–°çš„è®¤è¯†ï¼Œè™½ç„¶åœ¨æ¢å·¥ä½œæ—¶è‡ªå·±ä¹Ÿæ›¾æ€»ç»“æ¯ä»½å·¥ä½œä¸­è‡ªå·±çš„æˆé•¿æ”¶è·ä»¥åŠéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œä½†æ€»æ„Ÿè§‰æ•ˆæœæ²¡æœ‰é‚£ä¹ˆå¥½ï¼Œæ²¡æœ‰é‚£ä¹ˆæ·±åˆ»ï¼Œæˆ–è€…ä¼šå¿½è§†å¾ˆå¤šé—®é¢˜ä¸æ”¶è·ï¼Œæ‰€è°“â€å½“å±€è€…è¿·â€œã€‚ å‰å‡ å¤©æœ‹å‹åœˆçœ‹åˆ°èªå“¥åˆ†äº«çš„çŸ¥ä¹ä¸Šçš„ä¸€ç¯‡çŸ­æ–‡ï¼šé‚£æ—¶å€™æˆ‘è¿˜ä¸æ˜ç™½ã€‚æ‘˜å–ä¸€æ®µå…¶å†…å®¹ï¼š å¿µè¿‡å¤ªå¤šå¤ªå¤šçš„è¯—è¯ï¼Œè¯»è¿‡å¤ªå¤šå¤ªå¤šçš„æ•…äº‹ï¼Œå“ªæ€•å·²ç»æ·±æ·±åœ°åˆ»åœ¨è„‘ä¸Šï¼Œå¯ä¾æ—§æ˜¯ä¸æ˜ç™½ã€‚ ä¸æ˜ç™½åŒå”ä¸ºä½•è¦æœ›å°½å¤©æ¶¯è·¯ï¼Œä¸æ˜ç™½ç¨¼è½©ä¸ºä½•ä¼šé“å¤©å‡‰å¥½ä¸ªç§‹ã€‚ ä¸æ˜ç™½å¹½æ¢¦é‡Œç›¸å¯¹æ— è¨€å”¯æœ‰æ³ªåƒè¡Œçš„æ€å¿†ä¹‹ç—›ï¼Œä¸æ˜ç™½åƒ§åºä¸‹å¤œå¬ç»†é›¨ç‚¹æ»´åˆ°å¤©æ˜çš„é»ç¦»ä¹‹æ‚²ã€‚ ä¸æ˜ç™½é¡¹è„Šè½©ä¸­äº­äº­å¦‚ç›–çš„æ‡æ·æ ‘ï¼Œä¸æ˜ç™½å§‘è‹åŸå¤–ç‹¬å¯¹æ„çœ çš„æ¸”ç«é’Ÿå£°ã€‚ è¯¾æœ¬çš„æ³¨é‡Šå†™å¾—å†æ¸…æ™°ï¼Œè€å¸ˆçš„è®²è§£è¯´å¾—å†é€å½»ï¼Œä¹Ÿåªå‹‰å¼ºè¯»å¾—æ‡‚è¯ä¸­æ„ï¼Œå¥ˆä½•å‚ä¸é€å¥ä¸­æƒ…ã€‚ æ˜¯å•Šï¼Œå¹´å°‘ä¹‹æ—¶ï¼Œåˆæ€ä¹ˆä¼šæ‡‚ä¸§å­äº¡å¦»ï¼Œæ€ä¹ˆä¼šæ‡‚å›½ç ´å®¶äº¡ï¼Œæ€ä¹ˆä¼šæ‡‚äººé¬¼æ®Šé€”ï¼Œæ€ä¹ˆä¼šæ‡‚åè½å­™å±±ã€‚ã€€ç›´åˆ°ä¸€å¤©ï¼Œä¹¦é‡Œçš„æ•…äº‹å˜æˆäº†äººç”Ÿï¼Œè«åæ‚²ç—›æ¶Œä¸Šå¿ƒå¤´ï¼Œä¸èƒ½è‡ªå·²ï¼Œæ‰å¤§å½»å¤§æ‚Ÿï¼Œé†é†çŒé¡¶ï¼Œä»¿ä¼¼å¤§æ¢¦åˆé†’ã€‚å¦‚æ¢¦å¹»æ³¡å½±ï¼Œå¦‚éœ²äº¦å¦‚ç”µã€‚ å¡å°¼æ›¼è®¤ä¸ºï¼Œç³»ç»Ÿ2æ˜¯æ‡’æƒ°çš„ï¼Œè¦è®©è¿™ä¸ªæ‡’æƒ°çš„ç³»ç»Ÿå˜å¾—å‹¤å¿«èµ·æ¥ï¼Œå°±éœ€è¦åˆ»æ„çš„æç¤ºï¼Œå¯ä»¥æ˜¯è‡ªæˆ‘æç¤ºï¼Œä¹Ÿå¯ä»¥æ˜¯æ¥è‡ªäºå¤–éƒ¨çš„æç¤ºã€‚è¿™ä¸¤ç§æ–¹å¼ç›¸æ¯”è¾ƒï¼Œå¤–éƒ¨æç¤ºå¾€å¾€æ˜¯æ›´åŠ æœ‰æ•ˆçš„ã€‚ ä¸–ç•Œå¾ˆå¥‡å¦™ï¼Œä¸åŒé¢†åŸŸçš„ä¸€äº›ç»“è®ºæ€»æœ‰æƒŠäººçš„ç›¸ä¼¼ä¹‹å¤„ã€‚ä¾‹å¦‚ ç”µå½±ä¸­ä¹Ÿç»å¸¸å¯ä»¥çœ‹åˆ°ç±»ä¼¼æ¡¥æ®µï¼Œè¢«èœ˜è››å’¬äº†æ‰æœ‰äº†èœ˜è››ä¾ ï¼›ã€ŠåŠŸå¤«ä¸­ã€‹çš„å‘¨æ˜Ÿé©°è™½ç„¶æ˜¯ç™¾å¹´ä¸é‡çš„æ­¦å­¦å¥‡æ‰ï¼Œä½†ä¹Ÿæ˜¯åœ¨è¢«ç«äº‘é‚ªç¥æ‰“çš„è¿ä»–å¦ˆéƒ½ä¸è®¤è¯†ä¹‹åï¼Œæ— æ„ä¸­æ‰“é€šä»»ç£äºŒè„‰æ‰ç ´èŒ§æˆè¶ã€‚ é«˜ä¸­ç‰©ç†ä¸­å­¦åˆ°çš„\"åŠ›æ˜¯æ”¹å˜ç‰©ä½“è¿åŠ¨çŠ¶æ€çš„åŸå› ï¼Œè€Œä¸æ˜¯ç»´æŒç‰©ä½“è¿åŠ¨çš„åŸå› â€ã€‚ çƒ­åŠ›å­¦ä¸­æåˆ°çš„\"ç†µ\"ï¼Œå³æ ¹æ®çƒ­åŠ›å­¦ç¬¬ä¸€å®šå¾‹ä¸ç¬¬äºŒå®šå¾‹ï¼Œèƒ½é‡æ˜¯å®ˆæ’çš„ï¼Œå¯ä»¥äº’ç›¸è½¬åŒ–ï¼Œè€Œä¸ä¼šæ¶ˆå¤±ï¼Œä½†æ˜¯æ— æ³•100%åˆ©ç”¨ã€‚åœ¨è½¬åŒ–è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯æœ‰ä¸€éƒ¨åˆ†èƒ½é‡ä¼šè¢«æµªè´¹æ‰ï¼Œå…¬å¼å¦‚ä¸‹ èƒ½é‡çš„æ€»å’Œ = æœ‰æ•ˆèƒ½é‡ + æ— æ•ˆèƒ½é‡ â€œç†µ\"å°±æ˜¯æ— æ•ˆèƒ½é‡ï¼Œæ˜¯\"æ— åºåŒ–\"çš„åº¦é‡ã€‚â€œæ— åºåŒ–\"ä»£è¡¨ç€æ··ä¹±ï¼Œå¯ä»¥å¾—åˆ°ä¸‰ä¸ªé‡è¦ç»“è®ºï¼š å¦‚æœæ²¡æœ‰å¤–éƒ¨èƒ½é‡è¾“å…¥ï¼Œå°é—­ç³»ç»Ÿè¶‹å‘è¶Šæ¥è¶Šæ··ä¹±ï¼ˆç†µè¶Šæ¥è¶Šå¤§ï¼‰ã€‚ å¦‚æœè¦è®©ä¸€ä¸ªç³»ç»Ÿå˜å¾—æ›´æœ‰åºï¼Œå¿…é¡»æœ‰å¤–éƒ¨èƒ½é‡çš„è¾“å…¥ å½“ä¸€ä¸ªç³»ç»Ÿï¼ˆæˆ–éƒ¨åˆ†ï¼‰å˜å¾—æ›´åŠ æœ‰åºï¼Œå¿…ç„¶æœ‰å¦ä¸€ä¸ªç³»ç»Ÿï¼ˆæˆ–éƒ¨åˆ†ï¼‰å˜å¾—æ›´åŠ æ— åºï¼Œè€Œä¸”\"æ— åº\"çš„å¢åŠ ç¨‹åº¦å°†è¶…è¿‡\"æœ‰åº\"çš„å¢åŠ ç¨‹åº¦ã€‚ ç­‰ç­‰ç­‰ç­‰â€¦ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:3:2","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["éšç¬”"],"content":"é¥®æ°´æœºæ—çš„é—²è°ˆ æˆ‘ä»¬ç»å¸¸ä¼šé¢ä¸´é€‰æ‹©ä¸å†³ç­–ï¼Œç°åœ¨æˆ‘ä»¬å·²ç»å¼€å§‹é€æ¸æ„è¯†åˆ°æˆ‘ä»¬çš„æ€è€ƒæ˜¯å­˜åœ¨ç¼ºé™·çš„ï¼Œä½†æ˜¯å¯ä»¥å€ŸåŠ©å¤–éƒ¨åŠ›é‡æ¥å¸®æˆ‘ä»¬çº æ­£ã€‚å½“æˆ‘ä»¬èº«å¤„ä¸€ä¸ªæœºæ„ä¹‹ä¸­ï¼Œèº«è¾¹å°±ä¼šæœ‰å¾ˆå¤šæ—è§‚è€…ã€‚è¿™äº›æ—è§‚è€…ä¼šç”¨æ¥è‡ªäºä»–ä»¬ç³»ç»Ÿ2çš„æ…¢æ€è€ƒï¼Œæ¥å¸®ä½ çº æ­£è‡ªå·±ç³»ç»Ÿ1çš„å¿«æ€è€ƒå¯èƒ½å¯¼è‡´çš„é”™è¯¯ã€‚æ‰€ä»¥ï¼Œé›†ä½“è®¨è®ºå†³ç­–è™½ç„¶ä¼šæœ‰æ•ˆç‡ä¸é«˜çš„é—®é¢˜ï¼Œä½†åœ¨å¾ˆå¤šæƒ…å†µä¸‹å´è¿˜æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥å¯åŠ¨å¾ˆå¤šäººçš„æ…¢æ€è€ƒï¼Œå‡å°‘å¿«æ€è€ƒå¯èƒ½å¸¦æ¥çš„åè§ä¸å¤±è¯¯ã€‚ ä¹¦ä¸­æåˆ°äº†é¥®æ°´æœºé—²è°ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ°æ¯”è¾ƒè½»æ¾çš„ç¯å¢ƒï¼Œå¬å¬å¤§å®¶çš„é—²è°ˆå’Œæ‰¹è¯„ã€‚å»é¢å¯¹è¿™äº›æ‰¹è¯„è™½ç„¶ä¸å®¹æ˜“ï¼Œä½†æ˜¯æ¯”èµ·è‡ªå·±é¼“èµ·å‹‡æ°”è‡ªæˆ‘æ‰¹è¯„ï¼Œè¿˜æ˜¯å®¹æ˜“å¾—å¤šã€‚è€Œæ— è®ºæ˜¯å¬åˆ«äººçš„é—²è¨€ç¢è¯­ï¼Œè¿˜æ˜¯è‡ªæˆ‘åæ€è‡ªæˆ‘æ‰¹è¯„ï¼Œç›®çš„éƒ½æ˜¯ä¸€ä¸ªï¼Œè®©æ€è€ƒæ…¢ä¸‹æ¥ï¼Œè®©ç³»ç»Ÿ2è¿è½¬èµ·æ¥ï¼Œå°½é‡é¿å…ç³»ç»Ÿ1çš„ç›´è§‰æ€ç»´å’Œå¿«æ€è€ƒï¼Œå¯èƒ½ç»™æˆ‘ä»¬å¸¦æ¥çš„åè§å’Œå¤±è¯¯ã€‚ å…ˆè®©æ€è€ƒæ…¢ä¸‹æ¥ æ›¾å­è¯´ï¼šå¾æ—¥ä¸‰çœå¾èº«ï¼Œä¸ºäººè°‹è€Œä¸å¿ ä¹ï¼Ÿä¸æœ‹å‹äº¤è€Œä¸ä¿¡ä¹ï¼Ÿä¼ ä¸ä¹ ä¹ï¼Ÿ å­£æ–‡å­ä¸‰æ€è€Œåè¡Œã€‚å­é—»ä¹‹ï¼Œæ›°ï¼šâ€œå†ï¼Œæ–¯å¯çŸ£ã€‚â€ èµ¤å£ä¹‹æˆ˜ä¸­å­™æƒé¢å¯¹ä¼—æ–‡å®˜çš„æåŠ›åŠé™è¯´å‡ºäº†ï¼šæ­¤äº‹å®¹æˆ‘ä¸‰æ€ã€‚ å†å€ŸåŠ©ä»–å±±ä¹‹çŸ³ ä¸‰äººè¡Œï¼Œå¿…æœ‰æˆ‘å¸ˆç„‰ã€‚æ‹©å…¶å–„è€…è€Œä»ä¹‹ï¼Œå…¶ä¸å–„è€…è€Œæ”¹ä¹‹ ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥ä¸ºé”™ï¼›ä»–å±±ä¹‹çŸ³ï¼Œå¯ä»¥æ”»ç‰ ä»¥é“œä¸ºé•œï¼Œå¯ä»¥æ­£è¡£å† ï¼Œä»¥å¤ä¸ºé•œï¼Œå¯ä»¥è§å…´æ›¿ï¼Œä»¥äººä¸ºé•œï¼Œå¯ä»¥çŸ¥å¾—å¤± å…±å‹‰ ","date":"2021-07-10","objectID":"https://www.likakuli.com/posts/thoughtfulessay/:4:0","tags":["æ€è€ƒ","éšç¬”"],"title":"æ€æƒ³éšç¬”1 - æ€è€ƒæ€è€ƒçš„è¿‡ç¨‹","uri":"https://www.likakuli.com/posts/thoughtfulessay/"},{"categories":["åŸç†ä»‹ç»"],"content":"ç”±æ¥ æœ€è¿‘çš„å·¥ä½œå†…å®¹ä¸­æ¶‰åŠåˆ°äº† NUMA æ„ŸçŸ¥ç›¸å…³çš„åŠŸèƒ½ï¼Œä¹‹å‰æ²¡æœ‰ç‰¹æ„å»çœ‹è¿‡ kubelet ç›¸å…³éƒ¨åˆ†çš„å®ç°ï¼Œä¹Ÿæ˜¯è¶æ­¤æœºä¼šæŠŠè½ä¸‹çš„è¡¥è¡¥ã€‚åœ¨çœ‹ä»£ç çš„è¿‡ç¨‹ä¸­ï¼ŒNUMA æ„ŸçŸ¥éƒ¨åˆ†çš„é€»è¾‘å°¤å…¶æ¶‰åŠåˆ°ä¸€äº›ä½æ“ä½œçš„éƒ¨åˆ†ï¼Œçœ‹çš„è®©äººå¤´ç–¼ï¼Œäºæ˜¯ä»ç½‘ä¸Šæœäº†æœæœ‰å…³åŸç†çš„ä»‹ç»ï¼Œæ°å¥½åœ¨å®˜ç½‘æ‰¾åˆ°ä¸€ç¯‡ blogï¼Œçœ‹å®Œä¹‹åå†å»çœ‹ä»£ç å°±ä¼šè±ç„¶å¼€æœ—ã€‚æ­¤ç¯‡æ˜¯å¯¹åŸæ–‡çš„ç¿»è¯‘ï¼Œæƒ³é˜…è¯»åŸæ–‡çš„å¯ä»¥ç›´æ¥åˆ°è¿™é‡Œã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:1:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"TopologyManager TopologyManager åœ¨1.18ç‰ˆæœ¬ä¸­å¤„äº beta çŠ¶æ€ï¼Œè¯¥åŠŸèƒ½æ”¯æŒ CPU å’Œå¤–å›´è®¾å¤‡ï¼ˆä¾‹å¦‚ SR-IOV VF å’Œ GPUï¼‰çš„ NUMA å¯¹é½ï¼Œä½¿å·¥ä½œè´Ÿè½½èƒ½å¤Ÿåœ¨é’ˆå¯¹ä½å»¶è¿Ÿä¼˜åŒ–çš„ç¯å¢ƒä¸­è¿è¡Œã€‚ åœ¨å¼•å…¥ TopologyManager ä¹‹å‰ï¼ŒCPU å’Œè®¾å¤‡ç®¡ç†å™¨ä¼šåšå‡ºç›¸äº’ç‹¬ç«‹çš„èµ„æºåˆ†é…å†³ç­–ã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´ Multi-Socket ç³»ç»Ÿä¸Šå‡ºç°ä¸å¸Œæœ›çš„åˆ†é…ï¼Œé™ä½å»¶è¿Ÿæ•æ„Ÿåº”ç”¨çš„æ€§èƒ½ã€‚éšç€ TopologyManager çš„å¼•å…¥ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰åŠæ³•é¿å…è¿™ç§æƒ…å†µã€‚è¿™ç¯‡blogåŒ…æ‹¬å¦‚ä¸‹å†…å®¹ï¼š NUMA åŠå…¶é‡è¦æ€§ç®€ä»‹ ç”¨æˆ·å¯ä½¿ç”¨çš„ç”¨äºä¿è¯ CPU å’Œå¤–å›´è®¾å¤‡ NUMA å¯¹é½çš„ç­–ç•¥ TopologyManager å†…éƒ¨å·¥ä½œåŸç† TopologyManager å½“å‰é™åˆ¶ TopologyManager æœªæ¥å‘å±•è§„åˆ’ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:2:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"ä»€ä¹ˆæ˜¯NUMA \u0026 ä¸ºä»€ä¹ˆéœ€è¦å…³å¿ƒï¼Ÿ NUMA æ˜¯ Non-Uniform Memory Access çš„ç®€ç§°ã€‚å®ƒæ˜¯ä¸€ç§åœ¨å¤š CPU ç³»ç»Ÿä¸Šå¯ç”¨çš„æŠ€æœ¯ï¼Œå…è®¸ä¸åŒçš„ CPU ä»¥ä¸åŒçš„é€Ÿåº¦è®¿é—®å†…å­˜çš„ä¸åŒéƒ¨åˆ†ã€‚ ä»»ä½•ç›´æ¥è¿æ¥åˆ° CPU çš„å†…å­˜éƒ½è¢«è®¤ä¸ºæ˜¯è¯¥ CPU çš„æœ¬åœ°å†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥éå¸¸å¿«é€Ÿåœ°è®¿é—®ã€‚ ä»»ä½•æœªç›´æ¥è¿æ¥åˆ° CPU çš„å†…å­˜éƒ½è¢«è®¤ä¸ºæ˜¯éæœ¬åœ°çš„ã€‚åœ¨ç°ä»£ç³»ç»Ÿä¸Šï¼Œæœ¬åœ°ä¸éæœ¬åœ°å†…å­˜çš„æ¦‚å¿µä¹Ÿå¯ä»¥æ‰©å±•åˆ°å¤–å›´è®¾å¤‡ï¼Œä¾‹å¦‚ NIC æˆ– GPUã€‚ ä¸ºäº†è·å¾—é«˜æ€§èƒ½ï¼Œåº”è¯¥åˆ†é… CPU å’Œè®¾å¤‡ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥è®¿é—®ç›¸åŒçš„æœ¬åœ°å†…å­˜ã€‚ NUMA ç³»ç»Ÿä¸Šçš„æ‰€æœ‰å†…å­˜éƒ½åˆ†ä¸ºä¸€ç»„NUMA èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ç»„ CPU æˆ–è®¾å¤‡çš„æœ¬åœ°å†…å­˜ã€‚ å¦‚æœå•ä¸ª CPU çš„æœ¬åœ°å†…å­˜ä¸è¯¥ NUMA èŠ‚ç‚¹ç›¸å…³è”ï¼Œåˆ™æˆ‘ä»¬å°†å…¶ç§°ä¸º NUMA èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ã€‚ åŸºäºè®¿é—®å¤–å›´è®¾å¤‡æ—¶æ‰€å¿…é¡»é€šè¿‡çš„æœ€çŸ­äº’è¿æ•°é‡ï¼Œæˆ‘ä»¬å°†å¤–å›´è®¾å¤‡è§†ä¸º NUMA èŠ‚ç‚¹çš„ä¸€éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼Œåœ¨å›¾ 1 ä¸­ï¼ŒCPU 0-3 è¢«ç§°ä¸º NUMA node 0 çš„ä¸€éƒ¨åˆ†ï¼Œè€Œ CPU 4-7 æ˜¯ NUMA node 1 çš„ä¸€éƒ¨åˆ†ã€‚åŒæ ·ï¼ŒGPU 0 å’Œ NIC 0 è¢«ç§°ä¸º NUMA node 0 çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒä»¬ è¿æ¥åˆ° Socket 0ï¼Œå…¶ CPU éƒ½æ˜¯ NUMA node 0 çš„ä¸€éƒ¨åˆ†ã€‚ NUMA node 1 ä¸Šçš„ GPU 1 å’Œ NIC 1 ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ å°½ç®¡ä¸Šé¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº† NUMA èŠ‚ç‚¹åˆ° Socket çš„ 1-1 æ˜ å°„ï¼Œä½†åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¸€å®šå¦‚æ­¤ã€‚ å•ä¸ª NUMA èŠ‚ç‚¹ä¸Šå¯èƒ½æœ‰å¤šä¸ª Socketï¼Œæˆ–è€…å•ä¸ª Socket çš„å•ä¸ª CPU å¯èƒ½è¿æ¥åˆ°ä¸åŒçš„ NUMA èŠ‚ç‚¹ã€‚ æ­¤å¤–ï¼ŒSub-NUMA Clusteringï¼ˆåœ¨æœ€è¿‘çš„è‹±ç‰¹å°” CPU ä¸Šå¯ç”¨ï¼‰ç­‰æ–°å…´æŠ€æœ¯å…è®¸å•ä¸ª CPU ä¸å¤šä¸ª NUMA èŠ‚ç‚¹ç›¸å…³è”ï¼Œåªè¦å®ƒä»¬å¯¹ä¸¤ä¸ªèŠ‚ç‚¹çš„å†…å­˜è®¿é—®æ—¶é—´ç›¸åŒï¼ˆæˆ–å·®å¼‚å¯ä»¥å¿½ç•¥ä¸è®¡ï¼‰ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:3:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"NUMA å¯¹é½ TopologyManager æä¾›äº†å¦‚ä¸‹å‡ ç§å¯¹é½ç­–ç•¥ï¼š noneï¼šæ­¤æ”¿ç­–ä¸ä¼šå°è¯•è¿›è¡Œä»»ä½•èµ„æºè°ƒæ•´ã€‚ å®ƒçš„è¡Œä¸ºå°±åƒ TopologyManager æ ¹æœ¬ä¸å­˜åœ¨ä¸€æ ·ã€‚ è¿™æ˜¯é»˜è®¤ç­–ç•¥ã€‚ best-effortï¼šä½¿ç”¨æ­¤ç­–ç•¥ï¼ŒTopologyManager å°†å°è¯•å°½å¯èƒ½åœ°å¯¹é½ NUMA èŠ‚ç‚¹ä¸Šçš„åˆ†é…ï¼Œä½†å³ä½¿æŸäº›åˆ†é…çš„èµ„æºæœªåœ¨åŒä¸€ NUMA èŠ‚ç‚¹ä¸Šå¯¹é½ï¼Œä¹Ÿä¼šå§‹ç»ˆå…è®¸ pod å¯åŠ¨ã€‚ restrictedï¼šæ­¤ç­–ç•¥ä¸å°½åŠ›è€Œä¸ºç­–ç•¥ç›¸åŒï¼Œä½†å¦‚æœåˆ†é…çš„èµ„æºæ— æ³•æ­£ç¡®å¯¹é½ï¼Œå®ƒå°†å¯¼è‡´ pod å‡†å…¥å¤±è´¥ã€‚ ä¸ single-numa-node ç­–ç•¥ä¸åŒï¼Œå¦‚æœä¸å¯èƒ½åœ¨å•ä¸ª NUMA èŠ‚ç‚¹ä¸Šæ»¡è¶³åˆ†é…è¯·æ±‚ï¼Œåˆ™æŸäº›åˆ†é…å¯èƒ½æ¥è‡ªå¤šä¸ª NUMA èŠ‚ç‚¹ã€‚ single-numa-nodeï¼šè¿™ä¸ªç­–ç•¥æ˜¯æœ€ä¸¥æ ¼çš„ï¼Œåªæœ‰å½“æ‰€æœ‰è¯·æ±‚çš„ CPU å’Œè®¾å¤‡éƒ½å¯ä»¥ä»ä¸€ä¸ª NUMA èŠ‚ç‚¹åˆ†é…æ—¶ï¼Œpod å‡†å…¥æ‰ä¼šé€šè¿‡ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€é€‰ç­–ç•¥å•ç‹¬åº”ç”¨äº pod è§„èŒƒä¸­çš„æ¯ä¸ªå®¹å™¨ï¼Œè€Œä¸æ˜¯å°†æ‰€æœ‰å®¹å™¨ä¸­çš„èµ„æºå¯¹é½åœ¨ä¸€èµ·ã€‚ æ­¤å¤–ï¼Œå•ä¸ªç­–ç•¥é€šè¿‡å…¨å±€ kubelet æ ‡å¿—åº”ç”¨äºèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ podï¼Œè€Œä¸æ˜¯å…è®¸ç”¨æˆ·é€ä¸ª podï¼ˆæˆ–é€ä¸ªå®¹å™¨ï¼‰é€‰æ‹©ä¸åŒçš„ç­–ç•¥ã€‚ æˆ‘ä»¬å¸Œæœ›åœ¨æœªæ¥æ”¾å®½è¿™ä¸€é™åˆ¶ã€‚ kubeletå¯ä¾›è®¾ç½®çš„ç­–ç•¥å¦‚ä¸‹ï¼š --topology-manager-policy= [none | best-effort | restricted | single-numa-node] é€šè¿‡feature gateæ¥æ§åˆ¶åŠŸèƒ½çš„å¼€å¯ï¼Œäº1.16å¼•å…¥ï¼Œè‡ª1.18å¼€å§‹é»˜è®¤å¼€å¯ï¼Œå½¢å¼å¦‚ä¸‹ï¼š --feature-gates=\"...,TopologyManager=\u003ctrue|false\u003e\" ä¸ºäº†æ ¹æ®æ‰€é€‰ç­–ç•¥è§¦å‘å¯¹é½ï¼Œç”¨æˆ·å¿…é¡»æ ¹æ®ç‰¹å®šè¦æ±‚åœ¨å…¶ pod.spec ä¸­è®¾ç½® CPU å’Œ device çš„requestå€¼ã€‚ å¯¹äºå¤–å›´è®¾å¤‡ï¼Œè¿™æ„å‘³ç€ä»è®¾å¤‡æ’ä»¶ï¼ˆä¾‹å¦‚ intel.com/sriovã€nvidia.com/gpu ç­‰ï¼‰æä¾›çš„å¯ç”¨èµ„æºä¸­è¯·æ±‚è®¾å¤‡ã€‚ è¿™ä»…åœ¨è®¾å¤‡æ’ä»¶ä¸ TopologyManager æ­£ç¡®é›†æˆæ—¶æ‰æœ‰æ•ˆã€‚ ç›®å‰ï¼Œå·²çŸ¥å…·æœ‰æ­¤æ‰©å±•çš„å”¯ä¸€æ’ä»¶æ˜¯ Nvidia GPU è®¾å¤‡æ’ä»¶å’Œè‹±ç‰¹å°” SRIOV ç½‘ç»œè®¾å¤‡æ’ä»¶ã€‚ å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æœ‰å…³å¦‚ä½•æ‰©å±•è®¾å¤‡æ’ä»¶ä»¥ä¸ TopologyManager é›†æˆçš„è¯¦ç»†ä¿¡æ¯ã€‚ å¯¹äº CPUï¼Œè¿™è¦æ±‚ CPUManager å·²é…ç½®ä¸ºå¯ç”¨äº†å…¶ â€“static ç­–ç•¥ï¼Œå¹¶ä¸” pod åœ¨ä¿è¯ QoS ç±»ä¸­è¿è¡Œï¼ˆå³æ‰€æœ‰ CPU å’Œå†…å­˜é™åˆ¶éƒ½ç­‰äºå®ƒä»¬å„è‡ªçš„ CPU å’Œå†…å­˜è¯·æ±‚ï¼‰ã€‚ è¿˜å¿…é¡»ä»¥æ•´æ•°å€¼ï¼ˆä¾‹å¦‚ 1ã€2ã€1000m ç­‰ï¼‰è¯·æ±‚ CPUã€‚ å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æœ‰å…³å¦‚ä½•è®¾ç½® CPUManager ç­–ç•¥çš„è¯¦ç»†ä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾ CPUManager åœ¨å…¶ â€“static ç­–ç•¥å¯ç”¨çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå¹¶ä¸” gpu-vendor.com å’Œ nic-vendor.com çš„è®¾å¤‡æ’ä»¶å·²æ‰©å±•ä¸ºä¸ TopologyManager æ­£ç¡®é›†æˆï¼Œåˆ™ä¸‹é¢çš„ pod è§„èŒƒè¶³ä»¥è§¦å‘ TopologyManager è¿è¡Œå…¶é€‰å®šçš„ç­–ç•¥ï¼š spec: containers: - name: numa-aligned-container image: alpine resources: limits: cpu: 2 memory: 200Mi gpu-vendor.com/gpu: 1 nic-vendor.com/nic: 1 éµå¾ªä¸Šä¸€èŠ‚ä¸­çš„å›¾ 1ï¼Œè¿™å°†å¯¼è‡´ä»¥ä¸‹å¯¹é½åˆ†é…ä¹‹ä¸€ï¼š {cpu: {0, 1}, gpu: 0, nic: 0} {cpu: {0, 2}, gpu: 0, nic: 0} {cpu: {0, 3}, gpu: 0, nic: 0} {cpu: {1, 2}, gpu: 0, nic: 0} {cpu: {1, 3}, gpu: 0, nic: 0} {cpu: {2, 3}, gpu: 0, nic: 0} {cpu: {4, 5}, gpu: 1, nic: 1} {cpu: {4, 6}, gpu: 1, nic: 1} {cpu: {4, 7}, gpu: 1, nic: 1} {cpu: {5, 6}, gpu: 1, nic: 1} {cpu: {5, 7}, gpu: 1, nic: 1} {cpu: {6, 7}, gpu: 1, nic: 1} åªéœ€éµå¾ªæ­¤æ¨¡å¼ï¼Œå³å¯è®© TopologyManager ç¡®ä¿è¯·æ±‚æ‹“æ‰‘æ„ŸçŸ¥è®¾å¤‡å’Œç‹¬å  CPU çš„å®¹å™¨ä¹‹é—´çš„ NUMA å¯¹é½ã€‚ æ³¨æ„ï¼š å¦‚æœ Pod è¢« TopologyManager ç­–ç•¥ä¹‹ä¸€æ‹’ç»ï¼Œå®ƒå°†è¢«ç½®äº Terminated çŠ¶æ€ï¼Œå¹¶å‡ºç° Pod å‡†å…¥é”™è¯¯å’Œ TopologyAffinityError çš„åŸå› ã€‚ ä¸€æ—¦ pod å¤„äºæ­¤çŠ¶æ€ï¼ŒKubernetes è°ƒåº¦ç¨‹åºå°†ä¸ä¼šå°è¯•é‡æ–°è°ƒåº¦å®ƒã€‚ å› æ­¤ï¼Œå»ºè®®ä½¿ç”¨å¸¦ replicas çš„ deployment æ¥åº”å¯¹åœ¨é‡åˆ°æ­¤ç±»æ•…éšœæ—¶è§¦å‘ pod çš„é‡æ–°éƒ¨ç½²ã€‚ è¿˜å¯ä»¥å®æ–½å¤–éƒ¨æ§åˆ¶å¾ªç¯æ¥è§¦å‘å…·æœ‰ TopologyAffinityError çš„ pod çš„é‡æ–°éƒ¨ç½²ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:4:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"å®ç°æœºåˆ¶ TopologyManager æ‰§è¡Œçš„ä¸»è¦é€»è¾‘çš„ä¼ªä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š for container := range append(InitContainers, Containers...) { for provider := range HintProviders { hints += provider.GetTopologyHints(container) } bestHint := policy.Merge(hints) for provider := range HintProviders { provider.Allocate(container, bestHint) } } ä¸‹å›¾æ€»ç»“äº†æ­¤å¾ªç¯æœŸé—´é‡‡å–çš„æ­¥éª¤ï¼š æ­¥éª¤è¯´æ˜å¦‚ä¸‹ï¼š å¾ªç¯éå† pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚ å¯¹äºæ¯ä¸ªå®¹å™¨ï¼Œä»å®¹å™¨è¯·æ±‚çš„æ¯ç§æ‹“æ‰‘æ„ŸçŸ¥èµ„æºç±»å‹ï¼ˆä¾‹å¦‚ gpu-vendor.com/gpuã€nic-vendor.com/nicã€cpu ç­‰ï¼‰çš„ä¸€ç»„ HintProviders ä¸­æ”¶é›† TopologyHintsã€‚ ä½¿ç”¨é€‰å®šçš„ç­–ç•¥ï¼Œåˆå¹¶æ”¶é›†åˆ°çš„ TopologyHints ä»¥æ‰¾åˆ°åœ¨æ‰€æœ‰èµ„æºç±»å‹ä¹‹é—´å¯¹é½èµ„æºåˆ†é…çš„æœ€ä½³æç¤ºã€‚ å†æ¬¡éå† HintProvidersï¼Œåˆ©ç”¨ä¸Šä¸€æ­¥ä¸­è¿”å›çš„æœ€ä½³æç¤ºä¸ºå®¹å™¨åˆ†é…èµ„æºã€‚ æ­¤å¾ªç¯åœ¨ pod å‡†å…¥æ—¶é—´è¿è¡Œï¼Œå¦‚æœè¿™äº›æ­¥éª¤ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥æˆ–æ ¹æ®æ‰€é€‰ç­–ç•¥æ— æ³•æ»¡è¶³å¯¹é½ï¼Œåˆ™Podæ³¨å…¥å¤±è´¥ã€‚ ç›¸åº”åœ°æ¸…é™¤ä¹‹å‰åˆ†é…çš„ä»»ä½•èµ„æºã€‚ ä»¥ä¸‹éƒ¨åˆ†æ›´è¯¦ç»†åœ°ä»‹ç»äº† TopologyHints å’Œ HintProviders çš„ç¡®åˆ‡ç»“æ„ï¼Œä»¥åŠæ¯ä¸ªç­–ç•¥ä½¿ç”¨çš„åˆå¹¶ç­–ç•¥çš„ä¸€äº›ç»†èŠ‚ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:5:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"TopologyHints TopologyHint å¯¹ä¸€ç»„çº¦æŸè¿›è¡Œç¼–ç ï¼Œä»ä¸­å¯ä»¥æ»¡è¶³ç»™å®šçš„èµ„æºè¯·æ±‚ã€‚ ç›®å‰ï¼Œæˆ‘ä»¬è€ƒè™‘çš„å”¯ä¸€çº¦æŸæ˜¯ NUMA å¯¹é½ã€‚ å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š type TopologyHint struct { NUMANodeAffinity bitmask.BitMask Preferred bool } NUMANodeAffinity å­—æ®µåŒ…å«å¯ä»¥æ»¡è¶³èµ„æºè¯·æ±‚çš„ NUMA èŠ‚ç‚¹çš„ä½æ©ç ã€‚ ä¾‹å¦‚ï¼Œå…·æœ‰ 2 ä¸ª NUMA èŠ‚ç‚¹çš„ç³»ç»Ÿä¸Šå¯èƒ½çš„æ©ç åŒ…æ‹¬ï¼š {00}, {01}, {10}, {11} Preferred å­—æ®µåŒ…å«ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨äºæŒ‡ç¤ºæŒ‡å®šçš„æç¤ºæ˜¯å¦ä¼˜å…ˆé€‰æ‹©ã€‚ ä½¿ç”¨ best-effort ç­–ç•¥ï¼Œåœ¨ç”Ÿæˆæœ€ä½³æç¤ºæ—¶ï¼ŒPreferred æç¤ºå°†ä¼˜å…ˆäºé Preferred æç¤ºã€‚ ä½¿ç”¨ restricted å’Œå• numa-node ç­–ç•¥ï¼Œé Preferred çš„æç¤ºå°†è¢«æ‹’ç»ã€‚ é€šå¸¸ï¼ŒHintProviders é€šè¿‡æŸ¥çœ‹å¯ä»¥æ»¡è¶³èµ„æºè¯·æ±‚çš„å½“å‰å¯ç”¨èµ„æºé›†æ¥ç”Ÿæˆ TopologyHintsã€‚ æ›´å…·ä½“åœ°è¯´ï¼Œå®ƒä»¬ä¸ºå¯ä»¥æ»¡è¶³èµ„æºè¯·æ±‚çš„ NUMA èŠ‚ç‚¹çš„æ¯ä¸ªå¯èƒ½æ©ç ç”Ÿæˆä¸€ä¸ª TopologyHintã€‚ å¦‚æœæ©ç ä¸èƒ½æ»¡è¶³è¯·æ±‚ï¼Œåˆ™å°†å…¶çœç•¥ã€‚ ä¾‹å¦‚ï¼Œå½“è¢«è¦æ±‚åˆ†é… 2 ä¸ªèµ„æºæ—¶ï¼ŒHintProvider å¯èƒ½ä¼šåœ¨å…·æœ‰ 2 ä¸ª NUMA èŠ‚ç‚¹çš„ç³»ç»Ÿä¸Šæä¾›ä»¥ä¸‹æç¤ºã€‚ è¿™äº›æç¤ºæ˜¾ç¤ºä¸¤ç§èµ„æºå¯ä»¥æ¥è‡ªå•ä¸ª NUMA èŠ‚ç‚¹ï¼ˆ0 æˆ– 1ï¼‰ï¼Œä¹Ÿå¯ä»¥åˆ†åˆ«æ¥è‡ªä¸åŒçš„ NUMA èŠ‚ç‚¹ï¼ˆä½†æˆ‘ä»¬æ›´å¸Œæœ›å®ƒä»¬ä»…æ¥è‡ªä¸€ä¸ªï¼‰ã€‚ {01: True}, {10: True}, {11: False} ç›®å‰ï¼Œå½“ä¸”ä»…å½“ NUMANodeAffinity ç¼–ç å¯ä»¥æ»¡è¶³èµ„æºè¯·æ±‚çš„æœ€å° NUMA èŠ‚ç‚¹é›†æ—¶ï¼Œæ‰€æœ‰ HintProvider æ‰å°† Preferred å­—æ®µè®¾ç½®ä¸º True ã€‚ é€šå¸¸ï¼Œè¿™ä»…å¯¹äºåœ¨å…¶ä½æ©ç ä¸­è®¾ç½®äº†å•ä¸ª NUMA èŠ‚ç‚¹çš„ TopologyHint ä¸º Trueã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ»¡è¶³èµ„æºè¯·æ±‚çš„å”¯ä¸€æ–¹æ³•æ˜¯è·¨è¶Šå¤šä¸ª NUMA èŠ‚ç‚¹ï¼ˆä¾‹å¦‚ï¼Œè¯·æ±‚ 2 ä¸ªè®¾å¤‡å¹¶ä¸”ç³»ç»Ÿä¸Šä»…æœ‰çš„ 2 ä¸ªè®¾å¤‡ä½äºä¸åŒçš„ NUMA èŠ‚ç‚¹ä¸Šï¼‰ï¼Œåˆ™å®ƒä¹Ÿå¯èƒ½ä¸º Trueï¼š {0011: True}, {0111: False}, {1011: False}, {1111: False} æ³¨æ„ï¼šä»¥è¿™ç§æ–¹å¼è®¾ç½® Preferred å­—æ®µä¸æ˜¯åŸºäºå½“å‰å¯ç”¨èµ„æºçš„é›†åˆã€‚ å®ƒåŸºäºåœ¨ä¸€äº›æœ€å°çš„ NUMA èŠ‚ç‚¹é›†ä¸Šç‰©ç†åˆ†é…è¯·æ±‚èµ„æºæ•°é‡çš„èƒ½åŠ›ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¦‚æœåœ¨å…¶ä»–å®¹å™¨é‡Šæ”¾å…¶èµ„æºä¹‹å‰æ— æ³•æ»¡è¶³å®é™…çš„é¦–é€‰åˆ†é…ï¼Œåˆ™ HintProvider å¯ä»¥è¿”å›æ‰€æœ‰ Preferred å­—æ®µè®¾ç½®ä¸º False çš„æç¤ºåˆ—è¡¨ã€‚ ä¾‹å¦‚ï¼Œè¯·è€ƒè™‘å›¾ 1 ä¸­ç³»ç»Ÿçš„ä»¥ä¸‹åœºæ™¯ï¼š ç›®å‰é™¤åˆ†é…ç»™å®¹å™¨çš„CPUä¹‹å¤–åªå‰©2 CPUç©ºé—² å‰©ä½™çš„ 2 CPU ä½äºä¸åŒçš„ NUMA èŠ‚ç‚¹ä¸Š ä¸€ä¸ªæ–°çš„å®¹å™¨å‡ºç°ï¼Œè¦æ±‚ 2 CPU åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå”¯ä¸€ç”Ÿæˆçš„æç¤ºå°†æ˜¯ {11: False} è€Œä¸æ˜¯ {11: True}ã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºå¯ä»¥ä»è¯¥ç³»ç»Ÿä¸Šçš„åŒä¸€ä¸ª NUMA èŠ‚ç‚¹åˆ†é… 2 ä¸ª CPUï¼ˆé‰´äºå½“å‰çš„åˆ†é…çŠ¶æ€ï¼Œç°åœ¨ä¸æ˜¯è¿™æ ·ï¼‰ã€‚ è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œå½“å¯ä»¥æ»¡è¶³æœ€å°å¯¹é½æ—¶ï¼Œæœ€å¥½è®© pod å‡†å…¥å¤±è´¥å¹¶é‡è¯•éƒ¨ç½²ï¼Œè€Œä¸æ˜¯å…è®¸ä»¥æ¬¡ä¼˜å¯¹é½æ¥è°ƒåº¦ podã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:5:1","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"HintProviders HintProvider æ˜¯ kubelet å†…éƒ¨çš„ä¸€ä¸ªç»„ä»¶ï¼Œç”¨äºåè°ƒä¸ TopologyManager å¯¹é½çš„èµ„æºåˆ†é…ã€‚ ç›®å‰ Kubernetes ä¸­å”¯ä¸€çš„ HintProvider æ˜¯ CPUManager å’Œ DeviceManagerã€‚ æˆ‘ä»¬è®¡åˆ’å¾ˆå¿«æ·»åŠ å¯¹ HugePages çš„æ”¯æŒã€‚ å¦‚å‰æ‰€è¿°ï¼ŒTopologyManager ä» HintProviders æ”¶é›† TopologyHintsï¼Œä½¿ç”¨åˆå¹¶åçš„æœ€ä½³æç¤ºè§¦å‘å¯¹é½çš„èµ„æºåˆ†é…ã€‚ å› æ­¤ï¼ŒHintProviders å®ç°äº†ä»¥ä¸‹æ¥å£ï¼š type HintProvider interface { GetTopologyHints(*v1.Pod, *v1.Container) map[string][]TopologyHint Allocate(*v1.Pod, *v1.Container) error } è¯·æ³¨æ„ï¼Œå¯¹ GetTopologyHints() çš„è°ƒç”¨è¿”å›ä¸€ä¸ª map\\[string][]TopologyHintã€‚ è¿™å…è®¸å•ä¸ª HintProvider ä¸ºå¤šç§èµ„æºç±»å‹æä¾›æç¤ºï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ç§ã€‚ ä¾‹å¦‚ï¼ŒDeviceManager éœ€è¦è¿™æ ·åšï¼Œä»¥ä¾¿ä¸ºå…¶æ’ä»¶æ³¨å†Œçš„æ¯ä¸ªèµ„æºç±»å‹ä¼ å›æç¤ºã€‚ å½“ HintProviders ç”Ÿæˆä»–ä»¬çš„æç¤ºæ—¶ï¼Œä»–ä»¬åªè€ƒè™‘å¦‚ä½•æ»¡è¶³ç³»ç»Ÿä¸Šå½“å‰å¯ç”¨èµ„æºçš„å¯¹é½ï¼Œä¸è€ƒè™‘å·²åˆ†é…ç»™å…¶ä»–å®¹å™¨çš„ä»»ä½•èµ„æºã€‚ ä¾‹å¦‚ï¼Œè€ƒè™‘å›¾ 1 ä¸­çš„ç³»ç»Ÿï¼Œå…¶ä¸­æœ‰ä»¥ä¸‹ä¸¤ä¸ªå®¹å™¨ä»ä¸­è¯·æ±‚èµ„æºï¼š å¦‚æœ Container0 æ˜¯åœ¨ç³»ç»Ÿä¸Šåˆ†é…çš„ç¬¬ä¸€ä¸ªå®¹å™¨ï¼Œåˆ™å°†ä¸ºè§„èŒƒä¸­çš„ä¸‰ç§æ‹“æ‰‘æ„ŸçŸ¥èµ„æºç±»å‹ç”Ÿæˆä»¥ä¸‹æç¤ºé›†ï¼š cpu: [{01: True}, {10: True}, {11: False}] gpu-vendor.com/gpu: [{01: True}, {10: True}] nic-vendor.com/nic: [{01: True}, {10: True}] å¯¹åº”çš„å¯¹é½ç»“æœï¼š {cpu: {0, 1}, gpu: 0, nic: 0} å½“è€ƒè™‘ Container1 æ—¶ï¼Œè¿™äº›èµ„æºè¢«å‡å®šä¸ºä¸å¯ç”¨ï¼Œå› æ­¤åªä¼šç”Ÿæˆä»¥ä¸‹æç¤ºé›†ï¼š cpu: [{01: True}, {10: True}, {11: False}] gpu-vendor.com/gpu: [{10: True}] nic-vendor.com/nic: [{10: True}] å¯¹å…¶ç»“æœå¦‚ä¸‹ï¼š {cpu: {4, 5}, gpu: 1, nic: 1} æ³¨æ„ï¼šä¸æœ¬èŠ‚å¼€å¤´æä¾›çš„ä¼ªä»£ç ä¸åŒï¼Œå¯¹ Allocate() çš„è°ƒç”¨å®é™…ä¸Šå¹¶æ²¡æœ‰ç›´æ¥é‡‡ç”¨ä¸€ä¸ªåˆå¹¶åçš„æœ€ä½³æç¤ºçš„å‚æ•°ã€‚ ç›¸åï¼ŒTopologyManager å®ç°äº†ä»¥ä¸‹ Store æ¥å£ï¼ŒHintProviders å¯ä»¥æŸ¥è¯¢è¯¥æ¥å£ä»¥æ£€ç´¢ä¸ºç‰¹å®šå®¹å™¨ç”Ÿæˆçš„æç¤ºï¼š type Store interface { GetAffinity(podUID string, containerName string) TopologyHint } å°†å…¶åˆ†ç¦»åˆ°å…¶è‡ªå·±çš„ API è°ƒç”¨ä¸­ï¼Œå…è®¸äººä»¬åœ¨ pod å‡†å…¥å¾ªç¯ä¹‹å¤–è®¿é—®æ­¤æç¤ºã€‚ è¿™å¯¹äºè°ƒè¯•ä»¥åŠé€šè¿‡ kubectl ç­‰å·¥å…·è·å–ç”Ÿæˆçš„æç¤ºå¾ˆæœ‰ç”¨ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:5:2","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Policy.Merge ç”±ç»™å®šç­–ç•¥å®šä¹‰çš„åˆå¹¶ç­–ç•¥å†³å®šäº†å®ƒå¦‚ä½•å°†æ‰€æœ‰ HintProvider ç”Ÿæˆçš„ä¸€ç»„ TopologyHint ç»„åˆæˆå•ä¸ª TopologyHintã€‚ æ‰€æœ‰å—æ”¯æŒç­–ç•¥çš„åˆå¹¶ç­–ç•¥éƒ½ä»¥ç›¸åŒçš„æ–¹å¼å¼€å§‹ï¼š å–ä¸ºæ¯ç§èµ„æºç±»å‹ç”Ÿæˆçš„ TopologyHints çš„å‰ç§¯ å¯¹äºå‰ç§¯ä¸­çš„æ¯ä¸ªæ¡ç›®ï¼Œå°†æ¯ä¸ª TopologyHint çš„ NUMA Affinityè¿›è¡ŒæŒ‰ä½ä¸è®¡ç®—ï¼Œå¹¶å°†ç»“æœè®¾ç½®ä¸ºåˆ°åˆå¹¶æç¤ºçš„ NUMA Affinityã€‚ å¦‚æœæ¡ç›®ä¸­çš„æ‰€æœ‰æç¤ºéƒ½å°† Preferred è®¾ç½®ä¸º True ï¼Œåˆ™åœ¨ç”Ÿæˆçš„åˆå¹¶æç¤ºä¸­å°† Preferred è®¾ç½®ä¸º Trueã€‚ å¦‚æœå³ä½¿æ¡ç›®ä¸­çš„ä¸€ä¸ªæç¤ºå·²å°† Preferred è®¾ç½®ä¸º False ï¼Œç”Ÿæˆçš„åˆå¹¶æç¤ºä¸­ Preferredä¸º False ã€‚ å¦‚æœå…¶ NUMA Affinity åŒ…å«å…¨ 0ï¼Œåˆ™åˆå¹¶æç¤ºä¸­ Preferred ä¹Ÿä¸º Falseã€‚ æŒ‰ç…§ä¸Šä¸€èŠ‚çš„ç¤ºä¾‹ï¼ŒContainer0 ç”Ÿæˆçš„æç¤ºä¸ºï¼š cpu: [{01: True}, {10: True}, {11: False}]F gpu-vendor.com/gpu: [{01: True}, {10: True}] nic-vendor.com/nic: [{01: True}, {10: True}] ä¸Šè¿°ç®—æ³•äº§ç”Ÿä»¥ä¸‹å‰ç§¯å’Œåˆå¹¶åçš„æç¤ºï¼š {cpu, gpu-vendor.com/gpu, nic-vendor.com/nic} â€œmergedâ€ hint [{01: True}, {01: True}, {01: True}] {01: True} [{01: True}, {01: True}, {10: True}] {00: False} [{01: True}, {10: True}, {01: True}] {00: False} [{01: True}, {10: True}, {10: True}] {00: False} [{10: True}, {01: True}, {01: True}] {00: False} [{10: True}, {01: True}, {10: True}] {00: False} [{10: True}, {10: True}, {01: True}] {00: False} [{10: True}, {10: True}, {10: True}] {01: True} [{11: False}, {01: True}, {01: True}] {01: False} [{11: False}, {01: True}, {10: True}] {00: False} [{11: False}, {10: True}, {01: True}] {00: False} [{11: False}, {10: True}, {10: True}] {10: False} ä¸€æ—¦åˆå¹¶æç¤ºåˆ—è¡¨ç”Ÿæˆï¼Œå‰©ä¸‹çš„å·¥ä½œå°±ç”±ç‰¹å®šçš„ TopologyManager ç­–ç•¥æ¥å†³å®šå°†å“ªä¸ªæç¤ºè§†ä¸ºæœ€ä½³æç¤ºã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œè¿™åŒ…æ‹¬ï¼š æŒ‰â€œç‹­çª„ç¨‹åº¦â€å¯¹åˆå¹¶çš„æç¤ºè¿›è¡Œæ’åºã€‚ çª„åº¦å®šä¹‰ä¸ºåœ¨æç¤ºçš„ NUMA Affinity æ©ç ä¸­è®¾ç½®çš„ä½æ•°ã€‚ è®¾ç½®çš„ä½è¶Šå°‘ï¼Œæç¤ºè¶Šçª„ã€‚ å¯¹äºåœ¨å…¶ NUMA Affinity æ©ç ä¸­è®¾ç½®ç›¸åŒä½æ•°çš„æç¤ºï¼Œå…·æœ‰æœ€ä½ä½è®¾ç½®çš„æç¤ºè¢«è®¤ä¸ºæ›´çª„ã€‚ æŒ‰ Preferred å­—æ®µå¯¹åˆå¹¶çš„æç¤ºè¿›è¡Œæ’åºã€‚ ä¸å°† Preferred è®¾ç½®ä¸º False çš„æç¤ºç›¸æ¯”ï¼Œå°† Preferred è®¾ç½®ä¸º True çš„æç¤ºæ›´å¯èƒ½è¢«è§†ä¸ºå€™é€‰å¯¹è±¡ã€‚ é€‰æ‹©å…·æœ‰æœ€ä½³è®¾ç½®çš„æœ€çª„æç¤ºã€‚ åœ¨ best-effort ç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œæ­¤ç®—æ³•å°†å§‹ç»ˆå¯¼è‡´æŸäº›æç¤ºè¢«é€‰ä¸ºæœ€ä½³æç¤ºï¼Œæœ€ç»ˆPodå‡†å…¥é€šè¿‡ã€‚ HintProviders æ ¹æ®è¿™ä¸ªæœ€ä½³æç¤ºè¿›è¡Œèµ„æºåˆ†é…ã€‚ ä½†æ˜¯ï¼Œåœ¨ restricted å’Œ single-numa-node ç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œä»»ä½•é€‰æ‹©çš„ Preferred è®¾ç½®ä¸ºFalse çš„æç¤ºå°†è¢«ç«‹å³æ‹’ç»ï¼Œå¯¼è‡´pod å‡†å…¥å¤±è´¥å¹¶ä¸”æ— æ³•èµ„æºåˆ†é…ã€‚ æ­¤å¤– single-numa-node è¿˜å°†æ‹’ç»åœ¨å…¶ Affinity æ©ç ä¸­è®¾ç½®äº†å¤šä¸ª NUMA èŠ‚ç‚¹çš„æç¤ºã€‚ åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæ‰€æœ‰ç­–ç•¥éƒ½ä¼šä½¿ç”¨ {01: True} æç¤ºï¼ŒPodå‡†å…¥æˆåŠŸã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:5:3","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Upcoming enhancements è™½ç„¶ 1.18 ç‰ˆæœ¬å’Œ Beta ç‰ˆå‡çº§å¸¦æ¥äº†ä¸€äº›é‡è¦çš„å¢å¼ºå’Œä¿®å¤ï¼Œä½†ä»ç„¶å­˜åœ¨è®¸å¤šé™åˆ¶ï¼Œå¦‚ä¸‹æ‰€è¿°ã€‚ æˆ‘ä»¬å·²ç»åœ¨åŠªåŠ›è§£å†³è¿™äº›é™åˆ¶ä»¥åŠæ›´å¤šé—®é¢˜ã€‚ æœ¬èŠ‚å°†ä»‹ç»æˆ‘ä»¬è®¡åˆ’åœ¨ä¸ä¹…çš„å°†æ¥ä¸º TopologyManager å®æ–½çš„ä¸€ç»„å¢å¼ºåŠŸèƒ½ã€‚ è¿™ä¸ªåˆ—è¡¨å¹¶ä¸è¯¦å°½ï¼Œä½†å®ƒå¾ˆå¥½åœ°è¯´æ˜äº†æˆ‘ä»¬å‰è¿›çš„æ–¹å‘ã€‚å®ƒæŒ‰ç…§æˆ‘ä»¬æœŸæœ›çœ‹åˆ°æ¯ä¸ªå¢å¼ºå®Œæˆçš„æ—¶é—´èŒƒå›´è¿›è¡Œæ’åºã€‚ å¦‚æœæ‚¨æƒ³å‚ä¸å…¶ä¸­çš„ä»»ä½•å¢å¼ºåŠŸèƒ½ï¼Œè¯·å‚åŠ æ¯å‘¨ä¸€æ¬¡çš„ Kubernetes SIG-node ä¼šè®®ä»¥äº†è§£æ›´å¤šä¿¡æ¯å¹¶æˆä¸ºç¤¾åŒºå·¥ä½œçš„ä¸€éƒ¨åˆ†ï¼ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:6:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Supporting device-specific constraints ç›®å‰ï¼ŒNUMA äº²å’Œæ€§æ˜¯ TopologyManager ä¸ºèµ„æºå¯¹é½è€ƒè™‘çš„å”¯ä¸€çº¦æŸã€‚ æ­¤å¤–ï¼Œå¯ä»¥å¯¹ TopologyHint è¿›è¡Œçš„å”¯ä¸€æ‰©å±•æ¶‰åŠ node-level çº¦æŸï¼Œä¾‹å¦‚è·¨è®¾å¤‡ç±»å‹çš„ PCIe æ€»çº¿å¯¹é½ã€‚ å°è¯•å‘è¯¥ç»“æ„æ·»åŠ ä»»ä½•ç‰¹å®šäºè®¾å¤‡çš„çº¦æŸï¼ˆä¾‹å¦‚ï¼Œä¸€ç»„ GPU è®¾å¤‡ä¹‹é—´çš„å†…éƒ¨ NVLINK æ‹“æ‰‘ï¼‰å°†æ˜¯æ£˜æ‰‹çš„ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®å¯¹è®¾å¤‡æ’ä»¶æ¥å£è¿›è¡Œæ‰©å±•ï¼Œå…è®¸æ’ä»¶å£°æ˜å…¶æ‹“æ‰‘æ„ŸçŸ¥åˆ†é…é¦–é€‰é¡¹ï¼Œè€Œæ— éœ€å‘ kubelet å…¬å¼€ä»»ä½•ç‰¹å®šäºè®¾å¤‡çš„æ‹“æ‰‘ä¿¡æ¯ã€‚ é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒTopologyManager å¯ä»¥è¢«é™åˆ¶ä¸ºä»…å¤„ç†å¸¸è§çš„èŠ‚ç‚¹çº§æ‹“æ‰‘çº¦æŸï¼ŒåŒæ—¶ä»ç„¶å¯ä»¥å°†ç‰¹å®šäºè®¾å¤‡çš„æ‹“æ‰‘çº¦æŸåˆå¹¶åˆ°å…¶åˆ†é…å†³ç­–ä¸­ã€‚ å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°æ­¤ææ¡ˆçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”å°†å¾ˆå¿«åœ¨ Kubernetes 1.19 ä¸­æä¾›ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:6:1","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"NUMA alignment for hugepages å¦‚å‰æ‰€è¿°ï¼ŒTopologyManager å½“å‰ä»…æœ‰çš„ä¸¤ä¸ª HintProvider : CPUManager å’Œ DeviceManagerã€‚ ä½†æ˜¯ï¼Œç›®å‰æ­£åœ¨å¢åŠ å·¨é¡µçš„æ”¯æŒã€‚ éšç€è¿™é¡¹å·¥ä½œçš„å®Œæˆï¼ŒTopologyManager æœ€ç»ˆå°†èƒ½å¤Ÿåœ¨åŒä¸€ä¸ª NUMA èŠ‚ç‚¹ä¸Šåˆ†é…å†…å­˜ã€hugepagesã€CPU å’Œ PCI è®¾å¤‡ã€‚ è¿™é¡¹å·¥ä½œçš„ KEP ç›®å‰æ­£åœ¨å®¡æŸ¥ä¸­ï¼Œå¹¶ä¸”æ­£åœ¨åˆ¶ä½œåŸå‹ä»¥å°½å¿«å®ç°æ­¤åŠŸèƒ½ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:6:2","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Scheduler awareness ç›®å‰ï¼ŒTopologyManager å……å½“ Pod å‡†å…¥æ§åˆ¶å™¨ï¼Œå®ƒä¸ç›´æ¥å‚ä¸ pod çš„è°ƒåº¦å†³ç­–ã€‚ç›¸åï¼Œå½“ kubernetes è°ƒåº¦ç¨‹åºï¼ˆæˆ–åœ¨éƒ¨ç½²ä¸­è¿è¡Œçš„ä»»ä½•è°ƒåº¦ç¨‹åºï¼‰å°† pod æ”¾ç½®åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œæ—¶ï¼ŒTopologyManager å°†å†³å®šæ˜¯â€œæ¥çº³â€è¿˜æ˜¯â€œæ‹’ç»â€è¯¥ podã€‚å¦‚æœ Pod ç”±äºç¼ºä¹å¯ç”¨çš„ NUMA å¯¹é½èµ„æºè€Œè¢«æ‹’ç»ï¼Œäº‹æƒ…ä¼šå˜å¾—æœ‰ç‚¹æœ‰è¶£ã€‚è¿™ä¸ª kubernetes issue å¾ˆå¥½åœ°çªå‡ºå¹¶è®¨è®ºäº†è¿™ç§æƒ…å†µã€‚ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ç€æ‰‹è§£å†³è¿™ä¸ªé™åˆ¶å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Kubernetes è°ƒåº¦æ¡†æ¶æ¥å®ç°ï¼è¯¥æ¡†æ¶æä¾›äº†ä¸€ç»„æ–°çš„æ’ä»¶ APIï¼Œè¿™äº› API ä¸ç°æœ‰çš„ Kubernetes è°ƒåº¦ç¨‹åºé›†æˆï¼Œå¹¶å…è®¸å®ç°è°ƒåº¦åŠŸèƒ½ï¼Œä¾‹å¦‚ NUMA å¯¹é½ã€‚ å¦‚ä½•å®ç°è¿™äº›æ‰©å±•ä¸ TopologyManager é›†æˆçš„ç»†èŠ‚å°šæœªåˆ¶å®šã€‚æˆ‘ä»¬ä»ç„¶éœ€è¦å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š æˆ‘ä»¬æ˜¯å¦éœ€è¦é‡å¤çš„é€»è¾‘åœ¨ TopologyManager å’Œè°ƒåº¦ç¨‹åºä¸­å†³å®šè®¾å¤‡çš„äº²å’Œæ€§ï¼Ÿ æˆ‘ä»¬æ˜¯å¦éœ€è¦ä¸€ä¸ªæ–°çš„ API æ¥ä» TopologyManager è·å– TopologyHints åˆ°è°ƒåº¦ç¨‹åºæ’ä»¶ï¼Ÿ æ­¤åŠŸèƒ½çš„å·¥ä½œåº”åœ¨æ¥ä¸‹æ¥çš„å‡ ä¸ªæœˆå†…å¼€å§‹ï¼Œæ•¬è¯·æœŸå¾…ï¼ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:6:3","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Per-pod alignment policy å¦‚å‰æ‰€è¿°ï¼Œå•ä¸ªç­–ç•¥é€šè¿‡å…¨å±€ kubelet æ ‡å¿—åº”ç”¨äºèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ podï¼Œè€Œä¸æ˜¯å…è®¸ç”¨æˆ·é€ä¸ª podï¼ˆæˆ–é€ä¸ªå®¹å™¨ï¼‰é€‰æ‹©ä¸åŒçš„ç­–ç•¥ã€‚ è™½ç„¶æˆ‘ä»¬åŒæ„è¿™å°†æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åŠŸèƒ½ï¼Œä½†åœ¨å®ç°ä¹‹å‰è¿˜æœ‰å¾ˆå¤šéšœç¢éœ€è¦å…‹æœã€‚ æœ€å¤§çš„éšœç¢æ˜¯æ­¤å¢å¼ºåŠŸèƒ½éœ€è¦æ›´æ”¹ API æ‰èƒ½åœ¨ Pod spce æˆ–å…¶å…³è”çš„ RuntimeClass ä¸­è¡¨è¾¾æ‰€éœ€çš„å¯¹é½ç­–ç•¥ã€‚ æˆ‘ä»¬ç°åœ¨æ‰å¼€å§‹è®¤çœŸè®¨è®ºè¿™ä¸ªåŠŸèƒ½ï¼Œå®ƒç¦»å¯ç”¨è¿˜æœ‰å‡ ä¸ªç‰ˆæœ¬ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:6:4","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["åŸç†ä»‹ç»"],"content":"Conclusion éšç€ TopologyManager åœ¨ 1.18 ä¸­å‡çº§ä¸º Betaï¼Œæˆ‘ä»¬é¼“åŠ±å¤§å®¶å°è¯•å¹¶æœŸå¾…æ‚¨çš„ä»»ä½•åé¦ˆã€‚ åœ¨è¿‡å»çš„å‡ ä¸ªç‰ˆæœ¬ä¸­è¿›è¡Œäº†è®¸å¤šä¿®å¤å’Œå¢å¼ºï¼Œå¤§å¤§æé«˜äº† TopologyManager åŠå…¶ HintProviders çš„åŠŸèƒ½å’Œå¯é æ€§ã€‚ è™½ç„¶ä»ç„¶å­˜åœ¨è®¸å¤šé™åˆ¶ï¼Œä½†æˆ‘ä»¬è®¡åˆ’è¿›è¡Œä¸€ç³»åˆ—å¢å¼ºæ¥è§£å†³è¿™äº›é—®é¢˜ï¼Œå¹¶æœŸå¾…åœ¨å³å°†å‘å¸ƒçš„ç‰ˆæœ¬ä¸­ä¸ºæ‚¨æä¾›è®¸å¤šæ–°åŠŸèƒ½ã€‚ å¦‚æœæ‚¨æœ‰å…¶ä»–å¢å¼ºåŠŸèƒ½çš„æƒ³æ³•æˆ–å¯¹æŸäº›åŠŸèƒ½çš„æ¸´æœ›ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ä»¬ã€‚ å›¢é˜Ÿå§‹ç»ˆå¯¹å¢å¼ºå’Œæ”¹è¿› TopologyManager çš„å»ºè®®æŒå¼€æ”¾æ€åº¦ã€‚ ","date":"2021-06-18","objectID":"https://www.likakuli.com/posts/kubernetes-topology-manager/:7:0","tags":["kubernetes"],"title":"Kubenetes NUMAæ‹“æ‰‘æ„ŸçŸ¥åŠŸèƒ½ä»‹ç»","uri":"https://www.likakuli.com/posts/kubernetes-topology-manager/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"ä»äº‹Kubernetesç›¸å…³å·¥ä½œçš„åŒå­¦å¯¹Kube-schedulerä¸€å®šä¸ä¼šæ„Ÿåˆ°é™Œç”Ÿï¼Œæœ‰çš„ç”šè‡³è¿˜å¯èƒ½é‡åˆ°è¿‡é‡Œé¢çš„ä¸€äº›é—®é¢˜ï¼Œæœ¬ç¯‡ä¸»è¦ä»‹ç»å…¶ä¸­çš„ä¸€ä¸ªä¼˜é€‰ç­–ç•¥ï¼šInterPodAffinityçš„æ€§èƒ½ä¼˜åŒ–è¿‡ç¨‹ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°ä¸€äº›è¿˜åœ¨æ·±å—å…¶å›°æ‰°çš„æœ‹å‹ä»¬ï¼Œæ²¡æœ‰ä½¿ç”¨è¿‡æ­¤ç­–ç•¥æˆ–è€…æ²¡æœ‰ä½¿ç”¨è¿‡Kubernetesä¹Ÿä¸è¦ç´§ï¼Œå…¶æœ¬è´¨è¿˜æ˜¯åœ¨ä»¥æŸç§ç®—æ³•å»è§£å†³æŸç§é—®é¢˜ï¼Œä¸‹é¢æˆ‘ä¼šå°½é‡ä»¥é€šä¿—æ˜“æ‡‚çš„è¯æ¥è§£é‡Šéœ€è¦è§£å†³çš„é—®é¢˜åŠç®—æ³•ä¼˜åŒ–è¿‡ç¨‹ã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:0:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"ç­–ç•¥ä»‹ç» InterPodAffinityä½œä¸ºä¼˜é€‰ç­–ç•¥å°±æ˜¯åœ¨é¢„é€‰é€šè¿‡åçš„ä¸€å †å®¿ä¸»ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€åˆé€‚çš„å®¿ä¸»ï¼Œå¯»æ‰¾è§„åˆ™ä¸ºæŒ‰æ‹“æ‰‘æŠŠå®¿ä¸»åˆ†ç±»ï¼Œé’ˆå¯¹æ‹“æ‰‘çº§åˆ«ï¼Œå¦‚æœå‡ºç°ç¬¦åˆPodè¦æ±‚çš„å…¶ä»–Podï¼Œåˆ™ä¸ºæ­¤æ‹“æ‰‘ä¸‹çš„æ‰€æœ‰Nodeè®¡ç®—ä¸€ä¸ªå¾—åˆ†ï¼ŒPodçš„è¦æ±‚å¯ä»¥æœ‰å¤šæ¡ï¼Œæ¯ä¸€æ¡éƒ½æœ‰ä¸€ä¸ªæƒé‡ï¼ˆç”¨æ¥è®¡ç®—å¾—åˆ†ï¼‰ï¼ŒåŒæ—¶å¾—åˆ†ä¹Ÿåˆ†æ­£è´Ÿï¼Œä¾‹å¦‚PodæœŸæœ›æ‹“æ‰‘ä¸‹æ²¡æœ‰åŒç±»å‹çš„Podï¼Œå¦‚æœæœ‰åˆ™å¾—åˆ†ä¸ºè´Ÿã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸‹ç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥åšä¸ªç±»æ¯”å¸®åŠ©ç†è§£è¦è§£å†³çš„é—®é¢˜ï¼Œå†å¼•å‡ºå¯¹åº”çš„ç®—æ³•ã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:1:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"ä¸¾ä¸ªğŸŒ° å¼ ä¸‰ï¼ˆPodï¼‰å¤§å­¦åˆšæ¯•ä¸šå‚åŠ å·¥ä½œï¼Œéœ€è¦ç§Ÿæˆ¿ï¼ˆNodeï¼‰ï¼Œäºæ˜¯æ‰¾äº†ä¸­ä»‹å…¬å¸ï¼ˆKube-schedulerï¼‰ï¼Œå¼ ä¸‰æå‡ºäº†ä¸€äº›æ¡ä»¶ï¼Œæ¯”å¦‚æˆ¿ç§Ÿä¸èƒ½é«˜äº2000ä¸€ä¸ªæœˆï¼Œä¸Šç­è€—æ—¶ä¸è¶…è¿‡1å°æ—¶ç­‰ï¼Œä¸­ä»‹å…¬å¸æ ¹æ®å¼ ä¸‰çš„éœ€è¦ç­›é€‰å‡ºæ¥ä¸€æ‰¹æˆ¿å­ï¼Œå¼ ä¸‰çœ‹åè§‰å¾—éƒ½ä¸é”™ï¼Œä½†åªèƒ½ç§Ÿä¸€ä¸ªï¼Œäºæ˜¯åˆåˆ—å‡ºäº†ä¸€äº›å…¶ä»–éå¿…é¡»çš„åŠ åˆ†å‡åˆ†é¡¹ï¼Œæ¯”å¦‚æˆ¿å­æ‰€åœ¨å°åŒºå¦‚æœæœ‰äººæ˜¯æ˜æ˜Ÿçš„è¯ï¼ŒåŠ 8åˆ†ï¼Œå¦‚æœæˆ¿å­æ‰€åœ¨è¡—é“æœ‰æ–°å† è‚ºç‚æ‚£è€…ï¼Œåˆ™å‡10åˆ†ç­‰æ¡ä»¶ï¼Œä¸­ä»‹å…¬å¸éœ€è¦æ ¹æ®è¿™äº›æ¡ä»¶ç­›é€‰å‡ºæ¥æœ€é€‚åˆå¼ ä¸‰çš„ä¸€å¥—æˆ¿å­ã€‚ ä¸Šé¢æåˆ°çš„æ— è®ºæ˜¯å°åŒºè¿˜æ˜¯è¡—é“éƒ½æ˜¯ä¸€ç§æ‹“æ‰‘ï¼Œéƒ½å¯ä»¥çœ‹åšæ˜¯æˆ¿å­çš„ä¸€ä¸ªå±æ€§å¹¶ä¸”æœ‰å¯¹åº”çš„å€¼ï¼Œä¾‹å¦‚å°åŒºï¼šæ°¸æ³°ä¸œé‡Œï¼Œè¡—é“ï¼šè¥¿ä¸‰æ——è¡—é“ã€‚è¿™äº›é™„åŠ çš„åŠ å‡åˆ†é¡¹æ˜¯åŸºäºæ‹“æ‰‘çš„ï¼Œå…·æœ‰ç›¸åŒæ‹“æ‰‘çš„æˆ¿å­å†…åªè¦å‡ºç°ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„äººï¼Œåˆ™æ•´ä¸ªæ‹“æ‰‘å†…çš„æˆ¿å­éƒ½ä¼šå—åˆ°å½±å“ã€‚ä¾‹å¦‚å°åŒºå†…æœ‰ä¸€ä¸ªæ˜æ˜Ÿï¼Œåˆ™æ•´ä¸ªå°åŒºç¬¦åˆæ¡ä»¶çš„æˆ¿å­éƒ½ä¼šåŠ 8åˆ†ã€‚è‹¥è¡—é“æœ‰ä¸€ä¸ªæ–°å† æ‚£è€…ï¼Œåˆ™æ•´ä¸ªè¡—é“æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æˆ¿å­éƒ½ä¼šå‡10åˆ†ã€‚ åŒ–ç®€ä¸€ä¸‹ä¸ºæœ‰Mä¸ªç¬¦åˆæ¡ä»¶çš„æˆ¿æºï¼Œæ¯ä¸ªæˆ¿æºé‡Œé¢ä½Nä¸ªäººï¼ˆNå¯ä»¥ä¸åŒï¼‰ï¼Œæœ‰Xä¸ªåŠ åˆ†å‡åˆ†é¡¹ï¼Œæ±‚å¾—åˆ†æœ€é«˜çš„ä¸€ä¸ªæˆ¿æºã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:2:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"åˆä»£ ~1.15.4 InterPodAffinityé‡‡ç”¨çš„ç®—æ³•æ¯”è¾ƒç®€å•æš´åŠ›ï¼Œä¼ªä»£ç å¤§è‡´å¦‚ä¸‹ for iæˆ¿æº in æ‰€æœ‰æˆ¿æº for jç§Ÿå®¢ in iæˆ¿æº for ké¡¹ in åŠ å‡åˆ†é¡¹ if jç§Ÿå®¢ æ»¡è¶³ ké¡¹ for læˆ¿æº in æ‰€æœ‰æˆ¿æº if æ‹“æ‰‘ç›¸ç­‰(læˆ¿æº, iæˆ¿æº) lock() map[l] += ké¡¹åˆ†æ•° unlock() æ•´ä½“ä¸Šæ˜¯ä¸€ä¸ªå››å±‚çš„å¾ªç¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºM * N * X * Mï¼Œå·¥ç¨‹ä¸­å®ç°çš„æ—¶å€™é‡‡ç”¨å¤šä¸ªgoroutineè¿›è¡Œè®¡ç®—ï¼Œå…¨å±€ç»´æŠ¤ä¸€ä¸ªmapï¼Œkeyä¸ºåå­—ï¼Œå€¼ä¸ºå¾—åˆ†ï¼Œå› æ­¤åœ¨æ¯æ¬¡æ›´æ–°mapçš„æ—¶å€™éƒ½å…ˆåŠ é”ï¼Œæ›´æ–°å®Œä¹‹åå†é‡Šæ”¾é”ã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:3:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"äºŒä»£ 1.15.5 ~ 1.16.* æ—¶é—´å¤æ‚åº¦ä¸Šæ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ¬¡åšçš„æ”¹è¿›å›´ç»•é”æ¥è¿›è¡Œã€‚ä½¿ç”¨åˆ‡ç‰‡å–ä»£å­—å…¸ï¼Œåˆ‡ç‰‡é•¿åº¦ç­‰äºæˆ¿æºæ•°é‡ï¼Œåˆ©ç”¨ä¸‹æ ‡ä¸€ä¸€å¯¹åº”ã€‚æ”¹è¿›åå¦‚ä¸‹ for iæˆ¿æº in æ‰€æœ‰æˆ¿æº for jç§Ÿå®¢ in iæˆ¿æº for ké¡¹ in åŠ å‡åˆ†é¡¹ if jç§Ÿå®¢ æ»¡è¶³ ké¡¹ for iæˆ¿æº in æ‰€æœ‰æˆ¿æº if æ‹“æ‰‘ç›¸ç­‰(læˆ¿æº, iæˆ¿æº) slice[i] = atomic add(slice[i], ké¡¹åˆ†æ•°) ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:4:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"ä¸‰ä»£ 1.17.0 ~ 1.18.* æ—¶é—´å¤æ‚åº¦å‘ç”Ÿå˜åŒ–ï¼Œä»M * N * X * M å˜ä¸º M * N * Xã€‚é€šè¿‡ä¸€ä¸ªmap[æ‹“æ‰‘key]map[æ‹“æ‰‘value]å¾—åˆ†çš„ç»“æ„å–ä»£äº†æœ€é‡Œå±‚çš„å¾ªç¯ï¼Œåœ¨æ•´ä¸ªå¤§å¾ªç¯ç»“æŸåï¼Œæœ€åå†é¢å¤–è¿›è¡Œä¸€æ¬¡å¾ªç¯å°±å¯ä»¥äº†ã€‚ for iæˆ¿æº in æ‰€æœ‰æˆ¿æº for jç§Ÿå®¢ in iæˆ¿æº for ké¡¹ in åŠ å‡åˆ†é¡¹ if jç§Ÿå®¢ æ»¡è¶³ ké¡¹ lock map[æ‹“æ‰‘key]map[iæˆ¿æºæ‹“æ‰‘value] += ké¡¹åˆ†æ•° unlock for iæˆ¿æº in æ‰€æœ‰æˆ¿æº score[iæˆ¿æº] += map[æ‹“æ‰‘key][æ‹“æ‰‘value] æœ¬æ¬¡è™½ç„¶æ—¶é—´å¤æ‚åº¦é™ä½äº†ä¸€ä¸ªæ•°é‡çº§ï¼Œä½†æ˜¯åˆå¼•å…¥äº†é”ï¼Œç±»ä¼¼ä¸€ä»£çš„å®ç°ï¼Œåœ¨å…¨å±€æœ‰ä¸ªmapç”¨æ¥å­˜æ”¾æ‰€æœ‰æ‹“æ‰‘å¯¹åº”çš„åˆ†æ•°ï¼Œä¸ºé˜²æ­¢å¤šä¸ªgoroutineå¹¶è¡Œè®¿é—®mapå‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥åŠ äº†é”ã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:5:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"å››ä»£ 1.19.0~ æœ¬æ¬¡çš„æ”¹è¿›ä¸»è¦æ˜¯å»æ‰äº†é”ï¼Œåœ¨æ—¶é—´å¤æ‚ä¸Šæ²¡æœ‰å˜åŒ–ã€‚åŒæ ·é‡‡ç”¨äº†å…¨å±€mapï¼Œä½†æ˜¯åœ¨è¿›è¡Œæ‹“æ‰‘åˆ†æ•°è®¡ç®—æ—¶å¹¶æ²¡æœ‰ä¼ å…¥å…¨å±€çš„mapï¼Œè€Œæ˜¯æ¯ä¸ªæˆ¿æºå¯¹åº”ä¸€ä¸ªmapï¼Œæš‚ä¸”ç§°ä¸ºsub_mapã€‚ä»£ç ä¸­ç»´æŠ¤äº†ä¸€ä¸ªsub_mapsçš„åˆ‡ç‰‡ï¼Œç”±äºsub_mapå„ç”¨å„çš„ä¸å­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œä¸”æŠŠsub_mapæ·»åŠ åˆ°sub_mapsä¸­æ—¶å¯ä»¥é€šè¿‡åŸå­æ“ä½œå®ç°ï¼Œåœ¨å¹¶å‘è®¡ç®—å®Œæ‰€æœ‰æˆ¿æºçš„æ‹“æ‰‘çš„åˆ†åï¼Œå†ç»Ÿä¸€æŠŠæ‰€æœ‰çš„å­mapè¿›è¡Œå¤„ç†ï¼Œåˆ†æ•°ç»Ÿä¸€è®¾ç½®åˆ°å…¨å±€çš„mapä¸­ï¼Œå‰©ä¸‹çš„å¤„ç†é€»è¾‘å°±å’Œä¸‰ä»£æœ€åçš„å¤„ç†é€»è¾‘ä¸€æ ·äº†ã€‚ index := -1 for iæˆ¿æº in æ‰€æœ‰æˆ¿æº for jç§Ÿå®¢ in iæˆ¿æº for ké¡¹ in åŠ å‡åˆ†é¡¹ if jç§Ÿå®¢ æ»¡è¶³ ké¡¹ sub_maps[atomic add(index, 1)][æ‹“æ‰‘key]map[iæˆ¿æºæ‹“æ‰‘value] += ké¡¹åˆ†æ•° for sub_map in sub_maps map[æ‹“æ‰‘key][æ‹“æ‰‘value] + sub_map[æ‹“æ‰‘key][æ‹“æ‰‘value] for iæˆ¿æº in æ‰€æœ‰æˆ¿æº score[iæˆ¿æº] += map[æ‹“æ‰‘key][æ‹“æ‰‘value] ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:6:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["æ€§èƒ½ä¼˜åŒ–"],"content":"æ€»ç»“ å·¥ç¨‹ä¸åŒäºçº¯ç®—æ³•å®ç°ï¼Œä¸ä»…éœ€è¦åœ¨ç®—æ³•ç»´åº¦é™ä½æ—¶é—´å¤æ‚åº¦ï¼Œä¹Ÿè¦è€ƒè™‘å…·ä½“å·¥ç¨‹ä¸Šçš„å®ç°ï¼Œæ¯”å¦‚è¿™ä¸ªä¾‹å­ä¸­åœ¨æ¶‰åŠåˆ°å¹¶è¡Œè®¡ç®—æ—¶å¦‚ä½•ç”¨åŸå­æ“ä½œæ›¿æ¢æ‰é”ã€‚æƒ³è¦çŸ¥é“å“ªé‡Œæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œå¯ä»¥ä½¿ç”¨perfå…·ä½“åˆ†æï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…·ä½“è¯­è¨€å¯¹åº”çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œç®—æ³•ä¼˜åŒ–å’Œå·¥ç¨‹ä¼˜åŒ–åŒæ ·é‡è¦ï¼Œç®—æ³•ç»ˆå½’è¿˜æ˜¯ä¸ºå·¥ç¨‹æœåŠ¡çš„ã€‚ ","date":"2021-06-08","objectID":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/:7:0","tags":["æ€§èƒ½ä¼˜åŒ–","kubernetes"],"title":"Kube-scheduler InterPodAffinityæ€§èƒ½ä¼˜åŒ–å²","uri":"https://www.likakuli.com/posts/kubernetes-interpodaffinity/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æè¿° å¼€å¯ç‰¹æƒæ¨¡å¼ï¼ˆ--privilegedï¼‰çš„å®¹å™¨ï¼Œåœ¨ä½¿ç”¨nvidia GPUæ—¶ï¼Œæ— æ³•é€šè¿‡cAdvisorè·å–GPUç›¸å…³çš„metricsä¿¡æ¯ã€‚Googleå¤§æ³•å¯ä»¥æœåˆ°ç›¸å…³çš„Issueï¼Œäº2018å¹´æå‡ºï¼Œè‡³ä»Šä»å¤„äºOpençŠ¶æ€ï¼ˆç»™cAdvisorè´¡çŒ®ä»£ç çš„æœºä¼šï¼‰ï¼Œç”±äºæ¶‰åŠåˆ°çš„å†…å®¹è¾ƒå¤šï¼Œåˆ†ä¸ºä¸‰ç¯‡æ¥è®²ã€‚ æœ¬ç¯‡ä¸ºæœ€åä¸€ç¯‡ï¼Œåœ¨çœ‹æœ¬ç¯‡ä¹‹å‰å»ºè®®å…ˆæŸ¥çœ‹å‰ä¸¤ç¯‡ï¼š å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡ å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:1:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å›é¡¾ é¦–å…ˆé€šè¿‡ä¸¤ç§å›¾å›é¡¾ä¸€ä¸‹å®¹å™¨ä½¿ç”¨NVIDIA GPUçš„åŸç†ï¼Œå¦‚ä¸‹ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:2:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"Kubelet \u0026 Device Plugin ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:2:1","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"Nvidia-container-runtime ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:2:2","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ æ€»ç»“ä¸€ä¸‹cAdvisoræ— æ³•æä¾›ç‰¹æƒæ¨¡å¼å®¹å™¨GPUæŒ‡æ ‡çš„æ ¹æœ¬åŸå› ï¼š cAdvisorä½œä¸ºä¸€ä¸ªååº•å±‚çš„é€šç”¨æŒ‡æ ‡èƒ½åŠ›çš„æä¾›è€…ï¼Œä¸ºäº†ä¸å…¶ä»–ç»„ä»¶è§£è€¦ï¼Œå…¶ä»æœ€åº•å±‚device cgroupæ¥è·å–å®¹å™¨ç»‘å®šçš„GPUä¿¡æ¯ï¼› containerdåœ¨åˆ›å»ºå®¹å™¨æ—¶åˆ¤æ–­æ˜¯å¦å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œæ˜¯çš„è¯ä¼šä¸ºå®¹å™¨è®¾ç½®å¯ä»¥è®¿é—®æ‰€æœ‰è®¾å¤‡ï¼Œå³a *:* rwmã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:3:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å¿…è¦æ€§ ä½¿ç”¨GPUæ—¶å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼æ˜¯ä¸€ç§è¶‹åŠ¿ï¼Œç®€å•è¯´å°±æ˜¯é€šè¿‡Envçš„æ–¹å¼ä¼ é€’GPUå¡ä¿¡æ¯æ—¶ï¼Œç”¨æˆ·å¦‚æœçŸ¥é“è¿™ä¸ªèƒ½åŠ›ï¼Œåˆ™å¾ˆå®¹æ˜“å°±å¯ä»¥è¶Šè¿‡device-pluginåœ¨Pod specä¸­è®¾ç½®Envæ¥å®ç°ä½¿ç”¨GPUå¡çš„ç›®çš„ï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œnvidia k8s-deivice-pluginæä¾›äº†å¦ä¸€ç§å®ç°æ–¹å¼ï¼Œå‚è€ƒè¿™é‡Œï¼Œæ–°çš„æ–¹å¼æ˜¯é€šè¿‡æŒ‚è½½å·çš„æ–¹å¼è¯†åˆ«æ‰€éœ€çš„GPUè®¾å¤‡ä¿¡æ¯ï¼Œå¿…é¡»å¼€å¯ç‰¹æƒæ¨¡å¼ã€‚ è™½ç„¶ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥å®ç°å®¹å™¨å†…ä½¿ç”¨GPUè®¾å¤‡çš„ç›®çš„ï¼Œä½†å®ç°æ–¹å¼éƒ½ä¸å¤Ÿä¼˜é›…ï¼Œæ ¹æœ¬åŸå› è¿˜æ˜¯ç¼ºå°‘ä¸€ä¸ªå°†ç¬¬ä¸‰æ–¹è®¾å¤‡èµ„æºé€šçŸ¥ç»™container runtimeçš„è§„èŒƒï¼Œç¤¾åŒºä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œæå‡ºäº†CDIè§„èŒƒï¼Œæœ‰å…³è¿›å±•è¯¦è§è¿™é‡Œã€‚åœ¨æ­¤è§„èŒƒçš„æ ‡å‡†å®ç°ä¸Šçº¿ä¹‹å‰ï¼Œéšç€è¶Šæ¥è¶Šå¤šçš„å®¹å™¨åœ¨ä½¿ç”¨GPUæ—¶å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œå“ªæ€•ä¸é‚£ä¹ˆä¼˜é›…çš„æ–¹æ¡ˆä¹Ÿæ˜¯æœ‰å¿…è¦å…ˆå®ç°çš„ã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:3:1","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"GPUè®¾å¤‡è¡¨ç¤ºæ–¹å¼ k8s-device-pluginæ”¯æŒä¸¤ç§GPUè®¾å¤‡è¡¨ç¤ºæ–¹å¼ï¼Œé€šè¿‡deviceIDStrategyFlagå‚æ•°è®¾ç½®ï¼š index uuid ï¼ˆé»˜è®¤ï¼‰ å¦‚æœä»¥indexæ–¹å¼è®¾ç½®ï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨cAdvisorä¸­è·å–indexå€¼ï¼Œæ— éœ€ä»device cgroupä¸­è·å–ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒç®€å•ã€‚ä¸‹é¢çš„å†…å®¹æ˜¯é’ˆå¯¹ä»¥uuidæ–¹å¼è®¾ç½®æ—¶cAdvisorçš„å¤„ç†é€»è¾‘ã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:3:2","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"GPUè®¾å¤‡ä¿¡æ¯æ¥æº Pod-Resource Kubeletæä¾›äº†pod-resourceæœºåˆ¶ï¼Œå¯¹å¤–æä¾›rpcæœåŠ¡ï¼Œä¾›å¤–éƒ¨è·å–å®¹å™¨æ‰€éœ€çš„èµ„æºä¿¡æ¯ã€‚å¯¹Kubeletç‰ˆæœ¬æœ‰ä¸€å®šçš„è¦æ±‚ï¼Œä¸”è¿™ç§æ–¹å¼ä¼šæŠŠcAdvisorå’ŒKubeletå¶åˆåœ¨ä¸€èµ·ï¼Œä¸é€‚åˆIn-Treeæ–¹å¼ï¼Œå¯ä»¥é‡‡å–Out-Of-Treeçš„æ–¹å¼å®ç°ã€‚ OCI spec cAdvisorä¸­æœ¬èº«å·²ç»ç¼“å­˜äº†å®¹å™¨OCI specä¿¡æ¯ï¼Œå¯ä»¥ä»ä¸­è·å–ç»‘å®šçš„GPUä¿¡æ¯ï¼Œä¼˜ç‚¹æ˜¯ä¸Šå±‚æ— æ„ŸçŸ¥ï¼Œç¼ºç‚¹æ˜¯åŠ é‡äº†cAdvisorçš„ä¾èµ–ï¼ŒcAdvisoréœ€è¦çŸ¥é“å½“å‰å®¹å™¨ä½¿ç”¨çš„GPUä¿¡æ¯å’Œå½“å‰èŠ‚ç‚¹ä¸Šæ‰€æœ‰GPUä¿¡æ¯ã€‚ k8s-device-pluginæä¾›äº†ä¸¤ç§æ–¹å¼è®¾ç½®å½“å‰å®¹å™¨ä½¿ç”¨çš„GPUè®¾å¤‡ä¿¡æ¯ï¼š Env Volume Mount åœ¨è·å–å½“å‰èŠ‚ç‚¹æ‰€æœ‰GPUä¿¡æ¯ä¹‹å‰æœ‰ä¸ªåŸºç¡€çŸ¥è¯†ç‚¹éœ€è¦äº†è§£ï¼Œå³Mig Strategyã€‚ç­–ç•¥ä¸åŒï¼Œæœ€ç»ˆè·å–åˆ°çš„èŠ‚ç‚¹çš„GPUè®¾å¤‡ä¿¡æ¯ä¸åŒã€‚å½“å‰æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š Noneï¼šä¸ä½¿ç”¨MIGèƒ½åŠ› Singleï¼šä½¿ç”¨MIGèƒ½åŠ›ï¼Œä¸”å„GPUå®ä¾‹è¢«åˆ†ä¸ºç›¸åŒçš„è§„æ ¼çš„è®¡ç®—å®ä¾‹ Mixedï¼šä½¿ç”¨MIGèƒ½åŠ›ï¼ŒGPUå®ä¾‹å¯ä»¥åˆ’åˆ†ä¸ºä»»æ„è§„æ ¼çš„è®¡ç®—å®ä¾‹ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨æ•´ä¸ªGPUå®ä¾‹ å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯å®ç°ä¸åŒæœºåˆ¶ä¸‹è·å–GPUè®¾å¤‡ä¿¡æ¯çš„åŠŸèƒ½ï¼Œå¯ä»¥å‚è€ƒk8s-device-pluginçš„å®ç°ï¼Œå› ä¸ºå…¶æœ¬èº«åœ¨Allocateæ—¶å¿…ç„¶æ¶‰åŠåˆ°ç›¸å…³èƒ½åŠ›ã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display3/:3:3","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æè¿° å¼€å¯ç‰¹æƒæ¨¡å¼ï¼ˆ--privilegedï¼‰çš„å®¹å™¨ï¼Œåœ¨ä½¿ç”¨nvidia GPUæ—¶ï¼Œæ— æ³•é€šè¿‡cAdvisorè·å–GPUç›¸å…³çš„metricsä¿¡æ¯ã€‚Googleå¤§æ³•å¯ä»¥æœåˆ°ç›¸å…³çš„Issueï¼Œäº2018å¹´æå‡ºï¼Œè‡³ä»Šä»å¤„äºOpençŠ¶æ€ï¼ˆç»™cAdvisorè´¡çŒ®ä»£ç çš„æœºä¼šï¼‰ï¼Œç”±äºæ¶‰åŠåˆ°çš„å†…å®¹è¾ƒå¤šï¼Œåˆ†ä¸ºä¸‰ç¯‡æ¥è®²ã€‚ æ¥ä¸Šä¸€ç¯‡ï¼Œåœ¨ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬å·²ç»æ¸…æ¥šcAdvisoræ˜¯å¦‚ä½•è·å–å®¹å™¨æ‰€ä½¿ç”¨çš„GPUå¡ä¿¡æ¯çš„ï¼Œä¹Ÿæ¸…æ¥šäº†ä¸ºä»€ä¹ˆåœ¨å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼æ—¶cAdvisoræ— æ³•è·å–å…¶æ‰€ä½¿ç”¨çš„çš„GPUå¡ä¿¡æ¯ã€‚ä½†è·ç¦»ç»™å‡ºæœ‰æ•ˆä¸”ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆè¿˜æœ‰å¾ˆå¤šå¾…æ¢ç´¢çš„ï¼Œä¾‹å¦‚devices.listå†…å®¹æ˜¯å¦‚ä½•æ¥çš„ï¼Ÿå¦‚ä½•çŸ¥é“åº”è¯¥ä¸ºå®¹å™¨ç»‘å®šå“ªäº›GPUå¡ç­‰ï¼Œè¿™äº›é—®é¢˜éƒ½å°†ä¼šåœ¨æ¥ä¸‹æ¥çš„å†…å®¹ä¸­å¾—åˆ°ç­”æ¡ˆï¼Œè®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥è¿›è¡Œåˆ†æã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display2/:1:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æŠ½ä¸å‰¥èŒ§ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display2/:2:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"devics.listså†…å®¹ä»ä½•è€Œæ¥ ä¸Šé¢æåˆ°è¿‡ä¸‰ä¸ªdevice cgroupçš„é‡è¦æ–‡ä»¶ï¼Œå…¶ä¸­devices.allowå’Œdevices.denyä¸ºåªå†™æ–‡ä»¶ï¼Œdevices.listä¸ºåªè¯»æ–‡ä»¶ã€‚deviceå­ç³»ç»Ÿæ˜¯é€šè¿‡device whitelistå®ç°çš„ï¼Œæ­¤å¤„æ¶‰åŠåˆ°å†…æ ¸çš„çŸ¥è¯†ï¼Œæƒ³æ·±å…¥äº†è§£å…¶å®ç°çš„å¯ä»¥ç¿»ä¸€ä¸‹å†…æ ¸çš„ä»£ç ã€‚ç®€å•ç†è§£å°±æ˜¯é€šè¿‡å‰é¢ä¸¤ä¸ªåªå†™çš„æ–‡ä»¶å¯¹whiteliståšè®¾ç½®ï¼Œå¾€devices.allowä¸­æ·»åŠ æ¡ç›®ç›¸å½“äºæ·»åŠ ç™½åå•ï¼Œå¾€devices.denyä¸­æ·»åŠ æ¡ç›®ç›¸å½“äºåˆ é™¤ç™½åå•ï¼Œæœ€åé€šè¿‡devices.listè·å–ç™½åå•å†…å®¹ã€‚é‚£æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯devices.allowå’Œdevices.denyå†…å®¹æ˜¯è°æ ¹æ®ä»€ä¹ˆè§„åˆ™å†™å…¥çš„ï¼Ÿ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display2/:2:1","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"devices.allowå’Œdevices.denyå†…å®¹è°è´Ÿè´£å†™å…¥ nvidia-container-runtime-webhookå¯¹åº”çš„githubé¡¹ç›®ä¸º nvidia-container-toolkitã€‚ è¿™é‡Œå†…å®¹æ¯”è¾ƒå¤šï¼Œæ¶‰åŠåˆ°kubeletã€device-pluginã€ containerdã€ runCã€nvidia-container-runtimeã€nvidia-container-runtime-hookç­‰ã€‚åœ¨ç»§ç»­ä¹‹å‰å…ˆå›é¡¾ä¸€ä¸‹dockerçš„è¿›ç¨‹æ¨¡å‹ï¼Œäº†è§£äº†è¿›ç¨‹æ¨¡å‹åŠå„ç»„ä»¶çš„ä½œç”¨ä¹‹åå®šä½é—®é¢˜ä¼šæ›´æœ‰é’ˆå¯¹æ€§ï¼Œæ›´å®¹æ˜“ç†è§£ä¸‹é¢çš„å†…å®¹ã€‚ è¿›ç¨‹æ¨¡å‹å›é¡¾ ç›¸ä¿¡ä¸Šå›¾å¤§å®¶å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼Œå…¶ä¸­Docker Engineé€šè¿‡rpcä¸containerdé€šä¿¡ï¼Œcontainerdé€šè¿‡rpcä¸containerd-shim é€šä¿¡ï¼Œæœ€ç»ˆcontainerd-shimé€šè¿‡runCæ¥æ§åˆ¶å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸã€‚æåˆ°runCå°±ä¸å¾—ä¸æOCIï¼ˆOpen Container Initiativeï¼‰ã€‚OCI çš„æ¥æºè¿™é‡Œä¸å¤šè¯´ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæœç´¢ã€‚å…¶ä¸»è¦åŒ…å«äº†ä¸¤ç§è§„èŒƒï¼Œå³runtime-specå’Œimage-spceï¼Œè€Œ runCå°±æ˜¯å¯¹runtime-specçš„ä¸€ç§å®ç°ã€‚æ—¢ç„¶æ˜¯è§„èŒƒï¼Œé‚£å°±ä¼šå­˜åœ¨å¤šç§å®ç°ï¼Œnvidia-container-runtimeå°±æ˜¯ä¸ºäº†æ”¯æŒå®¹å™¨ä½¿ç”¨GPUè€Œåšçš„å¦ä¸€ç§runtime-specçš„å®ç°ï¼ŒåŸç†å¦‚ä¸‹ å³ä¾§ä»runCå¼€å§‹çš„ä¸€æ•´å—å°±æ˜¯nvidia-container-runtimeã€‚ runCå®ç°åŸç† runCå®¹å™¨åˆ›å»ºåŸç† ä¸€ä¸ªå®¹å™¨å¯åŠ¨ä¸»è¦åˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š create: ä¸»è¦æ˜¯ä¸ºäº†è§£æã€ç»„è£…å®¹å™¨å¯åŠ¨çš„é…ç½®å’Œä¸å­è¿›ç¨‹çš„æ¶ˆæ¯é€šé“ç­‰ï¼› init : ä¸»è¦æ ¹æ®å®¹å™¨é…ç½®å¯åŠ¨å®¹å™¨æ•´ä¸ªè¿è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ç†ŸçŸ¥nsï¼Œcgroups, seccomp, apparmor, capsç­‰; start : ä¸»è¦æ˜¯ä¸ºäº†é€šçŸ¥init è¿›ç¨‹å¯åŠ¨å®¹å™¨ï¼› å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾ nvidia-container-runtimeåŸç† nvidia-container-runtimeåŸç†æ˜¯åˆ©ç”¨runtime-specè§„èŒƒä¸­æåˆ°çš„PreStart Hookæœºåˆ¶åœ¨æ‰§è¡Œå®Œrunc startä¹‹åï¼Œåœ¨çœŸæ­£çš„ç”¨æˆ·è¿›ç¨‹å¯åŠ¨ä¹‹å‰ï¼Œæ‰§è¡Œnviadia-container-runtime-hookè¿›è¡Œä¸€äº›æ“ä½œï¼Œå…¶é’ˆå¯¹GPUè®¾å¤‡çš„æŒ‚è½½å’Œdevice cgroupçš„è®¾ç½®æ˜¯é€šè¿‡ä¸€ä¸ªç”±Cå’ŒC++å®ç°çš„å«åšnvidia-container-cliï¼ˆlibnvidia-containerï¼‰çš„ç¨‹åºå®ç°çš„ã€‚ æ³¨æ„ï¼šprestart hookçš„ç”Ÿæ•ˆæ—¶æœºæœ‰å¾…ç¡®è®¤ï¼Œè™½ç„¶OCI specä¸­æåˆ°æ˜¯åœ¨startä¹‹åï¼Œä½†æ˜¯ç»è¿‡çœ‹runcæºç å‘ç°æ˜¯åœ¨æ‰§è¡Œinitçš„è¿‡ç¨‹ä¸­ï¼Œä¸”å°šæœªæ‰§è¡Œstart nvidia-container-runtime-hooké€šè¿‡è§£æruntime-specä¸­ä¸ºç”¨æˆ·ç¨‹åºè®¾ç½®çš„**NVIDIA_VISIBLE_DEVICES**ç¯å¢ƒå˜é‡è·å–å®¹å™¨éœ€è¦ä½¿ç”¨çš„GPUå¡çš„IDï¼Œå¹¶è°ƒç”¨nvidia-container-cli configure --device=ID(s) æ¥å®Œæˆä¸Šè¿°æåˆ°çš„æ“ä½œã€‚ è‡³æ­¤å¯ä»¥å¯¹å®¹å™¨å†…çš„GPUè®¾å¤‡æŒ‚è½½å’Œdevice cgroupçš„è®¾ç½®è¿‡ç¨‹å’ŒåŸç†æœ‰ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè¿™é‡Œåˆ©ç”¨äº†OCI hookå’Œspecï¼Œé€šè¿‡ç¯å¢ƒå˜é‡å½¢å¼æŠŠéœ€è¦çš„GPUè®¾å¤‡IDè®¾ç½®åˆ°åä¸ºNVIDIA_VISIBLE_DEVICESçš„ç¯å¢ƒå˜é‡ä¸Šï¼Œè¿›è¡Œäº†æ¯”è¾ƒå·§å¦™çš„å®ç°ï¼Œé‚£åˆæ˜¯è°ä¸ºæ­¤ç¯å¢ƒå˜é‡è®¾ç½®èµ‹å€¼çš„å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹ NVIDIA_VISIBLE_DEVICESæ¥è‡ªä½•å¤„ Kubernetes æä¾›äº†ä¸€ä¸ª device pluginæ¡†æ¶ï¼ˆbeta from 1.10ï¼‰ï¼Œå¯ä»¥ç”¨å®ƒæ¥å°†ç³»ç»Ÿç¡¬ä»¶èµ„æºå‘å¸ƒåˆ°Kubeletï¼Œå†ç”±Kubeletä¸ŠæŠ¥ç»™Kube-apiserverï¼Œä¸å¿…å®šåˆ¶ Kubernetes æœ¬èº«çš„ä»£ç ã€‚ç›®æ ‡è®¾å¤‡åŒ…æ‹¬ GPUã€é«˜æ€§èƒ½ NICã€FPGAã€ InfiniBand é€‚é…å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„ã€å¯èƒ½éœ€è¦ç‰¹å®šäºä¾›åº”å•†çš„åˆå§‹åŒ–å’Œè®¾ç½®çš„è®¡ç®—èµ„æºã€‚ å·¥ä½œæµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œdevice pluginå…ˆæ³¨å†Œåˆ°Kubeletï¼ŒKubeletå¼€å§‹watchdevice pluginå˜åŒ–ï¼Œåœ¨å®¹å™¨çœŸæ­£åˆ›å»ºä¹‹å‰Kubeletè°ƒç”¨device pluginæä¾›çš„AllocateæœåŠ¡å»ä¸ºPodç”³è¯·æ‰€éœ€èµ„æºã€‚Kubeletåœ¨å†…éƒ¨ç»´æŠ¤äº†ä¸€ä»½Podä¸æ‰©å±•èµ„æºçš„æ˜ å°„æ•°æ®ï¼Œä¸”é€šè¿‡checkpointå½¢å¼å†™åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œåœ¨åç»­Kubeleté‡å¯æ—¶ä¼šç”¨åˆ°ã€‚åŒæ—¶åœ¨å¼€å¯KubeletPodResourceç‰¹æ€§å¼€å…³åï¼ŒKubuletè¿˜å¯ä»¥é€šè¿‡rpcçš„å½¢å¼å¯¹å¤–æä¾›pod-resourcesä¿¡æ¯ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒhttps://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/device-plugins/ã€‚ è¿™é‡Œå¤§è‡´å¯ä»¥çŒœåˆ°èµ‹å€¼çš„åœ°æ–¹äº†ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºGPUçš„ç¯å¢ƒå˜é‡ï¼Œæ‰€ä»¥ä¸å¯èƒ½ç›´æ¥åœ¨Kubeletä¸­å®šä¹‰ï¼Œé‚£å°±åªå‰©ä¸‹nidiaå¯¹åº”çš„k8s-device-pluginäº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶æºç ä¸­æ‰¾åˆ°å¯¹åº”çš„å®ç°é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š // Constants to represent the various device list strategies const ( DeviceListStrategyEnvvar = \"envvar\" DeviceListStrategyVolumeMounts = \"volume-mounts\" ) // migStrategyNone func (s *migStrategyNone) GetPlugins() []*NvidiaDevicePlugin { return []*NvidiaDevicePlugin{ NewNvidiaDevicePlugin( \"nvidia.com/gpu\", NewGpuDeviceManager(false), // Enumerate device even if MIG enabled \"NVIDIA_VISIBLE_DEVICES\", gpuallocator.NewBestEffortPolicy(), pluginapi.DevicePluginPath+\"nvidia-gpu.sock\"), } } // Allocate which return list of devices. func (m *NvidiaDevicePlugin) Allocate(ctx context.Context, reqs *pluginapi.AllocateRequest) (*pluginapi.AllocateResponse, error) { responses := pluginapi.AllocateResponse{} for _, req := range reqs.ContainerRequests { for _, id := range req.DevicesIDs { if !m.deviceExists(id) { return nil, fmt.Errorf(\"invalid allocation request for '%s': unknown device: %s\", m.resourceName, id) } } response := pluginapi.ContainerAllocateResponse{} uuids := req.DevicesIDs deviceIDs := m.deviceIDsFromUUIDs(uuids) // é»˜è®¤ä¸ºDeviceListStrategyEnvvarï¼Œm.deviceListEnvvarçš„å€¼å°±æ˜¯NVIDIA_VISIBLE_DEVICES if deviceListStrategyFlag == DeviceListStrategyEnvvar { response.Envs = m.apiEnvs(m.deviceListEnvvar, deviceIDs) } if deviceListStrategyFlag == DeviceListStrategyVolumeMounts { response.Envs = m.apiEnvs(m.deviceListEnvvar, []string{deviceListAsVolumeMountsContainerPathRoot}) response.Mounts = m.apiMounts(deviceIDs) } if passDeviceSpecsFlag { response.Devices = m.apiDeviceSpecs(nvidiaDriverRootFlag, uuids) } responses.ContainerResponses = append(responses.ContainerResponses, \u0026response) } return \u0026responses, nil } å¯ä»¥çœ‹åˆ°åœ¨å…·ä½“æ˜¯åœ¨Kubeletè°ƒç”¨AllocateæœåŠ¡æ—¶ï¼Œk8s-device-pluginå¯¹response.Envè¿›è¡Œäº†è®¾ç½®ï¼Œæ·»åŠ äº†å¯¹åº”çš„ç¯å¢ƒå˜é‡ï¼Œå€¼å°±æ˜¯å®¹å™¨æ‰€å¯¹åº”çš„GPUè®¾å¤‡ï¼Œå¤šä¸ªè®¾å¤‡ç”¨é€—å·åˆ†éš”ã€‚ ä¸ºä»€ä¹ˆå¼€å¯ç‰¹æƒæ¨¡å¼çš„å®¹å™¨devices.listæ˜¯*:* åŒæ ·æ˜¯è®¾ç½®äº†NVIDIA_VISIBLE_DEVICESï¼ŒåŒæ ·æœ€ç»ˆéƒ½æ˜¯nvidia-container-cliè¿›è¡Œdevice cgroupçš„è®¾ç½®ï¼Œä¸ºä»€ä¹ˆç‰¹æƒæ¨¡å¼çš„å®¹","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display2/:2:2","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å®Œæ•´æµç¨‹ è‡³æ­¤æˆ‘ä»¬æ¸…æ¥šäº†å®¹å™¨åœ¨ä½¿ç”¨GPUæ—¶çš„æ•´ä¸ªæµç¨‹ï¼Œä»å®¹å™¨åˆ›å»ºåˆ°çœŸæ­£æŒ‚è½½GPUè®¾å¤‡ä»¥åŠå¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•è·å–GPUæŒ‡æ ‡çš„åŸå› ã€‚ å¥½äº†ï¼Œæœ‰å…³cAdvisoræ— æ³•æä¾›ç‰¹æƒæ¨¡å¼å®¹å™¨çš„GPUæŒ‡æ ‡çš„åŸç†åŠåŸå› è‡³æ­¤å·²ç»éƒ½ææ¸…æ¥šäº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬è®²ä»‹ç»è§£å†³æ–¹æ¡ˆï¼Œæ•¬è¯·æœŸå¾…~ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display2/:2:3","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æè¿° å¼€å¯ç‰¹æƒæ¨¡å¼ï¼ˆ--privilegedï¼‰çš„å®¹å™¨ï¼Œåœ¨ä½¿ç”¨nvidia GPUæ—¶ï¼Œæ— æ³•é€šè¿‡cAdvisorè·å–GPUç›¸å…³çš„metricsä¿¡æ¯ã€‚Googleå¤§æ³•å¯ä»¥æœåˆ°ç›¸å…³çš„Issueï¼Œäº2018å¹´æå‡ºï¼Œè‡³ä»Šä»å¤„äºOpençŠ¶æ€ï¼ˆç»™cAdvisorè´¡çŒ®ä»£ç çš„æœºä¼šï¼‰ï¼Œç”±äºæ¶‰åŠåˆ°çš„å†…å®¹è¾ƒå¤šï¼Œåˆ†ä¸ºä¸‰ç¯‡æ¥è®²ã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display/:1:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å¯»è¸ªè§…æº é—®é¢˜çš„æœ€ç»ˆè¡¨ç°æ˜¯é€šè¿‡cAdvisoræ— æ³•è·å–å¼€å¯ç‰¹æƒæ¨¡å¼å®¹å™¨çš„gpuç›¸å…³æ•°æ®ï¼Œå³ curl localhost:4194/api/v1.3/docker/{containerID} è¿”å›çš„ç»“æœä¸­ä¸åŒ…å«ä»»ä½•gpuä¿¡æ¯ï¼Œè€Œæ²¡æœ‰å¼€ç‰¹æƒæ¨¡å¼çš„å®¹å™¨æ˜¯å¯ä»¥æ­£å¸¸è¿”å›gpuç›¸å…³ä¿¡æ¯çš„ã€‚ æœªå¼€å¯ç‰¹æƒæ¨¡å¼çš„å®¹å™¨è¿”å›ç»“æœç±»ä¼¼å¦‚ä¸‹ï¼š root@node1: # curl localhost:4194/api/v1.3/docker/a0f3c54d8c6beba5d9947723494e4c9b625f03ce4eb0c096e4cf46cae9e389e0 | jq [.[]][0].stats[0].accelerators [ { \"make\": \"nvidia\", \"model\": \"Tesla T4\", \"id\": \"GPU-a2d26dd1-5a8f-35e5-c325-2cd0756d5ed2\", \"memory_total\": 15843721216, \"memory_used\": 15127085056, \"duty_cycle\": 6 }, { \"make\": \"nvidia\", \"model\": \"Tesla T4\", \"id\": \"GPU-febe3f91-914e-cb7f-bf0a-d96ffeda2777\", \"memory_total\": 15843721216, \"memory_used\": 11367940096, \"duty_cycle\": 44 } ] å¯ä»¥çœ‹åˆ°å®¹å™¨ç”¨åˆ°äº†ä¸¤å—GPUå¡ã€‚ å¼€å¯ç‰¹æƒæ¨¡å¼çš„å®¹å™¨æ‰§è¡Œä¸Šè¿°å‘½ä»¤åè¿”å›ç©ºä¿¡æ¯ã€‚ ","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display/:2:0","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"cAdvisor é¦–å…ˆéœ€è¦äº†è§£çš„å°±æ˜¯cAdvisorè·å–gpuæŒ‡æ ‡ä¿¡æ¯çš„åŸç†ï¼Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œç®€å•ç¿»è¯‘ä¸€ä¸‹å¦‚ä¸‹ï¼š cAdvisorå¯ä»¥å¯¹å¤–æš´éœ²å®¹å™¨çº§åˆ«çš„ç¡¬ä»¶åŠ é€Ÿå™¨çš„æŒ‡æ ‡ï¼Œä¸”å½“å‰åªæ”¯æŒè‹±ä¼Ÿè¾¾GPUï¼Œä¸æ”¯æŒæ•´æœºçº§åˆ« cAdvisoråªå¯¹åœ¨å®¹å™¨å¯åŠ¨æ—¶æ˜¾ç¤ºè®¾ç½®äº†--device /dev/nvidia0:/dev/nvidia0ä¿¡æ¯çš„å®¹å™¨æš´éœ²æŒ‡æ ‡ï¼Œæœªæ˜¾ç¤ºæŒ‡å®šçš„ä¸æš´éœ²ï¼ˆå¯¹åº”å®¹å™¨å¯åŠ¨æ—¶è®¾ç½®äº†--privilegedå‚æ•°ï¼‰ é€šè¿‡ä»‹ç»å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼šæ— æ³•è·å–å¼€å¯ç‰¹æƒæ¨¡å¼å®¹å™¨çš„GPUæŒ‡æ ‡æ˜¯Featureè€Œä¸æ˜¯Bug åŒæ—¶æ–‡æ¡£ä¸­æœ€åæåˆ°å¦‚æœcAdvisorå®¹å™¨åŒ–éƒ¨ç½²æ—¶å¦‚ä½•è®¾ç½®å‚æ•°ï¼Œå…¶ä¸­æåˆ°çš„ä¸‰ç§æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š cAdvisorå®¹å™¨ä»¥--privilegedæ¨¡å¼å¯åŠ¨ Docker v17.04.0-ce åŠä»¥ä¸Šç‰ˆæœ¬çš„è¯ï¼Œå¯åŠ¨æ—¶è®¾ç½®--device-cgroup-rule 'c 195:* mrw'å‚æ•° å¯åŠ¨æ—¶è®¾ç½®--device /dev/nvidiactl:/dev/nvidiactl /dev/nvidia0:/dev/nvidia0 /dev/nvidia1:/dev/nvidia1 \u003cand-so-on-for-all-nvidia-devices\u003eå‚æ•° ç°å®æ˜¯æ— è®ºå®¹å™¨æ˜¯å¦å¼€å¯ç‰¹æƒæ¨¡å¼ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å»è·å–å®¹å™¨çº§åˆ«çš„GPUä½¿ç”¨ç‡æŒ‡æ ‡ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿå¤§è‡´æœ‰ä¸¤ç§æ–¹æ³•ï¼šä¿®æ”¹cAdvisorä½¿å…¶æ”¯æŒï¼ˆIn-Treeï¼‰ã€æ·»åŠ å…¶ä»–ç»„ä»¶æ¥æä¾›GPUä½¿ç”¨ç‡æŒ‡æ ‡ï¼ˆOut-Of-Treeï¼‰ï¼Œæ— è®ºå“ªç§æ–¹å¼ï¼Œæˆ‘ä»¬éƒ½æœ‰å¿…è¦å…ˆææ¸…æ¥šå¦‚ä½•é‡‡é›†GPUä½¿ç”¨ç‡æŒ‡æ ‡ï¼Œå¯ä»¥ä»cAdvisorä¸‹æ‰‹ï¼Œçœ‹ä»–æ˜¯å¦‚ä½•é‡‡é›†çš„ã€‚ é‡‡é›†æœºåˆ¶ åœ¨çœ‹å…·ä½“å®ç°ä¹‹å‰ï¼Œé¦–å…ˆä»‹ç»ä¸€ä¸‹cAdvisorè¿è¡ŒåŸç†ï¼Œå¦‚ä¸‹å›¾ cAdvisoråœ¨é‡‡é›†è¿‡ç¨‹ä¸­ä¸»è¦åˆ†ä¸¤ç§æ•°æ®ï¼š å®¹å™¨æ•°æ® æŒ‡æ ‡æ•°æ® å®¹å™¨æ•°æ®æ¥æº é€šè¿‡watch cgroupä¸‹æ–‡ä»¶ç›®å½•çš„å˜åŒ–è¿›è¡Œå¯¹åº”å®¹å™¨çš„å¤„ç†ï¼Œæ­¤å¤„åªè·å–åˆ°å®¹å™¨IDï¼Œåœ¨è·å–åˆ°æ–°å¢å®¹å™¨æ—¶ï¼Œé€šè¿‡containerHandleræ ¹æ®å®¹å™¨IDè·å–å®¹å™¨è¯¦æƒ…ï¼Œä¾‹å¦‚åˆ¤æ–­å‡ºæ¥watchåˆ°çš„å®¹å™¨æ˜¯é€šè¿‡dockeråˆ›å»ºçš„ï¼Œåˆ™ä¼šè°ƒç”¨docker APIè·å–æŒ‡å®šIDçš„å®¹å™¨è¯¦æƒ…ï¼Œå…¶ä¸­å°±åŒ…å«äº†å®¹å™¨å¯åŠ¨æ—¶éœ€è¦çš„Envä¿¡æ¯ï¼Œåé¢çš„è§£å†³æ–¹æ¡ˆä¸­ä¼šç”¨åˆ°è¿™ä¸ªå±æ€§ã€‚ æŒ‡æ ‡æ•°æ®æ¥æº æ¯ä¸ªå®¹å™¨éƒ½æœ‰ä¸ä¹‹å¯¹åº”çš„collectoræ¥è¿›è¡ŒæŒ‡æ ‡é‡‡é›†ï¼Œå…¶ä¸­nvidiaæŒ‡æ ‡ç”±å¯¹åº”çš„nvidiaCollectorè´Ÿè´£é‡‡é›†ã€‚ æºç åˆ†æ æ˜ç™½äº†åŸç†ä¹‹åï¼Œå°±å¯ä»¥æœ‰é’ˆå¯¹æ€§çš„å»æºç ä¸­çœ‹å…¶å…·ä½“å®ç°é€»è¾‘äº†ã€‚ä»£ç ä½ç½®å¾ˆå¥½æ‰¾ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æœ‰ä¸ªacceleratorsæ–‡ä»¶å¤¹ï¼Œæºç ä½äºnvidia.goæ–‡ä»¶å†…ã€‚ // GetCollector returns a collector that can fetch NVIDIA gpu metrics for NVIDIA devices // present in the devices.list file in the given devicesCgroupPath. func (nm *nvidiaManager) GetCollector(devicesCgroupPath string) (stats.Collector, error) { nc := \u0026nvidiaCollector{} if !nm.devicesPresent { return \u0026stats.NoopCollector{}, nil } // Makes sure that we don't call initializeNVML() concurrently and // that we only call initializeNVML() when it's not initialized. nm.Lock() if !nm.nvmlInitialized { err := initializeNVML(nm) if err != nil { nm.Unlock() return \u0026stats.NoopCollector{}, err } } nm.Unlock() if len(nm.nvidiaDevices) == 0 { return \u0026stats.NoopCollector{}, nil } // ä»cgroupä¸­è·å–éœ€è¦å®¹å™¨ä½¿ç”¨çš„nvidiaè®¾å¤‡ä¿¡æ¯ï¼Œè¿”å›çš„æ˜¯gpuåºå·æ•°ç»„ nvidiaMinorNumbers, err := parseDevicesCgroup(devicesCgroupPath) if err != nil { return \u0026stats.NoopCollector{}, err } for _, minor := range nvidiaMinorNumbers { device, ok := nm.nvidiaDevices[minor] if !ok { return \u0026stats.NoopCollector{}, fmt.Errorf(\"NVIDIA device minor number %d not found in cached devices\", minor) } nc.devices = append(nc.devices, device) } return nc, nil } é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå…ˆåˆå§‹åŒ–NVMLï¼ˆåŸºäºCå®ç°çš„APIï¼Œç”¨æ¥ç›‘æ§å’Œç®¡ç†nvidiaè®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯ï¼Œé€šè¿‡nvidia-smiå¯¹å¤–æš´éœ²å…¶å„ç§èƒ½åŠ›ã€‚ï¼‰ï¼Œæ¥ç€è°ƒç”¨parseDevicesCgroupå‡½æ•°è·å–å®¹å™¨è‡ªèº«æ‰€ä½¿ç”¨çš„GPUçš„åºå·ï¼Œæœ€åé€šè¿‡è¿”å›çš„è®¾å¤‡åºå·æ‰¾åˆ°ä½¿ç”¨çš„è®¾å¤‡ä¿¡æ¯è¿”å›ã€‚ // parseDevicesCgroupè§£ædevice cgroupä¸‹çš„devices.listæ–‡ä»¶æ¥è·å–å…è®¸è¢«å®¹å™¨è®¿é—®çš„GPUè®¾å¤‡çš„minorå· // å¦‚æœå®¹å™¨å¯ä»¥è®¿é—®æ‰€æœ‰è®¾å¤‡æˆ–è€…æ‰€æœ‰nvidiaè®¾å¤‡çš„è¯ï¼Œä½†è¿™äº›è®¾å¤‡å¹¶æœªåœ¨devices.listä¸­ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ var parseDevicesCgroup = func(devicesCgroupPath string) ([]int, error) { // Always return a non-nil slice nvidiaMinorNumbers := []int{} devicesList := filepath.Join(devicesCgroupPath, \"devices.list\") f, err := os.Open(devicesList) if err != nil { return nvidiaMinorNumbers, fmt.Errorf(\"error while opening devices cgroup file %q: %v\", devicesList, err) } defer f.Close() s := bufio.NewScanner(f) // See https://www.kernel.org/doc/Documentation/cgroup-v1/devices.txt for the file format for s.Scan() { text := s.Text() fields := strings.Fields(text) if len(fields) != 3 { return nvidiaMinorNumbers, fmt.Errorf(\"invalid devices cgroup entry %q: must contain three whitespace-separated fields\", text) } // Split the second field to find out major:minor numbers majorMinor := strings.Split(fields[1], \":\") if len(majorMinor) != 2 { return nvidiaMinorNumbers, fmt.Errorf(\"invalid devices cgroup entry %q: second field should have one colon\", text) } // NVIDIA graphics devices are character devices with major number 195. // https://github.com/torvalds/linux/blob/v4.13/Documentation/admin-guide/devices.txt#L2583 if fields[0] == \"c\" \u0026\u0026 majorMinor[0] == \"195\" { minorNumber, err := strconv.Atoi(majorMinor[1]) if err != nil { return nvidiaMinorNumbers, fmt.Errorf(\"invalid devices cgroup entry %q: minor number is not integer\", text) } // We don't want devices like nvidiactl (195:255) and nvidia-modeset (195:254) if minorNumber \u003c 128 { nvidiaMinorNumbers = append(nvidiaMinorNumbers, minorNumber) } // We are ignoring the \"195:*\" case","date":"2021-05-30","objectID":"https://www.likakuli.com/posts/gpu-metrics-not-display/:2:1","tags":["docker","gpu","cadvisor"],"title":"å®¹å™¨å¼€å¯ç‰¹æƒæ¨¡å¼åæ— æ³•é€šè¿‡cadvisorè·å–GPU metricsæŒ‡æ ‡","uri":"https://www.likakuli.com/posts/gpu-metrics-not-display/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿ æ¬¢è¿ä½¿ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªç”¨Goç¼–å†™çš„ç®€å•é€šç”¨çš„Restful APIé¡¹ç›®ï¼Œéµå¾ªSOLIDåŸåˆ™ã€‚ éƒ¨åˆ†çµæ„Ÿæ¥è‡ªäº service-pattern-go ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:0","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ä¾èµ– Gin Gorm Testify (Test \u0026 Mock framework) Mockery (Mock generator) Hystrix-Go (Circuit Breaker) ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:1","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å¼€å§‹ å®‰è£… ä»‹ç» ç›®å½•ç»“æ„ Mocking Tesing èƒ½åŠ›æ”¯æŒ ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:2","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å®‰è£… å…‹éš†é¡¹ç›®ä»£ç  git clone https://github.com/likakuli/generic-project-template.git å¯åŠ¨mysqlæœåŠ¡å¹¶åˆå§‹åŒ–æ•°æ®åº“ docker run --name=mysql -it -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -d registry.cn-beijing.aliyuncs.com/likakuli/mysql æ³¨æ„ï¼šå¦‚æœæ˜¯åœ¨MacOSä¸Šä½¿ç”¨Docker for Macå¯åŠ¨çš„å®¹å™¨ï¼Œåˆ™éœ€è¦å®‰è£… docker-connector ï¼Œå¦åˆ™æ— æ³•åœ¨æœ¬æœºé€šè¿‡å®¹å™¨IPè®¿é—®å®¹å™¨ï¼ŒåŸå› å‚è€ƒè¿™é‡Œã€‚å®‰è£…å‘½ä»¤å¦‚ä¸‹ # å®‰è£… docker-connector brew install wenjunxiao/brew/docker-connector # æŠŠ docker çš„æ‰€æœ‰ bridge ç½‘ç»œéƒ½æ·»åŠ åˆ°è·¯ç”±ä¸­ docker network ls --filter driver=bridge --format \"{{.ID}}\" | xargs docker network inspect --format \"route {{range .IPAM.Config}}{{.Subnet}}{{end}}\" \u003e\u003e /usr/local/etc/docker-connector.conf # å¯åŠ¨æœåŠ¡ sudo brew services start docker-connector # åœ¨ docker ç«¯è¿è¡Œ wenjunxiao/mac-docker-connectorï¼Œéœ€è¦ä½¿ç”¨ host ç½‘ç»œï¼Œå¹¶ä¸”å…è®¸ NET_ADMIN docker run -it -d --restart always --net host --cap-add NET_ADMIN --name connector wenjunxiao/mac-docker-connector é•œåƒæ¶‰åŠåˆ°çš„Dockerfileä¸sqlæ”¾ç½®åœ¨dockeræ–‡ä»¶å¤¹ä¸‹ è¿è¡Œå•å…ƒæµ‹è¯• make test ç¼–è¯‘ç¨‹åº make build è¿è¡Œç¨‹åº # æ›¿æ¢é…ç½®æ–‡ä»¶MySQL connectionString ./docker/replace_ip.sh # å¯åŠ¨ç¨‹åº ./generic-project-template --config=./conf/config.toml --log_dir=./logs --v=1 è®¿é—®ç¨‹åº curl http://localhost:8080/api/v1/score/Lucy/vs/Lily ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:3","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ä»‹ç» è¿™æ˜¯ä¸€ä¸ªç®€å•é€šç”¨çš„Restful APIé¡¹ç›®ï¼Œå†…ç½®ä¾èµ–æ³¨å…¥ã€Mockingç­‰åŠŸèƒ½ï¼Œæ—¨åœ¨æ–¹ä¾¿å¿«é€Ÿçš„ç¼–å†™å®‰å…¨å¯é çš„Restful APIä»£ç ã€‚ä¸åŒçš„æ•°æ®ç»“æ„ä¹‹é—´é€šè¿‡æ¥å£æ¥è®¿é—®ï¼Œé¿å…ç›´æ¥å¼•ç”¨å…·ä½“çš„å®ç°ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¾èµ–æ³¨å…¥åŠé‡‡ç”¨Mockç»“æ„è¿›è¡Œå•å…ƒæµ‹è¯•çš„æ•ˆæœã€‚ ä¸¾ä¾‹æ¥è¯´ï¼š IPlayerServie --\u003e IPlayerRepository type PlayerController struct { service interfaces.IPlayerService } type playerService struct { repo interfaces.IPlayerRepository } ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:4","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç›®å½•ç»“æ„ /cmd /- apiserver /conf /pkg /- config /- controllers /- interfaces /- models /- repositories /- server /- middlewares |- container.go |- router.go |- server.go /- services /- viewmodels controllers æ§åˆ¶å™¨æ–‡ä»¶å¤¹ä¸‹åŒ…å«æ‰€æœ‰Gin Route Handlerï¼Œé‡Œé¢åªåŒ…å«å¤„ç†Requestå’ŒResponseçš„é€»è¾‘ï¼Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è®¿é—®é€»è¾‘ã€‚ä»…ä¾èµ–äºinterfacesä¸‹çš„IServiceæ¥å£ï¼Œä¸ä¾èµ–äºå…·ä½“å®ç°ã€‚ interafces æ¥å£æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾æ‰€æœ‰IServiceå’ŒIRepositoryæ¥å£å®šä¹‰åŠé€šè¿‡Mockeryè‡ªåŠ¨ç”Ÿæˆçš„ç”¨äºå•å…ƒæµ‹è¯•çš„æ–‡ä»¶ï¼Œä¸åŒ…å«å…·ä½“æ¥å£å®ç°ã€‚ models æ¨¡å‹æ–‡ä»¶ä¸‹ä¸‹å­˜æ”¾æ‰€æœ‰ä¸æ•°æ®åº“æ˜ å°„çš„å®ä½“æ¨¡å‹å¯¹åº”çš„Go Structï¼ŒåªåŒ…å«æ•°æ®ç»“æ„ï¼Œä¸åŒ…å«æ•°æ®è®¿é—®é€»è¾‘ã€‚å¯ä»¥ç”± gen æ ¹æ®æ•°æ®åº“è¡¨ç»“æ„è‡ªåŠ¨ç”Ÿæˆï¼Œè¯¦æƒ…å‚è€ƒè¿™é‡Œ repositories ä»“åº“æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾æ‰€æœ‰æ•°æ®åº“è®¿é—®é€»è¾‘ï¼Œä¸”å®ç°äº†interfacesä¸‹å®šä¹‰çš„IRepositoryæ¥å£ï¼Œä¸»è¦ç”¨åˆ°modelsæ–‡ä»¶å¤¹ä¸‹å®šä¹‰çš„å®ä½“ç»“æ„ã€‚ services æœåŠ¡æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾æ‰€æœ‰å®ç°äº†servicesä¸‹å®šä¹‰çš„IServiceæ¥å£çš„é€»è¾‘ï¼Œä¾›controllersç›´æ¥ä½¿ç”¨ã€‚å…¶ä¸­æ¶‰åŠåˆ°çš„æ•°æ®åº“è®¿é—®éƒ¨åˆ†å‡é€šè¿‡è°ƒç”¨interfacesä¸‹çš„IRepositoryæ¥å£å®ç°ï¼Œä¸ä¾èµ–ä»»ä½•å…·ä½“å®ç°ã€‚ viewmodels è§†å›¾æ¨¡å‹æ–‡ä»¶å¤¹ä¸‹å­˜æ”¾æ‰€æœ‰éœ€è¦ä¸APIäº¤äº’çš„å®ä½“ï¼Œä¸»è¦åŒ…å«ä»APIè·å–åˆ°çš„ç»“æ„å’Œè¿”å›å€¼çš„ç»“æ„ã€‚ä¸modelsçš„åŒºåˆ«åœ¨äºå‰è€…å¯¹åº”apiå±‚ï¼Œåè€…å¯¹åº”æ•°æ®åº“å±‚ã€‚ router è·¯ç”±æ–‡ä»¶å¤¹ä¸‹åŒ…å«äº†æ‰€æœ‰å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡çš„Restful APIçš„è·¯ç”±æ³¨å†Œé€»è¾‘ã€‚ container å®¹å™¨æ–‡ä»¶ä¸‹åŒ…å«äº†æ‰€æœ‰ä¾èµ–æ³¨å…¥éœ€è¦çš„Providerçš„é€»è¾‘ï¼Œä¸”åœ¨æ­¤é€‰æ‹©å…·ä½“ä½¿ç”¨çš„æ¥å£å®ç°ç±»å‹ã€‚ ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:5","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Mocking ä¸ºæ–¹ä¾¿è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œä½¿ç”¨Mockeryè‡ªåŠ¨interfacesä¸‹æ¥å£å®ç°ï¼Œä¾‹å¦‚ç”ŸæˆIPlayerServiceçš„å®ç°ï¼Œåªéœ€è¦è¿›å…¥interfacesæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ï¼Œæœ€åä¼šåœ¨interfacesä¸‹è‡ªåŠ¨åˆ›å»ºmocksæ–‡ä»¶å¤¹æ¥å­˜æ”¾è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ mockery -name=IPlayerService éœ€è¦æå‰å®‰è£…mokeryå·¥å…· ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:6","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Testing æœ‰äº†ä¾èµ–æ³¨å…¥å’ŒMockåŠŸèƒ½åï¼Œå°±å¯ä»¥é’ˆå¯¹ä»»æ„æ¥å£å®ç°ç¼–å†™å•å…ƒæµ‹è¯•äº†ï¼Œç¤ºä¾‹ä¸­æ·»åŠ äº†é’ˆå¯¹serviceshecontrollersçš„å•æµ‹ï¼Œä¾›å‚è€ƒã€‚ ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:7","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"èƒ½åŠ›æ”¯æŒ Tracing PProf Prometheus Metrics Health Check Mock Testing Circuit Breaker Rate Limit Common go-utils â€¦ ","date":"2021-05-11","objectID":"https://www.likakuli.com/posts/generic-project-template/:1:8","tags":["Golang","Resetful API"],"title":"é€šç”¨Restful APIé¡¹ç›®æ¨¡æ¿","uri":"https://www.likakuli.com/posts/generic-project-template/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"CRUDè¿˜èƒ½è¿™ä¹ˆç©ï¼Ÿ ä½œä¸ºä¸€åæœ‰å¤šå¹´ç»éªŒçš„CRUDå·¥ç¨‹å¸ˆï¼Œåœ¨åšæŸé¡¹ç›®æ—¶ï¼Œéœ€è¦åœ¨æ­å»ºå®Œapiserveræ¡†æ¶ä»¥åŠdaoéƒ¨åˆ†ï¼Œä¸‰ä¸‹äº”é™¤äºŒçš„å°±æŠŠapiserveréƒ¨åˆ†æå®šäº†ï¼Œç„¶ååˆ°äº†daoéƒ¨åˆ†ã€‚ç”¨å±è‚¡æƒ³äº†æƒ³ç½‘ä¸Šè‚¯å®šæœ‰ç°æˆçš„å·¥å…·å¯ä»¥è‡ªåŠ¨ç”Ÿæˆgo structï¼Œäºæ˜¯åœ¨ç½‘ä¸Šæ‰¾äº†æ‰¾ï¼Œæœä¸å…¶ç„¶ï¼Œå¾ˆå¤šï¼Œä½†åŸºæœ¬éƒ½æ˜¯æ ¹æ®tableæ¥è‡ªåŠ¨ç”Ÿæˆgo structçš„ï¼Œäºæ˜¯æå®šäº†åˆ›å»ºtableçš„sqlï¼Œåˆ›å»ºå®Œtableä¹‹åé¡ºåˆ©çš„ç”¨å·¥å…·ç”Ÿæˆäº†go structã€‚ä½ ä»¥ä¸ºè¿™å°±å®Œäº†å—ã€‚å½“ç„¶æ²¡æœ‰ï¼Œå› ä¸ºåœ¨æ­¤è¿‡ç¨‹ä¸­æˆ‘å‘ç°äº†ä¸€ä¸ªBUGçº§çš„é¡¹ç›®ï¼šhttps://github.com/smallnest/genï¼Œç‚¹å¼€ä½œè€…ä¸»é¡µä¸€çœ‹ï¼ŒåŸæ¥åˆæ˜¯ä¸€ä½è‡ªå·±å…³æ³¨å·²ä¹…çš„åšä¸»ï¼šé¸Ÿçªï¼Œè‚ƒç„¶èµ·æ•¬ã€‚ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:1:0","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"é¡¹ç›®ä»‹ç» è¿™ä¸ªé¡¹ç›®èƒ½å¹²ä»€ä¹ˆå‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯ä»–å¯ä»¥æ ¹æ®ä½ çš„æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆgo structåŠdaoå±‚ã€apiå±‚ï¼Œç›´æ¥ç”Ÿæˆä¸€å¥—å¯è¿è¡Œçš„restful apié¡¹ç›®ï¼Œè€Œä¸”è¿˜æ­é…äº†swaggeræ–‡æ¡£ã€‚æŠ›å¼€æœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¸è¯´ï¼Œå•å°±è¿™ä¸ªæ€æƒ³å°±å·²ç»å¤Ÿæˆ‘ä»¬å­¦ä¹ äº†ã€‚ æ¥ä¸‹æ¥ç®€å•ä»‹ç»ä¸‹è¿™ä¸ªé¡¹ç›®ï¼Œä¸ºå•¥ç®€å•ä»‹ç»å‘¢ï¼Œå› ä¸ºä½¿ç”¨èµ·æ¥ç¡®å®å¾ˆç®€å•ï¼Œè€Œä¸”å…¶æ–‡æ¡£è¯´æ˜æ¯”è¾ƒå®Œå–„ã€‚ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:2:0","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"å®‰è£… é¡¹ç›®é‡‡ç”¨golangç¼–å†™ï¼Œç”Ÿæˆçš„ä¹Ÿæ˜¯golangä»£ç ï¼Œå®‰è£…æ–¹å¼è‡ªç„¶ä¹Ÿæ˜¯golangé¡¹ç›®çš„å®‰è£…æ–¹å¼ go get -u github.com/smallnest/gen ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:2:1","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"ä½¿ç”¨ åœ¨é¡¹ç›®ä»£ç çš„exampleæ–‡ä»¶å¤¹ä¸‹å­˜åœ¨ä¸€ä¸ªsample.dbæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥ç”Ÿæˆå®Œæˆçš„é¡¹ç›®ï¼Œå½“ç„¶ä¹Ÿæ”¯æŒè‡ªå®šä¹‰é…ç½®æ¥ç”Ÿæˆè‡ªå·±éœ€è¦çš„éƒ¨åˆ†ã€‚ ## æ ¹æ®sample.dbç”Ÿæˆé¡¹ç›®ä»£ç  $ gen --sqltype=sqlite3 \\ --connstr \"./sample.db\" \\ --database main \\ --json \\ --gorm \\ --guregu \\ --rest \\ --out ./example \\ --module example.com/rest/example \\ --mod \\ --server \\ --makefile \\ --json-fmt=snake \\ --generate-dao \\ --generate-proj \\ --overwrite ## ç¼–è¯‘ (ä½¿ç”¨makeå‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼Œpackr2ä¼šè¢«è‡ªåŠ¨å®‰è£…) $ cd ./example $ make example ## äºŒçº§åˆ¶ä½ç½®./bin/example $ cp ../../sample.db . $ ./example ## æ‰“å¼€æµè§ˆå™¨è®¿é—®è¿™é‡Œ http://127.0.0.1:8080/swagger/index.html ## åŒæ ·å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·è¿›è¡Œè®¿é—® curl http://localhost:8080/artists å¯èƒ½ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°æŸäº›æ–‡ä»¶æˆ–è€…åŒ…ï¼Œå®‰è£…å³å¯ï¼Œéƒ¨åˆ†æ–‡ä»¶åˆ¤æ–­æ–¹å¼æ˜¯ç›´æ¥æ£€æŸ¥GOPATHä¸‹æ˜¯å¦å­˜åœ¨ï¼Œæ‰€ä»¥ä¼šå‡ºç°ä½¿ç”¨go modæ¨¡å¼æ—¶getä¸‹æ¥ä¹‹åä»ç„¶æŠ¥é”™çš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥åˆ°GOPATHä¸‹ä¸‹è½½å¯¹åº”çš„é¡¹ç›®å³å¯ã€‚ æ˜¯ä¸æ˜¯so easyï¼Œåªéœ€è¦æä¾›æ•°æ®åº“å³å¯ç”Ÿæˆå®Œæ•´é¡¹ç›®ï¼Œä½†æ˜¯ä»–çš„åŠŸèƒ½ä¸æ­¢äºæ­¤ã€‚å› ä¸ºæ¯ä¸ªäººæœ‰è‡ªå·±çš„ä¹ æƒ¯çš„ç¼–ç é£æ ¼ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¸å¯èƒ½æ»¡è¶³æ‰€æœ‰äººçš„éœ€æ±‚ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:2:2","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"é«˜çº§åŠŸèƒ½ genæ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿ï¼Œå¯ä»¥æŠŠåŸæ¨¡æ¿å¯¼å‡ºï¼ŒåŸºäºå…¶ä¿®æ”¹ï¼Œæˆ–è€…å¹²è„†æŒ‰ç…§è‡ªå·±çš„é£æ ¼åˆ¶ä½œä¸€å¥—æ¨¡æ¿ï¼Œé€šè¿‡--templateDir=å‚æ•°æŒ‡å®šè‡ªå·±çš„æ¨¡æ¿çš„è·¯å¾„å³å¯ å¦‚æœåªæƒ³è¿›è¡Œç®€å•æ”¹åŠ¨ï¼Œå¯ä»¥å°è¯•--exec=å‚æ•°ï¼Œå…è®¸å¼€å‘è€…è‡ªå®šä¹‰ä»£ç ç”Ÿæˆè§„åˆ™ï¼Œåœ¨é¡¹ç›®è‡ªå¸¦çš„customæ–‡ä»¶å¤¹ä¸‹æœ‰sample.genæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®š--exec=sample.gençœ‹æ‰§è¡Œæ•ˆæœï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯æœ€æ–°çš„masterï¼Œåˆ™æ‰§è¡Œä¼šæŠ¥é”™ï¼Œçœ‹ä»£ç å¯ä»¥å‘ç°åœ¨2020/8/4çš„ä¸€æ¬¡ä¿®æ”¹ï¼Œæ”¹å˜äº†æŸäº›æ–¹æ³•çš„å½¢å‚ï¼Œè€Œsample.genæ²¡æœ‰è¿›è¡Œå¯¹åº”ä¿®æ”¹ï¼ŒæŒ‰éœ€ä¿®æ”¹å³å¯ã€‚ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:2:3","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"åŸç† é¡¹ç›®ç”¨åˆ°çš„ä¸»è¦çš„æŠ€æœ¯å°±æ˜¯golangçš„templateåŠŸèƒ½ï¼ŒåŒ…æ‹¬templateçš„å¸¸ç”¨èƒ½åŠ›åŠå®šåˆ¶å‡½æ•°ç­‰åŠŸèƒ½ã€‚å¦å¤–åŒ…æ‹¬GINæ¡†æ¶ã€GORMæ¡†æ¶ç­‰crudå·¥ç¨‹å¸ˆä»¬å¸¸ç”¨çš„åŒ…ã€‚é‡Œé¢è¿˜æœ‰ä¸€ä¸ªå¹³æ—¶ä¸æ€ä¹ˆç”¨çš„åŒ…packrï¼Œå…¶ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠé™æ€æ–‡ä»¶åµŒå…¥åˆ°æœ€ç»ˆç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œç¨‹åºå°±å¯ä»¥åœ¨ä»»ä½•ä½ç½®ç›´æ¥è¿è¡Œè€Œä¸éœ€è¦å—åˆ¶äºé¢å¤–é™æ€æ–‡ä»¶çš„ä½ç½®ç­‰å› ç´ ã€‚ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:3:0","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["å¼€æºé¡¹ç›®ä»‹ç»"],"content":"ç»“æŸè¯­ è¢«CRUDæŠ˜ç£¨çš„äººå•Šï¼Œæ˜¯å¦æœ‰è€ƒè™‘è¿‡å°†å…¶è‡ªåŠ¨åŒ–å‘¢ï¼Œè™½ç„¶ä¸šåŠ¡é€»è¾‘æ˜¯åœ¨å˜åŒ–çš„ï¼Œä½†é¡¹ç›®æ¡†æ¶éƒ¨åˆ†æ˜¯åŸºæœ¬ä¿æŒä¸å˜çš„ï¼Œæä¸€å¥—è‡ªå·±ä¹ æƒ¯çš„å¼€ç®±å³ç”¨æ¡†æ¶å²‚ä¸æ˜¯æ›´ç¾ï¼Œæ¯•ç«Ÿä»å¤´å†™çš„è¯ä¹Ÿéœ€è¦ä¸€ç‚¹æ—¶é—´ï¼Œæ‡’æœç„¶æ˜¯äººç±»è¿›æ­¥çš„é˜¶æ¢¯ï¼Œèµ¶ç´§å»ä¸‹è½½é¡¹ç›®è¯•ä¸€è¯•å§ã€‚ ","date":"2021-04-29","objectID":"https://www.likakuli.com/posts/crud/:4:0","tags":["gen"],"title":"CRUDå·¥ç¨‹å¸ˆçš„ç¦éŸ³","uri":"https://www.likakuli.com/posts/crud/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"è¿‘æœŸæœ‰ä¸ªå°éœ€æ±‚ï¼Œåœ¨ä¸é‡å»ºContainerçš„å‰æä¸‹ä¿®æ”¹Podç»“æ„ä¸­çš„Requestå€¼ï¼Œé™åˆ¶ä»…å¯ä»¥è°ƒå°ã€‚æœ¬ä»¥ä¸ºå¾ˆç®€å•çš„ä¸€ä¸ªéœ€æ±‚ï¼Œä½†å®é™…èŠ±è´¹äº†ä¸€å¤©çš„æ—¶é—´æ‰æå®Œï¼Œä»£ç æ”¹åŠ¨åªæœ‰å‡ è¡Œï¼Œä½†æ˜¯åœ¨æ”¹å®Œæµ‹è¯•çš„è¿‡ç¨‹ä¸­å‘ç°å¾ˆå¤šè¶…å‡ºé¢„æœŸæˆ–è€…è®¤çŸ¥çš„ç°è±¡ï¼Œä¸ºäº†ææ‡‚ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œåˆé‡æ–°æ‹äº†æ‹kubeletæºç ã€‚ åœ¨è¿™ä»¶äº‹ç»“æŸä¹‹åä¹Ÿè¿›è¡Œäº†åæ€ï¼Œä¸»è¦æ˜¯æœ‰å…³æºç é˜…è¯»çš„ï¼Œäºæ˜¯æŠŠè¿™ä¸ªè¿‡ç¨‹å’Œè‡ªå·±çš„æ„Ÿè§¦ä»¥åŠåç»­çš„ä¸€äº›æ”¹è¿›æ–¹æ³•å’Œè®¡åˆ’è®°å½•ä¸‹æ¥ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:0:0","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"è¿‡ç¨‹ å…ˆçœ‹ä¸‹è¿™ä»¶äº‹çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆå¿½ç•¥è¿™ä¸ªéœ€æ±‚çš„åˆç†æ€§ï¼Œç›´æ¥åˆ†ææŠ€æœ¯å®ç°ã€‚ é¦–å…ˆï¼Œkubernetesæœ¬èº«å¹¶ä¸æ”¯æŒä¿®æ”¹Podçš„èµ„æºå±æ€§ï¼Œæ— è®ºRequestè¿˜æ˜¯Limitï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹apiserverä¸­çš„æ ¡éªŒé€»è¾‘æ¥æ”¾å¼€æ­¤é™åˆ¶ï¼› å…¶æ¬¡ï¼Œå¦‚ä½•ä¿è¯åœ¨Requestæ”¹å˜ä¹‹åå®¹å™¨ä¸é‡å¯ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œkubeletä¼šä¸ºæ¯ä¸ªcontaineréƒ½è®¡ç®—å‡ºä¸€ä¸ªhashå€¼ï¼Œå…¶ä¸­ç”¨åˆ°äº†containerçš„æ‰€æœ‰å±æ€§ï¼Œåœ¨è°ƒç”¨docker apiè¿›è¡Œå®¹å™¨åˆ›å»ºçš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªå€¼è®¾ç½®åˆ°å®¹å™¨çš„Labelä¸­ï¼Œåç»­å¦‚æœkubeletæ£€æµ‹åˆ°æ–°è®¡ç®—å‡ºçš„hashå€¼ä¸åœ¨è¿è¡Œçš„å®¹å™¨çš„hashå€¼ä¸åŒï¼Œåˆ™ä¼šè¿›è¡Œå®¹å™¨çš„åŸåœ°é‡å¯æ“ä½œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹containerçš„Imageä¼šå‡ºå‘å®¹å™¨åŸåœ°é‡å¯çš„åŸå› ã€‚å¾ˆæ˜æ˜¾ï¼Œå¦‚æœæ”¾å¼€Requestçš„ä¿®æ”¹ï¼ŒRequestå€¼å˜äº†ä¹‹åä¹Ÿä¼šå¯¼è‡´æ–°çš„hashå€¼å˜åŒ–ä»è€Œå¯¼è‡´å®¹å™¨é‡å»ºï¼Œä¸æˆ‘ä»¬çš„æœŸæœ›ä¸ç¬¦ã€‚ä¹Ÿæœ‰åŠæ³•æ¥è§£å†³ï¼šè®°å½•containeråˆ›å»ºæ—¶çš„Requestå€¼ï¼Œè®¡ç®—çš„æ—¶å€™è¿˜æ˜¯ä½¿ç”¨åˆ›å»ºæ—¶çš„å€¼ï¼Œæ­¤å€¼åªæœ‰åœ¨containeråˆ›å»ºæ—¶ä¼šè®°å½•ï¼Œåç»­ä¸å†æ›´æ–°ã€‚ æµ‹è¯•åœºæ™¯æ˜¯åˆ›å»ºäº†Qosç±»å‹ä¸ºGuaranteed ç±»å‹çš„Podï¼Œæ”¾å¼€äº†kube-apiserverå¯¹Requestä¿®æ”¹çš„é™åˆ¶ï¼Œkubeletä¿æŒåŸç”Ÿä¸åŠ¨ï¼Œè°ƒå°å…¶Requestå€¼ï¼Œå¤§å®¶å¯ä»¥å…ˆå°è¯•è‡ªå·±æ€è€ƒä¸€ä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ é‚£ä¹ˆåœ¨æµ‹è¯•çš„æ—¶å€™é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ é¦–å…ˆï¼Œå‘ç°æ”¾å¼€Requestä¿®æ”¹ä¹‹åï¼Œå¦‚æœæ”¹äº†Requestçš„å€¼ï¼Œå®¹å™¨é‡å¯äº†ï¼ˆè¿™ä¸€æ­¥ç¬¦åˆé¢„æœŸï¼‰ï¼Œä½†æ˜¯é‡å¯æ¬¡æ•°åŠ 2ï¼ˆè¿™é‡Œå…¶å®æ˜¯ä¹‹å‰çš„ä¸€ä¸ªç›²ç‚¹ï¼‰ æ¥ç€ï¼Œç»§ç»­ä¿®æ”¹Requestå€¼ï¼Œå®¹å™¨ä¾ç„¶é‡å¯ï¼ˆç¬¦åˆé¢„æœŸï¼‰ï¼Œä½†æ˜¯æ­¤æ¬¡é‡å¯æ¬¡æ•°åªåŠ äº†1 æœ€åï¼Œé€šè¿‡æŸ¥çœ‹Pod Cgroupç›®å½•ï¼Œç¡®è®¤ä¿®æ”¹åçš„Requestå·²ç»åœ¨Podçº§åˆ«å’ŒContainerçº§åˆ«åˆ†åˆ«ç”Ÿæ•ˆï¼Œä½†æ˜¯åŒæ—¶å­˜åœ¨ä¸¤ä¸ªPodçš„ç›®å½•ï¼Œç±»ä¼¼å¦‚ä¸‹ # ä¿®æ”¹ä¹‹å‰çš„Podå¯¹åº”çš„cgroupç›®å½• /sys/fs/cgroup/cpu/kubepods/guaranteed/pod{uid} # ä¿®æ”¹ä¹‹åçš„Podå¯¹åº”çš„cgroupç›®å½• /sys/fs/cgroup/cpu/kubepods/burstable/pod{uid} ä¸ºä»€ä¹ˆåŒä¸€ä¸ªPodä¼šå­˜åœ¨ä¸¤ä¸ªcgroupç›®å½•å‘¢ï¼Ÿ å®¹å™¨é‡å¯äº†ï¼Œé‡å¯æ¬¡æ•°åº”è¯¥åªåŠ 1ï¼Œé‚£ä¸ºä»€ä¹ˆåœ¨ç¬¬ä¸€æ­¥ä¸­åŠ äº†2ï¼Ÿ ä½ å¯ä»¥åœ¨ç»§ç»­é˜…è¯»ä¹‹å‰å…ˆè‡ªå·±æ€è€ƒä¸€ä¸‹å¯èƒ½çš„åŸå› ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:1:0","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"é—®é¢˜åˆ†æ é¦–å…ˆçœ‹ä¸ºä»€ä¹ˆä¼šæœ‰ä¸¤ä¸ªcgroupç›®å½•ï¼Œéœ€è¦å…ˆææ¸…æ¥šcgroupç›®å½•æ˜¯å¦‚ä½•åˆ›å»ºã€å¦‚ä½•åˆ é™¤çš„ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:2:0","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"Cgorupåˆ›å»º æˆ‘ä»¬é‡‡ç”¨CgroupPerQosçš„æ–¹å¼è¿›è¡Œç®¡ç†ï¼Œä»¥cpuå­ç³»ç»Ÿä¸ºä¾‹ï¼Œå±‚çº§ç±»ä¼¼å¦‚ä¸‹æ‰€ç¤º /sys/fs/cgroup/cpu kubepods guaranteed pod{uid} {containerid} {containerid} pod{uid} {containerid} {containerid} burstable bestaffort ä»åˆ›å»ºè€…çš„è§’åº¦åˆ†ä¸¤ç§ï¼škubeletåˆ›å»ºçš„ã€dockeråˆ›å»ºçš„ã€‚å…¶ä¸­containerå±‚ç”±dockeråˆ›å»ºï¼Œcontainerä»¥ä¸Šçš„podå±‚ã€qoså±‚å’Œrootï¼ˆkubepodsï¼‰éƒ½æ˜¯ç”±kubeletåˆ›å»ºçš„ã€‚é‚£dockeråˆæ˜¯æ€ä¹ˆçŸ¥é“å®¹å™¨çš„cgroup parentç›®å½•æ˜¯è°å‘¢ï¼Ÿå…¶å®æ˜¯kubeletåœ¨è°ƒç”¨docker apiæ—¶ä¼ ç»™dockerçš„ä¸€ä¸ªå‚æ•°ï¼Œå‘Šè¯‰äº†å…¶cgroup parentè·¯å¾„ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œdocker inspect {containerid} | grep -i cgroupæ¥æŸ¥çœ‹æ¯ä¸ªcontainerçš„cgroup parentè·¯å¾„ã€‚ é‚£ä¸ºä»€ä¹ˆä¼šåœ¨ä¸¤ä¸ªqosç›®å½•ä¸‹åˆ†åˆ«å­˜åœ¨ä¸€ä¸ªPodç›®å½•å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº†Podçš„Qosç±»å‹ï¼Œè§¦å‘äº†syncPodé€»è¾‘ï¼Œé‡Œé¢ä¼šå»æ ¹æ®Podçš„qosç±»å‹è¿›è¡Œcgroupç›®å½•åˆ¤æ–­ï¼Œå¦‚æœqosæ”¹å˜ï¼Œåˆ™ä¼šæŠŠåŸPodä¸‹çš„æ‰€æœ‰containerå…¨éƒ¨æ€æ‰ï¼Œç„¶ååˆ›å»ºæ–°çš„cgroupç›®å½•ï¼Œå†å¯åŠ¨å®¹å™¨ã€‚è¿™ä¹Ÿå°±å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆåœ¨ç¬¬ä¸€æ¬¡ä¿®æ”¹Requestä¹‹åPodé‡å¯æ¬¡æ•°å¢åŠ äº†2ï¼Œå› ä¸ºpauseå®¹å™¨ä¹Ÿå‘ç”Ÿäº†é‡å»ºã€‚ä¸ºä»€ä¹ˆè¦é‡å»ºå®¹å™¨å‘¢ï¼Œå› ä¸ºæ•´ä¸ªpodçš„qoså‘ç”Ÿäº†å˜åŒ–ï¼ŒPodå†…çš„æ‰€æœ‰å®¹å™¨éœ€è¦åœ¨æ–°çš„qosç›®å½•ä¸‹é‡å»ºå…¶ç›®å½•ï¼Œä½†æ˜¯kubeletæ²¡æœ‰å»æ›´æ–°containerçš„cgroupè®¾ç½®ï¼Œè€Œæ˜¯é‡‡ç”¨é‡å»ºçš„æ–¹å¼æ¥å®ç°ã€‚ ä¸ºä»€ä¹ˆkubeletä¸ç›´æ¥å»æ›´æ–°cgroupç›®å½•ï¼Œè€Œæ˜¯é‡å»ºå®¹å™¨å‘¢ï¼Ÿé¦–å…ˆä¿®æ”¹Requestä¸ä»…å½±å“cgroupï¼Œå®¹å™¨çš„oomscoreä¹Ÿå°†å—åˆ°å½±å“ï¼Œdockerè™½ç„¶æä¾›äº†apiæ¥ä¿®æ”¹èµ„æºå¤§å°ï¼Œä½†å¹¶æ²¡æœ‰æä¾›ç›¸å…³çš„apiå»è¿›è¡Œcgroupç›®å½•åŠoomscoreç­‰å±æ€§çš„ä¿®æ”¹ï¼Œå…¶æ¬¡cgroupè¿ç§»æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„å·¥ä½œï¼Œè¿ç§»è¿‡ç¨‹ä¼šå‡ºç°éƒ¨åˆ†å†å²æ•°æ®ä¸¢å¤±ç­‰é—®é¢˜ï¼Œæ‰€ä»¥kubeleç›´æ¥é‡‡ç”¨é‡å»ºçš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:2:1","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"Cgroupåˆ é™¤ ç»è¿‡åˆ†æCgroupåˆ›å»ºè¿‡ç¨‹ï¼Œé‡å¯ä¸¤æ¬¡çš„é—®é¢˜å·²ç»æ‰¾åˆ°äº†ç­”æ¡ˆã€‚ä½†ä¸ºä»€ä¹ˆæ–°çš„Pod cgroupç›®å½•åˆ›å»ºå‡ºæ¥ä¹‹åï¼ŒåŸæœ‰çš„ç›®å½•æ²¡æœ‰è¢«åˆ é™¤å‘¢ï¼Ÿè¿™å°±éœ€è¦ææ¸…æ¥šPod Cgroupç›®å½•ä»€ä¹ˆæ—¶å€™åˆ é™¤çš„ï¼Œå®¹å™¨çº§åˆ«çš„cgroupç›®å½•æ˜¯åœ¨å®¹å™¨è¢«åˆ é™¤çš„æ—¶å€™åˆ é™¤çš„ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼ŒPodçº§åˆ«çš„Cgroupç›®å½•æ˜¯å¦ä¹Ÿæ˜¯åœ¨Podåˆ é™¤æ—¶åˆ é™¤çš„å‘¢ï¼Ÿç»è¿‡çœ‹ä»£ç å‘ç°å¹¶ä¸æ˜¯ï¼ŒPodèµ„æºæ¸…ç†æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹ï¼Œå®šæ—¶ç›‘æµ‹Podæ˜¯å¦å·²ç»è®¾ç½®äº†deletionTimestampå±æ€§å’Œå®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œåªæœ‰è®¾ç½®äº†æ­¤å±æ€§çš„Podæ‰æœ‰å¯èƒ½è¢«æ¸…ç†ï¼Œæ¸…ç†çš„è¿‡ç¨‹ä¸­åŒ…å«æŒ‚åœ¨å·ã€Cgroupç­‰èµ„æºï¼Œä¼šä¸€å¹¶æ¸…ç†ã€‚å› ä¸ºä¿®æ”¹Requestçš„è¯·æ±‚æ˜¯ä¸ä¼šå»ç»™Podè®¾ç½®deletionTimestampå±æ€§çš„ï¼Œè¿™å°±å¯¼è‡´Podçº§åˆ«çš„æ—§ç›®å½•ä¸ä¼šè¢«åˆ é™¤ï¼Œåˆå› ä¸ºæ–°ç›®å½•çš„åˆ›å»ºï¼Œå¯¼è‡´åŒæ—¶å­˜åœ¨ä¸¤ä¸ªPodçº§åˆ«çš„ç›®å½•ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:2:2","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"åæ€ ç»¼åˆçœ‹ä¸‹æ¥ï¼Œè¿™ä¸¤ä¸ªç‚¹éƒ½æ²¡æœ‰é‚£ä¹ˆéš¾ï¼Œè€Œä¸”ä¹‹å‰ä¹Ÿåšè¿‡kubeletå®šåˆ¶å¼€å‘ï¼ŒsyncPodéƒ¨åˆ†ä»£ç æ›´æ˜¯çœ‹è¿‡æ•°æ¬¡ã€‚é‚£ä¸ºä»€ä¹ˆèŠ±è´¹äº†è¿™ä¹ˆä¹…çš„æ—¶é—´å‘¢ï¼Ÿ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:3:0","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"æºç é˜…è¯»çš„ç›®çš„æ€§ æ­¤å‰é˜…è¯»æºç çš„ç›®çš„æœ‰å‡ ç§ï¼ŒæŸ¥é—®é¢˜ã€éªŒè¯æŸäº›æƒ³æ³•ã€æ¢å¯»ç³»ç»Ÿè¿è¡ŒåŸç†ï¼Œè¿˜æœ‰ä¸€äº›äººé€šè¿‡çœ‹æºç æ¥å†™blogã€æˆ–è€…å†™æºç åˆ†æä¹‹ç±»çš„ä¹¦ã€‚æ­¤å‰å¤§éƒ¨åˆ†åœºæ™¯æ˜¯ä¸ºäº†æŸ¥é—®é¢˜ã€éªŒè¯æƒ³æ³•ä»¥åŠæŸäº›å°åŠŸèƒ½çš„å®šåˆ¶å¼€å‘ï¼Œå¯ä»¥èšç„¦åˆ°æŸäº›ç‚¹æˆ–æµç¨‹ä¸Šï¼Œåšå®Œä¹‹åä¼šå¯¹ç›¸å…³ç‚¹å°è±¡æ¯”è¾ƒæ·±åˆ»ï¼Œä½†æ˜¯ç›¸å…³æ€§ä¸å¤§çš„åœ°æ–¹å°±ä¼šå¾ˆå®¹æ˜“é—å¿˜ï¼Œæˆ–è€…è¯´æ ¹æœ¬ä¸ä¼šå»åˆ»æ„å…³æ³¨ç›¸å…³æ€§ä¸å¤§çš„åœ°æ–¹ã€‚å¶å°”ä¼šæœ‰æƒ³æ³•å»ä¸»åŠ¨é˜…è¯»æºç ï¼Œæ¢æ±‚ç³»ç»Ÿè¿è¡ŒåŸç†ï¼Œå®ç°æ–¹å¼ï¼Œå†™blogç­‰ï¼Œä½†æœ€ç»ˆå‘ç°æ•ˆæœå¾ˆå·®ï¼Œå› ä¸ºåœ¨æ­¤è¿‡ç¨‹ä¸­æˆ‘ä»¬çš„ç›®çš„æ€§å¹¶ä¸æ˜¯çœŸæ­£çš„å»ç†è§£ç³»ç»Ÿï¼Œç¼ºä¹é’ˆå¯¹æ€§ã€‚è€Œä¸”å¯¹äºåœ¨è¿˜ä¸äº†è§£ç³»ç»Ÿè¿è¡ŒåŸç†çš„æƒ…å†µä¸‹æƒ³é€šè¿‡çœ‹æºç å»äº†è§£å…¶åŸç†å°±æ˜¯æœ¬æœ«å€’ç½®çš„äº‹æƒ…ã€‚æ¯”å¦‚æ¥æ‰‹ä¸€ä¸ªæ–°é¡¹ç›®æˆ–è€…å…¶ä»–äººçš„é¡¹ç›®çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰ç›¸å…³èƒŒæ™¯ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰é¡¹ç›®æ–‡æ¡£ï¼Œæ²¡æœ‰ä»£ç æ³¨é‡Šçš„æƒ…å†µï¼Œç›´æ¥æƒ³é€šè¿‡ä»£ç å»äº†è§£ä¸šåŠ¡å’Œç³»ç»Ÿè¿è¡ŒåŸç†æ˜¯ä¸€ä»¶éå¸¸ç—›è‹¦çš„äº‹æƒ…ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:3:1","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"æ€è€ƒçš„å¿…è¦æ€§ æ— è®ºå¤„äºä»€ä¹ˆç›®çš„å»çœ‹ä»£ç ï¼Œéœ€è¦æœ‰è‡ªå·±çš„æ€è€ƒï¼Œå¯ä»¥å‡è®¾ç³»ç»Ÿç”±è‡ªå·±è®¾è®¡ï¼Œé‚£ä¼šè®¾è®¡æˆä»€ä¹ˆæ ·å­ï¼Œä»£ç ç”±è‡ªå·±å®ç°ï¼Œä¼šå†™æˆä»€ä¹ˆæ ·å­ã€‚åœ¨è®¾è®¡è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œå¸¦ç€é—®é¢˜å†å»çœ‹ä»£ç ï¼Œå»éªŒè¯åˆ«äººæ˜¯å¦‚ä½•è®¾è®¡å¹¶å®ç°çš„ï¼Œå°¤å…¶æ˜¯é‡åˆ°å’Œè‡ªå·±é¢„æœŸè®¾è®¡ä¸ä¸€è‡´çš„åœ°æ–¹ï¼Œå¯ä»¥è¿›è¡Œå¯¹æ¯”ï¼Œåˆ†æé‚£ç§æ–¹æ¡ˆå¥½ï¼Œæˆ–è€…ä»–è¿™ä¹ˆè®¾è®¡æ˜¯å¤„äºä»€ä¹ˆè€ƒè™‘ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå®ç°ã€‚ä»¥è¿™æ ·çš„æ–¹å¼çœ‹ä»£ç è¦æ¯”æ²¡æœ‰ç›®çš„æ€§çš„èµ°é©¬è§‚èŠ±å¼çš„æµè§ˆä»£ç æ”¶è·æ›´å¤šï¼Œå°è±¡æ›´æ·±åˆ»ã€‚è¿™é‡Œæ¨èä¸€æœ¬ä¹¦ã€Šæ€è€ƒï¼Œå¿«ä¸æ…¢ã€‹ï¼Œè§£é‡Šäº†äººçš„å¤§è„‘æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¯ä»¥é€šè¿‡æœ¬ä¹¦äº†è§£åˆ°æ€è€ƒæ˜¯ä¸€ä¸ªæ€æ ·çš„è¿‡ç¨‹ã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:3:2","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":["æ€è€ƒæ„Ÿæ‚Ÿ"],"content":"åç»­è®¡åˆ’ æºç è¿˜æ˜¯è¦å»è¯»çš„ï¼Œåé¢ä¼šè¿›è¡Œä¸€äº›å°è¯•ï¼Œæ ¹æ®ä¸Šé¢æåˆ°çš„é˜…è¯»æ–¹å¼å¼€å§‹è¿›è¡Œï¼Œå³ æ€è€ƒç³»ç»Ÿè¿è¡Œæ–¹å¼ ==ã€‹è‡ªå·±è®¾è®¡ç³»ç»Ÿå®ç° ==ã€‹å¸¦ç€é—®é¢˜è¯»æºç ï¼ˆéªŒè¯æƒ³æ³•ï¼‰ ==ã€‹æ€è€ƒä¸æ€»ç»“ï¼Œè¯•è¿è¡Œä¸€æ®µæ—¶é—´çœ‹çœ‹æ•ˆæœã€‚ ","date":"2021-04-18","objectID":"https://www.likakuli.com/posts/sourcecodereading/:3:3","tags":["æ€è€ƒ"],"title":"å…³äºé˜…è¯»æºç çš„ä¸€äº›æ€è€ƒ","uri":"https://www.likakuli.com/posts/sourcecodereading/"},{"categories":[],"content":"Hiï¼Œæˆ‘æ˜¯ Kaku æé¹¤ï¼Œç›®å‰å°±èŒäºShopeeã€‚å¹¼å„¿å›­å°ç­å·¥ç¨‹å¸ˆï¼Œç»ˆèº«å­¦ä¹ è€…ã€‚ 2016å¹´å¼€å§‹ä»äº‹å®¹å™¨äº‘PAASå¹³å°ç›¸å…³çš„ç ”å‘å·¥ä½œï¼Œä»0åˆ°1æ­å»ºäº†å…¬å¸çº§å®¹å™¨å®¹å™¨äº‘å¹³å°ã€‚ 2018å¹´å¼€å§‹ä¸»è¦ç ”ç©¶å¤§è§„æ¨¡é›†ç¾¤è°ƒåº¦å’Œç®¡ç†ï¼Œ2019å¹´å¼€å§‹è´Ÿè´£æ»´æ»´å¼¹æ€§äº‘å¹³å°åŸºç¡€æ¶æ„æ–¹å‘çš„å·¥ä½œï¼ŒåŒ…æ‹¬å¤§è§„æ¨¡é›†ç¾¤æ”¯æ’‘ã€ç®¡ç†è¿ç»´ã€è°ƒåº¦ä¼˜åŒ–ç­‰å·¥ä½œï¼ŒåŒæ—¶å¯¹çº¿ä¸Šé—®é¢˜æ’æŸ¥ä¸å¤„ç†ä¹Ÿæœ‰ä¸€å®šçš„è¸©å‘ç»éªŒã€‚ ç›®å‰ä¸»è¦å…³æ³¨é¢†åŸŸåœ¨å¤§è§„æ¨¡å®¹å™¨é›†ç¾¤ç®¡ç†ä¸è°ƒåº¦ã€åˆ©ç”¨ebpfæŠ€æœ¯å®ç°è¿è¡ŒçŠ¶æ€çš„å¯è§†åŒ–ã€‚ æ¬¢è¿æ‰«æä¸‹æ–¹äºŒç»´ç å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ITæ•£ä¿®è¿›è¡Œè®¢é˜…ã€‚ä¹Ÿå¯ä»¥é€šè¿‡å¾®ä¿¡å…¬ä¼—å·ç•™è¨€åŒä½œè€…è¿›è¡Œäº¤æµæˆ–è€…ç›´æ¥é€šè¿‡å¾®ä¿¡å…¬ä¼—å·åŠ ä½œè€…å¾®ä¿¡è¿›è¡Œäº¤æµã€‚ ","date":"2021-04-15","objectID":"https://www.likakuli.com/about/:0:0","tags":[],"title":"å…³äºä½œè€…","uri":"https://www.likakuli.com/about/"},{"categories":[],"content":"ç»„ç»‡ï¼šk-cloud-labs é¡¹ç›®ï¼š Kinitiras: é€šç”¨å¯ç¼–ç¨‹ Kubernetes admission webhook è§„åˆ™å¼•æ“ï¼› Pidalio: Kinitiras çš„å®¢æˆ·ç«¯å®ç°ï¼Œ0 ä¾µå…¥ï¼Œé«˜æ€§èƒ½ï¼› Kluster-capacity: é›†ç¾¤å‰©ä½™å®¹é‡è¯„ä¼°ã€æ¨¡æ‹Ÿè°ƒåº¦ã€é›†ç¾¤å‹ç¼©ã€é›†ç¾¤ç¢ç‰‡ç‡ç­‰åˆ†æå·¥å…·ï¼› scheduler-stress-test: è°ƒåº¦å™¨æ€§èƒ½å‹æµ‹å·¥å…·ï¼› æ¬¢è¿å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·è´¡çŒ®~ ","date":"2021-04-15","objectID":"https://www.likakuli.com/projects/:0:0","tags":[""],"title":"ç»„ç»‡é¡¹ç›®ä»‹ç»","uri":"https://www.likakuli.com/projects/"},{"categories":["æºç åˆ†æ"],"content":"å¼€å±€ä¸€å¼ å›¾ï¼Œå‰©ä¸‹å…¨é ç¼– è¯¦ç»†å†…å®¹å‚è€ƒï¼š Informer DeltaFIFO Informer LocalStore æœªå®Œå¾…ç»­ ","date":"2021-03-18","objectID":"https://www.likakuli.com/posts/kubernetes-informer/:0:0","tags":["informer","kubernetes"],"title":"Kubernetes Informer","uri":"https://www.likakuli.com/posts/kubernetes-informer/"},{"categories":["æºç åˆ†æ"],"content":"æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆä¸Šå›¾ï¼Œcacheå¯¹åº”Informerä¸­çš„Local Storeã€‚ ç›´æ¥æ’¸æºç ï¼ˆåŸºäº1.12ç‰ˆæœ¬ï¼Œæœ‰åˆ å‡ï¼Œä¸å½±å“ä¸»è¦é€»è¾‘ï¼‰ // ä»£ç æºè‡ªclient-go/tools/cache/store.go type Store interface { Add(obj interface{}) error Update(obj interface{}) error Delete(obj interface{}) error List() []interface{} ListKeys() []string Get(obj interface{}) (item interface{}, exists bool, err error) GetByKey(key string) (item interface{}, exists bool, err error) // Replace will delete the contents of the store, using instead the // given list. Store takes ownership of the list, you should not reference // it after calling this function. // ç”¨ä¼ å…¥çš„å†…å®¹æ›¿æ¢åŸæœ‰å†…å®¹ Replace([]interface{}, string) error Resync() error } Storeä¸ºæœ€åŸºæœ¬çš„å­˜å‚¨æ¥å£ï¼Œæä¾›å¢åˆ æ”¹æŸ¥åŸºæœ¬åŠŸèƒ½ï¼Œè¦æ±‚å¯¹è±¡æœ‰å”¯ä¸€é”®ï¼Œé”®çš„è®¡ç®—æ–¹å¼ç”±æ¥å£çš„å…·ä½“å®ç°å†³å®šï¼Œå¾ˆå¥½ç†è§£ã€‚ // ä»£ç æºè‡ªclient-go/tools/cache/index.go // Indexer is a storage interface that lets you list objects using multiple indexing functions type Indexer interface { Store // Retrieve list of objects that match on the named indexing function Index(indexName string, obj interface{}) ([]interface{}, error) // IndexKeys returns the set of keys that match on the named indexing function. IndexKeys(indexName, indexKey string) ([]string, error) // ListIndexFuncValues returns the list of generated values of an Index func ListIndexFuncValues(indexName string) []string // ByIndex lists object that match on the named indexing function with the exact key ByIndex(indexNtame, indexKey string) ([]interface{}, error) // GetIndexer return the indexers GetIndexers() Indexers // AddIndexers adds more indexers to this store. If you call this after you already have data // in the store, the results are undefined. AddIndexers(newIndexers Indexers) error } Indexeråœ¨StoreåŸºç¡€ä¸Šæ‰©å±•äº†ç´¢å¼•èƒ½åŠ›ï¼Œå°±å¥½æ¯”ç»™æ•°æ®åº“æ·»åŠ çš„ç´¢å¼•ï¼Œä»¥ä¾¿æŸ¥è¯¢æ›´å¿«ï¼Œé‚£ä¹ˆè‚¯å®šéœ€è¦æœ‰ä¸ªç»“æ„æ¥ä¿å­˜ç´¢å¼• // ä»£ç æºè‡ªclient-go/tools/cache/index.go // IndexFunc knows how to provide an indexed value for an object. type IndexFunc func(obj interface{}) ([]string, error) // Index maps the indexed value to a set of keys in the store that match on that value type Index map[string]sets.String //sets.Stringä¸ºmap[string]struct{}ç±»å‹ï¼Œå‡å°‘å†…å­˜å ç”¨ // Indexers maps a name to a IndexFunc type Indexers map[string]IndexFunc // Indices maps a name to an Index type Indices map[string]Index åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ä¸€è„¸æ‡µé€¼ï¼Ÿï¼Ÿï¼ï¼ï¼Œå…‰çœ‹æ³¨é‡Šæ ¹æœ¬ä¸çŸ¥é“è¿™æ˜¯è¦å¹²å•¥ã€‚ç»è¿‡æœç´¢å‘ç°client-goé‡Œåªç”¨åˆ°äº†ä¸€ä¸ªIndexFuncï¼Œå³MetaNamespaceIndexFuncï¼Œå¯¹åº”çš„IndexNameä¸ºnamespaceï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Indexersæ€»æ˜¯è¿™ä¸ªå€¼{â€œnamespaceâ€:MetaNamespaceIndexFunc}ï¼Œä¸¾ä¸ªæ —å­ï¼š å‡å¦‚æˆ‘è¦ä»Storeä¸­è·å–Keyä¸ºdefault/test-appçš„Podä¿¡æ¯ï¼Œé‚£ä¹ˆä¸Šé¢çš„ä¸‰ä¸ªmapä¸­çš„å†…å®¹åˆ†åˆ«ä¸º Indexers: {â€œnamespaceâ€:MetaNamespaceIndexFunc} Index:{â€œdefaultâ€:{â€œdefault/test-appâ€:}} Indices: {â€œnamespaceâ€:{â€œdefaultâ€:{â€œdefault/test-appâ€:}}} å¦‚æœè¿˜æ˜¯ä¸æ‡‚ï¼Œå°±å…ˆå¾€ä¸‹çœ‹ï¼Œçœ‹Indexerçš„å…·ä½“å®ç° // ä»£ç æºè‡ªclient-go/tools/cache/store.go type cache struct { // cacheStorage bears the burden of thread safety for the cache cacheStorage ThreadSafeStore // keyFunc is used to make the key for objects stored in and retrieved from items, and // should be deterministic. keyFunc KeyFunc } // KeyFunc knows how to make a key from an object. Implementations should be deterministic. type KeyFunc func(obj interface{}) (string, error) // ä»£ç æºè‡ªclient-go/tools/cache/thread_safe_store.go type ThreadSafeStore interface { Add(key string, obj interface{}) Update(key string, obj interface{}) Delete(key string) Get(key string) (item interface{}, exists bool) List() []interface{} ListKeys() []string Replace(map[string]interface{}, string) Index(indexName string, obj interface{}) ([]interface{}, error) IndexKeys(indexName, indexKey string) ([]string, error) ListIndexFuncValues(name string) []string ByIndex(indexName, indexKey string) ([]interface{}, error) GetIndexers() Indexers // AddIndexers adds more indexers to this store. If you call this after you already have data // in the store, the results are undefined. AddIndexers(newIndexers Indexers) error Resync() error } // threadSafeMap implements ThreadSafeStore type threadSafeMap struct { lock sync.RWMutex items map[string]interface{} // indexers maps a name to an IndexFunc indexers Indexers // indices maps a name to an Index indices Indices } ä¸Šé¢ä»£ç å¾ˆå¥½ç†è§£ï¼Œcacheä¸»è¦ç”±çº¿ç¨‹å®‰å…¨çš„map[string]interface{}å®ç°ï¼ŒGoçš„","date":"2021-03-18","objectID":"https://www.likakuli.com/posts/kubernetes-informer-localstore/:0:0","tags":["informer","kubernetes"],"title":"Informer LocalStoreæºç è§£æ","uri":"https://www.likakuli.com/posts/kubernetes-informer-localstore/"},{"categories":["æºç åˆ†æ"],"content":"æ€»ç»“ ä¼šä¸ä¼šæœ‰äººæœ‰ç–‘é—®ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜åœ¨ä¸€ä¸ªç´¢å¼•é”®ä¸‹é¢ï¼Œè¿™æ ·çš„æ•ˆç‡å²‚ä¸æ˜¯å¤ªä½äº†?å…¶å®client-goä¸ºæ¯ç±»å¯¹è±¡éƒ½åˆ›å»ºäº†Informer(Informerå†…æœ‰Indexer)ï¼Œæ‰€ä»¥å­˜å‚¨åœ¨ç›¸åŒç´¢å¼•å»ºä¸‹çš„å¯¹è±¡éƒ½æ˜¯åŒä¸€ç±»ï¼Œè¿™ä¸ªé—®é¢˜è‡ªç„¶ä¹Ÿå°±æ²¡æœ‰äº†ã€‚cacheå°±ç±»ä¼¼æ•°æ®åº“çš„Tableï¼Œè€Œä¸”å¸¦äº†ç´¢å¼•åŠŸèƒ½ï¼Œå¯ä»¥è¯•æƒ³ä¸€ä¸‹è‡ªå·±æƒ³è¦å®ç°ä¸€ä¸ªå¸¦ç´¢å¼•åŠŸèƒ½çš„ç¼“å­˜çš„è¯ï¼Œæ€ä¹ˆè®¾è®¡æ•°æ®ç»“æ„ å¯¹è±¡å¦‚ä½•å­˜å‚¨ï¼Ÿæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å”¯ä¸€é”®ï¼Œé€šè¿‡KeyFuncè®¡ç®—å‡ºæ¥ï¼Œä¸åŒå¯¹è±¡çš„é”®ä¸é‡å¤ï¼Œå¯ä»¥ç”¨mapå®ç°ï¼Œå¯¹åº”ä¸Šé¢çš„ThreadSafeMap ç´¢å¼•ç­–ç•¥æœ‰å“ªäº›ï¼Ÿç”¨map[string]Funcå®ç°ï¼Œkeyä»£è¡¨è¯¥ç´¢å¼•ç­–ç•¥åå­—ï¼ŒFuncä¸ºç­–ç•¥ï¼Œä¼ å…¥å¯¹è±¡ï¼Œè¿”å›å¯¹è±¡åœ¨è¯¥ç­–ç•¥ä¸‹çš„ç´¢å¼•å€¼ï¼Œæ¯”å¦‚keyä¸ºnamespaceï¼ŒFunc(obj)çš„è¿”å›å€¼å°±æ˜¯è¯¥objçš„namespaceï¼Œå¦‚defaultï¼Œè¿™é‡Œè¦æ³¨æ„ï¼ŒFuncåº”è¯¥è¿”å›æ•°ç»„ï¼Œä¾‹å¦‚å¦‚æœç­–ç•¥ä¸ºLabelï¼Œä¸€ä¸ªå¯¹è±¡çš„Labelæ˜¯æœ‰å¤šä¸ªçš„ï¼Œç´¢å¼•å€¼å°±ä¼šæœ‰å¤šä¸ªï¼Œå¯¹åº”ä¸Šé¢çš„Indexers ç´¢å¼•å€¼å’Œå¯¹è±¡çš„å…³ç³»å¦‚ä½•å­˜å‚¨ï¼Ÿä¸€ä¸ªç´¢å¼•å€¼å¯èƒ½å›åº”å¤šä¸ªå¯¹è±¡ï¼Œå¦‚æŒ‰ç…§Labelç´¢å¼•ï¼Œéœ€è¦ä¸€ä¸ªmapæ¥å­˜å‚¨ï¼Œkeyä¸ºç´¢å¼•çš„å€¼ï¼Œå€¼ä¸ºå¯¹è±¡é›†åˆï¼Œä½†æ˜¯å› ä¸ºå¯¹è±¡æœ‰å”¯ä¸€é”®ï¼Œæ‰€ä»¥å€¼å¯ä»¥ç”¨å¯¹è±¡çš„å”¯ä¸€é”®çš„é›†åˆæ¥å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œä½†æ˜¯è¿™ç§æ•°æ®ç»“æ„åœ¨æŸ¥è¯¢æŸä¸ªå¯¹è±¡æ˜¯å¦æ»¡è¶³æŒ‡å®šçš„ç´¢å¼•å€¼æ—¶éœ€è¦éå†å€¼çš„é›†åˆï¼Œå¾ˆç®€å•å—ï¼Œå€¼ä¹Ÿç”¨mapæ¥å¯¸å°±å¯ä»¥äº†ï¼Œkeyä¸ºå¯¹è±¡çš„é”®ï¼Œå€¼ä¸ºç©ºç»“æ„ä½“ï¼Œå³å€¼å¾—ç±»å‹ä¸ºmap[string]struct{}ï¼Œå¯¹åº”sets.Stringï¼Œæ•´ä¸ªæ•°æ®ç»“æ„å¯¹åº”ä¸Šé¢çš„Index ç´¢å¼•ç­–ç•¥å’Œç´¢å¼•å€¼çš„å…³ç³»å¦‚ä½•å­˜å‚¨ï¼Ÿå¾ˆç®€å•ï¼Œä¸€ä¸ªmapå°±æå®šäº†ï¼Œkeyä¸ºç­–ç•¥åå­—ï¼Œvalueä¸ºIndexï¼Œå¯¹åº”ä¸Šé¢çš„Indices ä¸Šé¢åŸºæœ¬å¯ä»¥å®ç°åŠŸèƒ½äº†ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯ä»¥è€ƒè™‘çš„é—®é¢˜ï¼šè®¡ç®—å¯¹è±¡å”¯ä¸€é”®çš„æ–¹æ³•ã€ç´¢å¼•ç›¸å…³çš„ä¸‰ä¸ªæ•°æ®ç»“æ„æ”¾åœ¨å“ªé‡Œï¼Œk8sçš„å®ç°é‡Œï¼ŒKeyFuncæ˜¯è°ƒç”¨è€…å’Œcacheéƒ½çŸ¥é“å…·ä½“çš„ç®—æ³•ï¼Œç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„éƒ½æ”¾åœ¨äº†threadSafeMapé‡Œã€‚ ","date":"2021-03-18","objectID":"https://www.likakuli.com/posts/kubernetes-informer-localstore/:1:0","tags":["informer","kubernetes"],"title":"Informer LocalStoreæºç è§£æ","uri":"https://www.likakuli.com/posts/kubernetes-informer-localstore/"},{"categories":["æºç åˆ†æ"],"content":"DeltaFIFOä½äºReflectorå’ŒLocalStoreä¹‹é—´ï¼Œçœ‹åå­—çŸ¥é“æ˜¯ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œä½œç”¨å°±æ˜¯ç¼“å­˜æ•°æ®å˜åŒ–ï¼Œç›´æ¥çœ‹ä»£ç  // ä»£ç æºè‡ªclient-go/tools/cache/delta_fifo.go type DeltaFIFO struct { // lock/cond protects access to 'items' and 'queue'. // è¯»å†™é”ï¼Œæ€§èƒ½è¦æ¯”Mutexå¥½ lock sync.RWMutex // ä¾›popå‡½æ•°ä½¿ç”¨ï¼Œæ²¡æœ‰å¯¹è±¡çš„æ—¶å€™å¯ä»¥é˜»å¡ cond sync.Cond // We depend on the property that items in the set are in // the queue and vice versa, and that all Deltas in this // map have at least one Delta. // æ³¨æ„mapå€¼ç±»å‹ä¸ºDeltasï¼ŒDeltaFIFOç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚æœåŒä¸€ä¸ªç›®æ ‡çš„é¢‘ç¹æ“ä½œï¼Œå‰é¢æ“ä½œè¿˜ç¼“å­˜åœ¨é˜Ÿåˆ—ä¸­çš„æ—¶å€™ï¼Œé‚£ä¹ˆé˜Ÿåˆ—å°±è¦ç¼“å†²å¯¹è±¡çš„æ‰€æœ‰æ“ä½œ // queueé‡Œå­˜çš„æ˜¯mapçš„keysï¼Œç”¨mapå®ç°é«˜é€ŸæŸ¥è¯¢ï¼Œç”¨sliceä¿è¯æœ‰åº items map[string]Deltas queue []string // ä¸‹é¢ä¸¤ä¸ªå±æ€§ç”¨æ¥åˆ¤æ–­æ˜¯å¦å·²å®ŒæˆåŒæ­¥ï¼Œ // populated is true if the first batch of items inserted by Replace() has been populated // or Delete/Add/Update was called first. populated bool // initialPopulationCount is the number of items inserted by the first call of Replace() initialPopulationCount int // keyFunc is used to make the key used for queued item // insertion and retrieval, and should be deterministic. keyFunc KeyFunc // knownObjects list keys that are \"known\", for the // purpose of figuring out which items have been deleted // when Replace() or Delete() is called. // è¿™é‡Œå…¶å®å°±æ˜¯Indexer knownObjects KeyListerGetter // Indication the queue is closed. // Used to indicate a queue is closed so a control loop can exit when a queue is empty. // Currently, not used to gate any of CRED operations. closed bool closedLock sync.Mutex } // ä»£ç æºè‡ªclient-go/tools/cache/delta_fifo.go type Delta struct { Type DeltaType Object interface{} // å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯k8sé‡Œçš„èµ„æº } type DeltaType string // Deltaçš„ç±»å‹ç”¨å­—ç¬¦ä¸²è¡¨è¾¾ const ( Added DeltaType = \"Added\" // å¢åŠ  Updated DeltaType = \"Updated\" // æ›´æ–° Deleted DeltaType = \"Deleted\" // åˆ é™¤ Sync DeltaType = \"Sync\" // åŒæ­¥ ) type Deltas []Delta // Deltaæ•°ç»„ Deltaå°±æ˜¯æ•°æ®çš„å˜åŒ–ï¼Œç”¨å­—å…¸å­˜å‚¨è¾¾åˆ°æ›´å¿«çš„æ£€ç´¢é€Ÿåº¦ï¼Œè€Œä¸”Deltasæ˜¯è¦æ±‚æœ‰åºçš„ï¼Œè€Œå­—å…¸çš„éå†æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥ç”¨sliceä¿å­˜keyçš„é›†åˆï¼Œä»¥è¾¾åˆ°å…ˆè¿›å…ˆå‡ºæ•ˆæœã€‚ç»“åˆä¸Šå›¾æ¥çœ‹ï¼ŒDeltaFIFOå°±æ˜¯ä¸€ä¸ªç”¨æ¥å­˜å‚¨kubernetesèµ„æºå˜åŒ–çš„å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ã€‚DeltaFIFOé˜Ÿåˆ—åŠŸèƒ½æ˜¯é€šè¿‡å®ç°å¦‚ä¸‹æ¥å£å®ç°çš„ // ä»£ç æºè‡ªclient-go/tools/cache/fifo.go type Queue interface { // å­˜å‚¨æ¥å£ï¼Œå†Indexeråˆ†æè¿‡äº† Store // Pop blocks until it has something to process. // It returns the object that was process and the result of processing. // The PopProcessFunc may return an ErrRequeue{...} to indicate the item // should be requeued before releasing the lock on the queue. // popåœ¨å¯¹åˆ—ä¸ºç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼Œå°±æ˜¯é€šè¿‡ä¸Šé¢æåˆ°çš„sync.Condå®ç°çš„ // å…·ä½“å¼¹å‡ºçš„å¯¹è±¡æ˜¯é€šè¿‡ä¼ å…¥çš„PopProcessFuncå¤„ç†çš„ï¼Œå¤„ç†å®Œè¿”å›é”™è¯¯åï¼Œå¯èƒ½ä¼šå†å…¥å¯¹åˆ— Pop(PopProcessFunc) (interface{}, error) // AddIfNotPresent adds a value previously // returned by Pop back into the queue as long // as nothing else (presumably more recent) // has since been added. AddIfNotPresent(interface{}) error // HasSynced returns true if the first batch of items has been popped HasSynced() bool // Close queue Close() } ä»è¿™ä¸ªæ¥å£å¯ä»¥çœ‹å‡ºï¼Œå…¶å®Queueä¹Ÿæ˜¯ä¸€ä¸ªStoreï¼Œåªä¸è¿‡æ·»åŠ äº†Popçš„æ“ä½œï¼Œå¯ä»¥å°†å¯¹è±¡æœ‰åºå¼¹å‡ºï¼Œå¯¹æ¯”Indexerï¼ŒIndexeræ˜¯åœ¨StoreåŸºç¡€ä¸Šå¢åŠ äº†ç´¢å¼•ï¼Œæ‰€ä»¥ä¸€ä¸ªå½“åšå¯¹åˆ—ç”¨ï¼Œä¸€ä¸ªå½“åšå­˜å‚¨ç”¨ã€‚ æ¥ç€çœ‹DeltaFIFOå…·ä½“å®ç°ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ // ä»£ç æºè‡ªclient-go/tools/cache/delta_fifo.go // æ·»åŠ å¯¹è±¡æ¥å£ func (f *DeltaFIFO) Add(obj interface{}) error { f.lock.Lock() defer f.lock.Unlock() f.populated = true // é˜Ÿåˆ—ç¬¬ä¸€æ¬¡å†™å…¥æ“ä½œéƒ½è¦è®¾ç½®æ ‡è®° return f.queueActionLocked(Added, obj) } // æ›´æ–°å¯¹è±¡æ¥å£ func (f *DeltaFIFO) Update(obj interface{}) error { f.lock.Lock() defer f.lock.Unlock() f.populated = true // é˜Ÿåˆ—ç¬¬ä¸€æ¬¡å†™å…¥æ“ä½œéƒ½è¦è®¾ç½®æ ‡è®° return f.queueActionLocked(Updated, obj) } // åˆ é™¤å¯¹è±¡æ¥å£ func (f *DeltaFIFO) Delete(obj interface{}) error { id, err := f.KeyOf(obj) if err != nil { return KeyError{obj, err} } f.lock.Lock() defer f.lock.Unlock() f.populated = true // é˜Ÿåˆ—ç¬¬ä¸€æ¬¡å†™å…¥æ“ä½œéƒ½è¦è®¾ç½®æ ‡è®° // æ­¤å¤„æ˜¯éœ€è¦æ³¨æ„çš„ï¼ŒknownObjectså°±æ˜¯Indexerï¼Œé‡Œé¢å­˜æœ‰å·²çŸ¥å…¨éƒ¨çš„å¯¹è±¡ if f.knownObjects == nil { // åœ¨æ²¡æœ‰Indexerçš„æ¡ä»¶ä¸‹åªèƒ½é€šè¿‡è‡ªå·±å­˜å‚¨çš„å¯¹è±¡æŸ¥ä¸€ä¸‹ if _, exists := f.items[id]; !exists { return nil } } else { // è‡ªå·±å’ŒIndexeré‡Œé¢æœ‰ä»»ä½•ä¸€ä¸ªæœ‰è¿™ä¸ªå¯¹è±¡å¤šç®—å­˜åœ¨ _, exists, err := f.knownObjects.GetByKey(id) _, itemsExist := f.items[id] if err == nil \u0026\u0026 !exists \u0026\u0026 !itemsExist { return nil } } return f.queueActionLocked(Deleted, obj) } // åˆ—ä¸¾å¯¹è±¡é”®æ¥å£ func (f *DeltaFIFO) ListKeys() []string { f.lock.RLock() defer f.lock.RUnlock() list := make([]string, 0, len(f.items)) for key := range f.items { list = append(list, key) } return list } // åˆ—ä¸¾å¯¹è±¡æ¥å£ func (f *DeltaFIFO) List() []","date":"2021-03-18","objectID":"https://www.likakuli.com/posts/kubernetes-informer-deltafifo/:0:0","tags":["informer","kubernetes"],"title":"Informer DeltaFIFOæºç è§£æ","uri":"https://www.likakuli.com/posts/kubernetes-informer-deltafifo/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"cgroup mount destination: unknown","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-cgroup-unknown/","tags":["linux","cgroup","docker"],"title":"cgroup mount destination: unknown","uri":"https://www.likakuli.com/posts/docker-cgroup-unknown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜ çº¿ä¸Šk8sé›†ç¾¤åœ¨è¿›è¡Œå®¹å™¨åˆ›å»ºæ—¶æŠ¥å¦‚ä¸‹é”™è¯¯ Failed create pod sandbox: rpc error: code = Unknown desc = failed to start sandbox container for pod â€œxxx-sf-32c80-0â€: Error response from daemon: cgroups: cannot find cgroup mount destination: unknown ä¹‹å‰é‡åˆ°è¿‡cgroupç›¸å…³é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªé—®é¢˜è¿˜æ˜¯å¤´ä¸€æ¬¡è§ï¼Œç½‘ä¸Šæœç´¢äº†å…³é”®å­—ï¼Œç¤¾åŒºæœ‰ç±»ä¼¼æŠ¥é”™çš„issueï¼Œå¦‚cgroups: cannot found cgroup mount destination: unknownï¼Œè”ç³»æœ€è¿‘åšè¿‡çš„çº¿ä¸Šå˜æ›´åŠé—®é¢˜ï¼Œæ€€ç–‘è·ŸæŸè‡ªå®šä¹‰ç»„ä»¶æœ‰å…³ï¼Œè¯¦ç»†èƒŒæ™¯å‚è€ƒè¿™ç¯‡ã€‚ ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-cgroup-unknown/:0:1","tags":["linux","cgroup","docker"],"title":"cgroup mount destination: unknown","uri":"https://www.likakuli.com/posts/docker-cgroup-unknown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥è¿‡ç¨‹ å…‰çœ‹é—®é¢˜äº‘é‡Œé›¾é‡Œçš„ï¼ŒåªçŸ¥é“å’Œcgroupæœ‰å…³ï¼Œç™»é™†å®¿ä¸»æŸ¥çœ‹æ­¤é”™è¯¯æ˜¯kubeletè¯·æ±‚dockeræ—¶dockerè¿”å›çš„ï¼Œdocker 18.06ç‰ˆæœ¬ï¼Œæ²¡æœ‰æ›´è¯¦ç»†çš„æ—¥å¿—äº†ï¼Œä½†æ˜¯å¼€æºçš„ä¸€ä¸ªå¥½å¤„åœ¨äºæŸ¥é—®é¢˜çš„æ—¶å€™æœ‰æºç ï¼Œè¿™å¤§å¤§é™ä½äº†æŸ¥é—®é¢˜çš„éš¾åº¦ï¼Œç›´æ¥å»dockeré¡¹ç›®ä¸­æœç´¢å…³é”®è¯ï¼Œæœ€ç»ˆå‘ç°æ˜¯åœ¨containerdçš„æºç ä¸­ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ // PidPath will return the correct cgroup paths for an existing process running inside a cgroup // This is commonly used for the Load function to restore an existing container func PidPath(pid int) Path { p := fmt.Sprintf(\"/proc/%d/cgroup\", pid) paths, err := parseCgroupFile(p) if err != nil { return errorPath(errors.Wrapf(err, \"parse cgroup file %s\", p)) } return existingPath(paths, \"\") } func existingPath(paths map[string]string, suffix string) Path { // localize the paths based on the root mount dest for nested cgroups for n, p := range paths { dest, err := getCgroupDestination(string(n)) if err != nil { return errorPath(err) } rel, err := filepath.Rel(dest, p) if err != nil { return errorPath(err) } if rel == \".\" { rel = dest } paths[n] = filepath.Join(\"/\", rel) } return func(name Name) (string, error) { root, ok := paths[string(name)] if !ok { if root, ok = paths[fmt.Sprintf(\"name=%s\", name)]; !ok { return \"\", fmt.Errorf(\"unable to find %q in controller set\", name) } } if suffix != \"\" { return filepath.Join(root, suffix), nil } return root, nil } } func getCgroupDestination(subsystem string) (string, error) { f, err := os.Open(\"/proc/self/mountinfo\") if err != nil { return \"\", err } defer f.Close() s := bufio.NewScanner(f) for s.Scan() { fields := strings.Split(s.Text(), \" \") if len(fields) \u003c 10 { // broken mountinfo? continue } if fields[len(fields)-3] != \"cgroup\" { continue } for _, opt := range strings.Split(fields[len(fields)-1], \",\") { if opt == subsystem { return fields[3], nil } } } if err := s.Err(); err != nil { return \"\", err } return \"\", ErrNoCgroupMountDestination } func parseCgroupFile(path string) (map[string]string, error) { f, err := os.Open(path) if err != nil { return nil, err } defer f.Close() return parseCgroupFromReader(f) } func parseCgroupFromReader(r io.Reader) (map[string]string, error) { var ( cgroups = make(map[string]string) s = bufio.NewScanner(r) ) for s.Scan() { if err := s.Err(); err != nil { return nil, err } var ( text = s.Text() parts = strings.SplitN(text, \":\", 3) ) if len(parts) \u003c 3 { return nil, fmt.Errorf(\"invalid cgroup entry: %q\", text) } for _, subs := range strings.Split(parts[1], \",\") { if subs != \"\" { cgroups[subs] = parts[2] } } } return cgroups, nil } é€»è¾‘æ¯”è¾ƒæ¸…æ™°ï¼Œå…ˆä»/proc/id/cgroupä¸­è§£æå¾—åˆ°æ‰€æœ‰çš„subsystemï¼Œå¯¹åº”ä¸Šé¢parseCgroupFromReaderå‡½æ•°ï¼Œ/proc/id/cgroupå†…å®¹å¦‚ä¸‹ å…ˆæŒ‰å†’å·åˆ†éš”æ¯è¡Œå­—ç¬¦ä¸²ï¼Œç„¶åå–ç¬¬2åˆ—ï¼Œå†æ ¹æ®é€—å·åˆ†éš”å¾—åˆ°æ‰€æœ‰çš„å­ç³»ç»Ÿï¼Œæœ€ç»ˆè¿”å›æ‰€æœ‰å­ç³»ç»Ÿã€‚ç„¶åè°ƒç”¨existingPathæ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­ç³»ç»Ÿéƒ½å­˜åœ¨ï¼Œå†…éƒ¨åˆè°ƒç”¨getCgroupDestinationï¼Œæœ€ç»ˆçš„æŠ¥é”™å°±æ˜¯åœ¨è¿™ä¸ªå‡½æ•°é‡ŒæŠ¥å‡ºæ¥çš„ã€‚ getCgroupDestinationçš„é€»è¾‘æ˜¯è¯»å–/proc/id/mountinfoä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦ä¼ å…¥çš„å­ç³»ç»Ÿå­˜åœ¨ å…ˆæ ¹æ®ç©ºæ ¼åˆ†éš”ï¼Œæ‰¾åˆ°æ‰€æœ‰cgroupç±»å‹çš„ç›®å½•ï¼Œç„¶åå†æ ¹æ®é€—å·åˆ†éš”éå†æ‰€æœ‰çš„å­ç³»ç»Ÿæ˜¯å¦æ˜¯ä¼ å…¥çš„å­ç³»ç»Ÿã€‚æ‰¾ä¸åˆ°çš„è¯å°±ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¸å¾—ä¸åæ§½çš„å°±æ˜¯è¿™ä¸ªæŠ¥é”™æŠ¥çš„å¤ªæ²¡æœ‰è¯šæ„äº†ï¼Œè¦æ˜¯ç›´æ¥æŠŠæ‰¾ä¸åˆ°çš„å­ç³»ç»ŸæŠ¥å‡ºæ¥ï¼Œé—®é¢˜ä¼šç›´è§‚å¾ˆå¤šã€‚ ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-cgroup-unknown/:0:2","tags":["linux","cgroup","docker"],"title":"cgroup mount destination: unknown","uri":"https://www.likakuli.com/posts/docker-cgroup-unknown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ç»“è®º åˆ°æ­¤å¯ä»¥æ˜ç™½æ˜¯agentéš”ç¦»ç¨‹åºå…ˆmountäº†è‡ªå®šä¹‰ç›®å½•cpu_mirroråˆ°cgroupç›®å½•ä¸‹ï¼Œç„¶åå½±å“åˆ°äº†javaç¨‹åºå»è·å–æ­£ç¡®çš„æ ¸æ•°ï¼Œä¸ºäº†ä¿®å¤ç‰¹æ„æ‰§è¡Œäº†umountçš„æ“ä½œï¼Œä½†æ˜¯umountä¹‹å/proc/id/cgroupè¿˜æ˜¯å­˜åœ¨cpu_mirrorç›¸å…³ä¿¡æ¯è€Œ/proc/id/mountinfoä¸­å·²ç»ä¸å­˜åœ¨äº†ï¼Œåœ¨å®¹å™¨é‡æ–°åˆ›å»ºçš„æ—¶å€™è¿›è¡Œæ£€æŸ¥è¿›è€ŒæŠ¥é”™ã€‚ å¯¹æ¯”çº¿ä¸Šå…¶ä»–dockerç‰ˆæœ¬ï¼Œæ¯”å¦‚1.13.1ä¸­å°±æ²¡æœ‰æ­¤é—®é¢˜ï¼Œå› ä¸º1.13.1ç”¨çš„containerdä¸­å¹¶æ²¡æœ‰ä¸Šé¢æåˆ°çš„æ£€éªŒé€»è¾‘ é€šè¿‡è¿™ä¸ªé—®é¢˜ä¹Ÿæš´éœ²å‡ºæ¥æˆ‘ä»¬åœ¨æµ‹è¯•ã€ç°åº¦è¿‡ç¨‹ä¸­çš„é—®é¢˜ï¼Œç”±äºçº¿ä¸Šç¯å¢ƒå¤æ‚ï¼Œç³»ç»Ÿç‰ˆæœ¬ä¼—å¤šã€ç»„ä»¶ç‰ˆæœ¬ä¹Ÿä¸ç»Ÿä¸€ï¼Œåœ¨ä¸Šçº¿ä¸€ä¸ªåŠŸèƒ½æˆ–è€…æ‰§è¡Œçº¿ä¸Šæ“ä½œçš„æ—¶å€™ï¼Œæµ‹è¯•ç”¨ä¾‹éœ€è¦å……åˆ†è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œç°åº¦æ—¶ä¹Ÿéœ€è¦æ‰€æœ‰ç±»å‹çš„æœºå™¨è‡³å°‘éƒ½è¦†ç›–åˆ°äº†ä¹‹åæ‰å¯ä»¥æ”¾é‡ç»§ç»­é æ‰©å¤§ç°åº¦èŒƒå›´ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å‡ºç°ç±»ä¼¼çš„é—®é¢˜ã€‚ ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-cgroup-unknown/:0:3","tags":["linux","cgroup","docker"],"title":"cgroup mount destination: unknown","uri":"https://www.likakuli.com/posts/docker-cgroup-unknown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ å®¹å™¨åŸç”Ÿè®¾è®¡ä¸ºå•è¿›ç¨‹æ¨¡å‹ï¼Œä½†å…¬å¸çº¿ä¸Šè¿è¡Œçš„æœåŠ¡ä»¥å¤šè¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œè€Œä¸”é‡Œé¢åŒ…å«äº†å¾ˆå¤šçš„agentï¼Œä¾‹å¦‚æ—¥å¿—é‡‡é›†ã€ç›‘æ§é‡‡é›†ã€æ•°æ®é…é€ç­‰ï¼Œè€¦åˆåœ¨äº†ä¸€ä¸ªContainerä¸­ï¼Œç»è¿‡å¯¹çº¿ä¸Šèµ„æºä½¿ç”¨ç‡åˆ†æå‘ç°å¾ˆå¤§ä¸€éƒ¨åˆ†èµ„æºæ¶ˆè€—æ˜¯åœ¨agentéƒ¨åˆ†ï¼Œè€Œä¸”ä¸ä¸šåŠ¡è¿›ç¨‹åŒæ—¶äº‰æŠ¢ä¸šåŠ¡å®¹å™¨ç”³è¯·çš„èµ„æºï¼Œå½¼æ­¤å½±å“ã€‚è™½ç„¶å¢é‡çš„å®¹å™¨éƒ¨åˆ†agentè¿ç§»åˆ°äº†sidecaré‡Œé¢ï¼Œè§£å†³äº†è¿™äº›é—®é¢˜ï¼Œä½†å­˜é‡é—®é¢˜ä¹Ÿéœ€è¦è§£å†³ï¼Œä¸ºæ­¤ä¸“é—¨æäº†ä¸€ä¸ªé¡¹ç›®ç”¨æ¥ä¼˜åŒ–è¿™äº›é—®é¢˜ã€‚æ€æƒ³å°±æ˜¯æŠŠagentè¿›ç¨‹ä»ä¸šåŠ¡è¿›ç¨‹æ‰€åœ¨çš„cgroupä¸­è¿ç§»å‡ºå»ï¼Œä»¥ä¸åŒcgroupå±‚çº§å­˜åœ¨ï¼Œå°±å¯ä»¥é¿å…ç›¸äº’å½±å“ï¼Œä¹Ÿå¯ä»¥é™åˆ¶å„è‡ªèµ„æºå¤§å°ï¼Œä½†æ˜¯åœ¨ç°åº¦è¿‡ç¨‹ä¸­å‘ç°éƒ¨åˆ†Javaå®¹å™¨æœåŠ¡å¼€å§‹å‡ºç°æ¯›åˆºã€‚ ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-java-cpu/:0:1","tags":["docker","ä¸Šäº‘"],"title":"JavaæœåŠ¡çªç°æ¯›åˆº","uri":"https://www.likakuli.com/posts/docker-java-cpu/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥è¿‡ç¨‹ javaæœåŠ¡æ¯›åˆºé—®é¢˜åœ¨æœ€æ—©ä¸Šäº‘çš„æ—¶å€™å°±å‡ºç°è¿‡ï¼Œå½“æ—¶æ˜¯å› ä¸ºjdkç‰ˆæœ¬å¤ªä½ï¼Œåœ¨å®¹å™¨å†…è¿è¡Œæ—¶æ— æ³•æ­£ç¡®è·å–å®¹å™¨ç”³è¯·çš„cpuå¤§å°ï¼Œå¯¼è‡´åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´å®¹å™¨å†…çš„è¿›ç¨‹å†…éƒ¨äº‰æŠ¢è¿‡é«˜ï¼Œä¸šåŠ¡å¼€å§‹å‡ºç°æ¯›åˆºã€‚åœ¨æŸä¸ªç‰ˆæœ¬ï¼ˆjdk8u191ï¼‰ä¹‹åï¼Œå¼€å‘è€…å®Œå…¨ä¸éœ€è¦å…³æ³¨ç¨‹åºæ˜¯è¿è¡Œåœ¨ç‰©ç†æœºè¿˜æ˜¯å®¹å™¨ç¯å¢ƒä¸‹ã€‚ å¯¹æ¯”æœ‰é—®é¢˜çš„å®¹å™¨å†…çš„ä¸šåŠ¡è¿›ç¨‹ä½¿ç”¨çš„jdkç‰ˆæœ¬ï¼Œç»“æœï¼ˆ202 \u003e 191ï¼‰å±…ç„¶æ˜¯æ²¡é—®é¢˜çš„ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯å·²ç»å¯ä»¥è‡ªåŠ¨è¯†åˆ«cpuæ ¸æ•°äº†ï¼Œä½†ä¸ºä»€ä¹ˆè¿˜æ˜¯å‡ºç°é—®é¢˜äº†å‘¢ï¼Ÿ é¦–å…ˆéœ€è¦ç¡®å®šä¸‹å®¹å™¨å†…javaæœåŠ¡è·å–åˆ°çš„çœŸæ­£çš„cpuæ ¸æ•°ï¼Œå¯ä»¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ java -XX:+UnlockDiagnosticVMOptions -XX:+PrintContainerInfo -version è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ°è·å–åˆ°çš„æ ¸æ•°ç¡®å®ä¸æ˜¯æˆ‘ä»¬ç”³è¯·çš„æ ¸æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´è™½ç„¶é‡‡ç”¨äº†æ²¡é—®é¢˜çš„jdkç‰ˆæœ¬ï¼Œä½†è¿˜æ˜¯è·å–åˆ°äº†é”™è¯¯çš„æ ¸æ•°ã€‚ æ¥ä¸‹æ¥å°±æ˜¯çœ‹ä¸‹ä¸ºä»€ä¹ˆä¼šè·å–åˆ°é”™è¯¯çš„æ ¸æ•°ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨straceæ¥åˆ†æjavaæœåŠ¡å¯åŠ¨è¿‡ç¨‹ä¸­çš„å‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼Œå…¶ä¸­åœ¨è·å–cpuæ ¸æ•°çš„æ—¶å€™æ¯”è¾ƒå¥‡æ€ªï¼Œæ­£å¸¸æ˜¯ä»cpuå­ç³»ç»Ÿè·å–ï¼Œä½†æ˜¯ç»“æœå´æ˜¾ç¤ºä»cpu_mirrorè·å–ï¼Œè€Œè¿™ä¸ªç›®å½•ä¸‹æ²¡æœ‰ä¿å­˜cpuæ ¸æ•°çš„æ–‡ä»¶ã€‚åç»è¿‡ç¡®å®šï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯å‰é¢æåˆ°çš„åšagentéš”ç¦»çš„æ—¶å€™è‡ªå®šä¹‰çš„æŒ‚åœ¨ç›®å½•ï¼Œå®¹å™¨å†…ä½äº/sys/fs/cgroupä¸‹é¢ã€‚åˆ°æ­¤åŸºæœ¬å¯ä»¥çŒœæµ‹æ˜¯å› ä¸ºæˆ‘ä»¬è‡ªå·±mountäº†ä¸€ä¸ªç›®å½•åˆ°cgroupç›®å½•ä¸‹ï¼Œå¯¼è‡´jdkè·å–åˆ°äº†é”™è¯¯ç›®å½•ï¼Œå‚æ•°ä¹Ÿè·å–é”™è¯¯ã€‚ æœ€åï¼Œä¸ºä»€ä¹ˆjdkè·å–åˆ°äº†é”™è¯¯çš„è·¯å¾„å‘¢ï¼Ÿå‚è€ƒ Container Support doesnâ€™t work for some Join Controllers combinationsï¼Œä»£ç æ¯”è¾ƒå¥½ç†è§£ï¼Œå…¶å®å°±æ˜¯æœ‰é—®é¢˜çš„ç‰ˆæœ¬åœ¨è·å–è·¯å¾„æ—¶é‡‡ç”¨çš„æ˜¯å­—ç¬¦ä¸²æˆªå–ï¼Œè€Œä¸æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå¯¼è‡´cpu_mirrorè¿™ç§ç›®å½•ä¼šè¢«è¯¯è®¤ä¸ºæ˜¯æ­£ç¡®ç›®å½•ã€‚ è€ç‰ˆå¤„ç†/prof/self/mountinfoç›´æ¥éå†æ¯è¡Œï¼Œç”¨strstråˆ¤æ–­æ˜¯å¦åŒ…å«cpuã€memoryç­‰ï¼ŒåŒ…å«å°±æ˜¯æ‰¾åˆ°äº†ï¼Œå¤„ç†/proc/self/cgroupçš„æ—¶å€™æ ¹æ® å†’å· åˆ†éš”ï¼Œå»æ‰ç¬¬ä¸€åˆ—åºå·ï¼Œç„¶åå‰©ä¸‹çš„å†å–ç¬¬ä¸€åˆ—ï¼Œç„¶åç”¨strstræ¯”è¾ƒæ˜¯ä¸æ˜¯åŒ…å«cpuã€memoryç­‰ æ–°ç‰ˆé’ˆå¯¹/proc/self/mountinfoè¯»ä¸€æ¡æ•°æ®ï¼Œæœ€åä¸€åˆ—æ ¹æ® é€—å· åˆ†éš”ï¼Œç„¶åç”¨strcmpæ¯”è¾ƒæ˜¯å¦å’Œcpuã€memoryç›¸ç­‰ï¼Œå¤„ç† /proc/self/cgroupçš„æ—¶å€™æ ¹æ® å†’å· åˆ†éš”ï¼Œå»æ‰ç¬¬ä¸€åˆ—åºå·ï¼Œç„¶åå‰©ä¸‹çš„å†å–ç¬¬ä¸€åˆ— ï¼Œç„¶åæ ¹æ®é€—å·åˆ†éš”ï¼Œéå†ç»“æœç”¨strcmpæ¯”è¾ƒæ˜¯å¦æ˜¯cpuã€memoryç­‰ æ€»ç»“å°±æ˜¯è€ç‰ˆæœ¬ ç›´æ¥if contains(str, â€œcpuâ€) then set cpu subsystme æ–°ç‰ˆæœ¬ for subStr in split(str, â€œ,\") if subStr equals â€œcpuâ€ then set cpu subsystem ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-java-cpu/:0:2","tags":["docker","ä¸Šäº‘"],"title":"JavaæœåŠ¡çªç°æ¯›åˆº","uri":"https://www.likakuli.com/posts/docker-java-cpu/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ è®©ä¸šåŠ¡å‡çº§jdkç‰ˆæœ¬æ— æ³•å¿«é€Ÿè§£å†³æ­¤é—®é¢˜ï¼Œæœ€ç»ˆå†³å®šæŠŠæŒ‚è½½çš„cpu_mirrorç­‰é—®é¢˜ç›®å½•umountæ‰ï¼Œå®¹å™¨å†…çœ‹ä¸åˆ°çš„è¯ä¹Ÿå°±ä¸ä¼šå‡ºé—®é¢˜äº†ï¼Œç»è¿‡æµ‹è¯•å‘ç°å¯è¡Œï¼Œæœ€ç»ˆåˆåœ¨å®¿ä¸»ä¸Šæ‰¹é‡æ‰§è¡Œäº†umountçš„æ“ä½œï¼ˆä¸ºåé¢ä¸€ä¸ªçº¿ä¸Šé—®é¢˜åŸ‹ä¸‹äº†ä¼ç¬”ï¼Œè¯¦è§è¿™ç¯‡ï¼‰ï¼Œé•¿æœŸæ–¹æ¡ˆæ˜¯è´Ÿè´£éš”ç¦»çš„agentæŠŠé—®é¢˜ç›®å½•æ”¹åï¼Œé¿å…å­—ç¬¦ä¸²åŒ¹é…æ—¶åŒ¹é…åˆ°ã€‚ ","date":"2021-02-10","objectID":"https://www.likakuli.com/posts/docker-java-cpu/:0:3","tags":["docker","ä¸Šäº‘"],"title":"JavaæœåŠ¡çªç°æ¯›åˆº","uri":"https://www.likakuli.com/posts/docker-java-cpu/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ç°è±¡ çº¿ä¸Šk8sé›†ç¾¤æŠ¥è­¦ï¼Œå®¿ä¸»fdåˆ©ç”¨ç‡è¶…è¿‡80%ï¼Œç™»é™†æŸ¥çœ‹dockerdå†…å­˜ä½¿ç”¨26G ","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:1:0","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥æ€è·¯ ç”±äºä¹‹å‰å·²ç»é‡åˆ°è¿‡å¤šæ¬¡dockerdèµ„æºæ³„éœ²çš„é—®é¢˜ï¼Œå…ˆçœ‹æ˜¯å¦æ˜¯å·²çŸ¥åŸå› å¯¼è‡´çš„ï¼Œå‚è€ƒå‰é¢ä¸¤ç¯‡ ","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:2:0","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"fdçš„å¯¹ç«¯æ˜¯è°ï¼Ÿ æ‰§è¡Œss -anp | grep dockerdï¼Œç»“æœå¦‚ä¸‹å›¾ï¼Œå¯ä»¥çœ‹åˆ°å’Œä¹‹å‰é‡åˆ°çš„é—®é¢˜ä¸åŒï¼Œç¬¬8åˆ—æ˜¾ç¤ºä¸º0ï¼Œä¸ä¹‹å‰é‡åˆ°çš„çš„æƒ…å†µä¸ç¬¦ï¼Œæ— æ³•æ‰¾åˆ°å¯¹ç«¯ã€‚ ","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:2:1","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å†…å­˜ä¸ºä»€ä¹ˆæ³„éœ²ï¼Ÿ ä¸ºäº†å¯ä»¥ä½¿ç”¨pprofåˆ†æå†…å­˜æ³„éœ²ä½ç½®ï¼Œé¦–å…ˆä¸ºdockerdæ‰“å¼€debugæ¨¡å¼ï¼Œéœ€è¦ä¿®æ”¹serviceæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹ä¸¤å¥ ExecReload=/bin/kill -s HUP $MAINPID KillMode=process åŒæ—¶åœ¨/etc/docker/daemon.jsonæ–‡ä»¶ä¸­æ·»åŠ  â€œdebugâ€: trueçš„é…ç½®ï¼Œä¿®æ”¹å®Œä¹‹åæ‰§è¡Œsystemctl daemon-reloadé‡æ–°åŠ è½½dockeræœåŠ¡é…ç½®ï¼Œç„¶åæ‰§è¡Œsystemctl reload dockerï¼Œé‡æ–°åŠ è½½dockeré…ç½®ï¼Œå¼€å¯debugæ¨¡å¼ dockerdé»˜è®¤ä½¿ç”¨udså¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•ï¼Œå¯ä»¥ä½¿ç”¨socatå¯¹dockerè¿›è¡Œç«¯å£è½¬å‘ï¼Œå¦‚ä¸‹ sudo socat -d -d TCP-LISTEN:8080,fork,bind=0.0.0.0 UNIX:/var/run/docker.sockï¼Œæ„æ€æ˜¯å¤–éƒ¨å¯ä»¥é€šè¿‡è®¿é—®å®¿ä¸»æœºçš„8080ç«¯å£æ¥è°ƒç”¨docker apiï¼Œè‡³æ­¤ä¸€åˆ‡å°±ç»ª åœ¨æœ¬åœ°æ‰§è¡Œgo tool pprof http://ip:8080/debug/pprof/heapæŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹å›¾ å¯ä»¥çœ‹åˆ°å ç”¨å¤šçš„åœ°æ–¹åœ¨golangè‡ªå¸¦çš„bufio NewWriterSizeå’ŒNewReaderSizeå¤„ï¼Œæ¯æ¬¡httpè°ƒç”¨éƒ½ä¼šéƒ½è¿™é‡Œï¼Œä¹Ÿçœ‹å‡ºæ¥æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ ","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:2:2","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"Goroutineä¹Ÿæ³„éœ²ï¼Ÿ æ³„éœ²ä½ç½® é€šè¿‡å†…å­˜è¿˜æ˜¯æ— æ³•çŸ¥é“å…·ä½“å‡ºé—®é¢˜çš„ä½ç½®ï¼Œé—®é¢˜ä¸å¤§ï¼Œå†çœ‹çœ‹goroutineçš„æƒ…å†µï¼Œç›´æ¥åœ¨æµè§ˆå™¨è®¿é—®http://ip:8080/debug/pprof/goroutine?debug=1ï¼Œå¦‚ä¸‹å›¾ ä¸€å…±1572822ä¸ªgoroutineï¼Œä¸¤ä¸ªå¤§å¤´å„å ä¸€åŠï¼Œå„æœ‰786212ä¸ªã€‚çœ‹åˆ°è¿™é‡ŒåŸºæœ¬å°±å¯ä»¥æ²¿ç€æ–‡ä»¶è¡Œæ•°å»æºç ä¸­æŸ¥çœ‹äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨çš„docker 18.09.2ç‰ˆæœ¬ï¼ŒæŠŠæºç åˆ‡æ¢åˆ°å¯¹åº”ç‰ˆæœ¬ä¸‹ï¼Œé€šè¿‡æŸ¥çœ‹æºç å¯ä»¥çŸ¥é“è¿™ä¸¤å¤§ç±»çš„goroutineæ³„éœ²çš„åŸå› ï¼Œdockerdä¸containerdç›¸å…³å¤„ç†æµç¨‹å¦‚ä¸‹å›¾ å¯¹åº”ä¸Šå›¾çš„è¯ï¼Œgoroutineæ³„éœ²æ˜¯ç”±ä¸Šé¢æœ€ådocker killæ—¶çš„wait chan closeå¯¼è‡´çš„ï¼Œwaitçš„æ—¶å€™ä¼šå¯åŠ¨å¦ä¸€ä¸ªgoroutineï¼Œæ¯æ¬¡docker killéƒ½ä¼šé€ æˆè¿™ä¸¤ä¸ªgoroutineçš„æ³„éœ²ã€‚å¯¹åº”ä»£ç å¦‚ä¸‹ // Kill forcefully terminates a container. func (daemon *Daemon) Kill(container *containerpkg.Container) error { if !container.IsRunning() { return errNotRunning(container.ID) } // 1. Send SIGKILL if err := daemon.killPossiblyDeadProcess(container, int(syscall.SIGKILL)); err != nil { // While normally we might \"return err\" here we're not going to // because if we can't stop the container by this point then // it's probably because it's already stopped. Meaning, between // the time of the IsRunning() call above and now it stopped. // Also, since the err return will be environment specific we can't // look for any particular (common) error that would indicate // that the process is already dead vs something else going wrong. // So, instead we'll give it up to 2 more seconds to complete and if // by that time the container is still running, then the error // we got is probably valid and so we return it to the caller. if isErrNoSuchProcess(err) { return nil } ctx, cancel := context.WithTimeout(context.Background(), 2*time.Second) defer cancel() if status := \u003c-container.Wait(ctx, containerpkg.WaitConditionNotRunning); status.Err() != nil { return err } } // 2. Wait for the process to die, in last resort, try to kill the process directly if err := killProcessDirectly(container); err != nil { if isErrNoSuchProcess(err) { return nil } return err } // Wait for exit with no timeout. // Ignore returned status. \u003c-container.Wait(context.Background(), containerpkg.WaitConditionNotRunning) return nil } // Wait waits until the container is in a certain state indicated by the given // condition. A context must be used for cancelling the request, controlling // timeouts, and avoiding goroutine leaks. Wait must be called without holding // the state lock. Returns a channel from which the caller will receive the // result. If the container exited on its own, the result's Err() method will // be nil and its ExitCode() method will return the container's exit code, // otherwise, the results Err() method will return an error indicating why the // wait operation failed. func (s *State) Wait(ctx context.Context, condition WaitCondition) \u003c-chan StateStatus { s.Lock() defer s.Unlock() if condition == WaitConditionNotRunning \u0026\u0026 !s.Running { // Buffer so we can put it in the channel now. resultC := make(chan StateStatus, 1) // Send the current status. resultC \u003c- StateStatus{ exitCode: s.ExitCode(), err: s.Err(), } return resultC } // If we are waiting only for removal, the waitStop channel should // remain nil and block forever. var waitStop chan struct{} if condition \u003c WaitConditionRemoved { waitStop = s.waitStop } // Always wait for removal, just in case the container gets removed // while it is still in a \"created\" state, in which case it is never // actually stopped. waitRemove := s.waitRemove resultC := make(chan StateStatus) go func() { select { case \u003c-ctx.Done(): // Context timeout or cancellation. resultC \u003c- StateStatus{ exitCode: -1, err: ctx.Err(), } return case \u003c-waitStop: case \u003c-waitRemove: } s.Lock() result := StateStatus{ exitCode: s.ExitCode(), err: s.Err(), } s.Unlock() resultC \u003c- result }() return resultC } å¯¹ç…§goroutineçš„å›¾ç‰‡ï¼Œä¸¤ä¸ªgoroutineåˆ†åˆ«èµ°åˆ°äº†Killæœ€åä¸€æ¬¡çš„container.Waitå¤„ã€Waitçš„selectå¤„ï¼Œæ­£å› ä¸ºWaitæ–¹æ³•çš„selectä¸€ç›´ä¸è¿”å›ï¼Œå¯¼è‡´resultCæ— æ•°æ®ï¼Œå¤–é¢ä¹Ÿå°±æ— æ³•ä»container.Waitè¿”å›çš„chanä¸­è¯»åˆ°æ•°æ®ï¼Œä»è€Œå¯¼è‡´æ¯æ¬¡docker stopè°ƒç”¨é˜»å¡ä¸¤ä¸ªgoroutineã€‚ ä¸ºä»€ä¹ˆæ³„éœ²ï¼Ÿ ä¸ºä»€ä¹ˆselectä¸€ç›´ä¸è¿”å›å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°selectåœ¨ç­‰ä¸‰ä¸ªchanï¼Œä»»æ„ä¸€ä¸ªæœ‰æ•°æ®æˆ–è€…å…³é—­éƒ½ä¼šè¿”å› ctx.Done()ï¼šä¸è¿”å›æ˜¯å› ä¸ºæœ€åä¸€æ¬¡è°ƒç”¨Waitçš„æ—¶å€™ä¼ å…¥çš„æ˜¯context.Background()ã€‚è¿™é‡Œå…¶å®ä¹Ÿæ˜¯dockerdå¯¹è¯·æ±‚çš„å¤„ç†æ–¹å¼ï¼Œæ—¢ç„¶å®¢æˆ·ç«¯è¦åˆ é™¤å®¹å™¨ï¼Œé‚£æˆ‘å°±ç­‰ç€å®¹å™¨åˆ é™¤ï¼Œä»€ä¹ˆæ—¶é—´åˆ é™¤ä»€ä¹ˆæ—¶é—´é€€å‡ºï¼Œåªè¦å®¹å™¨æ²¡åˆ ï¼Œå°±ä¸€ç›´æœ‰ä¸ªgoroutineåœ¨ç­‰å¾…ã€‚ waitStopå’ŒwaitRemoveï¼šä¸è¿”å›æ˜¯å› ä¸ºæ²¡æ”¶åˆ°containerdå‘æ¥çš„task exitçš„ä¿¡å·ï¼Œå¯ä»¥å¯¹ç…§ä¸Šå›¾çœ‹ä¸‹ï¼Œåœ¨æ”¶åˆ°task exitåæ‰ä¼šå…³é—­chan ä¸ºä»€ä¹ˆæ²¡æ”¶","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:2:3","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ Kubeletä¸ºäº†ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œå‘ç°å®¿ä¸»ä¸Šè¿˜æœ‰ä¸åº”è¯¥å­˜åœ¨çš„å®¹å™¨å°±ä¼šä¸€ç›´ä¸æ–­çš„å»å°è¯•åˆ é™¤ï¼Œæ¯æ¬¡åˆ é™¤éƒ½ä¼šè°ƒç”¨docker stopçš„apiï¼Œä¸dockerdå»ºç«‹ä¸€ä¸ªudsè¿æ¥ï¼Œdockerdåˆ é™¤å®¹å™¨çš„æ—¶å€™ä¼šå¯åŠ¨ä¸€ä¸ªgoroutineé€šè¿‡rpcå½¢å¼è°ƒç”¨containerdæ¥åˆ é™¤å®¹å™¨å¹¶ç­‰å¾…æœ€ç»ˆåˆ é™¤å®Œæ¯•æ‰è¿”å›ï¼Œç­‰å¾…çš„è¿‡ç¨‹ä¸­ä¼šå¦èµ·ä¸€ä¸ªgoroutineæ¥è·å–ç»“æœï¼Œç„¶è€Œcontainerdåœ¨è°ƒç”¨runcå»çœŸæ­£æ‰§è¡Œåˆ é™¤çš„æ—¶å€™å› ä¸ºå®¹å™¨å†…Dè¿›ç¨‹ï¼Œæ— æ³•åˆ é™¤å®¹å™¨ï¼Œå¯¼è‡´æ²¡æœ‰å‘å‡ºtask exitä¿¡å·ï¼Œdockerdçš„ä¸¤ä¸ªç›¸å…³çš„goroutineä¹Ÿå°±ä¸ä¼šé€€å‡ºã€‚æ•´ä¸ªè¿‡ç¨‹ä¸æ–­é‡å¤ï¼Œæœ€ç»ˆå°±å¯¼è‡´fdã€å†…å­˜ã€goroutineä¸€æ­¥æ­¥çš„æ³„éœ²ï¼Œç³»ç»Ÿé€æ¸èµ°å‘ä¸å¯ç”¨ã€‚ å›è¿‡å¤´æ¥æƒ³æƒ³ï¼Œå…¶å®kubeletæœ¬èº«çš„å¤„ç†éƒ½æ²¡æœ‰é—®é¢˜ï¼Œkubeletæ˜¯ä¸ºäº†ç¡®ä¿ä¸€è‡´æ€§ï¼Œè¦å»åˆ é™¤ä¸åº”è¯¥å­˜åœ¨çš„å®¹å™¨ï¼Œç›´åˆ°å®¹å™¨è¢«å½»åº•åˆ é™¤ï¼Œæ¯æ¬¡è°ƒç”¨docker apiéƒ½è®¾ç½®äº†timeoutã€‚dockerdçš„é€»è¾‘æœ‰å¾…å•†æ¦·ï¼Œè‡³å°‘å¯ä»¥åšä¸€äº›æ”¹è¿›ï¼Œå› ä¸ºå®¢æˆ·ç«¯è¯·æ±‚æ—¶å¸¦äº†timeoutï¼Œä¸”dockerdåç«¯åœ¨æ¥æ”¶åˆ°task exitäº‹ä»¶åæ˜¯ä¼šå»åšcontainer removeæ“ä½œçš„ï¼Œå³ä½¿å½“å‰æ²¡æœ‰docker stopè¯·æ±‚ã€‚æ‰€ä»¥å¯ä»¥è€ƒè™‘æŠŠæœ€åä¼ å…¥context.Background()çš„Waitå‡½æ•°è°ƒç”¨å»æ‰ï¼Œå½“å‰é¢å¸¦è¶…æ—¶çš„Waitè¿”å›åç›´æ¥é€€å‡ºå°±å¯ä»¥ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆèµ„æºæ³„éœ²äº†ã€‚ ","date":"2020-12-24","objectID":"https://www.likakuli.com/posts/docker-leak3/:3:0","tags":["docker"],"title":"Dockerdèµ„æºæ³„éœ²ç³»åˆ— - 3","uri":"https://www.likakuli.com/posts/docker-leak3/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"1. èƒŒæ™¯ æ‰¿æ¥ä¸Šæ–‡ï¼Œè¿‘æœŸæˆ‘ä»¬æ’æŸ¥å¼¹æ€§äº‘çº¿ä¸Šå‡ èµ·æ•…éšœæ—¶ï¼Œæ•…éšœç”±å¤šä¸ªå› ç´ å…±åŒå¼•èµ·ï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š å¼¹æ€§äº‘åœ¨é€æ­¥ç°åº¦å‡çº§dockerç‰ˆæœ¬è‡³ 18.06.3-ce ç”±äºå†å²åŸå› ï¼Œå¼¹æ€§äº‘å¯ç”¨äº†dockeræœåŠ¡çš„systemdé…ç½®é€‰é¡¹ MountFlags=slave ä¸ºäº†é¿å…dockerdé‡å¯å¼•èµ·ä¸šåŠ¡å®¹å™¨é‡å»ºï¼Œå¼¹æ€§äº‘å¯ç”¨äº† live-restore=true é…ç½®ï¼ŒdockeræœåŠ¡å‘ç”Ÿé‡å¯ï¼Œdockerdä¸shimè¿›ç¨‹mnt nsä¸ä¸€è‡´ åœ¨ä»¥ä¸Šä¸‰ä¸ªå› ç´ åˆåŠ›ä½œç”¨ä¸‹ï¼Œçº¿ä¸Šå®¹å™¨åœ¨é‡å»ºä¸æ¼‚ç§»åœºæ™¯ä¸‹ï¼Œå‡ºç°åˆ é™¤å¤±è´¥çš„äº‹ä»¶ã€‚ åŒæ ·ï¼Œæ–‡ç« æœ€åä¹Ÿç»™å‡ºäº†ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š é•¿ç—›ï¼šä¿®æ”¹ä»£ç ï¼Œå¿½ç•¥é”™è¯¯ çŸ­ç—›ï¼šä¿®æ”¹é…ç½®ï¼Œä¸€åŠ³æ°¸é€¸ ä½œä¸ºä¼˜ç§€çš„ç¤¾ä¼šä¸»ä¹‰æ¥ç­äººï¼Œæˆ‘ä»¬å½“ç„¶é€‰æ‹©çŸ­ç—›äº†ï¼ä¾æ®å®˜æ–¹æç¤º MountFlags=slave ä¸ live-restore=true ä¸èƒ½ååŒå·¥ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€å…³é—­äºŒè€…ä¹‹ä¸€å°±èƒ½è§£å†³é—®é¢˜ã€‚ ä¸æˆ‘ä»¬è€Œè¨€ï¼Œdockeræä¾›çš„ live-restore èƒ½åŠ›æ˜¯ä¸€ä¸ªå¾ˆå…³é”®çš„ç‰¹æ€§ã€‚dockeré‡å¯çš„åŸå› å¤šç§å¤šæ ·ï¼Œæ—¢å¯èƒ½æ˜¯äººä¸ºè°ƒè¯•å› ç´ ï¼Œä¹Ÿå¯èƒ½æ˜¯æœºå™¨çš„éé¢„æœŸè¡Œä¸ºï¼Œå½“dockeré‡å¯åï¼Œæˆ‘ä»¬å¹¶ä¸å¸Œæœ›ç”¨æˆ·çš„å®¹å™¨ä¹Ÿå‘ç”Ÿé‡å»ºã€‚ä¼¼ä¹å…³é—­ MountFlags=slave æˆäº†æˆ‘ä»¬å”¯ä¸€çš„é€‰æ‹©ã€‚ ç­‰ç­‰ï¼Œå›æƒ³ä¸€ä¸‹docker device busyé—®é¢˜è§£å†³æ–¹æ¡ˆï¼Œåˆ«äººæ­£æ˜¯ä¸ºäº†é¿å…dockeræŒ‚è½½æ³„æ¼è€Œå¼•èµ·åˆ é™¤å®¹å™¨å¤±è´¥æ‰å¼€å¯çš„è¿™ä¸ªç‰¹æ€§ã€‚ ä½†æ˜¯ï¼Œè¿™ä¸ª17å¹´çš„ç»“è®ºçœŸçš„è¿˜å…·æœ‰æ™®é€‚æ€§å—ï¼Ÿæ˜¯ä¸ä¸æ˜¯ï¼Œæˆ‘ä»¬äº²è‡ªéªŒè¯å³å¯ã€‚ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating2/:0:1","tags":["docker"],"title":"Pod terminating2","uri":"https://www.likakuli.com/posts/docker-pod-terminating2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"2. å¯¹æ¯”å®éªŒ ä¸ºäº†éªŒè¯åœ¨å…³é—­ MountFlags=slave é€‰é¡¹åï¼Œdockeræ˜¯å¦å­˜åœ¨æŒ‚è½½ç‚¹æ³„æ¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬åˆ†åˆ«æŒ‘é€‰äº†ä¸€å° 1.13.1 ä¸ 18.06.3-ce çš„å®¿ä¸»è¿›è¡Œå®éªŒã€‚å®éªŒæ­¥éª¤æ­£å¦‚docker device busyé—®é¢˜è§£å†³æ–¹æ¡ˆæ‰€æç¤ºï¼Œåœ¨éªŒè¯ä¹‹å‰ï¼Œç¯å¢ƒå‡†å¤‡å¦‚ä¸‹ï¼š åˆ é™¤dockeræœåŠ¡çš„systemdé…ç½®é¡¹ MountFlags=slave æŒ‘é€‰å¯ç”¨systemdé…ç½®é¡¹ PrivateTmp=true çš„ä»»æ„æœåŠ¡ï¼Œæœ¬æ–‡ä»¥ httpd ä¸ºä¾‹ ä¸‹é¢å¼€å§‹éªŒè¯ï¼š ////// docker 1.13.1 éªŒè¯æ­¥éª¤åŠç»“æœ // 1. é‡æ–°åŠ è½½é…ç½® [stupig@hostname2 ~]$ sudo systemctl daemon-reload // 2. é‡å¯docker [stupig@hostname2 ~]$ sudo systemctl restart docker // 3. åˆ›å»ºå®¹å™¨ [stupig@hostname2 ~]$ sudo docker run -d nginx c89c2aeff6e3e6414dfc7f448b4a560b4aac96d69a82ba021b78ee576bf6771c // 4. é‡å¯httpd [stupig@hostname2 ~]$ sudo systemctl restart httpd // 5. åœæ­¢å®¹å™¨ [stupig@hostname2 ~]$ sudo docker stop c89c2aeff6e3e6414dfc7f448b4a560b4aac96d69a82ba021b78ee576bf6771c c89c2aeff6e3e6414dfc7f448b4a560b4aac96d69a82ba021b78ee576bf6771c // 6. æ¸…ç†å®¹å™¨ [stupig@hostname2 ~]$ sudo docker rm c89c2aeff6e3e6414dfc7f448b4a560b4aac96d69a82ba021b78ee576bf6771c Error response from daemon: Driver overlay2 failed to remove root filesystem c89c2aeff6e3e6414dfc7f448b4a560b4aac96d69a82ba021b78ee576bf6771c: remove /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged: device or resource busy // 7. å®šä½æŒ‚è½½ç‚¹ [stupig@hostname2 ~]$ grep -rwn /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged /proc/*/mountinfo /proc/19973/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/19974/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/19975/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/19976/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/19977/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/19978/mountinfo:40:231 227 0:40 / /home/docker_rt/overlay2/6c77cfb6c0c4b1e809c47af3c5ff6a4732a783cc14ff53270a7709c837c96346/merged rw,relatime shared:119 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX // 8. å®šä½ç›®æ ‡è¿›ç¨‹ [stupig@hostname2 ~]$ ps -ef|egrep '19973|19974|19975|19976|19977|19978' root 19973 1 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND apache 19974 19973 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND apache 19975 19973 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND apache 19976 19973 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND apache 19977 19973 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND apache 19978 19973 0 15:13 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND docker 1.13.1 ç‰ˆæœ¬çš„å®éªŒç»“æœæ­£å¦‚ç½‘æ–‡æ‰€æ–™ï¼Œå®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹å‡ºç°äº†æ³„æ¼ï¼Œå¹¶ä¸” docker rm æ— æ³•æ¸…ç†è¯¥å®¹å™¨ï¼ˆæ³¨æ„ docker rm -f ä»ç„¶å¯ä»¥æ¸…ç†ï¼ŒåŸå› å‚è€ƒä¸Šæ–‡ï¼‰ã€‚ å¼¹æ€§äº‘å¯ç”¨dockeré…ç½® MountFlags=slave ä¹Ÿæ˜¯ä¸ºäº†é¿å…è¯¥é—®é¢˜å‘ç”Ÿã€‚ é‚£ä¹ˆç°åœ¨å‹åŠ›è½¬ç§»åˆ° docker 18.06.3-ce è¿™è¾¹æ¥äº†ï¼Œæ–°ç‰ˆæœ¬æ˜¯å¦ä»ç„¶å­˜åœ¨è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ////// docker 18.06.3-ce éªŒè¯æ­¥éª¤åŠç»“æœ [stupig@hostname ~]$ sudo systemctl daemon-reload [stupig@hostname ~]$ sudo systemctl restart docker [stupig@hostname ~]$ sudo docker run -d nginx 718114321d67a817c1498e530b943c2514ed4200f2d0d138880f8c345df7048f [stupig@hostname ~]$ sudo systemctl restart httpd [stupig@hostname ~]$ sudo docker stop 718114321d67a817c1498e530b943c2514ed4200f2d0d138880f8c345df7048f 718114321d67a817c1498e530b943c2514ed4200f2d0d138880f8c345df7048f [stupig@hostname ~]$ sudo docker rm 718114321d67a817c1498e530b943c2514ed4200f2d0d138880f8c345df7048f 718114321d67a817c1498e530b943c2514ed4200f2d0d138880f8c345df7048f é’ˆå¯¹docker 18.06.3-ce çš„å®éªŒéå¸¸ä¸æ»‘é¡ºç•…ï¼Œä¸å­˜åœ¨ä»»ä½•é—®é¢˜ã€‚å›é¡¾ä¸Šæ–‡çŸ¥è¯†ç‚¹ï¼Œå½“å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹å‡ºç°æ³„æ¼åï¼Œdocker 18.06.3-","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating2/:0:2","tags":["docker"],"title":"Pod terminating2","uri":"https://www.likakuli.com/posts/docker-pod-terminating2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"3. è››ä¸é©¬è¿¹ ä¸Šä¸€èŠ‚å¯¹æ¯”å®éªŒçš„ç»“æœç»™äº†æˆ‘ä»¬è«å¤§çš„é¼“åŠ±ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¢ç´¢ä¸¤ä¸ªç‰ˆæœ¬çš„dockerçš„è¡¨ç°å·®å¼‚ï¼Œä»¥æœŸå®šä½ç—‡ç»“æ‰€åœ¨ã€‚ æ—¢ç„¶æ ¸å¿ƒé—®é¢˜åœ¨äºæŒ‚è½½ç‚¹æ˜¯å¦è¢«æ³„æ¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»¥æŒ‚è½½ç‚¹ä¸ºåˆ‡å…¥ç‚¹ï¼Œæ·±å…¥åˆ†æä¸¤ä¸ªç‰ˆæœ¬dockerçš„å·®å¼‚æ€§ã€‚æˆ‘ä»¬å¯¹æ¯”åœ¨ä¸¤ä¸ªç¯å¢ƒä¸‹æ‰§è¡Œå®Œ æ­¥éª¤4 åï¼Œä¸åŒè¿›ç¨‹å†…çš„æŒ‚è½½è¯¦æƒ…ï¼Œç»“æœå¦‚ä¸‹ï¼š // docker 1.13.1 [stupig@hostname2 ~]$ sudo docker run -d nginx 0fe8d412f99a53229ea0df3ec44c93496e150a39f724ea304adb7f924910d61b [stupig@hostname2 ~]$ sudo docker inspect -f {{.GraphDriver.Data.MergedDir}} 0fe8d412f99a53229ea0df3ec44c93496e150a39f724ea304adb7f924910d61b /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged // å…±äº«å‘½åç©ºé—´ [stupig@hostname2 ~]$ grep -rw /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged /proc/$$/mountinfo 223 1143 0:40 / /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX [stupig@hostname2 ~]$ sudo systemctl restart httpd [stupig@hostname2 ps -ef|grep httpd|head -n 1 root 16715 1 2 16:09 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND // httpdè¿›ç¨‹å‘½åç©ºé—´ [stupig@hostname2 ~]$ grep -rw /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged /proc/16715/mountinfo 257 235 0:40 / /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged rw,relatime shared:123 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX // docker 18.06.3-ce [stupig@hostname ~]$ sudo docker run -d nginx ce75d4fdb6df6d13a7bf4270f71b3752ee2d3849df1f64d5d5d19a478ac7db8d [stupig@hostname ~]$ sudo docker inspect -f {{.GraphDriver.Data.MergedDir}} ce75d4fdb6df6d13a7bf4270f71b3752ee2d3849df1f64d5d5d19a478ac7db8d /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged // å…±äº«å‘½åç©ºé—´ [stupig@hostname ~]$ grep -rw /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged /proc/$$/mountinfo 218 43 0:105 / /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged rw,relatime shared:109 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX [stupig@hostname ~]$ sudo systemctl restart httpd [stupig@hostname ~]$ ps -ef|grep httpd|head -n 1 root 63694 1 0 16:14 ? 00:00:00 /usr/sbin/httpd -DFOREGROUND // httpdè¿›ç¨‹å‘½åç©ºé—´ [stupig@hostname ~]$ grep -rw /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged /proc/63694/mountinfo 435 376 0:105 / /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged rw,relatime shared:122 master:109 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX å’‹ä¸€çœ‹ï¼Œå¥½åƒæ²¡å•¥åŒºåˆ«å•Šï¼çå¤§ä½ ä»¬çš„ç«çœ¼é‡‘ç›ï¼Œæ˜¯å¦å‘ç°å·®å¼‚æ‰€åœ¨äº†ï¼Ÿ å¦‚æœç»†å¿ƒå¯¹æ¯”ï¼Œè¿˜æ˜¯å¾ˆå®¹æ˜“åˆ†è¾¨å‡ºå·®å¼‚æ‰€åœ¨çš„ï¼š å…±äº«å‘½åç©ºé—´ä¸­ docker 18.06.3-ce ç‰ˆæœ¬åˆ›å»ºçš„æŒ‚è½½ç‚¹æ˜¯sharedçš„ è€Œdocker 1.13.1 ç‰ˆæœ¬åˆ›å»ºçš„æŒ‚è½½ç‚¹æ˜¯privateçš„ httpdè¿›ç¨‹å‘½åç©ºé—´ä¸­ docker 18.06.3-ce åˆ›å»ºçš„æŒ‚è½½ç‚¹ä»ç„¶æ˜¯å…±äº«çš„ï¼Œå¹¶ä¸”æ¥æ”¶å…±äº«ç»„109ä¼ é€’çš„æŒ‚è½½ä¸å¸è½½äº‹ä»¶ï¼Œæ³¨æ„ï¼šå…±äº«ç»„109æ­£å¥½å°±æ˜¯å…±äº«å‘½åç©ºé—´ä¸­å¯¹åº”çš„æŒ‚è½½ç‚¹ è€Œdocker 1.13.1 ç‰ˆæœ¬åˆ›å»ºçš„æŒ‚è½½ç‚¹è™½ç„¶ä¹Ÿæ˜¯å…±äº«çš„ï¼Œä½†æ˜¯å´ä¸å…±äº«å‘½åç©ºé—´ä¸­å¯¹åº”çš„æŒ‚è½½ç‚¹æ²¡æœ‰å…³è”å…³ç³» å¯èƒ½ä¼šæœ‰ç”¨æˆ·ä¸ç¦è¦é—®ï¼šæ€ä¹ˆåˆ†è¾¨æŒ‚è½½ç‚¹æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿä»¥åŠä¸åŒç±»å‹æŒ‚è½½ç‚¹çš„ä¼ é€’å±æ€§å‘¢ï¼Ÿè¯·å‚é˜…ï¼šmountå‘½åç©ºé—´è¯´æ˜æ–‡æ¡£ã€‚ é—®é¢˜å·²ç„¶æ˜äº†ï¼Œç”±äºä¸¤ä¸ªç‰ˆæœ¬dockeræ‰€åˆ›å»ºçš„å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹å…·å¤‡ä¸åŒçš„å±æ€§ï¼Œå¯¼è‡´å®ƒä»¬ä¹‹é—´çš„è¡Œä¸ºå·®å¼‚ã€‚ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating2/:0:3","tags":["docker"],"title":"Pod terminating2","uri":"https://www.likakuli.com/posts/docker-pod-terminating2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"4. åˆ¨æ ¹é—®åº• ç›¸ä¿¡å¤§å®¶å¦‚æœç†è§£äº†ä¸Šä¸€èŠ‚çš„å†…å®¹ï¼Œå°±å·²ç»äº†è§£äº†é—®é¢˜çš„æœ¬è´¨ã€‚æœ¬èŠ‚æˆ‘ä»¬ç»§ç»­æ¢ç´¢é—®é¢˜çš„æ ¹å› ã€‚ ä¸ºä»€ä¹ˆä¸¤ä¸ªç‰ˆæœ¬çš„dockerè¡Œä¸ºè¡¨ç°ä¸ä¸€è‡´ï¼Ÿä¸å¤–ä¹ä¸¤ä¸ªä¸»è¦åŸå› ï¼š dockerå¤„ç†é€»è¾‘å‘ç”Ÿå˜åŠ¨ å®¿ä¸»ç¯å¢ƒä¸ä¸€è‡´ï¼Œä¸»è¦æŒ‡å†…æ ¸ ç¬¬äºŒä¸ªå› ç´ å¾ˆå¥½æ’é™¤ï¼Œæˆ‘ä»¬å¯¹æ¯”äº†ä¸¤ä¸ªæµ‹è¯•ç¯å¢ƒçš„å®¿ä¸»å†…æ ¸ç‰ˆæœ¬ï¼Œç»“æœæ˜¯ä¸€è‡´çš„ã€‚æ‰€ä»¥ï¼ŒåŸºæœ¬è¿˜æ˜¯å› dockerä»£ç å‡çº§è€Œäº§ç”Ÿçš„è¡Œä¸ºä¸ä¸€è‡´ã€‚ç†è®ºä¸Šï¼Œæˆ‘ä»¬åªéœ€é€ä¸ªåˆ†ædocker 1.13.1 ä¸ docker 18.06.3-ce ä¸¤ä¸ªç‰ˆæœ¬é—´çš„æ‰€æœ‰æäº¤è®°å½•ï¼Œå°±ä¸€å®šèƒ½å¤Ÿå®šä½åˆ°å…³é”®æäº¤ä¿¡æ¯ï¼Œå¤§åŠ›æ€»æ˜¯ä¼šå‡ºç°å¥‡è¿¹ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿä»ç°åœºä¸­å‘ç°æœ‰ç”¨ä¿¡æ¯ï¼Œç¼©å°æ£€ç´¢èŒƒå›´ã€‚ ä»ç„¶ä»æŒ‚è½½ç‚¹åˆ‡å…¥ï¼Œæ—¢ç„¶ä¸¤ä¸ªç‰ˆæœ¬çš„dockeræ‰€åˆ›å»ºçš„æŒ‚è½½ç‚¹åœ¨å…±äº«å‘½åç©ºé—´ä¸­å°±å·²ç»å‡ºç°å·®å¼‚ï¼Œæˆ‘ä»¬é¡ºè—¤æ‘¸ç“œï¼Œæ‰¾æ‰¾å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹é“¾è·¯ä¸Šæ˜¯å¦å­˜åœ¨å·®å¼‚ï¼š // docker 1.13.1 // æœ¬æŒ‚è½½ç‚¹ [stupig@hostname2 ~]$ grep -rw /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged /proc/$$/mountinfo 223 1143 0:40 / /home/docker_rt/overlay2/4e09fa6803feab9d96fe72a44fb83d757c1788812ff60071ac2e62a5cf14cd97/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX // å®šä½æœ¬æŒ‚è½½ç‚¹çš„çˆ¶æŒ‚è½½ç‚¹ [stupig@hostname2 ~]$ grep -rw 1143 /proc/$$/mountinfo 1143 44 8:4 /docker_rt/overlay2 /home/docker_rt/overlay2 rw,relatime - xfs /dev/sda4 rw,attr2,inode64,logbsize=256k,sunit=512,swidth=512,prjquota // ç»§ç»­å®šä½ç¥–çˆ¶æŒ‚è½½ç‚¹ [stupig@hostname2 ~]$ grep -rw 44 /proc/$$/mountinfo 44 39 8:4 / /home rw,relatime shared:28 - xfs /dev/sda4 rw,attr2,inode64,logbsize=256k,sunit=512,swidth=512,prjquota // ç»§ç»­å¾€ä¸Š [stupig@hostname2 ~]$ grep -rw 39 /proc/$$/mountinfo 39 1 8:3 / / rw,relatime shared:1 - ext4 /dev/sda3 rw,stripe=64,data=ordered // docker 18.06.3-ce // æœ¬æŒ‚è½½ç‚¹ [stupig@hostname ~]$ grep -rw /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged /proc/$$/mountinfo 218 43 0:105 / /home/docker_rt/overlay2/a9823ed6b3c5a752eaa92072ff9d91dbe1467ceece3eedf613bf6ffaa5183b76/merged rw,relatime shared:109 - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX // å®šä½æœ¬æŒ‚åœ¨ç‚¹çš„çˆ¶æŒ‚è½½ç‚¹ [stupig@hostname ~]$ grep -rw 43 /proc/$$/mountinfo 43 61 8:17 / /home rw,noatime shared:29 - xfs /dev/sdb1 rw,attr2,nobarrier,inode64,prjquota // ç»§ç»­å®šä½ç¥–çˆ¶æŒ‚è½½ç‚¹ [stupig@hostname ~]$ grep -rw 61 /proc/$$/mountinfo 61 1 8:3 / / rw,relatime shared:1 - ext4 /dev/sda3 rw,data=ordered ä¸¤ä¸ªç‰ˆæœ¬çš„dockeræ‰€åˆ›å»ºçš„å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹é“¾è·¯ä¸Šå·®å¼‚è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„ï¼š å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹çš„çˆ¶çº§æŒ‚è½½ç‚¹ä¸åŒ docker 18.06.3-ce åˆ›å»ºçš„å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹çš„çˆ¶çº§æŒ‚è½½ç‚¹æ˜¯ /home/ ï¼Œå¹¶ä¸”æ˜¯å…±äº«çš„ docker 1.13.1 åˆ›å»ºçš„å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹çš„çˆ¶çº§æŒ‚è½½ç‚¹æ˜¯ /home/docker_rt/overlay2 ï¼Œå¹¶ä¸”æ˜¯ç§æœ‰çš„ è¿™é‡Œè¡¥å……ä¸€ä¸ªèƒŒæ™¯ï¼Œå¼¹æ€§äº‘æœºå™¨åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œä¼šå°† /home åˆå§‹åŒ–ä¸ºxfsæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œå› æ­¤æ‰€æœ‰å®¿ä¸»ä¸Š /home æŒ‚è½½ç‚¹éƒ½å…·å¤‡ç›¸åŒå±æ€§ã€‚ é‚£ä¹ˆï¼Œé—®é¢˜åŸºæœ¬å°±æ˜¯ç”± docker 1.13.1 ä¸­å¤šå‡ºçš„ä¸€å±‚æŒ‚è½½å±‚ /home/docker_rt/overlay2 å¼•èµ·ã€‚ å¦‚ä½•éªŒè¯è¿™ä¸ªçŒœæƒ³å‘¢ï¼Ÿç°åœ¨ï¼Œå…¶å®æˆ‘ä»¬å·²ç»å…·å¤‡äº†æ£€ç´¢ä»£ç çš„å…³é”®ç›®æ ‡ï¼Œdocker 1.13.1 ä¼šè®¾ç½®å®¹å™¨é•œåƒå±‚æ ¹ç›®å½•çš„ä¼ é€’å±æ€§ã€‚æ‹¿ç€è¿™ä¸ªå…ˆéªŒçŸ¥è¯†ï¼Œæˆ‘ä»¬ç›´æ¥æŸ¥ä»£ç ï¼Œæ£€ç´¢è¿‡ç¨‹åŸºæœ¬æ²¡è´¹ä»€ä¹ˆåŠŸå¤«ï¼Œç›´æ¥å±•ç¤ºç›¸å…³ä»£ç ï¼š // filepath: daemon/graphdriver/overlay2/overlay.go func init() { graphdriver.Register(driverName, Init) } func Init(home string, options []string, uidMaps, gidMaps []idtools.IDMap) (graphdriver.Driver, error) { if err := mount.MakePrivate(home); err != nil { return nil, err } supportsDType, err := fsutils.SupportsDType(home) if err != nil { return nil, err } if !supportsDType { // not a fatal error until v1.16 (#27443) logrus.Warn(overlayutils.ErrDTypeNotSupported(\"overlay2\", backingFs)) } d := \u0026Driver{ home: home, uidMaps: uidMaps, gidMaps: gidMaps, ctr: graphdriver.NewRefCounter(graphdriver.NewFsChecker(graphdriver.FsMagicOverlay)), supportsDType: supportsDType, } d.naiveDiff = graphdriver.NewNaiveDiffDriver(d, uidMaps, gidMaps) if backingFs == \"xfs\" { // Try to enable project quota support over xfs. if d.quotaCtl, err = quota.NewControl(home); err == nil { projectQuotaSupported = true } } return d, nil } å¾ˆæ˜æ˜¾ï¼Œé—®é¢˜å°±å‡ºåœ¨ mount.MakePrivate å‡½æ•°è°ƒç”¨ä¸Šã€‚ å®˜æ–¹å°† GraphDriver æ ¹ç›®å½•è®¾ç½®ä¸º Privateï¼Œæœ¬æ„æ˜¯ä¸ºäº†é¿å…å®¹å™¨è¯»å†™å±‚æŒ‚è½½ç‚¹æ³„æ¼ã€‚é‚£ä¸ºä»€ä¹ˆåœ¨é«˜ç‰ˆæœ¬ä¸­å»æ‰äº†è¿™ä¸ªé€»è¾‘å‘¢ï¼Ÿæ˜¾ç„¶å®˜æ–¹ä¹Ÿæ„è¯†åˆ°è¿™ä¹ˆåšå¹¶ä¸èƒ½å®ç°æœŸæœ›çš„ç›®çš„ï¼Œå®˜æ–¹ä¹Ÿåœ¨ä¿®å¤ä¸­ç»™å‡ºäº†è¯¦ç»†è¯´æ˜ã€‚ å®é™…ä¸Šï¼Œä¸è®¾ç½® GraphDriver æ ¹ç›®å½•çš„ä¼ æ’­å±æ€§ï¼Œåè€Œèƒ½é¿å…ç»å¤§å¤šæ•°æŒ‚è½½ç‚¹æ³„æ¼çš„é—®é¢˜ã€‚ã€‚ã€‚ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating2/:0:4","tags":["docker"],"title":"Pod terminating2","uri":"https://www.likakuli.com/posts/docker-pod-terminating2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"5. ç»“è¯­ ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†é—®é¢˜çš„æ¥é¾™å»è„‰ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼š é’ˆå¯¹ 1.13.1 ç‰ˆæœ¬dockerï¼Œå­˜é‡å®¿ä¸»è¾ƒå¤šï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥ device or resource busy é—®é¢˜ï¼ŒåŸºæœ¬ä¹Ÿä¸ä¼šç»™çº¿ä¸ŠæœåŠ¡å¸¦æ¥ä»€ä¹ˆå½±å“ é’ˆå¯¹ 18.06.3-ce ç‰ˆæœ¬dockerï¼Œå­˜é‡å®¿ä¸»è¾ƒå°‘ï¼Œæˆ‘ä»¬åˆ é™¤dockeræœåŠ¡çš„systemdé…ç½®é¡¹ MountFlagsï¼Œé€šè¿‡æ•…éšœè‡ªæ„ˆè§£å†³dockerå¡åœ¨é—®é¢˜ åœ¨å®¹å™¨åˆ›å»ºåï¼Œå¸è½½å®¹å™¨è¯»å†™å±‚æŒ‚è½½ï¼Œå¦‚æœä¸å½±å“å®¹å™¨å†…æ–‡ä»¶è®¿é—®ã€‚é‚£ä¹ˆå¯ä»¥ç›´æ¥å¸è½½æ‰€æœ‰æŒ‚è½½ç‚¹ï¼Œä¿®æ”¹dockeré…ç½®ï¼Œå¹¶é‡å¯dockeræœåŠ¡ã€æœ¬æ–¹æ¡ˆå°šæœªéªŒè¯ã€‘ é’ˆå¯¹å¢é‡å®¿ä¸»ï¼Œå…¨éƒ¨åˆ é™¤dockeræœåŠ¡çš„systemdé…ç½®é¡¹ MountFlags ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating2/:0:5","tags":["docker"],"title":"Pod terminating2","uri":"https://www.likakuli.com/posts/docker-pod-terminating2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":" è½¬è½½è‡ªç»„å†…åŒäº‹stupig ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating/:0:0","tags":["docker"],"title":"Pod terminating","uri":"https://www.likakuli.com/posts/docker-pod-terminating/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"1. èƒŒæ™¯ è¿‘æœŸï¼Œå¼¹æ€§äº‘çº¿ä¸Šé›†ç¾¤å‘ç”Ÿäº†å‡ èµ·ç‰¹æ®Šçš„å®¹å™¨æ¼‚ç§»å¤±è´¥äº‹ä»¶ï¼Œå…¶ç‰¹æ®Šä¹‹å¤„åœ¨äºå®¹å™¨å¤„äºPod TerminatingçŠ¶æ€ï¼Œè€Œå®¿ä¸»åˆ™å¤„äºReadyçŠ¶æ€ã€‚ å®¿ä¸»çŠ¶æ€ä¸ºReadyè¯´æ˜å…¶èƒ½å¤Ÿæ­£å¸¸å¤„ç†Podäº‹ä»¶ï¼Œä½†æ˜¯Podå´å¡åœ¨äº†é€€å‡ºé˜¶æ®µï¼Œè¯´æ˜æ­¤é—®é¢˜å¹¶éç”±kubeletå¼•èµ·ï¼Œé‚£ä¹ˆdockerå°±æ˜¯1å·çŠ¯ç½ªå«Œç–‘äººäº†ã€‚ ä¸‹æ–‡å°†è¯¦ç»†ä»‹ç»é—®é¢˜çš„æ’æŸ¥ä¸åˆ†æå…¨è¿‡ç¨‹ã€‚ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating/:0:1","tags":["docker"],"title":"Pod terminating","uri":"https://www.likakuli.com/posts/docker-pod-terminating/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"2. æŠ½ä¸å‰¥èŒ§ 2.1 æ’é™¤kubeletå«Œç–‘ PodçŠ¶æ€å¦‚ä¸‹ï¼š [stupig@master ~]$ kubectl get pod -owide pod-976a0-5 0/1 Terminating 0 112m å°½ç®¡kubeletçš„çŠ¯ç½ªå«Œç–‘å·²ç»å¾ˆå°ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯éœ€è¦æ’æŸ¥kubeletæ—¥å¿—è¿›ä¸€æ­¥ç¡®è®¤ã€‚æˆªå–kubeletå…³é”®æ—¥å¿—ç‰‡æ®µå¦‚ä¸‹ï¼š I1014 10:56:46.492682 34976 kubelet_pods.go:1017] Pod \"pod-976a0-5_default(f1e03a3d-0dc7-11eb-b4b1-246e967c4efc)\" is terminated, but some containers have not been cleaned up: {ID:{Type:docker ID:41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef} Name:stupig State:exited CreatedAt:2020-10-14 10:49:57.859913657 +0800 CST StartedAt:2020-10-14 10:49:57.928654495 +0800 CST FinishedAt:2020-10-14 10:50:28.661263065 +0800 CST ExitCode:0 Hash:2101852810 HashWithoutResources:2673273670 RestartCount:0 Reason:Completed Message: Resources:map[CpuQuota:200000 Memory:2147483648 MemorySwap:2147483648]} E1014 10:56:46.709255 34976 remote_runtime.go:250] RemoveContainer \"41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef\" from runtime service failed: rpc error: code = Unknown desc = failed to remove container \"41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef\": Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver \"overlay2\" failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy E1014 10:56:46.709292 34976 kuberuntime_gc.go:126] Failed to remove container \"41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef\": rpc error: code = Unknown desc = failed to remove container \"41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef\": Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver \"overlay2\" failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy æ—¥å¿—æ˜¾ç¤ºkubeletå¤„äºPod TerminatingçŠ¶æ€çš„åŸå› å¾ˆæ¸…æ¥šï¼šæ¸…ç†å®¹å™¨å¤±è´¥ã€‚ kubeletæ¸…ç†å®¹å™¨çš„å‘½ä»¤æ˜¯ docker rm -f ï¼Œå…¶å¤±è´¥çš„åŸå› åœ¨äºåˆ é™¤å®¹å™¨ç›®å½• xxx/merged æ—¶æŠ¥é”™ï¼Œé”™è¯¯æç¤ºä¸º device or resource busy ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œkubeletæ— æ³•å†æä¾›å…¶ä»–å…³é”®ä¿¡æ¯ã€‚ ç™»é™†å®¿ä¸»ï¼Œæˆ‘ä»¬éªŒè¯å¯¹åº”å®¹å™¨çš„çŠ¶æ€ï¼š [stupig@hostname ~]$ sudo docker ps -a | grep pod-976a0-5 41020461ed4d Removal In Progress k8s_stupig_pod-976a0-5_default_f1e03a3d-0dc7-11eb-b4b1-246e967c4efc_0 f0a75e10b252 Exited (0) 2 minutes ago k8s_POD_pod-976a0-5_default_f1e03a3d-0dc7-11eb-b4b1-246e967c4efc_0 [stupig@hostname ~]$ sudo docker rm -f 41020461ed4d Error response from daemon: container 41020461ed4d801afa8d10847a16907e65f6e8ca34d1704edf15b0d0e72bf4ef: driver \"overlay2\" failed to remove root filesystem: unlinkat /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged: device or resource busy é—®é¢˜å·²ç„¶æ¸…æ¥šï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ç§æ’æŸ¥æ€è·¯ï¼š å‚è€ƒGoogleä¸Šè§£å†³ device or resource busy é—®é¢˜çš„æ€è·¯ ç»“åˆç°è±¡åˆ†æä»£ç  2.2 Googleå¤§æ³• æœ‰é—®é¢˜æ‰¾Googleï¼æ‰€ä»¥ï¼Œæˆ‘ä»¬é¦–å…ˆå’¨è¯¢äº†Googleï¼Œæ£€ç´¢ç»“æœæ˜¾ç¤ºå¾ˆå¤šäººéƒ½ç¢°åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ã€‚ è€Œç½‘ç»œä¸Šä¸»æµçš„è§£å†³æ–¹æ¡ˆï¼šé…ç½®dockeræœåŠ¡MountFlagsä¸ºslaveï¼Œé¿å…dockeræŒ‚è½½ç‚¹ä¿¡æ¯æ³„æ¼åˆ°å…¶ä»–mntå‘½åç©ºé—´ï¼Œè¯¦ç»†åŸå› è¯·å‚é˜…ï¼šdocker device busyé—®é¢˜è§£å†³æ–¹æ¡ˆã€‚ è¿™ä¹ˆç®€å•ï¼Ÿï¼Ÿï¼Ÿæ˜¾ç„¶ä¸èƒ½ï¼Œæ£€æŸ¥å‘ç°dockeræœåŠ¡å½“å‰å·²é…ç½®MountFlagsä¸ºslaveã€‚ç½‘ç»œé“¶å¼¹å†æ¬¡å¤±å»åŠŸæ•ˆã€‚ soï¼Œæˆ‘ä»¬è¿˜æ˜¯è€è€å®å®ç»“åˆç°åœºåˆ†æä»£ç å§ã€‚ 2.3 dockerå¤„ç†æµç¨‹ åœ¨å…·ä½“åˆ†ædockerä»£ç ä¹‹å‰ï¼Œå…ˆç®€å•ä»‹ç»ä¸‹dockerçš„å¤„ç†æµç¨‹ï¼Œé¿å…ä½œä¸ºä¸€åªæ— å¤´è‹è‡å¤„å¤„ç¢°å£ã€‚ æ¸…æ¥šäº†dockerçš„å¤„ç†æµç¨‹ä¹‹åï¼Œæˆ‘ä»¬å†æ¥åˆ†æç°åœºã€‚ 2.4 æå®¡docker é—®é¢˜å‘ç”Ÿåœ¨dockeræ¸…ç†é˜¶æ®µï¼Œdockeræ¸…ç†å®¹å™¨è¯»å†™å±‚å‡ºé”™ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸º device or resource busyï¼Œè¯´æ˜dockerè¯»å†™å±‚å¹¶æ²¡æœ‰è¢«æ­£ç¡®å¸è½½ï¼Œæˆ–è€…æ˜¯æ²¡æœ‰å®Œå…¨å¸è½½ã€‚ä¸‹é¢çš„å‘½ä»¤å¯ä»¥éªŒè¯è¿™ä¸ªç»“è®ºï¼š [stupig@hostname ~]$ grep -rwn '/home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged' /proc/*/mountinfo /proc/22283/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/22407/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX /proc/28454/mountinfo:50:386 542 0:92 / /home/docker_rt/overlay2/e5dab77be213d9f9cfc0b0b3281dbef9c2878fee3b8e406bc8ab97adc30ae4d5/merged rw,relatime - overlay overlay rw,lowerdir=XXX,upperdir=XXX,workdir=XXX","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating/:0:2","tags":["docker"],"title":"Pod terminating","uri":"https://www.likakuli.com/posts/docker-pod-terminating/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"3. é—®é¢˜å½±å“ æ—¢ç„¶æ‰€æœ‰ç‰ˆæœ¬çš„dockeréƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆå…¶å½±å“æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ åœ¨é«˜ç‰ˆæœ¬dockerä¸­ï¼Œå…¶å½±å“æ˜¯æ˜¾å¼çš„ï¼Œä¼šå¼•èµ·å®¹å™¨æ¸…ç†å¤±è´¥ï¼Œè¿›è€Œé€ æˆPodåˆ é™¤å¤±è´¥ã€‚ è€Œåœ¨ä½ç‰ˆæœ¬dockerä¸­ï¼Œå…¶å½±å“æ˜¯éšå¼çš„ï¼Œé€ æˆæŒ‚è½½ç‚¹æ³„æ¼ï¼Œè¿›è€Œå¯èƒ½ä¼šé€ æˆçš„å½±å“å¦‚ä¸‹ï¼š inodeè¢«æ‰“æ»¡ï¼šç”±äºæŒ‚è½½ç‚¹æ³„æ¼ï¼Œå®¹å™¨è¯»å†™å±‚ä¸ä¼šè¢«æ¸…ç†ï¼Œé•¿æ—¶é—´ç´¯è®¡å¯èƒ½ä¼šé€ æˆinodeè€—å°½é—®é¢˜ï¼Œä½†æ˜¯æ˜¯å°æ¦‚ç‡äº‹ä»¶ å®¹å™¨IDå¤ç”¨ï¼šç”±äºæŒ‚è½½ç‚¹æœªè¢«å¸è½½ï¼Œå½“dockerå¤ç”¨äº†åŸæ¥å·²ç»é€€å‡ºçš„å®¹å™¨IDæ—¶ï¼Œåœ¨æŒ‚è½½å®¹å™¨initå±‚ä¸è¯»å†™å±‚æ—¶ä¼šå¤±è´¥ã€‚ç”±äºdockerç”Ÿæˆå®¹å™¨IDæ˜¯éšæœºçš„ï¼Œå› æ­¤ä¹Ÿæ˜¯å°æ¦‚ç‡äº‹ä»¶ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating/:0:3","tags":["docker"],"title":"Pod terminating","uri":"https://www.likakuli.com/posts/docker-pod-terminating/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"4. è§£å†³æ–¹æ¡ˆ é—®é¢˜å·²ç„¶æ˜ç¡®ï¼Œå¦‚ä½•è§£å†³é—®é¢˜æˆäº†å½“åŠ¡ä¹‹æ€¥ã€‚æ€è·¯æœ‰äºŒï¼š æ²»æ ‡ï¼šå¯¹æ ‡ 1.13.1 ç‰ˆæœ¬çš„å¤„ç†é€»è¾‘ï¼Œä¿®æ”¹ 18.06.3-ce å¤„ç†ä»£ç  æ²»æœ¬ï¼šæ—¢ç„¶å®˜æ–¹ä¹ŸæåŠ MountFlags=slave ä¸ live-restore ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¿®æ”¹ä¸¤ä¸ªé…ç½®é€‰é¡¹ä¹‹ä¸€å³å¯ è€ƒè™‘åˆ° é‡å¯dockerä¸é‡å¯å®¹å™¨ è¿™æ ·ä¸€ä¸ªå¼ºéœ€æ±‚çš„å­˜åœ¨ï¼Œä¼¼ä¹æˆ‘ä»¬å”¯ä¸€çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å…³é—­ MountFlags=slave é…ç½®ã€‚å…³é—­è¯¥é…ç½®åï¼Œä¸ä¹‹è€Œæ¥çš„ç–‘é—®å¦‚ä¸‹ï¼š èƒ½å¤Ÿè§£å†³æœ¬é—®é¢˜ï¼Ÿ ç½‘ä¼ å…¶ä»–systemdæ‰˜ç®¡æœåŠ¡å¯ç”¨PrivateTmpæ˜¯å¦ä¼šé€ æˆæŒ‚è½½ç‚¹æ³„æ¼ï¼Ÿ æ¬²çŸ¥åäº‹å¦‚ä½•ï¼Œä¸”å¬ä¸‹å›åˆ†è§£ï¼ ","date":"2020-10-31","objectID":"https://www.likakuli.com/posts/docker-pod-terminating/:0:4","tags":["docker"],"title":"Pod terminating","uri":"https://www.likakuli.com/posts/docker-pod-terminating/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":" è½¬è½½è‡ªç»„å†…åŒäº‹ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:0","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"1. èƒŒæ™¯ æœ€è¿‘å‡çº§äº†ä¸€ç‰ˆkubeletï¼Œä¿®å¤å› kubeletåˆ é™¤Podæ…¢å¯¼è‡´å¹³å°åˆ é™¤é›†ç¾¤è¶…æ—¶çš„é—®é¢˜ã€‚åœ¨ç°åº¦rediséš”ç¦»é›†ç¾¤çš„æ—¶å€™ï¼Œå‘ç°å‡çº§kubeletå¹¶é‡å¯æœåŠ¡åï¼Œå°‘é‡å®¿ä¸»çŠ¶æ€å˜æˆäº†NotReadyï¼Œå¹¶ä¸”å›æ»škubeletè‡³ä¹‹å‰ç‰ˆæœ¬ï¼Œå®¿ä¸»çŠ¶æ€ä»ç„¶æ˜¯NotReadyã€‚æŸ¥çœ‹å®¿ä¸»çŠ¶æ€æ—¶æç¤º â€˜container runtime is downâ€™ ï¼Œæ ¹æ®ç»éªŒï¼Œæ­¤æ—¶ä¸€èˆ¬å°±æ˜¯å®¹å™¨è¿è¡Œæ—¶å‡ºäº†é—®é¢˜ã€‚å¼¹æ€§äº‘ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯dockerï¼Œæˆ‘ä»¬å°±å»æ£€æŸ¥dockerçš„çŠ¶æ€ï¼Œæ£€æµ‹ç»“æœå¦‚ä¸‹ï¼š docker ps æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€ï¼Œæ‰§è¡Œæ­£å¸¸ docker inspect æŸ¥çœ‹æŸä¸€å®¹å™¨è¯¦ç»†çŠ¶æ€ï¼Œæ‰§è¡Œé˜»å¡ å…¸å‹çš„docker hangæ­»è¡Œä¸ºã€‚å› ä¸ºæˆ‘ä»¬æœ€è¿‘åœ¨å‡çº§dockerç‰ˆæœ¬ï¼Œå­˜é‡å®¿ä¸»dockerçš„ç‰ˆæœ¬ä¸º1.13.1ï¼Œå¹¶ä¸”åœ¨é€æ­¥å‡çº§è‡³18.06.3ï¼Œæ–°å®¿ä¸»çš„dockerç‰ˆæœ¬éƒ½æ˜¯18.06.3ã€‚docker hangæ­»é—®é¢˜åœ¨1.13.1ç‰ˆæœ¬ä¸Šè¡¨ç°å¾—æ›´å½»åº•ï¼Œåœ¨æ‰§è¡Œdocker psçš„æ—¶å€™å°±å·²ç»hangæ­»äº†ï¼Œä¸€æ—¦æŸä¸ªå®¹å™¨å‡ºäº†é—®é¢˜ï¼Œdockerå°±å¤„äºæ— å“åº”çŠ¶æ€ï¼›è€Œdocker 18.06.3åšäº†ä¸€ç‚¹å°å°çš„ä¼˜åŒ–ï¼Œåœ¨æ‰§è¡Œdocker psæ—¶å»æ‰äº†é’ˆå¯¹å®¹å™¨çº§åˆ«çš„åŠ é”æ“ä½œï¼Œä½†æ˜¯docker inspectä¾ç„¶ä¼šåŠ å®¹å™¨é”ï¼Œå› æ­¤æŸä¸€ä¸ªå®¹å™¨å‡ºç°é—®é¢˜ï¼Œå¹¶ä¸ä¼šé€ æˆdockeræœåŠ¡ä¸å¯å“åº”ï¼Œå—å½±å“çš„ä¹Ÿä»…ä»…æ˜¯è¯¥å®¹å™¨ï¼Œæ— æ³•æ‰§è¡Œä»»ä½•æ“ä½œã€‚ è‡³äºä¸ºä»€ä¹ˆä»¥docker psä¸docker inspectä¸ºæŒ‡æ ‡æ£€æŸ¥dockerçŠ¶æ€ï¼Œå› ä¸ºkubeletå°±æ˜¯ä¾èµ–è¿™ä¸¤ä¸ªdocker APIè·å–å®¹å™¨çŠ¶æ€ã€‚ æ‰€ä»¥ï¼Œç°åœ¨é—®é¢˜æœ‰äºŒï¼š docker hangæ­»çš„æ ¹å› æ˜¯ä»€ä¹ˆï¼Ÿ docker hangæ­»æ—¶ï¼Œä¸ºä»€ä¹ˆé‡å¯kubeletï¼Œä¼šå¯¼è‡´å®¿ä¸»çŠ¶æ€å˜ä¸ºNotReadyï¼Ÿ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:1","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"2.é‡å¯kubeletå˜æ›´å®¿ä¸»çŠ¶æ€ kubeleté‡å¯åå®¿ä¸»çŠ¶æ€ä»Readyå˜ä¸ºNotReadyï¼Œè¿™ä¸ªé—®é¢˜ç›¸è¾ƒdocker hangæ­»è€Œè¨€ï¼Œæ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ’æŸ¥è¿™ä¸ªé—®é¢˜ã€‚ kubeleté’ˆå¯¹å®¿ä¸»ä¼šè®¾ç½®å¤šä¸ªConditionï¼Œè¡¨æ˜å®¿ä¸»å½“å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œæ¯”å¦‚å®¿ä¸»å†…å­˜æ˜¯å¦å‘Šæ€¥ã€çº¿ç¨‹æ•°æ˜¯å¦å‘Šæ€¥ï¼Œä»¥åŠå®¿ä¸»æ˜¯å¦å°±ç»ªã€‚å…¶ä¸­ReadyConditionè¡¨æ˜å®¿ä¸»æ˜¯å¦å°±ç»ªï¼ŒkubectlæŸ¥çœ‹å®¿ä¸»çŠ¶æ€æ—¶ï¼Œå±•ç¤ºçš„Statueä¿¡æ¯å°±æ˜¯ReadConditionçš„å†…å®¹ï¼Œå¸¸è§çš„çŠ¶æ€åŠå…¶å«ä¹‰å®šä¹‰å¦‚ä¸‹ï¼š ReadyçŠ¶æ€ï¼šè¡¨æ˜å½“å‰å®¿ä¸»çŠ¶æ€ä¸€åˆ‡OKï¼Œèƒ½æ­£å¸¸å“åº”Podäº‹ä»¶ NotReadyçŠ¶æ€ï¼šè¡¨æ˜å®¿ä¸»çš„kubeletä»åœ¨è¿è¡Œï¼Œä½†æ˜¯æ­¤æ—¶å·²ç»æ— æ³•å¤„ç†Podäº‹ä»¶ã€‚NotReadyç»å¤§å¤šæ•°æƒ…å†µéƒ½æ˜¯å®¹å™¨è¿è¡Œæ—¶å‡ºäº†é—®é¢˜ UnknownçŠ¶æ€ï¼šè¡¨æ˜å®¿ä¸»kubeletå·²åœæ­¢è¿è¡Œ kubeletå®šä¹‰çš„ReadyConditionçš„åˆ¤å®šæ¡ä»¶å¦‚ä¸‹ï¼š // defaultNodeStatusFuncs is a factory that generates the default set of // setNodeStatus funcs func (kl *Kubelet) defaultNodeStatusFuncs() []func(*v1.Node) error { ...... setters = append(setters, nodestatus.OutOfDiskCondition(kl.clock.Now, kl.recordNodeStatusEvent), nodestatus.MemoryPressureCondition(kl.clock.Now, kl.evictionManager.IsUnderMemoryPressure, kl.recordNodeStatusEvent), nodestatus.DiskPressureCondition(kl.clock.Now, kl.evictionManager.IsUnderDiskPressure, kl.recordNodeStatusEvent), nodestatus.PIDPressureCondition(kl.clock.Now, kl.evictionManager.IsUnderPIDPressure, kl.recordNodeStatusEvent), nodestatus.ReadyCondition(kl.clock.Now, kl.runtimeState.runtimeErrors, kl.runtimeState.networkErrors, validateHostFunc, kl.containerManager.Status, kl.recordNodeStatusEvent), nodestatus.VolumesInUse(kl.volumeManager.ReconcilerStatesHasBeenSynced, kl.volumeManager.GetVolumesInUse), // TODO(mtaufen): I decided not to move this setter for now, since all it does is send an event // and record state back to the Kubelet runtime object. In the future, I'd like to isolate // these side-effects by decoupling the decisions to send events and partial status recording // from the Node setters. kl.recordNodeSchedulableEvent, ) return setters } æ·±å…¥nodestatus.ReadyConditionçš„å®ç°å¯ä»¥å‘ç°ï¼Œå®¿ä¸»æ˜¯å¦Readyå–å†³äºå¾ˆå¤šæ¡ä»¶ï¼ŒåŒ…å«è¿è¡Œæ—¶åˆ¤å®šã€ç½‘ç»œåˆ¤å®šã€åŸºæœ¬èµ„æºåˆ¤å®šç­‰ã€‚è¿™é‡Œæˆ‘ä»¬åªéœ€å…³æ³¨è¿è¡Œæ—¶åˆ¤å®šå³å¯ï¼š func (s *runtimeState) runtimeErrors() []string { s.RLock() defer s.RUnlock() var ret []string if !s.lastBaseRuntimeSync.Add(s.baseRuntimeSyncThreshold).After(time.Now()) { // 1 ret = append(ret, \"container runtime is down\") } if s.internalError != nil { ret = append(ret, s.internalError.Error()) } for _, hc := range s.healthChecks { // 2 if ok, err := hc.fn(); !ok { ret = append(ret, fmt.Sprintf(\"%s is not healthy: %v\", hc.name, err)) } } return ret } å½“å‡ºç°å¦‚ä¸‹ä¸¤ç§çŠ¶å†µä¹‹ä¸€æ—¶ï¼Œåˆ™åˆ¤å®šè¿è¡Œæ—¶æ£€æŸ¥ä¸é€šè¿‡ï¼š è·æœ€è¿‘ä¸€æ¬¡è¿è¡Œæ—¶åŒæ­¥æ“ä½œçš„æ—¶é—´é—´éš”è¶…è¿‡æŒ‡å®šé˜ˆå€¼ï¼ˆé»˜è®¤30sï¼‰ è¿è¡Œæ—¶å¥åº·æ£€æŸ¥æœªé€šè¿‡ é‚£ä¹ˆï¼Œå½“æ—¶å®¿ä¸»çš„NotReadyæ˜¯ç”±å“ªç§çŠ¶å†µå¼•èµ·çš„å‘¢ï¼Ÿç»“åˆkubeletæ—¥å¿—åˆ†æï¼Œkubeletæ¯éš”5så°±è¾“å‡ºä¸€æ¡æ—¥å¿—ï¼š ...... I0715 10:43:28.049240 16315 kubelet.go:1835] skipping pod synchronization - [container runtime is down] I0715 10:43:33.049359 16315 kubelet.go:1835] skipping pod synchronization - [container runtime is down] I0715 10:43:38.049492 16315 kubelet.go:1835] skipping pod synchronization - [container runtime is down] ...... å› æ­¤ï¼ŒçŠ¶å†µ1æ˜¯å®¿ä¸»NotReadyçš„å…ƒå‡¶ã€‚ æˆ‘ä»¬ç»§ç»­åˆ†æä¸ºä»€ä¹ˆkubeletæ²¡æœ‰æŒ‰ç…§é¢„æœŸè®¾ç½®lastBaseRuntimeSyncã€‚kubeletå¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªgoroutineï¼Œå¹¶åœ¨è¯¥goroutineä¸­å¾ªç¯è®¾ç½®lastBaseRuntimeSyncï¼Œå¾ªç¯å¦‚ä¸‹ï¼š func (kl *Kubelet) Run(updates \u003c-chan kubetypes.PodUpdate) { ...... go wait.Until(kl.updateRuntimeUp, 5*time.Second, wait.NeverStop) ...... } func (kl *Kubelet) updateRuntimeUp() { kl.updateRuntimeMux.Lock() defer kl.updateRuntimeMux.Unlock() ...... kl.oneTimeInitializer.Do(kl.initializeRuntimeDependentModules) kl.runtimeState.setRuntimeSync(kl.clock.Now()) } æ­£å¸¸æƒ…å†µä¸‹ï¼Œkubeletæ¯éš”5sä¼šå°†lastBaseRuntimeSyncè®¾ç½®ä¸ºå½“å‰æ—¶é—´ï¼Œè€Œå®¿ä¸»çŠ¶æ€å¼‚å¸¸æ—¶ï¼Œè¿™ä¸ªæ—¶é—´æˆ³ä¸€ç›´æœªè¢«æ›´æ–°ã€‚ä¹Ÿå³updateRuntimeUpä¸€ç›´è¢«é˜»å¡åœ¨è®¾ç½®lastBaseRuntimeSyncä¹‹å‰çš„æŸä¸€æ­¥ã€‚æˆ‘ä»¬åªéœ€é€ä¸ªæ’æŸ¥updateRuntimeUpå†…çš„å‡½æ•°è°ƒç”¨å³å¯ï¼Œå…·ä½“è¿‡ç¨‹ä¸å†å±•ç¤ºï¼Œæœ€ç»ˆçš„å‡½æ•°è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š initializeRuntimeDependentModules -\u003e kl.cadvisor.Start -\u003e cc.Manager.Start -\u003e self.createContainer -\u003e m.createContainerLocked -\u003e container.NewContainerHandler -\u003e factory.CanHandleAndAccept -\u003e self.client.ContainerInspect ç”±äºæŸä¸ªå®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œkubeletæ‰§è¡Œdocker inspectæ“ä½œä¹Ÿè¢«hangæ­»ã€‚ å› æ­¤ï¼Œé‡å¯kubeletå¼•èµ·å®¿ä¸»çŠ¶æ€ä»Readyå˜ä¸ºNotReadyï¼Œå…¶æ ¹å› åœ¨äºæŸä¸ªå®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼Œæ‰§è¡Œdocker inspectæ—¶è¢«hangæ­»ã€‚è€Œå¦‚æœdocker inspect hangæ­»å‘ç”Ÿåœ¨kubeleté‡å¯ä¹‹åï¼Œåˆ™ä¸ä¼šå¯¹å®¿ä¸»çš„ReadyçŠ¶æ€é€ æˆä»»ä½•å½±å“ï¼Œå› ä¸ºoneTimeInitializeræ˜¯sync.Onceç±»å‹ï¼Œä¹Ÿå³ä»…ä»…ä¼šåœ¨kebeletå¯åŠ¨æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚é‚£æ—¶kubeletä»…ä»…æ˜¯ä¸èƒ½å¤„ç†è¯¥Podç›¸å…³çš„ä»»ä½•äº‹ä»¶ï¼ŒåŒ…å«åˆ é™¤ã€å˜æ›´ç­‰ï¼Œä½†æ˜¯ä»ç„¶èƒ½å¤Ÿå¤„ç†å…¶ä»–Podçš„ä»»æ„äº‹ä»¶ã€‚ å¯èƒ½æœ‰äººä¼šé—®ï¼Œä¸ºä»€ä¹ˆkubeleté‡å¯æ—¶è®¿é—®docker inspectæ“ä½œä¸åŠ è¶…æ—¶æ§åˆ¶ï¼Ÿç¡®å®ï¼Œå¦‚æœæ·»åŠ äº†è¶…æ—¶æ§åˆ¶ï¼Œkubeleté‡å¯ä¸ä¼šå¼•èµ·å®¿ä¸»çŠ¶æ€å˜æ›´ã€‚å¾…è¯¦ç»†æŒ–æ˜åå†æ¥è¡¥å……ï¼Œæˆ‘ä»¬å…ˆç»§ç»­åˆ†ædocker hangæ­»çš„é—®é¢˜ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:2","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"3. docker hangæ­» æˆ‘ä»¬å¯¹docker hangæ­»å¹¶ä¸é™Œç”Ÿï¼Œå› ä¸ºå·²ç»å‘ç”Ÿäº†å¥½å¤šèµ·ã€‚å…¶å‘ç”Ÿæ—¶çš„ç°è±¡ä¹Ÿå¤šç§å¤šæ ·ã€‚ä»¥å¾€é’ˆå¯¹docker 1.13.1ç‰ˆæœ¬çš„æ’æŸ¥éƒ½å‘ç°äº†ä¸€äº›çº¿ç´¢ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å®šä½åˆ°æ ¹å› ï¼Œæœ€ç»ˆç»å¤§å¤šæ•°ä¹Ÿæ˜¯é€šè¿‡é‡å¯dockerè§£å†³ã€‚è€Œè¿™ä¸€æ¬¡å‘ç”Ÿåœ¨docker 18.06.3ç‰ˆæœ¬çš„docker hangæ­»è¡Œä¸ºï¼Œç»è¿‡æˆ‘ä»¬4äººå°åˆ†é˜Ÿæ¥è¿‘ä¸€å‘¨çš„æœ›é—»é—®åˆ‡ï¼Œç»ˆäºç¡®å®šäº†å…¶ç—…å› ã€‚æ³¨æ„ï¼Œdocker hangæ­»çš„åŸå› ä¸æ­¢ä¸€ç§ï¼Œå› æ­¤æœ¬å¤„æ–¹å¹¶éæ˜¯ä¸ªä¸‡èƒ½è¯ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬æŒæ¡çš„çŸ¥è¯†ä»…ä»…æ˜¯dockerå¼‚å¸¸äº†ï¼Œæ— æ³•å“åº”ç‰¹å®šå®¹å™¨çš„docker inspectæ“ä½œï¼Œè€Œå¯¹è¯¦ç»†ä¿¡æ¯åˆ™ä¸€æ— æ‰€çŸ¥ã€‚ 3.1 é“¾è·¯è·Ÿè¸ª é¦–å…ˆï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹dockerè¿è¡Œçš„å…¨å±€çŠ¶å†µæœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œç†Ÿæ‚‰goè¯­è¨€å¼€å‘çš„ç”¨æˆ·è‡ªç„¶èƒ½è”æƒ³åˆ°ç¥å™¨pprofã€‚æˆ‘ä»¬å€ŸåŠ©pprofæç»˜å‡ºäº†dockerå½“æ—¶è¿è¡Œçš„è“å›¾ï¼š goroutine profile: total 722373 717594 @ 0x7fe8bc202980 0x7fe8bc202a40 0x7fe8bc2135d8 0x7fe8bc2132ef 0x7fe8bc238c1a 0x7fe8bd56f7fe 0x7fe8bd56f6bd 0x7fe8bcea8719 0x7fe8bcea938b 0x7fe8bcb726ca 0x7fe8bcb72b01 0x7fe8bc71c26b 0x7fe8bcb85f4a 0x7fe8bc4b9896 0x7fe8bc72a438 0x7fe8bcb849e2 0x7fe8bc4bc67e 0x7fe8bc4b88a3 0x7fe8bc230711 # 0x7fe8bc2132ee sync.runtime_SemacquireMutex+0x3e /usr/local/go/src/runtime/sema.go:71 # 0x7fe8bc238c19 sync.(*Mutex).Lock+0x109 /usr/local/go/src/sync/mutex.go:134 # 0x7fe8bd56f7fd github.com/docker/docker/daemon.(*Daemon).ContainerInspectCurrent+0x8d /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/daemon/inspect.go:40 # 0x7fe8bd56f6bc github.com/docker/docker/daemon.(*Daemon).ContainerInspect+0x11c /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/daemon/inspect.go:29 # 0x7fe8bcea8718 github.com/docker/docker/api/server/router/container.(*containerRouter).getContainersByName+0x118 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/router/container/inspect.go:15 # 0x7fe8bcea938a github.com/docker/docker/api/server/router/container.(*containerRouter).(github.com/docker/docker/api/server/router/container.getContainersByName)-fm+0x6a /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/router/container/container.go:39 # 0x7fe8bcb726c9 github.com/docker/docker/api/server/middleware.ExperimentalMiddleware.WrapHandler.func1+0xd9 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/middleware/experimental.go:26 # 0x7fe8bcb72b00 github.com/docker/docker/api/server/middleware.VersionMiddleware.WrapHandler.func1+0x400 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/middleware/version.go:62 # 0x7fe8bc71c26a github.com/docker/docker/pkg/authorization.(*Middleware).WrapHandler.func1+0x7aa /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/pkg/authorization/middleware.go:59 # 0x7fe8bcb85f49 github.com/docker/docker/api/server.(*Server).makeHTTPHandler.func1+0x199 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/server.go:141 # 0x7fe8bc4b9895 net/http.HandlerFunc.ServeHTTP+0x45 /usr/local/go/src/net/http/server.go:1947 # 0x7fe8bc72a437 github.com/docker/docker/vendor/github.com/gorilla/mux.(*Router).ServeHTTP+0x227 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/vendor/github.com/gorilla/mux/mux.go:103 # 0x7fe8bcb849e1 github.com/docker/docker/api/server.(*routerSwapper).ServeHTTP+0x71 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/api/server/router_swapper.go:29 # 0x7fe8bc4bc67d net/http.serverHandler.ServeHTTP+0xbd /usr/local/go/src/net/http/server.go:2694 # 0x7fe8bc4b88a2 net/http.(*conn).serve+0x652 /usr/local/go/src/net/http/server.go:1830 4175 @ 0x7fe8bc202980 0x7fe8bc202a40 0x7fe8bc2135d8 0x7fe8bc2132ef 0x7fe8bc238c1a 0x7fe8bcc2eccf 0x7fe8bd597af4 0x7fe8bcea2456 0x7fe8bcea956b 0x7fe8bcb73dff 0x7fe8bcb726ca 0x7fe8bcb72b01 0x7fe8bc71c26b 0x7fe8bcb85f4a 0x7fe8bc4b9896 0x7fe8bc72a438 0x7fe8bcb849e2 0x7fe8bc4bc67e 0x7fe8bc4b88a3 0x7fe8bc230711 # 0x7fe8bc2132ee sync.runtime_SemacquireMutex+0x3e /usr/local/go/src/runtime/sema.go:71 # 0x7fe8bc238c19 sync.(*Mutex).Lock+0x109 /usr/local/go/src/sync/mutex.go:134 # 0x7fe8bcc2ecce github.com/docker/docker/container.(*State).IsRunning+0x2e /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com/docker/docker/container/state.go:240 # 0x7fe8bd597af3 github.com/docker/docker/daemon.(*Daemon).ContainerStats+0xb3 /root/rpmbuild/BUILD/src/engine/.gopath/src/github.com","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:3","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"4. è§£å†³æ–¹æ¡ˆ å½“å¤§å®¶äº†è§£äº†docker hangæ­»çš„æˆå› ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ€§çš„æå‡ºå¦‚ä¸‹è§£å†³åŠæ³•ã€‚ 4.1 æœ€ç›´è§‚çš„åŠæ³• æ—¢ç„¶docker execå¯èƒ½ä¼šå¼•èµ·docker hangæ­»ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç¦ç”¨ç³»ç»Ÿä¸­æ‰€æœ‰çš„docker execæ“ä½œå³å¯ã€‚æœ€å…¸å‹çš„æ˜¯kubeletçš„probeï¼Œå½“å‰æˆ‘ä»¬é»˜è®¤ç»™æ‰€æœ‰Podæ·»åŠ äº†ReadinessProbeï¼Œå¹¶ä¸”æ˜¯ä»¥execçš„å½¢å¼è¿›å…¥å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ã€‚æˆ‘ä»¬è°ƒæ•´kubeletçš„æ¢æµ‹è¡Œä¸ºï¼Œä¿®æ”¹ä¸ºtcpæˆ–è€…http probeå³å¯ã€‚ è¿™é‡Œè™½ç„¶æ”¹åŠ¨ä¸å¤§ï¼Œä½†æ˜¯æ¶‰åŠä¸šåŠ¡å®¹å™¨çš„æ”¹é€ æˆæœ¬å¤ªå¤§äº†ï¼Œå¦‚ä½•è¿ç§»å­˜é‡é›†ç¾¤æ˜¯ä¸ªå¤§é—®é¢˜ã€‚ 4.2 æœ€æ ¹æœ¬çš„åŠæ³• æ—¢ç„¶å½“å‰containerd-shimè¯»pipeéœ€è¦ç­‰å¾…runc execæ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœæˆ‘ä»¬å°†è¯»pipeçš„æ“ä½œæå‰è‡³runc execå‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç†è®ºä¸Šä¹Ÿå¯ä»¥é¿å…æ­»é”ã€‚ åŒæ ·ã€‚è¿™ç§æ–¹æ¡ˆçš„å‡çº§æˆæœ¬å¤ªé«˜äº†ï¼Œå‡çº§containerd-shimæ—¶éœ€è¦é‡å¯å­˜é‡çš„æ‰€æœ‰å®¹å™¨ï¼Œè¿™ä¸ªæ–¹æ¡ˆåŸºæœ¬ä¸å¯èƒ½é€šè¿‡ã€‚ 4.3 æœ€ç®€å•çš„åŠæ³• æ—¢ç„¶runc inité˜»å¡åœ¨å†™pipeï¼Œæˆ‘ä»¬ä¸»åŠ¨è¯»å–pipeå†…çš„å†…å®¹ï¼Œä¹Ÿèƒ½è®©runc inité¡ºåˆ©æ¨å‡ºã€‚ å†å°†æœ¬è§£å†³æ–¹æ¡ˆè‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•èƒ½å¤Ÿè¯†åˆ«å¦‚docker hangæ­»æ˜¯ç”±äºå†™pipeå¯¼è‡´çš„ï¼Œæ˜¯ä¸€ä¸ªå°å°çš„æŒ‘æˆ˜ã€‚ä½†æ˜¯ç›¸å¯¹äºä»¥ä¸Šä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œæˆ‘è®¤ä¸ºè¿˜æ˜¯å€¼å¾—ä¸€è¯•ï¼Œæ¯•ç«Ÿå½±å“é¢å¾®ä¹å…¶å¾®ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:4","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"5. åç»­ docker hangæ­»çš„åŸå› è¿œéè¿™ä¸€ç§ï¼Œæœ¬æ¬¡æ’æŸ¥çš„ç»“æœä¹Ÿå¹¶éé€‚ç”¨äºæ‰€æœ‰åœºæ™¯ã€‚å¸Œæœ›å„ä½çœ‹å®˜èƒ½å¤Ÿæ ¹æ®è‡ªå·±çš„ç°åœºæ’æŸ¥é—®é¢˜ã€‚å¦å¤–æŸ¥çœ‹linuxæ–‡æ¡£ï¼Œpipe capacityæ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œé«˜ç‰ˆæœ¬ä¸­since 4.5ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®/proc/sys/fs/pipe-user-pages-softæ¥è§£å†³ï¼Œä½†æ˜¯å¦‚æ–‡æ¡£æ‰€è¯´ï¼Œåœ¨4.9ä¹‹å‰/proc/sys/fs/pipe-user-pages-softè¿˜æ˜¯å­˜åœ¨ä¸€äº›bugçš„ï¼Œè‡³äºé‡‡ç”¨ä»€ä¹ˆåŠæ³•è§£å†³ï¼Œè¿˜å¾—æ ¹æ®è‡ªå·±æƒ…å†µæ¥åšé€‰æ‹©ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/docker-hang/:0:5","tags":["docker"],"title":"docker hangé—®é¢˜æ’æŸ¥","uri":"https://www.likakuli.com/posts/docker-hang/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"1. æ­å¼€é¢çº± å‘¨ä¸€ï¼Œæ¥åˆ°RDåé¦ˆçº¿ä¸Šå®¹å™¨ç½‘ç»œè®¿é—®å­˜åœ¨å¼‚å¸¸ï¼Œå…·ä½“çº¿ä¸Šæè¿°å¦‚ä¸‹ï¼š ä¸Šæ¸¸æœåŠ¡driver-apiæ‰€æœ‰å®¹å™¨è®¿é—®ä¸‹æ¸¸æœåŠ¡duse-apiæŸä¸€å®¹å™¨TCPã€telnetæµ‹è¯•ã€‘è¿æ¥ä¸é€šï¼Œè®¿é—®å…¶ä½™ä¸‹æ¸¸å®¹å™¨å‡æ­£å¸¸ ä¸Šæ¸¸æœåŠ¡å®¹å™¨æµ‹è¯•ä¸‹æ¸¸å®¹å™¨IPè¿é€šæ€§ã€pingæµ‹è¯•ã€‘æ­£å¸¸ ä»ä»¥ä¸Šä¸¤ç‚¹ç°è±¡å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š å®¹å™¨çš„ç½‘ç»œè®¾å¤‡å­˜åœ¨ï¼ŒIPåœ°å€è¿é€šï¼Œä½†æ˜¯å®¹å™¨æœåŠ¡è¿›ç¨‹æœªå¯åŠ¨ï¼Œç«¯å£æœªå¯åŠ¨ ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å’Œä¸šåŠ¡RDç¡®è®¤ä¹‹åï¼Œå‘ç°ä¸šåŠ¡å®¹å™¨çŠ¶æ€æ­£å¸¸ï¼Œä¸šåŠ¡è¿›ç¨‹ä¹Ÿæ­£è¿è¡Œç€ã€‚å—¯ï¼Œé—®é¢˜ä¸ç®€å•ã€‚ æ­¤å¤–ï¼Œé£å“¥è¿™è¾¹æ’æŸ¥è¿˜æœ‰ä¸€ä¸ªç»“è®ºï¼š arpåå‘è§£æduse-apiç‰¹æ®Šå®¹å™¨IPæ—¶ï¼Œä¸è¿”å›MACåœ°å€ä¿¡æ¯ å½“telnetå¤±è´¥åï¼Œç«‹å³æ‰§è¡Œarpï¼Œä¼šè¿”å›MACåœ°å€ä¿¡æ¯ å½“æˆ‘ä»¬æ‹¿ç€arpè§£æçš„MACåœ°å€ä¸å®¹å™¨å½“å‰çš„MACåœ°å€ä½œæ¯”è¾ƒæ—¶ï¼Œå‘ç°MACåœ°å€ä¸ä¸€è‡´ã€‚å””ï¼ŒåŸºæœ¬ä¸Šç¡®å®šé—®é¢˜æ‰€åœ¨äº†ï¼Œnet nsæ³„æ¼äº†ã€‚æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤éªŒè¯ï¼š sudo ip netns ls | while read ns; do sudo ip netns exec $ns ip addr; done | grep inet | grep -v 127 | awk '{print $2}' | sort | uniq -c ç¡®å®å‘ç°è¯¥å®¹å™¨å¯¹åº”çš„IPå‡ºç°äº†ä¸¤æ¬¡ï¼Œè¯¥å®¹å™¨IPå¯¹åº”äº†ä¸¤ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œä¹Ÿå³è¯¥å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´å‡ºç°äº†æ³„æ¼ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/netns-leak/:0:1","tags":["cni"],"title":"netnsæ³„éœ²","uri":"https://www.likakuli.com/posts/netns-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"2. è¯¯å…¥è¿·éšœ å½“ç¡®å®šäº†é—®é¢˜æ‰€åœ¨ä¹‹åï¼Œæˆ‘ä»¬ç«‹é©¬è°ƒè½¬æ’æŸ¥æ–¹å‘ï¼Œé‡æ–°æŠ•å…¥åˆ°net nsæ³„æ¼çš„æ’æŸ¥äº‹ä¸šå½“ä¸­ã€‚ æ—¢ç„¶net nså‡ºç°äº†æ³„æ¼ï¼Œæˆ‘ä»¬åªéœ€è¦æ’æŸ¥è¢«æ³„éœ²çš„net nsçš„æˆå› å³å¯ã€‚åœ¨å…·ä½“å®šä½ä¹‹å‰ï¼Œé¦–å…ˆè¡¥å……ä¸€ä¸ªèƒŒæ™¯ï¼š ip netns å‘½ä»¤é»˜è®¤æ‰«æ /var/run/netns ç›®å½•ï¼Œä»è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶è¯»å–net nsçš„ä¿¡æ¯ é»˜è®¤æƒ…å†µä¸‹ï¼Œkubeletè°ƒç”¨dockeråˆ›å»ºå®¹å™¨æ—¶ï¼Œdockerä¼šå°†net nsæ–‡ä»¶éšè—ï¼Œå¦‚æœä¸åšç‰¹æ®Šå¤„ç†ï¼Œæˆ‘ä»¬æ‰§è¡Œ ip netns å‘½ä»¤å°†çœ‹ä¸åˆ°ä»»ä½•æ•°æ® å½“å‰å¼¹æ€§äº‘ä¸ºäº†æ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼Œåšäº†ä¸€ä¸ªç‰¹æ®Šå¤„ç†ï¼Œå°†å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´mountåˆ° /var/run/netns ç›®å½• ã€æ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸ªå¤§å‘ã€‘ æœ‰äº†å¼¹æ€§äº‘å½“å‰çš„ç‰¹æ®Šå¤„ç†ï¼Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“æ‰€æœ‰net nsçš„åˆ›å»ºæ—¶é—´ï¼Œä¹Ÿå³ /var/run/netns ç›®å½•ä¸‹å¯¹åº”æ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ã€‚ æˆ‘ä»¬æŸ¥çœ‹è¯¥æ³„æ¼nsæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´ä¸º2020-04-17 11:34:07ï¼Œæ’æŸ¥èŒƒå›´è¿›ä¸€æ­¥ç¼©å°ï¼Œåªéœ€ä»è¯¥æ—¶é—´ç‚¹é™„è¿‘æ’æŸ¥å³å¯ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æäº†è¯¥é™„è¿‘æ—¶é—´æ®µï¼Œå®¹å™¨ç©¶ç«Ÿé­é‡äº†ä»€ä¹ˆï¼š 2020-04-17 11:33:26 ç”¨æˆ·æ‰§è¡Œå‘å¸ƒæ›´æ–°æ“ä½œ 2020-04-17 11:34:24 å¹³å°æ˜¾ç¤ºå®¹å™¨å·²å¯åŠ¨ 2020-04-17 11:34:28 å¹³å°æ˜¾ç¤ºå®¹å™¨å¯åŠ¨è„šæœ¬æ‰§è¡Œå¤±è´¥ 2020-04-17 11:36:22 ç”¨æˆ·é‡æ–°éƒ¨ç½²è¯¥å®¹å™¨ 2020-04-17 11:36:31 å¹³å°æ˜¾ç¤ºå®¹å™¨å·²åˆ é™¤æˆåŠŸ æ—¢ç„¶æ˜¯å®¹å™¨ç½‘ç»œå‘½åç©ºé—´æ³„æ¼ï¼Œåˆ™è¯´æ˜å†åˆ é™¤å®¹å™¨çš„æ—¶å€™ï¼Œæ²¡æœ‰æ‰§è¡Œnsçš„æ¸…ç†æ“ä½œã€‚ã€æ³¨ï¼šè¿™é‡Œç”±äºåŸºç¡€çŸ¥è¯†ä¸è¶³ï¼Œå¯¼è‡´é—®é¢˜****æ’æŸ¥ç»•äº†åœ°çƒä¸€åœˆã€‘ æˆ‘ä»¬æ¢³ç†kubeletåœ¨è¯¥æ—¶é—´æ®µå¯¹è¯¥å®¹å™¨çš„æ¸…ç†æ—¥å¿—ï¼Œæ ¸å¿ƒç›¸å…³æ—¥å¿—å±•ç¤ºå¦‚ä¸‹ï¼š I0417 11:36:30.974674 37736 kubelet_pods.go:1180] Killing unwanted pod \"duse-api-sf-xxxxx-0\" I0417 11:36:30.976803 37736 plugins.go:391] Calling network plugin cni to tear down pod \"duse-api-sf-80819-0_default\" I0417 11:36:30.983499 37736 kubelet_pods.go:1780] Orphaned pod \"4ae28778-805c-11ea-a54c-b4055d1e6372\" found, removing pod cgroups I0417 11:36:30.986360 37736 pod_container_manager_linux.go:167] Attempt to kill process with pid: 48892 I0417 11:36:30.986382 37736 pod_container_manager_linux.go:174] successfully killed all unwanted processes. ç®€å•æè¿°æµç¨‹ï¼š I0417 11:36:30.974674 æ ¹æ®åˆ é™¤å®¹å™¨æ‰§è¡Œï¼Œæ‰§è¡Œæ€æ­»Podæ“ä½œ I0417 11:36:30.976803 è°ƒç”¨cniæ’ä»¶æ¸…ç†ç½‘ç»œå‘½åç©ºé—´ I0417 11:36:30.983499 å¸¸é©»åç¨‹æ£€æµ‹åˆ°Podå·²ç»ˆæ­¢è¿è¡Œï¼Œå¼€å§‹æ‰§è¡Œæ¸…ç†æ“ä½œï¼ŒåŒ…æ‹¬æ¸…ç†ç›®å½•ã€cgroup I0417 11:36:30.986360 æ¸…ç†cgroupæ—¶æ€æ­»å®¹å™¨ä¸­è¿˜æœªé€€å‡ºçš„è¿›ç¨‹ I0417 11:36:30.986382 æ˜¾ç¤ºæ‰€æœ‰å®¹å™¨è¿›ç¨‹éƒ½å·²è¢«æ€æ­» è¿™é‡Œæç¤ºä¸€ç‚¹ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¹å™¨é€€å‡ºæ—¶ï¼Œå®¹å™¨å†…æ‰€æœ‰è¿›ç¨‹éƒ½å·²é€€å‡ºã€‚è€Œä¸Šé¢ä¹‹æ‰€ä»¥å‡ºç°æ¸…ç†cgroupæ—¶éœ€è¦æ€æ­»å®¹å™¨å†…æœªé€€å‡ºè¿›ç¨‹ï¼Œæ˜¯ç”±äºå¸¸é©»åç¨‹çš„æ£€æµ‹æœºåˆ¶å¯¼è‡´çš„ï¼Œå¸¸é©»åç¨‹åˆ¤å®šPodå·²ç»ˆæ­¢è¿è¡Œçš„æ¡ä»¶æ˜¯ï¼š // podIsTerminated returns true if pod is in the terminated state (\"Failed\" or \"Succeeded\"). func (kl *Kubelet) podIsTerminated(pod *v1.Pod) bool { // Check the cached pod status which was set after the last sync. status, ok := kl.statusManager.GetPodStatus(pod.UID) if !ok { // If there is no cached status, use the status from the // apiserver. This is useful if kubelet has recently been // restarted. status = pod.Status } return status.Phase == v1.PodFailed || status.Phase == v1.PodSucceeded || (pod.DeletionTimestamp != nil \u0026\u0026 notRunning(status.ContainerStatuses)) } è¿™ä¸ªå®¹å™¨å‘½ä¸­äº†ç¬¬ä¸‰ä¸ªæˆ–æ¡ä»¶ï¼šå®¹å™¨å·²è¢«æ ‡è®°åˆ é™¤ï¼Œå¹¶ä¸”æ‰€æœ‰ä¸šåŠ¡å®¹å™¨éƒ½ä¸åœ¨è¿è¡Œä¸­ï¼ˆä¸šåŠ¡å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæ ¹æœ¬å°±æ²¡è¿è¡Œèµ·æ¥è¿‡ï¼‰ï¼Œä½†æ˜¯Podçš„sandboxå®¹å™¨å¯èƒ½ä»ç„¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚ ä»…ä¾æ®ä¸Šé¢çš„kubeletæ—¥å¿—ï¼Œéš¾ä»¥å‘ç°é—®é¢˜æ‰€åœ¨ã€‚æˆ‘ä»¬æ¥ç€åˆåˆ†æäº†cniæ’ä»¶çš„æ—¥å¿—ï¼Œæˆªå–cniåœ¨åˆ é™¤è¯¥Podå®¹å™¨ç½‘ç»œæ—¶çš„æ—¥å¿—å¦‚ä¸‹ï¼š [pid:98497] 2020/04/17 11:36:30.990707 main.go:89: ===== start cni process ===== [pid:98497] 2020/04/17 11:36:30.990761 main.go:90: os env: [CNI_COMMAND=DEL CNI_CONTAINERID=c2ef79f7596b6b558f0c01c0715bac46714eefd1e9966625a09414c7218e1013 CNI_NETNS=/proc/48892/ns/net CNI_ARGS=IgnoreUnknown=1;K8S_POD_NAMESPACE=default;K8S_POD_NAME=duse-api-sf-xxxxx-0;K8S_POD_INFRA_CONTAINER_ID=c2ef79f7596b6b558f0c01c0715bac46714eefd1e9966625a09414c7218e1013 CNI_IFNAME=eth0 CNI_PATH=/home/kaku/kakucloud/cni-plugins/bin LANG=en_US.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin KUBE_LOGTOSTDERR=--logtostderr=false KUBE_LOG_LEVEL=--v=3 KUBE_ALLOW_PRIV=--allow-privileged=true KUBE_MASTER=--master=https://10.xxx.xxx.xxx:xxxx KUBELET_ADDRESS=--address=0.0.0.0 KUBELET_HOSTNAME=--hostname_override=10.xxx.xxx.xxx KUBELET_POD_INFRA_CONTAINER= KUBELET_ARGS=--network-plugin=cni --cni-bin-dir=/home/kaku/kakucloud/cni-plugins/bin --cni-conf-dir=/home/kaku/kakucloud/cni-plugins/conf --kubeconfig=/etc/kubernetes/kubeconfig/kubelet.kubeconfig --cert-dir=/etc/kubernetes/ssl --log-dir=/var/log/kubernetes --stderrthreshold=3 --allowed-unsafe-sysctls=net.*,kernel.shm*,kernel.msg*,kernel.sem,fs.mqueue.* --pod-infra-container-image=registry.kaku.com/kakuk8s/pause:3.0 --eviction-hard= --image-gc-high-threshold=75 --image-gc-low-threshold=65 --feature-gates=KubeletPluginsWatcher=false --restart-count-limit=5 --last-upgrade-time=2019-07-01] [pid:98497] 2020/04/17 11:36:30.990771 main.go:91: stdin : {\"cniVersion\":\"0.3.0\",\"logDir\":\"/home/kaku/kakucloud/cni-plugins/acllogs\",\"name\":\"ddcloudcni\",\"type\":\"aclCni\"} [pid:98497] 2020/04/17 11:36:30.990790 main.go:181: failed to ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/netns-leak/:0:2","tags":["cni"],"title":"netnsæ³„éœ²","uri":"https://www.likakuli.com/posts/netns-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"3. æ‹¨äº‘ç°æœˆ è¿™ä¸ªç»“è®ºå¯¹æˆ‘ä»¬æ¥è¯´ï¼Œä¸æ˜¯ä¸€ä¸ªå¥½æ¶ˆæ¯ã€‚è´¹åŠ›ä¸å°ï¼Œä¸è¯´å—è¾•åŒ—è¾™ï¼Œä½†æ˜¯ç¡®å®è¿˜æœªå‘ç°é—®é¢˜çš„æ ¹å› ã€‚ ä¸ºäº†è¿›ä¸€æ­¥ç¼©å°é—®é¢˜æ’æŸ¥èŒƒå›´ï¼Œæˆ‘ä»¬æ‰¾å†…æ ¸ç»„åŒå­¦è¯·æ•™äº†ä¸€ä¸ªåŸºç¡€çŸ¥è¯†ï¼š åœ¨åˆ é™¤net nsæ—¶ï¼Œå¦‚æœè¯¥nså†…ä»æœ‰ç½‘ç»œè®¾å¤‡ï¼Œç³»ç»Ÿè‡ªåŠ¨å…ˆåˆ é™¤ç½‘ç»œè®¾å¤‡ï¼Œç„¶åå†åˆ é™¤ns æŒæ¡äº†è¿™ä¸ªåŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬å†æ¥æ’æŸ¥ã€‚æ—¢ç„¶åŸç”Ÿk8sé›†ç¾¤ä¸å­˜åœ¨net nsæ³„æ¼é—®é¢˜ï¼Œé‚£é—®é¢˜ä¸€å®šç”±æˆ‘ä»¬å®šåˆ¶çš„æŸä¸ªæ¨¡å—å¼•èµ·ã€‚ç”±äºnet nsæ³„æ¼å‘ç”Ÿåœ¨nodeä¸Šï¼Œå½“å‰å¼¹æ€§äº‘åœ¨nodeèŠ‚ç‚¹ä¸Šéƒ¨ç½²çš„æ¨¡å—åŒ…å«ï¼š kubelet cni plugins other tools ç”±äºkubeletå·²ç»è¢«æ’é™¤å«Œç–‘ï¼Œé‚£ä¹ˆç½ªé­ç¥¸é¦–åŸºæœ¬å°±æ˜¯cniæ’ä»¶äº†ã€‚å¯¹æ¯”åŸç”Ÿé›†ç¾¤ä¸å¼¹æ€§äº‘çº¿ä¸Šé›†ç¾¤çš„cniæ’ä»¶ï¼Œå‘ç°ä¸€ä¸ªææœ‰å¯èƒ½ä¼šé€ æˆnet nsæ³„æ¼çš„ç‚¹ï¼š å®šåˆ¶çš„cniæ’ä»¶ä¸ºäº†æ’æŸ¥é—®é¢˜çš„æ–¹ä¾¿ï¼Œå°†å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´æ–‡ä»¶ç»‘å®šæŒ‚è½½åˆ°äº†/var/run/netns ç›®å½•ä¸‹ ã€å‚è€ƒä¸Šé¢çš„å¤§å‘ã€‘ æˆ‘ä»¬èµ¶ç´§ç€æ‰‹éªŒè¯å…ƒå‡¶æ˜¯å¦å°±æ˜¯å®ƒã€‚ä¿®æ”¹cniæ’ä»¶ä»£ç ï¼Œåˆ é™¤ç»‘å®šæŒ‚è½½æ“ä½œï¼Œç„¶ååœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ã€‚éªŒè¯ç»“æœç¬¦åˆé¢„æœŸï¼Œnet nsä¸åœ¨æ³„æ¼ã€‚è‡³æ­¤ï¼ŒçœŸç›¸ç»ˆäºå¤§ç™½äºå¤©ä¸‹äº†ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/netns-leak/:0:3","tags":["cni"],"title":"netnsæ³„éœ²","uri":"https://www.likakuli.com/posts/netns-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"4. äº¡ç¾Šè¡¥ç‰¢ å½“åˆä¸ºnet nsåšä¸€ä¸ªç»‘å®šæŒ‚è½½ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥é—®é¢˜ï¼Œä½¿å¾— ip netns å‘½ä»¤èƒ½å¤Ÿè®¿é—®å½“å‰å®¿ä¸»ä¸Šæ‰€æœ‰Podçš„ç½‘ç»œå‘½åç©ºé—´ã€‚ ä½†å…¶å®ä¸€ä¸ªç®€å•çš„è½¯é“¾æ“ä½œå°±èƒ½å¤Ÿå®ç°è¿™ä¸ªç›®æ ‡ã€‚Podé€€å‡ºæ—¶ï¼Œå¦‚æœè¿™ä¸ªè½¯é“¾æ–‡ä»¶æœªè¢«æ¸…ç†ï¼Œä¹Ÿä¸ä¼šå¼•èµ·net nsçš„æ³„æ¼ï¼ŒåŒæ—¶ ls -la /var/run/netns å‘½ä»¤å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°å“ªäº›net nsä»æœ‰æ•ˆï¼Œå“ªäº›å·²æ— æ•ˆã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/netns-leak/:0:4","tags":["cni"],"title":"netnsæ³„éœ²","uri":"https://www.likakuli.com/posts/netns-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"5. äº‹åè¯¸è‘› ä¸ºä»€ä¹ˆç»‘å®šæŒ‚è½½èƒ½å¤Ÿå¯¼è‡´net nsæ³„æ¼å‘¢ï¼Ÿè¿™æ˜¯ç”±linux ç½‘ç»œå‘½åç©ºé—´ç‰¹æ€§å†³å®šçš„ï¼š åªè¦è¯¥å‘½åç©ºé—´ä¸­ä»æœ‰ä¸€ä¸ªè¿›ç¨‹å­˜æ´»ï¼Œæˆ–è€…å­˜åœ¨ç»‘å®šæŒ‚è½½çš„æƒ…å†µï¼ˆå¯èƒ½è¿˜å­˜åœ¨å…¶ä»–æƒ…å†µï¼‰ï¼Œè¯¥nså°±ä¸ä¼šè¢«å›æ”¶ è€Œä¸€æ—¦æ‰€æœ‰è¿›ç¨‹éƒ½å·²é€€å‡ºï¼Œå¹¶ä¸”ä¹Ÿæ— ç‰¹æ®ŠçŠ¶å†µï¼Œlinuxå°†è‡ªåŠ¨å›æ”¶è¯¥ns æœ€åï¼Œè¿™ä¸ªé—®é¢˜æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œä¹‹æ‰€ä»¥é—®é¢˜å­˜åœ¨å¦‚æ­¤ä¹‹ä¹…ï¼Œæ’æŸ¥å¦‚æ­¤æ›²æŠ˜ï¼Œä¸»è¦æš´éœ²äº†æˆ‘ä»¬çš„åŸºç¡€çŸ¥è¯†æœ‰æ‰€æ¬ ç¼ºã€‚ å¥½å¥½å­¦ä¹ ï¼Œå¤©å¤©å‘ä¸Šï¼Œæ–¹æ˜¯ç‹é“ï¼ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/netns-leak/:0:5","tags":["cni"],"title":"netnsæ³„éœ²","uri":"https://www.likakuli.com/posts/netns-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æè¿° åœ¨ä¿®å¤cgroupæ³„æ¼é—®é¢˜æ—¶ä¼šç°åœæ‰kubeletï¼Œå¾…ä¿®å¤å®Œæˆåå¯åŠ¨kubeletç»„ä»¶ï¼Œé‡å¯åæ”¶åˆ°ä¸šåŠ¡åé¦ˆï¼Œä¸šåŠ¡å®¹å™¨é‡å¯äº†ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/:0:1","tags":["kubernetes"],"title":"Kubeleté‡å¯å¯¼è‡´å®¹å™¨é‡å¯","uri":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æ’æŸ¥ è¿™ä¸ªé—®é¢˜å…·ä½“åŸå› çš„æ’æŸ¥è¿˜æ˜¯èŠ±äº†ä¸€å®šæ—¶é—´çš„ï¼Œä¸‹é¢ä¼šåˆ—ä¸€ä¸‹å¤§è‡´çš„æ’æŸ¥æ€è·¯å¹¶ç»“åˆæºç ï¼ˆè‡ªå®šä¹‰çš„1.12.4åˆ†æ”¯ï¼‰è¿›è¡Œåˆ†æã€‚ æ’æŸ¥è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°äº†3ä¸ªå®¹å™¨ï¼Œå¦‚ä¸‹ åç§° é›†ç¾¤ å®¿ä¸» ç»“æœ é‡å¯æ¬¡æ•° 1 auto-srv-cwhttp-sf-30b71-0 py 10.86.98.42 é‡å¯ 1 2 conf-master-sf-19cf6-0 us01 10.15.29.31 é‡å¯ 1 3 opensource-sf-dc750-2 us01 10.15.29.31 æœªé‡å¯ 1 å®¹å™¨å¯åœç›¸å…³çš„ç»„ä»¶é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯kubeletï¼Œå› æ­¤å»æŸ¥çœ‹kubeletæ—¥å¿—ï¼Œæ‹¿pyçš„ä¸¾ä¾‹ï¼Œé‡å¯æ—¶é—´ä¸º2020-03-12 10:42:27ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹è¿™ä¹‹å‰çš„ä¸€äº›æ—¥å¿— è¿™é‡Œç›´æ¥è´´å‡ºæ¥æœ€åè¿‡æ»¤åçš„æ—¥å¿—ï¼Œçœç•¥ä¸€äº›ä¸­é—´è¿‡ç¨‹ root@ddcloud-underlay-kube-node065.py:~$ grep 0312 /var/log/kubernetes/kubelet.INFO | grep -E \"10:42:26|10:42:27\" | grep -E \"8a61fda8d43e4c28d4092a1bc8e5f372846d955ffffe0353a754c2e42f271b56|auto-srv-cwhttp-sf-30b71-0|bfde4b15-cb98-11e8-a3c8-6c92bf85beda\" | grep -v -i volume I0312 10:42:26.101676 2353235 kubelet.go:1887] SyncLoop (ADD, \"api\"): \"lifejuhe-pre-sf-d46e3-0_default(9c048a53-53b2-11ea-b6ae-6c92bf85be08), prime-manager-sf-71a2e-2_default(35bc54e5-4ef1-11ea-b6ae-6c92bf85be08), ai-business-sf-0cac5-19_default(b60c0a18-4d70-11ea-b6ae-6c92bf85be08), disconf-sf-92894-2_default(4ae4dfb8-fee4-11e9-b433-6c92bf85be08), am-base-api-new-sf-de855-4_default(e59f4da9-cd68-11e9-92ca-6c92bf85be08), auto-srv-menu-sf-96f75-1_default(eb6ef2a6-4c7c-11ea-b6ae-6c92bf85be08), pre-000_default(d8f7688a-cc39-11e8-a3c8-6c92bf85beda), auto-wechat-srv-sf-e680a-0_default(9a6e0fc8-051c-11ea-b433-6c92bf85be08), oracle-pre-sf-253a7-0_default(c0cef405-5fa8-11ea-b6ae-6c92bf85be08), auto-srv-cwhttp-sf-30b71-0_default(bfde4b15-cb98-11e8-a3c8-6c92bf85beda), auto-srv-chewu-sf-dc750-0_default(1d9eac73-620a-11ea-b6ae-6c92bf85be08), member-sf-747bb-64_default(4e761a14-634e-11ea-b6ae-6c92bf85be08), ep-arch-tmp-bh-sf-1eaad-4_default(7a2d3f79-001a-11e9-a95b-6c92bf85beda), nsky-htw-h5-extranet-sf-900e8-1_default(10ac4571-08c5-11e9-a95b-6c92bf85beda), fate-saver-pre-sf-5cee9-0_default(39915cd3-f70f-11e9-b433-6c92bf85be08), shortserver-sf-ab776-4_default(d1909587-6362-11ea-b6ae-6c92bf85be08), rainbow-h5-sf-c72e4-3_default(cba38b41-1cbe-11ea-b433-6c92bf85be08), agency-call-service-sf-674c2-29_default(e74635f4-5b46-11ea-b6ae-6c92bf85be08), hnc-ddrccp-sf-db379-1_default(f16fbe5f-9ba4-11e9-a777-6c92bf85be08), log-hnc-sf-6a5be-152_default(a87148b5-c002-11e9-92ca-6c92bf85be08), actinia-service-py-sf-61fb7-0_default(75ef3250-3998-11e9-a95b-6c92bf85beda), its-timing-test-sf-8dcfc-0_default(3ad3b185-d175-11e8-a3c8-6c92bf85beda), de-st-forecastor-sf-5a382-3_default(5c6c02b8-ea6c-11e9-8a9f-6c92bf85be08), transit-compass-sf-69886-3_default(5f28569f-7152-11e9-9a4a-6c92bf85be08), gundam-centos6-002_default(3d075c28-042a-11e9-b650-6c92bf85be08), loan-credit-server-sf-c411b-4_default(6455d8e9-61fe-11ea-b6ae-6c92bf85be08), marketingmodel-service-sf-b1260-16_default(9d570b88-5f31-11e9-9b14-6c92bf85beda), csi-hnc-sf-a8523-16_default(b6078000-5f60-11ea-b6ae-6c92bf85be08), ms-shutdown-datadriver-sf-30b86-4_default(805e9837-f0d7-11e9-a648-6c92bf85be08), abnormal-shutdown-service-sf-342c4-18_default(ccb413e6-d832-11e9-92ca-6c92bf85be08), fate-lancer-sf-49896-2_default(241ad7ce-5c53-11ea-b6ae-6c92bf85be08), jetfire-sf-7dbf2-2_default(13f50c1d-5de8-11ea-b6ae-6c92bf85be08), hnc-pre-v-sf-745f9-0_default(70a98be0-3fbe-11e9-a95b-6c92bf85beda), orderpre-sf-b433d-0_default(03f84b30-1760-11ea-b433-6c92bf85be08), gatewayserver-sf-fc2e7-9_default(310030c4-62b3-11ea-b6ae-6c92bf85be08), base-message-service-sf-1b6f0-2_default(f63261ce-d0aa-11e9-92ca-6c92bf85be08), athena-api-pre-sf-d61bf-0_default(9f7e4183-0089-11ea-b433-6c92bf85be08), soda-f-api-sf-c88f2-2_default(fc9520db-8211-11e9-913a-6c92bf85beda), soda-d-api-py-sf-c6659-5_default(af4a67f9-3216-11ea-b433-6c92bf85be08), rollsroyce-pre-sf-6ed43-0_default(78a053cf-6375-11ea-b6ae-6c92bf85be08), member-sf-747bb-74_default(7323a872-634e-11ea-b6ae-6c92bf85be08), settle-consumer-abtest-hnc-pre-v-sf-b18cf-0_default(d199f994-6363-11ea-b6ae-6c92bf85be08), dpub-vote-pre-sf-bc747-0_default(7388d4f7-1a82-11ea-b433-6c92bf85be08), delta-hub-web-sf-bc67e-2_default(35699c85-620c-11ea-b6ae-6c92bf85be08), drunkeness-model-service-sf-a38a4-43_default(c3cd5daa-5b47-11ea-b6ae-6c92bf85be08), lifeapi-hnc-sf-4a88c-2_default(46","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/:0:2","tags":["kubernetes"],"title":"Kubeleté‡å¯å¯¼è‡´å®¹å™¨é‡å¯","uri":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ç»“è®º èµ‹å€¼å’Œè·å–å€¼çš„æ“ä½œåœ¨ä¸¤ä¸ªgoroutineï¼Œä¸”ä¸¥é‡ä¾èµ–äºç¬¬ä¸€æ¬¡çš„èµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥åº”è¯¥åœ¨ä¿è¯ç¬¬ä¸€æ¬¡èµ‹å€¼åå†è¿›è¡Œå–å€¼æ“ä½œæ‰èƒ½ç¡®ä¿å®¹å™¨ä¸é‡å¯ï¼Œè™½ç„¶åˆ†æ”¯3åˆ¤æ–­æœ‰æ²¡æœ‰é»˜è®¤æ¢é’ˆä¸­åœ¨è®¾ç½®å’Œè·å–çš„æ—¶å€™éƒ½åŠ äº†é”ï¼Œä½†è¿˜æ˜¯æ— æ³•ä¿è¯ä»£ç æ‰§è¡Œé¡ºåºï¼Œæ‰€ä»¥å³ä½¿èµ°åˆ†æ”¯3ï¼Œä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºç°è®¾ç½®readyä¸ºtrueçš„æƒ…å†µï¼ˆæœ¬è¯¥è®¾ç½®ä¸ºfalseï¼‰ï¼Œä½†æ˜¯å› ä¸ºè¿™æ­£æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯ä¸ä¼šè§‰å¯Ÿåˆ°è¿™ç§æƒ…å†µçš„é—®é¢˜çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€æºçš„ä»£ç ä¸­å¯èƒ½ä¹Ÿæ˜¯å­˜åœ¨ç±»ä¼¼è¯¯åˆ¤çš„é£é™©çš„ï¼Œè‡³å°‘1.12.4ç‰ˆæœ¬ä¸­æ˜¯å­˜åœ¨çš„ã€‚ ","date":"2020-10-26","objectID":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/:0:3","tags":["kubernetes"],"title":"Kubeleté‡å¯å¯¼è‡´å®¹å™¨é‡å¯","uri":"https://www.likakuli.com/posts/kubernetes-kubelet-restart/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"knativeå¥åº·æ£€æŸ¥","date":"2020-08-20","objectID":"https://www.likakuli.com/posts/knative-healthcheck/","tags":["knative"],"title":"Knativeå¥åº·æ£€æŸ¥","uri":"https://www.likakuli.com/posts/knative-healthcheck/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ knative 0.14.0 å®é™…ä¿®æ”¹å¯èƒ½ä¸è´´å‡ºæ¥çš„ä»£ç ä¸ç¬¦ï¼Œè´´å‡ºæ¥çš„ä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°åŠŸèƒ½ åœ¨æ”¯æŒäº†å‰é¢çš„å®šåˆ¶åŠŸèƒ½åï¼Œé›†ç¾¤ä¸­éƒ¨ç½²ksvcæœåŠ¡æ—¶ä¼šæŠ¥IngressNotConfiguredé”™è¯¯ ","date":"2020-08-20","objectID":"https://www.likakuli.com/posts/knative-healthcheck/:0:1","tags":["knative"],"title":"Knativeå¥åº·æ£€æŸ¥","uri":"https://www.likakuli.com/posts/knative-healthcheck/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"åŸå› åˆ†æ é¦–å…ˆæ ¹æ®é”™è¯¯æç¤ºåŠæ—¥å¿—ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°æ˜¯åœ¨åšå¥åº·æ£€æŸ¥çš„æ—¶å€™å‡ºçš„é—®é¢˜ï¼ŒæœŸæœ›å¾—åˆ°200ï¼Œä½†æ˜¯å¾—åˆ°äº†404 func (m *Prober) probeVerifier(item *workItem) prober.Verifier { return func(r *http.Response, _ []byte) (bool, error) { // In the happy path, the probe request is forwarded to Activator or Queue-Proxy and the response (HTTP 200) // contains the \"K-Network-Hash\" header that can be compared with the expected hash. If the hashes match, // probing is successful, if they don't match, a new probe will be sent later. // An HTTP 404/503 is expected in the case of the creation of a new Knative service because the rules will // not be present in the Envoy config until the new VirtualService is applied. // No information can be extracted from any other scenario (e.g. HTTP 302), therefore in that case, // probing is assumed to be successful because it is better to say that an Ingress is Ready before it // actually is Ready than never marking it as Ready. It is best effort. switch r.StatusCode { case http.StatusOK: hash := r.Header.Get(network.HashHeaderName) switch hash { case \"\": m.logger.Errorf(\"Probing of %s abandoned, IP: %s:%s: the response doesn't contain the %q header\", item.url, item.podIP, item.podPort, network.HashHeaderName) return true, nil case item.ingressState.hash: return true, nil default: m.logger.Warnf(\"unexpected hash: want %q, got %q\", item.ingressState.hash, hash) return true, nil } // æ—¥å¿—ä¸­æŠ¥é”™çš„åœ°æ–¹ï¼Œæ¢æ´»å¸Œæœ›å¾—åˆ°200ï¼Œä½†æ˜¯å¾—åˆ°äº†404 case http.StatusNotFound, http.StatusServiceUnavailable: return false, fmt.Errorf(\"unexpected status code: want %v, got %v\", http.StatusOK, http.StatusNotFound) default: m.logger.Errorf(\"Probing of %s abandoned, IP: %s:%s: the response status is %v, expected 200 or 404\", item.url, item.podIP, item.podPort, r.StatusCode) return true, nil } } } å…¶å®è¿™æ—¶å€™å¤§è‡´ä¹Ÿèƒ½çŒœåˆ°æ˜¯ä»€ä¹ˆåŸå› äº†ï¼Œå› ä¸ºæˆ‘ä»¬å®šåˆ¶äº†é€šè¿‡USNè¿›è¡Œè¿‡æ»¤ï¼Œæ¢æ´»çš„æ—¶å€™ï¼ŒUrlä¸­å…¶å®æ˜¯æ²¡æœ‰USNçš„ã€‚ä¸‹ä¸€æ­¥å°±æ˜¯é¡ºè—¤æ‘¸ç“œï¼Œæ‰¾åˆ°æ¢æ´»å¯¹åº”çš„ä»£ç éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œä¹Ÿæ¯”è¾ƒç®€å• // processWorkItem processes a single work item from workQueue. // It returns false when there is no more items to process, true otherwise. func (m *Prober) processWorkItem() bool { ... // probePath /healthz probeURL.Path = path.Join(probeURL.Path, probePath) ok, err := prober.Do( item.context, transport, probeURL.String(), prober.WithHeader(network.UserAgentKey, network.IngressReadinessUserAgent), prober.WithHeader(network.ProbeHeaderName, network.ProbeHeaderValue), m.probeVerifier(item)) ... } å¯ä»¥çœ‹åˆ°æ¢æ´»çš„æ—¶å€™å°±æ˜¯æ‹¿Pathæ‹¼ä¸Š/heathzï¼ŒéªŒè¯äº†æˆ‘ä»¬çš„çŒœæƒ³ ","date":"2020-08-20","objectID":"https://www.likakuli.com/posts/knative-healthcheck/:0:2","tags":["knative"],"title":"Knativeå¥åº·æ£€æŸ¥","uri":"https://www.likakuli.com/posts/knative-healthcheck/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ä¿®å¤ ä¿®æ”¹ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œåœ¨æ·»åŠ wotkitemæ—¶ï¼Œé¢„å…ˆæŠŠUSNæ·»åŠ åˆ°pathä¸­å³å¯ func (l *gatewayPodTargetLister) ListProbeTargets(ctx context.Context, ing *v1alpha1.Ingress) ([]status.ProbeTarget, error) { ... // Use sorted hosts list for consistent ordering. for i, host := range gatewayHosts[gatewayName].List() { newURL := *target.URLs[0] newURL.Host = host + \":\" + target.Port var usn string if ing.Annotations != nil { usn = ing.Annotations[\"serverless.kakuchuxing.com/usn\"] } newURL.Path = path.Join(newURL.Path, usn) qualifiedTarget.URLs[i] = \u0026newURL ... } ","date":"2020-08-20","objectID":"https://www.likakuli.com/posts/knative-healthcheck/:0:3","tags":["knative"],"title":"Knativeå¥åº·æ£€æŸ¥","uri":"https://www.likakuli.com/posts/knative-healthcheck/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ é€šè¿‡è¿™ä¸ªé—®é¢˜ä¹Ÿçœ‹åˆ°äº†å¯¹äºä¸€äº›ç»†èŠ‚å’Œå…³é”®æµç¨‹æŒæ¡çš„è¿˜ä¸å¤Ÿï¼Œè¿˜æ˜¯éœ€è¦è¿›è¡Œç³»ç»Ÿæ€§çš„å­¦ä¹ ã€‚è‡³äºå¥åº·æ£€æŸ¥çš„é€»è¾‘ï¼Œå’Œk8sçš„å¥åº·æ£€æŸ¥ç¨æœ‰ä¸åŒï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç«  ","date":"2020-08-20","objectID":"https://www.likakuli.com/posts/knative-healthcheck/:0:4","tags":["knative"],"title":"Knativeå¥åº·æ£€æŸ¥","uri":"https://www.likakuli.com/posts/knative-healthcheck/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"é€šè¿‡headerè®¿é—®æŒ‡å®šç‰ˆæœ¬","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-version/","tags":["knative"],"title":"Knativeé€šè¿‡headerè®¿é—®æŒ‡å®šç‰ˆæœ¬","uri":"https://www.likakuli.com/posts/knative-version/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"èƒŒæ™¯ knative 0.14.0 å®é™…ä¿®æ”¹å¯èƒ½ä¸è´´å‡ºæ¥çš„ä»£ç ä¸ç¬¦ï¼Œè´´å‡ºæ¥çš„ä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°åŠŸèƒ½ æœ€è¿‘åœ¨æ­å»ºå…¬å¸çº§çš„serverlesså¹³å°ï¼Œéœ€è¦ç”¨åˆ°åŸŸåæ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼Œé‡‡å–çš„æ˜¯é€šè¿‡PATHæ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡ï¼ŒåŸŸåé‡‡ç”¨åŒä¸€ä¸ªã€‚ä¸Šä¸€ç¯‡å·²ç»è§£å†³äº†é€šè¿‡Pathè®¿é—®ä¸åŒæœåŠ¡çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ç°åº¦è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæƒ³æµ‹è¯•ä¸‹æ–°ç‰ˆæœ¬æ—¶å€™æ­£å¸¸ï¼Œå¦‚ä½•å°†æµé‡æ‰“åˆ°æŒ‡å®šç‰ˆæœ¬ä¸Šå‘¢ï¼ŸåŸç”Ÿçš„knativeæ˜¯é€šè¿‡urlçš„ä¸åŒå®ç°çš„ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªæ ¹æ®ç‰ˆæœ¬ç”Ÿæˆurlçš„æ¨¡æ¿ï¼Œè®¾ç½®åä¸åŒç‰ˆæœ¬çš„æœåŠ¡urlä¸åŒã€‚ä½†æ˜¯æˆ‘ä»¬çš„åœºæ™¯æ˜¯æ‰€æœ‰æœåŠ¡urlç›¸åŒï¼Œäºæ˜¯æˆ‘ä»¬çº¦å®šé€šè¿‡åœ¨è®¾ç½®ç‰¹æ®Šçš„headerçš„æ¥å®ç°æ­¤åŠŸèƒ½ ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-version/:0:1","tags":["knative"],"title":"Knativeé€šè¿‡headerè®¿é—®æŒ‡å®šç‰ˆæœ¬","uri":"https://www.likakuli.com/posts/knative-version/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ–¹æ¡ˆ åŸç”Ÿé€šè¿‡urlæ¥åŒºåˆ†ä¸åŒç‰ˆæœ¬ï¼Œå®ç°æ–¹å¼æ˜¯é€šè¿‡åœ¨ç”Ÿæˆvsæ—¶ï¼Œè®¾ç½®å…¶Matchçš„æ¡ä»¶Authrotyä¸ºå¯¹åº”çš„url prefixå³å¯ã€‚æ˜¾ç„¶æ— æ³•æ»¡è¶³æˆ‘ä»¬å½“å‰ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªurlçš„åœºæ™¯ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶å®ç°æ–¹å¼ï¼Œæ¢ä¸€ä¸ªç»´åº¦ï¼Œé headerå®ç°å³å¯ï¼Œä½†æ˜¯åˆä¸èƒ½å½±å“æ­£å¸¸è®¿é—®ï¼Œå³ä¸æ·»åŠ headerçš„æ—¶å€™ï¼Œæµé‡æŒ‰ç…§è®¾ç½®çš„æ¯”ä¾‹æ‰“åˆ°ä¸åŒçš„revisionä¸Šï¼Œæ·»åŠ äº†headeråï¼Œéœ€è¦å°†æµé‡æ‰“åˆ°æŒ‡å®šç‰ˆæœ¬ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•çš„åœ¨Matchä¸­æ·»åŠ Headerï¼Œéœ€è¦åˆ†åˆ«è®¾ç½®æ­£å¸¸è®¿é—®çš„æƒ…å†µå’Œè®¿é—®æŒ‡å®šç‰ˆæœ¬çš„æƒ…å†µï¼Œä¸”è®¿é—®æŒ‡å®šç‰ˆæœ¬çš„é…ç½®åº”è¯¥é¡ºåºé å‰ã€‚ // MakeIngressSpec creates a new IngressSpec func MakeIngressSpec( ctx context.Context, r *servingv1.Route, tls []v1alpha1.IngressTLS, targets map[string]traffic.RevisionTargets, visibility map[string]netv1alpha1.IngressVisibility, acmeChallenges ...v1alpha1.HTTP01Challenge, ) (v1alpha1.IngressSpec, error) { ... // add custom external domains customHostStr := r.Annotations[\"serverless.kakuchuxing.com/domains\"] // å€’åºï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆï¼Œå› ä¸ºè®¿é—®æŒ‡å®šç‰ˆæœ¬æ—¶nameä¸ä¸ºç©ºï¼Œä¸åŒºåˆ†ç‰ˆæœ¬æ—¶nameé»˜è®¤ä¸ºç©º sort.Sort(sort.Reverse(sort.StringSlice(names))) if len(customHostStr) \u003e 0 { customHosts := strings.Split(customHostStr, \";\") for _, name := range names { if name != \"default\" { visibility := netv1alpha1.IngressVisibilityExternalIP rule := *makeIngressRule(customHosts, r.Namespace, visibility, name, targets[name]) // If this is a public rule, we need to configure ACME challenge paths. rule.HTTP.Paths = append( makeACMEIngressPaths(challengeHosts, customHosts), rule.HTTP.Paths...) rules = append(rules, rule) } } } ... } func makeIngressRule(domains []string, ns string, visibility netv1alpha1.IngressVisibility, name string, targets traffic.RevisionTargets) *v1alpha1.IngressRule { ... return \u0026v1alpha1.IngressRule{ Hosts: domains, Visibility: visibility, HTTP: \u0026v1alpha1.HTTPIngressRuleValue{ Paths: []v1alpha1.HTTPIngressPath{ { Splits: splits, // TODO(lichuqiang): #2201, plumbing to config timeout and retries. // æŠŠtag nameä¿å­˜ä¸‹æ¥ï¼Œä¼ é€’ç»™vsï¼Œç”¨æ¥åŒºåˆ†æ˜¯å¦éœ€è¦è®¾ç½®header AppendHeaders: map[string]string{ \"RevisionName\": name, }, }, }, }, } } func makeVirtualServiceRoute(hosts sets.String, usn string, http *v1alpha1.HTTPIngressPath, gateways map[v1alpha1.IngressVisibility]sets.String, visibility v1alpha1.IngressVisibility) *istiov1alpha3.HTTPRoute { ... // add revision tag header to custom domain // è·å–ä¼ é€’è¿‡æ¥çš„tagï¼Œè®¾ç½®match header if tag := http.AppendHeaders[\"RevisionName\"]; tag != \"\" { for i := 0; i \u003c len(matches); i++ { if matches[i].Headers == nil { matches[i].Headers = make(map[string]*istiov1alpha3.StringMatch) } matches[i].Headers[\"RevisionName\"] = \u0026istiov1alpha3.StringMatch{ MatchType: \u0026istiov1alpha3.StringMatch_Exact{ Exact: http.Splits[0].ServiceName, }, } } } ... } ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-version/:0:2","tags":["knative"],"title":"Knativeé€šè¿‡headerè®¿é—®æŒ‡å®šç‰ˆæœ¬","uri":"https://www.likakuli.com/posts/knative-version/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ€»ç»“ è‡³æ­¤ï¼Œå·²ç»å®ç°äº†é€šè¿‡ç»Ÿä¸€åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡ï¼Œä¸”æ ¹æ®Pathè½¬å‘è¯·æ±‚ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡åœ¨è®¿é—®æ—¶æ·»åŠ æŒ‡å®šçš„headeræ¥æŠŠæµé‡æ‰“åˆ°æŒ‡å®šç‰ˆæœ¬ä¸Šï¼Œè¿™åœ¨ç°åº¦æˆ–è€…æµ‹è¯•æ—¶æ˜¯ä¸€ä¸ªéå¸¸å®ç”¨çš„åŠŸèƒ½ã€‚ ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-version/:0:3","tags":["knative"],"title":"Knativeé€šè¿‡headerè®¿é—®æŒ‡å®šç‰ˆæœ¬","uri":"https://www.likakuli.com/posts/knative-version/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"Knativeæ ¹æ®Pathè½¬å‘è¯·æ±‚","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-pathfilter/","tags":["knative"],"title":"Knativeæ ¹æ®Pathè½¬å‘è¯·æ±‚","uri":"https://www.likakuli.com/posts/knative-pathfilter/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"èƒŒæ™¯ knative 0.14.0 å®é™…ä¿®æ”¹å¯èƒ½ä¸è´´å‡ºæ¥çš„ä»£ç ä¸ç¬¦ï¼Œè´´å‡ºæ¥çš„ä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°åŠŸèƒ½ æœ€è¿‘åœ¨æ­å»ºå…¬å¸çº§çš„serverlesså¹³å°ï¼Œéœ€è¦ç”¨åˆ°åŸŸåæ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼Œé‡‡å–çš„æ˜¯é€šè¿‡PATHæ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡ï¼ŒåŸŸåé‡‡ç”¨åŒä¸€ä¸ªã€‚è¿™ä¸åŸç”Ÿknativeçš„è®¾è®¡å­˜åœ¨å·®å¼‚ï¼ŒåŸç”Ÿçš„åšæ³•æ˜¯æ¯ä¸ªæœåŠ¡ä¸€ä¸ªè‡ªå·±çš„åŸŸåï¼Œé€šè¿‡åŸŸåæŠŠæµé‡æ‰“åˆ°ä¸åŒçš„æœåŠ¡ä¸Šï¼Œæˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€ç¯‡ä¸­è§£å†³äº†è‡ªå®šä¹‰åŸŸåæ— æ³•è®¿é—®knativeé›†ç¾¤çš„é—®é¢˜ï¼Œè¿™ä¸€ç¯‡æ¥è§£å†³å¦‚ä½•é€šè¿‡ä¸åŒçš„Pathè®¿é—®åˆ°ä¸åŒçš„æœåŠ¡ ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-pathfilter/:0:1","tags":["knative"],"title":"Knativeæ ¹æ®Pathè½¬å‘è¯·æ±‚","uri":"https://www.likakuli.com/posts/knative-pathfilter/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ–¹æ¡ˆ ä¸¤ä¸ªé—®é¢˜éœ€è¦æˆ‘ä»¬æ¥è§£å†³ï¼š ä¸åŒæœåŠ¡çš„Pathå¯èƒ½ç›¸åŒï¼Œå¦‚ä½•åŒºåˆ† åŸç”Ÿé€šè¿‡ksvcçš„æ–¹å¼ä¸æ”¯æŒè®¾ç½®Pathï¼ˆé€šè¿‡è‡ªå·±åˆ›å»ºå„ç§ç±»å‹çš„èµ„æºå¯ä»¥å®ç°ï¼Œä½†æ˜¯æ§åˆ¶æ¯”è¾ƒå¤æ‚ï¼Œè€Œä¸”ä¸Šå±‚éœ€è¦ä¿®æ”¹é€‚é…ï¼‰ è§£å†³æ–¹æ¡ˆï¼š æ¯ä¸ªæœåŠ¡ä¸€ä¸ªUSNï¼Œä½¿ç”¨USNä½œä¸ºå”¯ä¸€æ ‡è¯† ä¿®æ”¹knativeï¼Œæ”¯æŒé€šè¿‡Pathè®¿é—® è½¬å‘åéœ€è¦rewrite urlï¼ŒæŠŠUSNå»æ‰ï¼Œå› ä¸ºä¸šåŠ¡ä»£ç ä¸­çš„è·¯ç”±é‡Œä¸å¯èƒ½åŒ…å«USN å…¶ä¸­ç¬¬ä¸€ç‚¹ä¸éœ€è¦ä»£ç æ”¹åŠ¨ï¼Œæˆ‘ä»¬ä¸»è¦æ¥å®ç°ç¬¬äºŒã€ä¸‰ç‚¹ã€‚ vsæœ¬èº«æ˜¯æ”¯æŒæ ¹æ®Pathè½¬å‘çš„åŠŸèƒ½çš„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨ksvcä¸­æš´éœ²å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨kingåˆ›å»ºvsçš„æ—¶å€™åŠ¨æ€æ³¨å…¥è¿›å»ï¼ŒåŒæ—¶åœ¨destinationä¸­æ·»åŠ url rewriteçš„é€»è¾‘ã€‚ func makeVirtualServiceSpec(ing *v1alpha1.Ingress, gateways map[v1alpha1.IngressVisibility]sets.String, hosts sets.String) *istiov1alpha3.VirtualService { spec := istiov1alpha3.VirtualService{ Hosts: hosts.List(), } // è‡ªå®šä¹‰åŠŸèƒ½ usn := ing.Annotations[\"serverless.kakuchuxing.com/usn\"] if usn != \"\" { usn = \"/\" + strings.Trim(usn, \"/\") + \"/\" } gw := sets.String{} for _, rule := range ing.Spec.Rules { for _, p := range rule.HTTP.Paths { hosts := hosts.Intersection(sets.NewString(rule.Hosts...)) if hosts.Len() != 0 { http := makeVirtualServiceRoute(hosts, usn, \u0026p, gateways, rule.Visibility) // Add all the Gateways that exist inside the http.match section of // the VirtualService. // This ensures that we are only using the Gateways that actually appear // in VirtualService routes. for _, m := range http.Match { gw = gw.Union(sets.NewString(m.Gateways...)) } // rewrite pathï¼Œé‡å®šå‘ï¼Œæ¶ˆé™¤USN if usn != \"\" { if http.Rewrite == nil { http.Rewrite = \u0026istiov1alpha3.HTTPRewrite{} } http.Rewrite.Uri = \"/\" } spec.Http = append(spec.Http, http) } } } spec.Gateways = gw.List() return \u0026spec } func makeVirtualServiceRoute(hosts sets.String, usn string, http *v1alpha1.HTTPIngressPath, gateways map[v1alpha1.IngressVisibility]sets.String, visibility v1alpha1.IngressVisibility) *istiov1alpha3.HTTPRoute { ... for _, host := range hosts.List() { g := gateways[visibility] if strings.HasSuffix(host, clusterDomainName) \u0026\u0026 len(gateways[v1alpha1.IngressVisibilityClusterLocal]) \u003e 0 { // For local hostname, always use private gateway g = gateways[v1alpha1.IngressVisibilityClusterLocal] } matches = append(matches, makeMatch(host, usn, http.Path, g)...) } ... } func makeMatch(host string, usn string, pathRegExp string, gateways sets.String) []*istiov1alpha3.HTTPMatchRequest { ... // add custom usn filterï¼Œæ·»åŠ USNçš„è¿‡æ»¤æ¡ä»¶ if usn != \"\" { if i == 0 { matches[i].Uri = \u0026istiov1alpha3.StringMatch{ MatchType: \u0026istiov1alpha3.StringMatch_Prefix{Prefix: usn}, } } else { matches[i].Uri = \u0026istiov1alpha3.StringMatch{ MatchType: \u0026istiov1alpha3.StringMatch_Exact{Exact: strings.TrimRight(usn, \"/\")}, } } } ... } ä¿®æ”¹æ¯”è¾ƒç®€å•ï¼Œå®Œå…¨å°±æ˜¯æŒ‰ç…§ä¹‹å‰è¯´çš„ä¸¤ç‚¹è¿›è¡Œçš„ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæ¯”è¾ƒtrickyçš„åœ°æ–¹å°±æ˜¯å®ç°url rewriteçš„æ–¹å¼ï¼Œå› ä¸ºç¤¾åŒºä¸­çš„vsï¼ˆistioé‡Œçš„crdï¼‰å…¶å®æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œæˆ‘ä»¬ä¸ºäº†è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œç‰¹æ„åšäº†ä¸€äº›ç‰¹æ®Šè®¾ç½®ã€‚å‚è€ƒè¿™é‡Œï¼Œå¤§è‡´æ„æ€å°±æ˜¯ç›®å‰vsä¸æ”¯æŒurl rewriteä¸ºç©ºï¼Œrewriteä¸ºç©ºä¹‹åï¼Œå®é™…è®¿é—®çš„æ—¶å€™éœ€è¦åœ¨urlçš„æœ€ååŠ ä¸Š/ï¼Œå¦åˆ™ä¼šè¿”å›400ï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆå¤šå‰ç«¯ç½‘ç«™ä¸»é¡µå°±æ˜¯ä¸€ä¸ªåŸŸåï¼Œåé¢ä¸è·Ÿä»»ä½•å†…å®¹ï¼Œé‚£è¿™æ—¶å€™å°±æœ‰é—®é¢˜äº†ï¼Œæ€»ä¸èƒ½å†å‘Šè¯‰ç”¨æˆ·åœ¨æœ€åè¾“å…¥ä¸€ä¸ª/ã€‚è§„é¿æ–¹æ¡ˆå…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸Šé¢ä»£ç ä¸­æœ€åmakeMatchå¤„çš„if elseè¯­å¥ï¼Œä¸”ä¸€å®šè¦ä¿è¯é¡ºåºï¼Œå³æœ€é•¿çš„è¦åœ¨å‰é¢ï¼Œå› ä¸ºé‡åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™åï¼Œåç»­è§„åˆ™ä¼šè¢«å¿½ç•¥ã€‚ http: - match: - uri: prefix: \"/echo/\" - uri: prefix: \"/echo\" rewrite: uri: \"/\" å¦‚æœé¡ºåºé¢ å€’ï¼Œé‚£ä¹ˆå½“è®¿é—®/echo/abcæ—¶ï¼Œä¼šé‡å®šå‘åˆ°//abcï¼Œè¿”å›404é”™è¯¯ã€‚ ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-pathfilter/:0:2","tags":["knative"],"title":"Knativeæ ¹æ®Pathè½¬å‘è¯·æ±‚","uri":"https://www.likakuli.com/posts/knative-pathfilter/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ€»ç»“ è‡³æ­¤ï¼Œå·²ç»æ”¯æŒé€šè¿‡ç»Ÿä¸€åŸŸåè®¿é—®ï¼Œä¸”é€šè¿‡PathæŠŠè¯·æ±‚è½¬å‘åˆ°ä¸é€šçš„æœåŠ¡ ","date":"2020-08-19","objectID":"https://www.likakuli.com/posts/knative-pathfilter/:0:3","tags":["knative"],"title":"Knativeæ ¹æ®Pathè½¬å‘è¯·æ±‚","uri":"https://www.likakuli.com/posts/knative-pathfilter/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"knative build docker image","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-build/","tags":["knative"],"title":"Knativeç»„ä»¶é•œåƒåˆ¶ä½œ","uri":"https://www.likakuli.com/posts/knative-build/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"èƒŒæ™¯ knative 0.14.0 æœ€è¿‘åœ¨æ­å»ºå…¬å¸çº§çš„serverlesså¹³å°ï¼Œé‡åˆ°æŸäº›é—®é¢˜ï¼Œçœ‹äº†æºç å‘ç°æ— æ³•é€šè¿‡å…¶æ‰©å±•æœºåˆ¶æ¥è§£å†³ï¼Œé‚å†³å®šä¿®æ”¹æºç æ¥è§£å†³ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-build/:0:1","tags":["knative"],"title":"Knativeç»„ä»¶é•œåƒåˆ¶ä½œ","uri":"https://www.likakuli.com/posts/knative-build/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"è¿‡ç¨‹ æºç å¾ˆå¿«ä¿®æ”¹å®Œäº†ï¼Œæœ¬åœ°ç¼–è¯‘é€šè¿‡ï¼Œknativeçš„ç»„ä»¶æ˜¯å®¹å™¨åŒ–è¿è¡Œçš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å†åˆ¶ä½œé•œåƒï¼Œä½†æ˜¯æµè§ˆå®Œå®˜æ–¹githubé¡¹ç›®ï¼Œå¹¶æœªå‘ç°æœ‰Dockerfileæ–‡ä»¶ï¼Œäºæ˜¯å†³å®šä½¿ç”¨é€†å‘æ–¹æ³•é€šè¿‡imageåæ¨å‡ºæ¥Dockerfileï¼Œäºæ˜¯åˆ©ç”¨ä¹‹å‰ä¿å­˜çš„çš„shellè„šæœ¬è¿›è¡Œåå‘è§£æï¼Œå¦‚ä¸‹ docker history --no-trunc 8b13dd01e81b | tac | tr -s ' ' | cut -d \" \" -f 5- | sed 's,^/bin/sh -c #(nop) ,,g' | sed 's,^/bin/sh -c,RUN,g' | sed 's, \u0026\u0026 ,\\n \u0026 ,g' | sed 's,\\s*[0-9]*[\\.]*[0-9]*\\s*[kMG]*B\\s*$,,g' | head -n -1 bazel build ... ko publish knative.dev/net-istio/cmd/webhook 463kB kodata contents, at $KO_DATA_PATH ko publish knative.dev/net-istio/cmd/webhook 52.9MB go build output, at /ko-app/webhook WTF? è¿™å’Œæˆ‘è®¤çŸ¥é‡Œçš„Dockerfileå®Œå…¨ä¸æ˜¯ä¸€å›äº‹å•Šï¼Œèµ¶ç´§googleï¼Œé¦–å…ˆgoogleæœç´¢äº†bazelï¼Œç„¶ååŒºé¡¹ç›®ä¸­æŸ¥çœ‹ï¼Œå¹¶æ²¡æœ‰å‘ç°æœ‰å•¥ç›¸å…³çš„æ–‡ä»¶ï¼Œå€’æ˜¯æœ‰ä¸ª.ko.yamlçš„æ–‡ä»¶ï¼Œé‡Œé¢æœ‰ä¸€æ¡è¯­å¥ï¼Œæ˜¯ä¸ªé•œåƒåç§°ï¼Œç„¶ågoogleæœç´¢äº†koï¼Œæœç„¶ï¼Œå¤§å…¬å¸å°±æ˜¯ä¸ä¸€æ ·ï¼Œä¸€ä¸ªkoè§£å†³äº†ä»diamanteç¼–è¯‘ï¼Œæ‰“é•œåƒï¼Œä¸Šä¼ é•œåƒï¼Œéƒ¨ç½²åˆ°k8sé›†ç¾¤ä¸­çš„æ‰€æœ‰æ­¥éª¤ï¼ˆå¿ƒä¸­æš—è‡ªæ„Ÿå¹googleæ˜¯çœŸçš„ç‰›ï¼‰ï¼Œå½“ç„¶ä¹Ÿæ”¯æŒåªæŠŠé•œåƒloadåˆ°æœ¬åœ°ï¼Œè€Œä¸è¿›è¡Œpushï¼Œä¹Ÿä¸åœ¨k8sä¸­åˆ›å»ºï¼ŒåŠ ä¸ªâ€“localå°±å¥½äº†ã€‚ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-build/:0:2","tags":["knative"],"title":"Knativeç»„ä»¶é•œåƒåˆ¶ä½œ","uri":"https://www.likakuli.com/posts/knative-build/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"æ€»ç»“ å…¶å®æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯èŠ±äº†è¾ƒé•¿æ—¶é—´çš„ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåŸå›  æ¬ ç¼ºæŸäº›çŸ¥è¯†ï¼šè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å¾€å¾€æ— æ³•ç›´æ¥æ‰¾åˆ°æ­£ç¡®ç­”æ¡ˆï¼Œåªèƒ½é€šè¿‡è¸©å‘ä¹‹åé€æ­¥æ’é™¤æ‰é”™è¯¯ç­”æ¡ˆï¼Œæ‰èƒ½ä¸€æ­¥æ­¥çš„æ‰¾åˆ°æ­£ç¡®çš„ç­”æ¡ˆ knativeæ¯”è¾ƒæ–°ï¼ˆ0.14.0ï¼‰ï¼Œç½‘ä¸Šå¾ˆéš¾æ‰¾åˆ°éœ€è¦çš„ç­”æ¡ˆ æ•´ä¸ªè¿‡ç¨‹è™½ç„¶èŠ±è´¹è¾ƒå¤šæ—¶é—´ï¼Œä½†æ˜¯æ”¶è·é¢‡ä¸°ã€‚ä¹‹æ‰€ä»¥å†™è¿™ä¸€ç¯‡å†…å®¹ï¼Œä¹Ÿæ˜¯å¸Œæœ›ä¸ºåæ¥äººè§£å†³ä¸€ä¸‹æ­¤ç±»çƒ¦æ¼ï¼Œåœ¨æ¯”è¾ƒç´§æ€¥æ—¶ï¼Œä¸ºå¤§å®¶èŠ‚çœæ—¶é—´ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°ä¸€éƒ¨åˆ†äººã€‚ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-build/:0:3","tags":["knative"],"title":"Knativeç»„ä»¶é•œåƒåˆ¶ä½œ","uri":"https://www.likakuli.com/posts/knative-build/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"é€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®knativeé›†ç¾¤å†…çš„æœåŠ¡","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-ingress-gateway/","tags":["knative"],"title":"Knativeé€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡","uri":"https://www.likakuli.com/posts/knative-ingress-gateway/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"èƒŒæ™¯ knative 0.14.0 å®é™…ä¿®æ”¹å¯èƒ½ä¸è´´å‡ºæ¥çš„ä»£ç ä¸ç¬¦ï¼Œè´´å‡ºæ¥çš„ä»£ç åªæ˜¯ä¸ºäº†æ–¹ä¾¿å¿«é€Ÿå®ç°åŠŸèƒ½ æœ€è¿‘åœ¨æ­å»ºå…¬å¸çº§çš„serverlesså¹³å°ï¼Œéœ€è¦ç”¨åˆ°åŸŸåæ¥è®¿é—®å†…éƒ¨æœåŠ¡ï¼Œé‡‡å–çš„æ˜¯é€šè¿‡PATHæ¥åŒºåˆ†ä¸åŒçš„æœåŠ¡ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-ingress-gateway/:0:1","tags":["knative"],"title":"Knativeé€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡","uri":"https://www.likakuli.com/posts/knative-ingress-gateway/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"é—®é¢˜ ç”³è¯·å®ŒåŸŸååï¼Œåˆ†åˆ«é€šè¿‡åŸŸåå’ŒIP:PORTå½¢å¼è®¿é—®å·²éƒ¨ç½²çš„helloworldæœåŠ¡ curl -v -H \"Host: api-test.sls.intra.kaku.com\" http://api-test.sls.intra.kaku.com/ * Trying 10.88.128.112... * TCP_NODELAY set * Connected to api-test.sls.intra.kaku.com (10.88.128.112) port 80 (#0) \u003e GET / HTTP/1.1 \u003e Host: api-test.sls.intra.kaku.com \u003e User-Agent: curl/7.54.0 \u003e Accept: */* \u003e \u003c HTTP/1.1 426 Upgrade Required \u003c Date: Thu, 09 Jul 2020 11:59:20 GMT \u003c Content-Length: 0 \u003c Connection: keep-alive \u003c server: istio-envoy \u003c * Connection #0 to host api-test.sls.intra.kaku.com left intact # 10.190.16.26 ä¸º knative-ingress-gatewayçš„å®¹å™¨IP curl -v -H \"Host:api-test.sls.intra.kaku.com\" http://10.190.16.26/ * Trying 10.190.16.26... * TCP_NODELAY set * Connected to 10.190.16.26 (10.190.16.26) port 80 (#0) \u003e GET / HTTP/1.1 \u003e Host:api-test.sls.intra.kaku.com \u003e User-Agent: curl/7.54.0 \u003e Accept: */* \u003e \u003c HTTP/1.1 404 Not Found \u003c date: Thu, 09 Jul 2020 12:03:05 GMT \u003c server: istio-envoy \u003c content-length: 0 \u003c * Connection #0 to host 10.190.16.26 left intact å¯ä»¥çœ‹åˆ°éƒ½æ— æ³•æ­£å¸¸è¿”å›ï¼Œé€šè¿‡åŸŸåè®¿é—®çš„æ—¶å€™è¿”å›äº†426ï¼Œé€šè¿‡IP:PORTè®¿é—®çš„æ—¶å€™è¿”å›äº†404ã€‚ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-ingress-gateway/:0:2","tags":["knative"],"title":"Knativeé€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡","uri":"https://www.likakuli.com/posts/knative-ingress-gateway/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ’æŸ¥ 426 Upgrade Required è¿™ä¸ªé—®é¢˜ç›´æ¥googleä¸€æœå°±å‡ºæ¥ç­”æ¡ˆäº†ï¼Œå‚è€ƒ è¿™é‡Œï¼Œå…¶å®è¿™æ˜¯envoyçš„èƒ½åŠ›ï¼Œåªè¦åœ¨envoyè¿è¡Œçš„å®¹å™¨ä¸­è®¾ç½®ISTIO_META_HTTP10ç¯å¢ƒå˜é‡ä¸º\"1\"é—®é¢˜å°±è§£å†³äº†ï¼Œå³**ISTIO_META_HTTP10: '\"1\"'** 404 Not Found è¿™ä¸ªé—®é¢˜å°±æ¶‰åŠåˆ°VirtualServiceäº†ï¼Œç®€ç§°vsï¼Œåœ¨ä»‹ç»vsä¹‹å‰æˆ‘ä»¬å…ˆå¤§è‡´è¿‡ä¸€ä¸‹knativeåˆ›å»ºé›†ç¾¤çš„æµç¨‹ å‡è®¾æˆ‘ä»¬é€šè¿‡kubectlæ“ä½œï¼Œæ­¤æ—¶æˆ‘ä»¬é€šè¿‡kubectl create -f helloworld.yamlçš„æ–¹å¼åˆ›å»ºksvcæœåŠ¡ï¼Œå¦‚æœé›†ç¾¤å„ç»„ä»¶æ­£å¸¸å·¥ä½œï¼Œä¸”ksvcå†…å®¹æ­£ç¡®ï¼Œé‚£ä¹ˆç¨å¾®è¿‡ä¸€ä¼šå°±å¯ä»¥åœ¨é›†ç¾¤ä¸­çœ‹åˆ°æˆ‘ä»¬çš„æœåŠ¡äº†ï¼Œæˆ‘ä»¬éœ€è¦åšçš„ä»…ä»…æ˜¯æ‰§è¡Œä¸€æ¡å‘½ä»¤è€Œå·²ã€‚å¯ä»¥çœ‹åˆ°knativeå°è£…çš„å¤ªå¥½äº†ï¼Œæå¤§çš„ç®€åŒ–äº†ç”¨æˆ·æ“ä½œï¼Œå¯¹äºå¯¹é›†ç¾¤æ²¡æœ‰é«˜çº§éœ€æ±‚çš„ç”¨æˆ·éå¸¸å‹å¥½ï¼ŒåŒæ—¶ä¹Ÿæœ‰åˆ©äºæˆ‘ä»¬å¿«é€Ÿå…¥é—¨ï¼Œå¦åˆ™ï¼Œå¦‚æœè¦æ‰§è¡Œä¸€å †å‘½ä»¤çš„è¯ï¼Œå°±çœŸçš„å¯ä»¥ä»å…¥é—¨åˆ°æ”¾å¼ƒäº† ä½†æ˜¯æˆ‘ä»¬æ¯•ç«Ÿæ˜¯ç®¡ç†å‘˜ï¼Œè¿˜æ˜¯è¦å¯¹è‡ªå·±æé«˜è¦æ±‚çš„ï¼Œä¸€å®šè¦ææ¸…æ¥šé‡Œé¢çš„åŸç†ï¼Œå„ç»„ä»¶ä¹‹é—´çš„äº¤äº’ï¼Œå¦åˆ™ç³»ç»Ÿå¯¹äºæˆ‘ä»¬æ¥è¯´å°±å®Œå…¨æ˜¯ä¸ªé»‘ç›’ï¼Œä¸å‡ºé—®é¢˜è¿˜å¥½ï¼Œå‡ºé—®é¢˜å°±å‚»çœ¼äº†ã€‚äº†è§£æºç ä¹Ÿæ˜¯å¿…é¡»çš„ï¼Œè¯´åˆ°æºç ï¼Œåªèƒ½æ„Ÿå¹knativeçš„æºç è¦æ¯”k8sçš„æºç å°è£…çš„å¥½å¤ªå¤šäº†ï¼Œå…¶ä¸­ä¸€ä¸ªåŸå› ä¹Ÿä½¿å¾—ç›Šäºk8sæä¾›çš„ä¸°å¯Œçš„æ‰©å±•æœºåˆ¶ï¼šcrdã€operatorã€informerã€webhookç­‰ã€‚knativeçš„æºç çœŸåº”è¯¥ä¹Ÿå€¼å¾—æ‹¿å‡ºæ¥ä¸€èµ·åˆ†äº«ï¼Œä»”ç»†ç ”è¯»ã€‚ å›åˆ°æ­£é¢˜ï¼Œç½‘è·¯è·¯ç”±èƒ½åŠ›æˆ‘ä»¬é€‰æ‹©çš„æ˜¯istioï¼Œæˆ‘ä»¬å¤§è‡´åˆ†ä¸¤ç§ç±»å‹çš„èµ„æºè¿›è¡Œä»‹ç»ï¼Œå’Œç½‘ç»œæœ‰å…³çš„ vs å’Œç½‘ç»œæ— å…³çš„ å’Œç½‘ç»œæ— å…³çš„èµ„æºåˆ›å»ºæµç¨‹ ksvc --\u003e configuration --\u003e revision --\u003e deployment å’Œç½‘ç»œæœ‰å…³çš„èµ„æºåˆ›å»ºæµç¨‹ ksvc --\u003e route --\u003e king--\u003e virtualservice æˆ‘ä»¬çš„é—®é¢˜æ˜¯å’Œç½‘ç»œæœ‰å…³çš„ï¼Œæ‰€ä»¥é‡ç‚¹å…³æ³¨ä¸‹é¢è¿™ä¸ªæµç¨‹ï¼Œæœ€ç»ˆå¯¹æ¥istioçš„æ˜¯vsï¼Œäºæ˜¯æˆ‘ä»¬ç›´æ¥å»çœ‹vsçš„é…ç½®ï¼Œå‘ç°å’ŒåŸŸåç›¸å…³çš„æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œspec.hosts å’Œ spec.http.match.authorityï¼Œäºæ˜¯æƒ³åˆ°çš„æœ€ç®€å•çš„ä¿®æ”¹æ–¹å¼å°±æ˜¯æŠŠæˆ‘ä»¬çš„åŸŸååŠ å…¥åˆ°spec.hostsä¸­ï¼Œå»æ‰spec.http.match.authorityï¼Œé€šè¿‡çœ‹ä»£ç å‘ç°è¿™ä¸¤å¤„å¹¶æ²¡æœ‰å¯ä»¥ä¿®æ”¹çš„æœºåˆ¶ï¼Œäºæ˜¯æƒ³åˆ°åˆ©ç”¨MutatingWebhookæ¥å®ç°ä¿®æ”¹ æ§åˆ¶è¿™ä¸¤ä¸ªå±æ€§çš„åœ°æ–¹éƒ½åœ¨net-istioçš„controllerä¸­ï¼Œwebhookå¯¹åº”çš„æ˜¯net-istioçš„webhookï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬éœ€è¦åœ¨webhookä¸­æ·»åŠ å¯¹åº”çš„ä»£ç ï¼Œä¸»è¦æ”¹åŠ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œå¦‚ä¸‹ // æ³¨å†Œvirtualserviceç±»å‹ï¼Œè¡¨ç¤ºè¦å¯¹å…¶è¿›è¡Œmutateçš„æ“ä½œï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æ­¤æ³¨å†Œå³å¯ï¼Œcontrollerä¼šè‡ªåŠ¨ä¿®æ”¹å¯¹åº”çš„MutatingWebhookConfigurationï¼Œæ·»åŠ å¯¹åº”çš„èµ„æºå’Œæ“ä½œ var types = map[schema.GroupVersionKind]resourcesemantics.GenericCRD{ appsv1.SchemeGroupVersion.WithKind(\"Deployment\"): \u0026defaults.IstioDeployment{}, v1alpha3.SchemeGroupVersion.WithKind(\"VirtualService\"): \u0026defaults.IstioVirtualService{}, } // pkg/defaults/virtualservice_default.goï¼Œä»¥å»æ‰match.authorityä¸¾ä¾‹ package defaults import ( \"context\" \"istio.io/client-go/pkg/apis/networking/v1alpha3\" \"knative.dev/pkg/apis\" ) type IstioVirtualService struct { v1alpha3.VirtualService `json:\",inline\"` } func (vs *IstioVirtualService) Validate(context.Context) *apis.FieldError { return nil } func (vs *IstioVirtualService) SetDefaults(ctx context.Context) { for _, http := range vs.Spec.Http { for _, match := range http.Match { match.Authority = nil } } } å¯ä»¥çœ‹åˆ°æ•´ä½“ä¿®æ”¹å¾ˆå°‘ï¼Œä¿®æ”¹å®Œä¹‹åé‡æ–°ç¼–è¯‘ï¼Œåˆ¶ä½œé•œåƒï¼Œä¿®æ”¹çº¿ä¸ŠPodçš„Imageï¼Œè§¦å‘åŸåœ°é‡å¯ï¼Œç„¶ååˆ é™¤æ‰åŸæœ‰çš„vsï¼Œæ–°çš„vsè‡ªåŠ¨ç”Ÿæˆï¼ŒæŸ¥çœ‹æ–°çš„vsï¼Œwtfï¼Ÿ å±…ç„¶å’Œä¹‹å‰ä¸€æ ·ï¼Œæ²¡æœ‰å®ç°æˆ‘ä»¬çš„æ•ˆæœï¼ŒæŸ¥kube-apiserveræ—¥å¿—æ²¡æœ‰çœ‹åˆ°åœ¨åˆ›å»ºvsæ—¶è°ƒç”¨webhookï¼ŒæŸ¥çœ‹webhookçš„æ—¥å¿—ï¼Œä¹Ÿæ²¡æœ‰å‘ç°è°ƒç”¨ï¼Œä½†æ˜¯åœ¨åˆ›å»ºdeploymentæ—¶å´ä¼šè°ƒç”¨ï¼Œç„¶åæŸ¥çœ‹webhookçš„é…ç½®ï¼Œå‘ç°èµ„æºé‡Œä¹Ÿå·²ç»åŠ ä¸Šäº†ï¼ŒæŸ¥äº†å¥½ä¹…è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°åŸå› ï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªå§¿åŠ¿ä¸å¯¹äº†ï¼Œç”±äºæ—¶é—´å…³ç³»æš‚æ—¶æ¢å¦ä¸€ç§æ–¹å¼å®ç°ã€‚ å› ä¸ºvsæ˜¯ç”±kingåˆ›å»ºçš„ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºkingçš„åœ°æ–¹ä¿®æ”¹ï¼Œè¿™æ ·åœ¨kingåˆ›å»ºvsçš„æ—¶å€™ä¼šè‡ªåŠ¨å¸¦ä¸Šæˆ‘ä»¬è‡ªå®šä¹‰çš„domainsï¼Œå¦‚ä¸‹ // é€šè¿‡annotationçš„æ–¹å¼ï¼ŒæŠŠéœ€è¦æ·»åŠ åˆ°hostsä¸­çš„åŸŸåæ”¾åˆ°annotationä¸­ // MakeIngressSpec creates a new IngressSpec func MakeIngressSpec( ctx context.Context, r *servingv1.Route, tls []v1alpha1.IngressTLS, targets map[string]traffic.RevisionTargets, visibility map[string]netv1alpha1.IngressVisibility, acmeChallenges ...v1alpha1.HTTP01Challenge, ) (v1alpha1.IngressSpec, error) { ... // add custom external domains customHostStr := r.Annotations[\"serverless.kakuchuxing.com/domains\"] sort.Sort(sort.Reverse(sort.StringSlice(names))) if len(customHostStr) \u003e 0 { customHosts := strings.Split(customHostStr, \";\") for _, name := range names { if name != \"default\" { visibility := netv1alpha1.IngressVisibilityExternalIP rule := *makeIngressRule(customHosts, r.Namespace, visibility, name, targets[name]) // If this is a public rule, we need to configure ACME challenge paths. rule.HTTP.Paths = append( makeACMEIngressPaths(challengeHosts, customHosts), rule.HTTP.Paths...) rules = append(rules, rule) } } } ... } é¦–å…ˆä¿®æ”¹ksvcï¼Œæ·»åŠ å¯¹åº”çš„annotaitonï¼Œç„¶åç»§ç»­ä¹‹å‰çš„æ“ä½œè¿›è¡Œç¼–è¯‘ï¼Œæ‰“é•œåƒï¼ŒåŸåœ°å‡çº§ï¼Œåˆ é™¤vsï¼Œæ–°çš„vsè‡ªé€ç”Ÿæˆï¼Œæ­¤æ—¶å¯ä»¥çœ‹åˆ°å·²ç»ä½¿æˆ‘ä»¬æœŸæœ›çš„æ•ˆæœäº†ï¼Œç„¶åç”¨åŸŸåè®¿é—®ï¼ŒHelloWorldç»ˆäºå¯ä»¥æ­£å¸¸è®¿é—®äº†ã€‚ ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-ingress-gateway/:0:3","tags":["knative"],"title":"Knativeé€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡","uri":"https://www.likakuli.com/posts/knative-ingress-gateway/"},{"categories":["å®šåˆ¶å¼€å‘"],"content":"æ€»ç»“ é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡webhookçš„æ–¹å¼ä¸ç”Ÿæ•ˆï¼Œç°è±¡çœ‹èµ·æ¥æ˜¯æ²¡è°ƒç”¨webhookï¼Œè¿˜éœ€è¦å†å»çœ‹ä¸‹k8sæœ‰å…³webhookè°ƒç”¨çš„éƒ¨åˆ†çš„ä»£ç ï¼Œå¾ˆå¯èƒ½åˆæ˜¯ä¸€ä¸ªçŸ¥è¯†ç›²åŒºã€‚ knativeä¸­å¾ˆå¤šç±»å‹çš„å±æ€§å¹¶æ²¡æœ‰åœ¨ä¸Šå±‚æš´éœ²ï¼Œå¯¼è‡´æ— æ³•ç›´æ¥ä½¿ç”¨ksvcè¿›è¡Œç®¡ç†ï¼Œè¦ä¹ˆæ”¹æºç ï¼Œè¦ä¹ˆè‡ªå·±è´Ÿè´£ç®¡ç†åŸæœ¬ç”±ksvcç»Ÿä¸€ç®¡ç†çš„ç»„ä»¶ï¼Œè™½ç„¶æ›´åŠ çµæ´»ï¼Œä½†æ˜¯ä½¿ç”¨æˆæœ¬ä¹Ÿæ›´é«˜ï¼Œè¿èƒŒksvcè®¾è®¡çš„åˆè¡· é€šè¿‡æ­¤æ¬¡é—®é¢˜æ’æŸ¥ï¼Œå­¦ä¹ åˆ°äº†knativeæ•´ä¸ªæµç¨‹ã€åŸç†ï¼Œç†æ¸…äº†å„ç»„ä»¶çš„äº¤äº’ï¼Œå¯¹åç»­é—®é¢˜æ’æŸ¥æœ‰å¾ˆå¤§çš„å¸®åŠ© ","date":"2020-07-09","objectID":"https://www.likakuli.com/posts/knative-ingress-gateway/:0:4","tags":["knative"],"title":"Knativeé€šè¿‡å¤–éƒ¨åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡","uri":"https://www.likakuli.com/posts/knative-ingress-gateway/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"endpointå˜åŒ–","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-ep-event/","tags":["kubernetes"],"title":"Endpointå¼‚å¸¸å˜åŒ–","uri":"https://www.likakuli.com/posts/kubernetes-ep-event/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ k8s 1.12.4 åŒ…å«è‡ªå®šä¹‰åŠŸèƒ½ çº¿ä¸Šé›†ç¾¤åœ¨æ‰¹é‡åŸåœ°å‡çº§æ—¶å‡ºç°æµé‡å¼‚å¸¸é—®é¢˜ï¼Œå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š æ‰¹é‡æ‘˜æµï¼Œå¹¶ç­‰å¾…7ç§’ æ‰¹é‡åˆ é™¤å®¹å™¨ watchåˆ°Endpoint ready å˜åŒ–ï¼Œæ±‡æ€»2så†…çš„å˜åŒ–ï¼Œæ‘˜æµæˆ–è€…æ¥æµï¼ˆé€šç”¨çš„å¤„ç†æ–¹å¼ï¼Œå¹‚ç­‰ï¼‰ åŸåœ°å‡çº§æ˜¯é ä¿®æ”¹imageå®ç°çš„ï¼Œåˆ©ç”¨çš„å°±æ˜¯k8såŸç”Ÿçš„èƒ½åŠ›ã€‚ç¬¬ä¸‰æ­¥ä¸­ä¸ºäº†é™ä½å¯¹ç¬¬ä¸‰æ–¹APIçš„è®¿é—®æ¬¡æ•°ï¼Œç­‰å¾…2sï¼Œæ±‡æ€»2så†…æ‰€æœ‰å˜åŒ–ç»Ÿä¸€è°ƒç”¨ä¸€æ¬¡APIæ¥è¿›è¡Œæ‘˜æµæˆ–è€…æ¥æµã€‚é—®é¢˜è¡¨ç°ä¸ºä¸Šè¿°è¿‡ç¨‹ä¸­å®¹å™¨å…ˆæ‘˜æµï¼Œå†æ¥æµï¼ˆå¼‚å¸¸ï¼‰ï¼Œå†æ‘˜æµï¼Œæœ€åå†æ¥æµï¼ŒæœŸæœ›çš„åœºæ™¯æ˜¯å®¹å™¨æ‘˜æµï¼Œå®Œåç­‰å¾…å®¹å™¨é‡å¯ï¼Œæ­£å¸¸ä¹‹åå†æ¥æµã€‚ ","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-ep-event/:0:1","tags":["kubernetes"],"title":"Endpointå¼‚å¸¸å˜åŒ–","uri":"https://www.likakuli.com/posts/kubernetes-ep-event/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"åˆ†æ è¿‘æœŸä¸Šçº¿äº†åŸåœ°é‡å»ºçš„åŠŸèƒ½ï¼Œå‡ºé—®é¢˜çš„é›†ç¾¤éƒ½æ˜¯ä½¿ç”¨æ­¤åŠŸèƒ½è¿›è¡Œå‘å¸ƒæ›´æ–°ï¼Œæ‰€ä»¥çŒœæµ‹å¯èƒ½å’Œè¿™ä¸ªåŠŸèƒ½æœ‰å…³ç³»ã€‚åœ¨åˆ é™¤é›†ç¾¤æˆ–è€…æ‰¹é‡æ¼‚ç§»å®¹å™¨æ—¶ï¼Œä¹Ÿæ¶‰åŠå¯¹åº”æµç¨‹ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰é—®é¢˜ï¼Œæ€»çš„æ’æŸ¥æ–¹å‘å¦‚ä¸‹ï¼š endpoint å˜åŒ–æœºåˆ¶ ä¸ºä»€ä¹ˆæ‰¹é‡åˆ é™¤æ—¶æ²¡æœ‰å‡ºç°é—®é¢˜ åŸåœ°å‡çº§å’Œåˆ é™¤æœ‰ä»€ä¹ˆå·®å¼‚ Endpointå˜åŒ–æœºåˆ¶ ä¼—æ‰€å‘¨çŸ¥ï¼Œk8sé’ˆå¯¹ä¸åŒçš„èµ„æºç±»å‹ä¼šæœ‰ç›¸åº”çš„controllerä¸ä¹‹å¯¹åº”ï¼Œæ§åˆ¶å…¶åŠå…¶å…³è”èµ„æºçš„ç”Ÿå‘½å‘¨æœŸçš„å˜åŒ–ï¼ŒEndpointä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨kube-controller-managerä¸­æœ‰endpoint controllerï¼ŒæŸ¥çœ‹å…¶é€»è¾‘ï¼Œä¸»è¦ç›¸å…³çš„éƒ¨åˆ†å¦‚ä¸‹æ‰€ç¤º func (e *EndpointController) syncService(key string) error { ... subsets := []v1.EndpointSubset{} var totalReadyEps int = 0 var totalNotReadyEps int = 0 for _, pod := range pods { if len(pod.Status.PodIP) == 0 { glog.V(5).Infof(\"Failed to find an IP for pod %s/%s\", pod.Namespace, pod.Name) continue } if !tolerateUnreadyEndpoints \u0026\u0026 pod.DeletionTimestamp != nil { glog.V(5).Infof(\"Pod is being deleted %s/%s\", pod.Namespace, pod.Name) continue } epa := *podToEndpointAddress(pod) hostname := pod.Spec.Hostname if len(hostname) \u003e 0 \u0026\u0026 pod.Spec.Subdomain == service.Name \u0026\u0026 service.Namespace == pod.Namespace { epa.Hostname = hostname } // Allow headless service not to have ports. if len(service.Spec.Ports) == 0 { if service.Spec.ClusterIP == api.ClusterIPNone { subsets, totalReadyEps, totalNotReadyEps = addEndpointSubset(subsets, pod, epa, nil, tolerateUnreadyEndpoints) // No need to repack subsets for headless service without ports. } } else { for i := range service.Spec.Ports { servicePort := \u0026service.Spec.Ports[i] portName := servicePort.Name portProto := servicePort.Protocol portNum, err := podutil.FindPort(pod, servicePort) if err != nil { glog.V(4).Infof(\"Failed to find port for service %s/%s: %v\", service.Namespace, service.Name, err) continue } var readyEps, notReadyEps int epp := \u0026v1.EndpointPort{Name: portName, Port: int32(portNum), Protocol: portProto} subsets, readyEps, notReadyEps = addEndpointSubset(subsets, pod, epa, epp, tolerateUnreadyEndpoints) totalReadyEps = totalReadyEps + readyEps totalNotReadyEps = totalNotReadyEps + notReadyEps } } } ... glog.V(4).Infof(\"Update endpoints for %v/%v, ready: %d not ready: %d\", service.Namespace, service.Name, totalReadyEps, totalNotReadyEps) ... } ä¸»è¦çš„å¤„ç†å‡½æ•°ä¸ºsyncServiceï¼Œå»æ‰äº†ä¸€äº›é€»è¾‘ï¼Œä¸»è¦çš„å¤„ç†é€»è¾‘åœ¨32è¡Œï¼Œéå†Podï¼ŒæŸ¥çœ‹å…¶PodReady Conditionæ˜¯å¦ä¸ºtrueï¼Œtrueçš„ä¼šä¼šæŠŠå…¶IPæ”¾å…¥subnetçš„Addressesç»“æ„ä¸­ï¼Œå¦åˆ™æ”¾å…¥NotReadyAddressesä¸­ã€‚Conditionä¸»è¦æ˜¯kubeletè®¾ç½®çš„ï¼Œåœ¨generateAPIPodStatusçš„æ—¶å€™ä¼šè¿›è¡Œè®¾ç½®ï¼Œå¦‚ä¸‹ // generateAPIPodStatus creates the final API pod status for a pod, given the // internal pod status. func (kl *Kubelet) generateAPIPodStatus(pod *v1.Pod, podStatus *kubecontainer.PodStatus) v1.PodStatus { glog.V(3).Infof(\"Generating status for %q\", format.Pod(pod)) // check if an internal module has requested the pod is evicted. for _, podSyncHandler := range kl.PodSyncHandlers { if result := podSyncHandler.ShouldEvict(pod); result.Evict { return v1.PodStatus{ Phase: v1.PodFailed, Reason: result.Reason, Message: result.Message, } } } s := kl.convertStatusToAPIStatus(pod, podStatus) // Assume info is ready to process spec := \u0026pod.Spec allStatus := append(append([]v1.ContainerStatus{}, s.ContainerStatuses...), s.InitContainerStatuses...) s.Phase = getPhase(spec, allStatus) // Check for illegal phase transition if pod.Status.Phase == v1.PodFailed || pod.Status.Phase == v1.PodSucceeded { // API server shows terminal phase; transitions are not allowed if s.Phase != pod.Status.Phase { glog.Errorf(\"Pod attempted illegal phase transition from %s to %s: %v\", pod.Status.Phase, s.Phase, s) // Force back to phase from the API server s.Phase = pod.Status.Phase } } kl.probeManager.UpdatePodStatus(pod.UID, s) s.Conditions = append(s.Conditions, status.GeneratePodInitializedCondition(spec, s.InitContainerStatuses, s.Phase)) s.Conditions = append(s.Conditions, status.GeneratePodReadyCondition(spec, s.Conditions, s.ContainerStatuses, s.Phase)) s.Conditions = append(s.Conditions, status.GenerateContainersReadyCondition(spec, s.ContainerStatuses, s.Phase)) // Status manager will take care of the LastTransitionTimestamp, either preserve // the timestamp from apiserver, or set a new one. When kubelet sees the pod, // `PodScheduled` condition must be true. s.Conditions = append(s.Conditions, v1.PodCon","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-ep-event/:0:2","tags":["kubernetes"],"title":"Endpointå¼‚å¸¸å˜åŒ–","uri":"https://www.likakuli.com/posts/kubernetes-ep-event/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ä¿®æ”¹æ–¹æ¡ˆ é€šè¿‡mutatingwebhookå®ç°ä¸€ä¸ªé€šç”¨çš„èƒ½åŠ›ï¼Œé’ˆå¯¹endpointçš„createå’Œupdateäº‹ä»¶ï¼Œä»é…ç½®ä¸­å¿ƒï¼ˆå†…éƒ¨ç»„ä»¶ï¼‰ä¸­è·å–å¯¹åº”çš„é…ç½®ï¼Œå¹¶é€šè¿‡è§„åˆ™å¼•æ“ï¼ˆå¼€æºç‰ˆæœ¬å¯å‚è€ƒ https://github.com/antonmedv/expr ï¼‰ï¼Œå¯¹subnetä¸­çš„Addresseså’ŒNotReadyAddressesåšä¸€äº›ä¿®æ”¹ï¼Œè¿™æ ·å¯ä»¥å®ç°æ— ä¾µå…¥å¼çš„ä¿®æ”¹ï¼Œä¹Ÿæ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥å¯¹é…ç½®è¿›è¡Œå®æ—¶ä¿®æ”¹ç­‰ï¼Œåç»­åƒsidecarè¿™ç§æ ¹æ®ç”¨æˆ·éœ€æ±‚æ¥è®¾ç½®pod ready conditionçš„æƒ…å†µï¼Œä¹Ÿæ— éœ€ä¿®æ”¹ä»£ç ï¼Œåªéœ€è¦æ·»åŠ é…ç½®å³å¯ï¼Œè€Œä¸”ä¹Ÿå¯ä»¥é€šè¿‡conditionçœ‹åˆ°çœŸå®çš„Containerã€PodçŠ¶æ€ ","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-ep-event/:0:3","tags":["kubernetes"],"title":"Endpointå¼‚å¸¸å˜åŒ–","uri":"https://www.likakuli.com/posts/kubernetes-ep-event/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ä¼˜é›…é€€å‡º","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/","tags":["kubernetes"],"title":"Sidecarä¼˜é›…é€€å‡º","uri":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ codisé›†ç¾¤åœ¨æ¥å…¥å¼¹æ€§äº‘æµ‹è¯•æ—¶å‘ç°å®¹å™¨æ¼‚ç§»å¤±è´¥ï¼Œé€šè¿‡é›†ç¾¤æ—¥å¿—çœ‹ï¼Œæç¤º è°ƒåº¦è¶…æ—¶ï¼Œå»ç•Œé¢æŸ¥çœ‹ï¼Œå·²ç»è°ƒåº¦æˆåŠŸäº†ï¼ˆè°ƒåº¦æˆåŠŸçš„æ ‡å¿—å°±æ˜¯å·²ç»æœ‰å®¿ä¸»æœºIPäº†ï¼‰ï¼ŒçŠ¶æ€æ˜¾ç¤ºçš„pendingå¹¶ä¸ä¸€å®šå°±æ˜¯è°ƒåº¦å¤±è´¥ã€‚ä½†è¿™ååº”ä¸å‡ºæ¥é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œæ¥ä¸‹æ¥å°±éœ€è¦åˆ°masteræœºå™¨ä¸Šæ‰§è¡Œå‘½åï¼ŒæŸ¥çœ‹æ—¥å¿—æ¥åˆ†æé—®é¢˜å‡ºåœ¨å“ªé‡Œ é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®å®šæ˜¯ä¸æ˜¯è°ƒåº¦è¶…æ—¶äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ kubectl describe po kirovpre-krds-sf-f3dec-0 æ¥çœ‹Podçš„åˆ›å»ºæ—¶é—´ä¸º 20:40:11ï¼Œè°ƒåº¦æˆåŠŸçš„æ—¶é—´ä¸º20:40:12ï¼Œå¯ä»¥çœ‹åˆ°è°ƒåº¦è¿˜æ˜¯å¾ˆå¿«çš„ã€‚å†çœ‹ä¸‹ç›¸å…³æ—¥å¿—ï¼Œæ˜¾ç¤º20:39:38åˆ é™¤æˆåŠŸï¼Œç„¶åç­‰å¾…å®¹å™¨è°ƒåº¦ï¼Œç­‰å¾…30såå‘ç°å®¹å™¨æœªè°ƒåº¦æˆåŠŸï¼Œåˆ™åˆ¤å®šä¸ºè°ƒåº¦è¶…æ—¶ã€‚ç®€å•æ¢³ç†ä¸‹æ—¶é—´çº¿ 20:39:38 åˆ é™¤æˆåŠŸ ï¼ˆkube-odinæ—¥å¿—ï¼‰ 20:40:11 å®¹å™¨åˆ›å»ºæˆåŠŸ ï¼ˆk8sï¼‰ 20:40:12 å®¹å™¨è°ƒåº¦æˆåŠŸ (k8s) ä»æ—¶é—´çº¿æ¥çœ‹ï¼Œç¡®å®ä»åˆ é™¤åˆ°è°ƒåº¦æˆåŠŸè€—æ—¶è¶…è¿‡äº†30sï¼Œä½†æ˜¯ä»å®¹å™¨åˆ›å»ºå‡ºæ¥åˆ°è°ƒåº¦æˆåŠŸæ‰1sï¼Œå¤§éƒ¨åˆ†è€—æ—¶æ˜¯åœ¨åˆ é™¤åˆ°æ–°åˆ›å»ºçš„é˜¶æ®µã€‚ç†Ÿæ‚‰k8sçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œåˆ é™¤Podçš„apiæ”¯æŒè®¾ç½®åˆ é™¤æ–¹å¼ï¼šbackgroudã€foregroudï¼ŒåŒºåˆ«å°±æ˜¯åå°åˆ é™¤æ˜¯å¼‚æ­¥çš„ï¼Œè°ƒç”¨apiåç«‹é©¬è¿”å›ï¼Œå‰å°åˆ é™¤çš„è¯æ˜¯åŒæ­¥çš„ï¼Œä¼šä¸€ç›´ç­‰å®¹å™¨çœŸæ­£åˆ é™¤åæ‰è¿”å›ï¼Œé»˜è®¤ä¸ºbackgroudã€‚ä¹Ÿå°±æ˜¯è¯´20:39:38æç¤ºçš„åˆ é™¤æˆåŠŸåªæ˜¯apiè°ƒç”¨æˆåŠŸï¼Œå®¹å™¨å¹¶æœªçœŸæ­£çš„åˆ é™¤ï¼Œå®¹å™¨çš„åˆ é™¤æ“ä½œä¸€ç›´åœ¨åå°æ‰§è¡Œï¼Œç›´åˆ°20:40:11æ‰åˆ é™¤æˆåŠŸï¼Œåˆ é™¤åç«‹é©¬åˆ›å»ºæ–°çš„å®¹å™¨ã€‚å¯ä»¥é€šè¿‡kubeletçš„æ—¥å¿—è¯æ˜è¿™ä¸€ç‚¹ï¼Œä¸‹é¢çš„æ—¥å¿—æ˜¯ç»è¿‡ç­›é€‰åçš„ I0603 20:39:37.908557 3033 kubelet.go:1913] SyncLoop (DELETE, \"api\"): \"kirovpre-krds-sf-f3dec-0_default(01473fb7-a17b-11ea-8d10-c88d83d31d55)\" I0603 20:39:37.908655 3033 kubelet_pods.go:1433] Generating status for \"kirovpre-krds-sf-f3dec-0_default(01473fb7-a17b-11ea-8d10-c88d83d31d55)\" I0603 20:39:37.908799 3033 kuberuntime_container.go:468] Running preStop hook for container \"docker://5fe57cf36af267adae571272f234762ad8741922e24074182ff25301e953ec72\" I0603 20:39:37.916683 3033 status_manager.go:499] Patch status for pod \"kirovpre-krds-sf-f3dec-0_default(01473fb7-a17b-11ea-8d10-c88d83d31d55)\" with \"{}\" I0603 20:39:37.916699 3033 status_manager.go:506] Status for pod \"kirovpre-krds-sf-f3dec-0_default(01473fb7-a17b-11ea-8d10-c88d83d31d55)\" updated successfully: (6, {Phase:Running Conditions:[{Type:Initialized Status:True LastProbeTime:0001-01-01 00:00:00 +0000 UTC LastTransitionTime:2020-05-29 15:07:09 +0800 CST Reason: Message:} {Type:Ready Status:True LastProbeTime:0001-01-01 00:00:00 +0000 UTC LastTransitionTime:2020-05-29 15:07:26 +0800 CST Reason: Message:} {Type:ContainersReady Status:True LastProbeTime:0001-01-01 00:00:00 +0000 UTC LastTransitionTime:2020-05-29 15:07:26 +0800 CST Reason: Message:} {Type:PodScheduled Status:True LastProbeTime:0001-01-01 00:00:00 +0000 UTC LastTransitionTime:2020-05-29 15:07:08 +0800 CST Reason: Message:}] Message: Reason: NominatedNodeName: HostIP:10.89.231.24 PodIP:10.169.92.60 StartTime:2020-05-29 15:07:09 +0800 CST InitContainerStatuses:[] ContainerStatuses:[{Name:agent-kirovpre-krds-ys02 State:{Waiting:nil Running:\u0026ContainerStateRunning{StartedAt:2020-05-29 15:07:18 +0800 CST,} Terminated:nil} LastTerminationState:{Waiting:nil Running:nil Terminated:nil} Ready:true RestartCount:0 Image:registry.kaku.com/kakuonline/kvstore-sidecar-python2-centos7-agent:ea6d410 ImageID:docker-pullable://registry.kaku.com/kakuonline/kvstore-sidecar-python2-centos7-agent@sha256:6d61df206fef0fbfd940e1139d7dff6b0dfaacd847d8d64b2b480cf5afd8a513 ContainerID:docker://5fe57cf36af267adae571272f234762ad8741922e24074182ff25301e953ec72} {Name:kirovpre-krds-ys02 State:{Waiting:nil Running:\u0026ContainerStateRunning{StartedAt:2020-05-29 15:07:22 +0800 CST,} Terminated:nil} LastTerminationState:{Waiting:nil Running:nil Terminated:nil} Ready:true RestartCount:0 Image:registry.kaku.com/kakuonline/kvstore-sidecar-krds:stable ImageID:docker-pullable://registry.kaku.com/kakuonline/kvstore-sidecar-krds@sha256:3945a5304ee92b89605831d991874d0b9fdffb89b19fc92d5bbc4969b8a3cf1f ContainerID:docker://2e2354889588dc7483d2bb9be27a5253f292374c8e179b12367e0deea8b2d825}] QOSClass:Burstable}) I0603 20:39:37.916795 3033 kubelet_pods.go:993] Pod \"kirovpre-krds-sf-f3dec-0_default(01473fb7-a17b-11ea-8d10-c88d83d31d55)\" is terminated, but some containers are still running I0603 20:39:40.975805 3033 kuberuntime_container.go:485] preStop hook for container {\"docker\" \"5fe57cf36af267adae571272f234762ad8741922e24074182ff25301e953ec72\"} completed I0603 20:39:40.975845 3033 kuberuntime_container.go:563] Killing container \"docker://2e2354889588dc7483d2bb9be27a5253f292374c8e179b12367e0deea8b2d825\" with 5 second grace period I0603 20:39:40.975856 3033 kuberuntime_container.go:468] Running preStop hook for container \"docker://2e2354889588dc7483d2bb9be27a5253f292374c8e179b123","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/:0:1","tags":["kubernetes"],"title":"Sidecarä¼˜é›…é€€å‡º","uri":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ æ˜ç™½äº†é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Œä¿®æ”¹å…¶å®å°±å¾ˆç®€å•äº†ï¼Œè¿™é‡Œä¸å†å¤šè¯´å¦‚ä½•ä¿®æ”¹ã€‚ æ­¤æ¬¡é—®é¢˜æ’æŸ¥ä½¿æˆ‘æ·±åˆ»çš„è®¤è¯†åˆ°äº†ä¸€ç‚¹ï¼šä¸€äº›çœ‹èµ·æ¥å¾ˆå®¹æ˜“ç†è§£çš„ä¸œè¥¿å¯èƒ½æ­£æ˜¯æˆ‘ä»¬æ€ç»´å®šå¼çš„è¯¯åŒºï¼Œè¶Šç®€å•çš„ä¸œè¥¿æˆ‘ä»¬å¾€å¾€è¶Šå®¹æ˜“å…ˆå…¥ä¸ºä¸»ï¼Œä¸å†è¿›è¡Œæ·±å…¥æ€è€ƒã€‚è€Œå¾ˆå¤šé—®é¢˜å¾€å¾€å°±æ˜¯è¿™äº›ä¸èµ·çœ¼çš„ç»†èŠ‚æ—¥ç§¯æœˆç´¯å¯¼è‡´çš„ï¼Œæˆ‘ä»¬è¦å°½å¯èƒ½çš„å¯¹æˆ‘ä»¬æ‰€ç”¨åˆ°çš„ä¸œè¥¿æœ‰æ·±åˆ»å…¨é¢çš„ç†è§£ï¼Œé™ä½å‡ºé—®é¢˜çš„æ¦‚ç‡ï¼Œæ¯•ç«Ÿçº¿ä¸Šæ— å°äº‹ã€‚æœ‰ç²¾åŠ›çš„è¯è¿˜æ˜¯è¦çœ‹çœ‹æºç ï¼Œæ¯”å¦‚ maxï¼ˆgraceperiod - cost, 2ï¼‰,æ„æ€å°±æ˜¯ä¼šä¸ºå®¹å™¨è‡³å°‘è®¾ç½®2sçš„æ—¶é—´ï¼Œè¶…è¿‡åæ‰èƒ½ä¼šè¿›è¡Œå¼ºåˆ ï¼›å†æ¯”å¦‚å¤–é¢ä¸ä¼ graceperiodæ—¶graceperiodç”¨podçš„terminationGracePeriodï¼Œä¼ çš„è¯å°±æ˜¯ä¼ è¿›æ¥çš„å‚æ•°ï¼Œè¿™å°±å¯èƒ½å¯¼è‡´å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼Œå¯¼è‡´ä¸ä¼šå¼ºåˆ ï¼ŒterminationGracePeriodå¤±æ•ˆç­‰ã€‚ ","date":"2020-06-23","objectID":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/:0:2","tags":["kubernetes"],"title":"Sidecarä¼˜é›…é€€å‡º","uri":"https://www.likakuli.com/posts/kubernetes-graceful-shutdown/"},{"categories":["bugä¿®å¤","é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"orphan controller revision cannot be adopt","date":"2020-04-01","objectID":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/","tags":["kubernetes"],"title":"Kube-controller-manageråŒæ­¥æ•°æ®æ…¢","uri":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/"},{"categories":["bugä¿®å¤","é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"èƒŒæ™¯ ç‰ˆæœ¬1.12.4 çº¿ä¸Šé‡åˆ°kube-controller-manageré‡å¯æ…¢çš„é—®é¢˜ï¼Œå…·ä½“è¡¨ç°ä¸ºè¿›ç¨‹é‡å¯è™½ç„¶é€Ÿåº¦å¿«ï¼Œä½†æ˜¯é‡å¯å®Œæ‰€æœ‰æ•°æ®éƒ½åŒæ­¥å®Œä¸€éè€—æ—¶å¾ˆé•¿ï¼Œé›†ç¾¤ä¸­å¤§çº¦5000ä¸ªstatefulsetï¼Œåœ¨è¿˜æ²¡åŒæ­¥å®Œä¸€éæ•°æ®ä¹‹å‰å¦‚æœæœ‰statefulsetçš„åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ç­‰æ“ä½œï¼Œå¯èƒ½ï¼ˆå’Œå…·ä½“statefulsetçš„æ“ä½œæœ‰å…³ï¼Œæ–°å»ºçš„æƒ…å†µè‚¯å®šæ˜¯åœ¨æœ€åï¼Œæ›´æ–°å’Œåˆ é™¤çš„æƒ…å†µéœ€è¦çœ‹åŒåçš„statefulsetæ˜¯å¦å·²ç»è¢«å¤„ç†è¿‡äº†ï¼Œå¦‚æœæ˜¯çš„è¯ä¹Ÿä¼šåœ¨æœ€åå¤„ç†ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä¸ä¼šæ’åœ¨æœ€åï¼‰å°±éœ€è¦ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½åŒæ­¥å®Œä¹‹åæ‰èƒ½ç»§ç»­å¤„ç†ã€‚ ","date":"2020-04-01","objectID":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/:0:1","tags":["kubernetes"],"title":"Kube-controller-manageråŒæ­¥æ•°æ®æ…¢","uri":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/"},{"categories":["bugä¿®å¤","é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"é—®é¢˜åŸå›  å¹¶å‘goroutineæ•° å½“å‰ç‰ˆæœ¬çš„statefulset controlleråªä½¿ç”¨äº†ä¸€ä¸ªgoroutineæ¥ä¸²è¡Œçš„å¤„ç†æ‰€æœ‰çš„statefulsetï¼Œåœ¨æœ€æ–°ç‰ˆçš„ä»£ç ä¸­å·²ç»æ”¯æŒäº†å¤šä¸ªgoroutineå¹¶è¡Œå¤„ç†ï¼Œä¸”å¯é…ç½® Informer List ç»è¿‡æ·»åŠ traceä¿¡æ¯æ‰“å°æ¯ä¸ªé˜¶æ®µè€—æ—¶ï¼Œå‘ç°åœ¨æ ¹æ®statefulsetè·å–å…¶å¯¹åº”çš„controllerrevisionæ—¶æ¯”è¾ƒæ…¢ï¼Œå¦‚ä¸‹ä»£ç æ®µ // adoptOrphanRevisions adopts any orphaned ControllerRevisions matched by set's Selector. func (ssc *StatefulSetController) adoptOrphanRevisions(set *apps.StatefulSet) error { // æ¯”è¾ƒæ…¢ revisions, err := ssc.control.ListRevisions(set) ... } è€Œä¸”åŒæ ·çš„é€»è¾‘ä¼šåœ¨è¿™é‡Œåœ¨æ‰§è¡Œä¸€æ¬¡ // syncStatefulSet syncs a tuple of (statefulset, []*v1.Pod). func (ssc *StatefulSetController) syncStatefulSet(set *apps.StatefulSet, pods []*v1.Pod) error { ... // TODO: investigate where we mutate the set during the update as it is not obvious. // UpdateStatefulSeté‡Œé¢ä¼šå†æ¬¡è°ƒç”¨ListRevisionså‡½æ•° if err := ssc.control.UpdateStatefulSet(set.DeepCopy(), pods); err != nil { return err } ... } æœ€ç»ˆå°±å¯¼è‡´åŒæ­¥ä¸€ä¸ªstatefulsetå°±éœ€è¦100+msï¼Œæ€»çš„5000+ statefulsetåŒæ­¥å®Œä¸€éå°±éœ€è¦å°†è¿‘20mã€‚ ControllerRevision æ¯ä¸ªstatefulsetéƒ½å¯¹åº”ä¸€äº›controllerrevisionèµ„æºï¼Œä»å­—é¢æ„æ€å°±å¯ä»¥çœ‹å‡ºæ¥å…¶ä½œç”¨å°±æ˜¯è®°å½•æ­¤statefulsetçš„å†å²ä¿¡æ¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹statefulsetåšå›æ»šä¹‹ç±»çš„æ“ä½œçš„åŸå› ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šä¸ºæ¯ä¸ªstatefulsetä¿ç•™10æ¡å†å²è®°å½•ï¼Œåœ¨æ¯ä¸ªstatefulsetä¸Šæœ‰å±æ€§å¯é…ç½®ã€‚ å…¶å®ä¸Šé¢è¯´åˆ°çš„è€—æ—¶çš„é€»è¾‘å°±æ˜¯é’ˆå¯¹æ¯ä¸ªstatefulsetå»è·å–å­¤å„¿controllerrevisionï¼Œå¦‚æœæœ‰åˆ™ä¼šé¢†å…»å­¤å„¿ã€‚æ‰€ä»¥ä¸€ä¸ªä¼˜åŒ–é¡¹å°±æ˜¯ç›´æ¥ä»å­¤å„¿ä¸­æ‰¾ï¼Œè€Œä¸æ˜¯ä»å…¨é‡ä¸­æ‰¾ï¼Œä¸”æŠŠæ‰€æœ‰çš„controllerrevisionç¼“å­˜åˆ°æœ¬åœ°ï¼Œä¸å†ä½¿ç”¨ListInformeræä¾›çš„é‚£äº›æ–¹æ³•ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•å§‹ç»ˆä¼šåœ¨å…¨é‡ä¸­å¯»æ‰¾æ»¡è¶³æ¡ä»¶çš„ï¼Œè€Œä¸”è¿˜ä¼šç”¨åˆ°åå°„ï¼Œè™½ç„¶æ•°æ®ä¹Ÿéƒ½åœ¨æœ¬åœ°ï¼Œä½†æ€§èƒ½è¿˜æ˜¯æ¯”è¾ƒå·®çš„ã€‚å¤§ä½“æ€è·¯å°±æ˜¯åœ¨åˆ›å»ºstatesetfulset controlleræ—¶åŒæ—¶æ³¨å†Œcontrollerrevisionç›¸å…³çš„äº‹ä»¶ï¼ŒæŠŠæ‰€æœ‰çš„revisionå’Œå­¤å„¿revisionç¼“å­˜åˆ°è‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ä¸­ï¼Œåç»­ç›´æ¥ä»é‡Œé¢è·å–å³å¯ã€‚ ","date":"2020-04-01","objectID":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/:0:2","tags":["kubernetes"],"title":"Kube-controller-manageråŒæ­¥æ•°æ®æ…¢","uri":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/"},{"categories":["bugä¿®å¤","é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"æœ€ç»ˆæ•ˆæœ ä¼˜åŒ–å®Œä¹‹åæœ€ç»ˆé‡å¯ä¸€æ¬¡controller-managerçŸ¥é“å…¨é‡æ•°æ®åŒæ­¥å®Œä¸€éçš„è€—æ—¶ç”±20må·¦å³ç¼©å‡åˆ°1må·¦å³ï¼Œå¯ä»¥çœ‹åˆ°æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œè€Œä¸”è¿˜æ˜¯æœ‰ä¼˜åŒ–ç©ºé—´çš„ï¼Œæ¯”å¦‚ç»§ç»­ä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œåœ¨å¤‡controller-managerå¯åŠ¨æ—¶å°±å…ˆæŠŠæ‰€æœ‰çš„æ•°æ®åŒæ­¥å®Œï¼Œæ‰€æœ‰æ›´æ–°ç¼“å­˜çš„é€»è¾‘ç…§æ ·æ‰§è¡Œï¼Œåªæ˜¯ä¸è§¦å‘å…¶ä»–æ“ä½œï¼Œè¿™æ ·åœ¨ä¸»å¤‡åˆ‡æ¢æ—¶å°±èƒ½çœæ‰ç½‘ç»œä¼ è¾“æ•°æ®çš„è€—æ—¶ï¼Œå½“ç„¶å¾—è¡¡é‡æ•°æ®é‡å¤§å°ï¼Œéšç€é›†ç¾¤è§„æ¨¡è¶Šæ¥è¶Šå¤§ï¼Œmasterä¸Šå„ç»„ä»¶å ç”¨çš„å†…å­˜åŠ¿å¿…è¶Šæ¥è¶Šå¤šï¼Œå°†æ¥å¯èƒ½å°±åˆä¼šé¢ä¸´å†…å­˜ä¸å¤Ÿç”¨çš„æƒ…å†µã€‚ ","date":"2020-04-01","objectID":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/:0:3","tags":["kubernetes"],"title":"Kube-controller-manageråŒæ­¥æ•°æ®æ…¢","uri":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/"},{"categories":["bugä¿®å¤","é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"æ„å¤–æ”¶è· æµ‹è¯•çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªbugï¼Œå­¤å„¿controllerrevisionæ— æ³•è¢«é¢†å…»ï¼Œä¸”ä¼šå¯¼è‡´statefulsetåŒæ­¥å¤±è´¥ï¼Œè¿™æ˜¯statefulset controllerçš„ä»£ç bugï¼Œprå·²åˆå…¥masterï¼Œéšç€v1.18ç‰ˆæœ¬å‘å¸ƒã€‚å…·ä½“å¯å‚è€ƒè¿™é‡Œ ","date":"2020-04-01","objectID":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/:0:4","tags":["kubernetes"],"title":"Kube-controller-manageråŒæ­¥æ•°æ®æ…¢","uri":"https://www.likakuli.com/posts/kubernetes-controllerrevisionhistory-bug/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"flannelå¯åŠ¨æç¤ºkey not found","date":"2019-12-16","objectID":"https://www.likakuli.com/posts/kubernetes-flannel/","tags":["kubernetes"],"title":"Flannel key not found","uri":"https://www.likakuli.com/posts/kubernetes-flannel/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"é—®é¢˜æè¿° etcd 3.3.1 flannel 0.11.0 flannelå¯åŠ¨æ—¶æŠ¥é”™ï¼Œå¯åŠ¨å‚æ•°å¦‚ä¸‹ ./flannel -etcd-keyfile=/etc/kubernetes/ssl/etcd-client-key.pem -etcd-cafile=/etc/kubernetes/ssl/ca.pem -etcd-endpoints=https://ip:port -etcd-certfile=/etc/kubernetes/ssl/etcd-client.pem -etcd-prefix=/coreos.com/network é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š E0908 20:27:17.671602 2331 main.go:382] Couldn't fetch network config: 100: Key not found (/coreos.com) [22] timed out E0908 20:27:18.680096 2331 main.go:382] Couldn't fetch network config: 100: Key not found (/coreos.com) [22] timed out E0908 20:27:19.688339 2331 main.go:382] Couldn't fetch network config: 100: Key not found (/coreos.com) [22] å…¶ä¸­coreos.comæ˜¯å¯åŠ¨flannelæ—¶-etcd-prefixå‚æ•°çš„é»˜è®¤å€¼ï¼ˆ/coreos.com/networkï¼‰ ","date":"2019-12-16","objectID":"https://www.likakuli.com/posts/kubernetes-flannel/:0:1","tags":["kubernetes"],"title":"Flannel key not found","uri":"https://www.likakuli.com/posts/kubernetes-flannel/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³åŠæ³• æŠ¥é”™æç¤ºå¾ˆæ˜æ˜¾ï¼Œæ²¡æœ‰å¯¹åº”çš„keyï¼Œäºæ˜¯æ‰§è¡Œetcdctlçš„å‘½ä»¤æ’å…¥å¯¹åº”çš„keyå¹¶è®¾ç½®å…¶å€¼ ETCDCTL_API=3 etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd-client.pem --key=/etc/kubernetes/ssl/etcd-client-key.pem --endpoints=https://ip:port put /coreos.com/network/config '{\"Network\":\"192.168.0.0/16\",\"SubnetLen\":24,\"Backend\":{\"Type\":\"vxlan\"}}' OK é‡æ–°å¯åŠ¨flannelï¼Œä¾æ—§æŠ¥é”™ï¼Œæ‰§è¡Œetcdctl getè·å–keyçš„ä¿¡æ¯ä¹Ÿå¯ä»¥æ­£å¸¸æ‹¿åˆ°ä¹‹å‰çš„è®¾ç½®ï¼Œä¸€è„¸æ‡µé€¼ã€‚ç½‘ä¸Šæœäº†ä¸‹è¯´æ˜¯etcd apiç‰ˆæœ¬çš„é—®é¢˜ï¼Œä¸æ˜¯å¾ˆæ˜ç™½ï¼Œç„¶åå»çœ‹ä»£ç ï¼Œå‘ç°flannelåœ¨ä½¿ç”¨etcdæ—¶åªæ”¯æŒetcd v2ç‰ˆæœ¬çš„apiï¼Œå› ä¸ºä¸Šçº¿æ·»åŠ key-valueæ—¶ä½¿ç”¨çš„æ˜¯v3ç‰ˆæœ¬çš„apiï¼Œæ‰€ä»¥å¯¼è‡´è™½ç„¶æ·»åŠ æˆåŠŸäº†ï¼Œä½†æ˜¯ç”¨v2è·å–çš„æ—¶å€™è¿˜æ˜¯å¤±è´¥ï¼Œè§£å†³åŠæ³•å°±æ˜¯ç”¨v2ç‰ˆæœ¬çš„apiæ·»åŠ ä¸€éå³å¯ etcdctl --cacert=/etc/kubernetes/ssl/ca.pem --cert=/etc/kubernetes/ssl/etcd-client.pem --key=/etc/kubernetes/ssl/etcd-client-key.pem --endpoints=https://ip:port set /coreos.com/network/config '{\"Network\":\"192.168.0.0/16\",\"SubnetLen\":24,\"Backend\":{\"Type\":\"vxlan\"}}' åŒºåˆ«å°±æ˜¯å»æ‰è®¾ç½®v3çš„ç¯å¢ƒå˜é‡ï¼Œputæ”¹ä¸ºsetï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨masteræœ€æ–°ä»£ç ä¸­ï¼Œä¸è®¾ç½®ETCDCTL_APIå°±é»˜è®¤ç”¨v3ç‰ˆæœ¬çš„apiï¼Œåç»­ä½¿ç”¨æ—¶è¿˜éœ€è¦å…·ä½“ç‰ˆæœ¬å…·ä½“å¯¹å¾…ã€‚ ","date":"2019-12-16","objectID":"https://www.likakuli.com/posts/kubernetes-flannel/:0:2","tags":["kubernetes"],"title":"Flannel key not found","uri":"https://www.likakuli.com/posts/kubernetes-flannel/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ”¶è· etcdä¸åŒç‰ˆæœ¬çš„apiå¯¹åº”çš„url pathçš„prefixä¸åŒï¼Œv2å‰ç¼€ä¸º/v2/keysï¼Œv3å‰ç¼€ä¸º/v3[alpha|beta]/kvï¼Œç”¨æ³•ä¹Ÿä¸åŒï¼Œå…·ä½“å¯ä»¥å‚è€ƒå®˜ç½‘APIè¯´æ˜ã€‚å¹³æ—¶ç›´æ¥ä½¿ç”¨clientåŒ…æ—¶è¿™äº›ä¿¡æ¯éƒ½ä¼šå¿½ç•¥æ‰ï¼Œå°è£…çš„å¤ªå¥½äº†ä¼šä½¿ä½¿ç”¨è€…å˜å‚»ï¼Œè¿˜æ˜¯æœ‰å¿…è¦çœ‹çœ‹æºç æ˜¯æ€ä¹ˆå®ç°çš„ã€‚ ","date":"2019-12-16","objectID":"https://www.likakuli.com/posts/kubernetes-flannel/:0:3","tags":["kubernetes"],"title":"Flannel key not found","uri":"https://www.likakuli.com/posts/kubernetes-flannel/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ çº¿ä¸Šmasterçš„apiserverç»„ä»¶å†…å­˜æŠ¥è­¦ï¼Œå†…å­˜ä½¿ç”¨é‡æŒç»­å¢é•¿ï¼Œç›‘æ§å¦‚ä¸‹ ","date":"2019-12-06","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/:0:1","tags":["kubernetes"],"title":"Kube-apiserver goroutine leak","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥è¿‡ç¨‹ ä»ç›‘æ§ä¸Šçœ‹å’Œå¦å¤–ä¸€ä¸ªç¨‹åºï¼ˆç®¡ç†å‘˜å¹³å°ï¼‰çš„å†…å­˜ä½¿ç”¨æƒ…å†µå»åˆï¼Œä½¿ç”¨ç‡é™ä¸‹æ¥æ˜¯å› ä¸ºé‡å¯äº†apiserverå’Œç®¡ç†å‘˜å¹³å°ï¼Œä¸”é—®é¢˜åªå‡ºç°åœ¨æœ€è¿‘ä¸¤å¤©çš„æ™šä¸Šï¼Œç®¡ç†å‘˜å¹³å°ä¸­æœ‰ä¸€æ®µé€»è¾‘æ˜¯å®šæ—¶å…¨é‡æ‹‰å–é›†ç¾¤æ•°æ®ï¼ˆè®¾è®¡ä¸åˆç†ï¼Œåç»­éœ€è¦æ”¹ï¼‰ï¼Œç®¡ç†å‘˜å¹³å°çš„æ—¥å¿—é‡Œæ˜¾ç¤ºæ‹‰å–æ•°æ®è¶…æ—¶ï¼ŒåŸºæœ¬çŒœæµ‹å’Œç®¡ç†å‘˜å¹³å°è°ƒç”¨k8s apiä¸åˆç†æœ‰å…³ï¼Œä¸”k8s apiserveråº”è¯¥ä¹Ÿæœ‰bugï¼Œå¯¼è‡´å†…å­˜æ³„éœ²æˆ–è€…goroutineæ³„éœ²ã€‚ä½†æ˜¯æœ€è¿‘ä»£ç éƒ½æ²¡åŠ¨è¿‡ï¼Œä¸ºå•¥ä¹‹å‰æ²¡äº‹å‘¢ï¼Œåè´Ÿè´£ç®¡ç†å‘˜å¹³å°çš„åŒäº‹è¯´è¿‘ä¸¤å¤©ç¾ä¸œä¸“çº¿æœ‰é—®é¢˜ï¼Œå»¶è¿Ÿæ˜¯ä¹‹å‰çš„3å€ï¼Œè€Œä¸”å‡ºç°é—®é¢˜çš„æ—¶é—´æ­£å¥½åŒ¹é…ï¼Œé‚£æ¥ä¸‹æ¥å°±æŸ¥ä¸€ä¸‹å…·ä½“åŸå› ã€‚ æŸ¥çœ‹apiserveræ—¥å¿— apiserveré”™è¯¯æ—¥å¿—é‡Œæœ‰å¤§é‡çš„ä¸Šè¿°æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯apiserverå› ä¸ºå“åº”è¶…æ—¶è§¦å‘çš„ï¼Œé‡Œé¢ä¹Ÿæœ‰è¯¦ç»†çš„å‡½æ•°è°ƒç”¨å †æ ˆä¿¡æ¯ï¼Œä¹Ÿæœ‰ipçš„ä¿¡æ¯ï¼Œæ­£å¥½å¯¹åº”äº†masterå’Œç®¡ç†å‘˜å¹³å°çš„åœ°å€ï¼Œé€šè¿‡pprofä¹Ÿå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„goroutineä½¿ç”¨é‡ä¸€ç›´åœ¨å¢åŠ ï¼Œå·²45000+ï¼Œç¡®è®¤æ˜¯äº§ç”Ÿäº†goroutineæ³„éœ²ã€‚ä¸‹å›¾ä¸ºpprof treeçœ‹åˆ°çš„éƒ¨åˆ†å†…å®¹ï¼Œé‡Œé¢æ˜¾ç¤ºäº†å ç”¨é‡æœ€å¤šçš„åœ°æ–¹ åŒæ—¶åœ¨æµè§ˆå™¨ä¸­è®¿é—®http://ip:port/debug/pprof/goroutine å¯ä»¥çœ‹åˆ°å…·ä½“goroutineæ•°é‡å’Œæ‰§è¡Œå‡½æ•°çš„è¡Œå·ï¼Œæ­¤å¤„å¿˜è®°æˆªå›¾äº†ï¼Œä¸è¿‡å’Œä¸Šé¢çš„ä¿¡æ¯å»åˆï¼Œä¸”æ›´ä¿¡æ¯å› ä¸ºæºå¸¦äº†è¡Œå·çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯å¦‚ä¸‹ä»£ç å‡ºçš„é—®é¢˜ï¼ˆä»£ç ç‰ˆæœ¬1.12.4ï¼‰ // k8s.io/kubernetes/vendor/k8s.io/apiserver/pkg/server/filters/timeout.go func (t *timeoutHandler) ServeHTTP(w http.ResponseWriter, r *http.Request) { r, after, postTimeoutFn, err := t.timeout(r) if after == nil { t.handler.ServeHTTP(w, r) return } errCh := make(chan interface{}) tw := newTimeoutWriter(w) go func() { defer func() { err := recover() if err != nil { const size = 64 \u003c\u003c 10 buf := make([]byte, size) buf = buf[:runtime.Stack(buf, false)] err = fmt.Sprintf(\"%v\\n%s\", err, buf) } errCh \u003c- err }() t.handler.ServeHTTP(tw, r) }() select { case err := \u003c-errCh: if err != nil { panic(err) } return case \u003c-after: postTimeoutFn() tw.timeout(err) } } æ³„éœ²çš„goroutineå°±æ˜¯ç¬¬11è¡Œå¤„çš„ï¼Œç®€å•è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„é€»è¾‘ï¼šç”Ÿæˆä¸€ä¸ªtimeoutçš„handlerï¼Œèµ·ä¸€ä¸ªæ–°çš„goroutineè¿›è¡Œåç»­handlerçš„å¤„ç†ï¼Œå½“å‰goroutineä¸­ä½¿ç”¨selectè¿›è¡Œç­‰å¾…ï¼Œåˆ†ä¸ºä¸¤ç§caseï¼Œåˆ†åˆ«å¯¹åº”æ–°goroutineä¸­panicçš„æƒ…å†µå’Œæ•´ä¸ªå‡½æ•°è¶…æ—¶çš„æƒ…å†µï¼Œåˆ†åˆ«çœ‹ä¸¤ä¸ªcaseçš„å†…å®¹ ç¬¬25è¡Œï¼šä»errChè¯»å–æ•°æ®ï¼Œå…¶ä¸­errChä¸­çš„æ•°æ®æ˜¯åœ¨æ–°çš„goroutineä¸­äº§ç”Ÿçš„ï¼Œå¯¹åº”åˆ°å®é™…æƒ…å†µå°±æ˜¯22è¡Œçš„ä»£ç å‡ºå‘ç”Ÿäº†panicï¼Œåœ¨13è¡Œæ•è·åˆ°äº†ï¼Œæœ€ååœ¨20è¡ŒæŠŠerrå†™å…¥åˆ°errChä¸­ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸ªerrChæ˜¯ä¸ªæ— ç¼“å­˜çš„ï¼› ç¬¬30è¡Œï¼šafteræ˜¯è°ƒç”¨time.Afteråäº§ç”Ÿçš„ä¸€ä¸ªchanï¼Œåœ¨è¶…æ—¶åå¯ä»¥ä»è¿™ä¸ªchanä¸­è·å–åˆ°æ•°æ®ï¼Œç„¶ååœ¨32è¡Œå¤„ä¼šè°ƒç”¨tw.timeoutå‡½æ•°ï¼Œé‡Œé¢ä¼šè§¦å‘panicï¼› é‚£ä¸ºä»€ä¹ˆ11è¡Œå¤„çš„goroutineæ³„éœ²äº†å‘¢ï¼Ÿ é—®é¢˜å°±å‡ºç°åœ¨äº†åˆšæ‰æåˆ°çš„æ— ç¼“å†²çš„errChä¸Šï¼Œå› ä¸ºè§¦å‘äº†timeoutï¼Œä»£ç é€»è¾‘æ²¡æœ‰æ‰§è¡Œåˆ°25è¡Œï¼Œç›´æ¥å»äº†30è¡Œï¼Œç„¶åæ•´ä¸ªå‡½æ•°panicï¼Œå¯¼è‡´20è¡Œæ‰§è¡Œçš„æ—¶å€™å¡ä½äº†ï¼Œä»è€Œé˜»æ­¢äº†11è¡Œå‡ºçš„æ–°çš„goroutineçš„é€€å‡ºï¼Œæ¯æœ‰ä¸€ä¸ªtimeoutçš„è¯·æ±‚ï¼Œè¿™é‡Œå°±ä¼šæ³„éœ²ä¸€ä¸ªgoroutineï¼Œä»è€Œå¯¼è‡´å†…å­˜éšä¹‹æ³„éœ²ï¼Œcpuçš„è¯å…¶å®ä¸å—ä»€ä¹ˆå½±å“ï¼Œå› ä¸ºæ³„éœ²çš„goroutineå·²ç»æ‰§è¡Œè¿‡goparkï¼Œä¸æ˜¯runnableçŠ¶æ€çš„ã€‚ ","date":"2019-12-06","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/:0:2","tags":["kubernetes"],"title":"Kube-apiserver goroutine leak","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ å°è±¡ä¸­è®°å¾—ä¹‹å‰çœ‹k8sç‰ˆæœ¬å‡çº§çš„release-noteæ—¶æœ‰æåˆ°è¿‡ä¿®å¤apiserver leakå­—æ ·çš„ä¿¡æ¯ï¼Œç„¶åå°±å»å®˜æ–¹é¡¹ç›®ä¸­æŸ¥ï¼Œç»“æœæ²¡æ‰¾åˆ°ï¼Œç„¶åç›´æ¥å»çœ‹äº†å¯¹åº”æ–‡ä»¶çš„æœ€æ–°ç‰ˆæœ¬ä»£ç ï¼Œçœ‹historyï¼Œç»ˆäºæ‰¾åˆ°äº†ç›¸å…³çš„ä¿®å¤çš„commitï¼Œåˆå…¥1.17ã€‚ case \u003c-after: defer func() { // resultCh needs to have a reader, since the function doing // the work needs to send to it. This is defer'd to ensure it runs // ever if the post timeout work itself panics. go func() { res := \u003c-resultCh if res != nil { switch t := res.(type) { case error: utilruntime.HandleError(t) default: utilruntime.HandleError(fmt.Errorf(\"%v\", res)) } } }() }() postTimeoutFn() tw.timeout(err) } å¯ä»¥çœ‹åˆ°å…¶æ€æƒ³å°±æ˜¯åœ¨å¤–å±‚panicåï¼Œæ–°åŠ ä¸€ä¸ªdefer funcç”¨æ¥ä»ä¹‹å‰çš„errChï¼ˆæ–°ç‰ˆæ”¹åä¸ºresultChï¼‰æ¥æ”¶æ•°æ®ï¼Œä»è€Œé¿å…ä¹‹å‰çš„é—®é¢˜ã€‚ ","date":"2019-12-06","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/:0:3","tags":["kubernetes"],"title":"Kube-apiserver goroutine leak","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ é€šè¿‡ä¸Šé¢çš„ä¿®æ”¹ï¼Œç¡®å®å¯ä»¥è§£å†³goroutineæ³„éœ²çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨ä¸€ä¸ªéšæ‚£ï¼šç¬¬6è¡Œæ–°åŠ çš„goroutineä¼šä»resultChè¯»æ•°æ®ï¼Œå› ä¸ºåœ¨ä¸Šä¸€æ®µä»£ç å¤„æœ‰ä¸ªå¤„ç†ï¼Œæ— è®ºæ˜¯å¦panicï¼Œéƒ½ä¼šå¾€errChï¼ˆresultChï¼‰å†™å…¥errï¼Œä»è€Œå¯ä»¥é¿å…åŒæ—¶æ³„éœ²ä¸¤ä¸ªgoroutineçš„æƒ…å†µï¼Œä½†æ˜¯å¦‚æœçŸ­æ—¶é—´å†…å¤§é‡è¯·æ±‚åˆ°æ¥ä¸”å¤„ç†æ—¶é—´éƒ½æ¯”è¾ƒæ…¢ç›´è‡³è¶…æ—¶ï¼Œè™½ç„¶goroutineä¸ä¼šæ³„éœ²ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿä¸¤å€äºä¹‹å‰çš„goroutineï¼Œå¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…é€ æˆå†…å­˜æš´æ¶¨ï¼Œä¹Ÿç®—æ˜¯ä¸€ä¸ªç¨³å®šæ€§é£é™©ï¼Œéœ€è¦åˆç†è®¾ç½®é™æµæ¥é™ä½é£é™©ã€‚ ","date":"2019-12-06","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/:0:4","tags":["kubernetes"],"title":"Kube-apiserver goroutine leak","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-goroutine-leak/"},{"categories":["ç®—æ³•"],"content":"èƒŒåŒ…é—®é¢˜","date":"2019-11-07","objectID":"https://www.likakuli.com/posts/backpack/","tags":["åŠ¨æ€è§„åˆ’"],"title":"èƒŒåŒ…é—®é¢˜golang","uri":"https://www.likakuli.com/posts/backpack/"},{"categories":["ç®—æ³•"],"content":"æœ€è¿‘çš„å·¥ä½œéƒ½è·Ÿé›†ç¾¤è°ƒåº¦æœ‰å…³ï¼Œä¸€ç›´åœ¨ä¸ºäº†æ»¡è¶³ç”¨æˆ·éœ€æ±‚æ·»åŠ å„ç§è°ƒåº¦ç­–ç•¥ï¼Œç°åœ¨ä¹Ÿæš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼ŒæŠ½æ—¶é—´æ€»ç»“æ€è€ƒäº†ä¹‹å‰çš„å·¥ä½œï¼Œè°ƒåº¦æœ¬è´¨ä¸Šå°±æ˜¯èƒŒåŒ…é—®é¢˜ï¼Œä½†æ˜¯ç›¸å½“å¤æ‚ï¼Œæ¶‰åŠåˆ°å¤šç»´å¤šé‡èƒŒåŒ…ã€ç»„åˆèƒŒåŒ…ã€ä¾èµ–èƒŒåŒ…ç­‰ã€‚åˆé‡æ–°å¼€å§‹å­¦ä¹ èƒŒåŒ…é—®é¢˜ï¼Œè¿™é‡Œå…ˆä»ç®€å•çš„01èƒŒåŒ…å¼€å§‹è®²ï¼Œåœ¨ç½‘ä¸Šä¹Ÿæ‰¾åˆ°äº†å¾ˆå¤šç›¸å…³çš„æ–‡ç« ï¼Œä½†æ˜¯å¾ˆé—æ†¾ï¼Œæˆ‘æ‰¾åˆ°çš„å¾ˆå¤šå…³äºç”¨golangå®ç°èƒŒåŒ…çš„æ–‡ç« ä¸­ç»™å‡ºçš„ä»£ç éƒ½æ˜¯æœ‰é—®é¢˜çš„ï¼Œåå†³å®šè‡ªå·±å†™å‡ºæ¥ï¼Œä¹Ÿå¸Œæœ›å¤§å®¶ä¸€èµ·æ€è€ƒï¼Œä¸è¦è¢«è¯¯å¯¼äº†ã€‚ ","date":"2019-11-07","objectID":"https://www.likakuli.com/posts/backpack/:0:0","tags":["åŠ¨æ€è§„åˆ’"],"title":"èƒŒåŒ…é—®é¢˜golang","uri":"https://www.likakuli.com/posts/backpack/"},{"categories":["ç®—æ³•"],"content":"é¢˜ç›® æœ‰æœ‰Nä»¶ç‰©å“å’Œä¸€ä¸ªå®¹é‡ä¸ºVçš„èƒŒåŒ…ã€‚ç¬¬iä»¶ç‰©å“çš„è´¹ç”¨æ˜¯c[i]ï¼Œä»·å€¼æ˜¯w[i]ã€‚æ±‚è§£å°†å“ªäº›ç‰©å“è£…å…¥èƒŒåŒ…å¯ä½¿ä»·å€¼æ€»å’Œæœ€å¤§ã€‚ ","date":"2019-11-07","objectID":"https://www.likakuli.com/posts/backpack/:0:1","tags":["åŠ¨æ€è§„åˆ’"],"title":"èƒŒåŒ…é—®é¢˜golang","uri":"https://www.likakuli.com/posts/backpack/"},{"categories":["ç®—æ³•"],"content":"åŸºæœ¬æ€æƒ³ è¿™æ˜¯æœ€åŸºç¡€çš„èƒŒåŒ…é—®é¢˜ï¼Œç‰¹ç‚¹æ˜¯ï¼šæ¯ç§ç‰©å“ä»…æœ‰ä¸€ä»¶ï¼Œå¯ä»¥é€‰æ‹©æ”¾æˆ–ä¸æ”¾ã€‚ ç”¨å­é—®é¢˜å®šä¹‰çŠ¶æ€ï¼šå³f[i][v]è¡¨ç¤ºå‰iä»¶ç‰©å“æ°æ”¾å…¥ä¸€ä¸ªå®¹é‡ä¸ºvçš„èƒŒåŒ…å¯ä»¥è·å¾—çš„æœ€å¤§ä»·å€¼ã€‚åˆ™å…¶çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¾¿æ˜¯ï¼š f[i][v]=max{f[i-1][v],f[i-1][v-c[i]]+w[i]} è¿™ä¸ªæ–¹ç¨‹éå¸¸é‡è¦ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰è·ŸèƒŒåŒ…ç›¸å…³çš„é—®é¢˜çš„æ–¹ç¨‹éƒ½æ˜¯ç”±å®ƒè¡ç”Ÿå‡ºæ¥çš„ã€‚æ‰€ä»¥æœ‰å¿…è¦å°†å®ƒè¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼šâ€œå°†å‰iä»¶ç‰©å“æ”¾å…¥å®¹é‡ä¸ºvçš„èƒŒåŒ…ä¸­â€è¿™ä¸ªå­é—®é¢˜ï¼Œè‹¥åªè€ƒè™‘ç¬¬iä»¶ç‰©å“çš„ç­–ç•¥ï¼ˆæ”¾æˆ–ä¸æ”¾ï¼‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ªåªç‰µæ‰¯å‰i-1ä»¶ç‰©å“çš„é—®é¢˜ã€‚å¦‚æœä¸æ”¾ç¬¬iä»¶ç‰©å“ï¼Œé‚£ä¹ˆé—®é¢˜å°±è½¬åŒ–ä¸ºâ€œå‰i-1ä»¶ç‰©å“æ”¾å…¥å®¹é‡ä¸ºvçš„èƒŒåŒ…ä¸­â€ï¼Œä»·å€¼ä¸ºf[i-1][v]ï¼›å¦‚æœæ”¾ç¬¬iä»¶ç‰©å“ï¼Œé‚£ä¹ˆé—®é¢˜å°±è½¬åŒ–ä¸ºâ€œå‰i-1ä»¶ç‰©å“æ”¾å…¥å‰©ä¸‹çš„å®¹é‡ä¸ºv-c[i]çš„èƒŒåŒ…ä¸­â€ï¼Œæ­¤æ—¶èƒ½è·å¾—çš„æœ€å¤§ä»·å€¼å°±æ˜¯f[i-1][v-c[i]]å†åŠ ä¸Šé€šè¿‡æ”¾å…¥ç¬¬iä»¶ç‰©å“è·å¾—çš„ä»·å€¼w[i]ã€‚ ","date":"2019-11-07","objectID":"https://www.likakuli.com/posts/backpack/:0:2","tags":["åŠ¨æ€è§„åˆ’"],"title":"èƒŒåŒ…é—®é¢˜golang","uri":"https://www.likakuli.com/posts/backpack/"},{"categories":["ç®—æ³•"],"content":"ä»£ç å®ç° æµ‹è¯•ç”¨ä¾‹ func main() { v := []int{7, 5, 8} //ç‰©å“å¤§å° w := []int{2, 3, 4} //ç‰©å“ä»·å€¼ goods := [][]int{ []int{7, 2}, []int{5, 3}, []int{8, 4}, } fmt.Println(zeroonepack1(v, w, 5)) fmt.Println(zeroonepack(goods, 5)) fmt.Println(zeroonepack2(v, w, 5)) } // ç»“æœåº”è¯¥éƒ½æ˜¯3æ‰å¯¹ äºŒç»´æ•°ç»„å®ç° // 0 æ¶ˆè€— 1 ä»·å€¼ // i ç‰©å“æ•° j å®¹é‡ // dp[i][j] = max(dp[i-1][j], goods[i][1] + dp[i-1][j-goods[i][0]]) func zeroonepack(goods [][]int, capacity int) int { num := len(goods) dp := make([][]int, num) for i := 0; i \u003c num; i++ { dp[i] = make([]int, capacity+1) } for i := goods[0][0]; i \u003c capacity+1; i++ { dp[0][i] = goods[0][1] } for i := 1; i \u003c num; i++ { // jä¸èƒ½ç›´æ¥ä»good[i][0]å¼€å§‹ for j := 0; j \u003c= capacity; j++ { // æ­¤if elseåˆ¤æ–­å¿…é¡»è¦æœ‰ if j \u003e= goods[i][0] { dp[i][j] = max(dp[i-1][j], dp[i-1][j-goods[i][0]]+goods[i][1]) } else { dp[i][j] = dp[i-1][j] } } } return dp[num-1][capacity] } func zeroonepack1(weight []int, value []int, capacity int) int { num := len(weight) dp := make([][]int, num) for i := 0; i \u003c num; i++ { dp[i] = make([]int, capacity+1) } for i := weight[0]; i \u003c= capacity; i++ { dp[0][i] = value[0] } for i := 1; i \u003c num; i++ { for j := 0; j \u003c= capacity; j++ { if j \u003e= weight[i] { dp[i][j] = max(dp[i-1][j], dp[i-1][j-weight[i]]+value[i]) } else { dp[i][j] = dp[i-1][j] } } } return dp[num-1][capacity] } ä¸Šé¢éƒ½æ˜¯äºŒç»´æ•°ç»„çš„å®ç°ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯O(VN)ï¼ŒåŒºåˆ«å°±æ˜¯ä¼ å…¥çš„å‚æ•°ä¸åŒï¼Œç”¨äºŒç»´æ•°ç»„è¡¨ç¤ºç‰©å“ï¼Œæˆ–è€…ç”¨ä¸¤ä¸ªä¸€ç»´æ•°ç»„åˆ†åˆ«è¡¨ç¤ºç‰©å“çš„æ¶ˆè€—ï¼ˆé‡é‡æˆ–ä½“ç§¯ç­‰ï¼‰å’Œä»·å€¼ï¼Œç‰¹åˆ«æ³¨æ„ä¸Šé¢çš„æ³¨é‡Šï¼Œå¾ˆå¤šgolangç‰ˆæœ¬çš„ä»£ç å°±æ˜¯é‚£é‡Œå‡ºçš„é—®é¢˜ï¼Œé”™è¯¯ç‰ˆæœ¬çš„ä»£ç å‚è€ƒè¿™é‡Œ ä¸€ç»´æ•°ç»„å®ç° ä»¥ä¸Šæ–¹æ³•çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦å‡ä¸ºO(VN)ï¼Œå…¶ä¸­æ—¶é—´å¤æ‚åº¦åº”è¯¥å·²ç»ä¸èƒ½å†ä¼˜åŒ–äº†ï¼Œä½†ç©ºé—´å¤æ‚åº¦å´å¯ä»¥ä¼˜åŒ–åˆ°Oã€‚ å…ˆè€ƒè™‘ä¸Šé¢è®²çš„åŸºæœ¬æ€è·¯å¦‚ä½•å®ç°ï¼Œè‚¯å®šæ˜¯æœ‰ä¸€ä¸ªä¸»å¾ªç¯i=1..Nï¼Œæ¯æ¬¡ç®—å‡ºæ¥äºŒç»´æ•°ç»„f[i][0..V]çš„æ‰€æœ‰å€¼ã€‚é‚£ä¹ˆï¼Œå¦‚æœåªç”¨ä¸€ä¸ªæ•°ç»„f[0..V]ï¼Œèƒ½ä¸èƒ½ä¿è¯ç¬¬iæ¬¡å¾ªç¯ç»“æŸåf[v]ä¸­è¡¨ç¤ºçš„å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„çŠ¶æ€f[i][v]å‘¢ï¼Ÿf[i][v]æ˜¯ç”±f[i-1][v]å’Œf[i-1][v-c[i]]ä¸¤ä¸ªå­é—®é¢˜é€’æ¨è€Œæ¥ï¼Œèƒ½å¦ä¿è¯åœ¨æ¨f[i][v]æ—¶ï¼ˆä¹Ÿå³åœ¨ç¬¬iæ¬¡ä¸»å¾ªç¯ä¸­æ¨f[v]æ—¶ï¼‰èƒ½å¤Ÿå¾—åˆ°f[i-1][v]å’Œf[i-1][v-c[i]]çš„å€¼å‘¢ï¼Ÿäº‹å®ä¸Šï¼Œè¿™è¦æ±‚åœ¨æ¯æ¬¡ä¸»å¾ªç¯ä¸­æˆ‘ä»¬ä»¥v=V..0çš„é¡ºåºæ¨f[v]ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¨f[v]æ—¶f[v-c[i]]ä¿å­˜çš„æ˜¯çŠ¶æ€f[i-1][v-c[i]]çš„å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š func zeroonepack2(weight []int, value []int, capacity int) int { num := len(weight) dp := make([]int, capacity+1) for i := weight[0]; i \u003c capacity; i++ { dp[i] = value[0] } for i := 1; i \u003c num; i++ { for j := capacity; j \u003e= 0; j-- { if j \u003e= weight[i] { dp[j] = max(dp[j], dp[j-weight[i]]+value[i]) } } } return dp[capacity] } å…¶ä¸­çš„f[v]=max{f[v],f[v-c[i]]}ä¸€å¥æ°å°±ç›¸å½“äºæˆ‘ä»¬çš„è½¬ç§»æ–¹ç¨‹f[i][v]=max{f[i-1][v],f[i-1][v-c[i]]}ï¼Œå› ä¸ºç°åœ¨çš„f[v-c[i]]å°±ç›¸å½“äºåŸæ¥çš„f[i-1][v-c[i]]ã€‚å¦‚æœå°†vçš„å¾ªç¯é¡ºåºä»ä¸Šé¢çš„é€†åºæ”¹æˆé¡ºåºçš„è¯ï¼Œé‚£ä¹ˆåˆ™æˆäº†f[i][v]ç”±f[i][v-c[i]]æ¨çŸ¥ï¼Œä¸æœ¬é¢˜æ„ä¸ç¬¦ï¼Œä½†å®ƒå´æ˜¯å¦ä¸€ä¸ªé‡è¦çš„èƒŒåŒ…é—®é¢˜æœ€ç®€æ·çš„è§£å†³æ–¹æ¡ˆï¼Œæ•…å­¦ä¹ åªç”¨ä¸€ç»´æ•°ç»„è§£01èƒŒåŒ…é—®é¢˜æ˜¯ååˆ†å¿…è¦çš„ã€‚ ","date":"2019-11-07","objectID":"https://www.likakuli.com/posts/backpack/:0:3","tags":["åŠ¨æ€è§„åˆ’"],"title":"èƒŒåŒ…é—®é¢˜golang","uri":"https://www.likakuli.com/posts/backpack/"},{"categories":["æºç åˆ†æ"],"content":"kube-apiserver watchå®ç°","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/","tags":["kubernetes"],"title":"Kube-apiserver watchå®ç°","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/"},{"categories":["æºç åˆ†æ"],"content":"List-Watchæ˜¯kubernetesçš„æ ¸å¿ƒæœºåˆ¶ã€‚ç»„ä»¶kubeletã€kube-controller-managerã€kube-scheduleréœ€è¦ç›‘æ§å„ç§èµ„æº(podã€serviceç­‰)çš„å˜åŒ–ï¼Œå½“è¿™äº›å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶(addã€deleteã€update)ï¼Œkube-apiserverä¼šä¸»åŠ¨é€šçŸ¥è¿™äº›ç»„ä»¶ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼ä¸€ä¸ªå‘å¸ƒ-è®¢é˜…ç³»ç»Ÿã€‚æœ¬æ–‡ç« å°†ä»ä»£ç è§’åº¦æ¢ç©¶ä¸€ä¸‹list-watchçš„å®ç°æ–¹å¼ã€‚ è½¬è½½è‡ªhttps://zhuanlan.zhihu.com/p/33335726ï¼Œæœ‰ä¿®æ”¹ ","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/:0:0","tags":["kubernetes"],"title":"Kube-apiserver watchå®ç°","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/"},{"categories":["æºç åˆ†æ"],"content":"**ç¬¬ä¸€éƒ¨åˆ†ï¼š**kube-apiserverå¯¹etcdçš„List-watchæœºåˆ¶ æµç¨‹ç¤ºæ„å›¾ æ„å»ºPodStorage kube-apiserveré’ˆå¯¹æ¯ä¸€ç±»èµ„æº(podã€serviceã€endpointã€replication controllerã€depolyments)éƒ½ä¼šæ„å»ºStorageå¯¹è±¡ï¼Œå¦‚:PodStorageï¼› PodStorage.Pod.Storeå°è£…äº†å¯¹etcdçš„æ“ä½œï¼› store.CompleteWithOptionsä¼šè°ƒç”¨etcdOptions.GetRESTOptionsï¼Œæ­¤æ–¹æ³•å°† è°ƒç”¨generic.UndecoratedStorageåˆ›å»ºæ— cacheçš„Storeï¼› æˆ–è€…è°ƒç”¨genericregistry.StorageWithCacheråˆ›å»ºå¸¦Cacheçš„Storeï¼› StorageWithCacher è°ƒç”¨NewCacherFromConfigï¼Œå°†åˆ›å»ºCacherå¯¹è±¡ï¼› åˆ›å»ºCacher é¦–å…ˆï¼Œåˆ›å»ºwatchCacheå¯¹è±¡å’ŒcacheListerWatcherå¯¹è±¡ï¼ŒcacheListWatcherå¯¹è±¡æ˜¯ListerWatcheræ¥å£å®ç°ï¼Œå®ç°äº†List()å’ŒWatch()æ–¹æ³•ï¼› æ„å»ºCacherå¯¹è±¡ï¼Œä¸»è¦çš„æ•°æ®æˆå‘˜ï¼šwatchCacheã€reflectorã€watchersåŠincoming channelï¼› watchCacheæ˜¯ä¸€ä¸ªcacheï¼Œç”¨æ¥å­˜å‚¨apiserverä»etcdé‚£é‡Œwatchåˆ°çš„å¯¹è±¡ï¼› watchersæ˜¯ä¸€ä¸ªmapï¼Œmapçš„å€¼ç±»å‹ä¸ºcacheWatcherï¼Œå½“kubeletã€kube-scheduleréœ€è¦watchæŸç±»èµ„æºæ—¶ï¼Œä»–ä»¬ä¼šå‘kube-apiserverå‘èµ·watchè¯·æ±‚ï¼Œkube-apiserverå°±ä¼šç”Ÿæˆä¸€ä¸ªcacheWatcherï¼ŒcacheWatcherè´Ÿè´£å°†watchçš„èµ„æºé€šè¿‡httpä»apiserverä¼ é€’åˆ°kubeletã€kube-schedulerï¼› Reflectorå¯¹è±¡ï¼Œä¸»è¦æ•°æ®æˆå‘˜ï¼šListerWatcherï¼ŒListerWatcheræ˜¯æ¥å£å¯¹è±¡ï¼ŒåŒ…æ‹¬æ–¹æ³•List()å’ŒWatch()ï¼›listerWatcheråŒ…è£…äº†Storageï¼Œä¸»è¦æ˜¯å°†watchåˆ°çš„å¯¹è±¡å­˜åˆ°watchCacheä¸­ï¼› incoming channelæ¥æ”¶watchCacheEventï¼› åç¨‹è°ƒç”¨cacher.dispatchEventsï¼ŒwatchCacheå°†incoming channelæ¥æ”¶watchCacheEventæ·»åŠ åˆ°watchersçš„inputChanä¸­ï¼› åç¨‹è°ƒç”¨cacher.startCaching; StartCaching æ‰§è¡ŒcacheListerWatcherçš„Listæ–¹æ³•å’ŒWatchæ–¹æ³•ï¼› è°ƒç”¨reflectorçš„watchHandleræ–¹æ³•ï¼› cacheListWatcher.Listï¼cacheListWatcher.Watch Listæ–¹æ³•å°†è°ƒç”¨storage.Listæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯etcdHelper.Listæ–¹æ³•ï¼› Watchæ–¹æ³•å°†è°ƒç”¨storage.watchæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯etcdHelper.WatchListæ–¹æ³•ï¼› etcdHelper.Listï¼etcdHelper.Watch etcdHelperå¯¹è±¡æ˜¯Storageæ¥å£å¯¹è±¡çš„å®ç°; etcdHelperçš„Listæ–¹æ³•ï¼š è·å–etcdçš„å¯¹è±¡ï¼ˆåŒ…æ‹¬resourceVersionä¿¡æ¯ï¼‰ï¼› etcdHelperçš„WatchListæ–¹æ³•ï¼š åˆ›å»ºetcdWatcherï¼› etcdWatcherå¯¹è±¡ï¼Œå®ç°äº†Watchæ¥å£ï¼› etcdWatcherå¯¹è±¡ï¼Œä¸»è¦çš„æ•°æ®æˆå‘˜æ˜¯etcdIncoming channelå’Œoutgoing channelï¼› åç¨‹æ‰§è¡ŒetcdWatcher.translateï¼› æœ€åï¼Œåç¨‹è¿è¡ŒetcdWatcher.etcdWatchï¼› etcdWatcher.etcdWatch å¦‚æœresourceVersion==0, è¿è¡ŒetcdGetInitialWatchState(),è·å–æ‰€æœ‰çš„podsï¼Œå¹¶å°†ç»“æœè¾“å…¥åˆ°etcdIncoming channel; ä¹‹åï¼Œä¸åœçš„è°ƒç”¨watcher.Next()ï¼Œå¹¶å°†ç»“æœè¾“å…¥åˆ°etcdIncoming channel; etcdWatcher.translate è¯»å–etcdIncoming channelä¿¡æ¯ï¼› è°ƒç”¨etcdWatcher.sendResultè¿›è¡Œè½¬åŒ–; å‘é€åˆ°outgoing channelï¼› reflector.watchHandler è¯»å–outgoing channelä¿¡æ¯ï¼Œæ“ä½œwatchCacheï¼› æ“ä½œwatchCache å¤„ç†äº‹ä»¶watchCache.processEvent åˆ›å»ºwatchCacheEvent è°ƒç”¨watchCache.updateCacheï¼Œæ›´æ–°watchCache; åˆ°æ­¤åˆ†æå®Œkube-apiserverå¯¹etcdçš„watchæœºåˆ¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œkube-apiserverä¼šå‘å…¶ä»–ç»„ä»¶æä¾›watchæ¥å£ï¼Œä¸‹é¢å°†åˆ†ækube-apiserverçš„watch APIã€‚ ","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/:1:0","tags":["kubernetes"],"title":"Kube-apiserver watchå®ç°","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/"},{"categories":["æºç åˆ†æ"],"content":"ç¬¬äºŒéƒ¨åˆ†ï¼škube-apiserverçš„watch restful API kube-apiserveræä¾›watch restful APIç»™å…¶ä»–ç»„ä»¶(kubeletã€kube-controller-managerã€kube-schedulerã€kube-proxy)ã€‚watch restful APIçš„å¤„ç†æµç¨‹å’ŒPUTã€DELETEã€GETç­‰REST APIå¤„ç†æµç¨‹ç±»ä¼¼ã€‚ æµç¨‹ç¤ºæ„å›¾ registerResourceHandlers ListResource 1.è°ƒç”¨rw.watchæ–¹æ³•ï¼Œè¿™é‡Œå°†ä¼šè°ƒç”¨Store.watchï¼› 2.è°ƒç”¨serveWatchæ–¹æ³•ï¼› Store.watch è°ƒç”¨Storage.Watchæ–¹æ³•å’ŒStorage.WatchListæ–¹æ³•ï¼Œè¿™é‡Œå°†è°ƒç”¨Cacher.watchæ–¹æ³•å’ŒCacher.WatchListæ–¹æ³• Cacher.watch watchæ–¹æ³•ä¸­å°†è°ƒç”¨newCacheWatcherï¼› newCacheWatcheræ–¹æ³•ï¼š ç”Ÿæˆä¸€ä¸ªwatcherï¼Œå¹¶å°†watcheræ’å…¥åˆ°cacher.watchersä¸­ï¼› åç¨‹è°ƒç”¨cacheWatcher.processæ–¹æ³•ï¼Œæ­¤æ–¹æ³•å°†ä¼šæ“ä½œinput channelçš„æ¶ˆæ¯ï¼› æ“ä½œinput channel è¯»å–input channelçš„ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨sendWatchCacheEventæ–¹æ³•ï¼› sendWatchCacheEvent kube-apiserverçš„watchä¼šå¸¦è¿‡æ»¤åŠŸèƒ½ï¼› å¯¹watchCacheEventè¿›è¡ŒFilterï¼Œå‘é€åˆ°cacher.result channelä¸­ï¼› ","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/:2:0","tags":["kubernetes"],"title":"Kube-apiserver watchå®ç°","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-watch/"},{"categories":["é—®é¢˜æ’æŸ¥","bugä¿®å¤"],"content":"ç°è±¡ k8s masterè¿›è¡Œçº¿ä¸Šå‡çº§ï¼Œnotifieråˆ©ç”¨client-goæä¾›çš„informeræœºåˆ¶æ³¨å†Œäº†EndPointçš„Update Handlerï¼Œå½“kube-apiserveré‡å¯æ—¶è§¦å‘äº†å¤§é‡çš„updateäº‹ä»¶ï¼Œè§¦å‘ä¾èµ–çš„ç¬¬ä¸‰æ–¹æœåŠ¡é™æµã€‚ ","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/:0:1","tags":["kubernetes"],"title":"Kube-apiserveré‡å¯å¯¼è‡´äº§ç”Ÿå…¨é‡çš„update event","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/"},{"categories":["é—®é¢˜æ’æŸ¥","bugä¿®å¤"],"content":"åŸå› æ’æŸ¥ åœ¨æµ‹è¯•ç¯å¢ƒè¿›è¡Œäº†æµ‹è¯•ï¼Œå¹¶ä¸”åœ¨æ³¨å†Œupdateäº‹ä»¶å¤„ç†å‡½æ•°ä¸­è°ƒç”¨ reflect.DeepEqual(old, new) è¿›è¡Œäº†æ¯”è¾ƒï¼Œå‘ç°è¿”å›trueï¼Œå³oldä¸newå®Œå…¨ç›¸åŒå´äº§ç”Ÿäº†updateäº‹ä»¶ã€‚ æ¥ä¸‹æ¥å°±æ˜¯åˆ°äº‹ä»¶äº§ç”Ÿçš„åœ°æ–¹å»å¯»æ‰¾åŸå› ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯reflectçš„ListAndWatchï¼Œç›¸å½“äºå…ƒæ•°æ®çš„ç”Ÿäº§è€…ï¼Œå¦ä¸€ä¸ªæ˜¯sharedIndexedInformerçš„HandleDeltasï¼Œæ¶ˆè´¹å…ƒæ•°æ®å¹¶ç”Ÿæˆå¯¹åº”ç±»å‹çš„äº‹ä»¶åˆ†å‘ä¸‹å»ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«çœ‹ HandleDeltas ï¼ˆäº‹ä»¶æ¥æºï¼‰ func (s *sharedIndexInformer) HandleDeltas(obj interface{}) error { s.blockDeltas.Lock() defer s.blockDeltas.Unlock() // from oldest to newest for _, d := range obj.(Deltas) { switch d.Type { case Sync, Added, Updated: isSync := d.Type == Sync s.cacheMutationDetector.AddObject(d.Object) // é‡ç‚¹å…³æ³¨ if old, exists, err := s.indexer.Get(d.Object); err == nil \u0026\u0026 exists { if err := s.indexer.Update(d.Object); err != nil { return err } s.processor.distribute(updateNotification{oldObj: old, newObj: d.Object}, isSync) } else { if err := s.indexer.Add(d.Object); err != nil { return err } s.processor.distribute(addNotification{newObj: d.Object}, isSync) } case Deleted: if err := s.indexer.Delete(d.Object); err != nil { return err } s.processor.distribute(deleteNotification{oldObj: d.Object}, false) } } return nil } å¾ˆå®¹æ˜“çœ‹å‡ºæ¥ï¼Œå½“deltaç±»å‹ä¸ºéDeleteæ—¶ï¼Œinformerä¼šä»è‡ªå·±çš„indexerï¼ˆå¸¦ç´¢å¼•çš„ç¼“å­˜ï¼‰ä¸­è·å–æŒ‡å®šçš„objectæ˜¯å¦å­˜åœ¨ï¼ˆæ³¨æ„è¿™é‡Œå…¶å®æ˜¯ä»objectè®¡ç®—å‡ºkeyï¼Œç„¶åç”¨keyå¯»æ‰¾åˆ°çš„ï¼‰ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°ç¼“å­˜ä¸”åˆ†å‘ä¸€ä¸ªupdateäº‹ä»¶ã€‚å¯ä»¥ç»§ç»­çœ‹åç»­å¯¹åˆ†å‘çš„è¿™ä¸ªnotificationçš„å¤„ç†ï¼Œéƒ½æ˜¯ç›´æ¥å¤„ç†ï¼Œæ²¡æœ‰ä»»ä½•å»é‡é€»è¾‘ã€‚åˆ°è¿™é‡Œå°±å¯ä»¥ç†è§£ä¸ºå•¥ä¼šæ”¶åˆ°å…¨é‡çš„updateäº‹ä»¶äº†ï¼Œæ­£å¼å› ä¸ºæ­¤æ—¶ç¼“å­˜é‡Œå·²ç»æœ‰äº†å¯¹åº”æ•°æ®ï¼Œè€Œåœ¨åˆ†å‘äº‹ä»¶æ—¶å¹¶æ²¡æœ‰æ¯”è¾ƒç¼“å­˜ä¸­çš„objectæ˜¯å¦å’Œæ–°æ¥çš„objectä¸€è‡´å°±ç›´æ¥å½“æˆupdateå¤„ç†äº†ï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ”¶åˆ°å…¨é‡çš„æ›´æ–°äº‹ä»¶ã€‚é‚£é—®é¢˜åˆæ¥äº†ï¼Œä¸ºä»€ä¹ˆé‡å¯apiserveræ—¶ä¼šå¾€deltafifoé‡Œå…¨é‡æ‰”ä¸€éæ•°æ®ï¼Œæ­£å¸¸ä¸åº”è¯¥æ˜¯ä»æœ€åçš„resourceVersionå¼€å§‹é‡æ–°watchå—ï¼Ÿç»§ç»­çœ‹ä¸‹é¢çš„å¤„ç† ListAndWatch ï¼ˆå…¨é‡æ•°æ®çš„æ¥æºï¼‰ // ä»£ç ä½ç½® k8s.io/client-go/tools/cache/reflector.go // ListAndWatch first lists all items and get the resource version at the moment of call, // and then use the resource version to watch. // It returns error if ListAndWatch didn't even try to initialize watch. func (r *Reflector) ListAndWatch(stopCh \u003c-chan struct{}) error { klog.V(3).Infof(\"Listing and watching %v from %s\", r.expectedType, r.name) var resourceVersion string // Explicitly set \"0\" as resource version - it's fine for the List() // to be served from cache and potentially be delayed relative to // etcd contents. Reflector framework will catch up via Watch() eventually. options := metav1.ListOptions{ResourceVersion: \"0\"} if err := func() error { initTrace := trace.New(\"Reflector ListAndWatch\", trace.Field{\"name\", r.name}) defer initTrace.LogIfLong(10 * time.Second) var list runtime.Object var err error listCh := make(chan struct{}, 1) panicCh := make(chan interface{}, 1) go func() { defer func() { if r := recover(); r != nil { panicCh \u003c- r } }() // Attempt to gather list in chunks, if supported by listerWatcher, if not, the first // list request will return the full response. pager := pager.New(pager.SimplePageFunc(func(opts metav1.ListOptions) (runtime.Object, error) { return r.listerWatcher.List(opts) })) if r.WatchListPageSize != 0 { pager.PageSize = r.WatchListPageSize } // Pager falls back to full list if paginated list calls fail due to an \"Expired\" error. list, err = pager.List(context.Background(), options) close(listCh) }() select { case \u003c-stopCh: return nil case r := \u003c-panicCh: panic(r) case \u003c-listCh: } if err != nil { return fmt.Errorf(\"%s: Failed to list %v: %v\", r.name, r.expectedType, err) } initTrace.Step(\"Objects listed\") listMetaInterface, err := meta.ListAccessor(list) if err != nil { return fmt.Errorf(\"%s: Unable to understand list result %#v: %v\", r.name, list, err) } resourceVersion = listMetaInterface.GetResourceVersion() initTrace.Step(\"Resource version extracted\") items, err := meta.ExtractList(list) if err != nil { return fmt.Errorf(\"%s: Unable to understand list result %#v (%v)\", r.name, list, err) } initTrace.Step(\"Objects extracted\") if err := r.syncWith(items, resourceVersion); err != nil { return fmt.Errorf(\"%s: Unable to sync list result: %v\", r.name, err) } initTrace.Step(\"SyncWith done\") r.setLastSyncResourceVersion(resourceVersion) initTrace.Step(\"Resource version updated\") return nil }(); err != nil { return err } resyncerrc := make(chan error, 1) cancelCh := make(chan struct{}) defer close(cancelCh) g","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/:0:2","tags":["kubernetes"],"title":"Kube-apiserveré‡å¯å¯¼è‡´äº§ç”Ÿå…¨é‡çš„update event","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/"},{"categories":["é—®é¢˜æ’æŸ¥","bugä¿®å¤"],"content":"æ€»ç»“ è‡³æ­¤ï¼Œå·²ç»æ¸…æ¥šäº†å…·ä½“çš„åŸå› ï¼ŒListAndWatchçš„ä¿®æ”¹å¾ˆç®€å•ï¼Œå·²ç»ç»™å®˜æ–¹æäº†pull request ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚ ","date":"2019-08-21","objectID":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/:0:3","tags":["kubernetes"],"title":"Kube-apiserveré‡å¯å¯¼è‡´äº§ç”Ÿå…¨é‡çš„update event","uri":"https://www.likakuli.com/posts/kubernetes-apiserver-refused/"},{"categories":["æºç åˆ†æ"],"content":"kubelet podåˆ›å»ºä¸»æµç¨‹","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":" kubernetes ç‰ˆæœ¬ï¼š v1.12 ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:0:0","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"kubelet å·¥ä½œåŸç† kubelet çš„å·¥ä½œæ ¸å¿ƒå°±æ˜¯åœ¨å›´ç»•ç€ä¸åŒçš„ç”Ÿäº§è€…ç”Ÿäº§å‡ºæ¥çš„ä¸åŒçš„æœ‰å…³ pod çš„æ¶ˆæ¯æ¥è°ƒç”¨ç›¸åº”çš„æ¶ˆè´¹è€…ï¼ˆä¸åŒçš„å­æ¨¡å—ï¼‰å®Œæˆä¸åŒçš„è¡Œä¸º(åˆ›å»ºå’Œåˆ é™¤ pod ç­‰)ï¼Œå³å›¾ä¸­çš„æ§åˆ¶å¾ªç¯ï¼ˆSyncLoopï¼‰ï¼Œé€šè¿‡ä¸åŒçš„äº‹ä»¶é©±åŠ¨è¿™ä¸ªæ§åˆ¶å¾ªç¯è¿è¡Œã€‚ æœ¬æ–‡ä»…åˆ†ææ–°å»º pod çš„æµç¨‹ï¼Œå½“ä¸€ä¸ª pod å®Œæˆè°ƒåº¦ï¼Œä¸ä¸€ä¸ª node ç»‘å®šèµ·æ¥ä¹‹åï¼Œè¿™ä¸ª pod å°±ä¼šè§¦å‘ kubelet åœ¨å¾ªç¯æ§åˆ¶é‡Œæ³¨å†Œçš„ handlerï¼Œä¸Šå›¾ä¸­çš„ HandlePods éƒ¨åˆ†ã€‚æ­¤æ—¶ï¼Œé€šè¿‡æ£€æŸ¥ pod åœ¨ kubelet å†…å­˜ä¸­çš„çŠ¶æ€ï¼Œkubelet å°±èƒ½åˆ¤æ–­å‡ºè¿™æ˜¯ä¸€ä¸ªæ–°è°ƒåº¦è¿‡æ¥çš„ podï¼Œä»è€Œè§¦å‘ Handler é‡Œçš„ ADD äº‹ä»¶å¯¹åº”çš„é€»è¾‘å¤„ç†ã€‚ç„¶å kubelet ä¼šä¸ºè¿™ä¸ª pod ç”Ÿæˆå¯¹åº”çš„ podStatusï¼Œæ¥ç€æ£€æŸ¥ pod æ‰€å£°æ˜çš„ volume æ˜¯ä¸æ˜¯å‡†å¤‡å¥½äº†ï¼Œç„¶åè°ƒç”¨ä¸‹å±‚çš„å®¹å™¨è¿è¡Œæ—¶ã€‚å¦‚æœæ˜¯ update äº‹ä»¶çš„è¯ï¼Œkubelet å°±ä¼šæ ¹æ® pod å¯¹è±¡å…·ä½“çš„å˜æ›´æƒ…å†µï¼Œè°ƒç”¨ä¸‹å±‚çš„å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œå®¹å™¨çš„é‡å»ºã€‚ ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:1:0","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"kubelet åˆ›å»º pod çš„æµç¨‹ kubelet åˆ›å»º pod çš„æµç¨‹ ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:0","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"1ã€kubelet çš„æ§åˆ¶å¾ªç¯ï¼ˆsyncLoopï¼‰ syncLoop ä¸­é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª syncTicker å’Œ housekeepingTickerï¼Œå³ä½¿æ²¡æœ‰éœ€è¦æ›´æ–°çš„ pod é…ç½®ï¼Œkubelet ä¹Ÿä¼šå®šæ—¶å»åšåŒæ­¥å’Œæ¸…ç† pod çš„å·¥ä½œã€‚ç„¶ååœ¨ for å¾ªç¯ä¸­ä¸€ç›´è°ƒç”¨ syncLoopIterationï¼Œå¦‚æœåœ¨æ¯æ¬¡å¾ªç¯è¿‡ç¨‹ä¸­å‡ºç°æ¯”è¾ƒä¸¥é‡çš„é”™è¯¯ï¼Œkubelet ä¼šè®°å½•åˆ° runtimeState ä¸­ï¼Œé‡åˆ°é”™è¯¯å°±ç­‰å¾… 5 ç§’ä¸­ç»§ç»­å¾ªç¯ã€‚ func (kl *Kubelet) syncLoop(updates \u003c-chan kubetypes.PodUpdate, handler SyncHandler) { glog.Info(\"Starting kubelet main sync loop.\") // syncTicker æ¯ç§’æ£€æµ‹ä¸€æ¬¡æ˜¯å¦æœ‰éœ€è¦åŒæ­¥çš„ pod workers syncTicker := time.NewTicker(time.Second) defer syncTicker.Stop() // æ¯ä¸¤ç§’æ£€æµ‹ä¸€æ¬¡æ˜¯å¦æœ‰éœ€è¦æ¸…ç†çš„ pod housekeepingTicker := time.NewTicker(housekeepingPeriod) defer housekeepingTicker.Stop() // pod çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ– plegCh := kl.pleg.Watch() const ( base = 100 * time.Millisecond max = 5 * time.Second factor = 2 ) duration := base for { if rs := kl.runtimeState.runtimeErrors(); len(rs) != 0 { time.Sleep(duration) duration = time.Duration(math.Min(float64(max), factor*float64(duration))) continue } ... kl.syncLoopMonitor.Store(kl.clock.Now()) // ç¬¬äºŒä¸ªå‚æ•°ä¸º SyncHandler ç±»å‹ï¼ŒSyncHandler æ˜¯ä¸€ä¸ª interfaceï¼Œ // åœ¨è¯¥æ–‡ä»¶å¼€å¤´å¤„å®šä¹‰ if !kl.syncLoopIteration(updates, handler, syncTicker.C, housekeepingTicker.C, plegCh) { break } kl.syncLoopMonitor.Store(kl.clock.Now()) } } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:1","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"2ã€ç›‘å¬ pod å˜åŒ–ï¼ˆsyncLoopIterationï¼‰ syncLoopIteration è¿™ä¸ªæ–¹æ³•å°±ä¼šå¯¹å¤šä¸ªç®¡é“è¿›è¡Œéå†ï¼Œå‘ç°ä»»ä½•ä¸€ä¸ªç®¡é“æœ‰æ¶ˆæ¯å°±äº¤ç»™ handler å»å¤„ç†ã€‚å®ƒä¼šä»ä»¥ä¸‹ç®¡é“ä¸­è·å–æ¶ˆæ¯ï¼š configChï¼šè¯¥ä¿¡æ¯æºç”± kubeDeps å¯¹è±¡ä¸­çš„ PodConfig å­æ¨¡å—æä¾›ï¼Œè¯¥æ¨¡å—å°†åŒæ—¶ watch 3 ä¸ªä¸åŒæ¥æºçš„ pod ä¿¡æ¯çš„å˜åŒ–ï¼ˆfileï¼Œhttpï¼Œapiserverï¼‰ï¼Œä¸€æ—¦æŸä¸ªæ¥æºçš„ pod ä¿¡æ¯å‘ç”Ÿäº†æ›´æ–°ï¼ˆåˆ›å»º/æ›´æ–°/åˆ é™¤ï¼‰ï¼Œè¿™ä¸ª channel ä¸­å°±ä¼šå‡ºç°è¢«æ›´æ–°çš„ pod ä¿¡æ¯å’Œæ›´æ–°çš„å…·ä½“æ“ä½œã€‚ syncChï¼šå®šæ—¶å™¨ç®¡é“ï¼Œæ¯éš”ä¸€ç§’å»åŒæ­¥æœ€æ–°ä¿å­˜çš„ pod çŠ¶æ€ houseKeepingChï¼šhousekeeping äº‹ä»¶çš„ç®¡é“ï¼Œåš pod æ¸…ç†å·¥ä½œ plegChï¼šè¯¥ä¿¡æ¯æºç”± kubelet å¯¹è±¡ä¸­çš„ pleg å­æ¨¡å—æä¾›ï¼Œè¯¥æ¨¡å—ä¸»è¦ç”¨äºå‘¨æœŸæ€§åœ°å‘ container runtime æŸ¥è¯¢å½“å‰æ‰€æœ‰å®¹å™¨çš„çŠ¶æ€ï¼Œå¦‚æœçŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è¿™ä¸ª channel äº§ç”Ÿäº‹ä»¶ã€‚ livenessManager.Updates()ï¼šå¥åº·æ£€æŸ¥å‘ç°æŸä¸ª pod ä¸å¯ç”¨ï¼Œkubelet å°†æ ¹æ® Pod çš„restartPolicy è‡ªåŠ¨æ‰§è¡Œæ­£ç¡®çš„æ“ä½œ func (kl *Kubelet) syncLoopIteration(configCh \u003c-chan kubetypes.PodUpdate, handler SyncHandler, syncCh \u003c-chan time.Time, housekeepingCh \u003c-chan time.Time, plegCh \u003c-chan *pleg.PodLifecycleEvent) bool { select { case u, open := \u003c-configCh: if !open { glog.Errorf(\"Update channel is closed. Exiting the sync loop.\") return false } switch u.Op { case kubetypes.ADD: ... case kubetypes.UPDATE: ... case kubetypes.REMOVE: ... case kubetypes.RECONCILE: ... case kubetypes.DELETE: ... case kubetypes.RESTORE: ... case kubetypes.SET: ... } ... case e := \u003c-plegCh: ... case \u003c-syncCh: ... case update := \u003c-kl.livenessManager.Updates(): ... case \u003c-housekeepingCh: ... } return true } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:2","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"3ã€å¤„ç†æ–°å¢ podï¼ˆHandlePodAddtionsï¼‰ å¯¹äºäº‹ä»¶ä¸­çš„æ¯ä¸ª podï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š 1ã€æŠŠæ‰€æœ‰çš„ pod æŒ‰ç…§åˆ›å»ºæ—¥æœŸè¿›è¡Œæ’åºï¼Œä¿è¯æœ€å…ˆåˆ›å»ºçš„ pod ä¼šæœ€å…ˆè¢«å¤„ç† 2ã€æŠŠå®ƒåŠ å…¥åˆ° podManager ä¸­ï¼ŒpodManager å­æ¨¡å—è´Ÿè´£ç®¡ç†è¿™å°æœºå™¨ä¸Šçš„ pod çš„ä¿¡æ¯ï¼Œpod å’Œ mirrorPod ä¹‹é—´çš„å¯¹åº”å…³ç³»ç­‰ç­‰ã€‚æ‰€æœ‰è¢«ç®¡ç†çš„ pod éƒ½è¦å‡ºç°åœ¨é‡Œé¢ï¼Œå¦‚æœ podManager ä¸­æ‰¾ä¸åˆ°æŸä¸ª podï¼Œå°±è®¤ä¸ºè¿™ä¸ª pod è¢«åˆ é™¤äº† 3ã€å¦‚æœæ˜¯ mirror pod è°ƒç”¨å…¶å•ç‹¬çš„æ–¹æ³• 4ã€éªŒè¯ pod æ˜¯å¦èƒ½åœ¨è¯¥èŠ‚ç‚¹è¿è¡Œï¼Œå¦‚æœä¸å¯ä»¥ç›´æ¥æ‹’ç» 5ã€é€šè¿‡ dispatchWork æŠŠåˆ›å»º pod çš„å·¥ä½œä¸‹å‘ç»™ podWorkers å­æ¨¡å—åšå¼‚æ­¥å¤„ç† 6ã€åœ¨ probeManager ä¸­æ·»åŠ  podï¼Œå¦‚æœ pod ä¸­å®šä¹‰äº† readiness å’Œ liveness å¥åº·æ£€æŸ¥ï¼Œå¯åŠ¨ goroutine å®šæœŸè¿›è¡Œæ£€æµ‹ func (kl *Kubelet) HandlePodAdditions(pods []*v1.Pod) { start := kl.clock.Now() // å¯¹æ‰€æœ‰ pod æŒ‰ç…§æ—¥æœŸæ’åºï¼Œä¿è¯æœ€å…ˆåˆ›å»ºçš„ pod ä¼˜å…ˆè¢«å¤„ç† sort.Sort(sliceutils.PodsByCreationTime(pods)) for _, pod := range pods { if kl.dnsConfigurer != nil \u0026\u0026 kl.dnsConfigurer.ResolverConfig != \"\" { kl.dnsConfigurer.CheckLimitsForResolvConf() } existingPods := kl.podManager.GetPods() // æŠŠ pod åŠ å…¥åˆ° podManager ä¸­ kl.podManager.AddPod(pod) // åˆ¤æ–­æ˜¯å¦æ˜¯ mirror podï¼ˆå³ static podï¼‰ if kubepod.IsMirrorPod(pod) { kl.handleMirrorPod(pod, start) continue } if !kl.podIsTerminated(pod) { activePods := kl.filterOutTerminatedPods(existingPods) // é€šè¿‡ canAdmitPod æ–¹æ³•æ ¡éªŒPodèƒ½å¦åœ¨è¯¥è®¡ç®—èŠ‚ç‚¹åˆ›å»º(å¦‚:ç£ç›˜ç©ºé—´) // Check if we can admit the pod; if not, reject it. if ok, reason, message := kl.canAdmitPod(activePods, pod); !ok { kl.rejectPod(pod, reason, message) continue } } mirrorPod, _ := kl.podManager.GetMirrorPodByPod(pod) // é€šè¿‡ dispatchWork åˆ†å‘ pod åšå¼‚æ­¥å¤„ç†ï¼ŒdispatchWork ä¸»è¦å·¥ä½œå°±æ˜¯æŠŠæ¥æ”¶åˆ°çš„å‚æ•°å°è£…æˆ UpdatePodOptionsï¼Œè°ƒç”¨ UpdatePod æ–¹æ³•. kl.dispatchWork(pod, kubetypes.SyncPodCreate, mirrorPod, start) // åœ¨ probeManager ä¸­æ·»åŠ  podï¼Œå¦‚æœ pod ä¸­å®šä¹‰äº† readiness å’Œ liveness å¥åº·æ£€æŸ¥ï¼Œå¯åŠ¨ goroutine å®šæœŸè¿›è¡Œæ£€æµ‹ kl.probeManager.AddPod(pod) } } static pod æ˜¯ç”± kubelet ç›´æ¥ç®¡ç†çš„ï¼Œk8s apiserver å¹¶ä¸ä¼šæ„ŸçŸ¥åˆ° static pod çš„å­˜åœ¨ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå’Œä»»ä½•ä¸€ä¸ª rs å…³è”ä¸Šï¼Œå®Œå…¨æ˜¯ç”± kubelet è¿›ç¨‹æ¥ç›‘ç®¡ï¼Œå¹¶åœ¨å®ƒå¼‚å¸¸æ—¶è´Ÿè´£é‡å¯ã€‚Kubelet ä¼šé€šè¿‡ apiserver ä¸ºæ¯ä¸€ä¸ª static pod åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ mirror podï¼Œå¦‚æ­¤ä»¥æ¥å°±å¯ä»¥å¯ä»¥é€šè¿‡ kubectl å‘½ä»¤æŸ¥çœ‹å¯¹åº”çš„ pod,å¹¶ä¸”å¯ä»¥é€šè¿‡ kubectl logs å‘½ä»¤ç›´æ¥æŸ¥çœ‹åˆ°static pod çš„æ—¥å¿—ä¿¡æ¯ã€‚ ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:3","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"4ã€ä¸‹å‘ä»»åŠ¡ï¼ˆdispatchWorkï¼‰ dispatchWorker çš„ä¸»è¦ä½œç”¨æ˜¯æŠŠæŸä¸ªå¯¹ Pod çš„æ“ä½œï¼ˆåˆ›å»º/æ›´æ–°/åˆ é™¤ï¼‰ä¸‹å‘ç»™ podWorkersã€‚ func (kl *Kubelet) dispatchWork(pod *v1.Pod, syncType kubetypes.SyncPodType, mirrorPod *v1.Pod, start time.Time) { if kl.podIsTerminated(pod) { if pod.DeletionTimestamp != nil { kl.statusManager.TerminatePod(pod) } return } // è½å®åœ¨ podWorkers ä¸­ kl.podWorkers.UpdatePod(\u0026UpdatePodOptions{ Pod: pod, MirrorPod: mirrorPod, UpdateType: syncType, OnCompleteFunc: func(err error) { if err != nil { metrics.PodWorkerLatency.WithLabelValues(syncType.String()).Observe(metrics.SinceInMicroseconds(start)) } }, }) if syncType == kubetypes.SyncPodCreate { metrics.ContainersPerPodCount.Observe(float64(len(pod.Spec.Containers))) } } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:4","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"5ã€æ›´æ–°äº‹ä»¶çš„ channelï¼ˆUpdatePodï¼‰ podWorkers å­æ¨¡å—ä¸»è¦çš„ä½œç”¨å°±æ˜¯å¤„ç†é’ˆå¯¹æ¯ä¸€ä¸ªçš„ Pod çš„æ›´æ–°äº‹ä»¶ï¼Œæ¯”å¦‚ Pod çš„åˆ›å»ºï¼Œåˆ é™¤ï¼Œæ›´æ–°ã€‚è€Œ podWorkers é‡‡å–çš„åŸºæœ¬æ€è·¯æ˜¯ï¼šä¸ºæ¯ä¸€ä¸ª Pod éƒ½å•ç‹¬åˆ›å»ºä¸€ä¸ª goroutine å’Œæ›´æ–°äº‹ä»¶çš„ channelï¼Œgoroutine ä¼šé˜»å¡å¼çš„ç­‰å¾… channel ä¸­çš„äº‹ä»¶ï¼Œå¹¶ä¸”å¯¹è·å–çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚è€Œ podWorkers å¯¹è±¡è‡ªèº«åˆ™ä¸»è¦è´Ÿè´£å¯¹æ›´æ–°äº‹ä»¶è¿›è¡Œä¸‹å‘ã€‚ func (p *podWorkers) UpdatePod(options *UpdatePodOptions) { pod := options.Pod uid := pod.UID var podUpdates chan UpdatePodOptions var exists bool p.podLock.Lock() defer p.podLock.Unlock() // å¦‚æœå½“å‰ pod è¿˜æ²¡æœ‰å¯åŠ¨è¿‡ goroutine ï¼Œåˆ™å¯åŠ¨ goroutineï¼Œå¹¶ä¸”åˆ›å»º channel if podUpdates, exists = p.podUpdates[uid]; !exists { // åˆ›å»º channel podUpdates = make(chan UpdatePodOptions, 1) p.podUpdates[uid] = podUpdates // å¯åŠ¨ goroutine go func() { defer runtime.HandleCrash() p.managePodLoop(podUpdates) }() } // ä¸‹å‘æ›´æ–°äº‹ä»¶ if !p.isWorking[pod.UID] { p.isWorking[pod.UID] = true podUpdates \u003c- *options } else { update, found := p.lastUndeliveredWorkUpdate[pod.UID] if !found || update.UpdateType != kubetypes.SyncPodKill { p.lastUndeliveredWorkUpdate[pod.UID] = *options } } } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:5","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"6ã€è°ƒç”¨ syncPodFn æ–¹æ³•åŒæ­¥ podï¼ˆmanagePodLoopï¼‰ managePodLoop è°ƒç”¨ syncPodFn æ–¹æ³•å»åŒæ­¥ podï¼ŒsyncPodFn å®é™…ä¸Šå°±æ˜¯kubelet.SyncPodã€‚åœ¨å®Œæˆè¿™æ¬¡ sync åŠ¨ä½œä¹‹åï¼Œä¼šè°ƒç”¨ wrapUp å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šåšå‡ ä»¶äº‹æƒ…: å°†è¿™ä¸ª pod ä¿¡æ¯æ’å…¥ kubelet çš„ workQueue é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å‘¨æœŸæ€§çš„å¯¹è¿™ä¸ª pod çš„çŠ¶æ€è¿›è¡Œ sync å°†åœ¨è¿™æ¬¡ sync æœŸé—´å †ç§¯çš„æ²¡æœ‰èƒ½å¤Ÿæ¥å¾—åŠå¤„ç†çš„æœ€è¿‘ä¸€æ¬¡ update æ“ä½œåŠ å…¥ goroutine çš„äº‹ä»¶ channel ä¸­ï¼Œç«‹å³å¤„ç†ã€‚ func (p *podWorkers) managePodLoop(podUpdates \u003c-chan UpdatePodOptions) { var lastSyncTime time.Time for update := range podUpdates { err := func() error { podUID := update.Pod.UID status, err := p.podCache.GetNewerThan(podUID, lastSyncTime) if err != nil { ... } err = p.syncPodFn(syncPodOptions{ mirrorPod: update.MirrorPod, pod: update.Pod, podStatus: status, killPodOptions: update.KillPodOptions, updateType: update.UpdateType, }) lastSyncTime = time.Now() return err }() if update.OnCompleteFunc != nil { update.OnCompleteFunc(err) } if err != nil { ... } p.wrapUp(update.Pod.UID, err) } } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:6","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"7ã€å®Œæˆåˆ›å»ºå®¹å™¨å‰çš„å‡†å¤‡å·¥ä½œï¼ˆSyncPodï¼‰ åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š å¦‚æœæ˜¯åˆ é™¤ podï¼Œç«‹å³æ‰§è¡Œå¹¶è¿”å› åŒæ­¥ podStatus åˆ° kubelet.statusManager æ£€æŸ¥ pod æ˜¯å¦èƒ½è¿è¡Œåœ¨æœ¬èŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯æƒé™æ£€æŸ¥ï¼ˆæ˜¯å¦èƒ½ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œæ˜¯å¦å¯ä»¥ä»¥ privileged æƒé™è¿è¡Œç­‰ï¼‰ã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œå°±åˆ é™¤æœ¬åœ°æ—§çš„ pod å¹¶è¿”å›é”™è¯¯ä¿¡æ¯ åˆ›å»º containerManagar å¯¹è±¡ï¼Œå¹¶ä¸”åˆ›å»º pod level cgroupï¼Œæ›´æ–° Qos level cgroup å¦‚æœæ˜¯ static Podï¼Œå°±åˆ›å»ºæˆ–è€…æ›´æ–°å¯¹åº”çš„ mirrorPod åˆ›å»º pod çš„æ•°æ®ç›®å½•ï¼Œå­˜æ”¾ volume å’Œ plugin ä¿¡æ¯,å¦‚æœå®šä¹‰äº† pvï¼Œç­‰å¾…æ‰€æœ‰çš„ volume mount å®Œæˆï¼ˆvolumeManager ä¼šåœ¨åå°åšè¿™äº›äº‹æƒ…ï¼‰,å¦‚æœæœ‰ image secretsï¼Œå» apiserver è·å–å¯¹åº”çš„ secrets æ•°æ® ç„¶åè°ƒç”¨ kubelet.volumeManager ç»„ä»¶ï¼Œç­‰å¾…å®ƒå°† pod æ‰€éœ€è¦çš„æ‰€æœ‰å¤–æŒ‚çš„ volume éƒ½å‡†å¤‡å¥½ã€‚ è°ƒç”¨ container runtime çš„ SyncPod æ–¹æ³•ï¼Œå»å®ç°çœŸæ­£çš„å®¹å™¨åˆ›å»ºé€»è¾‘ è¿™é‡Œæ‰€æœ‰çš„äº‹æƒ…éƒ½å’Œå…·ä½“çš„å®¹å™¨æ²¡æœ‰å…³ç³»ï¼Œå¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•æ˜¯åˆ›å»º pod å®ä½“ï¼ˆå³å®¹å™¨ï¼‰ä¹‹å‰éœ€è¦å®Œæˆçš„å‡†å¤‡å·¥ä½œã€‚ func (kl *Kubelet) syncPod(o syncPodOptions) error { // pull out the required options pod := o.pod mirrorPod := o.mirrorPod podStatus := o.podStatus updateType := o.updateType // æ˜¯å¦ä¸º åˆ é™¤ pod if updateType == kubetypes.SyncPodKill { ... } ... // æ£€æŸ¥ pod æ˜¯å¦èƒ½è¿è¡Œåœ¨æœ¬èŠ‚ç‚¹ runnable := kl.canRunPod(pod) if !runnable.Admit { ... } // æ›´æ–° pod çŠ¶æ€ kl.statusManager.SetPodStatus(pod, apiPodStatus) // å¦‚æœ pod é running çŠ¶æ€åˆ™ç›´æ¥ kill æ‰ if !runnable.Admit || pod.DeletionTimestamp != nil || apiPodStatus.Phase == v1.PodFailed { ... } // åŠ è½½ç½‘ç»œæ’ä»¶ if rs := kl.runtimeState.networkErrors(); len(rs) != 0 \u0026\u0026 !kubecontainer.IsHostNetworkPod(pod) { ... } pcm := kl.containerManager.NewPodContainerManager() if !kl.podIsTerminated(pod) { ... // åˆ›å»ºå¹¶æ›´æ–° pod çš„ cgroups if !(podKilled \u0026\u0026 pod.Spec.RestartPolicy == v1.RestartPolicyNever) { if !pcm.Exists(pod) { ... } } } // ä¸º static pod åˆ›å»ºå¯¹åº”çš„ mirror pod if kubepod.IsStaticPod(pod) { ... } // åˆ›å»ºæ•°æ®ç›®å½• if err := kl.makePodDataDirs(pod); err != nil { ... } // æŒ‚è½½ volume if !kl.podIsTerminated(pod) { if err := kl.volumeManager.WaitForAttachAndMount(pod); err != nil { ... } } // è·å– secret ä¿¡æ¯ pullSecrets := kl.getPullSecretsForPod(pod) // è°ƒç”¨ containerRuntime çš„ SyncPod æ–¹æ³•å¼€å§‹åˆ›å»ºå®¹å™¨ result := kl.containerRuntime.SyncPod(pod, apiPodStatus, podStatus, pullSecrets, kl.backOff) kl.reasonCache.Update(pod.UID, result) if err := result.Error(); err != nil { ... } return nil } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:7","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"8ã€åˆ›å»ºå®¹å™¨ containerRuntimeï¼ˆpkg/kubelet/kuberuntimeï¼‰å­æ¨¡å—çš„ SyncPod å‡½æ•°æ‰æ˜¯çœŸæ­£å®Œæˆ pod å†…å®¹å™¨å®ä½“çš„åˆ›å»ºã€‚ syncPod ä¸»è¦æ‰§è¡Œä»¥ä¸‹å‡ ä¸ªæ“ä½œï¼š 1ã€è®¡ç®— sandbox å’Œ container æ˜¯å¦å‘ç”Ÿå˜åŒ– 2ã€åˆ›å»º sandbox å®¹å™¨ 3ã€å¯åŠ¨ init å®¹å™¨ 4ã€å¯åŠ¨ä¸šåŠ¡å®¹å™¨ initContainers å¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ª container ä¸¥æ ¼æŒ‰ç…§é¡ºåºå¯åŠ¨ï¼Œåªæœ‰å½“å‰ä¸€ä¸ª container é€€å‡ºäº†ä»¥åï¼Œæ‰å¼€å§‹å¯åŠ¨ä¸‹ä¸€ä¸ª containerã€‚ func (m *kubeGenericRuntimeManager) SyncPod(pod *v1.Pod, _ v1.PodStatus, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, backOff *flowcontrol.Backoff) (result kubecontainer.PodSyncResult) { // 1ã€è®¡ç®— sandbox å’Œ container æ˜¯å¦å‘ç”Ÿå˜åŒ– podContainerChanges := m.computePodActions(pod, podStatus) if podContainerChanges.CreateSandbox { ref, err := ref.GetReference(legacyscheme.Scheme, pod) if err != nil { glog.Errorf(\"Couldn't make a ref to pod %q: '%v'\", format.Pod(pod), err) } ... } // 2ã€kill æ‰ sandbox å·²ç»æ”¹å˜çš„ pod if podContainerChanges.KillPod { ... } else { // 3ã€kill æ‰é running çŠ¶æ€çš„ containers ... for containerID, containerInfo := range podContainerChanges.ContainersToKill { ... if err := m.killContainer(pod, containerID, containerInfo.name, containerInfo.message, nil); err != nil { ... } } } m.pruneInitContainersBeforeStart(pod, podStatus) podIP := \"\" if podStatus != nil { podIP = podStatus.IP } // 4ã€åˆ›å»º sandbox podSandboxID := podContainerChanges.SandboxID if podContainerChanges.CreateSandbox { podSandboxID, msg, err = m.createPodSandbox(pod, podContainerChanges.Attempt) if err != nil { ... } ... podSandboxStatus, err := m.runtimeService.PodSandboxStatus(podSandboxID) if err != nil { ... } // å¦‚æœ pod ç½‘ç»œæ˜¯ host æ¨¡å¼ï¼Œå®¹å™¨ä¹Ÿç›¸åŒï¼›å…¶ä»–æƒ…å†µä¸‹ï¼Œå®¹å™¨ä¼šä½¿ç”¨ None ç½‘ç»œæ¨¡å¼ï¼Œè®© kubelet çš„ç½‘ç»œæ’ä»¶è‡ªå·±è¿›è¡Œç½‘ç»œé…ç½® if !kubecontainer.IsHostNetworkPod(pod) { podIP = m.determinePodSandboxIP(pod.Namespace, pod.Name, podSandboxStatus) glog.V(4).Infof(\"Determined the ip %q for pod %q after sandbox changed\", podIP, format.Pod(pod)) } } configPodSandboxResult := kubecontainer.NewSyncResult(kubecontainer.ConfigPodSandbox, podSandboxID) result.AddSyncResult(configPodSandboxResult) // è·å– PodSandbox çš„é…ç½®(å¦‚:metadata,clusterDNS,å®¹å™¨çš„ç«¯å£æ˜ å°„ç­‰) podSandboxConfig, err := m.generatePodSandboxConfig(pod, podContainerChanges.Attempt) ... // 5ã€å¯åŠ¨ init container if container := podContainerChanges.NextInitContainerToStart; container != nil { ... if msg, err := m.startContainer(podSandboxID, podSandboxConfig, container, pod, podStatus, pullSecrets, podIP, kubecontainer.ContainerTypeInit); err != nil { ... } } // 6ã€å¯åŠ¨ä¸šåŠ¡å®¹å™¨ for _, idx := range podContainerChanges.ContainersToStart { ... if msg, err := m.startContainer(podSandboxID, podSandboxConfig, container, pod, podStatus, pullSecrets, podIP, kubecontainer.ContainerTypeRegular); err != nil { ... } } return } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:8","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"9ã€å¯åŠ¨å®¹å™¨ æœ€ç»ˆç”± startContainer å®Œæˆå®¹å™¨çš„å¯åŠ¨ï¼Œå…¶ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š 1ã€æ‹‰å–é•œåƒ 2ã€ç”Ÿæˆä¸šåŠ¡å®¹å™¨çš„é…ç½®ä¿¡æ¯ 3ã€è°ƒç”¨ docker api åˆ›å»ºå®¹å™¨ 4ã€å¯åŠ¨å®¹å™¨ 5ã€æ‰§è¡Œ post start hook func (m *kubeGenericRuntimeManager) startContainer(podSandboxID string, podSandboxConfig *runtimeapi.PodSandboxConfig, container *v1.Container, pod *v1.Pod, podStatus *kubecontainer.PodStatus, pullSecrets []v1.Secret, podIP string, containerType kubecontainer.ContainerType) (string, error) { // 1ã€æ£€æŸ¥ä¸šåŠ¡é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ° Docker Registry æˆ–æ˜¯ Private Registry æ‹‰å–é•œåƒã€‚ imageRef, msg, err := m.imagePuller.EnsureImageExists(pod, container, pullSecrets) if err != nil { ... } ref, err := kubecontainer.GenerateContainerRef(pod, container) if err != nil { ... } // è®¾ç½® RestartCount restartCount := 0 containerStatus := podStatus.FindContainerStatusByName(container.Name) if containerStatus != nil { restartCount = containerStatus.RestartCount + 1 } // 2ã€ç”Ÿæˆä¸šåŠ¡å®¹å™¨çš„é…ç½®ä¿¡æ¯ containerConfig, cleanupAction, err := m.generateContainerConfig(container, pod, restartCount, podIP, imageRef, containerType) if cleanupAction != nil { defer cleanupAction() } ... // 3ã€é€šè¿‡ client.CreateContainer è°ƒç”¨ docker api åˆ›å»ºä¸šåŠ¡å®¹å™¨ containerID, err := m.runtimeService.CreateContainer(podSandboxID, containerConfig, podSandboxConfig) if err != nil { ... } err = m.internalLifecycle.PreStartContainer(pod, container, containerID) if err != nil { ... } ... // 3ã€å¯åŠ¨ä¸šåŠ¡å®¹å™¨ err = m.runtimeService.StartContainer(containerID) if err != nil { ... } containerMeta := containerConfig.GetMetadata() sandboxMeta := podSandboxConfig.GetMetadata() legacySymlink := legacyLogSymlink(containerID, containerMeta.Name, sandboxMeta.Name, sandboxMeta.Namespace) containerLog := filepath.Join(podSandboxConfig.LogDirectory, containerConfig.LogPath) if _, err := m.osInterface.Stat(containerLog); !os.IsNotExist(err) { if err := m.osInterface.Symlink(containerLog, legacySymlink); err != nil { glog.Errorf(\"Failed to create legacy symbolic link %q to container %q log %q: %v\", legacySymlink, containerID, containerLog, err) } } // 4ã€æ‰§è¡Œ post start hook if container.Lifecycle != nil \u0026\u0026 container.Lifecycle.PostStart != nil { kubeContainerID := kubecontainer.ContainerID{ Type: m.runtimeName, ID: containerID, } // runner.Run è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯åœ¨ä¸šåŠ¡å®¹å™¨èµ·æ¥çš„æ—¶å€™ï¼Œ // é¦–å…ˆä¼šæ‰§è¡Œä¸€ä¸ª container hook(PostStart å’Œ PreStop),åšä¸€äº›é¢„å¤„ç†å·¥ä½œã€‚ // åªæœ‰ container hook æ‰§è¡ŒæˆåŠŸæ‰ä¼šè¿è¡Œå…·ä½“çš„ä¸šåŠ¡æœåŠ¡ï¼Œå¦åˆ™å®¹å™¨å¼‚å¸¸ã€‚ msg, handlerErr := m.runner.Run(kubeContainerID, pod, container, container.Lifecycle.PostStart) if handlerErr != nil { ... } } return \"\", nil } ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:2:9","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"æ€»ç»“ æœ¬æ–‡ä¸»è¦è®²è¿°äº† kubelet ä»ç›‘å¬åˆ°æœ‰å®¹å™¨è°ƒåº¦è‡³æœ¬èŠ‚ç‚¹å†åˆ°å®¹å™¨åˆ›å»ºçš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œkubelet æœ€ç»ˆè°ƒç”¨ docker api æ¥åˆ›å»ºå®¹å™¨çš„ã€‚ç»“åˆä¸Šç¯‡æ–‡ç« ï¼Œå¯ä»¥çœ‹å‡º kubelet ä»å¯åŠ¨åˆ°åˆ›å»º pod çš„ä¸€ä¸ªæ¸…æ™°è¿‡ç¨‹ã€‚ å‚è€ƒï¼š k8sæºç åˆ†æ-kubelet Kubeletæºç åˆ†æ(ä¸€):å¯åŠ¨æµç¨‹åˆ†æ kubelet æºç åˆ†æï¼špod æ–°å»ºæµç¨‹ kubeletåˆ›å»ºPodæµç¨‹è§£æ Kubelet: Pod Lifecycle Event Generator (PLEG) Design- proposals ","date":"2019-08-06","objectID":"https://www.likakuli.com/posts/kubernetes-pod-create/:3:0","tags":["kubernetes"],"title":"Podåˆ›å»ºæµç¨‹","uri":"https://www.likakuli.com/posts/kubernetes-pod-create/"},{"categories":["æºç åˆ†æ"],"content":"kubeletä¸cniäº¤äº’æµç¨‹","date":"2019-07-16","objectID":"https://www.likakuli.com/posts/kubernetes-cni/","tags":["kubernetes"],"title":"Kubeletä¸CNIäº¤äº’æºç ","uri":"https://www.likakuli.com/posts/kubernetes-cni/"},{"categories":["æºç åˆ†æ"],"content":" è½¬è½½è‡ªï¼šhttps://www.cnblogs.com/haoqingchuan/p/8668746.htmlï¼Œæœ‰ä¿®æ”¹ ä»£ç ç‰ˆæœ¬1.12.4 æ•´ä½“ä»‹ç» kubeleté€šè¿‡è°ƒç”¨ grpc æ¥å£è°ƒç”¨å®ç°äº† CRI çš„ dockershim å®Œæˆ rpc é€šä¿¡ï¼ŒCNI æ˜¯ç”± dockershim grpc server ä¸­è°ƒç”¨çš„ kubelet -\u003e CRI shim -\u003e container runtime -\u003e container POD åˆ›å»ºè¿‡ç¨‹ä¸­ä» kubelet åˆ° docker server åˆ° cni çš„ UML ç»“æ„å¦‚ä¸‹ CNI æ’ä»¶åˆå§‹åŒ– kubelet åœ¨åˆå§‹åŒ–çš„æ—¶å€™å¦‚æœä½¿ç”¨containerRuntimeä¸ºDockerï¼Œåˆ™ä¼šèµ·åŠ¨dockershim rpc server case kubetypes.DockerContainerRuntime: // Create and start the CRI shim running as a grpc server. streamingConfig := getStreamingConfig(kubeCfg, kubeDeps, crOptions) // ä¸»è¦å‡½æ•° ds, err := dockershim.NewDockerService(kubeDeps.DockerClientConfig, crOptions.PodSandboxImage, streamingConfig, \u0026pluginSettings, runtimeCgroups, kubeCfg.CgroupDriver, crOptions.DockershimRootDirectory, !crOptions.RedirectContainerStreaming) if err != nil { return nil, err } if crOptions.RedirectContainerStreaming { klet.criHandler = ds } // The unix socket for kubelet \u003c-\u003e dockershim communication. glog.V(5).Infof(\"RemoteRuntimeEndpoint: %q, RemoteImageEndpoint: %q\", remoteRuntimeEndpoint, remoteImageEndpoint) glog.V(2).Infof(\"Starting the GRPC server for the docker CRI shim.\") server := dockerremote.NewDockerServer(remoteRuntimeEndpoint, ds) if err := server.Start(); err != nil { return nil, err } // Create dockerLegacyService when the logging driver is not supported. supported, err := ds.IsCRISupportedLogDriver() if err != nil { return nil, err } if !supported { klet.dockerLegacyService = ds legacyLogProvider = ds } åˆ›å»º dockerservice å¯¹è±¡æ—¶åˆå§‹åŒ–cniplugin // rpc serverç«¯ func NewDockerService(config *ClientConfig, podSandboxImage string, streamingConfig *streaming.Config, pluginSettings *NetworkPluginSettings, cgroupsName string, kubeCgroupDriver string, dockershimRootDir string, startLocalStreamingServer bool) (DockerService, error) { ... // è§£ækubeleté…ç½®çš„pluginbindir pluginSettings.PluginBinDirs = cni.SplitDirs(pluginSettings.PluginBinDirString) cniPlugins := cni.ProbeNetworkPlugins(pluginSettings.PluginConfDir, pluginSettings.PluginBinDirs) cniPlugins = append(cniPlugins, kubenet.NewPlugin(pluginSettings.PluginBinDirs)) netHost := \u0026dockerNetworkHost{ \u0026namespaceGetter{ds}, \u0026portMappingGetter{ds}, } plug, err := network.InitNetworkPlugin(cniPlugins, pluginSettings.PluginName, netHost, pluginSettings.HairpinMode, pluginSettings.NonMasqueradeCIDR, pluginSettings.MTU) if err != nil { return nil, fmt.Errorf(\"didn't find compatible CNI plugin with given settings %+v: %v\", pluginSettings, err) } ds.network = network.NewPluginManager(plug) glog.Infof(\"Docker cri networking managed by %v\", plug.Name()) ... } // æ ¹æ®æŒ‡å®šconfdir å’Œ bindirè·å–networkplugin func ProbeNetworkPlugins(confDir string, binDirs []string) []network.NetworkPlugin { old := binDirs binDirs = make([]string, 0, len(binDirs)) for _, dir := range old { if dir != \"\" { binDirs = append(binDirs, dir) } } plugin := \u0026cniNetworkPlugin{ defaultNetwork: nil, loNetwork: getLoNetwork(binDirs), execer: utilexec.New(), confDir: confDir, binDirs: binDirs, } // sync NetworkConfig in best effort during probing. plugin.syncNetworkConfig() return []network.NetworkPlugin{plugin} } åˆå§‹åŒ–cnipluginï¼Œä¼šæ ¹æ®pluginDiræŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ª CNI config æ–‡ä»¶ï¼Œå¹¶ä»¥æ­¤ config æ–‡ä»¶æŸ¥æ‰¾åˆ°å¯¹åº”çš„ CNI bin // InitNetworkPlugin inits the plugin that matches networkPluginName. Plugins must have unique names. func InitNetworkPlugin(plugins []NetworkPlugin, networkPluginName string, host Host, hairpinMode kubeletconfig.HairpinMode, nonMasqueradeCIDR string, mtu int) (NetworkPlugin, error) { if networkPluginName == \"\" { // default to the no_op plugin plug := \u0026NoopNetworkPlugin{} plug.Sysctl = utilsysctl.New() if err := plug.Init(host, hairpinMode, nonMasqueradeCIDR, mtu); err != nil { return nil, err } return plug, nil } pluginMap := map[string]NetworkPlugin{} allErrs := []error{} for _, plugin := range plugins { name := plugin.Name() if errs := validation.IsQualifiedName(name); len(errs) != 0 { allErrs = append(allErrs, fmt.Errorf(\"network plugin has invalid name: %q: %s\", name, strings.Join(errs, \";\"))) continue } if _, found := pluginMap[n","date":"2019-07-16","objectID":"https://www.likakuli.com/posts/kubernetes-cni/:0:0","tags":["kubernetes"],"title":"Kubeletä¸CNIäº¤äº’æºç ","uri":"https://www.likakuli.com/posts/kubernetes-cni/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"cgroupæ³„éœ²","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak/","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²1","uri":"https://www.likakuli.com/posts/cgroup-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ çº¿ä¸Šk8sèŠ‚ç‚¹åˆ›å»ºå®¹å™¨æ—¶æç¤º\"no space left on device\"ï¼Œä¸ºå·²çŸ¥é—®é¢˜ï¼Œå‚è€ƒ https://tencentcloudcontainerteam.github.io/2018/12/29/cgroup-leaking/ http://www.linuxfly.org/kubernetes-19-conflict-with-centos7/?from=groupmessage ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak/:0:1","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²1","uri":"https://www.likakuli.com/posts/cgroup-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ æŒ‰ç…§ä¸Šè¿°é“¾æ¥ä¸­çš„æç¤ºï¼Œé¦–å…ˆçœ‹runcéƒ¨åˆ†ï¼Œdockerç”¨çš„ä»opencontainers/runcé¡¹ç›®forkå‡ºæ¥çš„docker/runcé¡¹ç›®ï¼Œç›®å‰çº¿ä¸Šç”¨çš„dockerç‰ˆæœ¬ä¸º1.13.1ï¼Œå¯¹åº”çš„docker-runcçš„commitä¸º 9df8b306d01f59d3a8029be411de015b7304dd8fï¼ŒæŸ¥çœ‹å…¶ç›¸å…³ä»£ç  func (s *MemoryGroup) Apply(d *cgroupData) (err error) { path, err := d.path(\"memory\") if err != nil \u0026\u0026 !cgroups.IsNotFound(err) { return err } if memoryAssigned(d.config) { if path != \"\" { if err := os.MkdirAll(path, 0755); err != nil { return err } } // é»˜è®¤å…³é—­ if d.config.KernelMemory != 0 { if err := EnableKernelMemoryAccounting(path); err != nil { return err } } } defer func() { if err != nil { os.RemoveAll(path) } }() // We need to join memory cgroup after set memory limits, because // kmem.limit_in_bytes can only be set when the cgroup is empty. _, err = d.join(\"memory\") if err != nil \u0026\u0026 !cgroups.IsNotFound(err) { return err } return nil } æ­¤ç‰ˆæœ¬é»˜è®¤å…³é—­KernelMemoryåŠŸèƒ½ï¼Œæ‰€ä»¥docker-runcæš‚æ—¶ä¸éœ€è¦æ”¹ï¼Œæ¥ä¸‹æ¥çœ‹kubeletç›¸å…³ä»£ç ï¼Œkubeletä¸º1.12.4ç‰ˆæœ¬ï¼Œpkg/kubelet/cm/cgroup_manager_linux.goä¸‹ func(s*MemoryGroup)Apply(d*cgroupData)(errerror){path,err:=d.path(\"memory\")iferr!=nil\u0026\u0026!cgroups.IsNotFound(err){returnerr}elseifpath==\"\"{returnnil}ifmemoryAssigned(d.config){if_,err:=os.Stat(path);os.IsNotExist(err){iferr:=os.MkdirAll(path,0755);err!=nil{returnerr}//Onlyenablekernelmemoryaccoutingwhenthiscgroup//iscreatedbylibcontainer,otherwisewemightget//errorwhenpeopleuse`cgroupsPath`tojoinanexisted//cgroupwhosekernelmemoryisnotinitialized.//å¼ºåˆ¶å¼€å¯iferr:=EnableKernelMemoryAccounting(path);err!=nil{returnerr}}}deferfunc(){iferr!=nil{os.RemoveAll(path)}}()//Weneedtojoinmemorycgroupaftersetmemorylimits,because//kmem.limit_in_bytescanonlybesetwhenthecgroupisempty._,err=d.join(\"memory\")iferr!=nil\u0026\u0026!cgroups.IsNotFound(err){returnerr}returnnil} ä¸Šé¢çš„ä»£ç ä¸ºé»˜è®¤å¼€å¯KernelMemoryï¼Œä¸”æ— æ³•å…³é—­ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯æ³¨é‡Šæ‰EnableKernelMemoryAccountingè°ƒç”¨ï¼Œç„¶åé‡æ–°ç¼–è¯‘kubeletå³å¯ã€‚ç”±äºçº¿ä¸Šdockerå’Œcgroupä½¿ç”¨çš„cgroup-driverä¸ºcgroupfsè€Œä¸æ˜¯systemd**ï¼Œæ‰€ä»¥è¿™é‡Œå¹¶æ²¡æœ‰ä¿®æ”¹systemd****å¯¹åº”æ–‡ä»¶é‡Œæœ‰å…³KernelMemory****çš„ä»£ç ã€‚** ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak/:0:2","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²1","uri":"https://www.likakuli.com/posts/cgroup-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"éªŒè¯ æ‰¾äº†ä¸€å°æ–°æœºå™¨ï¼Œä¸Šé¢æ²¡æœ‰ä»»ä½•å®¹å™¨ï¼Œå…ˆçœ‹ä¸‹æ”¹ä¹‹å‰çš„kubeletæ‰€åˆ›å»ºçš„/sys/fs/cgroup/memory/kubepods/memory.kmem.slabinfoæ–‡ä»¶ï¼Œå¦‚ä¸‹ è¯´æ˜å·²ç»å¼€å¯äº†kmemï¼Œç„¶åæ›¿æ¢kubeletå¹¶é‡å¯å®¿ä¸»ï¼Œè§‚å¯Ÿä¸Šé¢æ–‡ä»¶ï¼Œå¦‚ä¸‹ è¯´æ˜kmemå·²ç»å…³é—­äº†ã€‚è¿™é‡Œé‡ç‚¹å¼ºè°ƒä¸€ä¸‹ï¼Œå¿…é¡»é‡å¯å®¿ä¸»æ‰èƒ½ç”Ÿæ•ˆï¼Œåªé‡å¯kubeletæ— æ³•ç”Ÿæ•ˆï¼Œå› ä¸ºéœ€è¦ä¿®æ”¹/sys/fs/cgroup/memory/kubepodsï¼Œkubeletå¯åŠ¨æ—¶ä¼šæ£€æµ‹æ­¤ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™ç›´æ¥ä½¿ç”¨ï¼Œåªé‡å¯kubeletæ—¶æ­¤ç›®å½•ä¾ç„¶å­˜åœ¨ï¼Œå› ä¸ºå®¹å™¨ä¸šåŠ¡è¿›ç¨‹è¿˜åœ¨ä½¿ç”¨ç€ç›¸å…³çš„cgroupã€‚æ–°åˆ›å»ºçš„Podä¼šä»¥ç»§æ‰¿æ­¤ç›®å½•ä¸‹çš„cgroupçš„é…ç½®ï¼Œæ‰€ä»¥éœ€è¦é‡å¯å®¿ä¸»æ‰èƒ½å…³é—­kmemã€‚ ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak/:0:3","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²1","uri":"https://www.likakuli.com/posts/cgroup-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ æœ¬ç¯‡æ˜¯ä¸€ç§å¿«é€Ÿæš´åŠ›çš„è§£å†³é—®é¢˜æ‰‹æ®µï¼Œåç»è¿‡è°ƒç ”æµ‹è¯•ï¼Œæœ‰ä¸éœ€è¦é‡å¯å®¿ä¸»çš„æ–¹æ¡ˆï¼Œåœ¨è¿™ä¸€ç¯‡ä¸­ä»‹ç» ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak/:0:4","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²1","uri":"https://www.likakuli.com/posts/cgroup-leak/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"cgroupæ³„éœ²","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":" çº¿ä¸Šå®¿ä¸»ä½¿ç”¨çš„kubernetesç‰ˆæœ¬æ˜¯1.12 ï¼Œkubeleté»˜è®¤æ˜¯å¼€å¯äº†kmem accountingçš„åŠŸèƒ½ã€‚kernel memory åœ¨å†…æ ¸4.0ä»¥ä¸‹çš„ç‰ˆæœ¬æ˜¯ä¸€ä¸ªå®éªŒç‰¹æ€§ï¼Œå­˜åœ¨ä½¿ç”¨åä¸èƒ½åˆ é™¤cgroupçš„é—®é¢˜ï¼Œé€ æˆcgroupæ³„æ¼ã€‚ ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:0:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ç°è±¡æè¿° å®¿ä¸»æœºä¸Šåˆ›å»ºå®¹å™¨æ—¶å¤±è´¥ï¼Œkubelet logä¸­å¯è§ æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ mkdir /sys/fs/cgroup/memory/kubepods/burstable/pod79fe803c-072f-11e9-90ca-525400090c71/b98d4aea818bf9d1d1aa84079e1688cd9b4218e008c58a8ef6d6c3c106403e7b: no space left on devic ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:1:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"åˆ°åº•åœ¨æ³„æ¼ä»€ä¹ˆ å†…æ ¸ä¸­å¯¹äºæ¯ä¸ªå­ç³»ç»Ÿçš„çš„æ¡ç›®æ•°æ˜¯æœ‰é™åˆ¶çš„ï¼Œé™åˆ¶çš„å¤§å°å®šä¹‰åœ¨kernel/cgroup.c#L139ã€‚ å½“æ­£å¸¸åœ¨cgroupåˆ›å»ºä¸€ä¸ªgroupçš„ç›®å½•æ—¶ï¼Œæ¡ç›®æ•°å°±åŠ 1 .æˆ‘ä»¬é‡åˆ°çš„æƒ…å†µå°±æ˜¯å› ä¸ºå¼€å¯äº†kmem accountingåŠŸèƒ½ï¼Œè™½ç„¶cgroupçš„ç›®å½•åˆ é™¤äº†ï¼Œä½†æ˜¯æ¡ç›®æ²¡æœ‰å›æ”¶ã€‚è¿™æ ·åé¢å°±æ— æ³•åˆ›å»º65535ä¸ªcgroupäº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å½“å‰å†…æ ¸ç‰ˆæœ¬ä¸‹ï¼Œå¼€å¯äº†kmem accountingåŠŸèƒ½ï¼Œä¼šå¯¼è‡´memory cgroupçš„æ¡ç›®æ³„æ¼æ— æ³•å›æ”¶ã€‚ ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:2:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å¦‚ä½•æŸ¥çœ‹æ³„æ¼ç¨‹åº¦ æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹cgroupçš„æ•°ç›® ã€‚ cat /proc/cgroups ä½†æ˜¯å­˜åœ¨æ³„æ¼çš„å®¿ä¸»æœºä¸Šè¿™ä¸ªæ•°å­—æ˜¯ä¸å¯ä¿¡çš„ï¼Œå› ä¸ºè¿™ä¸ªè®¡æ•°å°±æ˜¯éšç€cgroupä¸‹ç›®å½•çš„å¢åˆ è¿›è¡Œã€‚ ç»è¿‡è¯·æ•™å†…æ ¸ç»„åŒå­¦ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªå¯ä»¥ç»Ÿè®¡cgroupæ¡ç›®çš„æ–¹æ³• # usage : stap -g get_memcg_count.stp %{ #include \u003clinux/rcupdate.h\u003e#include \u003clinux/cgroup.h\u003e#include \u003clinux/memcontrol.h\u003e /* The embedded c function must have a return value. * If it doesn't has an argument, we must use a specified void here. */ int get_memcg_count(void) { struct cgroup_subsys_state *tmp; int count = 1; int i; rcu_read_lock(); for (i = 1; i \u003c 65536; i++) { tmp = css_lookup(\u0026mem_cgroup_subsys, i); if (tmp) count++; } rcu_read_unlock(); return count; } %} function do_calc:long() %{ int count = 0; count = get_memcg_count(); STAP_RETVALUE = count; %} probe begin { printf(\"probe begin\\n\"); printf(\"count %ld\\n\", do_calc()); exit(); } probe end { printf(\"probe end\\n\"); } ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:3:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"å¦‚ä½•å¼•å…¥ \u0026 å¦‚ä½•è§£å†³ è¿™ä¸ªé—®é¢˜æ˜¯kubernetes 1.9 ç‰ˆæœ¬å¼•å…¥çš„ï¼Œkubeletåˆ›å»ºå®¹å™¨ä»£ç ä¸­EnableKernelMemoryAccounting å¯¼è‡´çš„ã€‚å…³äºè¿™ä¸ªé—®é¢˜çš„åˆ†æï¼Œç½‘ç»œä¸Šæœ‰å¾ˆå¤šæ–‡ç« è¿›è¡Œåˆ†æï¼Œæ¯”å¦‚ https://github.com/kubernetes/kubernetes/issues/61937 https://github.com/moby/moby/issues/29638 https://tencentcloudcontainerteam.github.io/2018/12/29/cgroup-leaking/ http://www.linuxfly.org/kubernetes-19-conflict-with-centos7/?from=groupmessage åœ¨ä¸Šç¯‡cgroupæ³„éœ²é—®é¢˜1è¿›è¡Œäº†è¯¦ç»†çš„åˆ†æï¼Œå¹¶æä¾›äº†1.12.4ç‰ˆæœ¬ï¼ˆçº¿ä¸Šç‰ˆæœ¬ï¼‰çš„ä¿®å¤æ–¹æ¡ˆã€‚ ç¤¾åŒºç‰ˆæœ¬1.14ï¼Œæä¾›äº†å¼€å…³å¯ä»¥å…³é—­kmem accountingã€‚ æ–‡ç« ç»™å‡ºçš„æ–¹æ¡ˆç®€å•æ€»ç»“å°±æ˜¯é‡å¯å®¿ä¸»æœºå+å…³é—­kmem accountçš„kubeletï¼Œå¯ä»¥å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å¯¹äºè®¾ç½®äº†node affinityçš„åœºæ™¯ï¼Œé‡å¯å®¿ä¸»æœºæˆæœ¬è¾ƒé«˜ï¼Œå› æ­¤ä¹Ÿå°±æœ‰äº†æ¢ç´¢æ˜¯å¦å¯ä»¥ä¸é‡å¯å®¿ä¸»æœºçš„æ–¹æ¡ˆã€‚ ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:4:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"cgroupè¿ç§» ä¸‹é¢å¯¹äºmemory cgroupå­ç³»ç»Ÿï¼Œç®€ç§°ä¸ºmemcg ã€‚å¯¹äºå·²ç»æ³„æ¼çš„memcgï¼Œæ–°åˆ›å»ºçš„å®¹å™¨ä¼šç»§æ‰¿çˆ¶groupï¼Œæ‰€ä»¥ä¼šåŠ å‰§è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬é€šè¿‡ä¸€ç§cgroupè¿ç§»æ–¹å¼ï¼Œå°†å½“å‰çš„memcg è¿ç§»åˆ°å¦ä¸€ä¸ªgroupï¼Œç„¶åé‡æ–°åˆ›å»ºå…³é—­äº†kmem accountingçš„groupï¼Œå¹¶æŠŠåŸæ¥çš„å­groupè¿ç§»å›æ¥æ˜¯å¦å°±å¯ä»¥æå®šè¿™ä¸ªé—®é¢˜äº†å‘¢ã€‚ cgroup æœ¬èº«æ˜¯æ”¯æŒcgroupè¿ç§»åŠŸèƒ½çš„ 4.2 Task migration When a task migrates from one cgroup to another, its charge is not carried forward by default. The pages allocated from the original cgroup still remain charged to it, the charge is dropped when the page is freed or reclaimed. You can move charges of a task along with task migration. See 8. \"Move charges at task migration\" This feature is disabled by default. It can be enabledi (and disabled again) by writing to memory.move_charge_at_immigrate of the destination cgroup. If you want to enable it: # echo (some positive value) \u003e memory.move_charge_at_immigrate Note: Each bits of move_charge_at_immigrate has its own meaning about what type of charges should be moved. See 8.2 for details. Note: Charges are moved only when you move mm-\u003eowner, in other words, a leader of a thread group. Note: If we cannot find enough space for the task in the destination cgroup, we try to make space by reclaiming memory. Task migration may fail if we cannot make enough space. Note: It can take several seconds if you move charges much. æˆ‘ä»¬æ˜¯å…¨é‡task è¿ç§»ï¼Œå› æ­¤ä¹Ÿä¸å­˜åœ¨ä¸Šé¢æ³¨æ„äº‹é¡¹ä¸­æåˆ°çš„åªæ”¯æŒè¿ç§»ä¸»çº¿ç¨‹çš„é—®é¢˜ã€‚ é‚£æˆ‘ä»¬æ¢³ç†ä¸‹ï¼Œmemcg éœ€è¦è¿ç§»å†…å®¹åŒ…å«å“ªäº›ã€‚ è¿ç§»åéœ€è¦ä¿è¯å®¹å™¨å†…å­˜quotaä¸å˜ï¼Œå®¹å™¨çš„å†…å­˜ä½¿ç”¨é‡ä¸å˜ï¼Œå®¹å™¨å†…çš„è¿›ç¨‹ï¼ˆå¯¹äºcgroupæ¥è¯´ï¼Œéƒ½æ˜¯taskï¼‰è¿ç§»åä¸ä¸¢ã€‚è¿™ä¸‰é¡¹åˆ†åˆ«å¯¹åº”çš„æ˜¯memory.limit_in_bytes/memory.usage_in_bytes/tasks å› ä¸ºå†…å­˜ä½¿ç”¨é‡æ˜¯memcgæ¥æ§åˆ¶çš„ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„memory.usage_in_bytes æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–‡ä»¶ä¸­çš„æ•°æ®è¿ç§»æ˜¯ä¾èµ–äºtaskè¿ç§»æ¥å®ç°ã€‚ ","date":"2019-07-10","objectID":"https://www.likakuli.com/posts/cgroup-leak2/:5:0","tags":["linux","cgroup"],"title":"Cgroupæ³„éœ²2","uri":"https://www.likakuli.com/posts/cgroup-leak2/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"dockerdå†…å­˜æ³„éœ²","date":"2019-07-09","objectID":"https://www.likakuli.com/posts/dockerd-memory-leak1/","tags":["docker"],"title":"Dockerdå†…å­˜æ³„éœ²","uri":"https://www.likakuli.com/posts/dockerd-memory-leak1/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ çº¿ä¸Šéƒ¨åˆ†å®¿ä¸»æœºdockerdå ç”¨å†…å­˜è¿‡å¤§ï¼Œæœ‰çš„ç”šè‡³è¶…è¿‡100Gï¼Œè€Œæ•´ä¸ªå®¿ä¸»ä¸Šçš„å®¹å™¨ä½¿ç”¨çš„å†…å­˜è¿˜ä¸å¦‚dockerdä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„å¤šï¼Œç°åœ¨çš„å¤„ç†åŠæ³•æ˜¯æ•…éšœè‡ªæ„ˆï¼Œæ£€æµ‹åˆ°dockerdä½¿ç”¨å†…å­˜è¶…è¿‡10Gåä¼šè®¾ç½®live-restoreï¼Œç„¶åé‡å¯dockerdï¼Œè€Œä¸å½±å“æ­£å¸¸è¿è¡Œçš„å®¹å™¨ï¼Œä½†æ˜¯é‡å¯åè¿˜ä¸€ç›´å­˜åœ¨å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚å¯ä»¥æ€»ç»“ä¸ºä¸¤ç±»å†…å­˜æ³„éœ²æƒ…å†µï¼šæ²¡æœ‰è®¾ç½®live-restore: trueçš„å’Œè®¾ç½®äº†live-restore: trueä¸”é‡å¯è¿‡dockerdçš„ï¼Œè¿™é‡Œæ˜¯é’ˆå¯¹åè€…çš„æ’æŸ¥ï¼Œå› ä¸ºçº¿ä¸Šé»˜è®¤dockerdæ²¡æœ‰å¼€å¯debugæ¨¡å¼ï¼Œè¦æƒ³æ’æŸ¥å‰è€…çš„é—®é¢˜ï¼Œå°±éœ€è¦é‡å¯dockerï¼Œåˆå› ä¸ºæ²¡æœ‰é…ç½®live-restore: trueï¼Œå°±ä¼šå½±å“åˆ°æ­£åœ¨è¿è¡Œçš„å®¹å™¨ã€‚ ","date":"2019-07-09","objectID":"https://www.likakuli.com/posts/dockerd-memory-leak1/:0:1","tags":["docker"],"title":"Dockerdå†…å­˜æ³„éœ²","uri":"https://www.likakuli.com/posts/dockerd-memory-leak1/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"dockerdæ—¥å¿— tail -f /var/log/messages | grep dockerdï¼Œç»“æœå¦‚ä¸‹å›¾ï¼Œå­˜åœ¨å†…å­˜æ³„éœ²çš„dockerdçš„æ—¥å¿—éƒ½æœ‰å¦‚ä¸‹çš„æ—¥å¿—è®°å½•ï¼Œä¸”çœ‹æ—¶é—´è§„å¾‹æ˜¯ç›¸åŒsandboxçš„è®°å½•æ¯ç§’æ‰“å°ä¸€é ä»æºç ä¸­æœç´¢æ—¥å¿—å†…å®¹ï¼Œå¯¹åº”ä¸‹é¢çš„æºç åˆ†æ-2é‡Œçš„å†…å®¹ã€‚ æŸ¥çœ‹dockerdå¯åŠ¨æ—¶çš„æ—¥å¿—ï¼Œå¦‚ä¸‹ ","date":"2019-07-09","objectID":"https://www.likakuli.com/posts/dockerd-memory-leak1/:0:2","tags":["docker"],"title":"Dockerdå†…å­˜æ³„éœ²","uri":"https://www.likakuli.com/posts/dockerd-memory-leak1/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ­¥éª¤ æ­¥éª¤æ¯”è¾ƒé•¿ï¼Œå°¤å…¶æ˜¯æºç é‚£éƒ¨åˆ†ï¼Œä¸å…³æ³¨æºç çš„å¯ä»¥ç›´æ¥è·³è¿‡æºç ï¼Œç›´æ¥çœ‹ä»£ç çš„è§£é‡Š pprofåˆ†æ å¼€å¯dockerdçš„debugæ¨¡å¼ï¼Œå³ç¼–è¾‘/etc/docker/daemon.jsonï¼ŒåŠ ä¸Šdebug: trueçš„é…ç½®å¹¶é‡å¯dockerdï¼Œæ–¹ä¾¿åˆ©ç”¨pprofæ¥å®šä½å†…å­˜æ³„éœ²å¯¹åº”çš„ä»£ç ä½ç½®ã€‚ æ‰§è¡Œgo tool pprof http://ip:port/debug/pprof/heapï¼Œè¾“å…¥topå‘½ä»¤æŸ¥çœ‹å†…å­˜åˆ†é…æƒ…å†µï¼Œå¦‚ä¸‹å›¾ å¯ä»¥çœ‹åˆ°å ç”¨å†…å­˜è¾ƒå¤šçš„å‡½æ•°è°ƒç”¨ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å¾ˆç›´è§‚ï¼Œå¯ä»¥ç»§ç»­è¾“å…¥webå‘½ä»¤ï¼Œä¼šç”Ÿæˆsvgå›¾ç‰‡å¹¶é€šè¿‡ç”»å›¾è½¯ä»¶æˆ–æµè§ˆå™¨æ‰“å¼€ï¼Œå¦‚ä¸‹å›¾ è¿™æ ·å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ•´ä¸ªè°ƒç”¨æµç¨‹åŠå„å‡½æ•°å ç”¨å†…å­˜å¤§å°ï¼Œå¯ä»¥å‘ç°æ˜¯å¤–éƒ¨æŸç¨‹åºè°ƒç”¨äº†dockerçš„apiï¼Œæœ€ç»ˆè°ƒç”¨SubscribeTopicï¼Œæ­¤å‡½æ•°é‡Œé¢å­˜åœ¨å†…å­˜æ³„éœ²ã€‚ æºç åˆ†æ æ˜ç¡®äº†å‘ç”Ÿæ³„éœ²çš„æºç ä½ç½®ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å»çœ‹ä¸‹æºç çš„å…·ä½“é€»è¾‘ï¼Œä¸‹é¢è´´å‡ºéƒ¨åˆ†dockeræºç (tag v1.13.1)ï¼Œçœç•¥éƒ¨åˆ†ä¸å½±å“ç»“æœçš„ä»£ç  docker // ä½ç½®github.com/docker/docker/pkg/pubsub/publisher.go // SubscribeTopic adds a new subscriber that filters messages sent by a topic. func (p *Publisher) SubscribeTopic(topic topicFunc) chan interface{} { ch := make(chan interface{}, p.buffer) p.m.Lock() p.subscribers[ch] = topic p.m.Unlock() return ch } è¿™æ®µä»£ç å¾ˆçŸ­ï¼Œæ¯æ¬¡å…ˆnewä¸€ä¸ªæ–°çš„chanï¼Œç„¶åæŠŠchanåŠ å…¥åˆ°å­—å…¸ä¸­ã€‚å¯ä»¥çœ‹åˆ°å¦‚æœå‘ç”Ÿå†…å­˜æ³„æ¼ï¼Œé‚£å…«æˆå°±æ˜¯è¿™å¥p.subscribers[ch] = topicï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šä¸€ç›´å¾€mapé‡Œæ·»åŠ æ–°å…ƒç´ è€Œå¾—ä¸åˆ°åˆ é™¤ã€‚ä¸ºäº†éªŒè¯ï¼Œç»§ç»­å‘ä¸Šæ‰¾æ­¤å‡½æ•°çš„è°ƒç”¨æ–¹ï¼Œæ²¿ç€è°ƒç”¨å †æ ˆï¼ˆsvgå›¾ç‰‡é‡Œæ˜¾ç¤ºäº†å…·ä½“çš„è°ƒç”¨å †æ ˆï¼‰å¾€ä¸Šæ‰¾ï¼Œå¦‚ä¸‹ // Subscribe adds a new subscriber to the publisher returning the channel. func (p *Publisher) Subscribe() chan interface{} { // è¿™é‡Œè°ƒç”¨SubscribeTopic return p.SubscribeTopic(nil) } // collect registers the container with the collector and adds it to // the event loop for collection on the specified interval returning // a channel for the subscriber to receive on. func (s *statsCollector) collect(c *container.Container) chan interface{} { s.m.Lock() defer s.m.Unlock() publisher, exists := s.publishers[c] if !exists { publisher = pubsub.NewPublisher(100*time.Millisecond, 1024) s.publishers[c] = publisher } // è¿™é‡Œè°ƒç”¨Subscribe return publisher.Subscribe() } func (daemon *Daemon) subscribeToContainerStats(c *container.Container) chan interface{} { return daemon.statsCollector.collect(c) } // ContainerStats writes information about the container to the stream // given in the config object. func (daemon *Daemon) ContainerStats(ctx context.Context, prefixOrName string, config *backend.ContainerStatsConfig) error { ... // subscribe updates := daemon.subscribeToContainerStats(container) // unsubscribe defer daemon.unsubscribeToContainerStats(container, updates) noStreamFirstFrame := true for { select { case v, ok := \u003c-updates: if !ok { return nil } ... if !config.Stream \u0026\u0026 noStreamFirstFrame { // prime the cpu stats so they aren't 0 in the final output noStreamFirstFrame = false continue } if err := enc.Encode(statsJSON); err != nil { return err } if !config.Stream { return nil } case \u003c-ctx.Done(): return nil } } } å¯ä»¥çœ‹åˆ°æœ€ç»ˆåœ¨ContainerStatsä¸­è°ƒç”¨äº†subscribeå¹¶åœ¨æ­¤å‡½æ•°é€€å‡ºåè°ƒç”¨deferé‡Œçš„unsubscribeã€‚ç›´æ¥çœ‹ä»£ç å¯èƒ½çœ‹ä¸æ‡‚ï¼Œå…ˆä»‹ç»ä¸‹docker statsçš„apiï¼Œæ­¤apiç”¨æ¥è·å–å®¹å™¨èµ„æºä½¿ç”¨è¯¦æƒ…ï¼ŒåŒ…æ‹¬cpuï¼Œmemoryï¼Œnetworkç­‰ä¿¡æ¯ï¼Œæ”¯æŒä¸¤ç§æ–¹å¼ï¼Œæµå’Œéæµçš„æ–¹å¼ï¼Œæµæ˜¯åˆ©ç”¨httpçš„chunkedå±æ€§å®ç°çš„ï¼Œéæµçš„æ–¹å¼æ˜¯ç›´æ¥è¿”å›ã€‚ chan****çš„äº§ç”Ÿ æ¯æ¬¡è°ƒç”¨docker stats {container} æˆ–è€… docker statsçš„apiçš„æ—¶å€™ï¼Œéƒ½ä¼šè¿›å…¥åˆ°ContainerStatså‡½æ•°ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªchanæ¥è¾¾åˆ°å¼‚æ­¥çš„æ•ˆæœï¼Œå³å¹¶ä¸æ˜¯æ¯æ¬¡è°ƒç”¨statséƒ½å»å®æ—¶çš„ç»Ÿè®¡ç›¸å…³æ•°æ®ï¼Œè€Œæ˜¯æœ‰ä¸ªåå°goroutineåœ¨å®šæ—¶çš„statsï¼ˆä¸‹é¢ä¼šä»‹ç»ï¼‰ï¼Œå¹¶æŠŠæ•°æ®æ¨é€åˆ°chanï¼Œæ¯æ¬¡è°ƒç”¨apiæ—¶åªæ˜¯å»chanä¸­è·å–æ•°æ®è€Œå·²ï¼Œæ­¤chanå¯¹åº”çš„å°±æ˜¯ä¸Šé¢for selectä¸­çš„updatesï¼Œå³daemon.subscribeToContainerStats(container)çš„è¿”å›ç»“æœï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆSubscribeTopicé‡Œnewçš„chanã€‚ chan****çš„æ¶ˆäº¡ åœ¨ContainerStatså‡½æ•°ç»“æŸåä¼šè°ƒç”¨unsubscribeToContainerStatsï¼Œè¿™é‡Œä¼šå…³é—­åˆ›å»ºå‡ºæ¥çš„chanå¹¶ä»mapä¸­åˆ é™¤ï¼Œé‡Šæ”¾å†…å­˜ã€‚ çŸ¥é“äº†chançš„äº§ç”Ÿå’Œæ¶ˆäº¡ï¼Œå¯ä»¥æ’é™¤ä»¥streamå½¢å¼è°ƒç”¨apiå¯¼è‡´çš„ï¼Œå› ä¸ºè¿™ç§æ–¹å¼ä¸ä¼šä¸€ç›´è°ƒç”¨apiï¼Œä¹Ÿå°±ä¸ä¼šå¯¼è‡´chanä¸€ç›´æ–°å»ºã€‚é‚£å°±åªå‰©ä¸‹ä¸€ç§å½¢å¼ï¼Œå³å¤–éƒ¨æœ‰ç¨‹åºå®šæ—¶çš„ä»¥éstreamçš„å½¢å¼è°ƒç”¨docker statsçš„apiã€‚ä½†æ˜¯ä¸Šé¢ä¹Ÿçœ‹åˆ°äº†å‡½æ•°ç»“æŸåä¼šåœ¨deferé‡Œé‡Šæ”¾æ‰ç”³è¯·çš„chanï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå¯¼è‡´å†…å­˜æ³„éœ²å‘¢ï¼Ÿç¨å¾®æ³¨æ„ä¸€ä¸‹å°±å¯ä»¥çœ‹åˆ°é‡Šæ”¾chançš„å‡½æ•°æ˜¯åœ¨deferé‡Œè°ƒç”¨çš„ï¼Œè€Œä¸”å‡½æ•°é‡Œè¿˜æœ‰ä¸ªforå¾ªç¯ï¼Œæ‰€ä»¥å¾ˆå¯èƒ½æ˜¯å› ä¸ºå‡½æ•°çš„forå¾ªç¯ä¸€ç›´æ²¡æœ‰é€€å‡ºï¼Œå¯¼è‡´deferä¸€ç›´å¾—ä¸åˆ°æ‰§è¡Œï¼Œchanä¹Ÿå°±ä¸€ç›´é‡Šæ”¾ä¸äº†ï¼Œè€Œä¸”å¤–éƒ¨è¿˜å®šæ—¶çš„è°ƒç”¨apiï¼Œä¼šå¯¼è‡´ä¸€ç›´ä¼šæœ‰æ–°çš„chançš„åˆ›å»ºä¸”æ—§çš„chanåŠ å…¥ç¼“å­˜åæ— æ³•è¢«åˆ é™¤ï¼Œæœ€ç»ˆå¯¼è‡´å ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤§ã€‚é‚£å°±çœ‹ä¸‹forå¾ªç¯å†…çš„ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰ä¸€ä¸ªselectï¼Œä¸¤ä¸ªcaseï¼Œåˆ†åˆ«å¯¹åº”ä»updates chanä¸­è¯»æ•°æ®å’Œä»ctx.Done()ä¸­è¯»æ•°æ®ï¼Œåè€…æ˜¯å¤–éƒ¨ç¨‹åºå–æ¶ˆæ­¤æ¬¡apiè°ƒç”¨åä¼šå¾—åˆ°æ‰§è¡Œçš„ï¼Œå³ç»“æŸæ­¤æ¬¡è°ƒç”¨ï¼Œå‰è€…æ˜¯ä»updates chanä¸­è¯»statsæ•°æ®ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦å‡½æ•°ä¸é€€å‡ºï¼Œé‚£ä¹ˆä¸¤ä¸ªcaseéƒ½æ— æ³•æ»¡è¶³å³å¯ï¼Œå³å¤–éƒ¨ç¨‹åºæ²¡æœ‰ä¸»åŠ¨cancel requestä¸”updates chanä¸­å§‹ç»ˆæ²¡æœ‰æ•°æ®ï¼Œå…ˆä¸ç®¡å¤–éƒ¨ç¨‹åºï¼Œå› ä¸ºä¹Ÿä¸çŸ¥é“å¤–éƒ¨ç¨‹åºæ˜¯è°ï¼Œä»£ç æ€ä¹ˆå†™çš„ï¼Œä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯å¤–éƒ¨ç¨‹åºåœ¨è°ƒç”¨docker apiæ—¶çš„å¤„ç†æœ‰é—®é¢˜ï¼Œæ²¡æœ‰è®¾ç½®è¶…æ—¶æˆ–è€…è¶…æ—¶äº†ä¹Ÿæ²¡æœ‰å»cancel requestã€‚é‡ç‚¹å…³æ³¨ä¸‹ä¸ºä»€ä¹ˆupdates chanä¸­ä¸€ç›´æ²¡æœ‰æ•°æ®ï¼Œé‚£å°±è¦çœ‹ä¸‹å†™æ•°æ®ç›¸å…³ä»£ç ï¼Œå¦‚ä¸‹ func (s *statsCollector) run() { type publishersPair struct { container *container.Container publisher *pubsub.Publisher } // we cannot determine the capacity here. // it will grow enough in first iteration var pairs []publishersPair // s.intervalæ˜¯1sï¼Œç¡¬ç¼–ç çš„ for range time.Tick(s.interval) { // it does not make sense in the f","date":"2019-07-09","objectID":"https://www.likakuli.com/posts/dockerd-memory-leak1/:0:3","tags":["docker"],"title":"Dockerdå†…å­˜æ³„éœ²","uri":"https://www.likakuli.com/posts/dockerd-memory-leak1/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ dockerä½¿ç”¨ä¸‹æ¥ç»™äººçš„æ„Ÿè§‰å°±æ˜¯å­˜åœ¨å¤ªå¤šçš„é—®é¢˜äº†ï¼Œåé¢è¿˜ä¼šæœ‰å¤šç¯‡æœ‰å…³dockerèµ„æºæ³„éœ²ã€ç›®å½•umountå¤±è´¥ã€è¯»å†™pipeå¤±è´¥ç­‰å„å¼å„æ ·çš„é—®é¢˜ã€‚ ","date":"2019-07-09","objectID":"https://www.likakuli.com/posts/dockerd-memory-leak1/:0:4","tags":["docker"],"title":"Dockerdå†…å­˜æ³„éœ²","uri":"https://www.likakuli.com/posts/dockerd-memory-leak1/"},{"categories":["é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"create pod slowly","date":"2019-03-26","objectID":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/","tags":["kubernetes"],"title":"Statefulsetåˆ›å»ºpodæ…¢","uri":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/"},{"categories":["é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"èƒŒæ™¯ çº¿ä¸Škubernetesé›†ç¾¤ä»åˆ›å»ºstsåˆ°åˆ›å»ºpodéœ€è¦æ—¶é—´å¾ˆé•¿ï¼Œåˆ†é’Ÿçº§åˆ«ï¼Œä½†æ˜¯è°ƒåº¦å´å¾ˆå¿«ã€‚å¶å°”è¿˜ä¼šå‡ºç°å¯¼è‡´kube-odinä»»åŠ¡å¤±è´¥ï¼ˆè¶…è¿‡300sï¼‰çš„æƒ…å†µ ","date":"2019-03-26","objectID":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/:0:1","tags":["kubernetes"],"title":"Statefulsetåˆ›å»ºpodæ…¢","uri":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/"},{"categories":["é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"æ’æŸ¥è¿‡ç¨‹ åˆ†æå¯èƒ½çš„åŸå› ï¼š watchåˆ°stsçš„å˜åŒ–æœ‰å»¶è¿Ÿ stsä»å…¥é˜Ÿåˆ—åˆ°å‡ºé˜Ÿåˆ—è€—æ—¶é•¿ å¤„ç†stsè€—æ—¶é•¿ kube-controller-managerä¸­stsç›¸å…³æºç ä¸­æœ‰ä¸€äº›æ—¥å¿—ï¼Œéœ€è¦æŠŠloglevelè®¾ç½®ä¸º4ï¼Œå³è°ƒè¯•çº§åˆ«æ‰ä¼šæ‰“å°ï¼Œé‡Œé¢å°±åŒ…æ‹¬å¤„ç†å•ä¸ªstsçš„è€—æ—¶ã€‚é¦–å…ˆæŠŠkube-controller-manageræ—¥å¿—çº§åˆ«è°ƒåˆ°4ï¼Œæ—¥å¿—å¦‚ä¸‹å›¾, æœ€åæ˜¾ç¤ºçš„æ—¶é—´æ˜¯ä»é˜Ÿåˆ—ä¸­æ‹¿åˆ°stsåˆ°å¤„ç†å®Œstsçš„æ•´ä¸ªè¿‡ç¨‹çš„è€—æ—¶ï¼Œå¯ä»¥çœ‹åˆ°è€—æ—¶å¹¶ä¸é•¿ï¼Œåœ¨æ¯«ç§’çº§åˆ«ï¼Œé‚£å°±å¯ä»¥æ’é™¤æ‰å¤„ç†å•ä¸ªstsè€—æ—¶é•¿çš„å¯èƒ½æ€§äº†ã€‚ è¿˜å‰©ä¸‹ä¸¤ç§å¯èƒ½ï¼Œä¸è¿‡ç»†æƒ³çš„è¯ï¼Œç¬¬ä¸€ç§å¯èƒ½ä¹Ÿä¸å¤§ï¼Œå› ä¸ºwatchæ˜¯é€šç”¨çš„ï¼Œæ²¡é“ç†åŒä¸€ä¸ªé›†ç¾¤kube-controller-manageré‡Œçš„watchå°±æ…¢ï¼Œkube-scheulerçš„watchå°±å¿«ã€‚é‚£å°±å¾ˆæœ‰å¯èƒ½æ˜¯ä»watchåˆ°å˜åŒ–åæŠŠstså…¥é˜Ÿåˆ—åˆ°ä»é˜Ÿåˆ—ä¸­æ‹¿åˆ°stsè¿™ä¸ªé˜¶æ®µè€—æ—¶å¤ªé•¿äº†ã€‚æºç ä¸­å¹¶æ²¡æœ‰è¿™ä¸€éƒ¨åˆ†çš„è€—æ—¶ç»Ÿè®¡ï¼Œä½†æ˜¯ä»æºç ä¸­å¯ä»¥çœ‹åˆ°æ•´ä¸ªå¤„ç†è¿‡ç¨‹æ˜¯åŒæ­¥åˆ°çš„ï¼Œå³watchçš„æ‰€æœ‰stsæŒ‰é¡ºåºå…¥é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…åœ¨é¡ºåºçš„ä»é˜Ÿåˆ—ä¸­æ‹¿åˆ°ï¼Œæ¯æ¶ˆè´¹å®Œä¸€ä¸ªï¼Œå†å»æ‹¿å¦ä¸€ä¸ªï¼Œä¸²è¡Œæ‰§è¡Œï¼Œé‚£é—®é¢˜å°±æ¥äº†ï¼Œè™½ç„¶å•ä¸ªstsæ‰§è¡Œè€—æ—¶åœ¨æ¯«ç§’çº§ï¼Œä½†æ˜¯æ•´ä¸ªé›†ç¾¤çš„stsæ•°é‡åœ¨2000+ï¼ŒæŒ‰å¹³å‡æ¯ä¸ªstsè€—æ—¶40msè®¡ç®—ï¼Œç²—ç•¥ä¼°ç®—ä¸€ä¸‹å¤„ç†å®Œä¸€è½®çš„è¯ä¹Ÿéœ€è¦40ms*2000=80sçš„æ—¶é—´ï¼Œåˆ°è¿™é‡Œå·²ç»ç¦»çœŸç›¸ä¸è¿œäº†ï¼Œä½†è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯kube-controller-manageråœ¨åˆå§‹åŒ–çš„æ—¶å€™æ˜¯ä¼šæŠŠæ‰€æœ‰çš„stsåŠ è½½ä¸€éæ”¾å…¥é˜Ÿåˆ—ä¸­çš„ï¼Œå¤„ç†å®Œä¸€éå“ªæ€•è€—æ—¶2åˆ†é’Ÿï¼Œä½†æ˜¯å¤„ç†å®Œä¸€éä¹‹ååªwatchå˜åŒ–çš„stsï¼Œæ•°é‡å°±ä¼šå°‘å¾ˆå¤šäº†ï¼Œæ‰€ä»¥å¤„ç†å®Œåˆå§‹åŒ–æ—¶åŠ è½½çš„æ‰€æœ‰stsåï¼ŒæŒ‰é“ç†å†æœ‰stså˜åŒ–åº”è¯¥æ˜¯å¯ä»¥åŠæ—¶å¤„ç†çš„ï¼Œå› ä¸ºæ­¤æ—¶é˜Ÿåˆ—ä¸­åŸºæœ¬æ²¡æœ‰stsäº†ã€‚å¸¦ç€é—®é¢˜å†å»çœ‹æºç ï¼Œå‘ç°äº†ä¸€ä¸ªç¥å¥‡çš„åœ°æ–¹ï¼Œå¦‚ä¸‹ setInformer.Informer().AddEventHandlerWithResyncPeriod( cache.ResourceEventHandlerFuncs{ AddFunc: ssc.enqueueStatefulSet, UpdateFunc: func(old, cur interface{}) { oldPS := old.(*apps.StatefulSet) curPS := cur.(*apps.StatefulSet) if oldPS.Status.Replicas != curPS.Status.Replicas { glog.V(4).Infof(\"Observed updated replica count for StatefulSet: %v, %d-\u003e%d\", curPS.Name, oldPS.Status.Replicas, curPS.Status.Replicas) } ssc.enqueueStatefulSet(cur) }, DeleteFunc: ssc.enqueueStatefulSet, }, statefulSetResyncPeriod, // 30s ) è¿™å°±å¯¹äº†ï¼Œä¸Šé¢è¿™æ®µä»£ç æ„æ€æ˜¯åªè¦watchåˆ°stsçš„å˜åŒ–ï¼Œå°±ä¼šæŠŠå¯¹åº”çš„stsæ”¾å…¥é˜Ÿåˆ—ï¼Œä¸”æ¯éš”30sä¼šæŠŠå…¨éƒ¨stsé‡æ–°å…¥ä¸€éé˜Ÿåˆ—ï¼Œå†åŠ ä¸Šåˆšæ‰çš„ä¼°ç®—ï¼Œ80sæ‰èƒ½å¤„ç†å®Œæ‰€æœ‰stsï¼Œåœ¨æœªå¤„ç†å®Œä¹‹å‰ï¼ˆå¤„ç†äº†30sæ—¶ï¼‰å°±åˆä¼šæŠŠæ‰€æœ‰çš„stsé‡æ–°åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼ˆå¹¶ä¸æ˜¯ç®€å•ç²—æš´çš„æŠŠæ‰€æœ‰stså…¥é˜Ÿåˆ—ï¼Œä¸­é—´è¿˜ä¼šåšä¸€äº›å¤„ç†ï¼Œè¿‡æ»¤æ‰ä¸€äº›ä¸éœ€è¦é‡å¤å…¥é˜Ÿåˆ—çš„stsï¼‰ï¼Œè¿™å°±ä¼šå¯¼è‡´stsçš„å¾…å¤„ç†é˜Ÿåˆ—ä¸­å§‹ç»ˆæœ‰2000+ä¸ªå…ƒç´ ï¼Œæ–°watchåˆ°çš„å˜åŒ–ä¼šåŠ åˆ°é˜Ÿå°¾ï¼Œä»è€Œå¯¼è‡´stsåˆ›å»ºåè¿‡äº†å¾ˆä¹…Podæ‰åˆ›å»ºï¼Œå› ä¸ºsts controllerä¸€ç›´åœ¨æ¶ˆè´¹ä¹‹å‰æœªå¤„ç†å®Œçš„å…¶ä»–stsäº†ã€‚ ä¸‹é¢å†™äº†ä¸€ä¸ªDemoæ¥æ¼”ç¤ºè¿™ä¸ªé—®é¢˜ï¼Œä»£ç å¾ˆç®€å•ï¼Œå¦‚ä¸‹ package main import ( \"fmt\" \"k8s.io/api/apps/v1\" \"k8s.io/client-go/informers\" \"k8s.io/client-go/kubernetes\" \"k8s.io/client-go/rest\" \"k8s.io/client-go/tools/cache\" \"k8s.io/client-go/util/workqueue\" \"log\" \"math/rand\" \"time\" \"unsafe\" ) var queue workqueue.RateLimitingInterface func main() { defer queue.ShutDown() clientset, _ := kubernetes.NewForConfig(\u0026rest.Config{ Host: \"http://10.80.101.22:8080\", }) factor := rand.Float64() + 1 syncPeriod := time.Duration(float64(time.Duration(12*time.Hour).Nanoseconds()) * factor) informerFactory := informers.NewSharedInformerFactory(clientset, syncPeriod) stopChan := make(chan struct{}) informerFactory.Start(stopChan) informerFactory.WaitForCacheSync(stopChan) stsInformer := informerFactory.Apps().V1().StatefulSets().Informer() // å’Œsts controllerä¸€ç›´ï¼Œ30såŒæ­¥ä¸€éæ‰€æœ‰sts stsInformer.AddEventHandlerWithResyncPeriod(cache.ResourceEventHandlerFuncs{ AddFunc: onAdd, UpdateFunc: onUpdate, DeleteFunc: onDelete, }, 30*time.Second) go consume() stsInformer.Run(stopChan) } func init() { queue = workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \"statefulset\") } func consume() { for { func() { key, quit := queue.Get() if quit { fmt.Println(\"done\") return } defer queue.Done(key) sts := key.(*v1.StatefulSet) // æ¨¡æ‹Ÿå¤„ç†å•ä¸ªstsè€—æ—¶40ms time.Sleep(40 * time.Millisecond) log.Printf(\"cosumed %s, queue count: %d\", sts.Name, queue.Len()) }() } } func onAdd(obj interface{}) { sts := obj.(*v1.StatefulSet) if sts.Name == \"test-delay-sf-60f09\" { log.Printf(\"add address: %d\", unsafe.Pointer(sts)) } queue.Add(sts) } func onUpdate(old, new interface{}) { sts := old.(*v1.StatefulSet) // æµ‹è¯•ç”¨çš„stsï¼Œè§‚å¯Ÿå…¨é‡åŒæ­¥æ—¶çš„åœ°å€å˜åŒ–ï¼Œç”¨æ¥ç¡®å®šæ˜¯ä¸é€šæ‰¹æ¬¡çš„åŒæ­¥ï¼Œé’ˆå¯¹åŒä¸€ä¸ªstsæ¥è¯´æ˜¯å¦åœ°å€ç›¸åŒ // å› ä¸ºqueueä¸­ç”¨åˆ°stsä½œä¸ºmapçš„keyï¼Œæ‰€ä»¥æ­¤å¤„æ‰“å°åœ°å€ï¼ŒéªŒè¯ä¸€ä¸‹ if sts.Name == \"test-delay-sf-60f09\" { log.Printf(\"update address: %d\", unsafe.Pointer(sts)) } queue.Add(sts) } func onDelete(obj interface{}) { sts := obj.(*v1.StatefulSet) if sts.Name == \"test-delay-sf-60f09\" { log.Printf(\"update address: %d\", unsafe.Pointer(sts)) } queue.Add(sts) } æœ€ç»ˆçš„è¾“å‡ºç»“æœ å¯ä»¥çœ‹åˆ°queueçš„é•¿åº¦ä»ä¸€å¼€å§‹çš„2000+ä¸€ç›´é™åˆ°1525ï¼Œæ­¤æ—¶åŒæ­¥äº†ä¸€éå…¨é‡çš„stsï¼Œå³2000+ï¼Œqueueä¸­å…ƒç´ æ•°é‡åˆç”Ÿäº†ä¸Šå»ã€‚åŒæ—¶åœ¨æœªä¿®æ”¹stsçš„æƒ…å†µï¼ŒæŒ‡å®šstsåŒæ­¥åçš„åœ°å€å’ŒåŒæ­¥å‰çš„åœ°å€ç›¸åŒ824689074368ã€‚éªŒè¯äº†ä¹‹å‰çš„çŒœæƒ³ï¼Œé—®é¢˜å°±å‡ºåœ¨äº†è¿™é‡Œã€‚ ","date":"2019-03-26","objectID":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/:0:2","tags":["kubernetes"],"title":"Statefulsetåˆ›å»ºpodæ…¢","uri":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/"},{"categories":["é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"è§£å†³æ–¹æ¡ˆ æƒ³åˆ°ä¸¤ç§ä¼˜åŒ–æ–¹æ¡ˆ å»æ‰å®šæœŸï¼ˆ30sï¼‰å…¨é‡åŒæ­¥çš„æœºåˆ¶ï¼Œç›®å‰çœ‹å…¶ä»–controllerï¼Œå¦‚ReplicationControllerï¼ŒServiceControllerï¼ŒEndpointsControllerç­‰éƒ½æ²¡æœ‰è®¾ç½®å®šæœŸå…¨é‡åŒæ­¥ ä¿ç•™å®šæœŸåŒæ­¥ï¼Œæ·»åŠ å·²å¤„ç†çš„stsçš„ç¼“å­˜ï¼Œæ¯æ¬¡ä»queueä¸­æ‹¿åˆ°ä¸€ä¸ªæ–°çš„stsæ—¶ï¼Œæ¯”è¾ƒå·²å¤„ç†ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒçš„sts(resourceversionç›¸åŒ)ï¼Œå­˜åœ¨åˆ™å¿½ç•¥æ­¤stsï¼Œå¦åˆ™è¿›è¡Œå¤„ç† ","date":"2019-03-26","objectID":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/:0:3","tags":["kubernetes"],"title":"Statefulsetåˆ›å»ºpodæ…¢","uri":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/"},{"categories":["é—®é¢˜æ’æŸ¥","æ€§èƒ½ä¼˜åŒ–"],"content":"ç¤¾åŒº ä¸Šè¿°é—®é¢˜å·²åé¦ˆç¤¾åŒºï¼Œä¿®å¤æ–¹å¼å°±æ˜¯æ–¹æ¡ˆ1ï¼Œç›´æ¥å»æ‰äº†30sçš„åŒæ­¥æœºåˆ¶ã€‚è§https://github.com/kubernetes/kubernetes/pull/75622 è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼š30sçš„åŒæ­¥æœºåˆ¶å¹¶ä¸æ˜¯ä»kube-apiserveræ‹‰å–å…¨é‡æ•°æ®ï¼Œè€Œæ˜¯æŠŠInformeræœ¬åœ°ç¼“å­˜çš„æ•°æ®ï¼ˆä½äºIndexerä¸­ï¼‰å…¨é‡åŒæ­¥ä¸€éï¼Œç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢å‡ºç°åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ä¸å¤–éƒ¨ç»„ä»¶äº¤äº’æ—¶å‡ºé”™çš„æƒ…å†µï¼Œå‚è€ƒè¿™ä¸ªissueï¼šhttps://github.com/kubernetes/kubernetes/issues/75495ï¼Œä½†æ˜¯stsæ§åˆ¶å™¨æœ¬èº«æ²¡æœ‰ä¾èµ–ä»»ä½•å¤–éƒ¨ï¼ˆk8sä»¥å¤–ï¼‰ç»„ä»¶ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦30såŒæ­¥äº†ã€‚ä½†æ˜¯æˆ‘ä»¬ä»¥Operatorå®ç°çš„è‡ªå®šä¹‰Controllerå°±éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¿€è¿›å‹è®¾ç½®äº†ï¼Œåé¢ä¼šä¸“é—¨æœ‰ä¸€ä¸ªç³»åˆ—è¯¦ç»†è®²Informerçš„æºç ï¼Œæ•¬è¯·æœŸå¾…ã€‚ ","date":"2019-03-26","objectID":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/:0:4","tags":["kubernetes"],"title":"Statefulsetåˆ›å»ºpodæ…¢","uri":"https://www.likakuli.com/posts/kubernetes-statefulset-sync/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"etcd watchå†…å­˜æ³„éœ²","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-watch/","tags":["etcd"],"title":"Etcd watchå†…å­˜æ³„æ¼","uri":"https://www.likakuli.com/posts/etcd-watch/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"èƒŒæ™¯ é€šè¿‡ç›‘æ§çœ‹åˆ°å¼¹æ€§äº‘ç”¨æˆ·å¹³å°åç«¯ç¨‹åºkube-odinçš„å†…å­˜ä½¿ç”¨é‡åœ¨ç¨³å®šå¢åŠ ï¼Œæ¯æ¬¡ä¸Šçº¿å®Œåˆä¼šæ¢å¤ï¼Œå¯ä»¥åˆ¤æ–­å‡ºkube-odinä¸­å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ ","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-watch/:0:1","tags":["etcd"],"title":"Etcd watchå†…å­˜æ³„æ¼","uri":"https://www.likakuli.com/posts/etcd-watch/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥è¿‡ç¨‹ golangç¨‹åºçš„é—®é¢˜æ’æŸ¥ï¼Œæ— è®ºCPUè¿˜æ˜¯Memoryé—®é¢˜éƒ½å¯ä»¥ç”¨å®˜æ–¹æä¾›çš„pprofå·¥å…·ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯åœ¨kube-odinä»£ç åŠ å…¥å¦‚ä¸‹åŒ…net/http/pprofï¼Œä¸Šçº¿åˆ°äº†æµ‹è¯•ç¯å¢ƒï¼Œç„¶åé€šè¿‡go tool pprof httpaddressçš„æ–¹å¼æŸ¥çœ‹kube-odinå†…å­˜æ¶ˆè€—ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤špprofä½¿ç”¨æ–¹æ³•çš„æ–‡ç« ï¼Œå¯ä»¥è‡ªè¡Œæœç´¢ï¼ŒçŸ¥é“æ€ä¹ˆç”¨äº†ä¹‹åçœ‹ä¸‹å›¾ ç”±äºæ˜¯æµ‹è¯•ç¯å¢ƒï¼Œå¯¹æ¥æµ‹è¯•é›†ç¾¤ï¼Œæœ¬èº«æ•°æ®é‡å°±ä¸å¤§ï¼Œç¨‹åºåˆšå¯åŠ¨æ—¶å ç”¨å†…å­˜ä¹Ÿå°±ç™¾åæ¥Mï¼Œç°åœ¨å·²ç»ç”¨äº†1Gå¤šï¼Œå ç”¨å†…å­˜æœ€å¤šçš„æ˜¯newWatcherGrpcStreamå‡½æ•°ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å‡½æ•°ï¼Œå ç”¨çš„å†…å­˜ä¹Ÿåœ¨é€æ­¥å¢åŠ ï¼Œå…ˆçœ‹newWatcherGrpcStreamå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡listæŸ¥çœ‹å…¶å…·ä½“å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹å›¾ fmt.Sprintfå±…ç„¶éƒ½å ç”¨äº†86.01Må†…å­˜ï¼Œè¿˜æœ‰å‡ ä¸ªchanå ç”¨çš„ä¹Ÿæ¯”è¾ƒå¤šï¼Œä½†æ˜¯åŸºæœ¬éƒ½æ˜¯æ— ç¼“å­˜çš„chanï¼Œæ­£å¸¸ä¸ä¼šå ç”¨è¿™ä¹ˆå¤šçš„ã€‚ä¸€èˆ¬å†…å­˜æ³„éœ²å¯èƒ½æ˜¯æµæœªå…³é—­ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬æ–‡ä»¶æè¿°ç¬¦ä¹Ÿä¼šæ³„éœ²ï¼Œå¦å¤–å°±æ˜¯ç”¨åˆ°ç¼“å­˜æ—¶ä¹Ÿå®¹æ˜“é€ æˆæ³„éœ²ï¼Œå¦‚æœç¼“å­˜çš„å†…å®¹å¾—ä¸åˆ°é‡Šæ”¾ä¸”ä¸€ç›´å¢åŠ å†…å®¹ï¼Œå†…å­˜å°±ä¼šè¶Šæ¥è¶Šé«˜ã€‚å»çœ‹etcdç›¸å…³ä»£ç ï¼Œåœ¨ä»£ç ä¸­æ‰¾é—®é¢˜ï¼Œå‘ç°äº†ä¸€å¤„å¾ˆå¯ç–‘çš„ä»£ç ï¼Œå»æ‰äº†æ— å…³å†…å®¹ï¼Œä¸”å¢åŠ äº†fmt.Printlnç›¸å…³å‡½æ•°ï¼Œæ–¹ä¾¿è§‚å¯Ÿæ¯æ¬¡è¿è¡Œåˆ°æ­¤å¤„çš„ç¼“å­˜çš„ç»“æœï¼Œå¦‚ä¸‹ // Watch posts a watch request to run() and waits for a new watcher channel func (w *watcher) Watch(ctx context.Context, key string, opts ...OpOption) WatchChan { ... ctxKey := fmt.Sprintf(\"%v\", ctx) // find or allocate appropriate grpc watch stream w.mu.Lock() if w.streams == nil { // closed w.mu.Unlock() ch := make(chan WatchResponse) close(ch) return ch } fmt.Println(ctxKey) // æ‰“å°ç¼“å­˜çš„key fmt.Println(len(w.streams)) //æ‰“å°ç¼“å­˜æ•°é‡ wgs := w.streams[ctxKey] if wgs == nil { fmt.Println(\"new watcher stream\") //ç¼“å­˜é‡Œæ²¡æœ‰å¯¹åº”çš„key wgs = w.newWatcherGrpcStream(ctx) w.streams[ctxKey] = wgs }else{ fmt.Println(\"use exist watcher stream\") //ç¼“å­˜é‡Œæœ‰keyï¼Œå¤ç”¨ç¼“å­˜ } ... } // watcher implements the Watcher interface type watcher struct { remote pb.WatchClient // mu protects the grpc streams map mu sync.RWMutex // streams holds all the active grpc streams keyed by ctx value. streams map[string]*watchGrpcStream } è¿™é‡Œå‡ºç°äº†ä¸Šé¢çš„fmt.Sprintfã€newWatcherGrpcStreamç­‰å‡½æ•°ï¼Œè€Œä¸”å‡ºç°äº†ç¼“å­˜ï¼Œå³w.streamsï¼Œæ¯æ¬¡watchæ—¶éƒ½æ˜¯å…ˆè°ƒç”¨fmt.Sprintfè·å–åˆ°keyï¼Œå†ä»ç¼“å­˜ä¸­å–ï¼Œå¦‚æœæœ‰åˆ™å¤ç”¨ï¼Œæ²¡æœ‰åˆ™æ–°å»ºï¼Œé—®é¢˜å¾ˆæœ‰å¯èƒ½å‡ºç°åœ¨è¿™é‡Œï¼Œç„¶åå†æ‰¾ä¸€ä¸‹ç¼“å­˜åˆ é™¤æ•°æ®çš„é€»è¾‘ï¼Œå¦‚ä¸‹ func (w *watcher) Close() (err error) { w.mu.Lock() fmt.Println(\"begin close watcher\") streams := w.streams w.streams = nil w.mu.Unlock() for _, wgs := range streams { if werr := wgs.Close(); werr != nil { err = werr } } return err } func (w *watcher) closeStream(wgs *watchGrpcStream) { w.mu.Lock() fmt.Println(\"delete watch stream\") //å¼€å§‹åˆ é™¤ç¼“å­˜ close(wgs.donec) wgs.cancel() if w.streams != nil { fmt.Println(\"before delete:\",len(w.streams)) //åˆ é™¤å‰ç¼“å­˜æ•°é‡ fmt.Println(wgs.ctxKey) if _,ok:=w.streams[wgs.ctxKey];ok{ fmt.Println(\"delete key exist\") //åˆ é™¤çš„keyåœ¨ç¼“å­˜é‡Œå­˜åœ¨ } else{ fmt.Println(\"delete key NOT exist\") //åˆ é™¤çš„keyåœ¨ç¼“å­˜é‡Œä¸å­˜åœ¨ } delete(w.streams, wgs.ctxKey) fmt.Println(\"after delete:\",len(w.streams)) //åˆ é™¤åç¼“å­˜çš„æ•°é‡ } w.mu.Unlock() } å’Œåˆ é™¤ç¼“å­˜ç›¸å…³çš„å‡½æ•°æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªCloseå‡½æ•°åªæœ‰åœ¨etcdclientçš„å…³é—­é“¾æ¥æ—¶æ‰ä¼šè°ƒç”¨ï¼Œè€Œæˆ‘ä»¬åœ¨ä¸æ–­çš„lockï¼Œunlockæ—¶å…¶å®ç”¨çš„æ˜¯åŒä¸€ä»½etcdclientï¼Œæ‰€ä»¥ä¸ä¼šæ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°ã€‚è¿˜å‰©ä¸€ä¸ªcloseStreamå‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä¹ŸåŠ äº†ä¸€äº›æ‰“å°ä¿¡æ¯ï¼Œç”¨æ¥æŸ¥çœ‹ç¼“å­˜ç›¸å…³ä¿¡æ¯ï¼ŒcloseStreamè°ƒç”¨å¦‚ä¸‹ func (w *watcher) newWatcherGrpcStream(inctx context.Context) *watchGrpcStream { ... go wgs.run() return wgs } // run is the root of the goroutines for managing a watcher client func (w *watchGrpcStream) run() { ... defer func() { ... w.owner.closeStream(w) }() ... } æ•´ä¸ªè¿‡ç¨‹ä»æ’å…¥ç¼“å­˜åˆ°åˆ é™¤ç¼“å­˜çœ‹èµ·æ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œåªèƒ½å†™ä¸ªdemoæµ‹è¯•ä¸€ä¸‹äº†ï¼Œdemoå¤§è‡´å¦‚ä¸‹ func main() { client := instance.GetEtcdClient() locker := lock.New(client, lock.WithTTL(1*time.Second)) go foo(locker) http.HandleFunc(\"/gc\", func(writer http.ResponseWriter, request *http.Request) { runtime.GC() }) http.ListenAndServe(\":8080\", nil) } func foo(locker lock.Locker) { ticker := time.NewTicker(1 * time.Second) ids := []string{\"1\", \"2\", \"3\", \"4\", \"5\", \"6\", \"7\", \"8\", \"9\", \"10\"} for range ticker.C { for _, v := range ids { go func(i string) { unlock, _, err := locker.Trylock(context.TODO(), fmt.Sprintf(\"%s/%s\", \"/kaku/test/etcd/lock\", i)) if err != nil { if err != context.DeadlineExceeded { fmt.Println(\"lock task failed:%s\", err) } return } //fmt.Println(\"task has been locked\") defer func() { time.Sleep(time.Second) unlock() //fmt.Println(\"task has been unlocked\") }() }(v) } } } ç‰¹åˆ«ç®€å•ï¼Œå°±æ˜¯ä¸æ–­çš„å»lockï¼Œunlockï¼Œç»“åˆä¹‹å‰å¢åŠ çš„ä¸€äº›ç¼“å­˜æ‰“å°ä¿¡æ¯ï¼Œè¿è¡Œdemoï¼Œç»“æœå¦‚ä¸‹ context.TODO.WithCancel.WithDeadline(2019-01-27 12:03:04.293267 +0800 CST m=+3.078016721 [750.274218ms]).WithCancel 0 new watcher stream context.TODO.WithCancel.WithDeadline(2019-01-27 12:03:04.293375 +0800 CST m=+3.078124824 [704.968531ms]).WithCancel 1 new watcher stream context.TODO.WithCancel.WithDeadline(2019-01-27 12:03:04.293271 +0800 CST m=+3.078020","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-watch/:0:2","tags":["etcd"],"title":"Etcd watchå†…å­˜æ³„æ¼","uri":"https://www.likakuli.com/posts/etcd-watch/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"è§£å†³æ–¹æ¡ˆ å‡çº§etcdåŒ…ç‰ˆæœ¬è‡³å°‘åˆ°3.2.20 ","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-watch/:0:3","tags":["etcd"],"title":"Etcd watchå†…å­˜æ³„æ¼","uri":"https://www.likakuli.com/posts/etcd-watch/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-lock/","tags":["etcd"],"title":"Etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","uri":"https://www.likakuli.com/posts/etcd-lock/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"ç°è±¡ çº¿ä¸Šç¨‹åºä¸€ç›´æŠ¥é”™ï¼Œé”™è¯¯ä¿¡æ¯ï¼šlock failed: context deadline exceeded, retry ","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-lock/:0:1","tags":["etcd"],"title":"Etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","uri":"https://www.likakuli.com/posts/etcd-lock/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ’æŸ¥è¿‡ç¨‹ å¼‚å¸¸å¯¹åº”ä»£ç ä½ç½® å¾ˆæ˜æ˜¾çš„æ˜¯è·å–é”è¶…æ—¶äº†ï¼Œç”±äºç”¨çš„etcdçš„åˆ†å¸ƒå¼é”ï¼Œå°±æ€€ç–‘æ˜¯etcdå‡ºé—®é¢˜äº†ï¼Œæ­¤æ—¶çœ‹åˆ°å¤§é‡etcdæ—¥å¿—ï¼Œrejected connection from â€œip:portâ€ (error â€œtls: first record does not look like a TLS handshakeâ€, ServerName â€œ\")ï¼Œæ€€ç–‘æ˜¯ä¸æ˜¯è¿™ä¸ªé—®é¢˜å¯¼è‡´çš„ï¼Œç»è¿‡æŸ¥è¯¢æŠ¥é”™çš„IPï¼Œå‡ä¸ºçº¿ä¸Šå®¹å™¨IPï¼Œç™»é™†å®¹å™¨å†…çœ‹å‘ç°éƒ½æ˜¯ç®¡ç†å‘˜å¹³å°çš„ä»£ç ï¼Œé‡Œé¢ä¹Ÿç”¨åˆ°äº†py03çš„etcdï¼Œä½†æ˜¯ä¸æ˜¯å¯¼è‡´è¶…æ—¶çš„åŸå› ã€‚åœ¨æ’é™¤å„ç§å¯èƒ½ä¹‹åï¼Œæœ€åå»etcdæŸ¥çœ‹é”å¯¹åº”çš„keyçš„æƒ…å†µï¼Œå‘ç°æœ‰ä¸¤ä¸ªkey /notifier/locker/{leaseid} /notifier/locker/rwl/{leaseid} å…¶ä¸­ç¬¬ä¸€ä¸ªkeyæ˜¯notifierè‡ªå·±æ·»åŠ çš„ï¼Œç¬¬äºŒä¸ªkeyåœ¨ä»£ç ä¸­æœä¸åˆ°ï¼Œä½†æ˜¯çœ‹èµ·æ¥åƒæ˜¯redis whitelistçš„ç®€å†™ï¼Œå…ˆæŠŠç¬¬ä¸€ä¸ªkeyåˆ äº†ï¼Œç„¶åçœ‹notifieræ—¥å¿—ï¼Œä»ç„¶è·å–ä¸åˆ°é”ï¼Œæ‰€ä»¥æ€€ç–‘æ˜¯ç¬¬äºŒä¸ªkeyå·²ç»è·å¾—äº†é”ï¼Œè™½ç„¶keyä¸ä¸€æ ·ã€‚äºæ˜¯åˆ é™¤äº†ç¬¬äºŒä¸ªkeyï¼Œå†çœ‹notifieræ—¥å¿—ï¼Œç»ˆäºè·å¾—äº†é”ï¼Œå¼€å§‹æ­£å¸¸å·¥ä½œï¼Œäºæ˜¯å¾—å‡ºçŒœæƒ³ï¼Œetcd****çš„åˆ†å¸ƒå¼é”ï¼Œåœ¨å­ç›®å½•ä¸‹åŠ äº†é”ä¹‹åï¼Œçˆ¶ç›®å½•ä¼šåŠ é”å¤±è´¥ã€‚ç„¶åç”¨etcdctl lockæ¥éªŒè¯äº†ä¸‹ï¼Œç¡®å®å¦‚æ­¤ï¼Œ/a/bä¸‹åŠ äº†é”ï¼Œ/aå†åŠ é”å°±ä¼šå¤±è´¥ï¼Œä½†æ˜¯/aä¸‹åŠ äº†é”ï¼Œ/a/bå†åŠ é”ä¼šæˆåŠŸã€‚åŸºæœ¬ä¸Šå¯ä»¥éªŒè¯ä¸Šé¢çš„çŒœæƒ³ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä»etcdæºç ä¸­æ‰¾åˆ°å¯¹åº”å¤„ç†çš„ä»£ç äº†ã€‚ ","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-lock/:0:2","tags":["etcd"],"title":"Etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","uri":"https://www.likakuli.com/posts/etcd-lock/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"etcdæºç éƒ¨åˆ† åœ¨æŸ¥è¯¢æºç ä¹‹å‰ï¼Œç¬¬ä¸€ååº”å°±æ˜¯è¿™è‚¯å®šæ˜¯åœ¨æœåŠ¡ç«¯å®ç°çš„ï¼Œäºæ˜¯å¼€å§‹äº†ä»etcdæœåŠ¡ç«¯æ‰¾ç›¸å…³æºç çš„è¿‡ç¨‹ï¼Œä»etcdctlå‘½ä»¤å¼€å§‹è¿½æº¯åˆ°æ‰€æ¶‰åŠçš„æœåŠ¡ç«¯ï¼Œä¸€ç›´æ²¡æœ‰å‘ç°é—®é¢˜ã€‚åˆåœ¨ç½‘ä¸Šæœäº†ç›¸å…³etcdæœåŠ¡ç«¯æºç å®ç°çš„æ–‡ç« ï¼Œç»“åˆæœ¬åœ°ä»£ç å‡æ²¡æœ‰æƒ³æ‰¾çš„ä»£ç ï¼Œäºæ˜¯åè¿‡æ¥ä»clientæ‰¾èµ·ã€‚ é¦–å…ˆä»etcdctl lockå‘½ä»¤å¼€å§‹ï¼ŒæŒ‘ä¸»è¦å‡½æ•°å±•ç¤º // ä»£ç ä½ç½®go.etcd.io/etcd/etcdctl/ctlv3/command/lock_command.go func lockUntilSignal(c *clientv3.Client, lockname string, cmdArgs []string) error { ... if err := m.Lock(ctx); err != nil { return err } ... } æ¥ä¸‹æ¥è¿›å…¥åˆ°Lockå‡½æ•°ï¼Œè¿™æ˜¯ä¸ªå…³é”®å‡½æ•°ï¼Œetcdçš„åˆ†å¸ƒå¼é”å°±æ˜¯åœ¨è¿™é‡Œå®ç°çš„ func (m *Mutex) Lock(ctx context.Context) error { s := m.s client := m.s.Client() // è¿™é‡Œçš„pfxå°±æ˜¯prefixï¼Œå°±æ˜¯ä¼ è¿›æ¥çš„å‰ç¼€ï¼Œåé¢çš„s.Lease()ä¼šè¿”å›ä¸€ä¸ªç§Ÿçº¦ï¼Œæ˜¯ä¸€ä¸ªint64çš„æ•´æ•°ï¼Œå’Œsessionæœ‰å…³ m.myKey = fmt.Sprintf(\"%s%x\", m.pfx, s.Lease()) // è¿™é‡Œæ¯”è¾ƒä¸Šé¢prefix/leaseçš„createrevisionæ˜¯å¦ä¸º0ï¼Œä¸º0è¡¨ç¤ºç›®å‰ä¸å­˜åœ¨è¯¥keyï¼Œéœ€è¦æ‰§è¡ŒPutæ“ä½œï¼Œä¸‹é¢å¯ä»¥çœ‹åˆ° // ä¸ä¸º0è¡¨ç¤ºå·²ç»æœ‰å¯¹åº”çš„keyäº†ï¼Œåªéœ€è¦æ‰§è¡ŒGetå°±è¡Œ // createrevisionæ˜¯è‡ªå¢çš„ cmp := v3.Compare(v3.CreateRevision(m.myKey), \"=\", 0) // put self in lock waiters via myKey; oldest waiter holds lock put := v3.OpPut(m.myKey, \"\", v3.WithLease(s.Lease())) // reuse key in case this session already holds the lock get := v3.OpGet(m.myKey) // è·å–æ‰€å¾—æŒæœ‰è€… getOwner := v3.OpGet(m.pfx, v3.WithFirstCreate()...) resp, err := client.Txn(ctx).If(cmp).Then(put, getOwner).Else(get, getOwner).Commit() if err != nil { return err } m.myRev = resp.Header.Revision if !resp.Succeeded { m.myRev = resp.Responses[0].GetResponseRange().Kvs[0].CreateRevision } // if no key on prefix / the minimum rev is key, already hold the lock ownerKey := resp.Responses[1].GetResponseRange().Kvs // æ¯”è¾ƒå¦‚æœå½“å‰æ²¡æœ‰äººè·å¾—é”æˆ–è€…é”çš„ownerçš„createrevisionç­‰äºå½“å‰çš„kvçš„revisionï¼Œåˆ™è¡¨ç¤ºå·²è·å¾—é”ï¼Œå°±å¯ä»¥é€€å‡ºäº† if len(ownerKey) == 0 || ownerKey[0].CreateRevision == m.myRev { m.hdr = resp.Header return nil } // ä¸ºäº†éªŒè¯è‡ªå·±åŠ çš„æ‰“å°ä¿¡æ¯ //fmt.Printf(\"ownerKey: %s\\n\", ownerKey) // èµ°åˆ°è¿™é‡Œä»£è¡¨æ²¡æœ‰è·å¾—é”ï¼Œéœ€è¦ç­‰å¾…ä¹‹å‰çš„é”è¢«é‡Šæ”¾ï¼Œå³revisionå°äºå½“å‰revisionçš„kvè¢«åˆ é™¤ hdr, werr := waitDeletes(ctx, client, m.pfx, m.myRev-1) // release lock key if wait failed if werr != nil { m.Unlock(client.Ctx()) } else { m.hdr = hdr } return werr } // waitDeletes ç­‰å¾…æ‰€æœ‰å½“å‰æ¯”å½“å‰keyçš„revisionå°çš„keyè¢«åˆ é™¤åï¼Œé”é‡Šæ”¾åæ‰è¿”å› func waitDeletes(ctx context.Context, client *v3.Client, pfx string, maxCreateRev int64) (*pb.ResponseHeader, error) { getOpts := append(v3.WithLastCreate(), v3.WithMaxCreateRev(maxCreateRev)) for { resp, err := client.Get(ctx, pfx, getOpts...) if err != nil { return nil, err } if len(resp.Kvs) == 0 { return resp.Header, nil } lastKey := string(resp.Kvs[0].Key) // ä¸ºäº†è°ƒè¯•è‡ªå·±åŠ çš„è¿™å¥ fmt.Printf(\"wait for %s to delete\\n\", lastKey) if err = waitDelete(ctx, client, lastKey, resp.Header.Revision); err != nil { return nil, err } } } func waitDelete(ctx context.Context, client *v3.Client, key string, rev int64) error { cctx, cancel := context.WithCancel(ctx) defer cancel() var wr v3.WatchResponse // wchæ˜¯ä¸ªchannelï¼Œkeyè¢«åˆ é™¤åä¼šå¾€è¿™ä¸ªchanå‘æ•°æ® wch := client.Watch(cctx, key, v3.WithRev(rev)) for wr = range wch { for _, ev := range wr.Events { if ev.Type == mvccpb.DELETE { return nil } } } if err := wr.Err(); err != nil { return err } if err := ctx.Err(); err != nil { return err } return fmt.Errorf(\"lost watcher waiting for delete\") } çœ‹å®Œä¸Šé¢çš„ä»£ç åŸºæœ¬çŸ¥é“äº†etcdåˆ†å¸ƒå¼é”çš„å®ç°æœºåˆ¶äº†ï¼Œä½†æ˜¯è¿˜æ²¡çœ‹åˆ°å“ªé‡Œå’Œå‰ç¼€Prefixç›¸å…³äº†ã€‚å…¶å®ç­”æ¡ˆå°±è—åœ¨getOwneré‡Œï¼Œçœ‹ä¸Šè¿°ä»£ç ï¼Œä¸ç®¡æ˜¯æ‰§è¡ŒPutè¿˜æ˜¯Getï¼Œæœ€ç»ˆéƒ½æœ‰ä¸ªgetOwnerçš„è¿‡ç¨‹ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªgetOwnerï¼Œoptionsæ¨¡å¼é‡Œæœ‰ä¸ªv3.WithFirstCreateå‡½æ•°è°ƒç”¨ï¼Œçœ‹ä¸‹è¿™ä¸ªå‡½æ•° // WithFirstCreate gets the key with the oldest creation revision in the request range. func WithFirstCreate() []OpOption { return withTop(SortByCreateRevision, SortAscend) } // withTop gets the first key over the get's prefix given a sort order func withTop(target SortTarget, order SortOrder) []OpOption { return []OpOption{WithPrefix(), WithSort(target, order), WithLimit(1)} } // WithPrefix enables 'Get', 'Delete', or 'Watch' requests to operate // on the keys with matching prefix. For example, 'Get(foo, WithPrefix())' // can return 'foo1', 'foo2', and so on. func WithPrefix() OpOption { return func(op *Op) { if len(op.key) == 0 { op.key, op.end = []byte{0}, []byte{0} return } op.end = getPrefix(op.key) } } çœ‹åˆ°ä¸Šé¢çš„æ˜¯ä¸‰ä¸ªå‡½æ•°åï¼Œå¤§è‡´å°±æ‰¾åˆ°äº†å¯¹åº”çš„æºç çš„æ„Ÿè§‰ï¼Œå› ä¸ºçœ‹åˆ°äº†WithPrefixå‡½æ•°ï¼Œå’Œä¸Šé¢çš„çŒœæµ‹æ­£å¥½åŒ¹é…ã€‚æ‰€ä»¥getOwnerçš„å…·ä½“æ‰§è¡Œæ•ˆæœæ˜¯ä¼šæŠŠæ‰€æœ‰ä»¥lockkeyå¼€å¤´çš„kvéƒ½æ‹¿åˆ°ï¼Œä¸”æŒ‰ç…§createrevisionå‡åºæ’åˆ—ï¼Œå–ç¬¬ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªæ„æ€å°±å¾ˆæ˜ç™½äº†ï¼Œå°±æ˜¯è¦æ‹¿åˆ°å½“å‰ä»¥lockkeyä¸ºprefixçš„ä¸”createrevisionæœ€å°çš„é‚£ä¸ªkeyï¼Œå°±æ˜¯","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-lock/:0:3","tags":["etcd"],"title":"Etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","uri":"https://www.likakuli.com/posts/etcd-lock/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æ€»ç»“ é€šè¿‡åˆ†æé—®é¢˜ï¼Œçœ‹æºç ï¼Œå¯ä»¥äº†è§£åˆ°etcdé”çš„å®ç°åŸç†ï¼Œä»¥åŠå¯èƒ½å­˜åœ¨çš„å°å‘ã€‚etcdå±…ç„¶æŠŠé”çš„å®ç°æ”¾åœ¨äº†clientç«¯ï¼Œä¹Ÿæ˜¯å‡ºä¹æˆ‘çš„æ„æ–™ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹clientç«¯ä»£ç æ¥ä¿®æ”¹å…¶é”çš„å®ç°ï¼Œå°±å¯èƒ½å‡ºç°è™½ç„¶å…±ç”¨ä¸€ä¸ªæœåŠ¡ç«¯ï¼Œä½†æ˜¯etcdè¡Œä¸ºå´ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä¸çŸ¥é“ä¸ºä½•è¦è¿™ä¹ˆè®¾è®¡ï¼Œä¸ªäººæ„Ÿè§‰è¿˜æ˜¯è¦æ”¾åˆ°æœåŠ¡ç«¯æ›´å¥½äº›ã€‚ ","date":"2019-01-31","objectID":"https://www.likakuli.com/posts/etcd-lock/:0:4","tags":["etcd"],"title":"Etcdåˆ†å¸ƒå¼é”åŠ é”å¤±è´¥","uri":"https://www.likakuli.com/posts/etcd-lock/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"docker image p2p","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"æµ‹è¯•ç¯å¢ƒ 10.0.13.19 éƒ¨ç½²harborï¼Œå•ç‚¹ï¼Œdocker-composeçš„æ–¹å¼éƒ¨ç½² 4æ ¸8G 10.0.13.22 dragonflyçš„supernodeèŠ‚ç‚¹ 16æ ¸64G dockeræ–¹å¼éƒ¨ç½² 10.0.13.31 dragonflyçš„supernodeèŠ‚ç‚¹ 16æ ¸64G dockeræ–¹å¼éƒ¨ç½² kubernetes é›†ç¾¤ 20ä¸ªèŠ‚ç‚¹ ï¼Œdocker storage-driver overlay éƒ¨ç½²äº†dragonflyçš„daemonå’Œdfgetç­‰ç¨‹åº ä»¥ä¸Šå‡ä¸ºè™šæœºï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µå†…ï¼Œcentos7.4ç³»ç»Ÿ æ¶‰åŠåˆ°çš„ansibleè„šæœ¬åœ¨è¿™é‡Œ ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:1:0","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"dragonfly ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:2:0","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç‰¹æ€§ åŸºäºP2Pæ–‡ä»¶åˆ†å‘ æ”¯æŒå„ç§å®¹å™¨åŒ–æŠ€æœ¯ ä¸»æœºçº§åˆ«é™é€Ÿç­–ç•¥ åˆ©ç”¨CDNæœºåˆ¶é¿å…è¿œç¨‹é‡å¤ä¸‹è½½ å¼ºä¸€è‡´æ€§ ç£ç›˜ä¿æŠ¤,é«˜æ•ˆçš„IOå¤„ç† é«˜æ€§èƒ½ å¼‚å¸¸è‡ªåŠ¨éš”ç¦» é™ä½æ–‡ä»¶æ¥æºæœåŠ¡å™¨å‹åŠ› æ”¯æŒæ ‡å‡†çš„Http Header ä½¿ç”¨ç®€å• ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:2:1","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç»“æ„ä»‹ç» åˆ†å‘æ™®é€šæ–‡ä»¶ æ³¨: å…¶ä¸­cluster managerå³è¶…çº§èŠ‚ç‚¹(supernode) è¶…çº§èŠ‚ç‚¹å……å½“CDNï¼ŒåŒæ—¶è°ƒåº¦æ¯ä¸ªå¯¹ç­‰è€…(peer)åœ¨ä»–ä»¬ä¹‹é—´ä¼ è¾“æ–‡ä»¶å—ã€‚dfgetæ˜¯P2På®¢æˆ·ç«¯ï¼Œä¹Ÿç§°ä¸ºå¯¹ç­‰è€…(peer)ï¼Œä¸»è¦ç”¨äºä¸‹è½½å’Œå…±äº«æ–‡ä»¶å—ã€‚ åˆ†å‘å®¹å™¨é•œåƒ å›¾ä¸­é•œåƒä»“åº“(registry)ç±»ä¼¼äºæ–‡ä»¶æœåŠ¡å™¨ã€‚dfget proxyä¹Ÿç§°ä¸ºdfdaemonï¼Œå®ƒæ‹¦æˆªæ¥è‡ªdocker pullå’Œdocker pushçš„HTTPè¯·æ±‚ï¼Œç„¶åå°†é‚£äº›è·Ÿé•œåƒåˆ†å±‚ç›¸å…³çš„è¯·æ±‚ä½¿ç”¨dfgetæ¥å¤„ç†ã€‚ æ–‡ä»¶åˆ†å—æ˜¯æ€ä¹ˆä¸‹è½½çš„ æ³¨: å…¶ä¸­cluster managerå³è¶…çº§èŠ‚ç‚¹(supernode) æ¯ä¸ªæ–‡ä»¶ä¼šè¢«åˆ†æˆå¤šä¸ªå—åœ¨å¯¹ç­‰è€…(peer)é—´è¿›è¡Œä¼ è¾“ã€‚ä¸€ä¸ªpeerå°±æ˜¯ä¸€ä¸ªP2På®¢æˆ·ç«¯ã€‚ è¶…çº§èŠ‚ç‚¹ä¼šåˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨æœ¬åœ°ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šå°†å…¶ä»æ–‡ä»¶æœåŠ¡å™¨ä¸‹è½½åˆ°æœ¬åœ°ã€‚ ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:2:2","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"æµç¨‹è§£æ 1.å½“æ‰§è¡Œdocker pullæ“ä½œæ—¶,dfget-proxyä¼šæ‹¦æˆªdocker pullè¯·æ±‚ã€‚å°†è¯·æ±‚è½¬å‘ç»™CM(cluster manager)ã€‚ cmçš„åœ°å€å·²ç»åœ¨clientä¸»æœºçš„/etc/dragonfly.confæ–‡ä»¶ä¸­é…ç½®å¥½äº†ã€‚å¦å¤–ä¸Šæ–‡ä¸­æåˆ°çš„dfget-proxyå…¶å®å°±æ˜¯df-daemonã€‚Dragonflyä¸­æœ‰ä¸‰ä¸ªé¡¹ç›®,clientç«¯:getter(python)ã€daemon(golang),docker pullæ—¶,df-daemonæ‹¦æˆªåˆ°è¯·æ±‚å¹¶é€šè¿‡dfgetè¿›è¡Œæ–‡ä»¶æ‹‰å–,serverç«¯:supernode(java)ã€‚ 2.df-daemonå¯åŠ¨çš„æ—¶å€™å¸¦äº†registryå‚æ•°,å¹¶ä¸”é€šè¿‡dfgetä¼ ç»™æœåŠ¡ç«¯supernodeã€‚supernodeè§£æå‚æ•°åˆ°å¯¹åº”çš„é•œåƒä»“åº“è·å–é•œåƒå¹¶ä»¥blockçš„å½¢å¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å¦‚æœå†æ¬¡æ‹‰å–é•œåƒæ—¶,supernodeå°±ä¼šæ£€æµ‹å“ªä¸€ä¸ªclientå­˜åœ¨å’Œé•œåƒæ–‡ä»¶å¯¹åº”çš„block,å¦‚æœå­˜åœ¨ç›´æ¥ä»è¯¥clientä¸‹è½½,å¦‚æœä¸å­˜åœ¨å°±é€šè¿‡serverç«¯åˆ°é•œåƒä»“åº“æ‹‰å–é•œåƒã€‚ ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:2:3","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å®‰è£…éƒ¨ç½² ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:3:0","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å®‰è£…æœåŠ¡ç«¯ Dragonflyå®˜æ–¹æ”¯æŒåŸºäºDockerå’ŒPhysical Machineä¸¤ç§æ–¹æ¡ˆéƒ¨ç½²serverï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ç›´æ¥ä½¿ç”¨dockeræ–¹å¼éƒ¨ç½²ã€‚ docker run -d -p 8001:8001 -p 8002:8002 --restart=always registry.cn-hangzhou.aliyuncs.com/alidragonfly/supernode:0.2.0 ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:3:1","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å®‰è£…å®¢æˆ·ç«¯ #ä¸‹è½½ æ­¤é“¾æ¥ä¸º0.1.0ç‰ˆæœ¬ wget https://github.com/alibaba/Dragonfly/raw/master/package/df-client.linux-amd64.tar.gz #è§£å‹ tar -zxvf df-client.linux-amd64.tar.gz #è®¾ç½®Env vim ~/.bashrc #å°†ä¸‹é¢çš„è®¾ç½®æ·»åŠ åˆ°~/.bashrcæ–‡ä»¶æœ« PATH=$PATH:/root/df-client #é€€å‡ºvimå¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ source ~/.bashrc ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:3:2","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Harboræ­å»º åŸºäºåœ¨çº¿æ–¹å¼çš„å®‰è£…, æœ¬æ–‡é‡‡ç”¨httpçš„æ–¹å¼é…ç½®Harborã€‚Harborç‰ˆæœ¬ä¸º1.2.2 1.ä¸‹è½½ wget https://storage.googleapis.com/harbor-releases/harbor-online-installer-v1.5.2.tgz tar -zxvf harbor-online-installer-v1.5.2.tgz 2.ä¿®æ”¹é…ç½® cd harbor vim harbor.cfg hostname=10.0.13.19 //è®¾ç½®ä¸ºå½“å‰ä¸»æœºip 3.å®‰è£…å¹¶å¯åŠ¨harboræœåŠ¡ æœåŠ¡å¯åŠ¨ä»¥å,å¦‚æœéœ€è¦ç®¡ç†HarboræœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸ,å¯ä»¥ç›´æ¥é€šè¿‡docker-composeæ¥ç®¡ç† sh install.sh ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:3:3","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ä½¿ç”¨æŒ‡å— 1.åœ¨clientä¸»æœºä¸Šé€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šCM(cluster manager)èŠ‚ç‚¹ vi /etc/dragonfly.conf å†…å®¹: [node] address=10.0.13.22,10.0.13.31 2.**ç”±äºå½“å‰Dragonflyæš‚ä¸æ”¯æŒharborè®¤è¯ã€‚å¦‚æœæŒ‰ç…§å®˜ç½‘é…ç½®\"configure daemon mirror\"æ¥æ‹‰å–é•œåƒä¼šæç¤ºæˆæƒå¤±è´¥ã€‚**ä¸ºäº†ç»•è¿‡è¿™ä¸ªé—®é¢˜å¯ä»¥é‡‡ç”¨docker proxyçš„æ–¹å¼æ¥è§£å†³ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹: ï¼ˆ1ï¼‰vi /etc/systemd/system/docker.service.d/http-proxy.conf,æ²¡æœ‰è¯¥æ–‡ä»¶å°±ç›´æ¥åˆ›å»ºè¯¥æ–‡ä»¶ã€‚é€šè¿‡æ·»åŠ proxyï¼Œåœ¨æ‹‰å–é•œåƒæ—¶å°†ä¼šé€šè¿‡ä¸‹é¢çš„é…ç½®åœ°å€è½¬å‘åˆ°ç›®æ ‡æœºã€‚ [Service] Environment=\"HTTP_PROXY=http://127.0.0.1:65001\" ï¼ˆ2ï¼‰æ›´æ–°å˜æ›´ systemctl daemon-reload 3.åœ¨clientæœºä¸Šæ·»åŠ harborçš„insecureåœ°å€ï¼Œåœ¨/etc/docker/daemon.jsonçš„insecure-registriesä¸­æ·»åŠ 10.0.13.19 {\"disable-legacy-registry\":false,\"graph\":\"/data/docker\",\"insecure-registries\":[\"10.0.13.19\"]} 4.å¯åŠ¨clientæœåŠ¡ df-daemon --registry http://10.0.13.19 5.é‡å¯docker systemctl restart docker 6.dockerç™»å½• docker login --username=admin 10.0.13.19 æç¤ºç™»å½•æˆåŠŸè¯´æ˜ä¸Šè¿°é…ç½®æ­£ç¡® 7.éªŒè¯ #æœ‰æ•°æ®ç»è¿‡65001ç«¯å£åˆ™é…ç½®æ­£ç¡® tcpdump -i lo port 65001 #å¦å¼€ä¸€ä¸ªshellæ‰§è¡Œ docker pull 10.0.13.19/kaku/bigimage:v1.0 #æ‹‰å–é•œåƒ ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:3:4","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"æµ‹è¯•ç»“æœ 2ä¸ªsupernodeï¼Œ20ä¸ªèŠ‚ç‚¹å¹¶è¡Œçš„æ‹‰é•œåƒ é•œåƒå¤§å°ï¼ˆå‹ç¼©ï¼‰ native cost dragonfly cost native harboræµé‡ dragonfly harboræµé‡ 1.28G 2må¤š ç¨³å®šåœ¨1m30så·¦å³ 20*1.28 2*1.28 3.48G 10+m ç¨³å®šåœ¨5m30så·¦å³ 20*3.48 2*3.48 ä½¿ç”¨dfä¹‹åï¼Œå¯¹harborçš„å‹åŠ›æ˜æ˜¾å‡å°ï¼Œåœ¨20ä¸ªèŠ‚ç‚¹æ—¶æµ‹è¯•ç»“æœä¸º çº¦33%çš„æµé‡æ˜¯é€šè¿‡p2pçš„æ–¹å¼è·å¾—çš„ï¼Œéšç€èŠ‚ç‚¹æ•°çš„å¢å¤šï¼Œæ­¤å€¼è¿˜ä¼šç»§ç»­å¢å¤§ï¼› å„èŠ‚ç‚¹é•œåƒæ‹‰å–æ—¶é—´ç¨³å®šï¼Œæ¯”ä¸ä½¿ç”¨ä»£ç†æ—¶å¥½å¾ˆå¤šï¼Œä½†æ˜¯åœ¨å•èŠ‚ç‚¹æ‹‰é•œåƒæ—¶ï¼Œä½¿ç”¨ä»£ç†æ—¶çš„è€—æ—¶æ˜¯è¦æ¯”åŸç”Ÿdocker pullè€—æ—¶é•¿çš„ ç›®å‰éƒ¨ç½²çš„df supernodeä¸º0.2.0ç‰ˆæœ¬ï¼Œclientä¸º0.0.1ç‰ˆæœ¬ï¼Œå°è¯•ç”¨0.1.0ã€0.1.1ç‰ˆæœ¬çš„clientå‡å¤±è´¥ï¼Œè§è¿™é‡Œ ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:4:0","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å‚è€ƒ dragonflyä¸harborç»„å»ºæ”¯æŒP2Pçš„é•œåƒæœåŠ¡ https://github.com/alibaba/Dragonfly/issues/17 https://github.com/alibaba/Dragonfly/issues/20 https://github.com/alibaba/Dragonfly/issues/50#issuecomment-382286474 ","date":"2018-09-13","objectID":"https://www.likakuli.com/posts/dragonfly/:5:0","tags":["docker","dragonfly"],"title":"Dragonfly + Harborå®ç°çš„p2pé•œåƒåˆ†å‘","uri":"https://www.likakuli.com/posts/dragonfly/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"kuberneteså¯ç”¨GPU","date":"2018-09-06","objectID":"https://www.likakuli.com/posts/kubernetes-gpu/","tags":["kubernetes"],"title":"Kubernetes å¯ç”¨GPU","uri":"https://www.likakuli.com/posts/kubernetes-gpu/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"kubernetesè®¾ç½® k8s 1.10ä¹‹å‰éœ€è¦åœ¨kube-apiserverã€kube-controller-managerã€kube-schedulerã€kubeletä¸­å¼€å¯å¦‚ä¸‹featureï¼Œå¦‚æœä¸æ˜¯é¦–æ¬¡éƒ¨ç½²çš„è¯ï¼Œé‡å¯ä»¥ä¸Šæ‰€æœ‰ç»„ä»¶ï¼š â€“feature-gates=â€œDevicePlugins=trueâ€ å®‰è£… NVIDIA Driver~=361.93 å®‰è£…nvidia-docker2ï¼Œç”±äºç›®å‰ä½¿ç”¨çš„dockerç‰ˆæœ¬æç¤ºä¿¡æ¯é‡ŒåŒ…å«è‡ªå®šä¹‰å­—æ ·ï¼Œåªèƒ½ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å®‰è£…ï¼š æ‰€æœ‰å®‰è£…æ–¹å¼å‚è€ƒè¿™é‡Œ # If you have nvidia-docker 1.0 installed: we need to remove it and all existing GPU containers docker volume ls -q -f driver=nvidia-docker | xargs -r -I{} -n1 docker ps -q -a -f volume={} | xargs -r docker rm -f sudo yum remove nvidia-docker # Add the package repositories distribution=$(. /etc/os-release;echo $ID$VERSION_ID) curl -s -L https://nvidia.github.io/nvidia-container-runtime/$distribution/nvidia-container-runtime.repo | \\ sudo tee /etc/yum.repos.d/nvidia-container-runtime.repo # Install the nvidia runtime hook sudo yum install -y nvidia-container-runtime-hook sudo mkdir -p /usr/libexec/oci/hooks.d echo -e '#!/bin/sh\\nPATH=\"/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\" exec nvidia-container-runtime-hook \"$@\"' | \\ sudo tee /usr/libexec/oci/hooks.d/nvidia sudo chmod +x /usr/libexec/oci/hooks.d/nvidia # Test nvidia-smi with the latest official CUDA image # You can't use `--runtime=nvidia` with this setup. docker run --rm nvidia/cuda nvidia-smi å®‰è£…nvidia-container-runtimeï¼Œåœ¨ä¸Šä¸€æ­¥ä¸­å·²ç»å®‰è£…äº†å¯¹åº”çš„yum repoï¼Œè¿™é‡Œç›´æ¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ï¼š å› ä¸ºä½¿ç”¨äº†ä¸Šä¸€æ­¥çš„å®‰è£…æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œè¿™ä¸€æ­¥çš„å®‰è£…ï¼Œå¦‚æœæ˜¯é€šè¿‡yumç›´æ¥å®‰è£…çš„nvidia-docker2ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œæ­¤æ­¥ã€‚ # install runtime yum install nvidia-container-runtime update docker daemonï¼Œåœ¨docker daemonä¸­æ·»åŠ å¦‚ä¸‹é…ç½® daemon.jsonä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¯é€‰é…ç½®ä¸º\"default-runtime\": â€œnvidiaâ€ï¼Œå¦‚æœä¸è®¾ç½®é»˜è®¤runtimeï¼Œåˆ™é»˜è®¤ä½¿ç”¨runcï¼Œå¯åŠ¨å®¹å™¨æ˜¯éœ€è¦æŒ‡å®šâ€“runtime=nvidia \"default-runtime\": \"nvidia\"ï¼Œ \"runtimes\": { \"nvidia\": { \"path\": \"/usr/bin/nvidia-container-runtime\", \"runtimeArgs\": [] } } å®‰è£…NVIDIA device pluginï¼Œæ’ä»¶ä»¥daemonsetæ–¹å¼éƒ¨ç½²ï¼Œå¦‚æœé›†ç¾¤ä¸­æ—¢æœ‰CPUä¹Ÿæœ‰GPUèŠ‚ç‚¹ï¼Œå¯ä»¥é€šè¿‡labelç­›é€‰å‡ºGPUèŠ‚ç‚¹ï¼Œæ— GPUçš„èŠ‚ç‚¹æ— éœ€éƒ¨ç½²æ­¤ç¨‹åº # For Kubernetes v1.8 kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v1.8/nvidia-device-plugin.yml # For Kubernetes v1.9 kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v1.9/nvidia-device-plugin.yml ","date":"2018-09-06","objectID":"https://www.likakuli.com/posts/kubernetes-gpu/:1:0","tags":["kubernetes"],"title":"Kubernetes å¯ç”¨GPU","uri":"https://www.likakuli.com/posts/kubernetes-gpu/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"æµ‹è¯• apiVersion: v1 kind: Pod metadata: name: cuda-vector-add spec: restartPolicy: OnFailure containers: - name: cuda-vector-add # https://github.com/kubernetes/kubernetes/blob/v1.7.11/test/images/nvidia-cuda/Dockerfile image: \"k8s.gcr.io/cuda-vector-add:v0.1\" resources: limits: nvidia.com/gpu: 1 nodeSelector: GPU: \"true\" //æµ‹è¯•æ—¶è‡ªå·±ç»™å¯¹åº”GPUèŠ‚ç‚¹åŠ äº†GPU=trueçš„label kubectl create -f test.yaml æ‰§è¡Œç»“æœï¼š [root@vm10-0-13-17 ~]# kubectl get pods -a NAME READY STATUS RESTARTS AGE cuda-vector-add 0/1 Completed 0 3h nvidia-device-plugin-daemonset-pv6z8 1/1 Running 0 4h [root@vm10-0-13-17 ~]# kubectl logs cuda-vector-add [Vector addition of 50000 elements] Copy input data from the host memory to the CUDA device CUDA kernel launch with 196 blocks of 256 threads Copy output data from the CUDA device to the host memory Test PASSED Done ","date":"2018-09-06","objectID":"https://www.likakuli.com/posts/kubernetes-gpu/:2:0","tags":["kubernetes"],"title":"Kubernetes å¯ç”¨GPU","uri":"https://www.likakuli.com/posts/kubernetes-gpu/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"golangç›‘æ§","date":"2018-07-01","objectID":"https://www.likakuli.com/posts/golang-monitor/","tags":["golang"],"title":"Golangç›‘æ§","uri":"https://www.likakuli.com/posts/golang-monitor/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"çœ‹äº†ä¸€ç¯‡æ–‡ç« ï¼Œé‡Œé¢æ¶‰åŠåˆ°äº†ä¸€äº›golangç¨‹åºç›‘æ§çš„é—®é¢˜ï¼Œå›è¿‡å¤´æ€»ç»“äº†ä¸€ä¸‹å®ç°æ–¹å¼ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ ","date":"2018-07-01","objectID":"https://www.likakuli.com/posts/golang-monitor/:0:0","tags":["golang"],"title":"Golangç›‘æ§","uri":"https://www.likakuli.com/posts/golang-monitor/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"expvar goè‡ªå¸¦çš„runtimeåŒ…æ‹¥æœ‰å„ç§åŠŸèƒ½ï¼ŒåŒ…æ‹¬goroutineæ•°é‡ï¼Œè®¾ç½®é€»è¾‘çº¿ç¨‹æ•°é‡ï¼Œå½“å‰goç‰ˆæœ¬ï¼Œå½“å‰ç³»ç»Ÿç±»å‹ç­‰ç­‰ã€‚å‰ä¸¤å¤©å‘ç°äº†goæ ‡å‡†åº“è¿˜æœ‰ä¸€ä¸ªæ›´å¥½ç”¨çš„å¯ä»¥ç›‘æ§æœåŠ¡è¿è¡Œå„é¡¹æŒ‡æ ‡å’ŒçŠ¶æ€çš„åŒ…â€”-expvarã€‚ expvaråŒ…ä¸ºç›‘æ§å˜é‡æä¾›äº†ä¸€ä¸ªæ ‡å‡†åŒ–çš„æ¥å£ï¼Œå®ƒä»¥ JSON æ ¼å¼é€šè¿‡ /debug/vars æ¥å£ä»¥ HTTP çš„æ–¹å¼å…¬å¼€è¿™äº›ç›‘æ§å˜é‡ä»¥åŠæˆ‘è‡ªå®šä¹‰çš„å˜é‡ã€‚é€šè¿‡å®ƒï¼Œå†åŠ ä¸ŠmetricBeatï¼ŒESå’ŒKibanaï¼Œå¯ä»¥å¾ˆè½»æ¾çš„å¯¹æœåŠ¡è¿›è¡Œç›‘æ§ã€‚æˆ‘è¿™é‡Œæ˜¯ç”¨ginæŠŠæ¥å£æš´éœ²å‡ºæ¥ï¼Œå…¶å®ç”¨åˆ«çš„webæ¡†æ¶ä¹Ÿéƒ½å¯ä»¥ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨å®ƒï¼ˆç¤ºä¾‹ä»£ç ä½¿ç”¨GINÂ HTTP web frameworkï¼‰ï¼š package main import ( \"expvar\" \"github.com/gin-gonic/gin\" \"net/http\" \"net/http/pprof\" \"time\" ) func main() { router := gin.Default() router.GET(\"/debug/vars\", monitor.GetCurrentRunningStats) s := \u0026http.Server{ Addr: \":9090\", Handler: router, ReadTimeout: 5 * time.Second, WriteTimeout: 5 * time.Second, MaxHeaderBytes: 1 \u003c\u003c 20, } s.ListenAndServe() } å¯¹åº”çš„handler package monitor import ( \"encoding/json\" \"expvar\" \"fmt\" \"github.com/gin-gonic/gin\" \"net/http\" \"runtime\" \"time\" ) // å¼€å§‹æ—¶é—´ var start = time.Now() // calculateUptime è®¡ç®—è¿è¡Œæ—¶é—´ func calculateUptime() interface{} { return time.Since(start).String() } // currentGoVersion å½“å‰ Golang ç‰ˆæœ¬ func currentGoVersion() interface{} { return runtime.Version() } // getNumCPUs è·å– CPU æ ¸å¿ƒæ•°é‡ func getNumCPUs() interface{} { return runtime.NumCPU() } // getGoOS å½“å‰ç³»ç»Ÿç±»å‹ func getGoOS() interface{} { return runtime.GOOS } // getNumGoroutins å½“å‰ goroutine æ•°é‡ func getNumGoroutins() interface{} { return runtime.NumGoroutine() } // getNumCgoCall CGo è°ƒç”¨æ¬¡æ•° func getNumCgoCall() interface{} { return runtime.NumCgoCall() } var lastPause uint32 // getLastGCPauseTime è·å–ä¸Šæ¬¡ GC çš„æš‚åœæ—¶é—´ func getLastGCPauseTime() interface{} { var gcPause uint64 ms := new(runtime.MemStats) statString := expvar.Get(\"memstats\").String() if statString != \"\" { json.Unmarshal([]byte(statString), ms) if lastPause == 0 || lastPause != ms.NumGC { gcPause = ms.PauseNs[(ms.NumGC+255)%256] lastPause = ms.NumGC } } return gcPause } // GetCurrentRunningStats è¿”å›å½“å‰è¿è¡Œä¿¡æ¯ func GetCurrentRunningStats(c *gin.Context) { c.Writer.Header().Set(\"Content-Type\", \"application/json; charset=utf-8\") first := true report := func(key string, value interface{}) { if !first { fmt.Fprintf(c.Writer, \",\\n\") } first = false if str, ok := value.(string); ok { fmt.Fprintf(c.Writer, \"%q: %q\", key, str) } else { fmt.Fprintf(c.Writer, \"%q: %v\", key, value) } } fmt.Fprintf(c.Writer, \"{\\n\") expvar.Do(func(kv expvar.KeyValue) { report(kv.Key, kv.Value) }) fmt.Fprintf(c.Writer, \"\\n}\\n\") c.String(http.StatusOK, \"\") } func init() { //è¿™äº›éƒ½æ˜¯æˆ‘è‡ªå®šä¹‰çš„å˜é‡ï¼Œå‘å¸ƒåˆ°expvarä¸­ï¼Œæ¯æ¬¡è¯·æ±‚æ¥å£ï¼Œexpvarä¼šè‡ªåŠ¨å»è·å–è¿™äº›å˜é‡ï¼Œå¹¶è¿”å›ç»™æˆ‘ expvar.Publish(\"è¿è¡Œæ—¶é—´\", expvar.Func(calculateUptime)) expvar.Publish(\"version\", expvar.Func(currentGoVersion)) expvar.Publish(\"cores\", expvar.Func(getNumCPUs)) expvar.Publish(\"os\", expvar.Func(getGoOS)) expvar.Publish(\"cgo\", expvar.Func(getNumCgoCall)) expvar.Publish(\"goroutine\", expvar.Func(getNumGoroutins)) expvar.Publish(\"gcpause\", expvar.Func(getLastGCPauseTime)) } è¿è¡Œç¨‹åºï¼Œè®¿é—®http://localhost:9090/debug/varsï¼Œå¦‚ä¸‹ å¯ä»¥çœ‹åˆ°ï¼Œexpvarè¿”å›ç»™äº†æˆ‘æˆ‘ä¹‹å‰è‡ªå®šä¹‰çš„æ•°æ®ï¼Œä»¥åŠå®ƒæœ¬èº«è¦é»˜è®¤è¿”å›çš„æ•°æ®ï¼Œæ¯”å¦‚memstatsã€‚è¿™ä¸ªmemstatsæ˜¯å¹²å˜›çš„å‘¢ï¼Œå…¶å®çœ‹åˆ°è¿™äº›å­—æ®µåå°±å¯ä»¥çŸ¥é“ï¼Œæ˜¯å„ç§å†…å­˜å †æ ˆä»¥åŠGCçš„ä¸€äº›ä¿¡æ¯ï¼Œå…·ä½“å¯ä»¥çœ‹æºç æ³¨é‡Šï¼š type MemStats struct { // General statistics. // Alloc is bytes of allocated heap objects. // // This is the same as HeapAlloc (see below). Alloc uint64 // TotalAlloc is cumulative bytes allocated for heap objects. // // TotalAlloc increases as heap objects are allocated, but // unlike Alloc and HeapAlloc, it does not decrease when // objects are freed. TotalAlloc uint64 // Sys is the total bytes of memory obtained from the OS. // // Sys is the sum of the XSys fields below. Sys measures the // virtual address space reserved by the Go runtime for the // heap, stacks, and other internal data structures. It's // likely that not all of the virtual address space is backed // by physical memory at any given moment, though in general // it all was at some point. Sys uint64 // Lookups is the number of pointer lookups performed by the // runtime. // // This is primarily useful for debugging runtime internals. Lookups uint64 // Mallocs is the cumulative count of heap objects allocated. // The number of live objects is Mallocs - Frees. Mallocs uint64 // Frees is the cumulative count of heap objects f","date":"2018-07-01","objectID":"https://www.likakuli.com/posts/golang-monitor/:1:0","tags":["golang"],"title":"Golangç›‘æ§","uri":"https://www.likakuli.com/posts/golang-monitor/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"pprof æœ‰å…³pprofçš„åŸºæœ¬ä»‹ç»å’Œä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œï¼Œæœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ package main import ( \"net/http\" _ \"net/http/pprof\" ) func main() { http.ListenAndServe(\":9090\", nil) } è¿è¡Œç¨‹åºï¼Œè®¿é—®http://localhost:9090/debug/pprofå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœ é…åˆgo tool pprofä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚æŸ¥çœ‹cpuè¯¦æƒ…ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤å®ç° root@kaku-Inspiron-7537:~/blog# go tool pprof localhost:9090/debug/pprof/profile Fetching profile over HTTP from http://localhost:9090/debug/pprof/profile Saved profile in /root/pprof/pprof.___go_build_main_go__1_.samples.cpu.002.pb.gz File: ___go_build_main_go__1_ Type: cpu Time: Jul 2, 2018 at 12:44am (CST) Duration: 30s, Total samples = 0 Entering interactive mode (type \"help\" for commands, \"o\" for options) (pprof) web æ‰§è¡Œå®Œä¹‹åï¼Œå¦‚æœæœ¬åœ°å®‰è£…äº†graphvizå’Œchromeï¼Œåˆ™è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°å¦‚ä¸‹å›¾ç‰‡ å› ä¸ºç¤ºä¾‹ç¨‹åºæ²¡æœ‰ä»»ä½•å…¶ä»–ä»£ç ï¼Œä¹‹æš´éœ²äº†httpæœåŠ¡ï¼Œæ‰€ä»¥çœ‹åˆ°çš„ç»“æœæ¯”è¾ƒå•è°ƒ ","date":"2018-07-01","objectID":"https://www.likakuli.com/posts/golang-monitor/:2:0","tags":["golang"],"title":"Golangç›‘æ§","uri":"https://www.likakuli.com/posts/golang-monitor/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Prometheus Prometheus clientå†…ç½®äº†golang metricsæš´éœ²çš„handlerï¼Œåªéœ€è¦ç®€å•è°ƒç”¨å³å¯å®ç°ï¼Œå¦‚ä¸‹ package main import ( \"github.com/prometheus/client_golang/prometheus/promhttp\" \"net/http\" ) func main() { http.Handle(\"/metrics\", promhttp.Handler()) panic(http.ListenAndServe(\":9090\", nil)) } è¿è¡Œç¨‹åºï¼Œè®¿é—®http://localhost:9090/metrics å³å¯ã€‚ åŒæ—¶å¯ä»¥é€šè¿‡Prometheusæ¥é‡‡é›†æ­¤Endpointæš´éœ²å‡ºæ¥çš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè‡ªå®šä¹‰æ•°æ®çš„é‡‡é›†ï¼Œå‚è€ƒè¿™é‡Œ ","date":"2018-07-01","objectID":"https://www.likakuli.com/posts/golang-monitor/:3:0","tags":["golang"],"title":"Golangç›‘æ§","uri":"https://www.likakuli.com/posts/golang-monitor/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Prometheus","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å…¬å¸é‡‡ç”¨Prometheusæ¥é‡‡é›†Kubernetesé›†ç¾¤çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®ï¼Œä¹‹å‰å¯¹æ€§èƒ½æ•°æ®é‡‡é›†è¿™æ–¹é¢æ²¡æœ‰å…³æ³¨è¿‡ï¼Œä½†æ˜¯å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹æœ‰å¾ˆå¤šæ­¤ç±»éœ€æ±‚ï¼Œå› æ­¤é‡ç‚¹å­¦ä¹ äº†ä¸€ä¸‹Prometheusé‡‡é›†æ•°æ®çš„åŸç†ä»¥åŠå¦‚ä½•éƒ¨ç½²ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»ã€‚ Prometheusç‰ˆæœ¬ 2.3.0 AlertManagerç‰ˆæœ¬ 1.4.0 å› ä¸ºä¸¤è€…çš„é…ç½®å¯¹æ—§ç‰ˆæœ¬çš„å…¼å®¹ä¸æ˜¯å¾ˆå¥½ï¼Œåœ¨æŒ‰ç…§ç½‘ä¸Šæœç´¢çš„èµ„æ–™è¿›è¡Œéƒ¨ç½²æ—¶é‡åˆ°äº†ä¸å°‘å‘ï¼Œæ‰€ä»¥å½“ä½ çœ‹åˆ°è¿™ç¯‡æ–‡ç« ï¼Œæ ¹æ®æ–‡ç« è¿›è¡Œéƒ¨ç½²æ—¶ï¼Œå¯èƒ½æˆ‘ç°åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬å·²ç»å¾ˆæ—§ï¼Œæ‚¨å¯èƒ½éœ€è¦æŒ‰éœ€ä¿®æ”¹é…ç½® ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:0:0","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"åŸç† è¿™å¼ å›¾å¤§å®¶åº”è¯¥ä¸é™Œç”Ÿï¼Œæ²¡é”™ï¼Œå°±æ˜¯ä»å®˜ç½‘å·æ¥çš„å›¾ç‰‡ï¼Œä¸‹é¢ç‰¹å¾å’Œç»„ä»¶ä¹Ÿæ˜¯å·æ¥çš„ï¼Œå“ˆå“ˆã€‚ ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:1:0","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç‰¹å¾ Prometheusçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ï¼š ä¸€ä¸ªå…·æœ‰ç”±metricåç§°å’Œé”®/å€¼å¯¹æ ‡è¯†çš„å¤šç»´æ—¶é—´åºåˆ—çš„æ•°æ®æ¨¡å‹ ä¸€ç§çµæ´»çš„æŸ¥è¯¢è¯­è¨€ æ¥åˆ©ç”¨è¿™ç§ç»´åº¦ ä¸ä¾èµ–åˆ†å¸ƒå¼å­˜å‚¨; å•ä¸ªæœåŠ¡å™¨èŠ‚ç‚¹æ˜¯è‡ªæ²»çš„ï¼ˆè¿™ç‚¹çœŸä¸èƒ½è®¤åŒï¼Œæ²¡æœ‰HAè®©äººå¾ˆéš¾å—ï¼‰ æ—¶é—´åºåˆ—æ”¶é›†é€šè¿‡HTTPä¸Šçš„æ‹‰å¼æ¨¡å‹è¿›è¡Œ æ¨é€æ—¶é—´åºåˆ—é€šè¿‡ä¸­é—´ç½‘å…³æ”¯æŒ é€šè¿‡æœåŠ¡å‘ç°æˆ–é™æ€é…ç½®æ¥å‘ç°ç›®æ ‡ å¤šç§æ¨¡å¼çš„å›¾å½¢å’Œä»ªè¡¨ç›˜æ”¯æŒ AlertManagerçš„ä¸»è¦ç‰¹ç‚¹ï¼š Grouping åˆ†ç»„ Inhibition æŠ‘åˆ¶ Silences HA (é…ç½®æ–¹å¼æœ‰é™åˆ¶ï¼Œåªèƒ½ç½—åˆ—å‡ºæ‰€æœ‰çš„å®ä¾‹ï¼Œä¸èƒ½é€šè¿‡è´Ÿè½½å‡è¡¡æ–¹å¼é…ç½®) ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:1:1","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç»„ä»¶ æ™®ç½—ç±³ä¿®æ–¯ç”Ÿæ€ç³»ç»Ÿç”±å¤šä¸ªç»„ä»¶ç»„æˆï¼Œå…¶ä¸­è®¸å¤šç»„ä»¶æ˜¯å¯é€‰çš„ï¼š PrometheusæœåŠ¡å™¨ç”¨æ¥æ”¶é›†å’Œå­˜å‚¨æ—¶é—´åºåˆ—æ•°æ® ç”¨äºæ£€æµ‹åº”ç”¨ç¨‹åºä»£ç çš„å®¢æˆ·ç«¯åº“ æ”¯æŒShort-lived jobçš„Pushgateway ä¸“é—¨ç”¨äºHAProxyï¼ŒStatsDï¼ŒGraphiteç­‰æœåŠ¡çš„exporter ä¸€ä¸ªè­¦æŠ¥å¤„ç†å™¨alertmanager å„ç§æ”¯æŒå·¥å…· å¤§å¤šæ•°Prometheusç»„ä»¶éƒ½æ˜¯ç”¨Goç¼–å†™çš„ï¼Œå› æ­¤å®ƒä»¬å¾ˆå®¹æ˜“æ„å»ºå’Œéƒ¨ç½²ä¸ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:1:2","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"éƒ¨ç½² è¿™é‡Œä¸»è¦é€šè¿‡Kuberneteséƒ¨ç½²Prometheuså’ŒAlertManagerï¼Œå®ä¾‹æ•°éƒ½åªå¼€1ï¼ŒåŸå› ä¹Ÿå¾ˆå¥½ç†è§£ï¼ŒPrometheusä¸æ”¯æŒHAï¼Œå®ä¾‹å¼€å¤šäº†ä¹Ÿæ²¡æœ‰ç”¨ï¼Œè€Œä¸”æ¯ä¸ªå®ä¾‹å­˜çš„æ•°æ®å› ä¸ºé‡‡é›†æ—¶é—´çš„åŸå› ä¼šä¸ä¸€è‡´ï¼ŒAlertManageråªå¼€ä¸€ä¸ªå®ä¾‹çš„åŸå› æ˜¯è™½ç„¶æ”¯æŒHAï¼Œä½†æ˜¯åªèƒ½åœ¨é…ç½®Prometheusæ—¶ç½—åˆ—å‡ºæ‰€æœ‰çš„å®ä¾‹ï¼Œæ˜¾ç„¶é€šè¿‡Kuberneteséƒ¨ç½²æ—¶æ— æ³•è·å–åˆ°æ‰€æœ‰AlertManagerçš„Podå®ä¾‹ï¼Œåªèƒ½è·å¾—å¯¹åº”çš„Serviceï¼Œä½†æ˜¯serviceå°±å±äºè´Ÿè½½å‡è¡¡äº†ï¼Œå¦‚æœAlertManageré€‰åœ¨åœ¨é›†ç¾¤å¤–é€šè¿‡Dockeræˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥éƒ¨ç½²çš„è¯ï¼Œå¯ä»¥å¼€å¯å¤šä¸ªå®ä¾‹ï¼Œè¿™é‡Œæš‚æ—¶åœ¨é›†ç¾¤å†…éƒ¨ç½²ï¼Œä¸‹é¢å°†åˆ—å‡ºæ‰€ç”¨åˆ°çš„Yamlæ–‡ä»¶ã€‚ é¦–å…ˆï¼Œç»™å‡ºPrometheusç›¸å…³çš„æ–‡ä»¶ ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:0","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"prometheus.config.yaml apiVersion:v2kind:ConfigMapmetadata:name:prometheus-confignamespace:kube-systemdata:prometheus.yml:|global: scrape_interval: 15s evaluation_interval: 15s rule_files: - /etc/prometheus-rules/*.rules alerting: alertmanagers: - static_configs: - targets: - alertmanager:9093 scrape_configs: - job_name: 'kubernetes-apiservers' kubernetes_sd_configs: - role: endpoints scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name] action: keep regex: default;kubernetes;https - job_name: 'kubernetes-nodes' kubernetes_sd_configs: - role: node scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+) target_label: __metrics_path__ replacement: /api/v1/nodes/${1}/proxy/metrics - job_name: 'kubernetes-cadvisor' kubernetes_sd_configs: - role: node scheme: https tls_config: ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token relabel_configs: - action: labelmap regex: __meta_kubernetes_node_label_(.+) - target_label: __address__ replacement: kubernetes.default.svc:443 - source_labels: [__meta_kubernetes_node_name] regex: (.+)target_label:__metrics_path__replacement:/api/v1/nodes/${1}/proxy/metrics/cadvisor- job_name:'kubernetes-service-endpoints'kubernetes_sd_configs:- role:endpointsrelabel_configs:- source_labels:[__meta_kubernetes_service_annotation_prometheus_io_scrape]action:keepregex:true- source_labels:[__meta_kubernetes_service_annotation_prometheus_io_scheme]action:replacetarget_label:__scheme__regex:(https?)- source_labels:[__meta_kubernetes_service_annotation_prometheus_io_path]action:replacetarget_label:__metrics_path__regex:(.+)- source_labels:[__address__, __meta_kubernetes_service_annotation_prometheus_io_port]action:replacetarget_label:__address__regex:([^:]+)(?::\\d+)?;(\\d+)replacement:$1:$2- action:labelmapregex:__meta_kubernetes_service_label_(.+)- source_labels:[__meta_kubernetes_namespace]action:replacetarget_label:kubernetes_namespace- source_labels:[__meta_kubernetes_service_name]action:replacetarget_label:kubernetes_name- job_name:'kubernetes-services'kubernetes_sd_configs:- role:servicemetrics_path:/probeparams:module:[http_2xx]relabel_configs:- source_labels:[__meta_kubernetes_service_annotation_prometheus_io_probe]action:keepregex:true- source_labels:[__address__]target_label:__param_target- target_label:__address__replacement:blackbox-exporter.example.com:9115- source_labels:[__param_target]target_label:instance- action:labelmapregex:__meta_kubernetes_service_label_(.+)- source_labels:[__meta_kubernetes_namespace]target_label:kubernetes_namespace- source_labels:[__meta_kubernetes_service_name]target_label:kubernetes_name- job_name:'kubernetes-ingresses'kubernetes_sd_configs:- role:ingressrelabel_configs:- source_labels:[__meta_kubernetes_ingress_annotation_prometheus_io_probe]action:keepregex:true- source_labels:[__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]regex:(.+);(.+);(.+)replacement:${1}://${2}${3}target_label:__param_target- target_label:__address__replacement:blackbox-exporter.example.com:9115- source_labels:[__param_target]target_label:instance- action:labelmapregex:__meta_kubernetes_ingress_label_(.+)- source_labels:[__meta_kubernetes_namespace]target_label:kubernetes_namespace- source_labels:[__meta_kubernetes_ingress_name]target_label:kubernetes_name- job_name:'kubernetes-pods'kubernetes_sd_configs:- role:podrelabel_configs:- source_labels:[__meta","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:1","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"Prometheus.deploy.yaml ---apiVersion:apps/v1beta2 kind:Deployment metadata:labels:name:prometheus-deployment name:prometheus namespace:kube-system spec:replicas:1selector:matchLabels:app:prometheus template:metadata:labels:app:prometheus spec:containers:- image:quay.io/prometheus/prometheus name:prometheus command:- \"/bin/prometheus\"args:- \"--config.file=/etc/prometheus/prometheus.yml\"- \"--storage.tsdb.path=/prometheus\"- \"--storage.tsdb.retention=24h\"ports:- containerPort:9090protocol:TCP volumeMounts:- mountPath:\"/prometheus\"name:data - mountPath:\"/etc/prometheus\"name:config-volume - name:rules-volume mountPath:/etc/prometheus-rules resources:requests:cpu:100m memory:100Mi limits:cpu:500m memory:2500Mi serviceAccountName:prometheus volumes:- name:data emptyDir:{}- name:config-volume configMap:name:prometheus-config - name:rules-volume configMap:name:prometheus-rules--kind:ServiceapiVersion:v1metadata:labels:app:prometheusname:prometheusnamespace:kube-systemspec:type:NodePortports:- port:9090targetPort:9090nodePort:30003selector:app:prometheus æˆåŠŸéƒ¨ç½²åï¼Œé€šè¿‡http://nodeIP:30003å°±å¯ä»¥è®¿é—®Prometheusçš„é¡µé¢äº†ï¼Œå¦‚ä¸‹å›¾ scrape_configsä¸­é…ç½®çš„kubernetes-podsã€kubernetes-servicesç­‰Jobï¼Œå¯èƒ½åœ¨targetç•Œé¢çœ‹ä¸åˆ°ï¼Œå› ä¸ºéœ€è¦æ·»åŠ å¯¹åº”çš„Annotationï¼Œä¾‹å¦‚Podæ·»åŠ å¦‚ä¸‹çš„Annotationåï¼Œå°±ä¼šåœ¨ä¸Šé¢çš„ç•Œé¢ä¸­å‡ºç°ï¼Œæ³¨æ„è¿™é‡Œæ˜¯åœ¨Podçš„annotationé‡Œæ·»åŠ ï¼Œè€Œä¸æ˜¯åœ¨Deployçš„annotation prometheus.io/scrape:\"true\" serviceçš„è¯æŒ‰ç…§ä¸Šè¿°é…ç½®ä¸­å†™çš„ï¼Œåˆ™éœ€è¦æ·»åŠ å¦‚ä¸‹çš„Annotation prometheus.io/probe:\"true\" æˆ‘ä»¬å¯ä»¥åœ¨Graphç•Œé¢è¿›è¡ŒæŸ¥è¯¢ï¼Œå¯ä»¥ä»¥Consoleæˆ–è€…Graphçš„å½¢å¼å±•ç¤ºæŸ¥è¯¢çš„ç»“æœï¼ŒPrometheusæä¾›äº†å¼ºå¤§çš„æŸ¥è¯¢è¯­æ³•ï¼Œå‚è€ƒè¿™é‡Œï¼Œä¸‹å›¾ä¸ºæŸ¥è¯¢æ¯ä¸ªNodeçš„CPUä½¿ç”¨ç‡ æ­¤æ—¶è¿˜æ²¡æœ‰è¿›è¡ŒAlertManagerçš„ç›¸å…³é…ç½®ï¼Œåœ¨Alertsé¡µé¢çœ‹ä¸åˆ°ä»»ä½•å†…å®¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éƒ¨ç½²AlertManager ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:2","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"alertmanager.config.yaml kind:ConfigMapapiVersion:v1metadata:name:alertmanagernamespace:kube-systemdata:config.yml:|-global: resolve_timeout: 5m smtp_smarthost: 'mailhost:port' smtp_from: 'sender@example.com' smtp_auth_username: 'sender@example.com' smtp_auth_password: 'password' slack_api_url: 'https://hooks.slack.com/services/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' templates: - '/etc/alertmanager-templates/*.tmpl' route: group_by: ['alertname', 'cluster', 'service'] group_wait: 30s group_interval: 5m repeat_interval: 15m receiver: slack-notifications receiver: email_alert routes: - match: severity: email receiver: email_alert receivers: - name: 'email_alert' email_configs: - to: 'to@example.com' - name: 'slack-notifications' slack_configs: - channel: '#alert' send_resolved: true ç±»ä¼¼Prometheusï¼Œæˆ‘ä»¬æŠŠAlertManagerçš„é…ç½®åŒæ ·ä¿å­˜ä¸ºConfigMapï¼Œéƒ¨ç½²æ—¶ä¿®æ”¹é‚®ç®±ã€slackç­‰å¯¹åº”é…ç½®ä¸ºè‡ªå·±çš„å€¼ï¼Œä¹Ÿå¯ä»¥æ·»åŠ è‡ªå·±çš„æ¥æ”¶é€”å¾„ï¼Œå…·ä½“å‚è€ƒè¿™é‡Œï¼Œä¸Šè¿°é…ç½®çš„æ„æ€æ˜¯å‘Šè¯‰AlertManageræŒ‰ç…§alertnameã€clusterã€serviceå¯¹æ”¶åˆ°çš„é€šçŸ¥è¿›è¡Œåˆ†ç»„ï¼Œæ¯éš”å¤§çº¦5+15åˆ†é’Ÿå‘é€ä¸€æ¬¡æŠ¥è­¦ä¿¡æ¯ï¼ŒæŠ¥è­¦ä¿¡æ¯é»˜è®¤é€šè¿‡å‘é€åˆ°slackï¼Œå¦‚æœä¿¡æ¯ä¸­åŒ…å«severity: emailçš„labelï¼Œé‚£ä¹ˆè­¦æŠ¥è¿˜ä¼šåŒæ—¶å†å‘é€åˆ°æ¥æ”¶é‚®ç®±ã€‚ ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:3","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"alertmanager.deploy.yaml apiVersion:extensions/v1beta1kind:Deploymentmetadata:name:alertmanagernamespace:kube-systemspec:replicas:1selector:matchLabels:app:alertmanagertemplate:metadata:name:alertmanagerlabels:app:alertmanagerspec:containers:- name:alertmanagerimage:prom/alertmanager:latestargs:- '--config.file=/etc/alertmanager/config.yml'- '--storage.path=/alertmanager'ports:- name:alertmanagercontainerPort:9093volumeMounts:- name:config-volumemountPath:/etc/alertmanager- name:templates-volumemountPath:/etc/alertmanager-templates- name:alertmanagermountPath:/alertmanagervolumes:- name:config-volumeconfigMap:name:alertmanager- name:templates-volumeconfigMap:name:alertmanager-templates- name:alertmanageremptyDir:{}---apiVersion:v1kind:Servicemetadata:annotations:prometheus.io/scrape:'true'labels:name:alertmanagername:alertmanagernamespace:kube-systemspec:selector:app:alertmanagerports:- name:alertmanagerprotocol:TCPport:9093targetPort:9093 ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:4","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"prometheus-rules node-cpu-usage.rules groups:- name:node-cpu-usagerules:- alert:HighRateErrorexpr:(100 - (avg by (instance) (irate(node_cpu{name=\"node-exporter\",mode=\"idle\"}[5m])) * 100)) \u003e 75for:2mlabels:severity:pageannotations:summary:\"{{$labels.instance}}: High CPU usage detected\"description:\"{{$labels.instance}}: CPU usage is above 75% (current value is: {{ $value }})\" prometheus-rulesä¸ºæ–‡ä»¶å¤¹ï¼Œæ‰€æœ‰çš„é€šçŸ¥è§„åˆ™éƒ½æ”¾åœ¨æ­¤æ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæœ‰å…³ruleæ–‡ä»¶é…ç½®ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œ é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ›å»ºruleå¯¹åº”çš„ConfigMap kubectl create cm prometheus-rules --from-file=prometheus-rules -o yaml --dry-run | kubectl create -n kube-system -f - ","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:5","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"alertmanager-templates default.tmpl {{ define \"__alertmanager\" }}AlertManager{{ end }} {{ define \"__alertmanagerURL\" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }} {{ define \"__subject\" }}[{{ .Status | toUpper }}{{ if eq .Status \"firing\" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join \" \" }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join \" \" }}{{ end }}){{ end }}{{ end }} {{ define \"__description\" }}{{ end }} {{ define \"__text_alert_list\" }}{{ range . }}Labels: {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }} {{ end }}Annotations: {{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }} {{ end }}Source: {{ .GeneratorURL }} {{ end }}{{ end }} {{ define \"slack.default.title\" }}{{ template \"__subject\" . }}{{ end }} {{ define \"slack.default.username\" }}{{ template \"__alertmanager\" . }}{{ end }} {{ define \"slack.default.fallback\" }}{{ template \"slack.default.title\" . }} | {{ template \"slack.default.titlelink\" . }}{{ end }} {{ define \"slack.default.pretext\" }}{{ end }} {{ define \"slack.default.titlelink\" }}{{ template \"__alertmanagerURL\" . }}{{ end }} {{ define \"slack.default.iconemoji\" }}{{ end }} {{ define \"slack.default.iconurl\" }}{{ end }} {{ define \"slack.default.text\" }}{{ end }} {{ define \"hipchat.default.from\" }}{{ template \"__alertmanager\" . }}{{ end }} {{ define \"hipchat.default.message\" }}{{ template \"__subject\" . }}{{ end }} {{ define \"pagerduty.default.description\" }}{{ template \"__subject\" . }}{{ end }} {{ define \"pagerduty.default.client\" }}{{ template \"__alertmanager\" . }}{{ end }} {{ define \"pagerduty.default.clientURL\" }}{{ template \"__alertmanagerURL\" . }}{{ end }} {{ define \"pagerduty.default.instances\" }}{{ template \"__text_alert_list\" . }}{{ end }} {{ define \"opsgenie.default.message\" }}{{ template \"__subject\" . }}{{ end }} {{ define \"opsgenie.default.description\" }}{{ .CommonAnnotations.SortedPairs.Values | join \" \" }} {{ if gt (len .Alerts.Firing) 0 -}} Alerts Firing: {{ template \"__text_alert_list\" .Alerts.Firing }} {{- end }} {{ if gt (len .Alerts.Resolved) 0 -}} Alerts Resolved: {{ template \"__text_alert_list\" .Alerts.Resolved }} {{- end }} {{- end }} {{ define \"opsgenie.default.source\" }}{{ template \"__alertmanagerURL\" . }}{{ end }} {{ define \"victorops.default.message\" }}{{ template \"__subject\" . }} | {{ template \"__alertmanagerURL\" . }}{{ end }} {{ define \"victorops.default.from\" }}{{ template \"__alertmanager\" . }}{{ end }} {{ define \"email.default.subject\" }}{{ template \"__subject\" . }}{{ end }} {{ define \"email.default.html\" }} \u003c!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"\u003e \u003c!-- Style and HTML derived from https://github.com/mailgun/transactional-email-templates The MIT License (MIT) Copyright (c) 2014 Mailgun Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions: The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. --\u003e \u003chtml xmlns=\"http://www.w3.org/1999/xhtml\" xmlns=\"http://www.w3.org/1999","date":"2018-06-21","objectID":"https://www.likakuli.com/posts/prometheus/:2:6","tags":["prometheus"],"title":"Prometheus","uri":"https://www.likakuli.com/posts/prometheus/"},{"categories":["æºç åˆ†æ"],"content":"golang netpoll æºç åˆ†æ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"ç®€ä»‹ goé’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿï¼Œå…¶ç½‘ç»œioæ¨¡å‹ä¸åŒï¼Œå¯ä»¥ä»goæºç ç›®å½•ç»“æ„å’Œå¯¹åº”å†…å®¹æ¸…æ¥šçš„çœ‹åˆ°å„å¹³å°çš„ioæ¨¡å‹ï¼Œå¦‚é’ˆå¯¹linuxç³»ç»Ÿå®ç°çš„epollï¼Œé’ˆå¯¹windowsæ“ä½œç³»ç»Ÿå®ç°çš„iocpç­‰ï¼Œè¿™é‡Œä¸»è¦çœ‹é’ˆå¯¹linuxç³»ç»Ÿçš„å®ç°ï¼Œæ¶‰åŠåˆ°çš„æ–‡ä»¶å¤§ä½“å¦‚ä¸‹ï¼š runtime/netpoll.go runtime/netpoll_epoll.go runtime/proc.go net/fd_unix.go internal/poll/fd_poll_runtime.go internal/poll/fd_unix.go åœ¨å¼€å§‹æ­£å¼çœ‹æºç ä¹‹å‰éœ€è¦å…·å¤‡ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œå¦‚åŒæ­¥ã€å¼‚æ­¥ã€é˜»å¡ã€éé˜»å¡ã€ioå¤šè·¯å¤ç”¨ã€goè°ƒåº¦æ¨¡å‹ç­‰ï¼Œä¸äº†è§£çš„è¯å¯ä»¥å‚è€ƒä¸‹é¢çš„é“¾æ¥ï¼š åŒæ­¥å¼‚æ­¥é˜»å¡éé˜»å¡ ioå¤šè·¯å¤ç”¨select poll epoll goroutineå®ç°åŸç† ä¹Ÿå¯ä»¥ç½‘ä¸Šè‡ªè¡Œæœç´¢ï¼Œæ–‡ç« å¾ˆå¤š ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:1:0","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"æºç åˆ†æï¼ˆv1.10.2ï¼‰ golangé€šè¿‡å¯¹epollçš„å°è£…æ¥å–å¾—ä½¿ç”¨åŒæ­¥ç¼–ç¨‹è¾¾å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœã€‚æ€»ç»“æ¥è¯´ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½ä»¥ç½‘ç»œæè¿°ç¬¦netFDä¸ºä¸­å¿ƒå®ç°ï¼ŒnetFDé€šè¿‡å°†Sysfdä¸pollDescç»“æ„ç»‘å®šï¼Œå½“åœ¨ä¸€ä¸ªnetFDä¸Šè¯»å†™é‡åˆ°EAGAINé”™è¯¯æ—¶ï¼Œå°±å°†å½“å‰goroutineå­˜å‚¨åˆ°è¿™ä¸ªnetFDå¯¹åº”çš„pollDescä¸­ï¼ŒåŒæ—¶å°†goroutineç»™parkä½ï¼Œç›´åˆ°è¿™ä¸ªnetFDä¸Šå†æ¬¡å‘ç”Ÿè¯»å†™äº‹ä»¶ï¼Œæ‰å°†æ­¤goroutineè®¾ç½®ä¸ºreadyæ”¾å…¥å¾…è¿è¡Œé˜Ÿåˆ—ç­‰å¾…é‡æ–°è¿è¡Œï¼Œåœ¨åº•å±‚é€šçŸ¥goroutineå†æ¬¡å‘ç”Ÿè¯»å†™ç­‰äº‹ä»¶çš„æ–¹å¼å°±æ˜¯é çš„epolläº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚ ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:2:0","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"netFD æœåŠ¡ç«¯é€šè¿‡Listenæ–¹æ³•è¿”å›çš„Listeneræ¥å£çš„å®ç°å’Œé€šè¿‡listenerçš„Acceptæ–¹æ³•è¿”å›çš„Connæ¥å£çš„å®ç°éƒ½åŒ…å«ä¸€ä¸ªç½‘ç»œæ–‡ä»¶æè¿°ç¬¦netFDï¼ŒnetFDä¸­åŒ…å«ä¸€ä¸ªpoll.FDæ•°æ®ç»“æ„ï¼Œè€Œpoll.FDä¸­åŒ…å«ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„Sysfdå’ŒpollDescï¼Œå‰è€…æ˜¯çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ï¼Œåè€…å¯¹æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼Œæ‰€æœ‰çš„è¯»å†™è¶…æ—¶ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è°ƒç”¨åè€…çš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚ æœåŠ¡ç«¯çš„netFDåœ¨listenæ—¶ä¼šåˆ›å»ºepollçš„å®ä¾‹ï¼Œå¹¶å°†listenFDåŠ å…¥epollçš„äº‹ä»¶é˜Ÿåˆ— netFDåœ¨acceptæ—¶å°†è¿”å›çš„connFDä¹ŸåŠ å…¥epollçš„äº‹ä»¶é˜Ÿåˆ— netFDåœ¨è¯»å†™æ—¶å‡ºç°syscall.EAGAINé”™è¯¯ï¼Œé€šè¿‡pollDescå°†å½“å‰çš„goroutine parkä½ï¼Œç›´åˆ°readyï¼Œä»pollDescçš„waitReadä¸­è¿”å› æ¶‰åŠåˆ°çš„ä¸€äº›ç»“æ„ï¼š type TCPListener struct { fd *netFD } type conn struct { fd *netFD } // Network file descriptor. type netFD struct { pfd poll.FD // immutable until Close family int sotype int isConnected bool net string laddr Addr raddr Addr } // FD is a file descriptor. The net and os packages use this type as a // field of a larger type representing a network connection or OS file. type FD struct { // Lock sysfd and serialize access to Read and Write methods. fdmu fdMutex // System file descriptor. Immutable until Close. // ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ Sysfd int // I/O poller. pd pollDesc // Writev cache. iovecs *[]syscall.Iovec // Semaphore signaled when file is closed. csema uint32 // Whether this is a streaming descriptor, as opposed to a // packet-based descriptor like a UDP socket. Immutable. IsStream bool // Whether a zero byte read indicates EOF. This is false for a // message based socket connection. ZeroReadIsEOF bool // Whether this is a file rather than a network socket. isFile bool // Whether this file has been set to blocking mode. isBlocking bool } ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:2:1","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"pollDesc ä¸Šé¢æåˆ°çš„net.connçš„è¯»å†™ç­‰æ“ä½œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨çš„poll.FDå¯¹åº”çš„æ–¹æ³•ï¼Œpoll.FDä¸­åŒ…å«ä¸€ä¸ªé‡è¦ç»“æ„poll.pollDescï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š type pollDesc struct { runtimeCtx uintptr } å¯ä»¥çœ‹åˆ°å…¶ä¸­åªåŒ…å«ä¸€ä¸ªæŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆå…·ä½“ä»£è¡¨çš„å…¶å®æ˜¯å¦ä¸€ä¸ªåŒåä¸åŒåŒ…çš„ç»“æ„runtime.pollDescï¼Œå®šä¹‰å¦‚ä¸‹ï¼š // Network poller descriptor. // // No heap pointers. // //go:notinheap type pollDesc struct { link *pollDesc // in pollcache, protected by pollcache.lock // The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations. // This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime. // pollReset, pollWait, pollWaitCanceled and runtimeÂ·netpollready (IO readiness notification) // proceed w/o taking the lock. So closing, rg, rd, wg and wd are manipulated // in a lock-free way by all operations. // NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg), // that will blow up when GC starts moving objects. lock mutex // protects the following fields fd uintptr closing bool seq uintptr // protects from stale timers and ready notifications rg uintptr // pdReady, pdWait, G waiting for read or nil rt timer // read deadline timer (set if rt.f != nil) rd int64 // read deadline wg uintptr // pdReady, pdWait, G waiting for write or nil wt timer // write deadline timer wd int64 // write deadline user uint32 // user settable cookie } runtime.pollDescåŒ…å«è‡ªèº«ç±»å‹çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨æ¥ä¿å­˜ä¸‹ä¸€ä¸ªruntime.pollDescçš„åœ°å€ï¼Œgoä¸­æœ‰å¾ˆå¤šç±»ä¼¼çš„å®ç°ï¼Œç”¨æ¥å®ç°é“¾è¡¨ï¼Œå¯ä»¥å‡å°‘æ•°æ®ç»“æ„çš„å¤§å°ï¼Œæ‰€æœ‰çš„runtime.pollDescä¿å­˜åœ¨runtime.pollCacheç»“æ„ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š type pollCache struct { lock mutex first *pollDesc // PollDesc objects must be type-stable, // because we can get ready notification from epoll/kqueue // after the descriptor is closed/reused. // Stale notifications are detected using seq variable, // seq is incremented when deadlines are changed or descriptor is reused. } ä»¥tcpè¿æ¥ä¸ºä¾‹ï¼Œåˆ†æä¸€ä¸‹Listenå’ŒAcceptè°ƒç”¨è¿‡ç¨‹ï¼š ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:2:2","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"Listen func Listen(network, address string) (Listener, error) { addrs, err := DefaultResolver.resolveAddrList(context.Background(), \"listen\", network, address, nil) if err != nil { return nil, \u0026OpError{Op: \"listen\", Net: network, Source: nil, Addr: nil, Err: err} } var l Listener switch la := addrs.first(isIPv4).(type) { case *TCPAddr: l, err = ListenTCP(network, la) case *UnixAddr: l, err = ListenUnix(network, la) default: return nil, \u0026OpError{Op: \"listen\", Net: network, Source: nil, Addr: la, Err: \u0026AddrError{Err: \"unexpected address type\", Addr: address}} } if err != nil { return nil, err // l is non-nil interface containing nil pointer } return l, nil } // ListenTCP acts like Listen for TCP networks. // // The network must be a TCP network name; see func Dial for details. // // If the IP field of laddr is nil or an unspecified IP address, // ListenTCP listens on all available unicast and anycast IP addresses // of the local system. // If the Port field of laddr is 0, a port number is automatically // chosen. func ListenTCP(network string, laddr *TCPAddr) (*TCPListener, error) { switch network { case \"tcp\", \"tcp4\", \"tcp6\": default: return nil, \u0026OpError{Op: \"listen\", Net: network, Source: nil, Addr: laddr.opAddr(), Err: UnknownNetworkError(network)} } if laddr == nil { laddr = \u0026TCPAddr{} } ln, err := listenTCP(context.Background(), network, laddr) if err != nil { return nil, \u0026OpError{Op: \"listen\", Net: network, Source: nil, Addr: laddr.opAddr(), Err: err} } return ln, nil } å½“æˆ‘ä»¬è°ƒç”¨net.Listen(â€œtcpâ€,addr)æ—¶ï¼Œæ ¹æ®addressç±»å‹ä¼šå‘½ä¸­ListenTCPå‡½æ•°å»æ‰§è¡Œï¼ŒListenTCPå‡½æ•°å¾ˆç®€å•ï¼ŒåŸºæœ¬å¤„ç†é€»è¾‘éƒ½åœ¨listenTCPå‡½æ•°ä¸­ï¼Œå¾€ä¸‹çœ‹ func listenTCP(ctx context.Context, network string, laddr *TCPAddr) (*TCPListener, error) { fd, err := internetSocket(ctx, network, laddr, nil, syscall.SOCK_STREAM, 0, \"listen\") if err != nil { return nil, err } return \u0026TCPListener{fd}, nil } func internetSocket(ctx context.Context, net string, laddr, raddr sockaddr, sotype, proto int, mode string) (fd *netFD, err error) { if (runtime.GOOS == \"windows\" || runtime.GOOS == \"openbsd\" || runtime.GOOS == \"nacl\") \u0026\u0026 mode == \"dial\" \u0026\u0026 raddr.isWildcard() { raddr = raddr.toLocal(net) } family, ipv6only := favoriteAddrFamily(net, laddr, raddr, mode) return socket(ctx, net, family, sotype, proto, ipv6only, laddr, raddr) } listenTCPå‡½æ•°ï¼Œåœ¨æ­¤å‡½æ•°ä¸­ç»ˆäºè§åˆ°äº†æœŸæœ›çœ‹åˆ°çš„fdå­—çœ¼ï¼Œè·³åˆ°internetSocketå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„fdæ˜¯ç”±socketå‡½æ•°äº§ç”Ÿçš„ï¼Œç»§ç»­ // socket returns a network file descriptor that is ready for // asynchronous I/O using the network poller. func socket(ctx context.Context, net string, family, sotype, proto int, ipv6only bool, laddr, raddr sockaddr) (fd *netFD, err error) { s, err := sysSocket(family, sotype, proto) if err != nil { return nil, err } if err = setDefaultSockopts(s, family, sotype, ipv6only); err != nil { poll.CloseFunc(s) return nil, err } if fd, err = newFD(s, family, sotype, net); err != nil { poll.CloseFunc(s) return nil, err } // This function makes a network file descriptor for the // following applications: // // - An endpoint holder that opens a passive stream // connection, known as a stream listener // // - An endpoint holder that opens a destination-unspecific // datagram connection, known as a datagram listener // // - An endpoint holder that opens an active stream or a // destination-specific datagram connection, known as a // dialer // // - An endpoint holder that opens the other connection, such // as talking to the protocol stack inside the kernel // // For stream and datagram listeners, they will only require // named sockets, so we can assume that it's just a request // from stream or datagram listeners when laddr is not nil but // raddr is nil. Otherwise we assume it's just for dialers or // the other connection holders. if laddr != nil \u0026\u0026 raddr == nil { switch sotype { case syscall.SOCK_STREAM, syscall.SOCK_SEQPACKET: if err := fd.listenStream(laddr, listenerBacklog); err != nil { fd.Close() return nil, err } return fd, nil case syscall.SOCK_DGRAM: if err := fd.listenDatagram(laddr); err != nil { fd.Close() return nil, err } ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:2:3","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"Accept TCPListneræœ‰ä¸¤ä¸ªæš´éœ²å‡ºæ¥çš„Acceptç›¸å…³çš„å‡½æ•°ï¼Œåˆ†åˆ«ä¸ºAcceptå’ŒAcceptTCPï¼Œè¿™é‡Œä¸»è¦ä»AcceptTCPåˆ†æï¼Œå› ä¸ºåè€…è¢«tcpKeepAliveListenerçš„Acceptå‡½æ•°è°ƒç”¨ï¼Œè€ŒtcpKeepAliveListenerçš„Acceptæ–¹æ³•å°±æ˜¯å¸¸ç”¨çš„å»ºç«‹webé¡¹ç›®æ—¶ï¼Œhttp.ListenAndServeä¸­ä¼šç”¨åˆ°çš„Acceptæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š func (l *TCPListener) AcceptTCP() (*TCPConn, error) { if !l.ok() { return nil, syscall.EINVAL } c, err := l.accept() if err != nil { return nil, \u0026OpError{Op: \"accept\", Net: l.fd.net, Source: nil, Addr: l.fd.laddr, Err: err} } return c, nil } å¯ä»¥çœ‹åˆ°å®ç°é€»è¾‘åŸºæœ¬éƒ½åœ¨acceptæ–¹æ³•å†… func (ln *TCPListener) accept() (*TCPConn, error) { fd, err := ln.fd.accept() if err != nil { return nil, err } return newTCPConn(fd), nil } func (fd *netFD) accept() (netfd *netFD, err error) { d, rsa, errcall, err := fd.pfd.Accept() if err != nil { if errcall != \"\" { err = wrapSyscallError(errcall, err) } return nil, err } if netfd, err = newFD(d, fd.family, fd.sotype, fd.net); err != nil { poll.CloseFunc(d) return nil, err } if err = netfd.init(); err != nil { fd.Close() return nil, err } lsa, _ := syscall.Getsockname(netfd.pfd.Sysfd) netfd.setAddr(netfd.addrFunc()(lsa), netfd.addrFunc()(rsa)) return netfd, nil } // Accept wraps the accept network call. func (fd *FD) Accept() (int, syscall.Sockaddr, string, error) { if err := fd.readLock(); err != nil { return -1, nil, \"\", err } defer fd.readUnlock() if err := fd.pd.prepareRead(fd.isFile); err != nil { return -1, nil, \"\", err } for { s, rsa, errcall, err := accept(fd.Sysfd) if err == nil { return s, rsa, \"\", err } switch err { case syscall.EAGAIN: if fd.pd.pollable() { if err = fd.pd.waitRead(fd.isFile); err == nil { continue } } case syscall.ECONNABORTED: // This means that a socket on the listen // queue was closed before we Accept()ed it; // it's a silly error, so try again. continue } return -1, nil, errcall, err } } è¿™é‡Œæœ‰ä¸¤ä¸ªå‡½æ•°æ¯”è¾ƒé‡è¦ï¼Œä¸€ä¸ªæ˜¯acceptï¼Œä¸€ä¸ªæ˜¯fd.pd.waitReadï¼Œé¦–å…ˆçœ‹acceptçš„å®ç°ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šé€šè¿‡æ±‡ç¼–è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ // Wrapper around the accept system call that marks the returned file // descriptor as nonblocking and close-on-exec. func accept(s int) (int, syscall.Sockaddr, string, error) { ns, sa, err := Accept4Func(s, syscall.SOCK_NONBLOCK|syscall.SOCK_CLOEXEC) // On Linux the accept4 system call was introduced in 2.6.28 // kernel and on FreeBSD it was introduced in 10 kernel. If we // get an ENOSYS error on both Linux and FreeBSD, or EINVAL // error on Linux, fall back to using accept. switch err { case nil: return ns, sa, \"\", nil default: // errors other than the ones listed return -1, sa, \"accept4\", err case syscall.ENOSYS: // syscall missing case syscall.EINVAL: // some Linux use this instead of ENOSYS case syscall.EACCES: // some Linux use this instead of ENOSYS case syscall.EFAULT: // some Linux use this instead of ENOSYS } // See ../syscall/exec_unix.go for description of ForkLock. // It is probably okay to hold the lock across syscall.Accept // because we have put fd.sysfd into non-blocking mode. // However, a call to the File method will put it back into // blocking mode. We can't take that risk, so no use of ForkLock here. ns, sa, err = AcceptFunc(s) if err == nil { syscall.CloseOnExec(ns) } if err != nil { return -1, nil, \"accept\", err } if err = syscall.SetNonblock(ns, true); err != nil { CloseFunc(ns) return -1, nil, \"setnonblock\", err } return ns, sa, \"\", nil } // Accept4Func is used to hook the accept4 call. var Accept4Func func(int, int) (int, syscall.Sockaddr, error) = syscall.Accept4 func Accept4(fd int, flags int) (nfd int, sa Sockaddr, err error) { var rsa RawSockaddrAny var len _Socklen = SizeofSockaddrAny nfd, err = accept4(fd, \u0026rsa, \u0026len, flags) if err != nil { return } if len \u003e SizeofSockaddrAny { panic(\"RawSockaddrAny too small\") } sa, err = anyToSockaddr(\u0026rsa) if err != nil { Close(nfd) nfd = 0 } return } // THIS FILE IS GENERATED BY THE COMMAND AT THE TOP; DO NOT EDIT func accept4(s int, rsa *RawSockaddrAny, addrlen *_Socklen, flags int) (fd int, err error) { r0, _, e1 := Syscall6(SYS_ACCEPT4, uintptr(s), uintptr(unsafe.Pointer(rsa)), uintptr(unsafe.Pointer(addrlen)), uintptr(flags), 0, 0) fd = int(r0) if e1 != 0 { err = err","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:2:4","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["æºç åˆ†æ"],"content":"æ€»ç»“ é€šè¿‡ä¸Šé¢çš„ç®€å•åˆ†æï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥ç†è§£æ•´ä¸ªæµç¨‹ï¼Œé‡Œé¢è¿˜æ¶‰åŠåˆ°å¾ˆå¤šå…·ä½“ç»†èŠ‚ä»¥åŠgoè°ƒåº¦å™¨ç›¸å…³çš„å†…å®¹æ— æ³•ä¸€ä¸€ä»‹ç»ï¼Œæœ‰å…´è¶£çš„è¯å¯ä»¥ç›´æ¥æŸ¥çœ‹æºç ã€‚å‰©ä¸‹çš„readï¼Œwriteå¤§è‡´ç›¸åŒï¼Œè¿™é‡Œä¸å†åˆ†æï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡netpollçš„ç›¸å…³å‡½æ•°å®ç°çš„ï¼Œå¯ä»¥è¯´æ•´ä¸ªæ ¸å¿ƒå®ç°éƒ½åœ¨netpoll.goè¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå¤–é¢åªæ˜¯è¿›è¡Œäº†ä¸€äº›å°è£…å’ŒçŠ¶æ€çš„å¤„ç†ï¼Œè‡³äºGçŠ¶æ€çš„å˜åŒ–çš„ç›¸å…³ä»£ç ï¼Œå¯ä»¥è‡ªè¡Œæœç´¢goè°ƒåº¦å™¨ï¼Œå·²ç»æœ‰ç›¸å½“å¤šåšå®¢è¿›è¡Œè¿‡è®²è§£äº†ã€‚ å…¶å®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒçŸ¥è¯†å°±æ˜¯ä¸ªåœˆï¼Œç¼ºå°‘å“ªä¸€å—éƒ½ä¸²ä¸èµ·æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›ï¼Œå¡«è¡¥æˆ‘ä»¬æ‰€ç¼ºå¤±çš„éƒ¨åˆ†å§ï¼ŒåŠ æ²¹ï¼ ","date":"2018-06-10","objectID":"https://www.likakuli.com/posts/golang-netpoll/:3:0","tags":["golang","netpoll"],"title":"Golang netpollæºç åˆ†æ","uri":"https://www.likakuli.com/posts/golang-netpoll/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"kubernetes's bug because of the resourceversion","date":"2018-05-26","objectID":"https://www.likakuli.com/posts/kubernetes-ep-bug/","tags":["kubernetes"],"title":"KubernetesæƒŠå¤©åœ°æ³£é¬¼ç¥ä¹‹å¤§bug","uri":"https://www.likakuli.com/posts/kubernetes-ep-bug/"},{"categories":["é—®é¢˜æ’æŸ¥"],"content":"æœ€è¿‘docker oneçš„äº¤æµç¾¤é‡Œå‘å‡ºäº†ä¸€ç¯‡æ–‡ç« ï¼ŒKubernetes æƒŠå¤©åœ°æ³£é¬¼ç¥ä¹‹å¤§Bug ï¼Œä¼°è®¡å¾ˆå¤šäººçœ‹å®Œæ–‡ç« çš„ååº”å’Œæˆ‘ä¸€æ ·ï¼Œå¿ƒä¸­ä¸‡é©¬å¥”è…¾ï¼Œè‡ªå·±çš„é›†ç¾¤ä¼šä¸ä¼šä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ ï¼Ÿï¼Ÿï¼Ÿ æ–‡ä¸­å¯¹äºbugçš„å½±å“å’Œäº§ç”Ÿçš„åŸå› å·²ç»æè¿°çš„å¾ˆæ¸…æ¥šäº†ï¼Œä½†çœ‹å®Œä¹‹åæˆ‘æœ‰ä¸€ç‚¹ç–‘é—®ï¼Œæ–‡ä¸­æ‰€è¯´çš„å¤ç°æ¡ä»¶( é™†ç»­åˆ›å»ºã€åˆ é™¤ã€åˆ›å»º Kubernetes service å¯¹è±¡ï¼Œç„¶å\"kubectl delete svc xxx\"åˆ æ‰åˆ›å»ºæ—¶é—´é å‰çš„ serviceï¼Œä¹Ÿå°±æ˜¯å¾€ service event list æœ«å°¾æ’å…¥äº†ä¸€æ¡ resourceVersion æ¯”è¾ƒå°çš„è®°å½•ï¼Œè¿™å°†ä½¿å¾— controller-manager å»ä»å·²ç»çˆ¬è¿‡çš„ service event list ä½ç½®é‡æ–°çˆ¬å–é‡æ”¾ï¼Œç„¶åå°±é‡æ”¾äº† service çš„ ADDEDã€DELETED eventï¼Œäºæ˜¯ controller-manager å†…å­˜é‡Œç¼“å­˜çš„ service å¯¹è±¡è¢«åˆ é™¤ï¼Œå¯¼è‡´ EndpointController åˆ é™¤äº†â€œä¸å­˜åœ¨çš„â€service å¯¹åº”çš„ endpointsã€‚)åœ¨æ—¥å¸¸æ“ä½œä¸­å…¶å®ä¼šç»å¸¸å‡ºç°ï¼Œé‚£å²‚ä¸æ˜¯å¾ˆå¤šé›†ç¾¤éƒ½ä¼šå­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸”è¿™ä¸ªbugå½±å“è¿™ä¹ˆä¸¥é‡ï¼Œä¸ºä»€ä¹ˆç°åœ¨æ‰è¢«æŠ¥å‡ºæ¥ï¼ŸåŸºäºä¸Šè¿°ç–‘é—®ï¼Œæœ¬æ–‡ä¸»è¦æ˜¯åˆ°æºç ä¸­ä¸€æ¢ç©¶ç«Ÿï¼Œæºç ç‰ˆæœ¬1.9.2ï¼ŒæŒ‰ç…§æ–‡ä¸­æŒ‡å¼•å¯ä»¥å¿«é€Ÿå®šä½åˆ°é—®é¢˜ä»£ç æ‰€åœ¨ä½ç½®ï¼Œè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç ï¼Œå¦‚ä¸‹ï¼š // watchHandler watches w and keeps *resourceVersion up to date. func (r *Reflector) watchHandler(w watch.Interface, resourceVersion *string, errc chan error, stopCh \u003c-chan struct{}) error { start := r.clock.Now() eventCount := 0 // Stopping the watcher should be idempotent and if we return from this function there's no way // we're coming back in with the same watch interface. defer w.Stop() // update metrics defer func() { r.metrics.numberOfItemsInWatch.Observe(float64(eventCount)) r.metrics.watchDuration.Observe(time.Since(start).Seconds()) }() loop: for { select { case \u003c-stopCh: return errorStopRequested case err := \u003c-errc: return err case event, ok := \u003c-w.ResultChan(): if !ok { break loop } if event.Type == watch.Error { return apierrs.FromObject(event.Object) } if e, a := r.expectedType, reflect.TypeOf(event.Object); e != nil \u0026\u0026 e != a { utilruntime.HandleError(fmt.Errorf(\"%s: expected type %v, but watch event object had type %v\", r.name, e, a)) continue } meta, err := meta.Accessor(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\"%s: unable to understand watch event %#v\", r.name, event)) continue } newResourceVersion := meta.GetResourceVersion() switch event.Type { case watch.Added: err := r.store.Add(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\"%s: unable to add watch event object (%#v) to store: %v\", r.name, event.Object, err)) } case watch.Modified: err := r.store.Update(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\"%s: unable to update watch event object (%#v) to store: %v\", r.name, event.Object, err)) } case watch.Deleted: // TODO: Will any consumers need access to the \"last known // state\", which is passed in event.Object? If so, may need // to change this. err := r.store.Delete(event.Object) if err != nil { utilruntime.HandleError(fmt.Errorf(\"%s: unable to delete watch event object (%#v) from store: %v\", r.name, event.Object, err)) } default: utilruntime.HandleError(fmt.Errorf(\"%s: unable to understand watch event %#v\", r.name, event)) } *resourceVersion = newResourceVersion r.setLastSyncResourceVersion(newResourceVersion) eventCount++ } } watchDuration := r.clock.Now().Sub(start) if watchDuration \u003c 1*time.Second \u0026\u0026 eventCount == 0 { r.metrics.numberOfShortWatches.Inc() return fmt.Errorf(\"very short watch: %s: Unexpected watch close - watch lasted less than a second and no items received\", r.name) } glog.V(4).Infof(\"%s: Watch close - %v total %v items received\", r.name, r.expectedType, eventCount) return nil } è¿™æ˜¯æ–‡ä¸­æŒ‡å‡ºçš„å…·ä½“BUGæ‰€åœ¨ï¼Œç”¨é”™è¯¯çš„newResourceVersionå»ç»™resourceVersionå’ŒlastSyncResourceVersionèµ‹äº†å€¼ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±æ˜¯è¦æ‰¾è¿™ä¸¤ä¸ªå±æ€§åœ¨ä»€ä¹ˆåœ°æ–¹è¢«ç”¨åˆ°äº†ï¼Œç»è¿‡é€æ­¥æŸ¥æ‰¾ä»£ç å¼•ç”¨ï¼Œæœ€åç¡®å®šlastSyncResourceVersionå’Œè¿™ä¸ªbugæ— å…³ï¼Œé‚£é—®é¢˜å°±å‡ºåœ¨äº†resourceVersionä¸Šï¼Œå¯ä»¥çœ‹åˆ°ä¸Šé¢çš„æ–¹æ³•ä¸­resourceVersionæ˜¯é€šè¿‡æŒ‡é’ˆä¼ è¿›æ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šå½±å“åˆ°å¤–é¢ä½¿ç”¨åˆ°è¿™ä¸ªå±æ€§çš„åœ°æ–¹ï¼Œç»§ç»­æŸ¥çœ‹watchHandlerè¢«è°ƒç”¨çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š // ListAndWatch first lists all items and get the resource version at the moment of call, // and then use the resource version to watch. // It returns error if ListAndWatch didn't even try to initialize watch. func (r *Reflector) ListAndWatch(stopCh \u003c-chan struct{}) error { glog.V(3).Infof(\"Listing and watching %v from %s\", r.expectedType, r.name) var resourceVersion string // Explicitly set \"0\" as resource version - it's fine for the List() // to be served from cache and potentially be delayed relative to // etcd contents. Reflector framework will catch up via Watch() eventually. options := metav1.ListOptions{Resou","date":"2018-05-26","objectID":"https://www.likakuli.com/posts/kubernetes-ep-bug/:0:0","tags":["kubernetes"],"title":"KubernetesæƒŠå¤©åœ°æ³£é¬¼ç¥ä¹‹å¤§bug","uri":"https://www.likakuli.com/posts/kubernetes-ep-bug/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"kubernetes deploy with CA","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"ç®€ä»‹ kubernetes ç³»ç»Ÿçš„å„ç»„ä»¶éœ€è¦ä½¿ç”¨ TLS è¯ä¹¦å¯¹é€šä¿¡è¿›è¡ŒåŠ å¯†ï¼Œæœ¬æ–‡æ¡£ä½¿ç”¨ CloudFlare çš„ PKI å·¥å…·é›† cfssl æ¥ç”Ÿæˆ Certificate Authority (CA) å’Œå…¶å®ƒè¯ä¹¦ï¼Œæ“ä½œç³»ç»ŸCentOS7 amd64ï¼› é›†ç¾¤èŠ‚ç‚¹ 10.202.43.132 master \u0026 etcd 10.202.43 133 master \u0026 node \u0026 etcd 10.202.43.134 node \u0026 etcd è®¤è¯è¯·æ±‚ ca-csr.json etcd-csr.json admin-csr.json kubernetes-csr.json kube-proxy-csr.json ç”Ÿæˆçš„ CA è¯ä¹¦å’Œç§˜é’¥æ–‡ä»¶å¦‚ä¸‹ï¼š ca-key.pem ca.pem kubernetes-key.pem kubernetes.pem kube-proxy.pem kube-proxy-key.pem admin.pem admin-key.pem etcd.pem etcd-key.pem è¯ä¹¦ä½¿ç”¨æƒ…å†µå¦‚ä¸‹ï¼š etcdï¼šä½¿ç”¨ ca.pemã€etcd-key.pemã€etcd.pemï¼› kube-apiserverï¼šä½¿ç”¨ ca.pemã€kubernetes-key.pemã€kubernetes.pemï¼› kubeletï¼šä½¿ç”¨ ca.pemï¼› kube-proxyï¼šä½¿ç”¨ ca.pemã€kube-proxy-key.pemã€kube-proxy.pemï¼› kubectlï¼šä½¿ç”¨ ca.pemã€admin-key.pemã€admin.pemï¼› kube-controllerã€kube-scheduler å½“å‰éœ€è¦å’Œ kube-apiserver éƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨ä¸Šä¸”ä½¿ç”¨éå®‰å…¨ç«¯å£é€šä¿¡ï¼Œæ•…ä¸éœ€è¦è¯ä¹¦ã€‚ ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:1:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å®‰è£… CFSSL è¿™é‡Œé‡‡ç”¨äºŒè¿›åˆ¶æºç åŒ…å®‰è£…ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨goå‘½ä»¤å®‰è£… cd /usr/local/bin wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 mv cfssl_linux-amd64 cfssl wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 mv cfssljson_linux-amd64 cfssljson wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 mv cfssl-certinfo_linux-amd64 cfssl-certinfo chmod +x * ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:2:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"åˆ›å»º CA (Certificate Authority) åˆ›å»º CA é…ç½®æ–‡ä»¶ mkdir /opt/ssl cd /opt/ssl # ca-config.json æ–‡ä»¶ vim ca-config.json { \"signing\": { \"default\": { \"expiry\": \"87600h\" }, \"profiles\": { \"kubernetes\": { \"usages\": [ \"signing\", \"key encipherment\", \"server auth\", \"client auth\" ], \"expiry\": \"87600h\" } } } } å­—æ®µè¯´æ˜ ca-config.jsonï¼šå¯ä»¥å®šä¹‰å¤šä¸ª profilesï¼Œåˆ†åˆ«æŒ‡å®šä¸åŒçš„è¿‡æœŸæ—¶é—´ã€ä½¿ç”¨åœºæ™¯ç­‰å‚æ•°ï¼›åç»­åœ¨ç­¾åè¯ä¹¦æ—¶ä½¿ç”¨æŸä¸ª profileï¼› signingï¼šè¡¨ç¤ºè¯¥è¯ä¹¦å¯ç”¨äºç­¾åå…¶å®ƒè¯ä¹¦ï¼Œç”Ÿæˆçš„ ca.pem è¯ä¹¦ä¸­ CA=TRUEï¼› server authï¼šè¡¨ç¤ºclientå¯ä»¥ç”¨è¯¥ CA å¯¹serveræä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› client authï¼šè¡¨ç¤ºserverå¯ä»¥ç”¨è¯¥ CA å¯¹clientæä¾›çš„è¯ä¹¦è¿›è¡ŒéªŒè¯ï¼› åˆ›å»º CA è¯ä¹¦ç­¾åè¯·æ±‚ # ca-csr.json æ–‡ä»¶ vim ca-csr.json { \"CN\": \"kubernetes\", \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } å­—æ®µè¯´æ˜ â€œCNâ€ï¼šCommon Nameï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼› â€œOâ€ï¼šOrganizationï¼Œkube-apiserver ä»è¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚ç”¨æˆ·æ‰€å±çš„ç»„ (Group)ï¼› ç”Ÿæˆ CA è¯ä¹¦å’Œç§é’¥ cfssl gencert -initca ca-csr.json | cfssljson -bare ca ls ca.csr ca-key.pem ca.pem ca-csr.json ca-config.json åˆ†å‘è¯ä¹¦ # åˆ›å»ºè¯ä¹¦ç›®å½• mkdir -p /etc/kubernetes/ssl # æ‹·è´æ‰€æœ‰æ–‡ä»¶åˆ°ç›®å½•ä¸‹ cp *.pem /etc/kubernetes/ssl cp ca.csr /etc/kubernetes/ssl # è¿™é‡Œè¦å°†æ–‡ä»¶æ‹·è´åˆ°æ‰€æœ‰çš„k8s æœºå™¨ä¸Š scp *.pem 10.202.43.133:/etc/kubernetes/ssl/ scp *.csr 10.202.43.133:/etc/kubernetes/ssl/ scp *.pem 10.202.43.134:/etc/kubernetes/ssl/ scp *.csr 10.202.43.134:/etc/kubernetes/ssl/ ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:3:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"åˆ›å»º etcd è¯ä¹¦ etcd è¯ä¹¦è¿™é‡Œï¼Œæˆ‘åšæµ‹è¯•æ—¶ç”¨çš„etcdåœ°å€å¦‚ä¸‹ 10.202.43.132 10.202.43.133 10.202.43.134 å®é™…é…ç½®çš„ IP è¿˜è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥å¤šé¢„ç•™å‡ ä¸ªIPï¼Œä»¥å¤‡åç»­æ·»åŠ èƒ½é€šè¿‡è®¤è¯ï¼Œä¸éœ€è¦é‡æ–°ç­¾å‘ vim etcd-csr.json { \"CN\": \"etcd\", \"hosts\": [ \"127.0.0.1\", \"10.202.43.132\", \"10.202.43.133\", \"10.202.43.134\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } ç”Ÿæˆ etcd è¯ä¹¦å’Œç§é’¥ cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes etcd-csr.json | cfssljson -bare etcd ls etcd* etcd.csr etcd-csr.json etcd-key.pem etcd.pem æ‹·è´åˆ°etcdæœåŠ¡å™¨ # etcd-1 cp etcd*.pem /etc/kubernetes/ssl/ # etcd-2 scp etcd*.pem 10.202.43.133:/etc/kubernetes/ssl/ # etcd-3 scp etcd*.pem 10.202.43.134:/etc/kubernetes/ssl/ ä¿®æ”¹ etcd é…ç½® # etcd-1 vim /usr/lib/systemd/system/etcd.service [Unit] Description=Etcd Server After=network.target After=network-online.target Wants=network-online.target [Service] Type=notify WorkingDirectory=/opt/etcd/ User=etcd # set GOMAXPROCS to number of processors ExecStart=/usr/bin/etcd \\ --name=etcd1 \\ --cert-file=/etc/kubernetes/ssl/etcd.pem \\ --key-file=/etc/kubernetes/ssl/etcd-key.pem \\ --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \\ --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \\ --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\ --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \\ --initial-advertise-peer-urls=https://10.202.43.132:2380 \\ --listen-peer-urls=https://10.202.43.132:2380 \\ --listen-client-urls=https://10.202.43.132:2379,http://127.0.0.1:2379 \\ --advertise-client-urls=https://10.202.43.132:2379 \\ --initial-cluster-token=k8s-etcd-cluster \\ --initial-cluster=etcd1=https://10.202.43.132:2380,etcd2=https://10.202.43.133:2380,etcd3=https://10.202.43.134:2380 \\ --initial-cluster-state=new \\ --data-dir=/opt/etcd/ Restart=on-failure RestartSec=5 LimitNOFILE=65536 [Install] WantedBy=multi-user.target å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šçš„é…ç½®å’Œä¸Šé¢å¤§è‡´ç›¸åŒï¼Œåªéœ€è¦æŠŠå¯¹åº”IPæ¢æˆè‡ªå·±çš„å°±å¯ä»¥äº† è¯ä¹¦ç›¸å…³çš„é…ç½® --cert-file=/etc/kubernetes/ssl/etcd.pem --key-file=/etc/kubernetes/ssl/etcd-key.pem --peer-cert-file=/etc/kubernetes/ssl/etcd.pem --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem --trusted-ca-file=/etc/kubernetes/ssl/ca.pem --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem åˆ†åˆ«å¯åŠ¨ etcd é›†ç¾¤ systemctl daemon-reload systemctl start etcd # é…ç½®å¼€æœºå¯åŠ¨ systemctl enable etcd # æŸ¥çœ‹etcdçŠ¶æ€ systemctl status etcd éªŒè¯ etcd é›†ç¾¤çŠ¶æ€ etcdctl --endpoints=https://10.202.43.132:2379,https://10.202.43.133:2379,https://10.202.43.134:2379\\ --cert-file=/etc/kubernetes/ssl/etcd.pem \\ --ca-file=/etc/kubernetes/ssl/ca.pem \\ --key-file=/etc/kubernetes/ssl/etcd-key.pem \\ cluster-health ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:4:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"åˆ›å»º kubernetes è¯ä¹¦ åˆ›å»º admin è¯ä¹¦å’Œç§é’¥ # åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ vim admin-csr.json { \"CN\": \"admin\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"system:masters\", \"OU\": \"System\" } ] } # ç”Ÿæˆ admin è¯ä¹¦å’Œç§é’¥ cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes admin-csr.json | cfssljson -bare admin # æŸ¥çœ‹ç”Ÿæˆ ls admin* admin.csr admin-csr.json admin-key.pem admin.pem cp admin*.pem /etc/kubernetes/ssl/ scp admin*.pem 10.202.43.133:/etc/kubernetes/ssl/ åç»­ kube-apiserver ä½¿ç”¨ RBAC å¯¹å®¢æˆ·ç«¯(å¦‚ kubeletã€kube-proxyã€Pod)è¯·æ±‚è¿›è¡Œæˆæƒï¼› kube-apiserver é¢„å®šä¹‰äº†ä¸€äº› RBAC ä½¿ç”¨çš„ RoleBindingsï¼Œå¦‚ cluster-admin å°† Group system:masters ä¸ Role cluster-admin ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨kube-apiserver çš„æ‰€æœ‰ APIçš„æƒé™ï¼› OU æŒ‡å®šè¯¥è¯ä¹¦çš„ Group ä¸º system:mastersï¼Œkubelet ä½¿ç”¨è¯¥è¯ä¹¦è®¿é—® kube-apiserver æ—¶ ï¼Œç”±äºè¯ä¹¦è¢« CA ç­¾åï¼Œæ‰€ä»¥è®¤è¯é€šè¿‡ï¼ŒåŒæ—¶ç”±äºè¯ä¹¦ç”¨æˆ·ç»„ä¸ºç»è¿‡é¢„æˆæƒçš„ system:mastersï¼Œæ‰€ä»¥è¢«æˆäºˆè®¿é—®æ‰€æœ‰ API çš„æƒé™ï¼› ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kubectl ç”Ÿæˆè¯ä¹¦ç›¸å…³çš„é…ç½®æ–‡ä»¶å­˜å‚¨ä¸ /root/.kube ç›®å½•ä¸­ # é…ç½® kubernetes é›†ç¾¤ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://127.0.0.1:6443 # é…ç½® å®¢æˆ·ç«¯è®¤è¯ kubectl config set-credentials admin \\ --client-certificate=/etc/kubernetes/ssl/admin.pem \\ --embed-certs=true \\ --client-key=/etc/kubernetes/ssl/admin-key.pem kubectl config set-context kubernetes \\ --cluster=kubernetes \\ --user=admin kubectl config use-context kubernetes åˆ›å»º kubernetes è¯ä¹¦å’Œç§é’¥ # åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚ vim kubernetes-csr.json { \"CN\": \"kubernetes\", \"hosts\": [ \"127.0.0.1\", \"10.202.43.132\", \"10.202.43.133\", \"10.254.0.1\", \"kubernetes\", \"kubernetes.default\", \"kubernetes.default.svc\", \"kubernetes.default.svc.cluster\", \"kubernetes.default.svc.cluster.local\" ], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } # ç”Ÿæˆè¯ä¹¦å’Œç§é’¥ cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes # æŸ¥çœ‹ç”Ÿæˆ ls kubernetes* kubernetes.csr kubernetes-key.pem kubernetes.pem kubernetes-csr.json # æ‹·è´åˆ°ç›®å½• cp kubernetes*.pem /etc/kubernetes/ssl/ scp kubernetes*.pem 10.202.43.133:/etc/kubernetes/ssl/ è¿™é‡Œ hosts å­—æ®µä¸­ ä¸‰ä¸ª IP åˆ†åˆ«ä¸º 127.0.0.1 æœ¬æœºï¼Œ 10.202.43.132 å’Œ 10.202.43.133 ä¸º Master çš„ IP ï¼Œå¤šä¸ªMasteréœ€è¦å†™å¤šä¸ªï¼Œä¹Ÿå¯ä»¥å¤šå†™å‡ ä¸ªï¼Œæ–¹ä¾¿ä»¥åæ‰©å±•masterèŠ‚ç‚¹ï¼› 10.254.0.1 ä¸º kue-apiserver æŒ‡å®šçš„ service-cluster-ip-range ç½‘æ®µçš„ç¬¬ä¸€ä¸ª IPï¼Œå¦‚ 10.254.0.1 ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:1","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kube-apiserver kubelet é¦–æ¬¡å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS Bootstrapping è¯·æ±‚ï¼Œkube-apiserver éªŒè¯ kubelet è¯·æ±‚ä¸­çš„ token æ˜¯å¦ä¸å®ƒé…ç½®çš„ token ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™è‡ªåŠ¨ä¸º kubeletç”Ÿæˆè¯ä¹¦å’Œç§˜é’¥ã€‚æœ‰å…³ TLS Bootstrapping å‚è€ƒ è¿™é‡Œ # ç”Ÿæˆ token head -c 16 /dev/urandom | od -An -t x | tr -d ' ' f6280a3754345875d392258bd340ef7e # åˆ›å»º token.csv æ–‡ä»¶ cd /opt/ssl vim token.csv f6280a3754345875d392258bd340ef7e,kubelet-bootstrap,10001,\"system:kubelet-bootstrap\" # æ‹·è´ cp token.csv /etc/kubernetes/ scp token.csv 10.202.43.133:/etc/kubernetes/ # ç”Ÿæˆé«˜çº§å®¡æ ¸é…ç½®æ–‡ä»¶ cd /etc/kubernetes cat \u003e\u003e audit-policy.yaml \u003c\u003cEOF # Log all requests at the Metadata level. apiVersion: audit.k8s.io/v1beta1 kind: Policy rules: - level: Metadata EOF # æ‹·è´ scp audit-policy.yaml 10.202.43.133:/etc/kubernetes/ vim /usr/lib/systemd/system/kube-apiserver.service [Unit] Description=Kubernetes API Server Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=network.target [Service] User=root ExecStart=/usr/local/bin/kube-apiserver \\ --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \\ --advertise-address=10.202.43.132 \\ --allow-privileged=true \\ --apiserver-count=2 \\ --audit-policy-file=/etc/kubernetes/audit-policy.yaml \\ --audit-log-maxage=30 \\ --audit-log-maxbackup=3 \\ --audit-log-maxsize=100 \\ --audit-log-path=/var/log/kubernetes/audit.log \\ --authorization-mode=Node,RBAC \\ --bind-address=0.0.0.0 \\ --secure-port=6443 \\ --client-ca-file=/etc/kubernetes/ssl/ca.pem \\ --enable-swagger-ui=true \\ --etcd-cafile=/etc/kubernetes/ssl/ca.pem \\ --etcd-certfile=/etc/kubernetes/ssl/etcd.pem \\ --etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem \\ --etcd-servers=https://10.202.43.132:2379,https://10.202.43.133:2379,https://10.202.43.134:2379 \\ --event-ttl=1h \\ --kubelet-https=true \\ --insecure-bind-address=127.0.0.1 \\ --insecure-port=8080 \\ --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\ --service-cluster-ip-range=10.254.0.0/16 \\ --service-node-port-range=10000-60000 \\ --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \\ --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \\ --enable-bootstrap-token-auth \\ --token-auth-file=/etc/kubernetes/token.csv \\ --v=1 Restart=on-failure RestartSec=5 Type=notify LimitNOFILE=65536 [Install] WantedBy=multi-user.target è¯ä¹¦ç›¸å…³é…ç½® --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction # 1.8å¼€å§‹éœ€è¦æ·»åŠ  NodeRestriction --audit-policy-file=/etc/kubernetes/audit-policy.yaml --authorization-mode=Node,RBAC #1.8 å¼€å§‹éœ€è¦æ·»åŠ  Node --client-ca-file=/etc/kubernetes/ssl/ca.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/etcd.pem --etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem --kubelet-https=true --insecure-bind-address=127.0.0.1 #ä¸æ˜¯0.0.0.0 ä»…ä¾›kube-controller-manager å’Œ kube-scheduler ä½¿ç”¨ --insecure-port=8080 --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --enable-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:2","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kube-controller-manager # åˆ›å»º kube-controller-manager.service æ–‡ä»¶ vim /usr/lib/systemd/system/kube-controller-manager.service [Unit] Description=Kubernetes Controller Manager Documentation=https://github.com/GoogleCloudPlatform/kubernetes [Service] ExecStart=/usr/local/bin/kube-controller-manager \\ --address=0.0.0.0 \\ --master=http://127.0.0.1:8080 \\ --service-cluster-ip-range=10.254.0.0/16 \\ --cluster-name=kubernetes \\ --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\ --root-ca-file=/etc/kubernetes/ssl/ca.pem \\ --leader-elect=true \\ --v=1 Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target è¯ä¹¦ç›¸å…³é…ç½® --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:3","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kube-scheduler # åˆ›å»º kube-cheduler.service æ–‡ä»¶ vim /usr/lib/systemd/system/kube-scheduler.service [Unit] Description=Kubernetes Scheduler Documentation=https://github.com/GoogleCloudPlatform/kubernetes [Service] ExecStart=/usr/local/bin/kube-scheduler \\ --address=0.0.0.0 \\ --master=http://127.0.0.1:8080 \\ --leader-elect=true \\ --v=1 Restart=on-failure RestartSec=5 [Install] WantedBy=multi-user.target ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:4","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kubelet kubelet å¯åŠ¨æ—¶å‘ kube-apiserver å‘é€ TLS bootstrapping è¯·æ±‚ï¼Œéœ€è¦å…ˆå°† bootstrap token æ–‡ä»¶ä¸­çš„ kubelet-bootstrap ç”¨æˆ·èµ‹äºˆ system:node-bootstrapper è§’è‰²ï¼Œç„¶å kubelet æ‰æœ‰æƒé™åˆ›å»ºè®¤è¯è¯·æ±‚(certificatesigningrequests)ã€‚ # å…ˆåˆ›å»ºè®¤è¯è¯·æ±‚ # user ä¸º master ä¸­ token.csv æ–‡ä»¶é‡Œé…ç½®çš„ç”¨æˆ· # åªéœ€åˆ›å»ºä¸€æ¬¡å°±å¯ä»¥ kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap é…ç½® kubelet.kubeconfig # é…ç½®é›†ç¾¤ï¼Œserverå‚æ•°ä¸ºapiserveråœ°å€ï¼Œå¯ä»¥ä½¿ç”¨haproxyæˆ–nginxæ¥ä»£æ›¿ç›´æ¥ä½¿ç”¨ip,è¾¾åˆ°k8så¤šä¸»çš„ç›®çš„ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://10.202.43.132:6443 \\ --kubeconfig=bootstrap.kubeconfig # é…ç½®å®¢æˆ·ç«¯è®¤è¯ kubectl config set-credentials kubelet-bootstrap \\ --token=f6280a3754345875d392258bd340ef7e \\ --kubeconfig=bootstrap.kubeconfig # é…ç½®å…³è” kubectl config set-context default \\ --cluster=kubernetes \\ --user=kubelet-bootstrap \\ --kubeconfig=bootstrap.kubeconfig # é…ç½®é»˜è®¤å…³è” kubectl config use-context default --kubeconfig=bootstrap.kubeconfig # æ‹·è´ç”Ÿæˆçš„ bootstrap.kubeconfig æ–‡ä»¶ mv bootstrap.kubeconfig /etc/kubernetes/ é…ç½® kubelet.service # åˆ›å»º kubelet ç›®å½• mkdir /var/lib/kubelet vim /usr/lib/systemd/system/kubelet.service [Unit] Description=Kubernetes Kubelet Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=docker.service Requires=docker.service [Service] WorkingDirectory=/var/lib/kubelet ExecStart=/usr/local/bin/kubelet \\ --cgroup-driver=cgroupfs \\ --pod-infra-container-image=repository.gridsum.com:8443/kaku/pause-adm64:3.0 \\ --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\ --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\ --cert-dir=/etc/kubernetes/ssl \\ --cluster_dns=10.254.210.250 \\ --cluster_domain=cluster.local. \\ --allow-privileged=true \\ --fail-swap-on=false \\ --serialize-image-pulls=false \\ --logtostderr=true \\ --max-pods=512 \\ --v=1 [Install] WantedBy=multi-user.target è¯ä¹¦ç›¸å…³é…ç½® --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --cert-dir=/etc/kubernetes/ssl é…ç½® TLS è®¤è¯ # æŸ¥çœ‹ csr çš„åç§° kubectl get csr NAME AGE REQUESTOR CONDITION node-csr-*********************************** 1m kubelet-bootstrap Pending # å¢åŠ  è®¤è¯ kubectl get csr | grep Pending | awk '{print $1}' | xargs kubectl certificate approve # æˆåŠŸä»¥åä¼šè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ä¸å¯†é’¥ # é…ç½®æ–‡ä»¶ ls /etc/kubernetes/kubelet.kubeconfig /etc/kubernetes/kubelet.kubeconfig # å¯†é’¥æ–‡ä»¶ è¿™é‡Œæ³¨æ„å¦‚æœ csr è¢«åˆ é™¤äº†ï¼Œè¯·åˆ é™¤å¦‚ä¸‹æ–‡ä»¶ï¼Œå¹¶é‡å¯ kubelet æœåŠ¡ ls /etc/kubernetes/ssl/kubelet* /etc/kubernetes/ssl/kubelet-client.crt /etc/kubernetes/ssl/kubelet.crt /etc/kubernetes/ssl/kubelet-client.key /etc/kubernetes/ssl/kubelet.key ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:5","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® kube-proxy åˆ›å»º kube-proxy è¯ä¹¦å’Œç§é’¥ vim kube-proxy-csr.json { \"CN\": \"system:kube-proxy\", \"hosts\": [], \"key\": { \"algo\": \"rsa\", \"size\": 2048 }, \"names\": [ { \"C\": \"CN\", \"ST\": \"BeiJing\", \"L\": \"BeiJing\", \"O\": \"k8s\", \"OU\": \"System\" } ] } cfssl gencert -ca=ca.pem \\ -ca-key=ca-key.pem \\ -config=ca-config.json \\ -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy # æŸ¥çœ‹ç”Ÿæˆ ls kube-proxy* kube-proxy.csr kube-proxy-csr.json kube-proxy-key.pem kube-proxy.pem # æ‹·è´åˆ°ç›®å½• cp kube-proxy* /etc/kubernetes/ssl/ scp kube-proxy* 10.202.43.133:/etc/kubernetes/ssl/ scp kube-proxy* 10.202.43.134:/etc/kubernetes/ssl/ CN æŒ‡å®šè¯¥è¯ä¹¦çš„ User ä¸º system:kube-proxyï¼› kube-apiserver é¢„å®šä¹‰çš„ RoleBindings cluster-admin å°†User system:kube-proxy ä¸ Role system:node-proxier ç»‘å®šï¼Œè¯¥ Role æˆäºˆäº†è°ƒç”¨ kube-apiserver Proxy ç›¸å…³ API çš„æƒé™ï¼› é…ç½® kube-proxy.kubeconfig # é…ç½®é›†ç¾¤, serverå‚æ•°ä¸ºapiserveråœ°å€ï¼Œå¯ä»¥ä½¿ç”¨haproxyæˆ–nginxæ¥ä»£æ›¿ç›´æ¥ä½¿ç”¨ip,è¾¾åˆ°k8så¤šä¸»çš„ç›®çš„ kubectl config set-cluster kubernetes \\ --certificate-authority=/etc/kubernetes/ssl/ca.pem \\ --embed-certs=true \\ --server=https://10.202.43.132:6443 \\ --kubeconfig=kube-proxy.kubeconfig # é…ç½®å®¢æˆ·ç«¯è®¤è¯ kubectl config set-credentials kube-proxy \\ --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \\ --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \\ --embed-certs=true \\ --kubeconfig=kube-proxy.kubeconfig # é…ç½®å…³è” kubectl config set-context default \\ --cluster=kubernetes \\ --user=kube-proxy \\ --kubeconfig=kube-proxy.kubeconfig # é…ç½®é»˜è®¤å…³è” kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig # æ‹·è´åˆ°éœ€è¦çš„ node ç«¯é‡Œ scp kube-proxy.kubeconfig 10.202.43.133:/etc/kubernetes/ scp kube-proxy.kubeconfig 10.202.43.134:/etc/kubernetes/ é…ç½® kube-proxy.service 1.9 å®˜æ–¹ ipvs å·²ç» beta , å°è¯•å¼€å¯ ipvs æµ‹è¯•ä¸€ä¸‹, å®˜æ–¹ â€“feature-gates=SupportIPVSProxyMode=false é»˜è®¤æ˜¯ false çš„ï¼Œ éœ€è¦è®¾ç½® â€“-feature-gates=SupportIPVSProxyMode=true â€“-masquerade-allã€‚æ‰§è¡Œ yum install ipvsadm -y å®‰è£… ipvsï¼Œipvs å’Œ calico ä¸å…¼å®¹ï¼ŒåŸå› ä¹‹ä¸€æ˜¯ calico å¿…é¡»ä¸èƒ½è®¾ç½® â€“-masquerade-all # åˆ›å»º kube-proxy ç›®å½• mkdir -p /var/lib/kube-proxy vim /usr/lib/systemd/system/kube-proxy.service [Unit] Description=Kubernetes Kube-Proxy Server Documentation=https://github.com/GoogleCloudPlatform/kubernetes After=network.target [Service] WorkingDirectory=/var/lib/kube-proxy ExecStart=/usr/local/bin/kube-proxy \\ --bind-address=10.202.43.133 \\ --hostname-override=10.202.43.133 \\ --masquerade-all \\ --feature-gates=SupportIPVSProxyMode=true \\ --proxy-mode=ipvs \\ --ipvs-min-sync-period=5s \\ --ipvs-sync-period=5s \\ --ipvs-scheduler=rr \\ --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig \\ --logtostderr=true \\ --v=1 Restart=on-failure RestartSec=5 LimitNOFILE=65536 [Install] WantedBy=multi-user.target # é…ç½®è¯´æ˜ # --bind-address å’Œ --hostname-override æŒ‰éœ€è®¾ç½®ï¼Œ å…¶ä¸­ --bind-address ä¸º kube-proxy æ‰€åœ¨èŠ‚ç‚¹çš„ IP è¯ä¹¦ç›¸å…³é…ç½® --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:6","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"é…ç½® CoreDNS é…ç½® coredns.yaml # ä¸‹è½½é…ç½®æ–‡ä»¶ wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed mv coredns.yaml.sed coredns.yaml # vim coredns.yaml ... data: Corefile: | .:53 { errors health kubernetes cluster.local 10.254.0.0/16 { pods insecure upstream /etc/resolv.conf fallthrough in-addr.arpa ip6.arpa } ... image: repository.gridsum.com:8443/library/coredns ... clusterIP: 10.254.210.250 # åˆ›å»º coredns kubectl apply -f coredns.yaml ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:5:7","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"dashboard å®˜æ–¹ dashboard dashboardéƒ½ä»1.7ä¹‹ååªæ”¯æŒhttpsè®¿é—®ï¼ŒæŒ‰ç…§å®˜ç½‘ä½¿ç”¨kubectl proxyå¯åŠ¨æœ¬åœ°ä»£ç†æ¥è®¿é—®ã€‚æ­¤å¤„å¿…é¡»ä¸ºæœ¬åœ°ä»£ç†ï¼Œå³å¿…é¡»é€šè¿‡http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/è®¿é—®ï¼Œå¦‚æœè¦åœ¨windowsä¸Šè®¿é—®çš„è¯ï¼Œå¯ä»¥è‡ªå·±ç¼–è¯‘ä¸€ä¸ªkubectlå¯¹åº”çš„windowså®¢æˆ·ç«¯ï¼Œé€šè¿‡ä»¤ç‰Œç™»é™†çš„æ—¶å€™ï¼Œèƒ½çœ‹åˆ°çš„å†…å®¹ä¸tokençš„æƒé™æœ‰å…³ã€‚ ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:6:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"apiserverè®¿é—® å®¢æˆ·ç«¯åœ¨é›†ç¾¤å¤– # åœ¨ä»»ä¸€ master èŠ‚ç‚¹æ‰§è¡Œç‘å®‰å‘½ä»¤ä¾¿å¯åœ¨é›†ç¾¤å¤–é€šè¿‡http://masterip:8001è®¿é—®api server kubectl proxy --address 0.0.0.0 --accept-hosts '.*' --port=8001 é›†ç¾¤å†…è®¿é—® # kubectl get secret NAME TYPE DATA AGE default-token-z6lq7 kubernetes.io/service-account-token 3 15d # kubectl describe secret default-token-z6lq7 Name: default-token-z6lq7 Namespace: default Labels: \u003cnone\u003e Annotations: kubernetes.io/service-account.name=default kubernetes.io/service-account.uid=c246a42f-3d73-11e8-aa36-00155d010a3a Type: kubernetes.io/service-account-token Data ==== ca.crt: 1310 bytes namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tejZscTciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImMyNDZhNDJmLTNkNzMtMTFlOC1hYTM2LTAwMTU1ZDAxMGEzYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.Qfi9881mVeX8Z4ophf6_l5e5jGcILFobS5mKTQgdoz6NF0rJ4buRASmQiqu4N5ErolOstSIJhhK1yVzHbkBYsYReip6ffTnOwF2cWU5EJAhP7_o2zGWK5b11amlp5qLU0rWucfYe34ZfGxAcxoekmgKwJ6Hu58JlgD3ae5lu-_J6yVT_O-klC6FUXCY-r3FbtwwYz7WbrSxhuu5nCbegmEy5gPy9aEeVZcz6v5ZIyTU62mvbO_M1xYQfPyaHPWgjbkh9H540j2LUa7Y7RQw_LLEp_NbpzVfN58sFLY8cndzUfr5v_KjtFXyPVqmUX0qxoIRWL2opB7Qr2lL7qyTg5w #ä¸Šè¿°secretä¼šæŒ‚è½½åˆ°æ‰€æœ‰çš„podä¸Šï¼Œå®¹å™¨å†…å¯¹åº”è·¯å¾„ä¸º/var/run/secrets/kubernetes.io/serviceaccount #é›†ç¾¤å†…çš„Podé€šè¿‡åœ¨httpè¯·æ±‚çš„headerä¸­æ·»åŠ Authorization: Bearer ${KUBE_BEARER_TOKEN} è¿›è¡Œè®¿é—® # kubectl exec -it crawler-bgapi-new-9bjc7 sh # cd /var/run/secrets/kubernetes.io/serviceaccount # ls ca.crt namespace token # cat token eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tejZscTciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImMyNDZhNDJmLTNkNzMtMTFlOC1hYTM2LTAwMTU1ZDAxMGEzYSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.Qfi9881mVeX8Z4ophf6_l5e5jGcILFobS5mKTQgdoz6NF0rJ4buRASmQiqu4N5ErolOstSIJhhK1yVzHbkBYsYReip6ffTnOwF2cWU5EJAhP7_o2zGWK5b11amlp5qLU0rWucfYe34ZfGxAcxoekmgKwJ6Hu58JlgD3ae5lu-_J6yVT_O-klC6FUXCY-r3FbtwwYz7WbrSxhuu5nCbegmEy5gPy9aEeVZcz6v5ZIyTU62mvbO_M1xYQfPyaHPWgjbkh9H540j2LUa7Y7RQw_LLEp_NbpzVfN58sFLY8cndzUfr5v_KjtFXyPVqmUX0qxoIRWL2opB7Qr2lL7qyTg5 ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:7:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"},{"categories":["ä½¿ç”¨è¯´æ˜"],"content":"å‚è€ƒ Generate self-signed certificates Setting up a Certificate Authority and Creating TLS Certificates Client Certificates V/s Server Certificates æ•°å­—è¯ä¹¦åŠ CA çš„æ‰«ç›²ä»‹ç» kubernetes 1.9.1 kuberneteså®‰è£…ä¹‹è¯ä¹¦è®¤è¯ ç®¡ç†é›†ç¾¤ä¸­çš„TLS ","date":"2018-05-24","objectID":"https://www.likakuli.com/posts/kubernetes-ca/:8:0","tags":["kubernetes"],"title":"Kubernetes 1.9.6 CA IPVS CoreDNS","uri":"https://www.likakuli.com/posts/kubernetes-ca/"}]